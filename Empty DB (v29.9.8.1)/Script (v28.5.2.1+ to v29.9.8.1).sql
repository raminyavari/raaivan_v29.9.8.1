USE [EKM_App]
GO

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.5.2.1' BEGIN
	UPDATE [dbo].[AppSetting]
		SET [Version] = 'v28.7.2.1'
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.7.2.1' BEGIN
	CREATE TABLE [dbo].[FG_Polls](
		[PollID] [uniqueidentifier] NOT NULL,
		[IsCopyOfPollID] [uniqueidentifier] NULL,
		[OwnerID] [uniqueidentifier] NULL,
		[Name] [nvarchar](255) NULL,
		[Description] [nvarchar](2000) NULL,
		[BeginDate] [datetime] NULL,
		[FinishDate] [datetime] NULL,
		[ShowSummary] [bit] NOT NULL,
		[HideContributors] [bit] NOT NULL,
		[CreatorUserID] [uniqueidentifier] NOT NULL,
		[CreationDate] [datetime] NOT NULL,
		[LastModifierUserID] [uniqueidentifier] NULL,
		[LastModificationDate] [datetime] NULL,
		[Deleted] [bit] NOT NULL,
		[ApplicationID] [uniqueidentifier] NOT NULL,
	 CONSTRAINT [PK_FG_Polls] PRIMARY KEY CLUSTERED 
	(
		[PollID] ASC
	)WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]
	) ON [PRIMARY]
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.7.2.1' BEGIN
	ALTER TABLE [dbo].[FG_Polls]  WITH CHECK ADD  CONSTRAINT [FK_FG_Polls_aspnet_Applications] FOREIGN KEY([ApplicationID])
	REFERENCES [dbo].[aspnet_Applications] ([ApplicationId])
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.7.2.1' BEGIN
	ALTER TABLE [dbo].[FG_Polls] CHECK CONSTRAINT [FK_FG_Polls_aspnet_Applications]
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.7.2.1' BEGIN
	ALTER TABLE [dbo].[FG_Polls]  WITH CHECK ADD  CONSTRAINT [FK_FG_Polls_aspnet_Users_Creator] FOREIGN KEY([CreatorUserID])
	REFERENCES [dbo].[aspnet_Users] ([UserId])
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.7.2.1' BEGIN
	ALTER TABLE [dbo].[FG_Polls] CHECK CONSTRAINT [FK_FG_Polls_aspnet_Users_Creator]
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.7.2.1' BEGIN
	ALTER TABLE [dbo].[FG_Polls]  WITH CHECK ADD  CONSTRAINT [FK_FG_Polls_aspnet_Users_Modifier] FOREIGN KEY([LastModifierUserID])
	REFERENCES [dbo].[aspnet_Users] ([UserId])
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.7.2.1' BEGIN
	ALTER TABLE [dbo].[FG_Polls] CHECK CONSTRAINT [FK_FG_Polls_aspnet_Users_Modifier]
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.7.2.1' BEGIN
	ALTER TABLE [dbo].[FG_Polls]  WITH CHECK ADD  CONSTRAINT [FK_FG_Polls_FG_Polls] FOREIGN KEY([IsCopyOfPollID])
	REFERENCES [dbo].[FG_Polls] ([PollID])
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.7.2.1' BEGIN
	ALTER TABLE [dbo].[FG_Polls] CHECK CONSTRAINT [FK_FG_Polls_FG_Polls]
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.7.2.1' BEGIN
	ALTER TABLE [dbo].[WF_WorkFlowStates]
	ADD PollID uniqueidentifier NULL
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.7.2.1' BEGIN
	ALTER TABLE [dbo].[WF_WorkFlowStates]  WITH CHECK ADD  CONSTRAINT [FK_WF_WorkFlowStates_FG_Polls] FOREIGN KEY([PollID])
	REFERENCES [dbo].[FG_Polls] ([PollID])
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.7.2.1' BEGIN
	ALTER TABLE [dbo].[WF_WorkFlowStates] CHECK CONSTRAINT [FK_WF_WorkFlowStates_FG_Polls]
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.7.2.1' BEGIN
	ALTER TABLE [dbo].[FG_ExtendedFormElements]
	ADD [Weight] float NULL
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.7.2.1' BEGIN
	UPDATE [dbo].[AppSetting]
		SET [Version] = 'v28.9.5.2'
END
GO

/****** Object:  Table [dbo].[AttachmentFiles]    Script Date: 02/03/2018 08:59:13 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.9.5.2' BEGIN
	UPDATE [dbo].[AppSetting]
		SET [Version] = 'v28.10.5.3'
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.10.5.3' BEGIN
	CREATE TABLE [dbo].[DCT_Files](
		[ID] [uniqueidentifier] NOT NULL,
		[OwnerID] [uniqueidentifier] NOT NULL,
		[OwnerType] [varchar](50) NOT NULL,
		[FileNameGuid] [uniqueidentifier] NOT NULL,
		[Extension] [nvarchar](50) NULL,
		[FileName] [nvarchar](255) NOT NULL,
		[MIME] [nvarchar](255) NULL,
		[Size] [bigint] NULL,
		[CreatorUserID] [uniqueidentifier] NOT NULL,
		[CreationDate] [datetime] NOT NULL,
		[Deleted] [bit] NOT NULL,
		[ApplicationID] [uniqueidentifier] NOT NULL
	 CONSTRAINT [PK_DCT_Files] PRIMARY KEY CLUSTERED 
	(
		[ID] ASC
	)WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]
	) ON [PRIMARY]
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.10.5.3' BEGIN
	ALTER TABLE [dbo].[DCT_Files]  WITH CHECK ADD  CONSTRAINT [FK_DCT_Files_aspnet_Applications] FOREIGN KEY([ApplicationID])
	REFERENCES [dbo].[aspnet_Applications] ([ApplicationId])
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.10.5.3' BEGIN
	ALTER TABLE [dbo].[DCT_Files] CHECK CONSTRAINT [FK_DCT_Files_aspnet_Applications]
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.10.5.3' BEGIN
	ALTER TABLE [dbo].[DCT_Files]  WITH CHECK ADD  CONSTRAINT [FK_DCT_Files_aspnet_Users] FOREIGN KEY([CreatorUserID])
	REFERENCES [dbo].[aspnet_Users] ([UserId])
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.10.5.3' BEGIN
	ALTER TABLE [dbo].[DCT_Files] CHECK CONSTRAINT [FK_DCT_Files_aspnet_Users]
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.10.5.3' BEGIN
	DECLARE @Now datetime = N'2000-01-01 00:00:00.000'
	
	DECLARE @Str nvarchar(max) = 
		N'INSERT INTO [dbo].[DCT_Files] ( ' +
			N'ApplicationID, ' +
			N'ID, ' +
			N'OwnerID, ' +
			N'OwnerType, ' +
			N'FileNameGuid, ' +
			N'Extension, ' +
			N'[FileName], ' +
			N'MIME, ' +
			N'Size, ' +
			N'CreatorUserID, ' +
			N'CreationDate, ' +
			N'Deleted ' +
		N') ' +
		N'SELECT	F.ApplicationID, ' +
				N'F.ID, ' +
				N'A.ObjectID, ' +
				N'A.ObjectType, ' +
				N'F.FileNameGuid, ' +
				N'F.Extension, ' +
				N'F.[FileName], ' +
				N'F.MIME, ' +
				N'F.Size, ' +
				N'U.UserId, ' +
				N'N''' + @Now + ''', ' +
				N'CASE WHEN ISNULL(F.Deleted, 0) = 0 AND ISNULL(A.Deleted, 0) = 0 THEN 0 ELSE 1 END ' +
		N'FROM [dbo].[Attachments] AS A ' +
			N'INNER JOIN [dbo].[AttachmentFiles] AS F ' +
			N'ON F.AttachmentID = A.ID ' +
			N'INNER JOIN [dbo].[aspnet_Applications] AS P ' +
			N'ON P.ApplicationId = F.ApplicationID ' +
			N'INNER JOIN [dbo].[aspnet_Users] AS U ' +
			N'ON U.ApplicationId = P.ApplicationId AND LOWER(U.UserName) = N''admin'''
			
	EXEC (@Str)
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.10.5.3' BEGIN
	ALTER TABLE [dbo].[KW_KnowledgeTypes]
	ADD PreEvaluateByOwner bit NULL
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.10.5.3' BEGIN
	ALTER TABLE [dbo].[KW_KnowledgeTypes]
	ADD ForceEvaluatorsDescribe bit NULL
END
GO


IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.10.5.3' BEGIN
	UPDATE [dbo].[AppSetting]
		SET [Version] = 'v28.10.8.0'
END
GO



SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.10.8.0' BEGIN
	DELETE [dbo].[DCT_FileContents]
	WHERE FileNotFound = 1

	ALTER TABLE [dbo].[FG_ExtendedForms]
	ADD Name varchar(100) NULL

	ALTER TABLE [dbo].[FG_ExtendedFormElements]
	ADD Name varchar(100) NULL

	UPDATE [dbo].[AppSetting]
		SET [Version] = 'v28.12.0.3' -- 13961222
END

GO

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.12.0.3' BEGIN
	UPDATE [dbo].[DCT_Files]
		SET Size = Size * 1024
	WHERE OwnerType = N'Message' OR OwnerType = N'Wiki' OR OwnerType = N'WorkFlow'
	
	UPDATE [dbo].[AppSetting]
		SET [Version] = 'v28.17.3.4' -- 13970319
END

GO



SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.17.3.4' BEGIN
	SET ANSI_PADDING ON
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.17.3.4' BEGIN
	CREATE TABLE [dbo].[FG_Changes](
		[ID] [bigint] IDENTITY(1, 1) NOT NULL,
		[ElementID] [uniqueidentifier] NOT NULL,
		[TextValue] [nvarchar](max) NULL,
		[FloatValue] [float] NULL,
		[BitValue] [bit] NULL,
		[DateValue] [datetime] NULL,
		[GuidValue] [uniqueidentifier] NULL,
		[CreatorUserID] [uniqueidentifier] NOT NULL,
		[CreationDate] [datetime] NOT NULL,
		[Deleted] [bit] NOT NULL,
		[ApplicationID] [uniqueidentifier] NOT NULL
	 CONSTRAINT [PK_FG_Changes] PRIMARY KEY CLUSTERED 
	(
		[ID] ASC
	)WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]
	) ON [PRIMARY]
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.17.3.4' BEGIN
	CREATE UNIQUE INDEX UK_FG_Changes_ElementID ON [dbo].[FG_Changes]
	(
		[ApplicationID] ASC,
		[ElementID] ASC,
		[Deleted] ASC,
		[CreationDate] ASC,
		[CreatorUserID] ASC
	)WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.17.3.4' BEGIN
	SET ANSI_PADDING OFF
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.17.3.4' BEGIN
	ALTER TABLE [dbo].[FG_Changes]  WITH CHECK ADD  CONSTRAINT [FK_FG_Changes_aspnet_Applications] FOREIGN KEY([ApplicationID])
	REFERENCES [dbo].[aspnet_Applications] ([ApplicationId])
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.17.3.4' BEGIN
	ALTER TABLE [dbo].[FG_Changes] CHECK CONSTRAINT [FK_FG_Changes_aspnet_Applications]
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.17.3.4' BEGIN
	ALTER TABLE [dbo].[FG_Changes]  WITH CHECK ADD  CONSTRAINT [FK_FG_Changes_aspnet_Users] FOREIGN KEY([CreatorUserID])
	REFERENCES [dbo].[aspnet_Users] ([UserId])
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.17.3.4' BEGIN
	ALTER TABLE [dbo].[FG_Changes] CHECK CONSTRAINT [FK_FG_Changes_aspnet_Users]
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.17.3.4' BEGIN
	SET ANSI_PADDING ON
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.17.3.4' BEGIN
	CREATE TABLE [dbo].[RV_VariablesWithOwner](
		[ID] [bigint] IDENTITY(1, 1) NOT NULL,
		[OwnerID] [uniqueidentifier] NOT NULL,
		[Name] [varchar](100) NOT NULL,
		[Value] [nvarchar](max) NOT NULL,
		[CreatorUserID] [uniqueidentifier] NOT NULL,
		[CreationDate] [datetime] NOT NULL,
		[LastModifierUserID] [uniqueidentifier] NULL,
		[LastModificationDate] [datetime] NULL,
		[Deleted] [bit] NOT NULL,
		[ApplicationID] [uniqueidentifier] NOT NULL,
	 CONSTRAINT [PK_RV_VariablesWithOwner] PRIMARY KEY CLUSTERED 
	(
		[ID] ASC
	)WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]
	) ON [PRIMARY]
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.17.3.4' BEGIN
	SET ANSI_PADDING OFF
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.17.3.4' BEGIN
	ALTER TABLE [dbo].[RV_VariablesWithOwner]  WITH CHECK ADD  CONSTRAINT [FK_RV_VariablesWithOwner_aspnet_Applications] FOREIGN KEY([ApplicationID])
	REFERENCES [dbo].[aspnet_Applications] ([ApplicationId])
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.17.3.4' BEGIN
	ALTER TABLE [dbo].[RV_VariablesWithOwner] CHECK CONSTRAINT [FK_RV_VariablesWithOwner_aspnet_Applications]
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.17.3.4' BEGIN
	ALTER TABLE [dbo].[RV_VariablesWithOwner]  WITH CHECK ADD  CONSTRAINT [FK_RV_VariablesWithOwner_aspnet_Users_Creator] FOREIGN KEY([CreatorUserID])
	REFERENCES [dbo].[aspnet_Users] ([UserId])
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.17.3.4' BEGIN
	ALTER TABLE [dbo].[RV_VariablesWithOwner] CHECK CONSTRAINT [FK_RV_VariablesWithOwner_aspnet_Users_Creator]
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.17.3.4' BEGIN
	ALTER TABLE [dbo].[RV_VariablesWithOwner]  WITH CHECK ADD  CONSTRAINT [FK_RV_VariablesWithOwner_aspnet_Users_Modifier] FOREIGN KEY([LastModifierUserID])
	REFERENCES [dbo].[aspnet_Users] ([UserId])
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.17.3.4' BEGIN
	ALTER TABLE [dbo].[RV_VariablesWithOwner] CHECK CONSTRAINT [FK_RV_VariablesWithOwner_aspnet_Users_Modifier]
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.17.3.4' BEGIN
	UPDATE [dbo].[AppSetting]
		SET [Version] = 'v28.19.2.0'
END
GO

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.19.2.0' BEGIN
	ALTER TABLE [dbo].[CN_Services]
	ADD [NoContent] bit NULL
END

GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.19.2.0' BEGIN
	ALTER TABLE [dbo].[CN_Nodes]
	ADD [HideCreators] bit NULL
END

GO

SET ANSI_PADDING ON
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.19.2.0' BEGIN
	UPDATE ND
		SET Searchable = 1
	FROM [dbo].[CN_Nodes] AS ND
		INNER JOIN (
			SELECT DISTINCT H.OwnerID
			FROM [WF_History] AS H
		) AS H
		ON H.OwnerID = ND.NodeID
END
	
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.19.2.0' BEGIN
	UPDATE ND
		SET HideCreators = 1
	FROM [dbo].[CN_Nodes] AS ND
		INNER JOIN[dbo].[WF_History] AS X
		ON X.OwnerID = ND.NodeID 
		INNER JOIN (
			SELECT H.OwnerID, MAX(H.ID) AS ID
			FROM [dbo].[WF_History] AS H
			WHERE H.Deleted = 0
			GROUP BY H.OwnerID
		) AS A
		ON A.ID = X.ID
		INNER JOIN [dbo].[WF_WorkFlowStates] AS WS
		ON WS.WorkFlowID = X.WorkFlowID AND WS.StateID = X.StateID
	WHERE WS.HideOwnerName = 1
END

GO

SET ANSI_PADDING OFF
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.19.2.0' BEGIN
	ALTER TABLE [dbo].[FG_FormInstances]
	ADD [IsTemporary] bit NULL
END

GO


IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.19.2.0' BEGIN
	UPDATE [dbo].[AppSetting]
		SET [Version] = 'v28.24.16.1'
END

GO

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.16.1' BEGIN
	SET ANSI_PADDING ON
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.16.1' BEGIN
	CREATE TABLE [dbo].[RV_SystemSettings](
		[ID] [bigint] IDENTITY(1,1) NOT NULL,
		[Name] [varchar](100) NOT NULL,
		[Value] [nvarchar](max) NOT NULL,
		[LastModifierUserID] [uniqueidentifier] NULL,
		[LastModificationDate] [datetime] NULL,
		[ApplicationID] [uniqueidentifier] NOT NULL,
	 CONSTRAINT [PK_RV_SystemSettings] PRIMARY KEY CLUSTERED 
	(
		[ID] ASC
	)WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]
	) ON [PRIMARY]
END

GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.16.1' BEGIN
	SET ANSI_PADDING OFF
END

GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.16.1' BEGIN
	ALTER TABLE [dbo].[RV_SystemSettings]  WITH CHECK ADD  CONSTRAINT [FK_RV_SystemSettings_aspnet_Applications] FOREIGN KEY([ApplicationID])
	REFERENCES [dbo].[aspnet_Applications] ([ApplicationId])
END

GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.16.1' BEGIN
	ALTER TABLE [dbo].[RV_SystemSettings] CHECK CONSTRAINT [FK_RV_SystemSettings_aspnet_Applications]
END

GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.16.1' BEGIN
	ALTER TABLE [dbo].[RV_SystemSettings]  WITH CHECK ADD  CONSTRAINT [FK_RV_SystemSettings_aspnet_Users_Modifier] FOREIGN KEY([LastModifierUserID])
	REFERENCES [dbo].[aspnet_Users] ([UserId])
END

GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.16.1' BEGIN
	ALTER TABLE [dbo].[RV_SystemSettings] CHECK CONSTRAINT [FK_RV_SystemSettings_aspnet_Users_Modifier]
END

GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.16.1' BEGIN
	SET ANSI_PADDING ON
END

GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.16.1' BEGIN
	CREATE TABLE [dbo].[FG_SelectedItems](
		[ElementID] [uniqueidentifier] NOT NULL,
		[SelectedID] [uniqueidentifier] NOT NULL,
		[LastModifierUserID] [uniqueidentifier] NOT NULL,
		[LastModificationDate] [datetime] NOT NULL,
		[Deleted] [bit] NOT NULL,
		[ApplicationID] [uniqueidentifier] NOT NULL,
	 CONSTRAINT [PK_FG_SelectedItems] PRIMARY KEY CLUSTERED 
	(
		[ElementID] ASC,
		[SelectedID] ASC
	)WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]
	) ON [PRIMARY]
END

GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.16.1' BEGIN
	SET ANSI_PADDING OFF
END

GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.16.1' BEGIN
	ALTER TABLE [dbo].[FG_SelectedItems]  WITH CHECK ADD  CONSTRAINT [FK_FG_SelectedItems_aspnet_Applications] FOREIGN KEY([ApplicationID])
	REFERENCES [dbo].[aspnet_Applications] ([ApplicationId])
END

GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.16.1' BEGIN
	ALTER TABLE [dbo].[FG_SelectedItems] CHECK CONSTRAINT [FK_FG_SelectedItems_aspnet_Applications]
END

GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.16.1' BEGIN
	ALTER TABLE [dbo].[FG_SelectedItems]  WITH CHECK ADD  CONSTRAINT [FK_FG_SelectedItems_FG_InstanceElements] FOREIGN KEY([ElementID])
	REFERENCES [dbo].[FG_InstanceElements] ([ElementID])
END

GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.16.1' BEGIN
	ALTER TABLE [dbo].[FG_SelectedItems] CHECK CONSTRAINT [FK_FG_SelectedItems_FG_InstanceElements]
END

GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.16.1' BEGIN
	ALTER TABLE [dbo].[FG_SelectedItems]  WITH CHECK ADD  CONSTRAINT [FK_FG_SelectedItems_aspnet_Users_Modifier] FOREIGN KEY([LastModifierUserID])
	REFERENCES [dbo].[aspnet_Users] ([UserId])
END

GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.16.1' BEGIN
	ALTER TABLE [dbo].[FG_SelectedItems] CHECK CONSTRAINT [FK_FG_SelectedItems_aspnet_Users_Modifier]
END

GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.16.1' BEGIN
	DECLARE @str varchar(max) = N'INSERT INTO [dbo].[FG_SelectedItems] (ApplicationID, ElementID, SelectedID, ' +
		'LastModifierUserID, LastModificationDate, Deleted) ' +
	'SELECT E.ApplicationID, E.ElementID, E.GuidValue, ' +
		'ISNULL(E.LastModifierUserID, E.CreatorUserID), ISNULL(E.LastModificationDate, E.CreationDate), E.Deleted ' +
	'FROM [dbo].[FG_InstanceElements] AS E ' +
		'LEFT JOIN [dbo].[FG_SelectedItems] AS G ' +
		'ON G.ApplicationID = E.ApplicationID AND ' +
			'G.ElementID = E.ElementID AND G.SelectedID = E.GuidValue ' +
	'WHERE E.GuidValue IS NOT NULL AND E.CreatorUserID IS NOT NULL AND ' +
		'E.CreationDate IS NOT NULL AND G.ElementID IS NULL';
	
	EXEC (@str)
END

GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.16.1' BEGIN
	ALTER TABLE [dbo].[FG_InstanceElements]
	DROP COLUMN GuidValue
END

GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.16.1' BEGIN
	ALTER TABLE [dbo].[FG_Changes]
	DROP COLUMN GuidValue
END

GO


IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.16.1' BEGIN
	SET ANSI_PADDING ON
END

GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.16.1' BEGIN
	CREATE TABLE [dbo].[FG_PollAdmins](
		[PollID] [uniqueidentifier] NOT NULL,
		[UserID] [uniqueidentifier] NOT NULL,
		[LastModifierUserID] [uniqueidentifier] NOT NULL,
		[LastModificationDate] [datetime] NOT NULL,
		[Deleted] [bit] NOT NULL,
		[ApplicationID] [uniqueidentifier] NOT NULL,
	 CONSTRAINT [PK_FG_PollAdmins] PRIMARY KEY CLUSTERED 
	(
		[PollID] ASC,
		[UserID] ASC
	)WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]
	) ON [PRIMARY]
END

GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.16.1' BEGIN
	SET ANSI_PADDING OFF
END

GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.16.1' BEGIN
	ALTER TABLE [dbo].[FG_PollAdmins]  WITH CHECK ADD  CONSTRAINT [FK_FG_PollAdmins_aspnet_Applications] FOREIGN KEY([ApplicationID])
	REFERENCES [dbo].[aspnet_Applications] ([ApplicationId])
END

GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.16.1' BEGIN
	ALTER TABLE [dbo].[FG_PollAdmins] CHECK CONSTRAINT [FK_FG_PollAdmins_aspnet_Applications]
END

GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.16.1' BEGIN
	ALTER TABLE [dbo].[FG_PollAdmins]  WITH CHECK ADD  CONSTRAINT [FK_FG_PollAdmins_FG_Polls] FOREIGN KEY([PollID])
	REFERENCES [dbo].[FG_Polls] ([PollID])
END

GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.16.1' BEGIN
	ALTER TABLE [dbo].[FG_PollAdmins] CHECK CONSTRAINT [FK_FG_PollAdmins_FG_Polls]
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.16.1' BEGIN
	ALTER TABLE [dbo].[FG_PollAdmins]  WITH CHECK ADD  CONSTRAINT [FK_FG_PollAdmins_aspnet_Users] FOREIGN KEY([UserID])
	REFERENCES [dbo].[aspnet_Users] ([UserId])
END

GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.16.1' BEGIN
	ALTER TABLE [dbo].[FG_PollAdmins] CHECK CONSTRAINT [FK_FG_PollAdmins_aspnet_Users]
END

GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.16.1' BEGIN
	ALTER TABLE [dbo].[FG_PollAdmins]  WITH CHECK ADD  CONSTRAINT [FK_FG_PollAdmins_aspnet_Users_Modifier] FOREIGN KEY([LastModifierUserID])
	REFERENCES [dbo].[aspnet_Users] ([UserId])
END

GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.16.1' BEGIN
	ALTER TABLE [dbo].[FG_PollAdmins] CHECK CONSTRAINT [FK_FG_PollAdmins_aspnet_Users_Modifier]
END

GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.16.1' BEGIN
	ALTER TABLE [dbo].[FG_ExtendedFormElements]
	ADD IsUnique bit NULL
END

GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.16.1' BEGIN
	UPDATE [dbo].[AppSetting]
		SET [Version] = 'v28.24.21.2'
END

GO

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.21.2' BEGIN
	SET ANSI_PADDING ON
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.21.2' BEGIN
	ALTER TABLE [dbo].[USR_PasswordsHistory]
	ADD [AutoGenerated] bit NULL
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.21.2' BEGIN
	SET ANSI_PADDING OFF
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.21.2' BEGIN
	ALTER TABLE [dbo].[PRVC_Audience]
	DROP COLUMN [ModificationRight]
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.21.2' BEGIN
	SET ANSI_PADDING ON
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.21.2' BEGIN
	ALTER TABLE [dbo].[PRVC_PrivacyType]
	ADD [ConfidentialityID] [uniqueidentifier] NULL
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.21.2' BEGIN
	ALTER TABLE [dbo].[PRVC_PrivacyType]
	ADD [CalculateHierarchy] [bit] NULL
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.21.2' BEGIN	
	SET ANSI_PADDING OFF
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.21.2' BEGIN
	EXEC ('DELETE [dbo].[PRVC_PrivacyType] WHERE Deleted = 1')
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.21.2' BEGIN
	ALTER TABLE [dbo].[PRVC_PrivacyType]
	DROP COLUMN [Deleted]
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.21.2' BEGIN
	ALTER TABLE [dbo].[PRVC_PrivacyType]  WITH CHECK ADD  CONSTRAINT [FK_PRVC_PrivacyType_PRVC_ConfidentialityLevels] FOREIGN KEY([ConfidentialityID])
	REFERENCES [dbo].[PRVC_ConfidentialityLevels] ([ID])
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.21.2' BEGIN
	ALTER TABLE [dbo].[PRVC_PrivacyType] CHECK CONSTRAINT [FK_PRVC_PrivacyType_PRVC_ConfidentialityLevels]
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.21.2' BEGIN
	UPDATE T
		SET ConfidentialityID = C.LevelID
	FROM [dbo].[PRVC_PrivacyType] AS T
		INNER JOIN [dbo].[PRVC_Confidentialities] AS C
		ON C.ApplicationID = T.ApplicationID AND C.ItemID = T.ObjectID
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.21.2' BEGIN
	INSERT INTO [dbo].[PRVC_PrivacyType] (ApplicationID, ObjectID, ConfidentialityID, PrivacyType, 
		CreatorUserID, CreationDate, LastModifierUserID, LastModificationDate)
	SELECT C.ApplicationID, C.ItemID, C.LevelID, N'', C.CreatorUserID, C.CreationDate,
		C.LastModifierUserID, C.LastModificationDate
	FROM [dbo].[PRVC_PrivacyType] AS P
		RIGHT JOIN (
			SELECT	X.ApplicationID, 
					X.ItemID,
					CAST(MAX(CAST(X.LevelID AS varchar(50))) AS uniqueidentifier) AS LevelID,
					CAST(MAX(CAST(X.CreatorUserID AS varchar(50))) AS uniqueidentifier) AS CreatorUserID,
					MAX(X.CreationDate) AS CreationDate,
					CAST(MAX(CAST(X.LastModifierUserID AS varchar(50))) AS uniqueidentifier) AS LastModifierUserID,
					MAX(X.LastModificationDate) AS LastModificationDate
			FROM [dbo].[PRVC_Confidentialities] AS X
			GROUP BY X.ApplicationID, X.ItemID
		) AS C
		ON C.ApplicationID = P.ApplicationID AND C.ItemID = P.ObjectID
	WHERE P.ObjectID IS NULL
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.21.2' BEGIN
	IF EXISTS(select * FROM sys.views where name = 'PRVC_View_Confidentialities')
	DROP VIEW [dbo].[PRVC_View_Confidentialities]
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.21.2' BEGIN
	DROP TABLE [dbo].[PRVC_Confidentialities]
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.21.2' BEGIN
	UPDATE [dbo].[AppSetting]
		SET [Version] = 'v28.24.24.0' -- 13970801
END
GO

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.24.0' BEGIN
	SET ANSI_PADDING ON
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.24.0' BEGIN
	CREATE TABLE [dbo].[PRVC_DefaultPermissions](
		[ObjectID] [uniqueidentifier] NOT NULL,
		[PermissionType] [varchar](20) NOT NULL,
		[DefaultValue] [varchar](20) NOT NULL,
		[CreatorUserID] [uniqueidentifier] NOT NULL,
		[CreationDate] [datetime] NOT NULL,
		[LastModifierUserID] [uniqueidentifier] NULL,
		[LastModificationDate] [datetime] NULL,
		[ApplicationID] [uniqueidentifier] NULL
	 CONSTRAINT [PK_PRVC_DefaultPermissions] PRIMARY KEY CLUSTERED 
	(
		[ObjectID] ASC,
		[PermissionType] ASC
	)WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]
	) ON [PRIMARY]
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.24.0' BEGIN
	SET ANSI_PADDING OFF
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.24.0' BEGIN
	ALTER TABLE [dbo].[PRVC_DefaultPermissions]  WITH CHECK ADD  CONSTRAINT [FK_PRVC_DefaultPermissions_aspnet_Applications] FOREIGN KEY([ApplicationID])
	REFERENCES [dbo].[aspnet_Applications] ([ApplicationId])
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.24.0' BEGIN
	ALTER TABLE [dbo].[PRVC_DefaultPermissions] CHECK CONSTRAINT [FK_PRVC_DefaultPermissions_aspnet_Applications]
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.24.0' BEGIN
	ALTER TABLE [dbo].[PRVC_DefaultPermissions]  WITH CHECK ADD  CONSTRAINT [FK_PRVC_DefaultPermissions_aspnet_Users_Creator] FOREIGN KEY([CreatorUserID])
	REFERENCES [dbo].[aspnet_Users] ([UserId])
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.24.0' BEGIN
	ALTER TABLE [dbo].[PRVC_DefaultPermissions] CHECK CONSTRAINT [FK_PRVC_DefaultPermissions_aspnet_Users_Creator]
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.24.0' BEGIN
	ALTER TABLE [dbo].[PRVC_DefaultPermissions]  WITH CHECK ADD  CONSTRAINT [FK_PRVC_DefaultPermissions_aspnet_Users_Modifier] FOREIGN KEY([LastModifierUserID])
	REFERENCES [dbo].[aspnet_Users] ([UserId])
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.24.0' BEGIN
	ALTER TABLE [dbo].[PRVC_DefaultPermissions] CHECK CONSTRAINT [FK_PRVC_DefaultPermissions_aspnet_Users_Modifier]
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.24.0' BEGIN
	INSERT INTO [dbo].[PRVC_DefaultPermissions] (ApplicationID, ObjectID, PermissionType, DefaultValue,
		CreatorUserID, CreationDate, LastModifierUserID, LastModificationDate)
	SELECT P.ApplicationID, P.ObjectID, N'Create', P.PrivacyType, P.CreatorUserID, P.CreationDate,
		P.LastModifierUserID, P.LastModificationDate
	FROM [dbo].[PRVC_PrivacyType] AS P
		INNER JOIN [dbo].[CN_NodeTypes] AS NT
		ON NT.ApplicationID = P.ApplicationID AND NT.NodeTypeID = P.ObjectID
	WHERE ISNULL(P.PrivacyType, N'') <> N''
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.24.0' BEGIN
	INSERT INTO [dbo].[PRVC_DefaultPermissions] (ApplicationID, ObjectID, PermissionType, DefaultValue,
		CreatorUserID, CreationDate, LastModifierUserID, LastModificationDate)
	SELECT P.ApplicationID, P.ObjectID, N'View', P.PrivacyType, P.CreatorUserID, P.CreationDate,
		P.LastModifierUserID, P.LastModificationDate
	FROM [dbo].[PRVC_PrivacyType] AS P
		INNER JOIN [dbo].[CN_Nodes] AS NT
		ON NT.ApplicationID = P.ApplicationID AND NT.NodeID = P.ObjectID
	WHERE ISNULL(P.PrivacyType, N'') <> N''
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.24.0' BEGIN
	INSERT INTO [dbo].[PRVC_DefaultPermissions] (ApplicationID, ObjectID, PermissionType, DefaultValue,
		CreatorUserID, CreationDate, LastModifierUserID, LastModificationDate)
	SELECT P.ApplicationID, P.ObjectID, N'View', P.PrivacyType, P.CreatorUserID, P.CreationDate,
		P.LastModifierUserID, P.LastModificationDate
	FROM [dbo].[PRVC_PrivacyType] AS P
		LEFT JOIN [dbo].[PRVC_DefaultPermissions] AS NT
		ON NT.ApplicationID = P.ApplicationID AND NT.ObjectID = P.ObjectID
	WHERE ISNULL(P.PrivacyType, N'') <> N'' AND NT.ObjectID IS NULL
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.24.0' BEGIN
	UPDATE D
		SET DefaultValue = N'Create'
	FROM [dbo].[PRVC_DefaultPermissions] AS D
		INNER JOIN [dbo].[CN_Services] AS S
		ON S.ApplicationID = D.ApplicationID AND S.NodeTypeID = D.ObjectID
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.24.0' BEGIN
	UPDATE D
		SET DefaultValue = N'Create'
	FROM [dbo].[PRVC_DefaultPermissions] AS D
		INNER JOIN [dbo].[QA_WorkFlows] AS W
		ON W.ApplicationID = D.ApplicationID AND W.WorkFlowID = D.ObjectID
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.24.0' BEGIN
	UPDATE [dbo].[PRVC_DefaultPermissions]
		SET DefaultValue = N'Public'
	WHERE DefaultValue = N'PublicAsDefault'
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.24.0' BEGIN
	SET ANSI_PADDING ON
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.24.0' BEGIN
	CREATE TABLE [dbo].[PRVC_Settings](
		[ObjectID] [uniqueidentifier] NOT NULL,
		[ConfidentialityID] [uniqueidentifier] NULL,
		[CalculateHierarchy] [bit] NULL,
		[CreatorUserID] [uniqueidentifier] NOT NULL,
		[CreationDate] [datetime] NOT NULL,
		[LastModifierUserID] [uniqueidentifier] NULL,
		[LastModificationDate] [datetime] NULL,
		[ApplicationID] [uniqueidentifier] NULL
	 CONSTRAINT [PK_PRVC_Settings] PRIMARY KEY CLUSTERED 
	(
		[ObjectID] ASC
	)WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]
	) ON [PRIMARY]
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.24.0' BEGIN
	SET ANSI_PADDING OFF
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.24.0' BEGIN
	ALTER TABLE [dbo].[PRVC_Settings]  WITH CHECK ADD  CONSTRAINT [FK_PRVC_Settings_aspnet_Applications] FOREIGN KEY([ApplicationID])
	REFERENCES [dbo].[aspnet_Applications] ([ApplicationId])
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.24.0' BEGIN
	ALTER TABLE [dbo].[PRVC_Settings] CHECK CONSTRAINT [FK_PRVC_Settings_aspnet_Applications]
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.24.0' BEGIN
	ALTER TABLE [dbo].[PRVC_Settings]  WITH CHECK ADD  CONSTRAINT [FK_PRVC_Settings_aspnet_Users_Creator] FOREIGN KEY([CreatorUserID])
	REFERENCES [dbo].[aspnet_Users] ([UserId])
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.24.0' BEGIN
	ALTER TABLE [dbo].[PRVC_Settings] CHECK CONSTRAINT [FK_PRVC_Settings_aspnet_Users_Creator]
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.24.0' BEGIN
	ALTER TABLE [dbo].[PRVC_Settings]  WITH CHECK ADD  CONSTRAINT [FK_PRVC_Settings_aspnet_Users_Modifier] FOREIGN KEY([LastModifierUserID])
	REFERENCES [dbo].[aspnet_Users] ([UserId])
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.24.0' BEGIN
	ALTER TABLE [dbo].[PRVC_Settings] CHECK CONSTRAINT [FK_PRVC_Settings_aspnet_Users_Modifier]
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.24.0' BEGIN
	ALTER TABLE [dbo].[PRVC_Settings]  WITH CHECK ADD  CONSTRAINT [FK_PRVC_Settings_PRVC_ConfidentialityLevels] FOREIGN KEY([ConfidentialityID])
	REFERENCES [dbo].[PRVC_ConfidentialityLevels] ([ID])
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.24.0' BEGIN
	ALTER TABLE [dbo].[PRVC_Settings] CHECK CONSTRAINT [FK_PRVC_Settings_PRVC_ConfidentialityLevels]
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.24.0' BEGIN
	INSERT INTO [dbo].[PRVC_Settings](ApplicationID, ObjectID, ConfidentialityID, CalculateHierarchy,
		CreatorUserID, CreationDate, LastModifierUserID, LastModificationDate)
	SELECT PT.ApplicationID, PT.ObjectID, PT.ConfidentialityID, PT.CalculateHierarchy,
		PT.CreatorUserID, PT.CreationDate, PT.LastModifierUserID, PT.LastModificationDate
	FROM [dbo].[PRVC_PrivacyType] AS PT
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.24.0' BEGIN
	IF EXISTS(select * FROM sys.views where name = 'PRVC_View_Confidentialities')
	DROP VIEW [dbo].[PRVC_View_Confidentialities]
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.24.0' BEGIN
	DROP TABLE [dbo].[PRVC_PrivacyType]
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.24.0' BEGIN
	SET ANSI_PADDING ON
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.24.0' BEGIN
	ALTER TABLE [dbo].[PRVC_Audience]
	ADD [PermissionType] [nvarchar](50) NULL
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.24.0' BEGIN
	SET ANSI_PADDING OFF
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.24.0' BEGIN
	EXEC ('UPDATE [dbo].[PRVC_Audience] ' +
		'SET PermissionType = PrivacyType')
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.24.0' BEGIN
	ALTER TABLE [dbo].[PRVC_Audience]
	DROP COLUMN [PrivacyType]
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.24.0' BEGIN
	UPDATE [dbo].[PRVC_Audience]
		SET PermissionType = N'View'
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.24.0' BEGIN
	UPDATE A
		SET PermissionType = N'Create'
	FROM [dbo].[PRVC_Audience] AS A
		INNER JOIN [dbo].[CN_NodeTypes] AS NT
		ON NT.ApplicationID = A.ApplicationID AND NT.NodeTypeID = A.ObjectID
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.24.0' BEGIN
	UPDATE A
		SET PermissionType = N'Create'
	FROM [dbo].[PRVC_Audience] AS A
		INNER JOIN [dbo].[QA_WorkFlows] AS NT
		ON NT.ApplicationID = A.ApplicationID AND NT.WorkFlowID = A.ObjectID
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.24.0' BEGIN
	CREATE TABLE [dbo].[PRVC_TempAudience](
		[ObjectID] [uniqueidentifier] NOT NULL,
		[RoleID] [uniqueidentifier] NOT NULL,
		[PermissionType] [nvarchar](50) NOT NULL,
		[Allow] [bit] NOT NULL,
		[ExpirationDate] [datetime] NULL,
		[CreatorUserID] [uniqueidentifier] NULL,
		[CreationDate] [datetime] NULL,
		[LastModifierUserID] [uniqueidentifier] NULL,
		[LastModificationDate] [datetime] NULL,
		[Deleted] [bit] NOT NULL,
		[ApplicationID] [uniqueidentifier] NULL
	 CONSTRAINT [PK_PRVC_TempAudience] PRIMARY KEY CLUSTERED 
	(
		[ObjectID] ASC,
		[RoleID] ASC,
		[PermissionType] ASC
	)WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]
	) ON [PRIMARY]
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.24.0' BEGIN
	INSERT INTO [dbo].[PRVC_TempAudience] (ObjectID, RoleID, PermissionType, Allow, ExpirationDate,
		CreatorUserID, CreationDate, LastModifierUserID, LastModificationDate, Deleted, ApplicationID)
	SELECT A.ObjectID, A.RoleID, ISNULL(A.PermissionType, N'View'), A.Allow, A.ExpirationDate, 
		A.CreatorUserID, A.CreationDate, A.LastModifierUserID, A.LastModificationDate, A.Deleted, A.ApplicationID
	FROM [dbo].[PRVC_Audience] AS A
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.24.0' BEGIN
	DROP TABLE [dbo].[PRVC_Audience]
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.24.0' BEGIN
	SET ANSI_PADDING ON
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.24.0' BEGIN
	CREATE TABLE [dbo].[PRVC_Audience](
		[ObjectID] [uniqueidentifier] NOT NULL,
		[RoleID] [uniqueidentifier] NOT NULL,
		[PermissionType] [nvarchar](50) NOT NULL,
		[Allow] [bit] NOT NULL,
		[ExpirationDate] [datetime] NULL,
		[CreatorUserID] [uniqueidentifier] NULL,
		[CreationDate] [datetime] NULL,
		[LastModifierUserID] [uniqueidentifier] NULL,
		[LastModificationDate] [datetime] NULL,
		[Deleted] [bit] NOT NULL,
		[ApplicationID] [uniqueidentifier] NULL
	 CONSTRAINT [PK_PRVC_Audience] PRIMARY KEY CLUSTERED 
	(
		[ObjectID] ASC,
		[RoleID] ASC,
		[PermissionType] ASC
	)WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]
	) ON [PRIMARY]
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.24.0' BEGIN
	SET ANSI_PADDING OFF
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.24.0' BEGIN
	ALTER TABLE [dbo].[PRVC_Audience]  WITH CHECK ADD  CONSTRAINT [FK_PRVC_Audience_aspnet_Applications] FOREIGN KEY([ApplicationID])
	REFERENCES [dbo].[aspnet_Applications] ([ApplicationId])
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.24.0' BEGIN
	ALTER TABLE [dbo].[PRVC_Audience] CHECK CONSTRAINT [FK_PRVC_Audience_aspnet_Applications]
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.24.0' BEGIN
	ALTER TABLE [dbo].[PRVC_Audience]  WITH CHECK ADD  CONSTRAINT [FK_PRVC_Audience_aspnet_Users_Creator] FOREIGN KEY([CreatorUserID])
	REFERENCES [dbo].[aspnet_Users] ([UserId])
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.24.0' BEGIN
	ALTER TABLE [dbo].[PRVC_Audience] CHECK CONSTRAINT [FK_PRVC_Audience_aspnet_Users_Creator]
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.24.0' BEGIN
	ALTER TABLE [dbo].[PRVC_Audience]  WITH CHECK ADD  CONSTRAINT [FK_PRVC_Audience_aspnet_Users_Modifier] FOREIGN KEY([LastModifierUserID])
	REFERENCES [dbo].[aspnet_Users] ([UserId])
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.24.0' BEGIN
	ALTER TABLE [dbo].[PRVC_Audience] CHECK CONSTRAINT [FK_PRVC_Audience_aspnet_Users_Modifier]
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.24.0' BEGIN
	INSERT INTO [dbo].[PRVC_Audience]
	SELECT *
	FROM [dbo].[PRVC_TempAudience]
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.24.0' BEGIN
	DROP TABLE [dbo].[PRVC_TempAudience]
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.24.0' BEGIN
	SET ANSI_PADDING ON
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.24.0' BEGIN
	ALTER TABLE [dbo].[FG_ExtendedFormElements]
	ADD [UniqueValue] [bit] NULL
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.24.0' BEGIN
	SET ANSI_PADDING OFF
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.24.24.0' BEGIN
	UPDATE [dbo].[AppSetting]
		SET [Version] = 'v28.25.2.0' -- 13970818
END
GO

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.25.2.0' BEGIN
	SET ANSI_PADDING ON
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.25.2.0' BEGIN
	ALTER TABLE [dbo].[LG_Logs]
	ADD [Level] [varchar](20) NULL
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.25.2.0' BEGIN
	SET ANSI_PADDING OFF
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.25.2.0' BEGIN
	SET ANSI_PADDING ON
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.25.2.0' BEGIN
	ALTER TABLE [dbo].[LG_ErrorLogs]
	ADD [Level] [varchar](20) NULL
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.25.2.0' BEGIN
	SET ANSI_PADDING OFF
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.25.2.0' BEGIN
	SET ANSI_PADDING ON
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.25.2.0' BEGIN
	ALTER TABLE [dbo].[CN_Services]
	ADD [UniqueMembership] [bit] NULL
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.25.2.0' BEGIN
	SET ANSI_PADDING OFF
END
GO


IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.25.2.0' BEGIN
	ALTER TABLE [dbo].[FG_ExtendedFormElements]
	DROP COLUMN IsUnique
END
GO


IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.25.2.0' BEGIN
	DECLARE @Items TABLE ([Action] varchar(100), [Level] varchar(20))

	INSERT INTO @Items ([Action], [Level])
	VALUES	(N'Node_AccessDenied', N'Error'),
			(N'PendingMembers_AccessDenied', N'Error'),
			(N'AddNodeType', N'Trace'),
			(N'AddNodeType_PermissionFailed', N'Error'),
			(N'RenameNodeType', N'Trace'),
			(N'RenameNodeType_PermissionFailed', N'Error'),
			(N'ChangeNodeType', N'Trace'),
			(N'ChangeNodeType_PermissionFailed', N'Error'),
			(N'SetNodeTypeAdditionalID', N'Trace'),
			(N'SetNodeTypeAdditionalID_PermissionFailed', N'Error'),
			(N'SetNodeTypeAdditionalIDPattern', N'Trace'),
			(N'SetNodeTypeAdditionalIDPattern_PermissionFailed', N'Error'),
			(N'MoveNodeType', N'Trace'),
			(N'MoveNodeType_PermissionFailed', N'Error'),
			(N'RemoveNodeType', N'Trace'),
			(N'RemoveNodeType_PermissionFailed', N'Error'),
			(N'RecoverNodeType', N'Trace'),
			(N'RecoverNodeType_PermissionFailed', N'Error'),
			(N'AddRelationType', N'Trace'),
			(N'AddRelationType_PermissionFailed', N'Error'),
			(N'ModifyRelationType', N'Trace'),
			(N'ModifyRelationType_PermissionFailed', N'Error'),
			(N'RemoveRelationType', N'Trace'),
			(N'RemoveRelationType_PermissionFailed', N'Error'),
			(N'AddNode', N'Trace'),
			(N'AddNode_PermissionFailed', N'Error'),
			(N'ModifyNode', N'Trace'),
			(N'ModifyNode_PermissionFailed', N'Error'),
			(N'SetDocumentTreeNodeID', N'Trace'),
			(N'SetDocumentTreeNodeID_PermissionFailed', N'Error'),
			(N'ModifyNodeName', N'Trace'),
			(N'ModifyNodeName_PermissionFailed', N'Error'),
			(N'ModifyNodeDescription', N'Trace'),
			(N'ModifyNodeDescription_PermissionFailed', N'Error'),
			(N'ModifyNodePublicDescription', N'Trace'),
			(N'ModifyNodePublicDescription_PermissionFailed', N'Error'),
			(N'SetNodeExpirationDate', N'Trace'),
			(N'SetNodeExpirationDate_PermissionFailed', N'Error'),
			(N'SetPreviousVersion', N'Trace'),
			(N'SetPreviousVersion_PermissionFailed', N'Error'),
			(N'ModifyNodeTags', N'Trace'),
			(N'ModifyNodeTags_PermissionFailed', N'Error'),
			(N'SetNodeSearchability', N'Trace'),
			(N'SetNodeSearchability_PermissionFailed', N'Error'),
			(N'RemoveNode', N'Trace'),
			(N'RemoveNode_PermissionFailed', N'Error'),
			(N'RecycleNode', N'Trace'),
			(N'RecycleNode_PermissionFailed', N'Error'),
			(N'SortNodeTypes', N'Trace'),
			(N'SortNodeTypes_PermissionFailed', N'Error'),
			(N'SortNodes', N'Trace'),
			(N'SortNodes_PermissionFailed', N'Error'),
			(N'SetNodeDirectParent', N'Trace'),
			(N'SetNodeDirectParent_PermissionFailed', N'Error'),
			(N'AddNodeRelation', N'Trace'),
			(N'AddNodeRelation_PermissionFailed', N'Error'),
			(N'SaveRelations', N'Trace'),
			(N'SaveRelations_PermissionFailed', N'Error'),
			(N'RemoveNodeRelation', N'Trace'),
			(N'RemoveNodeRelation_PermissionFailed', N'Error'),
			(N'AddComplex', N'Trace'),
			(N'AddComplex_PermissionFailed', N'Error'),
			(N'ModifyComplex', N'Trace'),
			(N'ModifyComplex_PermissionFailed', N'Error'),
			(N'RemoveComplex', N'Trace'),
			(N'RemoveComplex_PermissionFailed', N'Error'),
			(N'AddNodeToComplex', N'Trace'),
			(N'AddNodeToComplex_PermissionFailed', N'Error'),
			(N'RemoveComplexNode', N'Trace'),
			(N'RemoveComplexNode_PermissionFailed', N'Error'),
			(N'AddComplexAdmin', N'Trace'),
			(N'AddComplexAdmin_PermissionFailed', N'Error'),
			(N'RemoveComplexAdmin', N'Trace'),
			(N'RemoveComplexAdmin_PermissionFailed', N'Error'),
			(N'LikeNode', N'Trace'),
			(N'UnlikeNode', N'Trace'),
			(N'AddNodeMember', N'Trace'),
			(N'AddNodeMember_PermissionFailed', N'Error'),
			(N'RemoveNodeMember', N'Trace'),
			(N'RemoveNodeMember_PermissionFailed', N'Error'),
			(N'AcceptNodeMember', N'Trace'),
			(N'AcceptNodeMember_PermissionFailed', N'Error'),
			(N'SetUserAsNodeAdmin', N'Trace'),
			(N'SetUserAsNodeAdmin_PermissionFailed', N'Error'),
			(N'RemoveNodeAdmin', N'Trace'),
			(N'RemoveNodeAdmin_PermissionFailed', N'Error'),
			(N'AddExpert', N'Trace'),
			(N'AddExpert_PermissionFailed', N'Error'),
			(N'RemoveExpert', N'Trace'),
			(N'RemoveExpert_PermissionFailed', N'Error'),
			(N'EnableExtension', N'Trace'),
			(N'EnableExtension_PermissionFailed', N'Error'),
			(N'DisableExtension', N'Trace'),
			(N'DisableExtension_PermissionFailed', N'Error'),
			(N'SetExtensionTitle', N'Trace'),
			(N'SetExtensionTitle_PermissionFailed', N'Error'),
			(N'MoveExtension', N'Trace'),
			(N'MoveExtension_PermissionFailed', N'Error'),
			(N'SetServiceTitle', N'Trace'),
			(N'SetServiceTitle_PermissionFailed', N'Error'),
			(N'SetServiceDescription', N'Trace'),
			(N'SetServiceDescription_PermissionFailed', N'Error'),
			(N'SetServiceSuccessMessage', N'Trace'),
			(N'SetServiceSuccessMessage_PermissionFailed', N'Error'),
			(N'SetServiceAdminType', N'Trace'),
			(N'SetServiceAdminType_PermissionFailed', N'Error'),
			(N'SetServiceMaxAcceptableAdminLevel', N'Trace'),
			(N'SetServiceMaxAcceptableAdminLevel_PermissionFailed', N'Error'),
			(N'SetContributionLimits', N'Trace'),
			(N'SetContributionLimits_PermissionFailed', N'Error'),
			(N'SetServiceEnableContribution', N'Trace'),
			(N'SetServiceEnableContribution_PermissionFailed', N'Error'),
			(N'SetServiceNoContent', N'Trace'),
			(N'SetServiceNoContent_PermissionFailed', N'Error'),
			(N'SetServiceIsDocument', N'Trace'),
			(N'SetServiceIsDocument_PermissionFailed', N'Error'),
			(N'SetServiceIsKnowledge', N'Trace'),
			(N'SetServiceIsKnowledge_PermissionFailed', N'Error'),
			(N'SetServiceIsTree', N'Trace'),
			(N'SetServiceIsTree_PermissionFailed', N'Error'),
			(N'SetServiceEditableForAdmin', N'Trace'),
			(N'SetServiceEditableForAdmin_PermissionFailed', N'Error'),
			(N'SetServiceEditableForCreator', N'Trace'),
			(N'SetServiceEditableForCreator_PermissionFailed', N'Error'),
			(N'SetServiceEditableForOwners', N'Trace'),
			(N'SetServiceEditableForOwners_PermissionFailed', N'Error'),
			(N'SetServiceEditableForExperts', N'Trace'),
			(N'SetServiceEditableForExperts_PermissionFailed', N'Error'),
			(N'SetServiceEditableForMembers', N'Trace'),
			(N'SetServiceEditableForMembers_PermissionFailed', N'Error'),
			(N'SetServiceEditSuggestion', N'Trace'),
			(N'SetServiceEditSuggestion_PermissionFailed', N'Error'),
			(N'AddServiceFreeUser', N'Trace'),
			(N'AddServiceFreeUser_PermissionFailed', N'Error'),
			(N'RemoveServiceFreeUser', N'Trace'),
			(N'RemoveServiceFreeUser_PermissionFailed', N'Error'),
			(N'AddServiceAdmin', N'Trace'),
			(N'AddServiceAdmin_PermissionFailed', N'Error'),
			(N'RemoveServiceAdmin', N'Trace'),
			(N'RemoveServiceAdmin_PermissionFailed', N'Error'),
			(N'SetAdminArea', N'Trace'),
			(N'SetAdminArea_PermissionFailed', N'Error'),
			(N'SetContributors', N'Trace'),
			(N'SetContributors_PermissionFailed', N'Error'),
			(N'CreateDocumentTree', N'Trace'),
			(N'CreateDocumentTree_PermissionFailed', N'Error'),
			(N'ModifyDocumentTree', N'Trace'),
			(N'ModifyDocumentTree_PermissionFailed', N'Error'),
			(N'RemoveDocumentTree', N'Trace'),
			(N'RemoveDocumentTree_PermissionFailed', N'Error'),
			(N'RecycleDocumentTree', N'Trace'),
			(N'RecycleDocumentTree_PermissionFailed', N'Error'),
			(N'CreateDocumentTreeNode', N'Trace'),
			(N'CreateDocumentTreeNode_PermissionFailed', N'Error'),
			(N'ModifyDocumentTreeNodeName', N'Trace'),
			(N'ModifyDocumentTreeNodeName_PermissionFailed', N'Error'),
			(N'MoveDocumentTreeNode', N'Trace'),
			(N'MoveDocumentTreeNode_PermissionFailed', N'Error'),
			(N'RemoveDocumentTreeNode', N'Trace'),
			(N'RemoveDocumentTreeNode_PermissionFailed', N'Error'),
			(N'SortDocumentTreeNodes', N'Trace'),
			(N'SortDocumentTreeNodes_PermissionFailed', N'Error'),
			(N'MoveDocuments', N'Trace'),
			(N'MoveDocuments_PermissionFailed', N'Error'),
			(N'Download_AccessDenied', N'Error'),
			(N'AddOwnerTree', N'Trace'),
			(N'AddOwnerTree_PermissionFailed', N'Error'),
			(N'RemoveOwnerTree', N'Trace'),
			(N'RemoveOwnerTree_PermissionFailed', N'Error'),
			(N'AddTreeNodeContents', N'Trace'),
			(N'AddTreeNodeContents_PermissionFailed', N'Error'),
			(N'RemoveTreeNodeContents', N'Trace'),
			(N'RemoveTreeNodeContents_PermissionFailed', N'Error'),
			(N'RegisterNewEvent', N'Trace'),
			(N'RemoveEventUser', N'Trace'),
			(N'ChangeEventUserStatus', N'Trace'),
			(N'CreateForm', N'Trace'),
			(N'CreateForm_PermissionFailed', N'Error'),
			(N'ModifyFormTitle', N'Trace'),
			(N'ModifyFormTitle_PermissionFailed', N'Error'),
			(N'ModifyFormName', N'Trace'),
			(N'ModifyFormName_PermissionFailed', N'Error'),
			(N'ModifyFormDescription', N'Trace'),
			(N'ModifyFormDescription_PermissionFailed', N'Error'),
			(N'RemoveForm', N'Trace'),
			(N'RemoveForm_PermissionFailed', N'Error'),
			(N'RecycleForm', N'Trace'),
			(N'RecycleForm_PermissionFailed', N'Error'),
			(N'AddFormElement', N'Trace'),
			(N'AddFormElement_PermissionFailed', N'Error'),
			(N'ModifyFormElement', N'Trace'),
			(N'ModifyFormElement_PermissionFailed', N'Error'),
			(N'MoveFormElementUp', N'Trace'),
			(N'MoveFormElementUp_PermissionFailed', N'Error'),
			(N'MoveFormElementDown', N'Trace'),
			(N'MoveFormElementDown_PermissionFailed', N'Error'),
			(N'SetFormElementNecessity', N'Trace'),
			(N'SetFormElementNecessity_PermissionFailed', N'Error'),
			(N'SetFormElementUniqueness', N'Trace'),
			(N'SetFormElementUniqueness_PermissionFailed', N'Error'),
			(N'RemoveFormElement', N'Trace'),
			(N'RemoveFormElement_PermissionFailed', N'Error'),
			(N'CreateFormInstance', N'Trace'),
			(N'RemoveFormInstance', N'Trace'),
			(N'RemoveOwnerFormInstances', N'Trace'),
			(N'ModifyFormInstanceElements', N'Trace'),
			(N'SetFormInstanceAsFilled', N'Trace'),
			(N'SetFormInstanceAsNotFilled', N'Trace'),
			(N'SetFormOwner', N'Trace'),
			(N'RemoveFormOwner', N'Trace'),
			(N'SetElementLimits', N'Trace'),
			(N'SetElementLimitNecessity', N'Trace'),
			(N'RemoveElementLimit', N'Trace'),
			(N'AddPoll', N'Trace'),
			(N'AddPoll_PermissionFailed', N'Error'),
			(N'RenamePoll', N'Trace'),
			(N'RenamePoll_PermissionFailed', N'Error'),
			(N'RemovePoll', N'Trace'),
			(N'RemovePoll_PermissionFailed', N'Error'),
			(N'RecyclePoll', N'Trace'),
			(N'RecyclePoll_PermissionFailed', N'Error'),
			(N'SetPollDescription', N'Trace'),
			(N'SetPollDescription_PermissionFailed', N'Error'),
			(N'SetPollBeginDate', N'Trace'),
			(N'SetPollBeginDate_PermissionFailed', N'Error'),
			(N'SetPollFinishDate', N'Trace'),
			(N'SetPollFinishDate_PermissionFailed', N'Error'),
			(N'SetPollShowSummary', N'Trace'),
			(N'SetPollShowSummary_PermissionFailed', N'Error'),
			(N'SetPollHideContributors', N'Trace'),
			(N'SetPollHideContributors_PermissionFailed', N'Error'),
			(N'AddKnowledgeType', N'Trace'),
			(N'AddKnowledgeType_PermissionFailed', N'Error'),
			(N'RemoveKnowledgeType', N'Trace'),
			(N'RemoveKnowledgeType_PermissionFailed', N'Error'),
			(N'SetKnowledgeTypeEvaluationType', N'Trace'),
			(N'SetKnowledgeTypeEvaluationType_PermissionFailed', N'Error'),
			(N'SetKnowledgeTypeEvaluators', N'Trace'),
			(N'SetKnowledgeTypeEvaluators_PermissionFailed', N'Error'),
			(N'SetKnowledgeTypePreEvaluateByOwner', N'Trace'),
			(N'SetKnowledgeTypePreEvaluateByOwner_PermissionFailed', N'Error'),
			(N'SetKnowledgeTypeForceEvaluatorsDescribe', N'Trace'),
			(N'SetKnowledgeTypeForceEvaluatorsDescribe_PermissionFailed', N'Error'),
			(N'SetKnowledgeTypeNodeSelectType', N'Trace'),
			(N'SetKnowledgeTypeNodeSelectType_PermissionFailed', N'Error'),
			(N'SetKnowledgeTypeSearchabilityType', N'Trace'),
			(N'SetKnowledgeTypeSearchabilityType_PermissionFailed', N'Error'),
			(N'SetKnowledgeTypeScoreScale', N'Trace'),
			(N'SetKnowledgeTypeScoreScale_PermissionFailed', N'Error'),
			(N'SetKnowledgeTypeMinAcceptableScore', N'Trace'),
			(N'SetKnowledgeTypeMinAcceptableScore_PermissionFailed', N'Error'),
			(N'SetKnowledgeTypeConvertEvaluatorsToExperts', N'Trace'),
			(N'SetKnowledgeTypeConvertEvaluatorsToExperts_PermissionFailed', N'Error'),
			(N'SetKnowledgeTypeCandidateRelations', N'Trace'),
			(N'SetKnowledgeTypeCandidateRelations_PermissionFailed', N'Error'),
			(N'AddKnowledgeTypeQuestion', N'Trace'),
			(N'AddKnowledgeTypeQuestion_PermissionFailed', N'Error'),
			(N'ModifyKnowledgeTypeQuestion', N'Trace'),
			(N'ModifyKnowledgeTypeQuestion_PermissionFailed', N'Error'),
			(N'RemoveKnowledgeTypeQuestion', N'Trace'),
			(N'RemoveKnowledgeTypeQuestion_PermissionFailed', N'Error'),
			(N'RemoveKnowledgeTypeRelatedNodeQuestions', N'Trace'),
			(N'RemoveKnowledgeTypeRelatedNodeQuestions_PermissionFailed', N'Error'),
			(N'MoveKnowledgeTypeQuestion', N'Trace'),
			(N'MoveKnowledgeTypeQuestion_PermissionFailed', N'Error'),
			(N'AddKnowledgeTypeAnswerOption', N'Trace'),
			(N'AddKnowledgeTypeAnswerOption_PermissionFailed', N'Error'),
			(N'ModifyKnowledgeTypeAnswerOption', N'Trace'),
			(N'ModifyKnowledgeTypeAnswerOption_PermissionFailed', N'Error'),
			(N'MoveKnowledgeTypeAnswerOption', N'Trace'),
			(N'MoveKnowledgeTypeAnswerOption_PermissionFailed', N'Error'),
			(N'RemoveKnowledgeTypeAnswerOption', N'Trace'),
			(N'RemoveKnowledgeTypeAnswerOption_PermissionFailed', N'Error'),
			(N'SetKnowledgeTypeQuestionWeight', N'Trace'),
			(N'SetKnowledgeTypeQuestionWeight_PermissionFailed', N'Error'),
			(N'AcceptKnowledge', N'Trace'),
			(N'AcceptKnowledge_PermissionFailed', N'Error'),
			(N'RejectKnowledge', N'Trace'),
			(N'RejectKnowledge_PermissionFailed', N'Error'),
			(N'SendKnowledgeToAdmin', N'Trace'),
			(N'SendKnowledgeToAdmin_PermissionFailed', N'Error'),
			(N'SendKnowledgeBackForRevision', N'Trace'),
			(N'SendKnowledgeBackForRevision_PermissionFailed', N'Error'),
			(N'SendKnowledgeToEvaluators', N'Trace'),
			(N'SendKnowledgeToEvaluators_PermissionFailed', N'Error'),
			(N'KnowledgeEvaluation_PermissionFailed', N'Error'),
			(N'RemoveKnowledgeEvaluator', N'Trace'),
			(N'RemoveKnowledgeEvaluator_PermissionFailed', N'Error'),
			(N'RefuseKnowledgeEvaluation_PermissionFailed', N'Error'),
			(N'TerminateKnowledgeEvaluation', N'Trace'),
			(N'TerminateKnowledgeEvaluation_PermissionFailed', N'Error'),
			(N'ActivateKnowledgeNecessaryItem', N'Trace'),
			(N'ActivateKnowledgeNecessaryItem_PermissionFailed', N'Error'),
			(N'DeactiveKnowledgeNecessaryItem', N'Trace'),
			(N'DeactiveKnowledgeNecessaryItem_PermissionFailed', N'Error'),
			(N'SetMessageTemplate', N'Trace'),
			(N'RemoveMessageTemplate', N'Trace'),
			(N'SetDefaultMessageTemplate', N'Trace'),
			(N'SetPrivacyAudience', N'Trace'),
			(N'SetPrivacyAudience_PermissionFailed', N'Error'),
			(N'AddConfidentialityLevel', N'Trace'),
			(N'AddConfidentialityLevel_PermissionFailed', N'Error'),
			(N'ModifyConfidentialityLevel', N'Trace'),
			(N'ModifyConfidentialityLevel_PermissionFailed', N'Error'),
			(N'RemoveConfidentialityLevel', N'Trace'),
			(N'RemoveConfidentialityLevel_PermissionFailed', N'Error'),
			(N'SetConfidentialityLevel', N'Trace'),
			(N'SetConfidentialityLevel_PermissionFailed', N'Error'),
			(N'UnsetConfidentialityLevel', N'Trace'),
			(N'UnsetConfidentialityLevel_PermissionFailed', N'Error'),
			(N'AddQAWorkFlow', N'Trace'),
			(N'AddQAWorkFlow_PermissionFailed', N'Error'),
			(N'RenameQAWorkFlow', N'Trace'),
			(N'RenameQAWorkFlow_PermissionFailed', N'Error'),
			(N'SetQAWorkFlowDescription', N'Trace'),
			(N'SetQAWorkFlowDescription_PermissionFailed', N'Error'),
			(N'SetQAWorkFlowsOrder_PermissionFailed', N'Error'),
			(N'SetQAWorkFlowInitialCheckNeeded', N'Trace'),
			(N'SetQAWorkFlowInitialCheckNeeded_PermissionFailed', N'Error'),
			(N'SetQAWorkFlowFinalConfirmationNeeded', N'Trace'),
			(N'SetQAWorkFlowFinalConfirmationNeeded_PermissionFailed', N'Error'),
			(N'SetQAWorkFlowActionDeadline', N'Trace'),
			(N'SetQAWorkFlowActionDeadline_PermissionFailed', N'Error'),
			(N'SetQAWorkFlowAnswerBy', N'Trace'),
			(N'SetQAWorkFlowAnswerBy_PermissionFailed', N'Error'),
			(N'SetQAWorkFlowPublishAfter', N'Trace'),
			(N'SetQAWorkFlowPublishAfter_PermissionFailed', N'Error'),
			(N'SetQAWorkFlowRemovableAfterConfirmation', N'Trace'),
			(N'SetQAWorkFlowRemovableAfterConfirmation_PermissionFailed', N'Error'),
			(N'SetQAWorkFlowNodeSelectType', N'Trace'),
			(N'SetQAWorkFlowNodeSelectType_PermissionFailed', N'Error'),
			(N'SetQAWorkFlowDisableComments', N'Trace'),
			(N'SetQAWorkFlowDisableComments_PermissionFailed', N'Error'),
			(N'SetQAWorkFlowDisableQuestionLikes', N'Trace'),
			(N'SetQAWorkFlowDisableQuestionLikes_PermissionFailed', N'Error'),
			(N'SetQAWorkFlowDisableAnswerLikes', N'Trace'),
			(N'SetQAWorkFlowDisableAnswerLikes_PermissionFailed', N'Error'),
			(N'SetQAWorkFlowDisableCommentLikes', N'Trace'),
			(N'SetQAWorkFlowDisableCommentLikes_PermissionFailed', N'Error'),
			(N'SetQAWorkFlowDisableBestAnswer', N'Trace'),
			(N'SetQAWorkFlowDisableBestAnswer_PermissionFailed', N'Error'),
			(N'RemoveQAWorkFlow', N'Trace'),
			(N'RemoveQAWorkFlow_PermissionFailed', N'Error'),
			(N'RecycleQAWorkFlow', N'Trace'),
			(N'RecycleQAWorkFlow_PermissionFailed', N'Error'),
			(N'AddQAWorkFlowAdmin', N'Trace'),
			(N'AddQAWorkFlowAdmin_PermissionFailed', N'Error'),
			(N'RemoveQAWorkFlowAdmin', N'Trace'),
			(N'RemoveQAWorkFlowAdmin_PermissionFailed', N'Error'),
			(N'SetQAWorkFlowCandidateRelations', N'Trace'),
			(N'SetQAWorkFlowCandidateRelations_PermissionFailed', N'Error'),
			(N'CreateFAQCategory', N'Trace'),
			(N'CreateFAQCategory_PermissionFailed', N'Error'),
			(N'RenameFAQCategory', N'Trace'),
			(N'RenameFAQCategory_PermissionFailed', N'Error'),
			(N'MoveFAQCategories', N'Trace'),
			(N'MoveFAQCategories_PermissionFailed', N'Error'),
			(N'SetFAQCategoriesOrder_PermissionFailed', N'Error'),
			(N'RemoveFAQCategories', N'Trace'),
			(N'RemoveFAQCategories_PermissionFailed', N'Error'),
			(N'AddFAQItems', N'Trace'),
			(N'AddFAQItems_PermissionFailed', N'Error'),
			(N'AddQuestionToFAQCategories', N'Trace'),
			(N'AddQuestionToFAQCategories_PermissionFailed', N'Error'),
			(N'RemoveFAQItem', N'Trace'),
			(N'RemoveFAQItem_PermissionFailed', N'Error'),
			(N'SetFAQItemsOrder_PermissionFailed', N'Error'),
			(N'SendQuestion', N'Trace'),
			(N'EditQuestionTitle', N'Trace'),
			(N'EditQuestionTitle_PermissionFailed', N'Error'),
			(N'EditQuestionDescription', N'Trace'),
			(N'EditQuestionDescription_PermissionFailed', N'Error'),
			(N'InitialConfirmQuestion_PermissionFailed', N'Error'),
			(N'ConfirmQuestion', N'Trace'),
			(N'ConfirmQuestion_PermissionFailed', N'Error'),
			(N'SetTheBestAnswer', N'Trace'),
			(N'SetTheBestAnswer_PermissionFailed', N'Error'),
			(N'RemoveQuestion', N'Trace'),
			(N'RemoveQuestion_PermissionFailed', N'Error'),
			(N'AddQuestionTag', N'Trace'),
			(N'AddQuestionTag_PermissionFailed', N'Error'),
			(N'SaveQuestionRelatedNodes', N'Trace'),
			(N'SaveQuestionRelatedNodes_PermissionFailed', N'Error'),
			(N'RemoveQuestionRelatedNodes', N'Trace'),
			(N'RemoveQuestionRelatedNodes_PermissionFailed', N'Error'),
			(N'SendAnswer', N'Trace'),
			(N'SendAnswer_PermissionFailed', N'Error'),
			(N'EditAnswer', N'Trace'),
			(N'EditAnswer_PermissionFailed', N'Error'),
			(N'RemoveAnswer', N'Trace'),
			(N'RemoveAnswer_PermissionFailed', N'Error'),
			(N'SendQAComment', N'Trace'),
			(N'EditQAComment', N'Trace'),
			(N'EditQAComment_PermissionFailed', N'Error'),
			(N'RemoveQAComment', N'Trace'),
			(N'RemoveQAComment_PermissionFailed', N'Error'),
			(N'AddQAKnowledgableUser', N'Trace'),
			(N'AddQAKnowledgableUser_PermissionFailed', N'Error'),
			(N'RemoveQAKnowledgableUser', N'Trace'),
			(N'RemoveQAKnowledgableUser_PermissionFailed', N'Error'),
			(N'SendPost', N'Trace'),
			(N'ModifyPost', N'Trace'),
			(N'RemovePost', N'Trace'),
			(N'SendComment', N'Trace'),
			(N'ModifyComment', N'Trace'),
			(N'RemoveComment', N'Trace'),
			(N'LikePost', N'Trace'),
			(N'DislikePost', N'Trace'),
			(N'UnlikePost', N'Trace'),
			(N'LikeComment', N'Trace'),
			(N'DislikeComment', N'Trace'),
			(N'UnlikeComment', N'Trace'),
			(N'AcceptFriendRequest', N'Trace'),
			(N'RejectFriendRequest', N'Trace'),
			(N'CreateUserGroup', N'Trace'),
			(N'ModifyUserGroup', N'Trace'),
			(N'RemoveUserGroup', N'Trace'),
			(N'AddUserGroupMember', N'Trace'),
			(N'RemoveUserGroupMember', N'Trace'),
			(N'SetUserGroupPermission', N'Trace'),
			(N'RemoveUserGroupPermission', N'Trace'),
			(N'SetUserGeneralInfo', N'Trace'),
			(N'Login_Failed', N'Error'),
			(N'SetFirstAndLastName', N'Trace'),
			(N'SetUserName', N'Trace'),
			(N'SetUserIsApproved', N'Trace'),
			(N'SetJobTitle', N'Trace'),
			(N'SetEmploymentType', N'Trace'),
			(N'SetBirthday', N'Trace'),
			(N'SetPhoneNumber', N'Trace'),
			(N'ModifyPhoneNumber', N'Trace'),
			(N'RemovePhoneNumber', N'Trace'),
			(N'SetMainPhoneNumber', N'Trace'),
			(N'SetEmailAddress', N'Trace'),
			(N'ModifyEmailAddress', N'Trace'),
			(N'RemoveEmailAddress', N'Trace'),
			(N'SetMainEmailAddress', N'Trace'),
			(N'Wiki_AccessDenied', N'Error'),
			(N'AddWikiTitle', N'Trace'),
			(N'AddWikiTitle_PermissionFailed', N'Error'),
			(N'ModifyWikiTitle', N'Trace'),
			(N'ModifyWikiTitle_PermissionFailed', N'Error'),
			(N'SetWikiTitlesOrder', N'Trace'),
			(N'SetWikiTitlesOrder_PermissionFailed', N'Error'),
			(N'RemoveWikiTitle', N'Trace'),
			(N'RemoveWikiTitle_PermissionFailed', N'Error'),
			(N'RecycleWikiTitle', N'Trace'),
			(N'RecycleWikiTitle_PermissionFailed', N'Error'),
			(N'AddWikiParagraph', N'Trace'),
			(N'AddWikiParagraph_PermissionFailed', N'Error'),
			(N'ModifyWikiParagraph', N'Trace'),
			(N'ModifyWikiParagraph_PermissionFailed', N'Error'),
			(N'SuggestWikiParagraphChange_PermissionFailed', N'Error'),
			(N'RemoveWikiParagraph', N'Trace'),
			(N'RemoveWikiParagraph_PermissionFailed', N'Error'),
			(N'RecycleWikiParagraph', N'Trace'),
			(N'RecycleWikiParagraph_PermissionFailed', N'Error'),
			(N'SetWikiParagraphsOrder', N'Trace'),
			(N'SetWikiParagraphsOrder_PermissionFailed', N'Error'),
			(N'AcceptWikiParagraphChange', N'Trace'),
			(N'AcceptWikiParagraphChange_PermissionFailed', N'Error'),
			(N'RejectWikiParagraphChange', N'Trace'),
			(N'RejectWikiParagraphChange_PermissionFailed', N'Error'),
			(N'RemoveWikiParagraphChange', N'Trace'),
			(N'RemoveWikiParagraphChange_PermissionFailed', N'Error'),
			(N'CreateState', N'Trace'),
			(N'CreateState_PermissionFailed', N'Error'),
			(N'ModifyState', N'Trace'),
			(N'ModifyState_PermissionFailed', N'Error'),
			(N'RemoveState', N'Trace'),
			(N'RemoveState_PermissionFailed', N'Error'),
			(N'CreateWorkFlow', N'Trace'),
			(N'CreateWorkFlow_PermissionFailed', N'Error'),
			(N'ModifyWorkFlow', N'Trace'),
			(N'ModifyWorkFlow_PermissionFailed', N'Error'),
			(N'RemoveWorkFlow', N'Trace'),
			(N'RemoveWorkFlow_PermissionFailed', N'Error'),
			(N'GetWorkFlow_PermissionFailed', N'Error'),
			(N'AddWorkFlowState', N'Trace'),
			(N'AddWorkFlowState_PermissionFailed', N'Error'),
			(N'RemoveWorkFlowState', N'Trace'),
			(N'RemoveWorkFlowState_PermissionFailed', N'Error'),
			(N'ModifyWorkFlowStateDescription', N'Trace'),
			(N'ModifyWorkFlowStateDescription_PermissionFailed', N'Error'),
			(N'SetWorkFlowStateTag', N'Trace'),
			(N'SetWorkFlowStateTag_PermissionFailed', N'Error'),
			(N'RemoveWorkFlowStateTag', N'Trace'),
			(N'RemoveWorkFlowStateTag_PermissionFailed', N'Error'),
			(N'SetWorkFlowStateDirector', N'Trace'),
			(N'SetWorkFlowStateDirector_PermissionFailed', N'Error'),
			(N'SetWorkFlowStatePoll', N'Trace'),
			(N'SetWorkFlowStatePoll_PermissionFailed', N'Error'),
			(N'SetWorkFlowStateDataNeedsType', N'Trace'),
			(N'SetWorkFlowStateDataNeedsType_PermissionFailed', N'Error'),
			(N'SetWorkFlowStateDataNeedsDescription', N'Trace'),
			(N'SetWorkFlowStateDataNeedsDescription_PermissionFailed', N'Error'),
			(N'SetWorkFlowStateDescriptionAsNeeded', N'Trace'),
			(N'SetWorkFlowStateDescriptionAsNeeded_PermissionFailed', N'Error'),
			(N'SetWorkFlowStateDescriptionAsNotNeeded', N'Trace'),
			(N'SetWorkFlowStateDescriptionAsNotNeeded_PermissionFailed', N'Error'),
			(N'SetWorkFlowStateHideOwnerNameAsNeeded', N'Trace'),
			(N'SetWorkFlowStateHideOwnerNameAsNeeded_PermissionFailed', N'Error'),
			(N'SetWorkFlowStateHideOwnerNameAsNotNeeded', N'Trace'),
			(N'SetWorkFlowStateHideOwnerNameAsNotNeeded_PermissionFailed', N'Error'),
			(N'SetWorkFlowStateEditPermission', N'Trace'),
			(N'SetWorkFlowStateEditPermission_PermissionFailed', N'Error'),
			(N'SetDataNeedRequestsAsFree', N'Trace'),
			(N'SetDataNeedRequestsAsFree_PermissionFailed', N'Error'),
			(N'SetDataNeedRequestsAsNotFree', N'Trace'),
			(N'SetDataNeedRequestsAsNotFree_PermissionFailed', N'Error'),
			(N'SetStateDataNeed', N'Trace'),
			(N'SetStateDataNeed_PermissionFailed', N'Error'),
			(N'RemoveStateDataNeed', N'Trace'),
			(N'RemoveStateDataNeed_PermissionFailed', N'Error'),
			(N'SetRejectionSettings', N'Trace'),
			(N'SetRejectionSettings_PermissionFailed', N'Error'),
			(N'SetMaxAllowedRejections', N'Trace'),
			(N'SetMaxAllowedRejections_PermissionFailed', N'Error'),
			(N'SetStateDataNeedInstanceAsFilled', N'Trace'),
			(N'SetStateDataNeedInstanceAsFilled_PermissionFailed', N'Error'),
			(N'SetStateDataNeedInstanceAsNotFilled', N'Trace'),
			(N'SetStateDataNeedInstanceAsNotFilled_PermissionFailed', N'Error'),
			(N'RemoveStateDataNeedInstance', N'Trace'),
			(N'RemoveStateDataNeedInstance_PermissionFailed', N'Error'),
			(N'AddStateConnection', N'Trace'),
			(N'AddStateConnection_PermissionFailed', N'Error'),
			(N'MoveStateConnectionUp', N'Trace'),
			(N'MoveStateConnectionUp_PermissionFailed', N'Error'),
			(N'MoveStateConnectionDown', N'Trace'),
			(N'MoveStateConnectionDown_PermissionFailed', N'Error'),
			(N'RemoveStateConnection', N'Trace'),
			(N'RemoveStateConnection_PermissionFailed', N'Error'),
			(N'SetStateConnectionLabel', N'Trace'),
			(N'SetStateConnectionLabel_PermissionFailed', N'Error'),
			(N'SetStateConnectionAttachmentStatus', N'Trace'),
			(N'SetStateConnectionAttachmentStatus_PermissionFailed', N'Error'),
			(N'SetStateConnectionDirector', N'Trace'),
			(N'SetStateConnectionDirector_PermissionFailed', N'Error'),
			(N'SetStateConnectionForm', N'Trace'),
			(N'SetStateConnectionForm_PermissionFailed', N'Error'),
			(N'RemoveStateConnectionForm', N'Trace'),
			(N'RemoveStateConnectionForm_PermissionFailed', N'Error'),
			(N'AddAutoMessage', N'Trace'),
			(N'AddAutoMessage_PermissionFailed', N'Error'),
			(N'ModifyAutoMessage', N'Trace'),
			(N'ModifyAutoMessage_PermissionFailed', N'Error'),
			(N'RemoveAutoMessage', N'Trace'),
			(N'RemoveAutoMessage_PermissionFailed', N'Error'),
			(N'TerminateWorkFlow', N'Trace'),
			(N'TerminateWorkFlow_PermissionFailed', N'Error'),
			(N'RestartWorkFlow_PermissionFailed', N'Error'),
			(N'AddOwnerWorkFlow', N'Trace'),
			(N'AddOwnerWorkFlow_PermissionFailed', N'Error'),
			(N'RemoveOwnerWorkFlow', N'Trace'),
			(N'RemoveOwnerWorkFlow_PermissionFailed', N'Error'),
			(N'NotAuthorizedAnonymousRequest', N'Warn'),
			(N'PotentialCSRFAttack', N'Warn'),
			(N'PotentialReplayAttack', N'Warn'),
			(N'JobStarted', N'Info'),
			(N'UserLockedOut', N'Info'),
			(N'Download', N'Trace'),
			(N'KnowledgeEvaluation', N'Trace'),
			(N'RefuseKnowledgeEvaluation', N'Trace'),
			(N'InitialConfirmQuestion', N'Trace'),
			(N'SharePost', N'Trace'),
			(N'Search', N'Trace'),
			(N'Login', N'Trace'),
			(N'Logout', N'Trace'),
			(N'SuggestWikiParagraphChange', N'Trace'),
			(N'RestartWorkFlow', N'Trace')

	UPDATE L
		SET [Level] = I.[Level]
	FROM [dbo].[LG_Logs] AS L
		INNER JOIN @Items AS I
		ON I.[Action] = L.[Action]
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.25.2.0' BEGIN
	UPDATE L
		SET [Level] = N'Trace'
	FROM [dbo].[LG_Logs] AS L
	WHERE L.[Level] IS NULL
END
GO


IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.25.2.0' BEGIN
	DECLARE @Items TABLE ([Action] varchar(100), [Level] varchar(20))

	INSERT INTO @Items ([Action], [Level])
	VALUES	(N'ExportReportToExcel', N'Fatal'),
			(N'JobFailed', N'Fatal'),
			(N'ExtractFormsFromXML', N'Fatal'),
			(N'InitSearchIndexDocuments', N'Fatal'),
			(N'IndexUpdateJob', N'Fatal')

	UPDATE L
		SET [Level] = I.[Level]
	FROM [dbo].[LG_ErrorLogs] AS L
		INNER JOIN @Items AS I
		ON I.[Action] = L.[Subject]
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.25.2.0' BEGIN
	UPDATE L
		SET [Level] = N'Debug'
	FROM [dbo].[LG_ErrorLogs] AS L
	WHERE L.[Level] IS NULL
END
GO


IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.25.2.0' BEGIN
	UPDATE [dbo].[AppSetting]
		SET [Version] = 'v28.28.8.1' -- 13971112
END
GO




IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.28.8.1' BEGIN
	UPDATE [dbo].[AppSetting]
		SET [Version] = 'v28.30.9.3'
END
GO




IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.30.9.3' BEGIN
	UPDATE [dbo].[AppSetting]
		SET [Version] = 'v28.30.19.1'
END
GO




SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

SET ANSI_PADDING ON
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.30.19.1' BEGIN
	CREATE TABLE [dbo].[USR_RemoteServers](
		[ServerID] [uniqueidentifier] NOT NULL,
		[UserID] [uniqueidentifier] NOT NULL,
		[Name] [nvarchar](255) NOT NULL,
		[URL] [nvarchar](100) NOT NULL,
		[UserName] [nvarchar](100) NOT NULL,
		[Password] [varbinary](100) NOT NULL,
		[CreationDate] [datetime] NOT NULL,
		[LastModificationDate] [datetime] NULL,
		[ApplicationID] [uniqueidentifier] NULL
	 CONSTRAINT [PK_USR_RemoteServers] PRIMARY KEY CLUSTERED 
	(
		[ServerID] ASC
	)WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]
	) ON [PRIMARY]
END
GO

SET ANSI_PADDING OFF
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.30.19.1' BEGIN
	ALTER TABLE [dbo].[USR_RemoteServers]  WITH CHECK ADD  CONSTRAINT [FK_USR_RemoteServers_aspnet_Applications] FOREIGN KEY([ApplicationID])
	REFERENCES [dbo].[aspnet_Applications] ([ApplicationId])
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.30.19.1' BEGIN
	ALTER TABLE [dbo].[USR_RemoteServers] CHECK CONSTRAINT [FK_USR_RemoteServers_aspnet_Applications]
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.30.19.1' BEGIN
	ALTER TABLE [dbo].[USR_RemoteServers]  WITH CHECK ADD  CONSTRAINT [FK_USR_RemoteServers_aspnet_Users] FOREIGN KEY([UserID])
	REFERENCES [dbo].[aspnet_Users] ([UserId])
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.30.19.1' BEGIN
	ALTER TABLE [dbo].[USR_RemoteServers] CHECK CONSTRAINT [FK_USR_RemoteServers_aspnet_Users]
END
GO

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

SET ANSI_PADDING ON
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.30.19.1' BEGIN
	ALTER TABLE [dbo].[CN_Services]
	ADD [DisableFileUpload] [bit] NULL
END
GO

SET ANSI_PADDING OFF
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.30.19.1' BEGIN
	UPDATE [dbo].[AppSetting]
		SET [Version] = 'v28.33.3.1' -- 13980602
END
GO

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

SET ANSI_PADDING ON
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.33.3.1' BEGIN
	ALTER TABLE [dbo].[CN_Services]
	ADD [UniqueAdminMember] [bit] NULL
END
GO

SET ANSI_PADDING OFF
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.33.3.1' BEGIN
	UPDATE S
		SET UniqueAdminMember = 1
	FROM [dbo].[CN_NodeTypes] AS NT
		INNER JOIN [dbo].[CN_Services] AS S
		ON S.ApplicationID = NT.ApplicationID AND S.NodeTypeID = NT.NodeTypeID
	WHERE NT.AdditionalID = N'2'
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.33.3.1' BEGIN
	UPDATE S
		SET UniqueMembership = 1,
			UniqueAdminMember = 1
	FROM [dbo].[CN_NodeTypes] AS NT
		INNER JOIN [dbo].[CN_Services] AS S
		ON S.ApplicationID = NT.ApplicationID AND S.NodeTypeID = NT.NodeTypeID
	WHERE NT.AdditionalID = N'6'
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.33.3.1' BEGIN
	UPDATE [dbo].[AppSetting]
		SET [Version] = 'v28.35.8.6' -- 13980704
END
GO

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

SET ANSI_PADDING ON
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.35.8.6' BEGIN
	ALTER TABLE [dbo].[CN_Services]
	ADD [DisableRelatedNodesSelect] [bit] NULL
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.35.8.6' BEGIN
	ALTER TABLE [dbo].[CN_Services]
	ADD [DisableAbstractAndKeywords] [bit] NULL
END
GO

SET ANSI_PADDING OFF
GO


IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.35.8.6' BEGIN
	UPDATE [dbo].[AppSetting]
		SET [Version] = 'v28.35.14.0' -- 13980827
END
GO

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

SET ANSI_PADDING ON
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.35.14.0' BEGIN
	ALTER TABLE [dbo].[KW_KnowledgeTypes]
	ADD [EvaluationsRemovable] [bit] NULL	
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.35.14.0' BEGIN
	ALTER TABLE [dbo].[KW_KnowledgeTypes]
	ADD [EvaluationsEditable] [bit] NULL	
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.35.14.0' BEGIN
	ALTER TABLE [dbo].[KW_KnowledgeTypes]
	ADD [UnhideEvaluators] [bit] NULL	
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.35.14.0' BEGIN
	ALTER TABLE [dbo].[KW_KnowledgeTypes]
	ADD [UnhideEvaluations] [bit] NULL	
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.35.14.0' BEGIN
	ALTER TABLE [dbo].[KW_KnowledgeTypes]
	ADD [UnhideNodeCreators] [bit] NULL	
END
GO

SET ANSI_PADDING OFF
GO


IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.35.14.0' BEGIN
	UPDATE [dbo].[AppSetting]
		SET [Version] = 'v28.35.22.3'
END
GO

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

SET ANSI_PADDING ON
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.35.22.3' BEGIN
	ALTER TABLE [dbo].[KW_History]
	ADD [ReplyToHistoryID] [bigint] NULL
END
GO

SET ANSI_PADDING OFF
GO


IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.35.22.3' BEGIN
	ALTER TABLE [dbo].[KW_History]  WITH CHECK ADD  CONSTRAINT [FK_KW_History_KW_History_ReplyToHistoryID] FOREIGN KEY([ReplyToHistoryID])
	REFERENCES [dbo].[KW_History] ([ID])
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.35.22.3' BEGIN
	ALTER TABLE [dbo].[KW_History] CHECK CONSTRAINT [FK_KW_History_KW_History_ReplyToHistoryID]
END
GO


SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.35.22.3' BEGIN
	CREATE TABLE [dbo].[KW_QuestionAnswersHistory](
		[VersionID] [uniqueidentifier] NOT NULL,
		[KnowledgeID] [uniqueidentifier] NOT NULL,
		[UserID] [uniqueidentifier] NOT NULL,
		[QuestionID] [uniqueidentifier] NOT NULL,
		[Title] [nvarchar](2000) NOT NULL,
		[Score] [float] NOT NULL,
		[ResponderUserID] [uniqueidentifier] NULL,
		[EvaluationDate] [datetime] NOT NULL,
		[Deleted] [bit] NOT NULL,
		[ApplicationID] [uniqueidentifier] NULL,
		[SelectedOptionID] [uniqueidentifier] NULL,
		[VersionDate] [datetime] NOT NULL
	 CONSTRAINT [PK_KW_QuestionAnswersHistory] PRIMARY KEY CLUSTERED 
	(
		[VersionID] ASC,
		[KnowledgeID] ASC,
		[UserID] ASC,
		[QuestionID] ASC
	)WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]
	) ON [PRIMARY]
END

GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.35.22.3' BEGIN
	ALTER TABLE [dbo].[KW_QuestionAnswersHistory]  WITH CHECK ADD  CONSTRAINT [FK_KW_QuestionAnswersHistory_aspnet_Applications] FOREIGN KEY([ApplicationID])
	REFERENCES [dbo].[aspnet_Applications] ([ApplicationId])
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.35.22.3' BEGIN
	ALTER TABLE [dbo].[KW_QuestionAnswersHistory] CHECK CONSTRAINT [FK_KW_QuestionAnswersHistory_aspnet_Applications]
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.35.22.3' BEGIN
	ALTER TABLE [dbo].[KW_QuestionAnswersHistory]  WITH CHECK ADD  CONSTRAINT [FK_KW_QuestionAnswersHistory_aspnet_Users] FOREIGN KEY([UserID])
	REFERENCES [dbo].[aspnet_Users] ([UserId])
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.35.22.3' BEGIN
	ALTER TABLE [dbo].[KW_QuestionAnswersHistory] CHECK CONSTRAINT [FK_KW_QuestionAnswersHistory_aspnet_Users]
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.35.22.3' BEGIN
	ALTER TABLE [dbo].[KW_QuestionAnswersHistory]  WITH CHECK ADD  CONSTRAINT [FK_KW_QuestionAnswersHistory_CN_Nodes] FOREIGN KEY([KnowledgeID])
	REFERENCES [dbo].[CN_Nodes] ([NodeID])
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.35.22.3' BEGIN
	ALTER TABLE [dbo].[KW_QuestionAnswersHistory] CHECK CONSTRAINT [FK_KW_QuestionAnswersHistory_CN_Nodes]
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.35.22.3' BEGIN
	ALTER TABLE [dbo].[KW_QuestionAnswersHistory]  WITH CHECK ADD  CONSTRAINT [FK_KW_QuestionAnswersHistory_KW_Questions] FOREIGN KEY([QuestionID])
	REFERENCES [dbo].[KW_Questions] ([QuestionID])
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.35.22.3' BEGIN
	ALTER TABLE [dbo].[KW_QuestionAnswersHistory] CHECK CONSTRAINT [FK_KW_QuestionAnswersHistory_KW_Questions]
END
GO


SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.35.22.3' BEGIN
	UPDATE [dbo].[AppSetting]
		SET [Version] = 'v28.37.5.0' -- 13981204
END
GO

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

SET ANSI_PADDING ON
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.37.5.0' BEGIN
	ALTER TABLE [dbo].[FG_ExtendedFormElements]
	ADD [Help] [nvarchar](2000) NULL
END
GO

SET ANSI_PADDING OFF
GO



IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.37.5.0' BEGIN
	UPDATE [dbo].[AppSetting]
		SET [Version] = 'v28.38.4.2' -- 13990118
END
GO

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.38.4.2' BEGIN
	DELETE [dbo].[PRVC_DefaultPermissions]
	WHERE DefaultValue NOT IN (N'Public', N'Restricted')
END
GO


IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.38.4.2' BEGIN
	ALTER TABLE [dbo].[KW_KnowledgeTypes]
	ADD TextOptions nvarchar(max) NULL
END
GO


IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.38.4.2' BEGIN
	ALTER TABLE [dbo].[KW_KnowledgeTypes]
	ADD EvaluationsEditableForAdmin bit NULL
END
GO


IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.38.4.2' BEGIN
	ALTER TABLE [dbo].[KW_QuestionAnswers]
	ADD AdminScore float NULL
END
GO


IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.38.4.2' BEGIN
	ALTER TABLE [dbo].[KW_QuestionAnswers]
	ADD AdminSelectedOptionID uniqueidentifier NULL
END
GO


IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.38.4.2' BEGIN
	ALTER TABLE [dbo].[KW_QuestionAnswers]
	ADD AdminID uniqueidentifier NULL
END
GO


IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.38.4.2' BEGIN
	EXEC ('UPDATE [dbo].[KW_QuestionAnswers] SET AdminID = [ResponderUserID]')
END
GO


IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.38.4.2' BEGIN
	ALTER TABLE [dbo].[KW_QuestionAnswers]
	DROP COLUMN [ResponderUserID]
END
GO


IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.38.4.2' BEGIN
	ALTER TABLE [dbo].[KW_QuestionAnswersHistory]
	ADD AdminScore float NULL
END
GO


IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.38.4.2' BEGIN
	ALTER TABLE [dbo].[KW_QuestionAnswersHistory]
	ADD AdminSelectedOptionID uniqueidentifier NULL
END
GO


IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.38.4.2' BEGIN
	ALTER TABLE [dbo].[KW_QuestionAnswersHistory]
	ADD AdminID uniqueidentifier NULL
END
GO


IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.38.4.2' BEGIN
	ALTER TABLE [dbo].[KW_QuestionAnswersHistory]
	ADD WFVersionID int NULL
END
GO


IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.38.4.2' BEGIN
	EXEC ('UPDATE [dbo].[KW_QuestionAnswersHistory] SET AdminID = ResponderUserID')
END
GO


IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.38.4.2' BEGIN
	ALTER TABLE [dbo].[KW_QuestionAnswersHistory]
	DROP COLUMN [ResponderUserID]
END
GO


IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.38.4.2' BEGIN
	UPDATE [dbo].[KW_QuestionAnswersHistory]
		SET WFVersionID = 1
END
GO


IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.38.4.2' BEGIN
	ALTER TABLE [dbo].[KW_History]
	ADD WFVersionID int NULL
END
GO


IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.38.4.2' BEGIN
	ALTER TABLE [dbo].[KW_History]
	ADD TextOptions nvarchar(1000) NULL
END
GO


IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.38.4.2' BEGIN
	ALTER TABLE [dbo].[KW_History]
	ADD DeputyUserID uniqueidentifier NULL
END
GO


IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.38.4.2' BEGIN
	ALTER TABLE [dbo].[KW_History]
	ADD UniqueID uniqueidentifier NULL
END
GO


IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.38.4.2' BEGIN
	UPDATE [dbo].[KW_History]
		SET WFVersionID = 1
END
GO


IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.38.4.2' BEGIN
	UPDATE H
		SET WFVersionID = 2
	FROM [dbo].[KW_History] AS H
		INNER JOIN (
			SELECT A.KnowledgeID, DATEADD(SECOND, 10, MAX(A.EvaluationDate)) AS DT
			FROM [dbo].[KW_QuestionAnswersHistory] AS A
			GROUP BY A.KnowledgeID
		) AS X
		ON X.KnowledgeID = H.KnowledgeID AND H.ActionDate > X.DT AND H.[Action] <> N'TerminateEvaluation'
END
GO


IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.38.4.2' BEGIN
	ALTER TABLE [dbo].[CN_Services]
	ADD EnablePreviousVersionSelect bit NULL
END
GO


IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.38.4.2' BEGIN
	UPDATE [dbo].[CN_Services]
		SET EnablePreviousVersionSelect = IsDocument
END
GO


IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.38.4.2' BEGIN
	UPDATE [dbo].[AppSetting]
		SET [Version] = 'v28.43.25.4'
END
GO

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.43.25.4' BEGIN
	UPDATE [dbo].[AppSetting]
		SET [Version] = 'v29.5.25.4' -- 13990507
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.5.25.4' BEGIN
	UPDATE [dbo].[AppSetting]
		SET [Version] = 'v29.6.25.4' -- 13990507
END
GO

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

WHILE EXISTS(SELECT TOP(1) * FROM sys.views) BEGIN
	DECLARE @ViewName varchar(500)
	DECLARE Cur cursor 

	FOR SELECT [Name] 
	FROM sys.views
	OPEN Cur
	FETCH NEXT FROM Cur INTO @ViewName
	WHILE @@FETCH_STATUS = 0
	BEGIN
		BEGIN TRY
			EXEC('DROP VIEW ' + @ViewName)
		END TRY
		BEGIN CATCH
		END CATCH
		
		FETCH NEXT FROM Cur INTO @ViewName
	END
	CLOSE Cur
	DEALLOCATE Cur
END

GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.6.25.4' BEGIN
	ALTER TABLE [dbo].[USR_EmailAddresses]
	ADD Validated bit NULL
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.6.25.4' BEGIN
	ALTER TABLE [dbo].[USR_EmailAddresses]
	DROP CONSTRAINT [FK_USR_EmailAddresses_aspnet_Applications]
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.6.25.4' BEGIN
	ALTER TABLE [dbo].[USR_EmailAddresses]
	DROP COLUMN ApplicationID
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.6.25.4' BEGIN
	ALTER TABLE [dbo].[USR_PhoneNumbers]
	ADD Validated bit NULL
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.6.25.4' BEGIN
	ALTER TABLE [dbo].[USR_PhoneNumbers]
	DROP CONSTRAINT [FK_USR_PhoneNumbers_aspnet_Applications]
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.6.25.4' BEGIN
	ALTER TABLE [dbo].[USR_PhoneNumbers]
	DROP COLUMN ApplicationID
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.6.25.4' BEGIN
	CREATE TABLE [dbo].[USR_UserApplications](
		[UserID] [uniqueidentifier] NOT NULL,
		[ApplicationID] [uniqueidentifier] NOT NULL
	 CONSTRAINT [PK_USR_UserApplications] PRIMARY KEY CLUSTERED 
	(
		[UserID] ASC,
		[ApplicationID] ASC
	)WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]
	) ON [PRIMARY]
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.6.25.4' BEGIN
	ALTER TABLE [dbo].[USR_UserApplications]  WITH CHECK ADD  CONSTRAINT [FK_USR_UserApplications_aspnet_Applications] FOREIGN KEY([ApplicationID])
	REFERENCES [dbo].[aspnet_Applications] ([ApplicationId])
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.6.25.4' BEGIN
	ALTER TABLE [dbo].[USR_UserApplications] CHECK CONSTRAINT [FK_USR_UserApplications_aspnet_Applications]
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.6.25.4' BEGIN
	ALTER TABLE [dbo].[USR_UserApplications]  WITH CHECK ADD  CONSTRAINT [FK_USR_UserApplications_aspnet_Users] FOREIGN KEY([UserID])
	REFERENCES [dbo].[aspnet_Users] ([UserId])
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.6.25.4' BEGIN
	ALTER TABLE [dbo].[USR_UserApplications] CHECK CONSTRAINT [FK_USR_UserApplications_aspnet_Users]
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.6.25.4' BEGIN
	DECLARE @str varchar(max) = 
		'INSERT INTO [dbo].[USR_UserApplications] (ApplicationID, UserID) ' +
		'SELECT P.ApplicationID, P.UserID ' +
		'FROM [dbo].[USR_Profile] AS P'
		
	EXEC (@str)
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.6.25.4' BEGIN
	ALTER TABLE [dbo].[aspnet_Users]
	DROP COLUMN [ApplicationID]
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.6.25.4' BEGIN
	ALTER TABLE [dbo].[aspnet_Membership]
	DROP CONSTRAINT [FK__aspnet_Me__Appli__009508B4]
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.6.25.4' BEGIN
	ALTER TABLE [dbo].[aspnet_Membership]
	DROP COLUMN [ApplicationID]
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.6.25.4' BEGIN
	ALTER TABLE [dbo].[USR_Profile]
	DROP CONSTRAINT [FK_USR_Profile_aspnet_Applications]
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.6.25.4' BEGIN
	ALTER TABLE [dbo].[USR_Profile]
	DROP COLUMN [ApplicationID]
END
GO


IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.6.25.4' BEGIN
	ALTER TABLE [dbo].[USR_EmailContacts]
	DROP CONSTRAINT [FK_USR_EmailContacts_aspnet_Applications]
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.6.25.4' BEGIN
	ALTER TABLE [dbo].[USR_EmailContacts]
	DROP COLUMN [ApplicationID]
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.6.25.4' BEGIN
	ALTER TABLE [dbo].[USR_PassResetTickets]
	DROP CONSTRAINT [FK_USR_PassResetTickets_aspnet_Applications]
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.6.25.4' BEGIN
	ALTER TABLE [dbo].[USR_PassResetTickets]
	DROP COLUMN [ApplicationID]
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.6.25.4' BEGIN
	ALTER TABLE [dbo].[USR_PasswordsHistory]
	DROP CONSTRAINT [FK_USR_PasswordsHistory_aspnet_Applications]
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.6.25.4' BEGIN
	ALTER TABLE [dbo].[USR_PasswordsHistory]
	DROP COLUMN [ApplicationID]
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.6.25.4' BEGIN
	ALTER TABLE [dbo].[USR_TemporaryUsers]
	DROP CONSTRAINT [FK_USR_TemporaryUsers_aspnet_Applications]
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.6.25.4' BEGIN
	ALTER TABLE [dbo].[USR_TemporaryUsers]
	DROP COLUMN [ApplicationID]
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.6.25.4' BEGIN
	ALTER TABLE [dbo].[USR_TemporaryUsers]
	ADD PhoneNumber varchar(20) NULL
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.6.25.4' BEGIN
	ALTER TABLE [dbo].[aspnet_Applications]
	ADD CreatorUserID uniqueidentifier NULL
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.6.25.4' BEGIN
	ALTER TABLE [dbo].[aspnet_Applications]
	ADD Deleted bit NULL
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.6.25.4' BEGIN
	ALTER TABLE [dbo].[aspnet_Applications]
	ADD Title nvarchar(255) NULL
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.6.25.4' BEGIN
	UPDATE [dbo].[AppSetting]
		SET [Version] = 'v29.6.26.0' -- 13990906
END
GO




SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.6.26.0' BEGIN
	ALTER TABLE [dbo].[FG_ExtendedForms]
	ADD TemplateFormID uniqueidentifier NULL
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.6.26.0' BEGIN
	ALTER TABLE [dbo].[FG_ExtendedForms]  WITH CHECK ADD  CONSTRAINT [FK_FG_ExtendedForms_FG_ExtendedForms_TemplateID] FOREIGN KEY([TemplateFormID])
	REFERENCES [dbo].[FG_ExtendedForms] ([FormID])
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.6.26.0' BEGIN
	ALTER TABLE [dbo].[FG_ExtendedForms] CHECK CONSTRAINT [FK_FG_ExtendedForms_FG_ExtendedForms_TemplateID]
END
GO


IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.6.26.0' BEGIN
	ALTER TABLE [dbo].[FG_ExtendedFormElements]
	ADD TemplateElementID uniqueidentifier NULL
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.6.26.0' BEGIN
	ALTER TABLE [dbo].[FG_ExtendedFormElements]  WITH CHECK ADD  CONSTRAINT [FK_FG_ExtendedFormElements_FG_ExtendedFormElements_TemplateID] FOREIGN KEY([TemplateElementID])
	REFERENCES [dbo].[FG_ExtendedFormElements] ([ElementID])
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.6.26.0' BEGIN
	ALTER TABLE [dbo].[FG_ExtendedFormElements] CHECK CONSTRAINT [FK_FG_ExtendedFormElements_FG_ExtendedFormElements_TemplateID]
END
GO


IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.6.26.0' BEGIN
	ALTER TABLE [dbo].[CN_NodeTypes]
	ADD TemplateTypeID uniqueidentifier NULL
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.6.26.0' BEGIN
	ALTER TABLE [dbo].[CN_NodeTypes]  WITH CHECK ADD  CONSTRAINT [FK_CN_NodeTypes_CN_NodeTypes_TemplateID] FOREIGN KEY([TemplateTypeID])
	REFERENCES [dbo].[CN_NodeTypes] ([NodeTypeID])
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.6.26.0' BEGIN
	ALTER TABLE [dbo].[CN_NodeTypes] CHECK CONSTRAINT [FK_CN_NodeTypes_CN_NodeTypes_TemplateID]
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.6.26.0' BEGIN
	ALTER TABLE [dbo].[FG_ExtendedFormElements]
	ADD InitialValue nvarchar(max) NULL
END
GO


IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.6.26.0' BEGIN
	ALTER TABLE [dbo].[CN_NodeTypes]
	ADD AvatarName varchar(50) NULL
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.6.26.0' BEGIN
	ALTER TABLE [dbo].[CN_Nodes]
	ADD AvatarName varchar(50) NULL
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.6.26.0' BEGIN
	ALTER TABLE [dbo].[USR_Profile]
	ADD AvatarName varchar(50) NULL
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.6.26.0' BEGIN
	ALTER TABLE [dbo].[aspnet_Applications]
	ADD AvatarName varchar(50) NULL
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.6.26.0' BEGIN
	ALTER TABLE [dbo].[USR_Profile]
	ADD TwoStepAuthentication varchar(50) NULL
END
GO


IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.6.26.0' BEGIN
	CREATE TABLE [dbo].[RV_WorkSpaces](
		WorkSpaceID uniqueidentifier NOT NULL,
		Name nvarchar(255) NOT NULL,
		[Description] nvarchar(2000) NULL,
		AvatarName varchar(50) NULL,
		CreatorUserID uniqueidentifier NOT NULL,
		CreationDate datetime NOT NULL,
		LastModifierUserID uniqueidentifier NULL,
		LastModificationDate datetime NULL,
		Deleted bit NOT NULL
	 CONSTRAINT [PK_RV_WorkSpaces] PRIMARY KEY CLUSTERED 
	(
		[WorkSpaceID] ASC
	)WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]
	) ON [PRIMARY]
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.6.26.0' BEGIN
	ALTER TABLE [dbo].[RV_WorkSpaces]  WITH CHECK ADD  CONSTRAINT [FK_RV_WorkSpaces_aspnet_Users_Creator] FOREIGN KEY([CreatorUserID])
	REFERENCES [dbo].[aspnet_Users] ([UserId])
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.6.26.0' BEGIN
	ALTER TABLE [dbo].[RV_WorkSpaces] CHECK CONSTRAINT [FK_RV_WorkSpaces_aspnet_Users_Creator]
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.6.26.0' BEGIN
	ALTER TABLE [dbo].[RV_WorkSpaces]  WITH CHECK ADD  CONSTRAINT [FK_RV_WorkSpaces_aspnet_Users_Modifier] FOREIGN KEY([LastModifierUserID])
	REFERENCES [dbo].[aspnet_Users] ([UserId])
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.6.26.0' BEGIN
	ALTER TABLE [dbo].[RV_WorkSpaces] CHECK CONSTRAINT [FK_RV_WorkSpaces_aspnet_Users_Modifier]
END
GO


IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.6.26.0' BEGIN
	CREATE TABLE [dbo].[RV_WorkSpaceApplications](
		[WorkSpaceID] uniqueidentifier NOT NULL,
		[ApplicationID] uniqueidentifier NOT NULL
	 CONSTRAINT [PK_RV_WorkSpaceApplications] PRIMARY KEY CLUSTERED 
	(
		[WorkSpaceID] ASC,
		[ApplicationID] ASC
	)WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]
	) ON [PRIMARY]
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.6.26.0' BEGIN
	ALTER TABLE [dbo].[RV_WorkSpaceApplications]  WITH CHECK ADD  CONSTRAINT [FK_RV_WorkSpaceApplications_RV_WorkSpaces] FOREIGN KEY([WorkSpaceID])
	REFERENCES [dbo].[RV_WorkSpaces] ([WorkSpaceID])
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.6.26.0' BEGIN
	ALTER TABLE [dbo].[RV_WorkSpaceApplications] CHECK CONSTRAINT [FK_RV_WorkSpaceApplications_RV_WorkSpaces]
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.6.26.0' BEGIN
	ALTER TABLE [dbo].[RV_WorkSpaceApplications]  WITH CHECK ADD  CONSTRAINT [FK_RV_WorkSpaceApplications_aspnet_Applications] FOREIGN KEY([ApplicationID])
	REFERENCES [dbo].[aspnet_Applications] ([ApplicationId])
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.6.26.0' BEGIN
	ALTER TABLE [dbo].[RV_WorkSpaceApplications] CHECK CONSTRAINT [FK_RV_WorkSpaceApplications_aspnet_Applications]
END
GO


IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.6.26.0' BEGIN
	ALTER TABLE [dbo].[aspnet_Applications]
	ADD [InvitationID] uniqueidentifier NULL
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.6.26.0' BEGIN
	ALTER TABLE [dbo].[aspnet_Applications]
	ADD [EnableInvitationLink] bit NULL
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.6.26.0' BEGIN
	ALTER TABLE [dbo].[aspnet_Applications]
	ADD [Language] varchar(50) NULL
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.6.26.0' BEGIN
	ALTER TABLE [dbo].[aspnet_Applications]
	ADD [Calendar] varchar(50) NULL
END
GO


IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.6.26.0' BEGIN
	ALTER TABLE [dbo].[USR_Profile]
	ADD [EnableNewsLetter] bit NULL
END
GO


IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.6.26.0' BEGIN
	UPDATE [dbo].[AppSetting]
		SET [Version] = 'v29.7.8.6' -- 14000227
END
GO

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.7.8.6' BEGIN
	UPDATE [dbo].[AppSetting]
		SET [Version] = 'v28.44.8.6' -- 14000227
END
GO

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.44.8.6' BEGIN
	UPDATE [dbo].[AppSetting]
		SET [Version] = 'v29.7.8.6'
END
GO

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.7.8.6' BEGIN
	ALTER TABLE [dbo].[aspnet_Applications]
	ADD [CreationDate] datetime NULL
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.7.8.6' BEGIN
	ALTER TABLE [dbo].[aspnet_Applications]
	ADD [Size] varchar(100) NULL
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.7.8.6' BEGIN
	ALTER TABLE [dbo].[aspnet_Applications]
	ADD [ExpertiseFieldID] uniqueidentifier NULL
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.7.8.6' BEGIN
	ALTER TABLE [dbo].[aspnet_Applications]
	ADD [ExpertiseFieldName] nvarchar(255)
END
GO



SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.7.8.6' BEGIN
	ALTER TABLE [dbo].[USR_UserApplications]
	ADD [Organization] [nvarchar](255) NULL
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.7.8.6' BEGIN
	ALTER TABLE [dbo].[USR_UserApplications]
	ADD [Department] [nvarchar](255) NULL
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.7.8.6' BEGIN
	ALTER TABLE [dbo].[USR_UserApplications]
	ADD [JobTitle] [nvarchar](255) NULL
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.7.8.6' BEGIN
	ALTER TABLE [dbo].[USR_UserApplications]
	ADD [EmploymentType] [varchar](50) NULL
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.7.8.6' BEGIN
	ALTER TABLE [dbo].[USR_UserApplications]
	ADD [CreationDate] datetime NULL
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.7.8.6' BEGIN
	ALTER TABLE [dbo].[USR_UserApplications]
	ADD [LastModificationDate] datetime NULL
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.7.8.6' BEGIN
	ALTER TABLE [dbo].[USR_UserApplications]
	ADD [Deleted] bit NULL
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.7.8.6' BEGIN
	EXEC ('UPDATE [dbo].[USR_UserApplications] SET Deleted = 0')
END
GO


SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.7.8.6' BEGIN
	ALTER TABLE [dbo].[USR_Profile]
	ADD [AboutMe] [nvarchar](2000) NULL
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.7.8.6' BEGIN
	ALTER TABLE [dbo].[USR_Profile]
	ADD [CountryOfResidence] [nvarchar](255) NULL
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.7.8.6' BEGIN
	ALTER TABLE [dbo].[USR_Profile]
	ADD [Province] [nvarchar](255) NULL
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.7.8.6' BEGIN
	ALTER TABLE [dbo].[USR_Profile]
	ADD [City] [nvarchar](255) NULL
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.7.8.6' BEGIN
	ALTER TABLE [dbo].[USR_Profile]
	ADD [Settings] [nvarchar](max) NULL
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.7.8.6' BEGIN
	EXEC ('UPDATE A ' +
		'SET CreationDate = X.MinDate ' +
	'FROM [dbo].[aspnet_Applications] AS A ' +
		'INNER JOIN ( ' +
			'SELECT lg.ApplicationID, MIN(lg.[Date]) AS MinDate ' +
			'FROM [dbo].[LG_Logs] AS lg ' +
			'GROUP BY lg.[ApplicationID] ' +
		') AS X ' +
		'ON A.ApplicationID = A.ApplicationID ' +
	'WHERE A.CreationDate IS NULL')
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.7.8.6' BEGIN
	EXEC ('UPDATE A ' +
		'SET CreationDate = ISNULL(X.MinDate, DATEADD(DAY, -10, GETDATE())) ' +
	'FROM [dbo].[USR_UserApplications] AS A ' +
		'LEFT JOIN ( ' +
			'SELECT lg.ApplicationID, lg.UserID, MIN(lg.[Date]) AS MinDate ' +
			'FROM [dbo].[LG_Logs] AS lg ' +
			'GROUP BY lg.[ApplicationID], lg.UserID ' +
		') AS X ' +
		'ON A.ApplicationID = A.ApplicationID AND X.UserID = A.UserID ' +
	'WHERE A.CreationDate IS NULL ')
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.7.8.6' BEGIN
	EXEC ('UPDATE A ' +
		'SET JobTitle = P.JobTitle ' +
	'FROM [dbo].[USR_UserApplications] AS A ' +
		'INNER JOIN [dbo].[USR_Profile] AS P ' +
		'ON P.UserID = A.UserID')
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.7.8.6' BEGIN
	IF EXISTS(select * FROM sys.views where name = 'USR_View_Users')
	DROP VIEW [dbo].[USR_View_Users]
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.7.8.6' BEGIN
	IF EXISTS(select * FROM sys.views where name = 'Users_Normal')
	DROP VIEW [dbo].[Users_Normal]
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.7.8.6' BEGIN
	ALTER TABLE [dbo].[USR_Profile]
	DROP COLUMN JobTitle
END
GO


IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.7.8.6' BEGIN
	EXEC ('UPDATE A ' +
		'SET EmploymentType = P.EmploymentType ' +
	'FROM [dbo].[USR_UserApplications] AS A ' +
		'INNER JOIN [dbo].[USR_Profile] AS P ' +
		'ON P.UserID = A.UserID')
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.7.8.6' BEGIN
	IF EXISTS(select * FROM sys.views where name = 'USR_View_Users')
	DROP VIEW [dbo].[USR_View_Users]
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.7.8.6' BEGIN
	IF EXISTS(select * FROM sys.views where name = 'Users_Normal')
	DROP VIEW [dbo].[Users_Normal]
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.7.8.6' BEGIN
	ALTER TABLE [dbo].[USR_Profile]
	DROP COLUMN EmploymentType
END
GO


IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.7.8.6' BEGIN
	CREATE TABLE [dbo].[LG_RawLogs](
		[LogID] [bigint] IDENTITY(1,1) NOT NULL,
		[UserID] [uniqueidentifier] NULL,
		[ApplicationID] [uniqueidentifier] NULL,
		[Date] [datetime] NOT NULL,
		[Info] [nvarchar](max) NULL
	 CONSTRAINT [PK_LG_RawLogs] PRIMARY KEY CLUSTERED 
	(
		[LogID] ASC
	)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
	) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.7.8.6' BEGIN
	ALTER TABLE [dbo].[LG_RawLogs]  WITH CHECK ADD  CONSTRAINT [FK_LG_RawLogs_aspnet_Applications] FOREIGN KEY([ApplicationID])
	REFERENCES [dbo].[aspnet_Applications] ([ApplicationId])
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.7.8.6' BEGIN
	ALTER TABLE [dbo].[LG_RawLogs] CHECK CONSTRAINT [FK_LG_RawLogs_aspnet_Applications]
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.7.8.6' BEGIN
	ALTER TABLE [dbo].[LG_RawLogs]  WITH CHECK ADD  CONSTRAINT [FK_LG_RawLogs_aspnet_Users] FOREIGN KEY([UserID])
	REFERENCES [dbo].[aspnet_Users] ([UserID])
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.7.8.6' BEGIN
ALTER TABLE [dbo].[LG_RawLogs] CHECK CONSTRAINT [FK_LG_RawLogs_aspnet_Users]
END
GO


IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.7.8.6' BEGIN
	ALTER TABLE [dbo].[FG_ExtendedFormElements]
	ADD [Info2] nvarchar(max) NULL
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.7.8.6' BEGIN
	ALTER TABLE [dbo].[FG_InstanceElements]
	ADD [Info2] nvarchar(max) NULL
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.7.8.6' BEGIN
	EXEC ('UPDATE [dbo].[FG_ExtendedFormElements] SET Info2 = Info')
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.7.8.6' BEGIN
	EXEC ('UPDATE [dbo].[FG_InstanceElements] SET Info2 = Info')
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.7.8.6' BEGIN
	ALTER TABLE [dbo].[FG_ExtendedFormElements]
	DROP COLUMN [Info]
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.7.8.6' BEGIN
	ALTER TABLE [dbo].[FG_InstanceElements]
	DROP COLUMN [Info]
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.7.8.6' BEGIN
	ALTER TABLE [dbo].[FG_ExtendedFormElements]
	ADD [Info] nvarchar(max) NULL
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.7.8.6' BEGIN
	ALTER TABLE [dbo].[FG_InstanceElements]
	ADD [Info] nvarchar(max) NULL
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.7.8.6' BEGIN
	EXEC ('UPDATE [dbo].[FG_ExtendedFormElements] SET Info = Info2')
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.7.8.6' BEGIN
	EXEC ('UPDATE [dbo].[FG_InstanceElements] SET Info = Info2')
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.7.8.6' BEGIN
	ALTER TABLE [dbo].[FG_ExtendedFormElements]
	DROP COLUMN [Info2]
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.7.8.6' BEGIN
	ALTER TABLE [dbo].[FG_InstanceElements]
	DROP COLUMN [Info2]
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.7.8.6' BEGIN
	ALTER TABLE [dbo].[WF_WorkFlowStates]
	ADD [UserID] uniqueidentifier NULL
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.7.8.6' BEGIN
	UPDATE [dbo].[AppSetting]
		SET [Version] = 'v29.7.8.9' -- 14000517
END
GO

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.7.8.9' BEGIN
	CREATE TABLE [dbo].[WF_WorkFlowActions](
		[ConnectionID] [uniqueidentifier] NOT NULL,
		[Action] [varchar](255) NOT NULL,
		[SequenceNumber] [int] NULL,
		[CreatorUserID] [uniqueidentifier] NULL,
		[CreationDate] [datetime] NULL,
		[LastModifierUserID] [uniqueidentifier] NULL,
		[LastModificationDate] [datetime] NULL,
		[Deleted] [bit] NOT NULL,
		[ApplicationID] [uniqueidentifier] NULL
	 CONSTRAINT [PK_WF_WorkFlowActions] PRIMARY KEY CLUSTERED 
	(
		[ConnectionID] ASC,
		[Action] ASC
	)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY],
	) ON [PRIMARY]
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.7.8.9' BEGIN
	ALTER TABLE [dbo].[WF_WorkFlowActions]  WITH CHECK ADD  CONSTRAINT [FK_WF_WorkFlowActions_aspnet_Applications] FOREIGN KEY([ApplicationID])
	REFERENCES [dbo].[aspnet_Applications] ([ApplicationId])
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.7.8.9' BEGIN
	ALTER TABLE [dbo].[WF_WorkFlowActions] CHECK CONSTRAINT [FK_WF_WorkFlowActions_aspnet_Applications]
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.7.8.9' BEGIN
	ALTER TABLE [dbo].[WF_WorkFlowActions]  WITH CHECK ADD  CONSTRAINT [FK_WF_WorkFlowActions_aspnet_Users_Creator] FOREIGN KEY([CreatorUserID])
	REFERENCES [dbo].[aspnet_Users] ([UserId])
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.7.8.9' BEGIN
	ALTER TABLE [dbo].[WF_WorkFlowActions] CHECK CONSTRAINT [FK_WF_WorkFlowActions_aspnet_Users_Creator]
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.7.8.9' BEGIN
	ALTER TABLE [dbo].[WF_WorkFlowActions]  WITH CHECK ADD  CONSTRAINT [FK_WF_WorkFlowActions_aspnet_Users_Modifier] FOREIGN KEY([LastModifierUserID])
	REFERENCES [dbo].[aspnet_Users] ([UserId])
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.7.8.9' BEGIN
	ALTER TABLE [dbo].[WF_WorkFlowActions] CHECK CONSTRAINT [FK_WF_WorkFlowActions_aspnet_Users_Modifier]
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.7.8.9' BEGIN
	ALTER TABLE [dbo].[WF_WorkFlowActions]  WITH CHECK ADD  CONSTRAINT [FK_WF_WorkFlowActions_WF_StateConnections] FOREIGN KEY([ConnectionID])
	REFERENCES [dbo].[WF_StateConnections] ([ID])
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.7.8.9' BEGIN
	ALTER TABLE [dbo].[WF_WorkFlowActions] CHECK CONSTRAINT [FK_WF_WorkFlowActions_WF_StateConnections]
END
GO

IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v29.7.8.9' BEGIN
	UPDATE [dbo].[AppSetting]
		SET [Version] = 'v28.45.0.0' -- 14000725
END
GO





SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


IF (SELECT TOP(1) X.[Version] FROM [dbo].[AppSetting] AS X) = N'v28.45.0.0' BEGIN
	UPDATE [dbo].[AppSetting]
		SET [Version] = 'v29.9.8.1' -- 14000725
END
GO

WHILE EXISTS(SELECT TOP(1) * FROM sys.objects WHERE [type] = 'p' AND is_ms_shipped = 0) BEGIN
	DECLARE @ProcName varchar(500)
	DECLARE Cur cursor 

	FOR SELECT [Name] 
	FROM sys.objects 
	WHERE [type] = 'p' AND is_ms_shipped = 0
	OPEN Cur
	FETCH NEXT FROM Cur INTO @ProcName
	WHILE @@FETCH_STATUS = 0
	BEGIN
		BEGIN TRY
			EXEC('DROP PROCEDURE ' + @ProcName)
		END TRY
		BEGIN CATCH
		END CATCH
			
		FETCH NEXT FROM Cur INTO @ProcName
	END
	CLOSE Cur
	DEALLOCATE Cur
END

GO

WHILE EXISTS(
	SELECT TOP(1) * 
	FROM sys.objects 
	WHERE [type] IN (N'FN', N'IF', N'TF', N'FS', N'FT') AND is_ms_shipped = 0
) BEGIN
	DECLARE @FuncName varchar(500)
	DECLARE Cur cursor 

	FOR SELECT [Name] 
	FROM sys.objects 
	WHERE [type] IN (N'FN', N'IF', N'TF', N'FS', N'FT') AND is_ms_shipped = 0
	OPEN Cur
	FETCH NEXT FROM Cur INTO @FuncName
	WHILE @@FETCH_STATUS = 0
	BEGIN
		BEGIN TRY
			EXEC('DROP FUNCTION ' + @FuncName)
		END TRY
		BEGIN CATCH
		END CATCH
			
		FETCH NEXT FROM Cur INTO @FuncName
	END
	CLOSE Cur
	DEALLOCATE Cur
END

GO

WHILE EXISTS(SELECT TOP(1) * FROM sys.types WHERE is_user_defined = 1) BEGIN
	DECLARE @TypeName varchar(500)
	DECLARE Cur cursor 

	FOR SELECT [Name] 
	FROM sys.types
	WHERE is_user_defined = 1
	OPEN Cur
	FETCH NEXT FROM Cur INTO @TypeName
	WHILE @@FETCH_STATUS = 0
	BEGIN
		BEGIN TRY
			EXEC('DROP TYPE ' + @TypeName)
		END TRY
		BEGIN CATCH
		END CATCH
			
		FETCH NEXT FROM Cur INTO @TypeName
	END
	CLOSE Cur
	DEALLOCATE Cur
END

GO



WHILE EXISTS(SELECT TOP(1) * FROM sys.views) BEGIN
	DECLARE @ViewName varchar(500)
	DECLARE Cur cursor 

	FOR SELECT [Name] 
	FROM sys.views
	OPEN Cur
	FETCH NEXT FROM Cur INTO @ViewName
	WHILE @@FETCH_STATUS = 0
	BEGIN
		BEGIN TRY
			EXEC('DROP VIEW ' + @ViewName)
		END TRY
		BEGIN CATCH
		END CATCH
		
		FETCH NEXT FROM Cur INTO @ViewName
	END
	CLOSE Cur
	DEALLOCATE Cur
END

GO

WHILE EXISTS(SELECT TOP(1) * FROM sys.objects WHERE [type] IN (N'TR') AND is_ms_shipped = 0) BEGIN
	DECLARE @TRName varchar(500)
	DECLARE Cur cursor 

	FOR SELECT [Name] 
	FROM sys.objects 
	WHERE [type] IN (N'TR') AND is_ms_shipped = 0
	OPEN Cur
	FETCH NEXT FROM Cur INTO @TRName
	WHILE @@FETCH_STATUS = 0
	BEGIN
		BEGIN TRY
			EXEC('DROP TRIGGER ' + @TRName)
		END TRY
		BEGIN CATCH
		END CATCH
			
		FETCH NEXT FROM Cur INTO @TRName
	END
	CLOSE Cur
	DEALLOCATE Cur
END

GO

WHILE EXISTS(SELECT TOP(1) * FROM sys.objects WHERE [type] = 'p' AND is_ms_shipped = 0) BEGIN
	DECLARE @ProcName varchar(500)
	DECLARE Cur cursor 

	FOR SELECT [Name] 
	FROM sys.objects 
	WHERE [type] = 'p' AND is_ms_shipped = 0
	OPEN Cur
	FETCH NEXT FROM Cur INTO @ProcName
	WHILE @@FETCH_STATUS = 0
	BEGIN
		BEGIN TRY
			EXEC('DROP PROCEDURE ' + @ProcName)
		END TRY
		BEGIN CATCH
		END CATCH
			
		FETCH NEXT FROM Cur INTO @ProcName
	END
	CLOSE Cur
	DEALLOCATE Cur
END

GO

WHILE EXISTS(
	SELECT TOP(1) * 
	FROM sys.objects 
	WHERE [type] IN (N'FN', N'IF', N'TF', N'FS', N'FT') AND is_ms_shipped = 0
) BEGIN
	DECLARE @FuncName varchar(500)
	DECLARE Cur cursor 

	FOR SELECT [Name] 
	FROM sys.objects 
	WHERE [type] IN (N'FN', N'IF', N'TF', N'FS', N'FT') AND is_ms_shipped = 0
	OPEN Cur
	FETCH NEXT FROM Cur INTO @FuncName
	WHILE @@FETCH_STATUS = 0
	BEGIN
		BEGIN TRY
			EXEC('DROP FUNCTION ' + @FuncName)
		END TRY
		BEGIN CATCH
		END CATCH
			
		FETCH NEXT FROM Cur INTO @FuncName
	END
	CLOSE Cur
	DEALLOCATE Cur
END

GO

WHILE EXISTS(SELECT TOP(1) * FROM sys.types WHERE is_user_defined = 1) BEGIN
	DECLARE @TypeName varchar(500)
	DECLARE Cur cursor 

	FOR SELECT [Name] 
	FROM sys.types
	WHERE is_user_defined = 1
	OPEN Cur
	FETCH NEXT FROM Cur INTO @TypeName
	WHILE @@FETCH_STATUS = 0
	BEGIN
		BEGIN TRY
			EXEC('DROP TYPE ' + @TypeName)
		END TRY
		BEGIN CATCH
		END CATCH
			
		FETCH NEXT FROM Cur INTO @TypeName
	END
	CLOSE Cur
	DEALLOCATE Cur
END

GO



WHILE EXISTS(SELECT TOP(1) * FROM sys.views) BEGIN
	DECLARE @ViewName varchar(500)
	DECLARE Cur cursor 

	FOR SELECT [Name] 
	FROM sys.views
	OPEN Cur
	FETCH NEXT FROM Cur INTO @ViewName
	WHILE @@FETCH_STATUS = 0
	BEGIN
		BEGIN TRY
			EXEC('DROP VIEW ' + @ViewName)
		END TRY
		BEGIN CATCH
		END CATCH
		
		FETCH NEXT FROM Cur INTO @ViewName
	END
	CLOSE Cur
	DEALLOCATE Cur
END

GO

WHILE EXISTS(SELECT TOP(1) * FROM sys.objects WHERE [type] IN (N'TR') AND is_ms_shipped = 0) BEGIN
	DECLARE @TRName varchar(500)
	DECLARE Cur cursor 

	FOR SELECT [Name] 
	FROM sys.objects 
	WHERE [type] IN (N'TR') AND is_ms_shipped = 0
	OPEN Cur
	FETCH NEXT FROM Cur INTO @TRName
	WHILE @@FETCH_STATUS = 0
	BEGIN
		BEGIN TRY
			EXEC('DROP TRIGGER ' + @TRName)
		END TRY
		BEGIN CATCH
		END CATCH
			
		FETCH NEXT FROM Cur INTO @TRName
	END
	CLOSE Cur
	DEALLOCATE Cur
END

GO

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

IF EXISTS(select * FROM sys.views where name = 'RV_View_NewGuid')
DROP VIEW [dbo].[RV_View_NewGuid]
GO


CREATE VIEW [dbo].[RV_View_NewGuid] WITH ENCRYPTION
AS
SELECT NEWID() AS ID

GO


SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

IF EXISTS(select * FROM sys.views where name = 'WF_View_CurrentStates')
DROP VIEW [dbo].[WF_View_CurrentStates]
GO

IF EXISTS(select * FROM sys.views where name = 'CN_View_Nodes_Normal')
DROP VIEW [dbo].[CN_View_Nodes_Normal]
GO


CREATE VIEW [dbo].[CN_View_Nodes_Normal] WITH SCHEMABINDING, ENCRYPTION
AS
SELECT  ND.NodeID, 
		ND.ApplicationID,
		ND.Name AS NodeName, 
		ND.[Description],
		ND.AdditionalID_Main AS NodeAdditionalID_Main, 
		ND.AdditionalID AS NodeAdditionalID, 
		ND.NodeTypeID,
		NT.Name AS TypeName, 
		NT.AdditionalID AS TypeAdditionalID, 
        ND.ParentNodeID,
        ND.Deleted, 
        ISNULL(ND.Searchable, 1) AS Searchable,
        ISNULL(ND.HideCreators, 0) AS HideCreators,
        NT.Deleted AS TypeDeleted,
        ND.Tags AS Tags, 
        ND.CreationDate AS CreationDate,
        ND.PublicationDate,
        ND.CreatorUserID AS CreatorUserID,
        ND.OwnerID AS OwnerID,
        ND.AreaID,
        ND.DocumentTreeNodeID,
        ND.Score,
        ND.[Status],
        ND.[WFState],
        ND.SequenceNumber,
        ND.IndexLastUpdateDate
FROM [dbo].[CN_Nodes] AS ND
	INNER JOIN [dbo].[CN_NodeTypes] AS NT
	ON NT.ApplicationID = ND.ApplicationID AND ND.NodeTypeID = NT.NodeTypeID

GO

SET ANSI_PADDING ON
GO

CREATE UNIQUE CLUSTERED INDEX PX_CN_View_Nodes_Normal ON [dbo].[CN_View_Nodes_Normal]
(
	[ApplicationID] ASC,
	[NodeID] ASC
)WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]
GO


SET NUMERIC_ROUNDABORT OFF;
SET ANSI_PADDING, ANSI_WARNINGS, CONCAT_NULL_YIELDS_NULL, ARITHABORT,
    QUOTED_IDENTIFIER, ANSI_NULLS ON;


IF EXISTS(select * FROM sys.views where name = 'KW_View_ContentFileExtensions')
DROP VIEW [dbo].[KW_View_ContentFileExtensions]
GO

IF EXISTS(select * FROM sys.views where name = 'KW_View_Knowledges')
DROP VIEW [dbo].[KW_View_Knowledges]
GO


CREATE VIEW [dbo].[KW_View_Knowledges] WITH SCHEMABINDING, ENCRYPTION
AS
SELECT  ND.NodeID AS KnowledgeID,
		ND.ApplicationID,
		ND.AdditionalID AS AdditionalID,
		NT.NodeTypeID AS KnowledgeTypeID,
		NT.AdditionalID AS TypeAdditionalID,
		NT.Name AS KnowledgeType,
		ND.AreaID,
		ND.OwnerID AS OwnerID,
		ND.DocumentTreeNodeID AS TreeNodeID,
		ND.PreviousVersionID AS PreviousVersionID,
		ND.Name AS Title,
		ND.CreatorUserID AS CreatorUserID,
		ND.CreationDate AS CreationDate,
		ND.[Status] AS [Status],
		ND.Score AS Score,
		ND.Searchable AS Searchable,
		ND.PublicationDate AS PublicationDate,
		ND.Deleted AS Deleted
FROM    [dbo].[CN_Nodes] AS ND
		INNER JOIN [dbo].[CN_Services] AS S
		INNER JOIN [dbo].[CN_NodeTypes] AS NT
		ON NT.ApplicationID = S.ApplicationID AND NT.NodeTypeID = S.NodeTypeID
		ON NT.ApplicationID = ND.ApplicationID AND NT.NodeTypeID = ND.NodeTypeID
WHERE S.IsKnowledge = 1

GO


CREATE UNIQUE CLUSTERED INDEX PK_KW_View_Knowledges_KnowledgeID ON [dbo].[KW_View_Knowledges]
(
	[ApplicationID] ASC,
	[KnowledgeID] ASC
)WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]
GO

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


IF EXISTS(select * FROM sys.views where name = 'ContentFileExtensions')
DROP VIEW [dbo].[ContentFileExtensions]
GO

IF EXISTS(select * FROM sys.views where name = 'KW_View_ContentFileExtensions')
DROP VIEW [dbo].[KW_View_ContentFileExtensions]
GO


CREATE VIEW [dbo].[KW_View_ContentFileExtensions] WITH SCHEMABINDING, ENCRYPTION
AS
SELECT	KW.TreeNodeID AS TreeNodeID, 
		KW.ApplicationID,
		KW.KnowledgeID AS KnowledgeID, 
		KW.Title AS KnowledgeTitle, 
		AF.Extension AS Extension,
		KW.Deleted AS Deleted
FROM [dbo].[DCT_Files] AS AF
	INNER JOIN [dbo].[KW_View_Knowledges] AS KW
	ON KW.ApplicationID = AF.ApplicationID AND KW.KnowledgeID = AF.OwnerID

GO


SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


IF EXISTS(select * FROM sys.views where name = 'CN_View_NodeRelations')
DROP VIEW [dbo].[CN_View_NodeRelations]
GO

CREATE VIEW [dbo].[CN_View_NodeRelations] WITH SCHEMABINDING, ENCRYPTION
AS
SELECT NR.ApplicationID,
	   NR.SourceNodeID AS SourceNodeID, 
	   NR.DestinationNodeID AS DestinationNodeID, 
	   NR.PropertyID AS RelationTypeID, 
	   NR.NominalValue AS NominalValue, 
       NR.NumericalValue AS NumericalValue, 
       NR.Deleted AS RelationDeleted, 
       RT.AdditionalID AS RelationTypeAdditionalID, 
       RT.Name AS RelationType, 
       RT.Deleted AS RelationTypeDeleted
FROM   dbo.CN_NodeRelations  AS NR 
	INNER JOIN dbo.CN_Properties AS RT
	ON RT.ApplicationID = NR.ApplicationID AND RT.PropertyID = NR.PropertyID
	
GO

CREATE UNIQUE CLUSTERED INDEX PX_CN_View_NodeRelations ON [dbo].[CN_View_NodeRelations]
(
	[ApplicationID] ASC,
	[SourceNodeID] ASC,
	[DestinationNodeID] ASC,
	[RelationTypeID] ASC
)WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]
GO

CREATE NONCLUSTERED INDEX [IX_CN_View_NodeRelations_DestinationNodeID] ON [dbo].[CN_View_NodeRelations] 
(
	[ApplicationID] ASC,
	[DestinationNodeID] ASC,
	[SourceNodeID] ASC,
	[RelationTypeID] ASC,
	[RelationDeleted] ASC,
	[RelationTypeAdditionalID] ASC,
	[RelationTypeDeleted] ASC
)WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]
GO


SET NUMERIC_ROUNDABORT OFF;
SET ANSI_PADDING, ANSI_WARNINGS, CONCAT_NULL_YIELDS_NULL, ARITHABORT,
    QUOTED_IDENTIFIER, ANSI_NULLS ON;


IF EXISTS(select * FROM sys.views where name = 'Users_Normal')
DROP VIEW [dbo].[Users_Normal]
GO


CREATE VIEW [dbo].[Users_Normal] WITH SCHEMABINDING, ENCRYPTION
AS
SELECT  APP.ApplicationID,
		U.UserId AS UserID, 
		U.UserName, 
		U.LoweredUserName,
		P.FirstName, 
		P.LastName, 
		P.BirthDay,
		P.AboutMe,
		P.City,
		APP.Organization,
		APP.Department,
		APP.JobTitle,
		APP.EmploymentType,
		P.Settings,
		P.MainPhoneID,
		P.MainEmailID,
		P.TwoStepAuthentication,
		M.IsApproved,
		M.IsLockedOut,
		M.CreateDate AS CreationDate,
		P.IndexLastUpdateDate,
		U.LastActivityDate
FROM    [dbo].[aspnet_Users] AS U
		INNER JOIN [dbo].[USR_Profile] AS P
		ON P.UserID = U.UserId
		INNER JOIN [dbo].[aspnet_Membership] AS M
		ON M.UserId = U.UserId
		INNER JOIN [dbo].[USR_UserApplications] AS APP
		ON APP.UserID = U.UserId

GO

CREATE UNIQUE CLUSTERED INDEX PK_View_Users_Normal_UserID ON [dbo].[Users_Normal]
(
	[ApplicationID] ASC,
	[UserID] ASC
)WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]
GO

SET NUMERIC_ROUNDABORT OFF;
SET ANSI_PADDING, ANSI_WARNINGS, CONCAT_NULL_YIELDS_NULL, ARITHABORT,
    QUOTED_IDENTIFIER, ANSI_NULLS ON;


IF EXISTS(select * FROM sys.views where name = 'USR_View_Users')
DROP VIEW [dbo].[USR_View_Users]
GO


CREATE VIEW [dbo].[USR_View_Users] WITH SCHEMABINDING, ENCRYPTION
AS
SELECT  U.UserId AS UserID, 
		U.UserName, 
		U.LoweredUserName,
		P.FirstName, 
		P.LastName, 
		P.BirthDay,
		P.MainPhoneID,
		P.MainEmailID,
		P.Settings,
		P.TwoStepAuthentication,
		M.IsApproved,
		M.IsLockedOut,
		M.CreateDate AS CreationDate
FROM    [dbo].[aspnet_Users] AS U
		INNER JOIN [dbo].[USR_Profile] AS P
		ON P.UserID = U.UserId
		INNER JOIN [dbo].[aspnet_Membership] AS M
		ON M.UserId = U.UserId

GO

CREATE UNIQUE CLUSTERED INDEX PK_USR_View_Users_UserID ON [dbo].[USR_View_Users]
(
	[UserID] ASC
)WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]
GO


SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

IF EXISTS(select * FROM sys.views where name = 'CN_View_InRelatedNodes')
DROP VIEW [dbo].[CN_View_InRelatedNodes]
GO

IF EXISTS(select * FROM sys.views where name = 'CN_View_OutRelatedNodes')
DROP VIEW [dbo].[CN_View_OutRelatedNodes]
GO


CREATE VIEW [dbo].[CN_View_InRelatedNodes] WITH SCHEMABINDING, ENCRYPTION
AS
SELECT  NR.ApplicationID,
		NR.DestinationNodeID AS NodeID,
		RN.NodeID AS RelatedNodeID,
		RN.NodeTypeID AS RelatedNodeTypeID,
		NR.PropertyID
FROM [dbo].[CN_NodeRelations] AS NR
	INNER JOIN [dbo].[CN_Nodes] AS RN
	ON RN.ApplicationID = NR.ApplicationID AND RN.NodeID = NR.SourceNodeID
WHERE NR.Deleted = 0 AND RN.Deleted = 0

GO

CREATE VIEW [dbo].[CN_View_OutRelatedNodes] WITH SCHEMABINDING, ENCRYPTION
AS
SELECT  NR.ApplicationID,
		NR.SourceNodeID AS NodeID,
		RN.NodeID AS RelatedNodeID,
		RN.NodeTypeID AS RelatedNodeTypeID,
		NR.PropertyID
FROM [dbo].[CN_NodeRelations] AS NR
	INNER JOIN [dbo].[CN_Nodes] AS RN
	ON RN.ApplicationID = NR.ApplicationID AND RN.NodeID = NR.DestinationNodeID
WHERE NR.Deleted = 0 AND RN.Deleted = 0

GO

CREATE UNIQUE CLUSTERED INDEX PX_CN_View_InRelatedNodes ON [dbo].[CN_View_InRelatedNodes]
(
	[ApplicationID] ASC,
	[NodeID] ASC,
	[RelatedNodeID] ASC,
	[RelatedNodeTypeID] ASC,
	[PropertyID] ASC
)WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]
GO

CREATE UNIQUE CLUSTERED INDEX PX_CN_View_OutRelatedNodes ON [dbo].[CN_View_OutRelatedNodes]
(
	[ApplicationID] ASC,
	[NodeID] ASC,
	[RelatedNodeID] ASC,
	[RelatedNodeTypeID] ASC,
	[PropertyID] ASC
)WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]
GO


SET NUMERIC_ROUNDABORT OFF;
SET ANSI_PADDING, ANSI_WARNINGS, CONCAT_NULL_YIELDS_NULL, ARITHABORT,
    QUOTED_IDENTIFIER, ANSI_NULLS ON;


IF EXISTS(select * FROM sys.views where name = 'CN_View_Experts')
DROP VIEW [dbo].[CN_View_Experts]
GO


CREATE VIEW [dbo].[CN_View_Experts] WITH SCHEMABINDING, ENCRYPTION
AS
SELECT  EX.ApplicationID,
		EX.NodeID AS NodeID,
		EX.UserID AS UserID,
		ND.NodeTypeID AS NodeTypeID,
		ND.Name AS NodeName
FROM    [dbo].[CN_Experts] AS EX
		INNER JOIN [dbo].[CN_Nodes] AS ND
		ON ND.ApplicationID = EX.ApplicationID AND ND.NodeID = EX.NodeID
		INNER JOIN [dbo].[aspnet_Membership] AS M
		ON M.UserId = EX.UserID
WHERE	(EX.Approved = 1 OR EX.SocialApproved = 1) AND 
		ND.Deleted = 0 AND M.IsApproved = 1

GO

CREATE UNIQUE CLUSTERED INDEX PK_CN_View_Experts_NodeID ON [dbo].[CN_View_Experts]
(
	[ApplicationID] ASC,
	[NodeID] ASC,
	[UserID] ASC
)WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]
GO

IF NOT EXISTS(SELECT * FROM sys.indexes WHERE name='IX_CN_View_Experts_UserID' AND 
	object_id = OBJECT_ID('CN_View_Experts'))
CREATE NONCLUSTERED INDEX [IX_CN_View_Experts_UserID] ON [dbo].[CN_View_Experts] 
(
	[ApplicationID] ASC,
	[UserID] ASC,
	[NodeID] ASC
)WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]
GO

SET NUMERIC_ROUNDABORT OFF;
SET ANSI_PADDING, ANSI_WARNINGS, CONCAT_NULL_YIELDS_NULL, ARITHABORT,
    QUOTED_IDENTIFIER, ANSI_NULLS ON;


IF EXISTS(select * FROM sys.views where name = 'CN_View_NodeMembers')
DROP VIEW [dbo].[CN_View_NodeMembers]
GO


CREATE VIEW [dbo].[CN_View_NodeMembers] WITH SCHEMABINDING, ENCRYPTION
AS
SELECT  NM.ApplicationID,
		NM.NodeID AS NodeID,
		NM.UserID AS UserID,
		ND.NodeTypeID AS NodeTypeID,
		ND.Name AS NodeName,
		NM.IsAdmin AS IsAdmin,
		CAST((CASE WHEN NM.[Status] = 'Pending' THEN 1 ELSE 0 END) AS bit) AS IsPending
FROM    [dbo].[CN_NodeMembers] AS NM
		INNER JOIN [dbo].[CN_Nodes] AS ND
		ON ND.ApplicationID = NM.ApplicationID AND ND.NodeID = NM.NodeID
		INNER JOIN [dbo].[aspnet_Membership] AS M
		ON M.UserId = NM.UserID
WHERE	NM.Deleted = 0 AND ND.Deleted = 0 AND M.IsApproved = 1

GO

CREATE UNIQUE CLUSTERED INDEX PK_CN_View_NodeMembers_NodeID ON [dbo].[CN_View_NodeMembers]
(
	[ApplicationID] ASC,
	[NodeID] ASC,
	[UserID] ASC
)WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]
GO

IF NOT EXISTS(SELECT * FROM sys.indexes WHERE name='IX_CN_View_NodeMembers_UserID' AND 
	object_id = OBJECT_ID('CN_View_NodeMembers'))
CREATE NONCLUSTERED INDEX [IX_CN_View_NodeMembers_UserID] ON [dbo].[CN_View_NodeMembers] 
(
	[ApplicationID] ASC,
	[UserID] ASC,
	[NodeID] ASC
)WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]
GO

SET NUMERIC_ROUNDABORT OFF;
SET ANSI_PADDING, ANSI_WARNINGS, CONCAT_NULL_YIELDS_NULL, ARITHABORT,
    QUOTED_IDENTIFIER, ANSI_NULLS ON;


IF EXISTS(select * FROM sys.views where name = 'CN_View_ListMembers')
DROP VIEW [dbo].[CN_View_ListMembers]
GO


CREATE VIEW [dbo].[CN_View_ListMembers] WITH SCHEMABINDING, ENCRYPTION
AS
SELECT  L.ApplicationID,
		L.ListID AS ListID,
		NM.UserID AS UserID,
		ND.NodeID AS NodeID,
		ND.NodeTypeID AS NodeTypeID,
		L.Name AS ListName,
		ND.Name AS NodeName
FROM    [dbo].[CN_Lists] AS L
		INNER JOIN [dbo].[CN_ListNodes] AS LN
		ON LN.ApplicationID = L.ApplicationID AND LN.NodeID = L.ListID
		INNER JOIN [dbo].[CN_Nodes] AS ND
		ON ND.ApplicationID = LN.ApplicationID AND ND.NodeID = LN.NodeID
		INNER JOIN [dbo].[CN_NodeMembers] AS NM
		ON NM.ApplicationID = ND.ApplicationID AND NM.NodeID = ND.NodeID
		INNER JOIN [dbo].[aspnet_Membership] AS M
		ON M.UserId = NM.UserID
WHERE	LN.Deleted = 0 AND ND.Deleted = 0 AND 
		NM.[Status] = N'Accepted' AND NM.Deleted = 0 AND M.IsApproved = 1

GO


CREATE UNIQUE CLUSTERED INDEX PK_CN_View_ListMembers_ListID ON [dbo].[CN_View_ListMembers]
(
	[ApplicationID] ASC,
	[ListID] ASC,
	[UserID] ASC,
	[NodeID] ASC
)WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]
GO

IF NOT EXISTS(SELECT * FROM sys.indexes WHERE name='IX_CN_View_ListMembers_UserID' AND 
	object_id = OBJECT_ID('CN_View_ListMembers'))
CREATE NONCLUSTERED INDEX [IX_CN_View_ListMembers_UserID] ON [dbo].[CN_View_ListMembers] 
(
	[ApplicationID] ASC,
	[UserID] ASC,
	[ListID] ASC,
	[NodeID] ASC
)WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]
GO

IF NOT EXISTS(SELECT * FROM sys.indexes WHERE name='IX_CN_View_ListMembers_NodeID' AND 
	object_id = OBJECT_ID('CN_View_ListMembers'))
CREATE NONCLUSTERED INDEX [IX_CN_View_ListMembers_NodeID] ON [dbo].[CN_View_ListMembers] 
(
	[ApplicationID] ASC,
	[NodeID] ASC,
	[ListID] ASC,
	[UserID] ASC
)WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]
GO

SET NUMERIC_ROUNDABORT OFF;
SET ANSI_PADDING, ANSI_WARNINGS, CONCAT_NULL_YIELDS_NULL, ARITHABORT,
    QUOTED_IDENTIFIER, ANSI_NULLS ON;


IF EXISTS(select * FROM sys.views where name = 'CN_View_ListExperts')
DROP VIEW [dbo].[CN_View_ListExperts]
GO


CREATE VIEW [dbo].[CN_View_ListExperts] WITH SCHEMABINDING, ENCRYPTION
AS
SELECT  L.ApplicationID,
		L.ListID AS ListID,
		EX.UserID AS UserID,
		ND.NodeID AS NodeID,
		ND.NodeTypeID AS NodeTypeID,
		L.Name AS ListName,
		ND.Name AS NodeName
FROM    [dbo].[CN_Lists] AS L
		INNER JOIN [dbo].[CN_ListNodes] AS LN
		ON LN.ApplicationID = L.ApplicationID AND LN.NodeID = L.ListID
		INNER JOIN [dbo].[CN_Nodes] AS ND
		ON ND.ApplicationID = LN.ApplicationID AND ND.NodeID = LN.NodeID
		INNER JOIN [dbo].[CN_Experts] AS EX
		ON ND.ApplicationID = EX.ApplicationID AND ND.NodeID = EX.NodeID
		INNER JOIN [dbo].[aspnet_Membership] AS M
		ON M.UserId = EX.UserID
WHERE	LN.Deleted = 0 AND ND.Deleted = 0 AND 
		(EX.Approved = 1 OR EX.SocialApproved = 1) AND M.IsApproved = 1

GO


CREATE UNIQUE CLUSTERED INDEX PK_CN_View_ListExperts_ListID ON [dbo].[CN_View_ListExperts]
(
	[ApplicationID] ASC,
	[ListID] ASC,
	[UserID] ASC,
	[NodeID] ASC
)WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]
GO

IF NOT EXISTS(SELECT * FROM sys.indexes WHERE name='IX_CN_View_ListExperts_UserID' AND 
	object_id = OBJECT_ID('CN_View_ListExperts'))
CREATE NONCLUSTERED INDEX [IX_CN_View_ListExperts_UserID] ON [dbo].[CN_View_ListExperts] 
(
	[ApplicationID] ASC,
	[UserID] ASC,
	[ListID] ASC,
	[NodeID] ASC
)WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]
GO

IF NOT EXISTS(SELECT * FROM sys.indexes WHERE name='IX_CN_View_ListExperts_NodeID' AND 
	object_id = OBJECT_ID('CN_View_ListExperts'))
CREATE NONCLUSTERED INDEX [IX_CN_View_ListExperts_NodeID] ON [dbo].[CN_View_ListExperts] 
(
	[ApplicationID] ASC,
	[NodeID] ASC,
	[ListID] ASC,
	[UserID] ASC
)WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]
GO

SET NUMERIC_ROUNDABORT OFF;
SET ANSI_PADDING, ANSI_WARNINGS, CONCAT_NULL_YIELDS_NULL, ARITHABORT,
    QUOTED_IDENTIFIER, ANSI_NULLS ON;


IF EXISTS(select * FROM sys.views where name = 'CN_View_ListAdmins')
DROP VIEW [dbo].[CN_View_ListAdmins]
GO


CREATE VIEW [dbo].[CN_View_ListAdmins] WITH SCHEMABINDING, ENCRYPTION
AS
SELECT  L.ApplicationID,
		L.ListID AS ListID,
		LA.UserID AS UserID,
		ND.NodeID AS NodeID,
		L.Name AS ListName
FROM    [dbo].[CN_Lists] AS L
		INNER JOIN [dbo].[CN_ListNodes] AS LN
		ON LN.ApplicationID = L.ApplicationID AND LN.ListID = L.ListID
		INNER JOIN [dbo].[CN_Nodes] AS ND
		ON ND.ApplicationID = LN.ApplicationID AND ND.NodeID = LN.NodeID
		INNER JOIN [dbo].[CN_ListAdmins] AS LA
		ON LA.ApplicationID = L.ApplicationID AND LA.ListID = L.ListID
		INNER JOIN [dbo].[aspnet_Membership] AS M
		ON M.UserId = LA.UserID
WHERE	LN.Deleted = 0 AND ND.Deleted = 0 AND LA.Deleted = 0 AND M.IsApproved = 1

GO


CREATE UNIQUE CLUSTERED INDEX PK_CN_View_ListAdmins_ListID ON [dbo].[CN_View_ListAdmins]
(
	[ApplicationID] ASC,
	[ListID] ASC,
	[UserID] ASC,
	[NodeID] ASC
)WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]
GO

IF NOT EXISTS(SELECT * FROM sys.indexes WHERE name='IX_CN_View_ListAdmins_UserID' AND 
	object_id = OBJECT_ID('CN_View_ListAdmins'))
CREATE NONCLUSTERED INDEX [IX_CN_View_ListAdmins_UserID] ON [dbo].[CN_View_ListAdmins] 
(
	[ApplicationID] ASC,
	[UserID] ASC,
	[ListID] ASC,
	[NodeID] ASC
)WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]
GO

IF NOT EXISTS(SELECT * FROM sys.indexes WHERE name='IX_CN_View_ListAdmins_NodeID' AND 
	object_id = OBJECT_ID('CN_View_ListAdmins'))
CREATE NONCLUSTERED INDEX [IX_CN_View_ListAdmins_NodeID] ON [dbo].[CN_View_ListAdmins] 
(
	[ApplicationID] ASC,
	[NodeID] ASC,
	[ListID] ASC,
	[UserID] ASC
)WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]
GO

SET NUMERIC_ROUNDABORT OFF;
SET ANSI_PADDING, ANSI_WARNINGS, CONCAT_NULL_YIELDS_NULL, ARITHABORT,
    QUOTED_IDENTIFIER, ANSI_NULLS ON;


IF EXISTS(select * FROM sys.views where name = 'PRVC_View_Confidentialities')
DROP VIEW [dbo].[PRVC_View_Confidentialities]
GO


CREATE VIEW [dbo].[PRVC_View_Confidentialities] WITH SCHEMABINDING, ENCRYPTION
AS
SELECT  S.ApplicationID,
		S.ObjectID,
		CL.ID AS ConfidentialityID,
		CL.LevelID AS LevelID,
		CL.Title AS [Level]
FROM    [dbo].[PRVC_ConfidentialityLevels] AS CL
		INNER JOIN [dbo].[PRVC_Settings] AS S
		ON S.ApplicationID = CL.ApplicationID AND S.ConfidentialityID = CL.ID
WHERE CL.Deleted = 0 AND S.ConfidentialityID IS NOT NULL

GO


CREATE UNIQUE CLUSTERED INDEX PK_PRVC_View_Confidentialities_ObjectID ON [dbo].[PRVC_View_Confidentialities]
(
	[ObjectID] ASC,
	[ApplicationID] ASC
)WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]
GO

SET NUMERIC_ROUNDABORT OFF;
SET ANSI_PADDING, ANSI_WARNINGS, CONCAT_NULL_YIELDS_NULL, ARITHABORT,
    QUOTED_IDENTIFIER, ANSI_NULLS ON;


IF EXISTS(select * FROM sys.views where name = 'USR_View_Friends')
DROP VIEW [dbo].[USR_View_Friends]
GO


CREATE VIEW [dbo].[USR_View_Friends] WITH SCHEMABINDING, ENCRYPTION
AS
SELECT	F.ApplicationID,
		UN.UserID,
		CASE 
			WHEN UN.UserID = F.SenderUserID THEN F.ReceiverUserID 
			ELSE F.SenderUserID 
		END AS FriendID,
		CAST((CASE WHEN UN.UserID = F.SenderUserID THEN 1 ELSE 0 END) AS bit) AS IsSender,
		F.RequestDate,
		F.AcceptionDate,
		F.AreFriends
FROM [dbo].[aspnet_Users] AS UN
	INNER JOIN [dbo].[USR_Friends] AS F
	ON (F.SenderUserID = UN.UserID OR F.ReceiverUserID = UN.UserID)
WHERE F.Deleted = 0

GO


CREATE UNIQUE CLUSTERED INDEX PK_USR_View_Friends_UserID ON [dbo].[USR_View_Friends]
(
	[ApplicationID] ASC,
	[UserID] ASC,
	[FriendID] ASC
)WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]

GO


SET NUMERIC_ROUNDABORT OFF;
SET ANSI_PADDING, ANSI_WARNINGS, CONCAT_NULL_YIELDS_NULL, ARITHABORT,
    QUOTED_IDENTIFIER, ANSI_NULLS ON;


IF EXISTS(select * FROM sys.views where name = 'CN_View_TagRelations_WikiContext')
DROP VIEW [dbo].[CN_View_TagRelations_WikiContext]
GO

CREATE VIEW [dbo].[CN_View_TagRelations_WikiContext] WITH SCHEMABINDING, ENCRYPTION
AS
SELECT DISTINCT	
		TI.ApplicationID,
		Context.NodeID AS ContextID,
		TI.TaggedID,
		TI.TaggedType
FROM [dbo].[RV_TaggedItems] AS TI
	INNER JOIN [dbo].[WK_Paragraphs] AS P
	ON P.ApplicationID = TI.ApplicationID AND P.ParagraphID = TI.ContextID
	INNER JOIN [dbo].[WK_Titles] AS T
	ON T.ApplicationID = TI.ApplicationID AND T.TitleID = P.TitleID
	INNER JOIN [dbo].[CN_Nodes] AS Context
	ON Context.ApplicationID = TI.ApplicationID AND Context.NodeID = T.OwnerID
WHERE TI.TaggedType IN (N'Node', N'User') AND  P.Deleted = 0 AND 
	(P.[Status] = N'Accepted' OR P.[Status] = N'CitationNeeded') AND T.Deleted = 0

GO



SET NUMERIC_ROUNDABORT OFF;
SET ANSI_PADDING, ANSI_WARNINGS, CONCAT_NULL_YIELDS_NULL, ARITHABORT,
    QUOTED_IDENTIFIER, ANSI_NULLS ON;


IF EXISTS(select * FROM sys.views where name = 'USR_View_ValidatedEmails')
DROP VIEW [dbo].[USR_View_ValidatedEmails]
GO

CREATE VIEW [dbo].[USR_View_ValidatedEmails] WITH SCHEMABINDING, ENCRYPTION
AS
SELECT	E.EmailID,
		E.UserID,
		LOWER(U.LoweredUserName) AS UserName,
		LOWER(E.EmailAddress) AS Email
FROM [dbo].[USR_EmailAddresses] AS E
	INNER JOIN [dbo].[aspnet_Users] AS U
	ON U.UserId = E.UserID
WHERE E.Deleted = 0 AND E.Validated = 1

GO

CREATE UNIQUE CLUSTERED INDEX PK_View_ValidatedEmails_Email ON [dbo].[USR_View_ValidatedEmails]
(
	[Email] ASC,
	[UserID] ASC,
	[EmailID] ASC,
	[UserName] ASC
)WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]
GO

SET NUMERIC_ROUNDABORT OFF;
SET ANSI_PADDING, ANSI_WARNINGS, CONCAT_NULL_YIELDS_NULL, ARITHABORT,
    QUOTED_IDENTIFIER, ANSI_NULLS ON;


IF EXISTS(select * FROM sys.views where name = 'USR_View_ValidatedPhoneNumbers')
DROP VIEW [dbo].[USR_View_ValidatedPhoneNumbers]
GO

CREATE VIEW [dbo].[USR_View_ValidatedPhoneNumbers] WITH SCHEMABINDING, ENCRYPTION
AS
SELECT	E.NumberID,
		E.UserID,
		LOWER(U.LoweredUserName) AS UserName,
		E.PhoneNumber
FROM [dbo].[USR_PhoneNumbers] AS E
	INNER JOIN [dbo].[aspnet_Users] AS U
	ON U.UserId = E.UserID
WHERE E.Deleted = 0 AND E.Validated = 1

GO

CREATE UNIQUE CLUSTERED INDEX PK_View_ValidatedPhoneNumbers_Number ON [dbo].[USR_View_ValidatedPhoneNumbers]
(
	[PhoneNumber] ASC,
	[UserID] ASC,
	[NumberID] ASC,
	[UserName] ASC
)WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]
GO

IF  EXISTS (SELECT * FROM sys.indexes WHERE object_id = OBJECT_ID(N'[dbo].[DCT_Files]') AND name = N'IX_DCT_Files_OwnerID')
DROP INDEX [IX_DCT_Files_OwnerID] ON [dbo].[DCT_Files] WITH ( ONLINE = OFF )
GO

CREATE NONCLUSTERED INDEX [IX_DCT_Files_OwnerID] ON [dbo].[DCT_Files] 
(
	[OwnerID] ASC,
	[ApplicationID] ASC,
	[OwnerType] ASC,
	[FileNameGuiD] ASC,
	[Deleted] ASC
)WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]
GO

IF  EXISTS (SELECT * FROM sys.indexes WHERE object_id = OBJECT_ID(N'[dbo].[FG_FormInstances]') AND name = N'IX_FG_FormInstances_OwnerID')
DROP INDEX [IX_FG_FormInstances_OwnerID] ON [dbo].[FG_FormInstances] WITH ( ONLINE = OFF )
GO

CREATE NONCLUSTERED INDEX [IX_FG_FormInstances_OwnerID] ON [dbo].[FG_FormInstances] 
(
	[OwnerID] ASC,
	[ApplicationID] ASC,
	[FormID] ASC,
	[InstanceID] ASC,
	[OwnerType] ASC,
	[Deleted] ASC
)WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]
GO


IF  EXISTS (SELECT * FROM sys.indexes WHERE object_id = OBJECT_ID(N'[dbo].[FG_InstanceElements]') AND name = N'IX_FG_InstanceElements_InstanceID')
DROP INDEX [IX_FG_InstanceElements_InstanceID] ON [dbo].[FG_InstanceElements] WITH ( ONLINE = OFF )
GO

CREATE NONCLUSTERED INDEX [IX_FG_InstanceElements_InstanceID] ON [dbo].[FG_InstanceElements] 
(
	[InstanceID] ASC,
	[ApplicationID] ASC,
	[ElementID] ASC,
	[RefElementID] ASC,
	[Type] ASC,
	[Deleted] ASC
)WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]
GO





IF  EXISTS (SELECT * FROM sys.indexes WHERE object_id = OBJECT_ID(N'[dbo].[WK_Paragraphs]') AND name = N'IX_WK_Paragraphs_TitleID')
DROP INDEX [IX_WK_Paragraphs_TitleID] ON [dbo].[WK_Paragraphs] WITH ( ONLINE = OFF )
GO

CREATE NONCLUSTERED INDEX [IX_WK_Paragraphs_TitleID] ON [dbo].[WK_Paragraphs] 
(
	[TitleID] ASC,
	[ApplicationID] ASC,
	[Status] ASC,
	[Deleted] ASC
)WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]
GO

IF NOT EXISTS (SELECT * FROM sys.fulltext_catalogs WHERE [name] = 'Default_Catalog') BEGIN
	CREATE FULLTEXT CATALOG [Default_Catalog]WITH ACCENT_SENSITIVITY = OFF
	AS DEFAULT
	AUTHORIZATION [dbo]
END

GO




IF NOT EXISTS(SELECT * FROM sys.fulltext_indexes
  where object_id = object_id('USR_View_Users')) BEGIN
	CREATE FULLTEXT INDEX ON [dbo].[USR_View_Users]
	( 
		UserName Language Neutral,
		FirstName Language Neutral,
		Lastname Language Neutral
	)
	KEY INDEX PK_USR_View_Users_UserID
	ON [Default_Catalog]
	WITH CHANGE_TRACKING AUTO
END

GO



IF NOT EXISTS(SELECT * FROM sys.fulltext_indexes
  where object_id = object_id('QA_Questions')) BEGIN
	CREATE FULLTEXT INDEX ON [dbo].[QA_Questions]
	( 
		Title Language Neutral,
		[Description] Language Neutral
	)
	KEY INDEX PK_QA_Questions
	ON [Default_Catalog]
	WITH CHANGE_TRACKING AUTO
END

GO



IF NOT EXISTS(SELECT * FROM sys.fulltext_indexes
  where object_id = object_id('CN_Nodes')) BEGIN
	CREATE FULLTEXT INDEX ON [dbo].[CN_Nodes]
	( 
		Name Language Neutral,
		AdditionalID Language Neutral,
		[Description] Language Neutral,
		Tags Language Neutral
	)
	KEY INDEX PK_Nodes_NodeID
	ON [Default_Catalog]
	WITH CHANGE_TRACKING AUTO
END

GO



IF NOT EXISTS(SELECT * FROM sys.fulltext_indexes
  where object_id = object_id('CN_Lists')) BEGIN
	CREATE FULLTEXT INDEX ON [dbo].[CN_Lists]
	( 
		Name Language Neutral,
		[Description] Language Neutral
	)
	KEY INDEX PK_CN_Lists
	ON [Default_Catalog]
	WITH CHANGE_TRACKING AUTO
END

GO



IF NOT EXISTS(SELECT * FROM sys.fulltext_indexes
  where object_id = object_id('CN_Tags')) BEGIN
	CREATE FULLTEXT INDEX ON [dbo].[CN_Tags]
	( 
		Tag Language Neutral
	)
	KEY INDEX PK_CN_Tags
	ON [Default_Catalog]
	WITH CHANGE_TRACKING AUTO
END

GO



IF NOT EXISTS(SELECT * FROM sys.fulltext_indexes
  where object_id = object_id('KW_Questions')) BEGIN
	CREATE FULLTEXT INDEX ON [dbo].[KW_Questions]
	( 
		Title Language Neutral
	)
	KEY INDEX PK_TMP_KW_Questions
	ON [Default_Catalog]
	WITH CHANGE_TRACKING AUTO
END

GO



IF NOT EXISTS(SELECT * FROM sys.fulltext_indexes
  where object_id = object_id('FG_ExtendedForms')) BEGIN
	CREATE FULLTEXT INDEX ON [dbo].[FG_ExtendedForms]
	( 
		Title Language Neutral
	)
	KEY INDEX PK_FG_ExtendedForms
	ON [Default_Catalog]
	WITH CHANGE_TRACKING AUTO
END

GO



IF NOT EXISTS(SELECT * FROM sys.fulltext_indexes
  where object_id = object_id('USR_EducationalExperiences')) BEGIN
	CREATE FULLTEXT INDEX ON [dbo].[USR_EducationalExperiences]
	( 
		School Language Neutral,
		StudyField Language Neutral
	)
	KEY INDEX PK_USR_EducationalExperiences
	ON [Default_Catalog]
	WITH CHANGE_TRACKING AUTO
END

GO



IF NOT EXISTS(SELECT * FROM sys.fulltext_indexes
  where object_id = object_id('USR_HonorsAndAwards')) BEGIN
	CREATE FULLTEXT INDEX ON [dbo].[USR_HonorsAndAwards]
	( 
		Title Language Neutral,
		Issuer Language Neutral,
		Occupation Language Neutral,
		[Description] Language Neutral
	)
	KEY INDEX PK_USR_HonorsAndAwards
	ON [Default_Catalog]
	WITH CHANGE_TRACKING AUTO
END

GO



IF NOT EXISTS(SELECT * FROM sys.fulltext_indexes
  where object_id = object_id('USR_JobExperiences')) BEGIN
	CREATE FULLTEXT INDEX ON [dbo].[USR_JobExperiences]
	( 
		Title Language Neutral,
		Employer Language Neutral
	)
	KEY INDEX PK_USR_JobExperiences
	ON [Default_Catalog]
	WITH CHANGE_TRACKING AUTO
END

GO



IF NOT EXISTS(SELECT * FROM sys.fulltext_indexes
  where object_id = object_id('USR_LanguageNames')) BEGIN
	CREATE FULLTEXT INDEX ON [dbo].[USR_LanguageNames]
	( 
		LanguageName Language Neutral
	)
	KEY INDEX PK_USR_LanguageID
	ON [Default_Catalog]
	WITH CHANGE_TRACKING AUTO
END

GO



IF NOT EXISTS(SELECT * FROM sys.fulltext_indexes
  where object_id = object_id('FG_Polls')) BEGIN
	CREATE FULLTEXT INDEX ON [dbo].[FG_Polls]
	( 
		Name Language Neutral
	)
	KEY INDEX PK_FG_Polls
	ON [Default_Catalog]
	WITH CHANGE_TRACKING AUTO
END

GO



IF NOT EXISTS(SELECT * FROM sys.fulltext_indexes
  where object_id = object_id('CN_NodeTypes')) BEGIN
	CREATE FULLTEXT INDEX ON [dbo].[CN_NodeTypes]
	( 
		Name Language Neutral
	)
	KEY INDEX PK_NodeTypes_NodeTypeID
	ON [Default_Catalog]
	WITH CHANGE_TRACKING AUTO
END

GO



IF NOT EXISTS(SELECT * FROM sys.fulltext_indexes
  where object_id = object_id('DCT_TreeNodes')) BEGIN
	CREATE FULLTEXT INDEX ON [dbo].[DCT_TreeNodes]
	( 
		Name Language Neutral
	)
	KEY INDEX PK_DCT_TreeNodes
	ON [Default_Catalog]
	WITH CHANGE_TRACKING AUTO
END

GO



/****** Object:  StoredProcedure [dbo].[AddFolder]    Script Date: 03/14/2012 11:38:59 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


IF NOT EXISTS (SELECT * FROM sys.types WHERE is_table_type = 1 AND name = 'KeyLessGuidTableType')
--DROP TYPE dbo.KeyLessGuidTableType

CREATE TYPE [dbo].[KeyLessGuidTableType] AS TABLE
(Value uniqueidentifier NOT NULL, SequenceNumber int IDENTITY(1,1));
GO


IF NOT EXISTS (SELECT * FROM sys.types WHERE is_table_type = 1 AND name = 'GuidTableType')
--DROP TYPE dbo.GuidTableType

CREATE TYPE [dbo].[GuidTableType] AS TABLE
(Value uniqueidentifier NOT NULL PRIMARY KEY CLUSTERED);
GO


IF NOT EXISTS (SELECT * FROM sys.types WHERE is_table_type = 1 AND name = 'GuidPairTableType')
--DROP TYPE dbo.GuidPairTableType

CREATE TYPE [dbo].[GuidPairTableType] AS TABLE(
	FirstValue uniqueidentifier NOT NULL,
	SecondValue uniqueidentifier NOT NULL,
PRIMARY KEY CLUSTERED(FirstValue ASC, SecondValue ASC)
)
GO


IF NOT EXISTS (SELECT * FROM sys.types WHERE is_table_type = 1 AND name = 'GuidPairBitTableType')
--DROP TYPE dbo.GuidPairBitTableType

CREATE TYPE [dbo].[GuidPairBitTableType] AS TABLE(
	FirstValue uniqueidentifier NULL,
	SecondValue uniqueidentifier NULL,
	BitValue bit NULL
)
GO


IF NOT EXISTS (SELECT * FROM sys.types WHERE is_table_type = 1 AND name = 'GuidTripleTableType')
--DROP TYPE dbo.GuidTripleTableType

CREATE TYPE [dbo].[GuidTripleTableType] AS TABLE(
	FirstValue uniqueidentifier NOT NULL,
	SecondValue uniqueidentifier NOT NULL,
	ThirdValue uniqueidentifier NOT NULL
PRIMARY KEY CLUSTERED(FirstValue ASC, SecondValue ASC, ThirdValue ASC)
)
GO


IF NOT EXISTS (SELECT * FROM sys.types WHERE is_table_type = 1 AND name = 'GuidStringTableType')
--DROP TYPE dbo.GuidStringTableType

CREATE TYPE [dbo].[GuidStringTableType] AS TABLE(
	FirstValue uniqueidentifier NOT NULL,
	SecondValue nvarchar(max) NULL
)
GO


IF NOT EXISTS (SELECT * FROM sys.types WHERE is_table_type = 1 AND name = 'GuidStringPairTableType')
--DROP TYPE dbo.GuidStringPairTableType

CREATE TYPE [dbo].[GuidStringPairTableType] AS TABLE(
	GuidValue uniqueidentifier NULL,
	FirstValue nvarchar(max) NULL,
	SecondValue nvarchar(max) NULL
)
GO


IF NOT EXISTS (SELECT * FROM sys.types WHERE is_table_type = 1 AND name = 'BigIntTableType')
--DROP TYPE dbo.BigIntTableType

CREATE TYPE [dbo].[BigIntTableType]
AS 
TABLE(
	Value bigint NOT NULL
PRIMARY KEY CLUSTERED(Value ASC)
)
GO


IF NOT EXISTS (SELECT * FROM sys.types WHERE is_table_type = 1 AND name = 'StringTableType')
--DROP TYPE dbo.StringTableType

CREATE TYPE [dbo].[StringTableType] AS TABLE(
	Value nvarchar(max) NOT NULL
)
GO


IF NOT EXISTS (SELECT * FROM sys.types WHERE is_table_type = 1 AND name = 'StringPairTableType')
--DROP TYPE dbo.StringPairTableType

CREATE TYPE [dbo].[StringPairTableType] AS TABLE(
	FirstValue nvarchar(max) NOT NULL,
	SecondValue nvarchar(max) NOT NULL
)
GO


IF NOT EXISTS (SELECT * FROM sys.types WHERE is_table_type = 1 AND name = 'FloatStringTableType')
--DROP TYPE dbo.FloatStringTableType

CREATE TYPE [dbo].[FloatStringTableType] AS TABLE(
	FirstValue float NOT NULL,
	SecondValue nvarchar(max) NOT NULL
)
GO


IF NOT EXISTS (SELECT * FROM sys.types WHERE is_table_type = 1 AND name = 'GuidIntTableType')
--DROP TYPE dbo.GuidIntTableType

CREATE TYPE [dbo].[GuidIntTableType] AS TABLE(
	FirstValue uniqueidentifier NOT NULL,
	SecondValue int NOT NULL,
PRIMARY KEY CLUSTERED(FirstValue ASC, SecondValue ASC)
)
GO


IF NOT EXISTS (SELECT * FROM sys.types WHERE is_table_type = 1 AND name = 'GuidFloatTableType')
--DROP TYPE dbo.GuidFloatTableType

CREATE TYPE [dbo].[GuidFloatTableType] AS TABLE(
	FirstValue uniqueidentifier NOT NULL,
	SecondValue float NOT NULL,
PRIMARY KEY CLUSTERED(FirstValue ASC, SecondValue ASC)
)
GO


IF NOT EXISTS (SELECT * FROM sys.types WHERE is_table_type = 1 AND name = 'GuidBitTableType')
--DROP TYPE dbo.GuidBitTableType

CREATE TYPE [dbo].[GuidBitTableType] AS TABLE(
	FirstValue uniqueidentifier NOT NULL,
	SecondValue bit NOT NULL,
PRIMARY KEY CLUSTERED(FirstValue ASC, SecondValue ASC)
)
GO


--IF NOT EXISTS (SELECT * FROM sys.types WHERE is_table_type = 1 AND name = 'NodesHierarchyTableType')
--DROP TYPE dbo.NodesHierarchyTableType

IF EXISTS (SELECT * FROM sys.types WHERE is_table_type = 1 AND name = 'NodesHierarchyTableType')
DROP TYPE dbo.NodesHierarchyTableType

CREATE TYPE [dbo].[NodesHierarchyTableType] AS TABLE(
	NodeID uniqueidentifier NOT NULL,
	ParentNodeID uniqueidentifier NULL,
	[Level] int NULL,
	Name nvarchar(2000)
PRIMARY KEY CLUSTERED(NodeID ASC)
)
GO


IF NOT EXISTS (SELECT * FROM sys.types WHERE is_table_type = 1 AND name = 'DocFileInfoTableType')
--DROP TYPE dbo.DocFileInfoTableType

CREATE TYPE [dbo].[DocFileInfoTableType] AS TABLE(
	FileID uniqueidentifier NOT NULL,
	[FileName] nvarchar(255) NOT NULL,
	Extension varchar(20) NULL,
	MIME varchar(100) NULL,
	Size bigint NULL,
	OwnerID uniqueidentifier NULL,
	OwnerType varchar(50) NULL
PRIMARY KEY CLUSTERED(FileID ASC)
)
GO


IF NOT EXISTS (SELECT * FROM sys.types WHERE is_table_type = 1 AND name = 'ExchangeNodeTableType')
--DROP TYPE dbo.ExchangeNodeTableType

CREATE TYPE [dbo].[ExchangeNodeTableType] AS TABLE(
	NodeID uniqueidentifier NULL,
	NodeAdditionalID varchar(50) NULL,
	Name nvarchar(500) NULL,
	ParentAdditionalID varchar(50) NULL,
	Abstract nvarchar(max) NULL,
	Tags nvarchar(2000) NULL
)
GO


IF NOT EXISTS (SELECT * FROM sys.types WHERE is_table_type = 1 AND name = 'ExchangeUserTableType')
--DROP TYPE dbo.ExchangeUserTableType

CREATE TYPE [dbo].[ExchangeUserTableType] AS TABLE(
	UserID	uniqueidentifier NULL,
	UserName nvarchar(50) NULL,
	NewUserName nvarchar(50) NULL,
	FirstName nvarchar(500) NULL,
	LastName nvarchar(500) NULL,
	EmploymentType varchar(50) NULL,
	DepartmentID varchar(50) NULL,
	IsManager bit NULL,
	Email varchar(100) NULL,
	PhoneNumber varchar(50) NULL,
	ResetPassword bit NULL,
	[Password] nvarchar(255) NULL,
	PasswordSalt nvarchar(255) NULL,
	EncryptedPassword nvarchar(255) NULL
)
GO


IF NOT EXISTS (SELECT * FROM sys.types WHERE is_table_type = 1 AND name = 'ExchangeMemberTableType')
--DROP TYPE dbo.ExchangeMemberTableType

CREATE TYPE [dbo].[ExchangeMemberTableType] AS TABLE(
	NodeTypeAdditionalID nvarchar(50),
	NodeAdditionalID nvarchar(50),
	NodeID uniqueidentifier NULL,
	UserName nvarchar(50) NULL,
	IsAdmin bit NULL
)
GO


IF NOT EXISTS (SELECT * FROM sys.types WHERE is_table_type = 1 AND name = 'ExchangeRelationTableType')
--DROP TYPE dbo.ExchangeRelationTableType

CREATE TYPE [dbo].[ExchangeRelationTableType] AS TABLE(
	SourceTypeAdditionalID nvarchar(50),
	SourceAdditionalID nvarchar(50),
	SourceID uniqueidentifier NULL,
	DestinationTypeAdditionalID nvarchar(50),
	DestinationAdditionalID nvarchar(50),
	DestinationID uniqueidentifier NULL,
	Bidirectional bit NULL
)
GO


IF NOT EXISTS (SELECT * FROM sys.types WHERE is_table_type = 1 AND name = 'ExchangeAuthorTableType')
--DROP TYPE dbo.ExchangeAuthorTableType

CREATE TYPE [dbo].[ExchangeAuthorTableType] AS TABLE(
	NodeTypeAdditionalID nvarchar(50) NULL,
	NodeAdditionalID nvarchar(50) NULL,
	UserName nvarchar(50) NULL,
	Percentage int NULL
)
GO


IF NOT EXISTS (SELECT * FROM sys.types WHERE is_table_type = 1 AND name = 'ExchangePermissionTableType')
--DROP TYPE dbo.ExchangePermissionTableType

CREATE TYPE [dbo].[ExchangePermissionTableType] AS TABLE(
	NodeTypeAdditionalID nvarchar(50) NULL,
	NodeAdditionalID nvarchar(50) NULL,
	GroupTypeAdditionalID nvarchar(50) NULL,
	GroupAdditionalID nvarchar(50) NULL,
	UserName nvarchar(50) NULL,
	PermissionType nvarchar(50) NULL,
	Allow bit NULL,
	DropAll bit NULL
)
GO


IF NOT EXISTS (SELECT * FROM sys.types WHERE is_table_type = 1 AND name = 'FormInstanceTableType')
-- DROP TYPE dbo.FormInstanceTableType

CREATE TYPE [dbo].[FormInstanceTableType] AS TABLE(
	InstanceID	uniqueidentifier NOT NULL PRIMARY KEY CLUSTERED,
	FormID uniqueidentifier NULL,
	OwnerID uniqueidentifier NULL,
	DirectorID uniqueidentifier NULL,
	[Admin] bit NULL,
	IsTemporary bit NULL
)
GO


IF NOT EXISTS (SELECT * FROM sys.types WHERE is_table_type = 1 AND name = 'FormElementTableType')
-- DROP TYPE dbo.FormElementTableType

CREATE TYPE [dbo].[FormElementTableType] AS TABLE(
	ElementID	uniqueidentifier NOT NULL PRIMARY KEY CLUSTERED,
	TemplateElementID uniqueidentifier NULL,
	InstanceID uniqueidentifier NOT NULL,
	RefElementID uniqueidentifier NULL,
	Title nvarchar(2000) NULL,
	Name varchar(100) NULL,
	SequenceNubmer int NOT NULL,
	Necessary bit NULL,
	UniqueValue bit NULL,
	[Type] varchar(20) NOT NULL,
	Help nvarchar(2000) NULL,
	Info nvarchar(max) NULL,
	[Weight] float NULL,
	TextValue nvarchar(max) NULL,
	FloatValue float NULL,
	BitValue bit NULL,
	DateValue datetime NULL
)
GO


IF NOT EXISTS (SELECT * FROM sys.types WHERE is_table_type = 1 AND name = 'DashboardTableType')
--DROP TYPE dbo.DashboardTableType

CREATE TYPE [dbo].[DashboardTableType] AS TABLE(
	UserID			uniqueidentifier NOT NULL,
	NodeID			uniqueidentifier NOT NULL,
	RefItemID		uniqueidentifier NULL,
	[Type]			varchar(20) NOT NULL,
	SubType			varchar(20) NULL,
	Info			nvarchar(max) NULL,
	Removable		bit	NULL,
	SenderUserID	uniqueidentifier NULL,
	SendDate		datetime NULL,
	ExpirationDate	datetime NULL,
	Seen			bit NULL,
	ViewDate		datetime NULL,
	Done			bit NULL,
	ActionDate		datetime NULL
)
GO


IF NOT EXISTS (SELECT * FROM sys.types WHERE is_table_type = 1 AND name = 'FormFilterTableType')
--DROP TYPE dbo.FormFilterTableType

CREATE TYPE [dbo].[FormFilterTableType] AS TABLE(
	ElementID		uniqueidentifier NOT NULL,
	OwnerID			uniqueidentifier NULL,
	[Text]			nvarchar(max) NULL,
	[TextItems]		nvarchar(max) NULL,
	[Or]			bit NULL,
	Exact			bit NULL,
	DateFrom		datetime NULL,
	DateTo			datetime NULL,
	FloatFrom		float NULL,
	FloatTo			float NULL,
	[Bit]			bit,
	[Guid]			uniqueidentifier NULL,
	GuidItems		varchar(max) NULL,
	Compulsory		bit NULL
)
GO


IF NOT EXISTS (SELECT * FROM sys.types WHERE is_table_type = 1 AND name = 'SentMessageTableType')
--DROP TYPE dbo.SentMessageTableType

CREATE TYPE [dbo].[SentMessageTableType] AS TABLE(
    RefItemID		UNIQUEIDENTIFIER NOT NULL,
    ReceiverUserID	UNIQUEIDENTIFIER NOT NULL,
    ReceiverAddress	VARCHAR(100) NOT NULL,
    SenderAddress	VARCHAR(100) NOT NULL,
	MessageText		NVARCHAR(MAX) NOT NULL,
	UserStatus		VARCHAR(20) NOT NULL,
    SubjectType		VARCHAR(20) NOT NULL,
    [Action]		VARCHAR(20) NOT NULL,
    Media			VARCHAR(20) NOT NULL,
    [Language]		VARCHAR(20) NOT NULL
)
GO


IF NOT EXISTS (SELECT * FROM sys.types WHERE is_table_type = 1 AND name = 'MessageTableType')
--DROP TYPE dbo.MessageTableType

CREATE TYPE [dbo].[MessageTableType] AS TABLE(
    MessageID		UNIQUEIDENTIFIER NOT NULL,
    SenderUserID	UNIQUEIDENTIFIER NOT NULL,
    Title			NVARCHAR(512) NULL,
    MessageText		NVARCHAR(MAX) NULL
)
GO


IF NOT EXISTS (SELECT * FROM sys.types WHERE is_table_type = 1 AND name = 'EmailQueueItemTableType')
--DROP TYPE dbo.EmailQueueItemTableType

CREATE TYPE [dbo].[EmailQueueItemTableType] AS TABLE(
    ID				BIGINT NULL,
    SenderUserID	UNIQUEIDENTIFIER NULL,
    [Action]		VARCHAR(50) NOT NULL,
    Email			NVARCHAR(200) NOT NULL,
    Title			NVARCHAR(2000) NULL,
    EmailBody		NVARCHAR(MAX) NOT NULL
)
GO


IF NOT EXISTS (SELECT * FROM sys.types WHERE is_table_type = 1 AND name = 'TaggedItemTableType')
--DROP TYPE dbo.TaggedItemTableType

CREATE TYPE [dbo].[TaggedItemTableType] AS TABLE(
    ContextID		UNIQUEIDENTIFIER NOT NULL,
    TaggedID		UNIQUEIDENTIFIER NULL,
    ContextType		VARCHAR(50) NULL,
    TaggedType		VARCHAR(50) NULL
)
GO


IF NOT EXISTS (SELECT * FROM sys.types WHERE is_table_type = 1 AND name = 'PrivacyAudienceTableType')
--DROP TYPE dbo.PrivacyAudienceTableType

CREATE TYPE [dbo].[PrivacyAudienceTableType] AS TABLE(
    ObjectID		uniqueidentifier NULL,
    RoleID			uniqueidentifier NULL,
    PermissionType	varchar(50) NULL,
    Allow			bit NULL,
    ExpirationDate	datetime NULL
)
GO


IF NOT EXISTS (SELECT * FROM sys.types WHERE is_table_type = 1 AND name = 'CNExtensionTableType')
--DROP TYPE dbo.CNExtensionTableType

CREATE TYPE [dbo].[CNExtensionTableType] AS TABLE(
    OwnerID			uniqueidentifier NULL,
    Extension		varchar(50) NOT NULL,
    Title			nvarchar(100) NULL,
    SequenceNumber	int NULL,
    [Disabled]		bit NULL
)
GO

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


/* 'GFN' stands for Global Function */

IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[GFN_GuidEmpty]') 
            AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
DROP FUNCTION [dbo].[GFN_GuidEmpty]
GO

CREATE FUNCTION [dbo].[GFN_GuidEmpty] ()
RETURNS uniqueidentifier
AS
BEGIN
	RETURN CAST(0x0 AS uniqueidentifier)
END

GO


IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[GFN_NewGuid]') 
            AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
DROP FUNCTION [dbo].[GFN_NewGuid]
GO

CREATE FUNCTION [dbo].[GFN_NewGuid] ()
RETURNS uniqueidentifier
AS
BEGIN
	RETURN (SELECT TOP(1) X.ID FROM [dbo].[RV_View_NewGuid] AS X)
END

GO


IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[GFN_IsSystemAdmin]') 
            AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
DROP FUNCTION [dbo].[GFN_IsSystemAdmin]
GO

CREATE FUNCTION [dbo].[GFN_IsSystemAdmin] (
	@ApplicationID	uniqueidentifier,
	@UserID			uniqueidentifier
)
RETURNS bit
AS
BEGIN
	DECLARE @Val bit = (
		SELECT CAST(1 as bit)
		WHERE EXISTS(
				SELECT TOP(1) *
				FROM [dbo].[aspnet_UsersInRoles] AS U
					INNER JOIN [dbo].[aspnet_Roles] AS R
					ON R.RoleId = U.RoleId
				WHERE (@ApplicationID IS NULL OR R.ApplicationID = @ApplicationID) AND 
					U.UserId = @UserID AND R.LoweredRoleName = N'admins'
			)
	)
	
	RETURN ISNULL(@Val, 0)
END

GO


IF  EXISTS (SELECT * FROM sys.objects 
            WHERE object_id = OBJECT_ID(N'[dbo].[GFN_StrToGuidTable]') 
            AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
DROP FUNCTION [dbo].[GFN_StrToGuidTable]
GO

CREATE FUNCTION [dbo].[GFN_StrToGuidTable]
(
	@inputString	varchar(max),
	@delimiter		char
)
RETURNS
@outputTable TABLE
(
	Value	uniqueidentifier
)
WITH ENCRYPTION
AS
BEGIN
	-- Fill the table variable with the rows for your result set
	if @inputString IS NULL OR @inputString = '' return
	
    declare @beginPos int, @pos int, @strItem varchar(100)
    set @pos = 0
    set @beginPos = @pos

	while (@pos >= @beginPos) begin
		set @beginPos = @pos + 1
		set @pos = charindex(@delimiter, @inputString, @beginPos)
		
		if @pos >= @beginPos
			set @strItem = substring(@inputString, @beginPos, @pos - 1)
		else
			set @strItem = substring(@inputString, @beginPos, 8000000)
		
		Insert @outputTable values (CAST(@strItem as uniqueidentifier))
	end
   
    RETURN 
END

GO


IF  EXISTS (SELECT * FROM sys.objects 
            WHERE object_id = OBJECT_ID(N'[dbo].[GFN_StrToGuidPairTable]') 
            AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
DROP FUNCTION [dbo].[GFN_StrToGuidPairTable]
GO

CREATE FUNCTION [dbo].[GFN_StrToGuidPairTable]
(
	@inputString	varchar(max),
	@innerDelimiter		char,
	@outerDelimiter		char
)
RETURNS
@outputTable TABLE
(
	FirstValue		uniqueidentifier,
	SecondValue		uniqueidentifier
)
WITH ENCRYPTION
AS
BEGIN
	-- Fill the table variable with the rows for your result set
	if @inputString IS NULL OR @inputString = '' return
	
    declare @beginPos int, @pos int, @strFirstItem varchar(100), @strSecondItem varchar(100)
    set @pos = 0
    set @beginPos = @pos
    
	while (@pos >= @beginPos) begin
		set @beginPos = @pos + 1
		set @pos = charindex(@innerDelimiter, @inputString, @beginPos)
		
		set @strFirstItem = substring(@inputString, @beginPos, @pos-1)
		
		set @beginPos = @pos + 1
		set @pos = charindex(@outerDelimiter, @inputString, @beginPos)
			
		if @pos >= @beginPos
			set @strSecondItem = substring(@inputString, @beginPos, @pos-1)
		else
			set @strSecondItem = substring(@inputString, @beginPos, 8000000)
		
		Insert @outputTable values (CAST(@strFirstItem as uniqueidentifier),
			CAST(@strSecondItem as uniqueidentifier))
	end
   
    RETURN 
END

GO


IF  EXISTS (SELECT * FROM sys.objects 
            WHERE object_id = OBJECT_ID(N'[dbo].[GFN_StrToGuidTripleTable]') 
            AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
DROP FUNCTION [dbo].[GFN_StrToGuidTripleTable]
GO

CREATE FUNCTION [dbo].[GFN_StrToGuidTripleTable]
(
	@inputString	varchar(max),
	@innerDelimiter		char,
	@outerDelimiter		char
)
RETURNS
@outputTable TABLE
(
	FirstValue		uniqueidentifier,
	SecondValue		uniqueidentifier,
	ThirdValue		uniqueidentifier
)
WITH ENCRYPTION
AS
BEGIN
	-- Fill the table variable with the rows for your result set
	if @inputString IS NULL OR @inputString = '' return
	
    declare @beginPos int, @pos int, 
		@strFirstItem varchar(100), @strSecondItem varchar(100), @strThirdItem varchar(100)
    set @pos = 0
    set @beginPos = @pos
    
	while (@pos >= @beginPos) begin
		set @beginPos = @pos + 1
		set @pos = charindex(@innerDelimiter, @inputString, @beginPos)
		
		set @strFirstItem = substring(@inputString, @beginPos, @pos-1)
		
		set @beginPos = @pos + 1
		set @pos = charindex(@innerDelimiter, @inputString, @beginPos)
		
		set @strSecondItem = substring(@inputString, @beginPos, @pos-1)
		
		set @beginPos = @pos + 1
		set @pos = charindex(@outerDelimiter, @inputString, @beginPos)
		
		if @pos >= @beginPos
			set @strThirdItem = substring(@inputString, @beginPos, @pos-1)
		else
			set @strThirdItem = substring(@inputString, @beginPos, 8000000)
		
		Insert @outputTable values (CAST(@strFirstItem as uniqueidentifier),
			CAST(@strSecondItem as uniqueidentifier),
			CAST(@strThirdItem as uniqueidentifier))
	end
   
    RETURN 
END

GO


IF  EXISTS (SELECT * FROM sys.objects 
            WHERE object_id = OBJECT_ID(N'[dbo].[GFN_StrToBigIntTable]') 
            AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
DROP FUNCTION [dbo].[GFN_StrToBigIntTable]
GO

CREATE FUNCTION [dbo].[GFN_StrToBigIntTable]
(
	@inputString	varchar(max),
	@delimiter		char
)
RETURNS
@outputTable TABLE
(
	Value	bigint
)
WITH ENCRYPTION
AS
BEGIN
	-- Fill the table variable with the rows for your result set
	if @inputString IS NULL OR @inputString = '' return
	
    declare @beginPos int, @pos int, @strItem varchar(100)
    set @pos = 0
    set @beginPos = @pos

	while (@pos >= @beginPos) begin
		set @beginPos = @pos + 1
		set @pos = charindex(@delimiter, @inputString, @beginPos)
		
		if @pos >= @beginPos
			set @strItem = substring(@inputString, @beginPos, @pos-@beginPos)
		else
			set @strItem = substring(@inputString, @beginPos, 8000000)
		
		Insert @outputTable values (CAST(@strItem as bigint))
	end
   
    RETURN 
END

GO


IF  EXISTS (SELECT * FROM sys.objects 
            WHERE object_id = OBJECT_ID(N'[dbo].[GFN_StrToStringTable]') 
            AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
DROP FUNCTION [dbo].[GFN_StrToStringTable]
GO

CREATE FUNCTION [dbo].[GFN_StrToStringTable]
(
	@inputString	nvarchar(max),
	@delimiter		char
)
RETURNS
@outputTable TABLE
(
	Value	nvarchar(max)
)
WITH ENCRYPTION
AS
BEGIN
	DECLARE @XML xml =
		CONVERT(xml,'<root><s>' + REPLACE(@inputString,@delimiter,'</s><s>') + '</s></root>')
	
	INSERT INTO @outputTable
	SELECT LTRIM(RTRIM(T.c.value('.','nvarchar(max)')))
	FROM @XML.nodes('/root/s') T(c)
	
	DELETE @outputTable
	WHERE Value = N''
	
    RETURN 
END

GO


IF  EXISTS (SELECT * FROM sys.objects 
            WHERE object_id = OBJECT_ID(N'[dbo].[GFN_StrToStringPairTable]') 
            AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
DROP FUNCTION [dbo].[GFN_StrToStringPairTable]
GO

CREATE FUNCTION [dbo].[GFN_StrToStringPairTable]
(
	@inputString	nvarchar(max),
	@innerDelimiter	char,
	@outerDelimiter char
)
RETURNS
@outputTable TABLE
(
	FirstValue	nvarchar(max),
	SecondValue	nvarchar(max)
)
WITH ENCRYPTION
AS
BEGIN
	DECLARE @XML xml =
		CONVERT(xml,'<root><s>' + REPLACE(@inputString,@outerDelimiter,'</s><s>') + '</s></root>')
	
	DECLARE @S Table(ID int IDENTITY(1,1), Val nvarchar(4000))
	
	INSERT INTO @S (Val)
	SELECT T.c.value('.','varchar(max)')
	FROM @XML.nodes('/root/s') T(c)
	
	DECLARE @CNT int = (SELECT COUNT(*) FROM @S)
	WHILE (@CNT > 0) BEGIN
		DECLARE @Str nvarchar(4000) = (SELECT Val FROM @S WHERE ID = @CNT)
		DECLARE @Pos int = charindex(@innerDelimiter, @Str, 0)
		
		INSERT INTO @outputTable (FirstValue, SecondValue)
		VALUES(substring(@Str, 0, @pos), substring(@Str, @pos + 1, 4000))
		
		SET @CNT = @CNT - 1
	END
	
	DELETE @outputTable
	WHERE SecondValue = N''
	
    RETURN 
END

GO


IF  EXISTS (SELECT * FROM sys.objects 
            WHERE object_id = OBJECT_ID(N'[dbo].[GFN_StrToFloatStringTable]') 
            AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
DROP FUNCTION [dbo].[GFN_StrToFloatStringTable]
GO

CREATE FUNCTION [dbo].[GFN_StrToFloatStringTable]
(
	@inputString	varchar(max),
	@innerDelimiter	char,
	@outerDelimiter char
)
RETURNS
@outputTable TABLE
(
	FirstValue	float,
	SecondValue	varchar(max)
)
WITH ENCRYPTION
AS
BEGIN
	DECLARE @XML xml =
		CONVERT(xml,'<root><s>' + REPLACE(@inputString,@outerDelimiter,'</s><s>') + '</s></root>')
	
	DECLARE @S Table(ID int IDENTITY(1,1), Val nvarchar(4000))
	
	INSERT INTO @S (Val)
	SELECT T.c.value('.','varchar(max)')
	FROM @XML.nodes('/root/s') T(c)
	
	DECLARE @CNT int = (SELECT COUNT(*) FROM @S)
	WHILE (@CNT > 0) BEGIN
		DECLARE @Str nvarchar(4000) = (SELECT Val FROM @S WHERE ID = @CNT)
		DECLARE @Pos int = charindex(@innerDelimiter, @Str, 0)
		
		INSERT INTO @outputTable (FirstValue, SecondValue)
		VALUES(CAST(substring(@Str, 0, @pos) AS float), 
			substring(@Str, @pos + 1, 4000))
		
		SET @CNT = @CNT - 1
	END
	
	DELETE @outputTable
	WHERE SecondValue = N''
	
    RETURN 
END

GO



IF  EXISTS (SELECT * FROM sys.objects 
            WHERE object_id = OBJECT_ID(N'[dbo].[GFN_VerifyString]') 
            AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
DROP FUNCTION [dbo].[GFN_VerifyString]
GO

CREATE FUNCTION [dbo].[GFN_VerifyString]
(
	@inputString	nvarchar(max)
)
RETURNS nvarchar(max)
WITH ENCRYPTION
AS
BEGIN
	IF @inputString IS NULL RETURN NULL
    RETURN REPLACE(REPLACE(REPLACE(REPLACE(@inputString, N'', N''), N'', N''), 0x0000, N''), 0x0002, N'')
END

GO


IF  EXISTS (SELECT * FROM sys.objects 
            WHERE object_id = OBJECT_ID(N'[dbo].[GFN_Base64Encode]') 
            AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
DROP FUNCTION [dbo].[GFN_Base64Encode]
GO

CREATE FUNCTION [dbo].[GFN_Base64Encode]
(
	@input	nvarchar(max)
)
RETURNS nvarchar(max)
WITH ENCRYPTION
AS
BEGIN
	IF @input IS NULL OR @input = N'' RETURN @input

	DECLARE @binaryText varbinary(max) = CONVERT(varbinary(max), @input)
	
	RETURN CAST('' AS xml).value('xs:base64Binary(sql:variable("@binaryText"))', 'nvarchar(max)')
END

GO


IF  EXISTS (SELECT * FROM sys.objects 
            WHERE object_id = OBJECT_ID(N'[dbo].[GFN_Base64Decode]') 
            AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
DROP FUNCTION [dbo].[GFN_Base64Decode]
GO

CREATE FUNCTION [dbo].[GFN_Base64Decode]
(
	@input	nvarchar(max)
)
RETURNS nvarchar(max)
WITH ENCRYPTION
AS
BEGIN
	IF @input IS NULL OR @input = N'' RETURN @input

	DECLARE @binaryText varbinary(max) = 
		CAST('' AS xml).value('xs:base64Binary(sql:variable("@input"))', 'varbinary(max)')
	
	RETURN CONVERT(nvarchar(max), @binaryText)
END

GO


IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[GFN_GetSearchText]') 
            AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
DROP FUNCTION [dbo].[GFN_GetSearchText]
GO

CREATE FUNCTION [dbo].[GFN_GetSearchText]
(
	@input	nvarchar(max)
)
RETURNS nvarchar(max)
WITH ENCRYPTION
AS
BEGIN
	IF @input IS NULL OR @input = N'' RETURN @input
	
	DECLARE @Words TABLE(ID int IDENTITY(1, 1) primary key clustered, Word nvarchar(1000))
	
	INSERT INTO @Words (Word)
	SELECT LTRIM(RTRIM(Ref.Value))
	FROM [dbo].[GFN_StrToStringTable](@input, N' ') AS Ref
	WHERE LTRIM(RTRIM(Ref.Value)) <> N'' AND LEN(ISNULL(LTRIM(RTRIM(Ref.Value)), N'')) > 2
	
	DECLARE @Count int = (SELECT COUNT(*) FROM @Words)
	DECLARE @I int =  1
	
	IF @Count = 0 RETURN NULL
	
	DECLARE @RetStr nvarchar(max) = N'ISABOUT('
	
	WHILE @I <= @Count BEGIN
		DECLARE @Str nvarchar(1000) = (SELECT Ref.Word FROM @Words AS Ref WHERE Ref.ID = @I)
		
		IF @I > 1 SET @RetStr = @RetStr + N','
		
		SET @RetStr = @RetStr + N'"' + @Str + N'*" WEIGHT(' +
			CAST(
				(CASE
					WHEN @I > 5 THEN 0.1
					ELSE 1 - ((@I - 1) * 0.2)
				END)
				AS nvarchar(100)
			) +
			N')'
		
		SET @I = @I + 1
	END
	
	RETURN @RetStr + N')'
END

GO


IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[GFN_LikeMatch]') 
	AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
DROP FUNCTION [dbo].[GFN_LikeMatch]
GO

CREATE FUNCTION [dbo].[GFN_LikeMatch]
(
	@Input nvarchar(2000),
	@StringItems StringTableType readonly,
	@Or bit,
	@Exact bit
)
RETURNS bit
WITH ENCRYPTION
AS
BEGIN
	DECLARE @RetVal bit = 0
	
	DECLARE @Count int = (SELECT COUNT(*) FROM @StringItems)
	
	DECLARE @str nvarchar(10) = CASE WHEN @Exact = 1 THEN N'' ELSE N'%' END
	
	DECLARE @MatchCount int  = (
		SELECT COUNT(*)
		FROM @StringItems AS SI
		WHERE @Input LIKE (@str + ISNULL(SI.Value, N'') + @str)
	)
	
	IF @Or = 1 RETURN CASE WHEN @MatchCount > 0 THEN 1 ELSE 0 END
	ELSE RETURN CASE WHEN @MatchCount = @Count THEN 1 ELSE 0 END
	
	RETURN 0
END

GO


IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[GFN_Persian2Julian]') 
            AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
DROP FUNCTION [dbo].[GFN_Persian2Julian]
GO

CREATE FUNCTION [dbo].[GFN_Persian2Julian](@iYear int, @iMonth int, @iDay int)
RETURNS bigint
AS
BEGIN
 
	Declare @PERSIAN_EPOCH  as int
	Declare @epbase as bigint
	Declare @epyear as bigint
	Declare @mdays as bigint
	Declare @Jofst  as Numeric(18,2)
	Declare @jdn bigint
	 
	Set @PERSIAN_EPOCH=1948321
	Set @Jofst=2415020.5
	 
	If @iYear>=0 
		Begin
			Set @epbase=@iyear-474 
		End
	Else
		Begin
			Set @epbase = @iYear - 473 
		End
		set @epyear=474 + (@epbase%2820) 
	If @iMonth<=7
		Begin
			Set @mdays=(Convert(bigint,(@iMonth) - 1) * 31)
		End
	Else
		Begin
			Set @mdays=(Convert(bigint,(@iMonth) - 1) * 30+6)
		End
		Set @jdn =Convert(int,@iday) + @mdays+ Cast(((@epyear * 682) - 110) / 2816 as int)  + (@epyear - 1) * 365 + Cast(@epbase / 2820 as int) * 1029983 + (@PERSIAN_EPOCH - 1) 
		RETURN @jdn
	End

GO


IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[GFN_Gregorian2Persian]') 
            AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
DROP FUNCTION [dbo].[GFN_Gregorian2Persian]
GO

CREATE Function dbo.[GFN_Gregorian2Persian] (@date datetime)
RETURNS @outputTable TABLE (
	[Year]	INT NOT NULL,
	[Month]	INT NOT NULL,
	[Day]	INT NOT NULL
)
AS
BEGIN
	SET @date = CAST(CAST(DATEPART(YEAR, @date) as varchar(10)) + '-' + 
	CAST(DATEPART(MONTH, @date) as varchar(10)) + '-' + CAST(DATEPART(DAY, @date) as varchar(10)) + ' 00:00:00.000' AS datetime)

    Declare @depoch as bigint
    Declare @cycle  as bigint
    Declare @cyear  as bigint
    Declare @ycycle as bigint
    Declare @aux1 as bigint
    Declare @aux2 as bigint
    Declare @yday as bigint
    Declare @Jofst  as Numeric(18,2)
    Declare @jdn bigint
 
    Declare @iYear   As Integer
    Declare @iMonth  As Integer
    Declare @iDay    As Integer
 
    Set @Jofst=2415020.5
    Set @jdn=Round(Cast(@date as int)+ @Jofst,0)
 
    Set @depoch = @jdn - [dbo].[GFN_Persian2Julian](475, 1, 1) 
    Set @cycle = Cast(@depoch / 1029983 as int) 
    Set @cyear = @depoch%1029983 
 
    If @cyear = 1029982
       Begin
         Set @ycycle = 2820 
       End
    Else
       Begin
        Set @aux1 = Cast(@cyear / 366 as int) 
        Set @aux2 = @cyear%366 
        Set @ycycle = Cast(((2134 * @aux1) + (2816 * @aux2) + 2815) / 1028522 as int) + @aux1 + 1 
      End
 
    Set @iYear = @ycycle + (2820 * @cycle) + 474 
 
    If @iYear <= 0
      Begin 
        Set @iYear = @iYear - 1 
      End
    Set @yday = (@jdn - [dbo].[GFN_Persian2Julian](@iYear, 1, 1)) + 1 
    If @yday <= 186 
       Begin
         Set @iMonth = CEILING(Convert(Numeric(18,4),@yday) / 31) 
       End
    Else
       Begin
          Set @iMonth = CEILING((Convert(Numeric(18,4),@yday) - 6) / 30)  
       End
       Set @iDay = (@jdn - [dbo].[GFN_Persian2Julian](@iYear, @iMonth, 1)) + 1 
 
	INSERT INTO @outputTable ([Year], [Month], [Day])
	VALUES (ISNULL(@iYear, 0), ISNULL(@iMonth, 0), ISNULL(@iDay, 0))

	RETURN
End
 
GO


IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[GFN_Julian2Gregorian]') 
            AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
DROP FUNCTION [dbo].[GFN_Julian2Gregorian]
GO

CREATE FUNCTION [dbo].[GFN_Julian2Gregorian] (@jdn bigint)
RETURNS datetime
AS
BEGIN
    DECLARE @Jofst AS numeric(18,2)
    SET @Jofst=2415020.5
    RETURN CAST(Convert(nvarchar(11),Convert(datetime,(@jdn- @Jofst),113),110) AS datetime)
END

GO


IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[GFN_Persian2Gregorian]') 
            AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
DROP FUNCTION [dbo].[GFN_Persian2Gregorian]
GO

CREATE FUNCTION [dbo].[GFN_Persian2Gregorian] (@Year int, @Month int, @Day int)
RETURNS datetime
AS
BEGIN
    RETURN [dbo].[GFN_Julian2Gregorian]([dbo].[GFN_Persian2Julian](@Year, @Month, @Day))
END

GO


IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[GFN_IsJalaliLeapYear]') 
            AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
DROP FUNCTION [dbo].[GFN_IsJalaliLeapYear]
GO

CREATE FUNCTION [dbo].[GFN_IsJalaliLeapYear] (@Year int)
RETURNS bit
AS
BEGIN
    DECLARE @A float = 0.025
    DECLARE @B float = 266
    
    DECLARE @LeapDays0 float = 0, @LeapDays1 float = 0
    
    IF ISNULL(@Year, 0) = 0 RETURN 0
    ELSE IF @Year > 0 BEGIN
		SET @LeapDays0 = (((@Year + 38) % 2820) * 0.24219) + @A
		SET @LeapDays1 = (((@Year + 39) % 2820) * 0.24219) + @A
    END
    ELSE BEGIN
		SET @LeapDays0 = (((@Year + 39) % 2820) * 0.24219) + @A
		SET @LeapDays1 = (((@Year + 40) % 2820) * 0.24219) + @A
    END
    
    DECLARE @Frac0 int = CAST((@LeapDays0 - CAST(@LeapDays0 AS int)) * 1000 AS int)
    DECLARE @Frac1 int = CAST((@LeapDays1 - CAST(@LeapDays1 AS int)) * 1000 AS int)
    
    IF @Frac0 <= @B AND @Frac1 > @B RETURN 1
    ELSE RETURN 0
    
    RETURN 1
END

GO



IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[GFN_GetTimePeriod]') 
            AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
DROP FUNCTION [dbo].[GFN_GetTimePeriod]
GO

CREATE FUNCTION [dbo].[GFN_GetTimePeriod] (@Date datetime, @Period varchar(50), @CalendarType varchar(50))
RETURNS	int
AS
BEGIN
	SET @Period = LOWER(LTRIM(RTRIM(ISNULL(@Period, ''))))
	SET @CalendarType = LOWER(LTRIM(RTRIM(ISNULL(@CalendarType, ''))))

	DECLARE @Year int = 0
	DECLARE @Month int = 0

	IF @CalendarType = 'jalali' BEGIN
		SELECT TOP(1)
			@Year = X.[Year],
			@Month = X.[Month]
		FROM [dbo].[GFN_Gregorian2Persian](@Date) AS X
	END
	ELSE BEGIN
		SET @Year = ISNULL(DATEPART(YEAR, @Date), 0)
		SET @Month = ISNULL(DATEPART(MONTH, @Date), 0)
	END

    RETURN (
		CASE
			WHEN @Period = 'year' THEN @Year
			WHEN @Period = 'season' THEN 
				CAST((CAST(@Year AS varchar(10)) + CAST((
					CASE
						WHEN (@Month % 3) = 0 THEN (@Month / 3) - 1
						ELSE @Month / 3
					END + 1
				) AS varchar(10))) AS int)
			WHEN @Period = 'month' THEN 
				CAST((CAST(@Year AS varchar(10)) + (CASE WHEN @Month < 10 THEN '0' ELSE '' END) + CAST(@Month AS varchar(10))) AS int)
			ELSE 0
		END
	)
END

GO




SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


/* 'GFN' stands for Global Function */
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[CN_FN_GetNodeTypeID]') 
    AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
DROP FUNCTION [dbo].[CN_FN_GetNodeTypeID]
GO

CREATE FUNCTION [dbo].[CN_FN_GetNodeTypeID](
	@ApplicationID	uniqueidentifier,
	@AdditionalID	nvarchar(50)
)
RETURNS uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	RETURN (
		SELECT TOP(1) NT.NodeTypeID 
		FROM [dbo].[CN_NodeTypes] AS NT
		WHERE NT.ApplicationID = @ApplicationID AND NT.AdditionalID = @AdditionalID AND
			ISNULL(@AdditionalID, N'') <> N''
	)
END

GO


IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[CN_FN_GetDepartmentNodeTypeIDs]') 
	AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
DROP FUNCTION [dbo].[CN_FN_GetDepartmentNodeTypeIDs]
GO

CREATE FUNCTION [dbo].[CN_FN_GetDepartmentNodeTypeIDs](
	@ApplicationID	uniqueidentifier
)
RETURNS @OutputTable TABLE (
	NodeTypeID uniqueidentifier primary key clustered,
	ParentID uniqueidentifier,
	[Level] int,
	Name nvarchar(2000)
)
WITH ENCRYPTION
AS
BEGIN
	;WITH hierarchy (ID, ParentID, [Level], Name)
	AS
	(
		SELECT NT.NodeTypeID AS ID, NT.ParentID AS ParentID, 0 AS [Level], NT.Name AS Name
		FROM [dbo].[CN_NodeTypes] AS NT
		WHERE NT.ApplicationID = @ApplicationID AND NT.AdditionalID = N'6'
		
		UNION ALL
		
		SELECT NT.NodeTypeID AS ID, NT.ParentID AS ParentID, 
			[Level] + 1, NT.Name AS Name
		FROM [dbo].[CN_NodeTypes] AS NT
			INNER JOIN hierarchy AS HR
			ON NT.ParentID = HR.ID
		WHERE NT.NodeTypeID <> HR.ID AND NT.Deleted = 0
	)
	INSERT INTO @OutputTable (NodeTypeID, ParentID, [Level], Name)
	SELECT H.ID, H.ParentID, H.[Level], H.Name
	FROM hierarchy AS H
	
	RETURN
END

GO


/*
IF  EXISTS (SELECT * FROM sys.objects 
            WHERE object_id = OBJECT_ID(N'[dbo].[CN_FN_GetExpertiseNodeTypeID]') 
            AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
DROP FUNCTION [dbo].[CN_FN_GetExpertiseNodeTypeID]
GO

CREATE FUNCTION [dbo].[CN_FN_GetExpertiseNodeTypeID](
	@ApplicationID	uniqueidentifier
)
RETURNS uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	RETURN (
		SELECT NodeTypeID 
		FROM [dbo].[CN_NodeTypes]
		WHERE ApplicationID = @ApplicationID AND AdditionalID = N'7'
	)
END

GO
*/


IF  EXISTS (SELECT * FROM sys.objects 
	WHERE object_id = OBJECT_ID(N'[dbo].[CN_FN_GetRelationTypeID]') 
    AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
DROP FUNCTION [dbo].[CN_FN_GetRelationTypeID]
GO

CREATE FUNCTION [dbo].[CN_FN_GetRelationTypeID](
	@ApplicationID	uniqueidentifier,
	@AdditionalID	nvarchar(50)
)
RETURNS uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	RETURN (
		SELECT P.PropertyID 
		FROM [dbo].[CN_Properties] AS P
		WHERE P.ApplicationID = @ApplicationID AND P.AdditionalID = @AdditionalID
	)
END

GO


IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[CN_FN_GetParentRelationTypeID]') 
	AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
DROP FUNCTION [dbo].[CN_FN_GetParentRelationTypeID]
GO

CREATE FUNCTION [dbo].[CN_FN_GetParentRelationTypeID](
	@ApplicationID	uniqueidentifier
)
RETURNS uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	RETURN (
		SELECT P.PropertyID 
		FROM [dbo].[CN_Properties] AS P
		WHERE P.ApplicationID = @ApplicationID AND P.AdditionalID = N'1'
	)
END

GO


IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[CN_FN_GetChildRelationTypeID]') 
	AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
DROP FUNCTION [dbo].[CN_FN_GetChildRelationTypeID]
GO

CREATE FUNCTION [dbo].[CN_FN_GetChildRelationTypeID](
	@ApplicationID	uniqueidentifier
)
RETURNS uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	RETURN (
		SELECT P.PropertyID 
		FROM [dbo].[CN_Properties] AS P
		WHERE P.ApplicationID = @ApplicationID AND P.AdditionalID = N'2'
	)
END

GO


IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[CN_FN_GetRelatedRelationTypeID]') 
	AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
DROP FUNCTION [dbo].[CN_FN_GetRelatedRelationTypeID]
GO

CREATE FUNCTION [dbo].[CN_FN_GetRelatedRelationTypeID](
	@ApplicationID	uniqueidentifier
)
RETURNS uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	RETURN (
		SELECT P.PropertyID 
		FROM [dbo].[CN_Properties] AS P
		WHERE P.ApplicationID = @ApplicationID AND P.AdditionalID = N'3'
	)
END

GO


IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[CN_FN_GetChildNodesHierarchy]') 
	AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
DROP FUNCTION [dbo].[CN_FN_GetChildNodesHierarchy]
GO

CREATE FUNCTION [dbo].[CN_FN_GetChildNodesHierarchy](
	@ApplicationID	uniqueidentifier,
	@NodeIDs		GuidTableType readonly
)	
RETURNS @OutputTable TABLE (
	NodeID uniqueidentifier primary key clustered,
	ParentID uniqueidentifier,
	[Level] int,
	Name nvarchar(2000)
)
WITH ENCRYPTION
AS
BEGIN
	INSERT INTO @OutputTable(NodeID, ParentID, [Level], Name)
	SELECT ND.NodeID AS ID, ND.ParentNodeID AS ParentID, 0 AS [Level], ND.Name AS Name
	FROM @NodeIDs AS N
		INNER JOIN [dbo].[CN_Nodes] AS ND
		ON ND.ApplicationID = @ApplicationID AND ND.NodeID = N.Value
	
	INSERT INTO @OutputTable(NodeID, ParentID, [Level], Name)
	SELECT ND.NodeID AS ID, ND.ParentNodeID AS ParentID, 
		[Level] + 1, ND.Name AS Name
	FROM @OutputTable AS HR
		INNER JOIN [dbo].[CN_Nodes] AS ND
		ON ND.ApplicationID = @ApplicationID AND ND.ParentNodeID = HR.NodeID
	WHERE ND.NodeID <> HR.NodeID AND ND.Deleted = 0
	
	RETURN
END

GO


IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[CN_FN_GetChildNodesDeepHierarchy]') 
	AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
DROP FUNCTION [dbo].[CN_FN_GetChildNodesDeepHierarchy]
GO

CREATE FUNCTION [dbo].[CN_FN_GetChildNodesDeepHierarchy](
	@ApplicationID	uniqueidentifier,
	@NodeIDs		GuidTableType readonly
)	
RETURNS @OutputTable TABLE (
	NodeID uniqueidentifier primary key clustered,
	ParentID uniqueidentifier,
	[Level] int,
	Name nvarchar(2000)
)
WITH ENCRYPTION
AS
BEGIN
	;WITH hierarchy (ID, ParentID, [Level], Name)
	AS
	(
		SELECT ND.NodeID AS ID, ND.ParentNodeID AS ParentID, 0 AS [Level], ND.Name AS Name
		FROM @NodeIDs AS N
			INNER JOIN [dbo].[CN_Nodes] AS ND
			ON ND.ApplicationID = @ApplicationID AND ND.NodeID = N.Value
		
		UNION ALL
		
		SELECT Node.NodeID AS ID, Node.ParentNodeID AS ParentID, [Level] + 1, Node.Name
		FROM [dbo].[CN_Nodes] AS Node
			INNER JOIN hierarchy AS HR
			ON HR.ID = Node.ParentNodeID
		WHERE ApplicationID = @ApplicationID AND 
			Node.NodeID <> HR.ID AND Node.Deleted = 0
	)
	
	INSERT INTO @OutputTable (NodeID, ParentID, [Level], Name)
	SELECT H.ID, H.ParentID, H.[Level], H.Name
	FROM hierarchy AS H
	ORDER BY H.[Level] ASC
	
	RETURN
END

GO


IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[CN_FN_GetChildNodeTypesHierarchy]') 
	AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
DROP FUNCTION [dbo].[CN_FN_GetChildNodeTypesHierarchy]
GO

CREATE FUNCTION [dbo].[CN_FN_GetChildNodeTypesHierarchy](
	@ApplicationID	uniqueidentifier,
	@NodeTypeIDs	GuidTableType readonly
)	
RETURNS @OutputTable TABLE (
	NodeTypeID uniqueidentifier primary key clustered,
	ParentID uniqueidentifier,
	[Level] int,
	Name nvarchar(2000)
)
WITH ENCRYPTION
AS
BEGIN
	INSERT INTO @OutputTable(NodeTypeID, ParentID, [Level], Name)
	SELECT NT.NodeTypeID AS ID, NT.ParentID AS ParentID, 0 AS [Level], NT.Name AS Name
	FROM @NodeTypeIDs AS N
		INNER JOIN [dbo].[CN_NodeTypes] AS NT
		ON NT.ApplicationID = @ApplicationID AND NT.NodeTypeID = N.Value
	
	INSERT INTO @OutputTable(NodeTypeID, ParentID, [Level], Name)
	SELECT NT.NodeTypeID AS ID, NT.ParentID AS ParentID, 
		[Level] + 1, NT.Name AS Name
	FROM @OutputTable AS HR
		INNER JOIN [dbo].[CN_NodeTypes] AS NT
		ON NT.ApplicationID = @ApplicationID AND NT.ParentID = HR.NodeTypeID
	WHERE NT.NodeTypeID <> HR.NodeTypeID AND NT.Deleted = 0
	
	RETURN
END

GO


IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[CN_FN_GetChildNodeTypesDeepHierarchy]') 
	AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
DROP FUNCTION [dbo].[CN_FN_GetChildNodeTypesDeepHierarchy]
GO

CREATE FUNCTION [dbo].[CN_FN_GetChildNodeTypesDeepHierarchy](
	@ApplicationID	uniqueidentifier,
	@NodeTypeIDs	GuidTableType readonly
)	
RETURNS @OutputTable TABLE (
	NodeTypeID uniqueidentifier primary key clustered,
	ParentID uniqueidentifier,
	[Level] int,
	Name nvarchar(2000)
)
WITH ENCRYPTION
AS
BEGIN
	;WITH hierarchy (ID, ParentID, [Level], Name)
	AS
	(
		SELECT ND.NodeTypeID AS ID, ND.ParentID AS ParentID, 0 AS [Level], ND.Name AS Name
		FROM @NodeTypeIDs AS N
			INNER JOIN [dbo].[CN_NodeTypes] AS ND
			ON ND.ApplicationID = @ApplicationID AND ND.NodeTypeID = N.Value
		
		UNION ALL
		
		SELECT NT.NodeTypeID AS ID, NT.ParentID AS ParentID, [Level] + 1, NT.Name
		FROM [dbo].[CN_NodeTypes] AS NT
			INNER JOIN hierarchy AS HR
			ON HR.ID = NT.ParentID
		WHERE ApplicationID = @ApplicationID AND NT.NodeTypeID <> HR.ID AND NT.Deleted = 0
	)
	
	INSERT INTO @OutputTable (NodeTypeID, ParentID, [Level], Name)
	SELECT *
	FROM (
			SELECT	ID, 
					CAST(MAX(CAST(H.ParentID AS varchar(50))) AS uniqueidentifier) AS ParentID, 
					MIN(H.[Level]) AS [Level], 
					MAX(H.Name) AS Name
			FROM hierarchy AS H
			GROUP BY H.ID
		) AS X
	ORDER BY X.[Level] ASC
	
	RETURN
END

GO


IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[CN_FN_GetNodesHierarchy]') 
	AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
DROP FUNCTION [dbo].[CN_FN_GetNodesHierarchy]
GO

CREATE FUNCTION [dbo].[CN_FN_GetNodesHierarchy](
	@ApplicationID	uniqueidentifier,
	@NodeIDs		GuidTableType readonly
)	
RETURNS @OutputTable TABLE (
	NodeID uniqueidentifier,
	ParentID uniqueidentifier,
	[Level] int,
	Name nvarchar(2000)
)
WITH ENCRYPTION
AS
BEGIN
	;WITH hierarchy (ID, TypeID, ParentID, [Level], Name)
	AS
	(
		SELECT ND.NodeID AS ID, ND.NodeTypeID AS TypeID, ND.ParentNodeID AS ParentID, 0 AS [Level], ND.Name
		FROM @NodeIDs AS IDs
			INNER JOIN [dbo].[CN_Nodes] AS ND
			ON ND.ApplicationID = @ApplicationID AND ND.NodeID = IDs.Value
		
		UNION ALL
		
		SELECT Node.NodeID AS ID, Node.NodeTypeID, Node.ParentNodeID AS ParentID, [Level] + 1, Node.Name
		FROM [dbo].[CN_Nodes] AS Node
			INNER JOIN hierarchy AS HR
			ON HR.ParentID = Node.NodeID
		WHERE ApplicationID = @ApplicationID AND Node.NodeTypeID = HR.TypeID AND
			Node.NodeID <> HR.ID AND Node.Deleted = 0
	)
	
	INSERT INTO @OutputTable (NodeID, ParentID, [Level], Name)
	SELECT H.ID, H.ParentID, H.[Level], H.Name
	FROM hierarchy AS H
	ORDER BY H.[Level] ASC
	
	RETURN
END

GO


IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[CN_FN_GetRelatedNodeIDs]') 
	AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
DROP FUNCTION [dbo].[CN_FN_GetRelatedNodeIDs]
GO

CREATE FUNCTION [dbo].[CN_FN_GetRelatedNodeIDs](
	@ApplicationID		uniqueidentifier,
	@NodeIDs			GuidTableType readonly,
	@NodeTypeIDs		GuidTableType readonly,
	@RelatedNodeTypeIDs	GuidTableType readonly,
	@In					bit,
	@Out				bit,
	@InTags				bit,
	@OutTags			bit
)	
RETURNS @OutputTable TABLE (
	NodeID			uniqueidentifier,
	RelatedNodeID	uniqueidentifier,
	IsRelated		bit,
	IsTagged		bit
)
WITH ENCRYPTION
AS
BEGIN
	DECLARE @NodeIDsCount int = (SELECT COUNT(*) FROM @NodeIDs)
	DECLARE @NodeTypeIDsCount int = (SELECT COUNT(*) FROM @NodeTypeIDs)
	DECLARE @RelatedTypesCount int = (SELECT COUNT(*) FROM @RelatedNodeTypeIDs)
	
	--Source must not be null
	IF @NodeIDsCount = 0 AND @NodeTypeIDsCount = 0 SET @NodeIDsCount = 1

	INSERT INTO @OutputTable(NodeID, RelatedNodeID, IsRelated, IsTagged)
	SELECT X.NodeID, X.RelatedNodeID, X.IsRelated, X.IsTagged
	FROM (
			SELECT	IDs.NodeID, 
					IDs.RelatedNodeID, 
					CAST(MAX(IDs.IsRelated) AS bit) AS IsRelated, 
					CAST(MAX(IDs.IsTagged) AS bit) AS IsTagged
			FROM (
					SELECT R.NodeID, R.RelatedNodeID, 1 AS IsRelated, 0 AS IsTagged
					FROM [dbo].[CN_View_InRelatedNodes] AS R
					WHERE @In = 1 AND R.ApplicationID = @ApplicationID AND 
						(@NodeIDsCount = 0 OR R.NodeID IN (SELECT X.Value FROM @NodeIDs AS X)) AND (
							@RelatedTypesCount = 0 OR 
							R.RelatedNodeTypeID IN (SELECT X.Value FROM @RelatedNodeTypeIDs AS X)
						)
						
					UNION ALL 
					
					SELECT R.NodeID, R.RelatedNodeID, 1 AS IsRelated, 0 AS IsTagged
					FROM [dbo].[CN_View_OutRelatedNodes] AS R
					WHERE @Out = 1 AND R.ApplicationID = @ApplicationID AND 
						(@NodeIDsCount = 0 OR R.NodeID IN (SELECT X.Value FROM @NodeIDs AS X)) AND (
							@RelatedTypesCount = 0 OR 
							R.RelatedNodeTypeID IN (SELECT X.Value FROM @RelatedNodeTypeIDs AS X)
						)
						
					UNION ALL
						
					SELECT T.TaggedID, T.ContextID, 0 AS IsRelated, 1 AS IsTagged
					FROM [dbo].[RV_TaggedItems] AS T
						INNER JOIN [dbo].[CN_Nodes] AS ND
						ON ND.ApplicationID = @ApplicationID AND ND.NodeID = T.ContextID AND ND.Deleted = 0 AND (
							@RelatedTypesCount = 0 OR 
							ND.NodeTypeID IN (SELECT X.Value FROM @RelatedNodeTypeIDs AS X)
						)
					WHERE @InTags = 1 AND T.ApplicationID = @ApplicationID AND 
						(@NodeIDsCount = 0 OR T.TaggedID IN (SELECT X.Value FROM @NodeIDs AS X)) AND
						T.ContextType = N'Node'
						
					UNION ALL
						
					SELECT T.ContextID, T.TaggedID, 0 AS IsRelated, 1 AS IsTagged
					FROM [dbo].[RV_TaggedItems] AS T
						INNER JOIN [dbo].[CN_Nodes] AS ND
						ON ND.ApplicationID = @ApplicationID AND ND.NodeID = T.TaggedID AND ND.Deleted = 0 AND (
							@RelatedTypesCount = 0 OR 
							ND.NodeTypeID IN (SELECT X.Value FROM @RelatedNodeTypeIDs AS X)
						)
					WHERE @OutTags = 1 AND T.ApplicationID = @ApplicationID AND
						(@NodeIDsCount = 0 OR T.ContextID IN (SELECT X.Value FROM @NodeIDs AS X)) AND
						T.TaggedType LIKE N'Node%'
				) AS IDs
			GROUP BY IDs.NodeID, IDs.RelatedNodeID
		) AS X
		LEFT JOIN [dbo].[CN_Nodes] AS N
		ON @NodeTypeIDsCount > 0 AND N.ApplicationID = @ApplicationID AND N.NodeID = X.NodeID AND
			N.NodeTypeID IN (SELECT T.Value FROM @NodeTypeIDs AS T)
	WHERE X.NodeID <> X.RelatedNodeID AND (@NodeTypeIDsCount = 0 OR N.NodeID IS NOT NULL)
	
	RETURN
END

GO


IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[CN_FN_GetUserRelatedNodeIDs]') 
	AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
DROP FUNCTION [dbo].[CN_FN_GetUserRelatedNodeIDs]
GO

CREATE FUNCTION [dbo].[CN_FN_GetUserRelatedNodeIDs](
	@ApplicationID		uniqueidentifier,
	@UserIDs			GuidTableType readonly,
	@RelatedNodeTypeIDs	GuidTableType readonly
)	
RETURNS @OutputTable TABLE (
	UserID uniqueidentifier,
	RelatedNodeID uniqueidentifier
)
WITH ENCRYPTION
AS
BEGIN
	DECLARE @RelatedTypesCount int = (SELECT COUNT(*) FROM @RelatedNodeTypeIDs)

	INSERT INTO @OutputTable(UserID, RelatedNodeID)
	SELECT DISTINCT T.TaggedID, T.ContextID
	FROM @UserIDs AS IDs
		INNER JOIN [dbo].[RV_TaggedItems] AS T
		ON T.ApplicationID = @ApplicationID AND T.TaggedID = IDs.Value
		INNER JOIN [dbo].[CN_Nodes] AS ND
		ON ND.ApplicationID = @ApplicationID AND ND.NodeID = T.ContextID AND ND.Deleted = 0 AND (
			@RelatedTypesCount = 0 OR 
			ND.NodeTypeID IN (SELECT X.Value FROM @RelatedNodeTypeIDs AS X)
		)
	WHERE T.ContextID <> T.TaggedID
	
	RETURN
END

GO


IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[CN_FN_Explore]') 
	AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
DROP FUNCTION [dbo].[CN_FN_Explore]
GO

CREATE FUNCTION [dbo].[CN_FN_Explore](
	@ApplicationID uniqueidentifier,
	@BaseIDs GuidTableType readonly,
	@BaseTypeIDs GuidTableType readonly,
	@RelatedID uniqueidentifier,
	@RelatedTypeIDs GuidTableType readonly,
	@RegistrationArea bit,
	@Tags bit,
	@Relations bit
)	
RETURNS @OutputTable TABLE (
	BaseID				UNIQUEIDENTIFIER NOT NULL,
    BaseTypeID			UNIQUEIDENTIFIER NULL,
    BaseName			NVARCHAR(2000) NULL,
    BaseType			NVARCHAR(2000) NULL,
    RelatedID			UNIQUEIDENTIFIER NOT NULL,
    RelatedTypeID		UNIQUEIDENTIFIER NULL,
    RelatedName			NVARCHAR(2000) NULL,
    RelatedType			NVARCHAR(2000) NULL,
    RelatedCreationDate	DATETIME NULL,
    IsTag				BIT NULL,
    IsRelation			BIT NULL,
    IsRegistrationArea	BIT NULL
)
WITH ENCRYPTION
AS
BEGIN
	-- Base === Context --> Folder
	-- Tagged === Related --> Content

	DECLARE @BaseIDsCount int = (SELECT COUNT(*) FROM @BaseIDs)
	DECLARE @BaseTypeIDsCount int = 0
	IF @BaseIDsCount = 0 SET @BaseTypeIDsCount = (SELECT COUNT(*) FROM @BaseTypeIDs)
	DECLARE @RelatedTypeIDsCount int = 0
	IF @RelatedID IS NULL SET @RelatedTypeIDsCount = (SELECT COUNT(*) FROM @RelatedTypeIDs)
	
	INSERT INTO @OutputTable (
		BaseID, BaseTypeID, BaseName, BaseType,
		RelatedID, RelatedTypeID, RelatedName, RelatedType, RelatedCreationDate,
		IsTag, IsRelation, IsRegistrationArea
	)
	SELECT	Base.NodeID, Base.NodeTypeID, Base.NodeName, Base.TypeName,
			Related.NodeID, Related.NodeTypeID, Related.NodeName, Related.TypeName, Related.CreationDate,
			DT.IsTag, DT.IsRelation, DT.IsRegistrationArea
	FROM (
			SELECT R.NodeID, R.RelatedNodeID, R.IsRelated AS IsRelation, 
				R.IsTagged AS IsTag, 0 AS IsRegistrationArea
			FROM [dbo].[CN_FN_GetRelatedNodeIDs](@ApplicationID, 
				@BaseIDs, @BaseTypeIDs, @RelatedTypeIDs, @Relations, @Relations, @Tags, @Tags) AS R
			WHERE @RelatedID IS NULL OR R.RelatedNodeID = @RelatedID
			
			UNION ALL
			
			SELECT N.NodeID AS ContextID, N.AreaID AS TaggedID, 0, 0, 1
			FROM [dbo].[CN_Nodes] AS N
				INNER JOIN [dbo].[CN_Nodes] AS Area
				ON Area.ApplicationID = @ApplicationID AND Area.NodeID = N.AreaID
			WHERE @RegistrationArea = 1 AND N.ApplicationID = @ApplicationID AND 
				(@RelatedID IS NULL OR N.NodeID = @RelatedID) AND
				(@RelatedTypeIDsCount = 0 OR N.NodeTypeID IN (SELECT X.Value FROM @RelatedTypeIDs AS X)) AND
				(@BaseIDsCount = 0 OR Area.NodeID IN (SELECT X.Value FROM @BaseIDs AS X)) AND
				(@BaseTypeIDsCount = 0 OR Area.NodeTypeID IN (SELECT X.Value FROM @BaseTypeIDs AS X))
		) AS DT
		INNER JOIN [dbo].[CN_View_Nodes_Normal] AS Base
		ON Base.ApplicationID = @ApplicationID AND Base.NodeID = DT.NodeID
		INNER JOIN [dbo].[CN_View_Nodes_Normal] AS Related
		ON Related.ApplicationID = @ApplicationID AND Related.NodeID = DT.RelatedNodeID
	WHERE ISNULL(Related.[Status], N'Accepted') = N'Accepted' AND ISNULL(Related.Searchable, 1) = 1

	RETURN
END

GO


IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[CN_FN_GetNodeFileContents]') 
    AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
DROP FUNCTION [dbo].[CN_FN_GetNodeFileContents]
GO

CREATE FUNCTION [dbo].[CN_FN_GetNodeFileContents](
	@ApplicationID	uniqueidentifier,
	@NodeID			uniqueidentifier
)
RETURNS nvarchar(max)
WITH ENCRYPTION
AS
BEGIN
	DECLARE @Ret nvarchar(max) = NULL

	;WITH Partitioned AS
	(
		SELECT	OID.OwnerID,
				CAST(SUBSTRING(ISNULL(FC.Content, N''), 1, 4000) AS nvarchar(4000)) AS Content,
				ROW_NUMBER() OVER (PARTITION BY OID.OwnerID ORDER BY FC.FileID ASC, OID.ID ASC) AS Number,
				COUNT(*) OVER (PARTITION BY OID.OwnerID) AS [Count]
		FROM (
				SELECT @NodeID AS OwnerID, E.ElementID AS ID
				FROM [dbo].[FG_FormInstances] AS I
					INNER JOIN [dbo].[FG_InstanceElements] AS E
					ON E.ApplicationID = @ApplicationID AND E.InstanceID = I.InstanceID AND 
						E.[Type] = N'File' AND E.Deleted = 0
				WHERE I.ApplicationID = @ApplicationID AND 
					I.OwnerID = @NodeID AND I.Deleted = 0
				
				UNION
				
				SELECT @NodeID AS OwnerID, @NodeID
			) AS OID
			INNER JOIN [dbo].[DCT_Files] AS F
			ON F.ApplicationID = @ApplicationID AND F.Deleted = 0 AND
				(F.OwnerID = OID.OwnerID OR F.OwnerID = OID.ID) /* AND
				(
					(OID.ID = OID.OwnerID AND F.OwnerType = N'Node') OR
					(OID.ID <> OID.OwnerID AND 
						(F.OwnerType = N'WikiContent' OR F.OwnerType = N'FormElement')
					)
				)*/
			INNER JOIN [dbo].[DCT_FileContents] AS FC
			ON FC.ApplicationID = @ApplicationID AND 
				FC.FileID = F.FileNameGuid AND FC.NotExtractable = 0
	),
	Fetched AS
	(
		SELECT	P.OwnerID, P.Content AS FullContent, P.Content, P.Number, P.[Count] 
		FROM Partitioned AS P
		WHERE P.Number = 1

		UNION ALL

		SELECT	P.OwnerID, C.FullContent + ' ' + P.Content, P.Content, P.Number, P.[Count]
		FROM Partitioned AS P
			INNER JOIN Fetched AS C 
			ON P.OwnerID = C.OwnerID AND P.Number = C.Number + 1
		WHERE P.Number <= 95
	)
	SELECT TOP(1) @Ret = F.FullContent
	FROM Fetched AS F
	WHERE F.Number = (CASE WHEN F.[Count] > 90 THEN 90 ELSE F.[Count] END)
	
	RETURN @Ret
END

GO


IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[CN_FN_GetFilteredNodes]') 
    AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
DROP FUNCTION [dbo].[CN_FN_GetFilteredNodes]
GO

CREATE FUNCTION [dbo].[CN_FN_GetFilteredNodes](
	@ApplicationID		uniqueidentifier,
	@CurrentUserID		uniqueidentifier,
	@NodeIDs			KeyLessGuidTableType readonly,
	@RelatedToIDs		GuidTableType readonly,
	@CreatorUserIDs		GuidTableType readonly,
	@IsFavorite			bit,
	@IsGroup			bit,
	@IsExpertise		bit,
	@CheckAccess		bit,
	@DefaultPrivacy		varchar(20),
	@FormFilters		FormFilterTableType readonly,
	@MatchAllFilters	bit,
	@Now				datetime
)
RETURNS @outputTable TABLE (
	NodeID			uniqueidentifier,
	SequenceNumber	int IDENTITY (1, 1)
)
WITH ENCRYPTION
AS
BEGIN
	DECLARE @CreatorLevelIDs KeyLessGuidTableType

	SET @CheckAccess = ISNULL(@CheckAccess, 0)

	DECLARE @RelatedCount int = (SELECT COUNT(*) FROM @RelatedToIDs)
	DECLARE @CreatorCount int = (SELECT COUNT(*) FROM @CreatorUserIDs)

	-- Useless Variables
	DECLARE @BTIDs GuidTableType
	DECLARE @RTIDs GuidTableType

	;WITH Related AS (
		SELECT I.[Value] AS NodeID, I.SequenceNumber
		FROM @NodeIDs AS I
			LEFT JOIN (
				SELECT R.NodeID, R.RelatedNodeID
				FROM [dbo].[CN_FN_GetRelatedNodeIDs](@ApplicationID, 
					@RelatedToIDs, @BTIDs, @RTIDs, 1, 1, 1, 1) AS R
			) AS X
			ON @RelatedCount > 0 AND X.RelatedNodeID = I.[Value]
		WHERE @RelatedCount = 0 OR 
			(X.RelatedNodeID IS NOT NULL AND I.[Value] NOT IN (SELECT R.[Value] FROM @RelatedToIDs AS R))
	),
	Creator AS (
		SELECT R.NodeID, R.SequenceNumber
		FROM Related AS R
			LEFT JOIN (
				SELECT DISTINCT NC.NodeID
				FROM @CreatorUserIDs AS C
					INNER JOIN [dbo].[CN_NodeCreators] AS NC
					ON NC.ApplicationID = @ApplicationID AND NC.UserID = C.[Value] AND NC.Deleted = 0
			) AS A
			ON @RelatedCount > 0 AND A.NodeID = R.NodeID
			LEFT JOIN [dbo].[CN_Nodes] AS ND
			ON @CreatorCount > 0 AND ND.ApplicationID = @ApplicationID AND ND.NodeID = R.NodeID
		WHERE @CreatorCount = 0 OR  
			(A.NodeID IS NOT NULL OR ND.CreatorUserID IN (SELECT B.[Value] FROM @CreatorUserIDs AS B))
	),
	Favorite AS (
		SELECT C.NodeID, C.SequenceNumber
		FROM Creator AS C
			LEFT JOIN [dbo].[CN_NodeLikes] AS L
			ON @IsFavorite = 1 AND L.ApplicationID = @ApplicationID AND L.NodeID = C.NodeID AND
				L.UserID = @CurrentUserID AND L.Deleted = 0
		WHERE ISNULL(@IsFavorite, 0) = 0 OR L.NodeID IS NOT NULL
	),
	[Group] AS (
		SELECT F.NodeID, F.SequenceNumber
		FROM Favorite AS F
			LEFT JOIN [dbo].[CN_View_NodeMembers] AS M
			ON @IsGroup = 1 AND M.ApplicationID = @ApplicationID AND M.NodeID = F.NodeID AND
				M.UserID = @CurrentUserID AND ISNULL(M.IsPending, 0) = 0
		WHERE ISNULL(@IsGroup, 0) = 0 OR M.NodeID IS NOT NULL
	),
	Expertise AS (
		SELECT G.NodeID, G.SequenceNumber
		FROM [Group] AS G
			LEFT JOIN [dbo].[CN_View_Experts] AS E
			ON @IsExpertise = 1 AND E.ApplicationID = @ApplicationID AND 
				E.NodeID = G.NodeID AND E.UserID = @CurrentUserID
		WHERE ISNULL(@IsExpertise, 0) = 0 OR E.NodeID IS NOT NULL
	)
	INSERT INTO @CreatorLevelIDs ([Value])
	SELECT E.NodeID
	FROM Expertise AS E
	ORDER BY E.SequenceNumber ASC
	
	-- Check Access
	DECLARE @AccessLevelIDs KeyLessGuidTableType
	
	DECLARE	@PermissionTypes StringPairTableType
		
	INSERT INTO @PermissionTypes (FirstValue, SecondValue)
	VALUES (N'View', @DefaultPrivacy), (N'ViewAbstract', @DefaultPrivacy)
	
	INSERT INTO @AccessLevelIDs ([Value])
	SELECT I.[Value]
	FROM @CreatorLevelIDs AS I
		LEFT JOIN (
			SELECT A.ID
			FROM [dbo].[PRVC_FN_CheckAccess](@ApplicationID, @CurrentUserID, 
				@CreatorLevelIDs, N'Node', @Now, @PermissionTypes) AS A
			GROUP BY A.ID
		) AS X
		ON @CheckAccess = 1 AND X.ID = I.[Value]
	WHERE @CheckAccess = 0 OR X.ID IS NOT NULL
	ORDER BY I.SequenceNumber ASC
	-- end of Check Access

	IF (SELECT COUNT(*) FROM @FormFilters) > 0 BEGIN
		DECLARE @IDs GuidTableType
		
		INSERT INTO @IDs (Value)
		SELECT X.[Value]
		FROM @AccessLevelIDs AS X
		
		INSERT INTO @outputTable (NodeID)
		SELECT Ref.OwnerID
		FROM @AccessLevelIDs AS IDs
			INNER JOIN [dbo].[FG_FN_FilterInstanceOwners](@ApplicationID, NULL, @IDs, @FormFilters, @MatchAllFilters) AS Ref
			ON Ref.OwnerID = IDs.[Value]
		ORDER BY Ref.[Rank] ASC, IDs.SequenceNumber ASC
	END
	ELSE BEGIN
		INSERT INTO @outputTable (NodeID)
		SELECT IDs.[Value]
		FROM @AccessLevelIDs AS IDs
		ORDER BY IDs.SequenceNumber ASC
	END

	RETURN
END

GO

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[PRVC_FN_DefaultValueToBoolean]') 
            AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
DROP FUNCTION [dbo].[PRVC_FN_DefaultValueToBoolean]
GO

CREATE FUNCTION [dbo].[PRVC_FN_DefaultValueToBoolean]
(
	@Value	varchar(20)
)
RETURNS bit
WITH ENCRYPTION
AS
BEGIN
	IF ISNULL(@Value, N'') = N'Public' RETURN 1
	ELSE IF ISNULL(@Value, N'') <> N'' RETURN 0
	
	RETURN NULL
END

GO


IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[PRVC_FN_CheckNodePermission]') 
            AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
DROP FUNCTION [dbo].[PRVC_FN_CheckNodePermission]
GO

CREATE FUNCTION [dbo].[PRVC_FN_CheckNodePermission]
(
	@Node				bit,
	@NodeType			bit,
	@DocumentTreeNode	bit,
	@DocumentTree		bit
)
RETURNS bit
WITH ENCRYPTION
AS
BEGIN
	RETURN CASE
		WHEN @Node IS NOT NULL THEN @Node
		WHEN @NodeType IS NULL THEN ISNULL(@DocumentTreeNode, @DocumentTree)
		WHEN @DocumentTreeNode IS NULL AND @DocumentTree IS NULL THEN @NodeType
		WHEN @NodeType < ISNULL(@DocumentTreeNode, @DocumentTree) THEN @NodeType
		ELSE ISNULL(@DocumentTreeNode, @DocumentTree)
	END
	
	RETURN NULL
END

GO


IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[PRVC_FN_CheckAccess]') 
    AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
DROP FUNCTION [dbo].[PRVC_FN_CheckAccess]
GO

CREATE FUNCTION [dbo].[PRVC_FN_CheckAccess](
	@ApplicationID		uniqueidentifier,
	@UserID				uniqueidentifier,
	@ObjectIDs			KeyLessGuidTableType readonly,
	@ObjectType			varchar(50),
	@Now				datetime,
	@PermissionTypes	StringPairTableType readonly -- FirstValue: Type, SecondValue: DefaultPrivacy
)
RETURNS
@OutputTable TABLE
(
	ID		uniqueidentifier,
	[Type]	varchar(50)
)
WITH ENCRYPTION
AS
BEGIN
	DECLARE @Yesterday datetime
	IF @Now IS NOT NULL SET @Yesterday = DATEADD(DAY, -1, @Now)

	-- Find Confidentiality of the User
	DECLARE @UserConf int

	IF @UserID IS NULL SET @UserConf = 0
	ELSE SET @UserConf = ISNULL(
		(
			SELECT TOP(1) C.LevelID 
			FROM [dbo].[PRVC_View_Confidentialities] AS C
			WHERE C.ApplicationID = @ApplicationID  AND C.ObjectID = @UserID
		),
		ISNULL((
			SELECT MIN(C.LevelID) 
			FROM [dbo].[PRVC_ConfidentialityLevels] AS C
			WHERE C.ApplicationID = @ApplicationID AND C.Deleted = 0
		), 0)
	)
	-- end of Find Confidentiality of the User

	DECLARE @GroupIDs GuidTableType

	INSERT INTO @GroupIDs (Value)
	SELECT NM.NodeID
	FROM [dbo].[CN_View_NodeMembers] AS NM
	WHERE NM.ApplicationID = @ApplicationID AND NM.UserID = @UserID AND NM.IsPending = 0

	DECLARE @ItemIDs TABLE (ID uniqueidentifier, [Level] int)

	INSERT INTO @ItemIDs(ID, [Level])
	SELECT X.NodeID, MIN(ISNULL(X.[Level], 0)) + 1
	FROM [dbo].[CN_FN_GetNodesHierarchy](@ApplicationID, @GroupIDs) AS X
	GROUP BY X.NodeID


	IF ISNULL(@ObjectType, N'') <> N'Node' BEGIN
		INSERT INTO @OutputTable (ID, [Type])
		SELECT O.Value, P.FirstValue
		FROM (
				SELECT Ref.ObjectID AS ID, Ref.[Type], Ref.Allow
				FROM (
						SELECT	ROW_NUMBER() OVER (PARTITION BY X.ObjectID, X.[Type]
									ORDER BY X.[Level] ASC, X.Allow ASC) AS RowNumber,
								X.ObjectID,
								X.[Type],
								X.Allow
						FROM (
								SELECT	O.Value AS ObjectID, 
										A.PermissionType AS [Type], 
										ISNULL(I.[Level], 0) AS [Level], 
										A.Allow
								FROM @ObjectIDs AS O
									INNER JOIN [dbo].[PRVC_Audience] AS A
									ON A.ApplicationID = @ApplicationID AND A.ObjectID = O.Value AND A.Deleted = 0 AND
										A.PermissionType IN (SELECT P.FirstValue FROM @PermissionTypes AS P) AND
										(A.ExpirationDate IS NULL OR (@Yesterday IS NOT NULL AND A.ExpirationDate >= @Yesterday))
									LEFT JOIN [dbo].[PRVC_Settings] AS S
									ON S.ApplicationID = @ApplicationID AND S.ObjectID = O.Value
									LEFT JOIN [dbo].[PRVC_ConfidentialityLevels] AS CL
									ON CL.ApplicationID = @ApplicationID AND CL.ID = S.ConfidentialityID AND CL.Deleted = 0
									LEFT JOIN @ItemIDs AS I
									ON I.ID = A.RoleID
								WHERE (I.ID IS NOT NULL OR A.RoleID = @UserID) AND
									(S.ObjectID IS NULL OR ISNULL(S.CalculateHierarchy, 0) = 1 OR ISNULL(I.[Level], 0) <= 1) AND
									@UserConf >= ISNULL(CL.LevelID, 0)
							) AS X
					) AS Ref
				WHERE Ref.RowNumber = 1
			) AS A
			RIGHT JOIN @ObjectIDs AS O
			CROSS JOIN @PermissionTypes AS P
			LEFT JOIN [dbo].[PRVC_DefaultPermissions] AS D
			ON D.ApplicationID = @ApplicationID AND D.ObjectID = O.Value AND D.PermissionType = P.FirstValue
			ON O.Value = A.ID AND P.FirstValue = A.[Type]
		WHERE ISNULL(A.Allow, 0) = 1 OR (A.ID IS NULL AND ISNULL(ISNULL(D.DefaultValue, P.SecondValue), N'') = N'Public')
	END
	ELSE BEGIN
		DECLARE @Nodes TABLE (
			NodeID uniqueidentifier, NodeTypeID uniqueidentifier, 
			DocumentTreeNodeID uniqueidentifier, DocumentTreeID uniqueidentifier, 
			PermissionType varchar(50),  
			DefaultValue bit, DefaultN bit, DefaultNT bit, DefaultDTN bit, DefaultDT bit,
			NAllow bit, NTAllow bit, DTNAllow bit, DTAllow bit
		)

		INSERT INTO @Nodes (NodeID, NodeTypeID, DocumentTreeNodeID, DocumentTreeID, PermissionType, DefaultValue)
		SELECT ND.NodeID, ND.NodeTypeID, ND.DocumentTreeNodeID, TN.TreeID, 
			P.FirstValue, [dbo].[PRVC_FN_DefaultValueToBoolean](P.SecondValue)
		FROM @ObjectIDs AS O
			CROSS JOIN @PermissionTypes AS P
			INNER JOIN [dbo].[CN_Nodes] AS ND
			ON ND.ApplicationID = @ApplicationID AND ND.NodeID = O.Value
			LEFT JOIN [dbo].[DCT_TreeNodes] AS TN
			ON ND.DocumentTreeNodeID IS NOT NULL AND TN.ApplicationID = @ApplicationID AND 
				TN.TreeNodeID = ND.DocumentTreeNodeID AND TN.Deleted = 0
			LEFT JOIN [dbo].[DCT_Trees] AS T
			ON ND.DocumentTreeNodeID IS NOT NULL AND T.ApplicationID = @ApplicationID AND 
				T.TreeID = TN.TreeID AND T.Deleted = 0
				
		DECLARE @IDs TABLE (ID uniqueidentifier, [Type] varchar(20), 
			DefaultValue bit, PRIMARY KEY CLUSTERED (ID ASC, [Type] ASC))
		
		INSERT INTO @IDs (ID, [Type], DefaultValue)
		SELECT DISTINCT I.Value, PT.FirstValue, [dbo].[PRVC_FN_DefaultValueToBoolean](DP.DefaultValue)
		FROM (
				SELECT X.Value FROM @ObjectIDs AS X
				UNION ALL 
				SELECT DISTINCT N.NodeTypeID FROM @Nodes AS N WHERE N.NodeTypeID IS NOT NULL
				UNION ALL
				SELECT DISTINCT N.DocumentTreeNodeID FROM @Nodes AS N WHERE N.DocumentTreeNodeID IS NOT NULL
				UNION ALL
				SELECT DISTINCT N.DocumentTreeID FROM @Nodes AS N WHERE N.DocumentTreeID IS NOT NULL
			) AS I
			CROSS JOIN @PermissionTypes AS PT
			LEFT JOIN [dbo].[PRVC_DefaultPermissions] AS DP
			ON DP.ApplicationID = @ApplicationID AND DP.ObjectID = I.Value AND DP.PermissionType = PT.FirstValue
			
		UPDATE @Nodes SET DefaultN = IDs.DefaultValue
		FROM @Nodes AS N INNER JOIN @IDs AS IDs ON IDs.ID = N.NodeID AND IDs.[Type] = N.PermissionType
			
		UPDATE @Nodes SET DefaultNT = IDs.DefaultValue
		FROM @Nodes AS N INNER JOIN @IDs AS IDs ON IDs.ID = N.NodeTypeID AND IDs.[Type] = N.PermissionType
		
		UPDATE @Nodes SET DefaultDTN = IDs.DefaultValue
		FROM @Nodes AS N INNER JOIN @IDs AS IDs ON IDs.ID = N.DocumentTreeNodeID AND IDs.[Type] = N.PermissionType
		
		UPDATE @Nodes SET DefaultDT = IDs.DefaultValue
		FROM @Nodes AS N INNER JOIN @IDs AS IDs ON IDs.ID = N.DocumentTreeID AND IDs.[Type] = N.PermissionType
		
		DECLARE @Values TABLE (ID uniqueidentifier, [Type] varchar(20), Allow bit)

		INSERT INTO @Values (ID, [Type], Allow)
		SELECT Ref.ObjectID, Ref.[Type], Ref.Allow
		FROM (
				SELECT	ROW_NUMBER() OVER (PARTITION BY X.ObjectID, X.[Type]
							ORDER BY X.[Level] ASC, X.Allow ASC) AS RowNumber,
						X.ObjectID,
						X.[Type],
						X.Allow
				FROM (
						SELECT	O.Value AS ObjectID, 
								A.PermissionType AS [Type], 
								ISNULL(I.[Level], 0) AS [Level], 
								A.Allow
						FROM (
								SELECT DISTINCT IDs.ID AS Value
								FROM @IDs AS IDs
							) AS O
							LEFT JOIN [dbo].[PRVC_Settings] AS S
							ON S.ApplicationID = @ApplicationID AND S.ObjectID = O.Value
							INNER JOIN [dbo].[PRVC_Audience] AS A
							ON A.ApplicationID = @ApplicationID AND A.ObjectID = O.Value AND A.Deleted = 0 AND
								A.PermissionType IN (SELECT P.FirstValue FROM @PermissionTypes AS P) AND
								(A.ExpirationDate IS NULL OR (@Yesterday IS NOT NULL AND A.ExpirationDate >= @Yesterday))
							LEFT JOIN @ItemIDs AS I
							ON I.ID = A.RoleID
						WHERE (I.ID IS NOT NULL OR A.RoleID = @UserID) AND 
							(S.ObjectID IS NULL OR ISNULL(S.CalculateHierarchy, 0) = 1 OR ISNULL(I.[Level], 0) <= 1)
					) AS X
			) AS Ref
		WHERE Ref.RowNumber = 1
		
		UPDATE @Nodes
			SET NAllow = V.Allow
		FROM @Nodes AS N
			INNER JOIN @Values AS V
			ON V.ID = N.NodeID AND V.[Type] = N.PermissionType
			
		UPDATE @Nodes
			SET NTAllow = V.Allow
		FROM @Nodes AS N
			INNER JOIN @Values AS V
			ON V.ID = N.NodeTypeID AND V.[Type] = N.PermissionType
			
		UPDATE @Nodes
			SET DTNAllow = V.Allow
		FROM @Nodes AS N
			INNER JOIN @Values AS V
			ON V.ID = N.DocumentTreeNodeID AND V.[Type] = N.PermissionType
			
		UPDATE @Nodes
			SET DTAllow = V.Allow
		FROM @Nodes AS N
			INNER JOIN @Values AS V
			ON V.ID = N.DocumentTreeID AND V.[Type] = N.PermissionType
		
		INSERT INTO @OutputTable (ID, [Type])
		SELECT	N.NodeID AS ID, 
				N.PermissionType AS [Type]
		FROM @Nodes AS N
			LEFT JOIN [dbo].[PRVC_View_Confidentialities] AS S
			ON S.ApplicationID = @ApplicationID AND S.ObjectID = N.NodeID
		WHERE @UserConf >= ISNULL(S.LevelID, 0) AND 
			ISNULL(ISNULL(
				[dbo].[PRVC_FN_CheckNodePermission](N.NAllow, N.NTAllow, N.DTNAllow, N.DTAllow),
				[dbo].[PRVC_FN_CheckNodePermission](N.DefaultN, N.DefaultNT, N.DefaultDTN, N.DefaultDT)
			), N.DefaultValue) = 1
	END
	
	RETURN
END

GO


SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[WF_FN_GetDashboardInfo]') 
    AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
DROP FUNCTION [dbo].[WF_FN_GetDashboardInfo]
GO

CREATE FUNCTION [dbo].[WF_FN_GetDashboardInfo](
	@WorkFlowName		nvarchar(1000),
	@StateTitle			nvarchar(1000),
	@DataNeedInstanceID	uniqueidentifier
)
RETURNS nvarchar(max)
WITH ENCRYPTION
AS
BEGIN
	RETURN '{"WorkFlowName":"' + ISNULL([dbo].[GFN_Base64encode](@WorkFlowName), N'') + 
		'","WorkFlowState":"' + ISNULL([dbo].[GFN_Base64encode](@StateTitle), N'') +
		(
			CASE
				WHEN @DataNeedInstanceID IS NULL THEN N''
				ELSE '","DataNeedInstanceID":"' + CAST(@DataNeedInstanceID AS varchar(50))
			END
		) +
		'"}'
END

GO


SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[FG_FN_CheckElementValue]') 
    AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
DROP FUNCTION [dbo].[FG_FN_CheckElementValue]
GO

CREATE FUNCTION [dbo].[FG_FN_CheckElementValue](
	@Type varchar(20),
	@RefText nvarchar(2000), 
	@RefFloat float, 
	@RefBit bit,
	@RefDate datetime,
	@Text nvarchar(max),
	@TextItems StringTableType readonly,
	@Or bit,
	@Exact bit,
	@DateFrom datetime,
	@DateTo datetime,
	@FloatFrom float, 
	@FloatTo float, 
	@Bit bit,
	@NoTextItem bit
)
RETURNS float
WITH ENCRYPTION
AS
BEGIN
	IF @Type = N'Text' OR @Type = N'File' BEGIN
		RETURN 
			CASE 
				WHEN @NoTextItem = 1 THEN (CASE WHEN ISNULL(@RefText, N'') = N'' THEN 1 ELSE 0 END)
				WHEN [dbo].[GFN_LikeMatch](@RefText, @TextItems, @Or, @Exact) = 1 THEN 1 
				ELSE 0 
			END
	END
	ELSE IF @Type = N'MultiLevel' BEGIN
		RETURN CASE 
				WHEN ISNULL(@NoTextItem, 0) = 0 AND EXISTS(SELECT TOP(1) * FROM @TextItems AS T WHERE T.Value = @RefText) THEN 1 
				ELSE 0 
			END
	END
	ELSE IF @Type = N'Checkbox' OR @Type = N'Select' BEGIN
		IF @Type = N'Select' SET @Or = 1
	
		RETURN
			CASE
				WHEN @NoTextItem = 1 THEN (CASE WHEN ISNULL(@RefText, N'') = N'' THEN 1 ELSE 0 END)
				WHEN ISNULL((
					SELECT SUM(CASE WHEN [dbo].[GFN_LikeMatch](LTRIM(RTRIM(ISNULL(Ref.Value, N''))), @TextItems, @Or, @Exact) = 1 THEN 1 ELSE 0 END)
					FROM [dbo].[GFN_StrToStringTable](ISNULL(@RefText, N''), N'~') AS Ref
				), 0) > 0 THEN 1
				ELSE 0
			END
	END
	ELSE IF @Type = N'Date' BEGIN
		RETURN 
			CASE 
				WHEN (@DateFrom IS NULL OR @RefDate >= @DateFrom) AND 
					(@DateTo IS NULL OR @RefDate <= @DateTo) THEN 1 
				ELSE 0 
			END
	END
	ELSE IF @Type = N'Binary' BEGIN
		RETURN 
			CASE 
				WHEN @Bit IS NULL THEN (CASE WHEN @RefBit IS NULL THEN 1 ELSE 0 END)
				WHEN @RefBit LIKE @Bit THEN 1 
				ELSE 0 
			END
	END
	ELSE IF @Type = N'Numeric' BEGIN
		RETURN 
			CASE 
				WHEN (@FloatFrom IS NULL OR @RefFloat >= @FloatFrom) AND 
					(@FloatTo IS NULL OR @RefFloat <= @FloatTo) THEN 1 
				ELSE 0 
			END
	END
	
	RETURN 0
END

GO


IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[FG_FN_FilterInstances]') 
    AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
DROP FUNCTION [dbo].[FG_FN_FilterInstances]
GO

CREATE FUNCTION [dbo].[FG_FN_FilterInstances](
	@ApplicationID	uniqueidentifier,
	@OwnerElementID	uniqueidentifier,
	@InstanceIDs	GuidTableType readonly,
	@FormFilters	FormFilterTableType readonly,
	@delimiter		char,
	@MatchAll		bit
)
RETURNS @Values Table(InstanceID uniqueidentifier primary key clustered, [Rank] float)
WITH ENCRYPTION
AS
BEGIN
	DECLARE @ElementID uniqueidentifier
	DECLARE @Type varchar(20)
	DECLARE @Text nvarchar(max)
	DECLARE @strTextItems nvarchar(max)
	DECLARE @Or bit
	DECLARE @Exact bit
	DECLARE @DateFrom datetime
	DECLARE @DateTo datetime
	DECLARE @FloatFrom float
	DECLARE @FloatTo float
	DECLARE @Bit bit
	DECLARE @strGuidItems varchar(max)
	DECLARE @Compulsory bit
	
	DECLARE @Fltrs Table(ID int IDENTITY(1,1), ElementID uniqueidentifier, [Type] varchar(20), Compulsory bit)
	
	INSERT INTO @Fltrs (ElementID, [Type], Compulsory)
	SELECT Ref.ElementID, E.[Type], Ref.Compulsory
	FROM @FormFilters AS Ref
		INNER JOIN [dbo].[FG_ExtendedFormElements] AS E
		ON E.ApplicationID = @ApplicationID AND E.ElementID = Ref.ElementID
	WHERE (Ref.OwnerID IS NULL AND @OwnerElementID IS NULL) OR Ref.OwnerID = @OwnerElementID
	
	DECLARE @Iter int = (SELECT COUNT(*) FROM @Fltrs)
	DECLARE @Count int = @Iter
	DECLARE @CompulsoryCount int = (SELECT COUNT(F.ID) FROM @Fltrs AS F WHERE ISNULL(F.Compulsory, 0) = 1)
	
	DECLARE @RetInstIDs TABLE (
		InstanceID uniqueidentifier primary key clustered,
		[Rank] float,
		MatchCount int,
		CompulsoryCount int
	)
	
	INSERT INTO @RetInstIDs (InstanceID, [Rank], MatchCount, CompulsoryCount)
	SELECT Ref.Value, 0, 0, 0
	FROM @InstanceIDs AS Ref
	
	WHILE @Iter > 0 BEGIN
		SELECT	@ElementID = FF.ElementID,
				@Type = F.[Type],
				@Text = FF.[Text],
				@strTextItems = FF.TextItems,
				@Or = FF.[Or],
				@Exact = FF.Exact,
				@DateFrom = FF.DateFrom,
				@DateTo = FF.DateTo,
				@FloatFrom = FF.FloatFrom,
				@FloatTo = FF.FloatTo,
				@Bit = FF.[Bit],
				@strGuidItems = FF.GuidItems,
				@Compulsory = F.Compulsory
		FROM @Fltrs AS F
			INNER JOIN @FormFilters AS FF
			ON F.ElementID = FF.ElementID
		WHERE F.ID = @Iter
		
		IF @Text = N'' SET @Text = NULL
		
		DECLARE @TextItems StringTableType
		DECLARE @GuidItems GuidTableType
		DECLARE @NoTextItem bit
		DECLARE @NoGuidItem bit
		
		DELETE @TextItems
		DELETE @GuidItems
		
		SET @NoTextItem = 0
		SET @NoGuidItem = 0
		
		INSERT INTO @TextItems
		SELECT Ref.Value
		FROM [dbo].[GFN_StrToStringTable](@strTextItems, @delimiter) AS Ref
		
		IF (SELECT COUNT(*) FROM @TextItems) = 0 SET @NoTextItem = 1
		
		INSERT INTO @GuidItems
		SELECT Ref.Value 
		FROM [dbo].[GFN_StrToGuidTable](@strGuidItems, @delimiter) AS Ref
		
		IF (SELECT COUNT(*) FROM @GuidItems) = 0 SET @NoGuidItem = 1
		
		IF @Type = N'Form' BEGIN
			DECLARE @InstElems TABLE (ElementID uniqueidentifier, InstanceID uniqueidentifier, Score float)
			DECLARE @OwnerIDs GuidTableType
			
			INSERT INTO @InstElems (ElementID, InstanceID)
			SELECT IE.ElementID, Ref.InstanceID
			FROM @RetInstIDs AS Ref
				INNER JOIN [dbo].[FG_InstanceElements] AS IE
				ON IE.ApplicationID = @ApplicationID AND IE.InstanceID = Ref.InstanceID
			WHERE IE.RefElementID = @ElementID AND IE.Deleted = 0
			
			INSERT INTO @OwnerIDs (Value)
			SELECT DISTINCT I.ElementID
			FROM @InstElems AS I
			
			UPDATE @InstElems
				SET Score = Ref.[Rank]
			FROM @InstElems AS I
				INNER JOIN [dbo].[FG_FN_FilterInstanceOwners](@ApplicationID, 
					@ElementID, @OwnerIDs, @FormFilters, @MatchAll) AS Ref
				ON Ref.OwnerID = I.ElementID
				
			DECLARE @MaxScore float = (SELECT MAX(Score) FROM @InstElems)
			IF @MaxScore IS NULL OR @MaxScore <= 0 SET @MaxScore = 1
			
			UPDATE @RetInstIDs
				SET [Rank] = [Rank] + (I.Score / @MaxScore),
					MatchCount = MatchCount + 1,
					CompulsoryCount = CompulsoryCount + CAST(ISNULL(@Compulsory, 0) AS int)
			FROM @RetInstIDs AS R
				INNER JOIN @InstElems AS I
				ON I.InstanceID = R.InstanceID
			WHERE ISNULL(I.Score, 0) > 0
		END
		ELSE IF @Type = N'File' BEGIN
			UPDATE @RetInstIDs
				SET [Rank] = [Rank] + X.Score,
					MatchCount = MatchCount + 1,
					CompulsoryCount = CompulsoryCount + CAST(ISNULL(@Compulsory, 0) AS int)
			FROM @RetInstIDs AS Ref
				INNER JOIN (
					SELECT	Ref.InstanceID,
							[dbo].[FG_FN_CheckElementValue](
								IE.[Type], F.[FileName], NULL, NULL, NULL, 
								@Text, @TextItems, @Or, @Exact, @DateFrom, @DateTo, 
								@FloatFrom, @FloatTo, @Bit, @NoTextItem
							) AS Score
					FROM @RetInstIDs AS Ref
						INNER JOIN [dbo].[FG_InstanceElements] AS IE
						ON IE.ApplicationID = @ApplicationID AND IE.InstanceID = Ref.InstanceID
						INNER JOIN [dbo].[DCT_Files] AS F
						ON F.ApplicationID = @ApplicationID AND F.OwnerID = IE.ElementID
					WHERE IE.RefElementID = @ElementID AND IE.Deleted = 0
				) AS X
				ON X.InstanceID = Ref.InstanceID
			WHERE X.Score > 0			
		END
		ELSE IF @Type = N'Node' OR @Type = N'User' BEGIN
			UPDATE @RetInstIDs
				SET [Rank] = [Rank] + X.Score,
					MatchCount = MatchCount + 1,
					CompulsoryCount = CompulsoryCount + CAST(ISNULL(@Compulsory, 0) AS int)
			FROM @RetInstIDs AS Ref
				INNER JOIN (
					SELECT	Ref.InstanceID,
							CAST(COUNT(G.Value) AS float) AS Score
					FROM @RetInstIDs AS Ref
						INNER JOIN [dbo].[FG_InstanceElements] AS IE
						ON IE.ApplicationID = @ApplicationID AND IE.InstanceID = Ref.InstanceID
						INNER JOIN [dbo].[FG_SelectedItems] AS S
						ON S.ApplicationID = @ApplicationID AND 
							S.ElementID = IE.ElementID AND S.Deleted = 0
						INNER JOIN @GuidItems AS G
						ON G.Value = S.SelectedID
					WHERE IE.RefElementID = @ElementID AND IE.Deleted = 0
					GROUP BY Ref.InstanceID
				) AS X
				ON X.InstanceID = Ref.InstanceID
			WHERE @NoGuidItem = 0 AND X.Score > 0
		END
		ELSE BEGIN
			UPDATE @RetInstIDs
				SET [Rank] = [Rank] + X.Score,
					MatchCount = MatchCount + 1,
					CompulsoryCount = CompulsoryCount + CAST(ISNULL(@Compulsory, 0) AS int)
			FROM @RetInstIDs AS Ref
				INNER JOIN (
					SELECT	Ref.InstanceID,
							[dbo].[FG_FN_CheckElementValue](
								ISNULL(IE.[Type], @Type), IE.TextValue, IE.FloatValue, IE.BitValue, IE.DateValue, 
								@Text, @TextItems, @Or, @Exact, @DateFrom, @DateTo, 
								@FloatFrom, @FloatTo, @Bit, @NoTextItem
							) AS Score
					FROM @RetInstIDs AS Ref
						LEFT JOIN [dbo].[FG_InstanceElements] AS IE
						ON IE.ApplicationID = @ApplicationID AND IE.InstanceID = Ref.InstanceID AND
							IE.RefElementID = @ElementID AND IE.Deleted = 0
				) AS X
				ON X.InstanceID = Ref.InstanceID
			WHERE X.Score > 0
		END
		
		SET @Iter = @Iter - 1
	END
	
	INSERT INTO @Values (InstanceID, [Rank])
	SELECT Ref.InstanceID, ref.[Rank]
	FROM @RetInstIDs AS Ref
	WHERE Ref.[Rank] > 0 AND (ISNULL(@MatchAll, 0) = 0 OR Ref.MatchCount = @Count) AND 
		Ref.CompulsoryCount = @CompulsoryCount AND (
			CASE
				WHEN @Count > @CompulsoryCount THEN 
					(CASE WHEN Ref.MatchCount > Ref.CompulsoryCount THEN 1 ELSE 0 END)
				ELSE 1
			END
		) = 1
	
	RETURN
END

GO


IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[FG_FN_FilterInstanceOwners]') 
    AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
DROP FUNCTION [dbo].[FG_FN_FilterInstanceOwners]
GO

CREATE FUNCTION [dbo].[FG_FN_FilterInstanceOwners](
	@ApplicationID	uniqueidentifier,
	@OwnerElementID	uniqueidentifier, -- OwnerElement is a FormElement of type 'Form'
	@OwnerIDs		GuidTableType readonly,
	@FormFilters	FormFilterTableType readonly,
	@MatchAll		bit
)
RETURNS @Values Table(
	OwnerID uniqueidentifier,
	[Rank] float
)
WITH ENCRYPTION
AS
BEGIN
	DECLARE @FormInstanceOwners Table (InstanceID uniqueidentifier, OwnerID uniqueidentifier)
	DECLARE @InstanceIDs GuidTableType
	
	INSERT INTO @FormInstanceOwners (InstanceID, OwnerID)
	SELECT ISNULL(X.InstanceID, [dbo].[GFN_NewGuid]()), Ref.Value
	FROM @OwnerIDs AS Ref 
		LEFT JOIN [dbo].[FG_FN_GetOwnerFormInstanceIDs](@ApplicationID, @OwnerIDs, NULL, NULL, NULL) AS X
		ON X.OwnerID = Ref.Value
	
	INSERT INTO @InstanceIDs (Value)
	SELECT DISTINCT Ref.InstanceID
	FROM @FormInstanceOwners AS Ref
	
	INSERT INTO @Values (OwnerID, [Rank])
	SELECT O.OwnerID, SUM(Ref.[Rank])
	FROM @FormInstanceOwners AS O
		INNER JOIN [dbo].[FG_FN_FilterInstances](
			@ApplicationID, @OwnerElementID, @InstanceIDs, @FormFilters, N',', @MatchAll
		) AS Ref
		ON Ref.InstanceID = O.InstanceID
	GROUP BY O.OwnerID
	
	RETURN
END

GO


IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[FG_FN_ToString]') 
    AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
DROP FUNCTION [dbo].[FG_FN_ToString]
GO

CREATE FUNCTION [dbo].[FG_FN_ToString](
	@ApplicationID	uniqueidentifier,
	@ElementID		uniqueidentifier,
	@Type			varchar(50),
	@TextValue		nvarchar(max),
	@FloatValue		float,
	@BitValue		bit,
	@DateValue		datetime
)
RETURNS nvarchar(max)
WITH ENCRYPTION
AS
BEGIN
	IF @Type = N'File' BEGIN
		RETURN CAST([dbo].[DCT_FN_FilesCount](@ApplicationID, @ElementID) AS nvarchar(max))
	END
	ELSE IF @Type = N'Form' BEGIN
		RETURN CAST(ISNULL((
			SELECT COUNT(FI.InstanceID)
			FROM [dbo].[FG_FormInstances] AS FI
			WHERE FI.ApplicationID = @ApplicationID AND FI.OwnerID = @ElementID AND FI.Deleted = 0
		), 0) AS nvarchar(max))
	END
	ELSE IF @Type = N'Node' OR @Type = N'User' BEGIN
		RETURN @TextValue
		
		/*
		RETURN CAST(ISNULL((
			SELECT COUNT(S.SelectedID)
			FROM [dbo].[FG_SelectedItems] AS S
			WHERE S.ApplicationID = @ApplicationID AND S.ElementID = @ElementID AND S.Deleted = 0
		), 0) AS nvarchar(max))
		*/
	END
	ELSE IF @TextValue IS NOT NULL RETURN @TextValue
	ELSE IF @FloatValue IS NOT NULL RETURN CAST(@FloatValue AS nvarchar(max))
	ELSE IF @BitValue IS NOT NULL RETURN CAST(@BitValue AS nvarchar(max))
	ELSE IF @DateValue IS NOT NULL RETURN CAST(@DateValue AS nvarchar(max))
	
	RETURN CAST(N'' AS varchar(max))
END

GO


IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[FG_FN_IsFillable]') 
    AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
DROP FUNCTION [dbo].[FG_FN_IsFillable]
GO

CREATE FUNCTION [dbo].[FG_FN_IsFillable](
	@Type varchar(50)
)
RETURNS bit
WITH ENCRYPTION
AS
BEGIN
	IF @Type = N'Separator' RETURN 0
	ELSE RETURN 1
	
	RETURN 0
END

GO


IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[FG_FN_HasElementLimit]') 
    AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
DROP FUNCTION [dbo].[FG_FN_HasElementLimit]
GO

CREATE FUNCTION [dbo].[FG_FN_HasElementLimit](
	@ApplicationID	uniqueidentifier,
	@OwnerID		uniqueidentifier
)
RETURNS bit
WITH ENCRYPTION
AS
BEGIN
	DECLARE @Ret bit = (
		SELECT TOP(1) CAST(1 AS bit)
		FROM [dbo].[FG_ElementLimits] AS L
			INNER JOIN [dbo].[FG_FormOwners] AS FO
			ON FO.ApplicationID = @ApplicationID AND Fo.OwnerID = @OwnerID
			INNER JOIN [dbo].[FG_ExtendedFormElements] AS E
			ON E.ApplicationID = @ApplicationID AND 
				E.ElementID = L.ElementID AND E.Deleted = 0
		WHERE L.ApplicationID = @ApplicationID AND L.OwnerID = @OwnerID AND L.Deleted = 0
	)
	
	RETURN ISNULL(@Ret, 0)
END

GO


IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[FG_FN_GetLimitedElements]') 
    AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
DROP FUNCTION [dbo].[FG_FN_GetLimitedElements]
GO

CREATE FUNCTION [dbo].[FG_FN_GetLimitedElements](
	@ApplicationID	uniqueidentifier,
	@OwnerID		uniqueidentifier
)
RETURNS @Values TABLE (ElementID uniqueidentifier)
WITH ENCRYPTION
AS
BEGIN
	DECLARE @HasLimits bit = [dbo].[FG_FN_HasElementLimit](@ApplicationID, @OwnerID)
	
	IF @HasLimits = 1 BEGIN
		INSERT INTO @Values (ElementID)
		SELECT L.ElementID
		FROM [dbo].[FG_ElementLimits] AS L
			INNER JOIN [dbo].[FG_FormOwners] AS FO
			ON FO.ApplicationID = @ApplicationID AND FO.OwnerID = @OwnerID AND FO.Deleted = 0
			INNER JOIN [dbo].[FG_ExtendedFormElements] AS E
			ON E.ApplicationID = @ApplicationID AND E.ElementID = L.ElementID AND E.Deleted = 0
		WHERE L.ApplicationID = @ApplicationID AND L.OwnerID = @OwnerID AND L.Deleted = 0
	END
	ELSE BEGIN
		INSERT INTO @Values (ElementID)
		SELECT E.ElementID
		FROM [dbo].[FG_FormOwners] AS FO
			INNER JOIN [dbo].[FG_ExtendedFormElements] AS E
			ON E.ApplicationID = @ApplicationID AND E.FormID = FO.FormID AND E.Deleted = 0
		WHERE FO.ApplicationID = @ApplicationID AND FO.OwnerID = @OwnerID AND FO.Deleted = 0
	END
	
	RETURN
END

GO


IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[FG_FN_HasFormContent]') 
    AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
DROP FUNCTION [dbo].[FG_FN_HasFormContent]
GO

CREATE FUNCTION [dbo].[FG_FN_HasFormContent](
	@ApplicationID	uniqueidentifier,
	@OwnerID		uniqueidentifier
)
RETURNS bit
WITH ENCRYPTION
AS
BEGIN
	RETURN CAST((
		SELECT TOP(1) 1
		FROM [dbo].[FG_FormInstances] AS I
			INNER JOIN [dbo].[FG_InstanceElements] AS E
			ON E.ApplicationID = @ApplicationID AND E.InstanceID = I.InstanceID
		WHERE I.ApplicationID = @ApplicationID AND I.OwnerID = @OwnerID AND 
			I.Deleted = 0 AND E.Deleted = 0 AND (
				ISNULL([dbo].[FG_FN_ToString](@ApplicationID, E.ElementID, E.[Type], 
					E.TextValue, E.FloatValue, E.BitValue, E.DateValue), N'') <> N''
			)
	) AS bit)
END

GO


IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[FG_FN_GetOwnerFormContents]') 
    AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
DROP FUNCTION [dbo].[FG_FN_GetOwnerFormContents]
GO

CREATE FUNCTION [dbo].[FG_FN_GetOwnerFormContents](
	@ApplicationID	uniqueidentifier,
	@OwnerID		uniqueidentifier,
	@MaxLevel		int
)
RETURNS nvarchar(max)
WITH ENCRYPTION
AS
BEGIN
	SET @MaxLevel = ISNULL(@MaxLevel, 0)

	IF @MaxLevel <= 0 RETURN CAST(N'' AS varchar(max))

	DECLARE @Ret nvarchar(max) = NULL

	DECLARE @Exceptions StringTableType

	;WITH Partitioned AS
	(
		SELECT	OwnerID,
				CASE 
					WHEN IE.[Type] = N'Form' 
						THEN [dbo].[FG_FN_GetOwnerFormContents](@ApplicationID, IE.ElementID, @MaxLevel - 1)
					ELSE [dbo].[FG_FN_ToString](@ApplicationID, IE.ElementID, IE.[Type], 
						IE.TextValue, IE.FloatValue, IE.BitValue, IE.DateValue)
				END AS Content,
				ROW_NUMBER() OVER (PARTITION BY @OwnerID ORDER BY IE.ElementID) AS Number,
				COUNT(*) OVER (PARTITION BY @OwnerID) AS [Count]
		FROM [dbo].[FG_FormInstances] AS FI
			INNER JOIN [dbo].[FG_InstanceElements] AS IE
			ON IE.ApplicationID = @ApplicationID AND IE.InstanceID = FI.InstanceID AND 
				IE.[Type] <> N'File' AND IE.Deleted = 0
		WHERE FI.ApplicationID = @ApplicationID AND FI.OwnerID = @OwnerID AND FI.Deleted = 0
	),
	Fetched AS
	(
		SELECT	P.OwnerID, P.Content AS FullContent, P.Content, P.Number, P.[Count] 
		FROM Partitioned AS P
		WHERE P.Number = 1

		UNION ALL

		SELECT	P.OwnerID, ISNULL(C.FullContent, N'') + ' ' + ISNULL(P.Content, N''), P.Content, P.Number, P.[Count]
		FROM Partitioned AS P
			INNER JOIN Fetched AS C 
			ON P.OwnerID = C.OwnerID AND P.Number = C.Number + 1
		WHERE P.Number <= 95
	)
	SELECT TOP(1) @Ret = F.FullContent
	FROM Fetched AS F
	WHERE F.Number = (CASE WHEN F.[Count] > 90 THEN 90 ELSE F.[Count] END)
	
	RETURN @Ret
END

GO


IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[FG_FN_CheckUniqueConstraint]') 
    AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
DROP FUNCTION [dbo].[FG_FN_CheckUniqueConstraint]
GO

CREATE FUNCTION [dbo].[FG_FN_CheckUniqueConstraint](
	@ApplicationID	uniqueidentifier,
	@Elements		FormElementTableType readonly
)
RETURNS @OutputTable TABLE (
	ElementID uniqueidentifier,
	RefElementID uniqueidentifier
)
WITH ENCRYPTION
AS
BEGIN
	DECLARE @OwnerIDs GuidTableType
	
	INSERT INTO @OwnerIDs (Value)
	SELECT DISTINCT I.OwnerID
	FROM @Elements AS E
		INNER JOIN [dbo].[FG_FormInstances] AS I
		ON I.ApplicationID = @ApplicationID AND I.InstanceID = E.InstanceID

	INSERT INTO @OutputTable (ElementID, RefElementID)
	SELECT DISTINCT Ref.ElementID, Ref.RefElementID
	FROM @Elements AS Ref
		INNER JOIN [dbo].[FG_ExtendedFormElements] AS E
		ON E.ApplicationID = @ApplicationID AND 
			(E.ElementID = Ref.ElementID OR E.ElementID = Ref.RefElementID) AND 
			E.UniqueValue = 1 AND (E.[Type] = N'Text' OR E.[Type] = N'Numeric')
		INNER JOIN [dbo].[FG_InstanceElements] AS IE
		ON IE.ApplicationID = @ApplicationID AND IE.RefElementID = E.ElementID AND
			(Ref.ElementID IS NULL OR IE.ElementID <> Ref.ElementID) AND
			(
				CASE 
					WHEN E.[Type] = N'Text' AND ISNULL(Ref.TextValue, N'') <> N'' AND 
						ISNULL(Ref.TextValue, N'') = ISNULL(IE.TextValue, N'') THEN 1
					WHEN E.[Type] = N'Numeric' AND Ref.FloatValue IS NOT NULL AND 
						IE.FloatValue IS NOT NULL AND Ref.FloatValue = IE.FloatValue THEN 1
					ELSE 0
				END
			) = 1
		INNER JOIN (
			SELECT FI.InstanceID
			FROM [dbo].[FG_FormInstances] AS FI
				INNER JOIN (
					SELECT ND.NodeID AS ID
					FROM @OwnerIDs AS IDs 
						INNER JOIN [dbo].[CN_NodeTypes] AS NT
						ON NT.ApplicationID = @ApplicationID AND NT.NodeTypeID = IDs.Value
						INNER JOIN [dbo].[CN_Nodes] AS ND
						ON ND.ApplicationID = @ApplicationID AND 
							ND.NodeTypeID = NT.NodeTypeID AND ND.Deleted = 0

					UNION

					SELECT ND.NodeID
					FROM @OwnerIDs AS IDs
						INNER JOIN [dbo].[CN_Nodes] AS NT
						ON NT.ApplicationID = @ApplicationID AND NT.NodeID = IDs.Value
						INNER JOIN [dbo].[CN_Nodes] AS ND
						ON ND.ApplicationID = @ApplicationID AND 
							ND.NodeTypeID = NT.NodeTypeID AND ND.Deleted = 0

					UNION

					SELECT IDs.Value
					FROM @OwnerIDs AS IDs
				) AS Owners
				ON FI.OwnerID = Owners.ID
			WHERE FI.ApplicationID = @ApplicationID
		) AS X
		ON X.InstanceID = IE.InstanceID
	
	RETURN
END

GO


IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[FG_FN_GetOwnerFormInstanceIDs]') 
    AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
DROP FUNCTION [dbo].[FG_FN_GetOwnerFormInstanceIDs]
GO

CREATE FUNCTION [dbo].[FG_FN_GetOwnerFormInstanceIDs](
	@ApplicationID	uniqueidentifier,
	@OwnerIDs		GuidTableType readonly,
	@FormID			uniqueidentifier,
	@IsTemporary	bit,
	@CreatorUserID	uniqueidentifier
)
RETURNS @OutputTable TABLE (
	OwnerID uniqueidentifier,
	InstanceID uniqueidentifier
)
WITH ENCRYPTION
AS
BEGIN
	INSERT INTO @OutputTable (OwnerID, InstanceID)
	SELECT FI.OwnerID, FI.InstanceID
	FROM (
			SELECT X.OwnerID, X.FormID
			FROM (
					SELECT	IDs.Value AS OwnerID,
							CAST((CASE WHEN MAX(ND.Name) IS NULL THEN 0 ELSE 1 END) AS bit) AS IsNode,
							ISNULL(@FormID, CAST(MAX(CAST(F.FormID AS varchar(50))) AS uniqueidentifier)) AS FormID,
							CAST((CASE WHEN @FormID IS NULL AND MAX(E.Extension) IS NULL THEN 0 ELSE 1 END) AS bit) AS HasForm
					FROM @OwnerIDs AS IDs
						LEFT JOIN [dbo].[CN_Nodes] AS ND
						ON @FormID IS NULL AND ND.ApplicationID = @ApplicationID AND ND.NodeID = IDs.Value
						LEFT JOIN [dbo].[FG_FormOwners] AS F
						ON @FormID IS NULL AND F.ApplicationID = @ApplicationID AND 
							F.OwnerID = ND.NodeTypeID AND F.Deleted = 0
						LEFT JOIN [dbo].[CN_Extensions] AS E
						ON @FormID IS NULL AND E.ApplicationID = @ApplicationID AND 
							E.OwnerID = ND.NodeTypeID AND E.Extension = N'Form' AND E.Deleted = 0
					GROUP BY IDs.Value
				) AS X
			WHERE (X.FormID IS NOT NULL AND X.HasForm = 1) OR X.IsNode = 0
		) AS ExternalIDs
		INNER JOIN [dbo].[FG_FormInstances] AS FI
		ON FI.ApplicationID = @ApplicationID AND FI.OwnerID = ExternalIDs.OwnerID AND
			(ExternalIDs.FormID IS NULL OR FI.FormID = ExternalIDs.FormID) AND FI.Deleted = 0 AND
			(@IsTemporary IS NULL OR ISNULL(FI.IsTemporary, 0) = @IsTemporary) AND
			(@CreatorUserID IS NULL OR FI.CreatorUserID = @CreatorUserID)
	
	RETURN
END

GO


IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[FG_FN_ValidateNewName]') 
    AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
DROP FUNCTION [dbo].[FG_FN_ValidateNewName]
GO

CREATE FUNCTION [dbo].[FG_FN_ValidateNewName](
	@ApplicationID	uniqueidentifier,
	@ObjectID		uniqueidentifier,
	@FormID			uniqueidentifier,
	@Name			varchar(100)
)
RETURNS bit
WITH ENCRYPTION
AS
BEGIN
	SET @Name = LOWER(LTRIM(RTRIM(ISNULL(@Name, ''))))
	
	IF @Name = '' OR @ObjectID IS NULL RETURN 0
	
	DECLARE @Ret bit = 1

	IF @FormID IS NULL BEGIN
		SELECT TOP(1) @Ret = 0
		FROM [dbo].[FG_ExtendedForms] AS F
		WHERE F.ApplicationID = @ApplicationID AND F.Deleted = 0 AND
			F.FormID <> @ObjectID AND LOWER(F.Name) = @Name
	END
	ELSE BEGIN
		SELECT TOP(1) @Ret = 0
		FROM [dbo].[FG_ExtendedFormElements] AS E
		WHERE E.ApplicationID = @ApplicationID AND E.FormID = @FormID AND E.Deleted = 0 AND
			E.ElementID <> @ObjectID AND LOWER(E.Name) = @Name
	END
	
	RETURN ISNULL(@Ret, 0)
END

GO

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[WK_FN_HasWikiContent]') 
    AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
DROP FUNCTION [dbo].[WK_FN_HasWikiContent]
GO

CREATE FUNCTION [dbo].[WK_FN_HasWikiContent](
	@ApplicationID	uniqueidentifier,
	@OwnerID		uniqueidentifier
)
RETURNS bit
WITH ENCRYPTION
AS
BEGIN
	RETURN CAST((
		SELECT TOP(1) 1
		FROM [dbo].[WK_Titles] AS TT
			INNER JOIN [dbo].[WK_Paragraphs] AS P
			ON P.ApplicationID = @ApplicationID AND P.TitleID = TT.TitleID
		WHERE TT.ApplicationID = @ApplicationID AND TT.OwnerID = @OwnerID AND 
			TT.Deleted = 0 AND P.Deleted = 0 AND ISNULL(P.BodyText, N'') <> N'' AND
			(P.[Status] = N'Accepted' OR P.[Status] = N'CitationNeeded')
	) AS bit)
END

GO


IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[WK_FN_GetWikiContent]') 
    AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
DROP FUNCTION [dbo].[WK_FN_GetWikiContent]
GO

CREATE FUNCTION [dbo].[WK_FN_GetWikiContent](
	@ApplicationID	uniqueidentifier,
	@OwnerID		uniqueidentifier
)
RETURNS nvarchar(max)
WITH ENCRYPTION
AS
BEGIN
	/*
	RETURN STUFF(
		(
			SELECT	N' <h1>' + ISNULL(TT.Title, N'') + N'</h1> ' + 
					N' <h2>' + ISNULL(P.Title, N'') + N'</h2> ' + ISNULL(P.BodyText, N'')
			FROM [dbo].[WK_Titles] AS TT
				INNER JOIN [dbo].[WK_Paragraphs] AS P
				ON P.ApplicationID = @ApplicationID AND P.TitleID = TT.TitleID
			WHERE TT.ApplicationID = @ApplicationID AND TT.OwnerID = @OwnerID AND 
				TT.Deleted = 0 AND P.Deleted = 0 AND
				(P.[Status] = N'Accepted' OR P.[Status] = N'CitationNeeded')
			FOR xml path('a'), type
		).value('.','nvarchar(max)'),
		1,
		1,
		''
	)
	*/

	DECLARE @Ret nvarchar(max) = NULL

	;WITH Partitioned AS
	(
		SELECT	TT.OwnerID,
				N' <h1>' + ISNULL(TT.Title, N'') + N'</h1> ' + 
				N' <h2>' + ISNULL(P.Title, N'') + N'</h2> ' + 
				CAST(SUBSTRING(ISNULL(P.BodyText, N''), 1, 4000) AS nvarchar(4000)) AS Content,
				ROW_NUMBER() OVER (PARTITION BY TT.OwnerID ORDER BY P.ParagraphID) AS Number,
				COUNT(*) OVER (PARTITION BY TT.OwnerID) AS [Count]
		FROM [dbo].[WK_Titles] AS TT
			INNER JOIN [dbo].[WK_Paragraphs] AS P
			ON P.ApplicationID = @ApplicationID AND P.TitleID = TT.TitleID
		WHERE TT.ApplicationID = @ApplicationID AND TT.OwnerID = @OwnerID AND 
			TT.Deleted = 0 AND P.Deleted = 0 AND ISNULL(P.BodyText, N'') <> N'' AND
			(P.[Status] = N'Accepted' OR P.[Status] = N'CitationNeeded')
	),
	Fetched AS
	(
		SELECT	P.OwnerID, P.Content AS FullContent, P.Content, P.Number, P.[Count] 
		FROM Partitioned AS P
		WHERE P.Number = 1

		UNION ALL

		SELECT	P.OwnerID, C.FullContent + ' ' + P.Content, P.Content, P.Number, P.[Count]
		FROM Partitioned AS P
			INNER JOIN Fetched AS C 
			ON P.OwnerID = C.OwnerID AND P.Number = C.Number + 1
		WHERE P.Number <= 95
	)
	SELECT TOP(1) @Ret = F.FullContent
	FROM Fetched AS F
	WHERE F.Number = (CASE WHEN F.[Count] > 90 THEN 90 ELSE F.[Count] END)
	
	RETURN @Ret
END

GO


SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[USR_FN_GetMutualFriendsCount]') 
            AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
DROP FUNCTION [dbo].[USR_FN_GetMutualFriendsCount]
GO

CREATE FUNCTION [dbo].[USR_FN_GetMutualFriendsCount]
(
	@ApplicationID	uniqueidentifier,
	@UserID			uniqueidentifier,
	@OtherUserIDs	GuidTableType readonly
)
RETURNS
@outputTable TABLE
(
	UserID				uniqueidentifier,
    MutualFriendsCount	int
)
WITH ENCRYPTION
AS
BEGIN
	INSERT INTO @outputTable (UserID, MutualFriendsCount)
	SELECT O.Value AS UserID, COUNT(F.FriendID) AS MutualsCount
	FROM [dbo].[USR_View_Friends] AS F
		INNER JOIN @OtherUserIDs AS O
		INNER JOIN [dbo].[USR_View_Friends] AS F2
		ON F2.ApplicationId = @ApplicationID AND F2.UserID = O.Value
		ON F2.FriendID = F.FriendID
	WHERE F.ApplicationId = @ApplicationID AND F.UserID = @UserID AND 
		F.AreFriends = 1 AND F2.AreFriends = 1 AND 
		F2.FriendID <> F.UserID AND F.FriendID <> F2.UserID
	GROUP BY F.UserID, O.Value
   
    RETURN 
END

GO


IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[USR_FN_GetFriendIDs]') 
            AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
DROP FUNCTION [dbo].[USR_FN_GetFriendIDs]
GO

CREATE FUNCTION [dbo].[USR_FN_GetFriendIDs]
(
	@ApplicationID	uniqueidentifier,
	@UserID			uniqueidentifier,
	@AreFriends		bit,
    @Sent			bit,
    @Received		bit
)
RETURNS
@outputTable TABLE
(
	UserID		uniqueidentifier primary key clustered
)
WITH ENCRYPTION
AS
BEGIN
	INSERT INTO @outputTable (UserID)
	SELECT F.FriendID AS ID
	FROM [dbo].[USR_View_Friends] AS F
	WHERE F.ApplicationId = @ApplicationID AND F.UserID = @UserID AND 
		(@AreFriends IS NULL OR F.AreFriends = @AreFriends) AND
		((@Received = 1 AND F.IsSender = 0) OR (@Sent = 1 AND F.IsSender = 1))
   
    RETURN 
END

GO


SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


IF  EXISTS (SELECT * FROM sys.objects 
            WHERE object_id = OBJECT_ID(N'[dbo].[DCT_FN_GetChildNodesHierarchy]') 
            AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
DROP FUNCTION [dbo].[DCT_FN_GetChildNodesHierarchy]
GO

CREATE FUNCTION [dbo].[DCT_FN_GetChildNodesHierarchy](
	@ApplicationID		uniqueidentifier,
	@NodeIDsOrTreeIDs	GuidTableType readonly,
	@Archive			bit
)	
RETURNS @OutputTable TABLE (
	NodeID uniqueidentifier primary key clustered,
	ParentID uniqueidentifier,
	[Level] int,
	Name nvarchar(2000),
	SequenceNumber int
)
WITH ENCRYPTION
AS
BEGIN
	INSERT INTO @OutputTable(NodeID, ParentID, [Level], Name, SequenceNumber)
	SELECT DISTINCT 
		X.TreeNodeID AS ID,
		X.ParentNodeID AS ParentID,
		0 AS [Level],
		X.Name,
		X.SequenceNumber
	FROM (
			SELECT	TN.*
			FROM @NodeIDsOrTreeIDs AS N
				INNER JOIN [dbo].[DCT_TreeNodes] AS TN
				ON TN.ApplicationID = @ApplicationID AND TN.TreeNodeID = N.Value
				
			UNION ALL
			
			SELECT TN.*
			FROM @NodeIDsOrTreeIDs AS N
				INNER JOIN [dbo].[DCT_Trees] AS T
				ON T.ApplicationID = @ApplicationID AND T.TreeID = N.Value
				INNER JOIN [dbo].[DCT_TreeNodes] AS TN
				ON TN.ApplicationID = @ApplicationID AND 
					TN.TreeID = T.TreeID AND TN.ParentNodeID IS NULL AND 
					(@Archive IS NULL OR TN.Deleted = @Archive)
		) AS X
	
	INSERT INTO @OutputTable(NodeID, ParentID, [Level], Name, SequenceNumber)
	SELECT TN.TreeNodeID AS ID, TN.ParentNodeID AS ParentID, 
		[Level] + 1, TN.Name AS Name, TN.SequenceNumber
	FROM [dbo].[DCT_TreeNodes] AS TN
		INNER JOIN @OutputTable AS HR
		ON HR.NodeID = TN.ParentNodeID
	WHERE TN.ApplicationID = @ApplicationID AND TN.TreeNodeID <> HR.NodeID AND 
		(@Archive IS NULL OR TN.Deleted = @Archive)
	
	RETURN
END

GO


IF  EXISTS (SELECT * FROM sys.objects 
            WHERE object_id = OBJECT_ID(N'[dbo].[DCT_FN_GetChildNodesDeepHierarchy]') 
            AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
DROP FUNCTION [dbo].[DCT_FN_GetChildNodesDeepHierarchy]
GO

CREATE FUNCTION [dbo].[DCT_FN_GetChildNodesDeepHierarchy](
	@ApplicationID	uniqueidentifier,
	@NodeIDs		GuidTableType readonly
)	
RETURNS @OutputTable TABLE (
	NodeID uniqueidentifier primary key clustered,
	ParentID uniqueidentifier,
	[Level] int,
	Name nvarchar(2000),
	SequenceNumber int
)
WITH ENCRYPTION
AS
BEGIN
	;WITH hierarchy (ID, ParentID, [Level], Name)
	AS
	(
		SELECT TN.TreeNodeID AS ID, TN.ParentNodeID AS ParentID, 0 AS [Level], TN.Name AS Name
		FROM @NodeIDs AS N
			INNER JOIN [dbo].[DCT_TreeNodes] AS TN
			ON TN.ApplicationID = @ApplicationID AND TN.TreeNodeID = N.Value
		
		UNION ALL
		
		SELECT Node.TreeNodeID AS ID, Node.ParentNodeID AS ParentID, [Level] + 1, Node.Name
		FROM [dbo].[DCT_TreeNodes] AS Node
			INNER JOIN hierarchy AS HR
			ON HR.ID = Node.ParentNodeID
		WHERE Node.ApplicationID = @ApplicationID AND 
			Node.TreeNodeID <> HR.ID AND Node.Deleted = 0
	)
	
	INSERT INTO @OutputTable (NodeID, ParentID, [Level], Name)
	SELECT H.ID, H.ParentID, H.[Level], H.Name
	FROM hierarchy AS H
	ORDER BY H.[Level] ASC
	
	RETURN
END

GO


IF  EXISTS (SELECT * FROM sys.objects 
            WHERE object_id = OBJECT_ID(N'[dbo].[DCT_FN_GetParentNodesHierarchy]') 
            AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
DROP FUNCTION [dbo].[DCT_FN_GetParentNodesHierarchy]
GO

CREATE FUNCTION [dbo].[DCT_FN_GetParentNodesHierarchy](
	@ApplicationID	uniqueidentifier,
	@NodeIDs		GuidTableType readonly
)	
RETURNS @OutputTable TABLE (
	NodeID uniqueidentifier primary key clustered,
	ParentID uniqueidentifier,
	[Level] int,
	Name nvarchar(2000)
)
WITH ENCRYPTION
AS
BEGIN
	INSERT INTO @OutputTable(NodeID, ParentID, [Level], Name)
	SELECT	TN.TreeNodeID AS ID, TN.ParentNodeID AS ParentID, 0 AS [Level], TN.Name
	FROM @NodeIDs AS N
		INNER JOIN [dbo].[DCT_TreeNodes] AS TN
		ON TN.ApplicationID = @ApplicationID AND TN.TreeNodeID = N.Value
	
	INSERT INTO @OutputTable(NodeID, ParentID, [Level], Name)
	SELECT TN.TreeNodeID AS ID, TN.ParentNodeID AS ParentID, [Level] + 1, TN.Name AS Name
	FROM [dbo].[DCT_TreeNodes] AS TN
		INNER JOIN @OutputTable AS HR
		ON HR.ParentID = TN.TreeNodeID
	WHERE TN.ApplicationID = @ApplicationID AND TN.TreeNodeID <> HR.NodeID
	
	RETURN
END

GO


IF  EXISTS (SELECT * FROM sys.objects 
            WHERE object_id = OBJECT_ID(N'[dbo].[DCT_FN_HasFile]') 
            AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
DROP FUNCTION [dbo].[DCT_FN_HasFile]
GO

CREATE FUNCTION [dbo].[DCT_FN_HasFile](
	@ApplicationID	uniqueidentifier,
	@OwnerID		uniqueidentifier
)	
RETURNS bit
WITH ENCRYPTION
AS
BEGIN
	RETURN CAST(ISNULL((
		SELECT 1
		FROM [dbo].[DCT_Files] AS F
		WHERE F.ApplicationID = @ApplicationID AND F.OwnerID = @OwnerID AND F.Deleted = 0
	), 0) AS bit)
END

GO


IF  EXISTS (SELECT * FROM sys.objects 
            WHERE object_id = OBJECT_ID(N'[dbo].[DCT_FN_FilesCount]') 
            AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
DROP FUNCTION [dbo].[DCT_FN_FilesCount]
GO

CREATE FUNCTION [dbo].[DCT_FN_FilesCount](
	@ApplicationID	uniqueidentifier,
	@OwnerID		uniqueidentifier
)	
RETURNS int
WITH ENCRYPTION
AS
BEGIN
	RETURN CAST(ISNULL((
		SELECT COUNT(F.ID)
		FROM [dbo].[DCT_Files] AS F
		WHERE F.ApplicationID = @ApplicationID AND F.OwnerID = @OwnerID AND F.Deleted = 0
	), 0) AS int)
END

GO


IF  EXISTS (SELECT * FROM sys.objects 
            WHERE object_id = OBJECT_ID(N'[dbo].[DCT_FN_GetFileOwnerNodes]') 
            AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
DROP FUNCTION [dbo].[DCT_FN_GetFileOwnerNodes]
GO

CREATE FUNCTION [dbo].[DCT_FN_GetFileOwnerNodes](
	@ApplicationID	uniqueidentifier,
	@FileIDs		GuidTableType readonly
)	
RETURNS @OutputTable TABLE (
	FileID uniqueidentifier,
	NodeID uniqueidentifier,
	NodeTypeID uniqueidentifier,
	NodeName nvarchar(500),
	NodeType nvarchar(500),
	[FileName] nvarchar(500),
	Extension nvarchar(20)
)
WITH ENCRYPTION
AS
BEGIN
	DECLARE @Files TABLE (ID uniqueidentifier, OwnerID uniqueidentifier,
		OwnerType varchar(20), [FileName] nvarchar(500), Extension nvarchar(20))

	INSERT INTO @Files (ID, OwnerID, OwnerType, [FileName], Extension)
	SELECT ID.Value, F.OwnerID, F.OwnerType, F.[FileName], F.Extension
	FROM @FileIDs AS ID
		INNER JOIN [dbo].[DCT_Files] AS F
		ON F.ApplicationID = @ApplicationID AND 
			(F.ID = ID.Value OR F.FileNameGuid = ID.Value) AND F.Deleted = 0
		
	INSERT INTO @OutputTable (FileID, NodeID, NodeTypeID, 
		NodeName, NodeType, [FileName], Extension)
	(
		SELECT	F.ID AS FileID, 
				ND.NodeID, 
				ND.NodeTypeID,
				ND.NodeName AS Name,
				ND.TypeName AS NodeType,
				F.[FileName],
				F.Extension
		FROM @Files AS F
			INNER JOIN [dbo].[CN_View_Nodes_Normal] AS ND
			ON ND.ApplicationID = @ApplicationID AND ND.NodeID = F.OwnerID AND ND.Deleted = 0
		WHERE F.OwnerType = N'Node' OR F.OwnerType = N'WikiContent'

		UNION ALL

		SELECT	F.ID AS FileID, 
				ND.NodeID,
				ND.NodeTypeID,
				ND.NodeName AS Name,
				ND.TypeName AS NodeType,
				F.[FileName],
				F.Extension
		FROM @Files AS F
			INNER JOIN [dbo].[FG_InstanceElements] AS E
			ON E.ApplicationID = @ApplicationID AND E.ElementID = F.OwnerID AND 
				E.[Type] = N'File' AND E.Deleted = 0
			INNER JOIN [dbo].[FG_FormInstances] AS I
			ON I.ApplicationID = @ApplicationID AND I.InstanceID = E.InstanceID AND I.Deleted = 0
			INNER JOIN [dbo].[CN_View_Nodes_Normal] AS ND
			ON ND.ApplicationID = @ApplicationID AND ND.NodeID = I.OwnerID AND ND.Deleted = 0
		WHERE F.OwnerType = N'FormElement'
	)
	
	RETURN
END

GO


IF  EXISTS (SELECT * FROM sys.objects 
            WHERE object_id = OBJECT_ID(N'[dbo].[DCT_FN_ListDeepAttachments]') 
            AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
DROP FUNCTION [dbo].[DCT_FN_ListDeepAttachments]
GO

CREATE FUNCTION [dbo].[DCT_FN_ListDeepAttachments](
	@ApplicationIDs	GuidTableType readonly,
	@NodeIDs		GuidTableType readonly,
	@Archive		bit
)	
RETURNS @OutputTable TABLE (
	ApplicationID	uniqueidentifier,
	FileID			uniqueidentifier,
	CreationDate	datetime,
	CreatorUserID	uniqueidentifier,
	NodeID			uniqueidentifier,
	NodeTypeID		uniqueidentifier,
	NodeName		nvarchar(500),
	NodeType		nvarchar(500),
	[FileName]		nvarchar(500),
	Extension		nvarchar(20),
	Size			bigint,
	OwnerType		varchar(100),
	Deleted			bit
)
WITH ENCRYPTION
AS
BEGIN
	DECLARE @AppsCount int = (SELECT COUNT(*) FROM @ApplicationIDs AS A)
	DECLARE @NodesCount int = (SELECT COUNT(*) FROM @NodeIDs AS N)

	;WITH Files
	AS
	(
		SELECT F.ApplicationID, F.ID, F.OwnerID, F.OwnerType, F.[FileName], F.Extension, F.Size, F.Deleted, F.CreatorUserID, F.CreationDate
		FROM [dbo].[DCT_Files] AS F
		WHERE (@AppsCount = 0 OR F.ApplicationID IN (SELECT App.[Value] FROM @ApplicationIDs AS App)) AND
			(@Archive IS NULL OR F.Deleted = @Archive)
	)
	
	INSERT INTO @OutputTable (ApplicationID, FileID, CreationDate, CreatorUserID, NodeID, NodeTypeID, 
		NodeName, NodeType, [FileName], Extension, Size, OwnerType, Deleted)
	(
		SELECT	F.ApplicationID,
				F.ID AS FileID, 
				F.CreationDate,
				F.CreatorUserID,
				ND.NodeID, 
				ND.NodeTypeID,
				ND.NodeName AS [Name],
				ND.TypeName AS NodeType,
				F.[FileName],
				F.Extension,
				F.Size,
				F.OwnerType,
				CAST((CASE WHEN ND.Deleted = 1 OR F.Deleted = 1 THEN 1 ELSE 0 END) AS bit) AS Deleted
		FROM Files AS F
			LEFT JOIN [dbo].[CN_View_Nodes_Normal] AS ND
			ON ND.ApplicationID = F.ApplicationID AND ND.NodeID = F.OwnerID AND 
				(@Archive IS NULL OR ND.Deleted = @Archive) AND
				(@NodesCount = 0 OR ND.NodeID IN (SELECT N.[Value] FROM @NodeIDs AS N))
		WHERE F.OwnerType = N'Node' OR F.OwnerType = N'WikiContent'

		UNION ALL

		SELECT	F.ApplicationID,
				F.ID AS FileID, 
				F.CreationDate,
				F.CreatorUserID,
				ND.NodeID,
				ND.NodeTypeID,
				ND.NodeName AS Name,
				ND.TypeName AS NodeType,
				F.[FileName],
				F.Extension,
				F.Size,
				F.OwnerType,
				CAST((CASE WHEN E.Deleted = 1 OR I.Deleted = 1 OR ND.Deleted = 1 OR F.Deleted = 1 THEN 1 ELSE 0 END) AS bit) AS Deleted
		FROM Files AS F
			INNER JOIN [dbo].[FG_InstanceElements] AS E
			ON E.ApplicationID = F.ApplicationID AND E.ElementID = F.OwnerID AND 
				E.[Type] = N'File' AND (@Archive IS NULL OR E.Deleted = @Archive)
			INNER JOIN [dbo].[FG_FormInstances] AS I
			ON I.ApplicationID = F.ApplicationID AND I.InstanceID = E.InstanceID AND 
				(@Archive IS NULL OR I.Deleted = @Archive)
			INNER JOIN [dbo].[CN_View_Nodes_Normal] AS ND
			ON ND.ApplicationID = F.ApplicationID AND ND.NodeID = I.OwnerID AND 
				(@Archive IS NULL OR ND.Deleted = @Archive) AND
				(@NodesCount = 0 OR ND.NodeID IN (SELECT N.[Value] FROM @NodeIDs AS N))
		WHERE F.OwnerType = N'FormElement'
	)
	
	RETURN
END

GO

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[QA_FN_GetParentCategoryHierarchy]') 
            AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
DROP FUNCTION [dbo].[QA_FN_GetParentCategoryHierarchy]
GO

CREATE FUNCTION [dbo].[QA_FN_GetParentCategoryHierarchy](
	@ApplicationID	uniqueidentifier,
	@CategoryID		uniqueidentifier
)	
RETURNS @OutputTable TABLE (
	CategoryID uniqueidentifier primary key clustered,
	ParentID uniqueidentifier,
	[Level] int,
	Name nvarchar(2000)
)
WITH ENCRYPTION
AS
BEGIN
	;WITH hierarchy (ID, ParentID, [Level], Name)
	AS
	(
		SELECT F.CategoryID AS ID, F.ParentID AS ParentID, 0 AS [Level], F.Name
		FROM [dbo].[QA_FAQCategories] AS F
		WHERE F.ApplicationID = @ApplicationID AND F.CategoryID = @CategoryID
		
		UNION ALL
		
		SELECT C.CategoryID AS ID, C.ParentID AS ParentID, [Level] + 1, C.Name
		FROM [dbo].[QA_FAQCategories] AS C
			INNER JOIN hierarchy AS HR
			ON C.CategoryID = HR.ParentID
		WHERE C.ApplicationID = @ApplicationID AND 
			C.CategoryID <> HR.ID AND C.Deleted = 0
	)
	INSERT INTO @OutputTable(CategoryID, ParentID, [Level], Name)
	SELECT * 
	FROM hierarchy AS H
	ORDER BY H.[Level] ASC
	
	RETURN
END

GO



IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[QA_FN_GetChildCategoriesHierarchy]') 
            AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
DROP FUNCTION [dbo].[QA_FN_GetChildCategoriesHierarchy]
GO

CREATE FUNCTION [dbo].[QA_FN_GetChildCategoriesHierarchy](
	@ApplicationID	uniqueidentifier,
	@CategoryIDs	GuidTableType readonly
)	
RETURNS @OutputTable TABLE (
	CategoryID uniqueidentifier primary key clustered,
	ParentID uniqueidentifier,
	[Level] int,
	Name nvarchar(2000)
)
WITH ENCRYPTION
AS
BEGIN
	INSERT INTO @OutputTable(CategoryID, ParentID, [Level], Name)
	SELECT C.CategoryID AS ID, C.ParentID AS ParentID, 0 AS [Level], C.Name AS Name
	FROM @CategoryIDs AS N
		INNER JOIN [dbo].[QA_FAQCategories] AS C
		ON C.ApplicationID = @ApplicationID AND C.CategoryID = N.Value
	
	INSERT INTO @OutputTable(CategoryID, ParentID, [Level], Name)
	SELECT C.CategoryID AS ID, C.ParentID, 
		[Level] + 1, C.Name AS Name
	FROM [dbo].[QA_FAQCategories] AS C
		INNER JOIN @OutputTable AS HR
		ON C.ParentID = HR.CategoryID
	WHERE C.ApplicationID = @ApplicationID AND C.CategoryID <> HR.CategoryID AND C.Deleted = 0
	
	RETURN
END

GO


IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[QA_FN_GetQuestionContent]') 
    AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
DROP FUNCTION [dbo].[QA_FN_GetQuestionContent]
GO

CREATE FUNCTION [dbo].[QA_FN_GetQuestionContent](
	@ApplicationID	uniqueidentifier,
	@QuestionID		uniqueidentifier
)
RETURNS nvarchar(max)
WITH ENCRYPTION
AS
BEGIN
	DECLARE @Ret nvarchar(max) = NULL

	;WITH Partitioned AS
	(
		SELECT	AN.AnswerID,
				CAST(SUBSTRING(ISNULL(AN.AnswerBody, N''), 1, 4000) AS nvarchar(4000)) AS Content,
				ROW_NUMBER() OVER (PARTITION BY AN.QuestionID ORDER BY AN.AnswerID) AS Number,
				COUNT(*) OVER (PARTITION BY AN.QuestionID) AS [Count]
		FROM [dbo].[QA_Answers] AS AN
		WHERE AN.ApplicationID = @ApplicationID AND
			AN.QuestionID = @QuestionID AND AN.Deleted = 0
	),
	Fetched AS
	(
		SELECT P.AnswerID, P.Content AS FullContent, P.Content, P.Number, P.[Count] 
		FROM Partitioned AS P
		WHERE P.Number = 1

		UNION ALL

		SELECT	P.AnswerID, C.FullContent + ' ' + P.Content, P.Content, P.Number, P.[Count]
		FROM Partitioned AS P
			INNER JOIN Fetched AS C 
			ON P.AnswerID = C.AnswerID AND P.Number = C.Number + 1
		WHERE P.Number <= 95
	)
	SELECT TOP(1) @Ret = F.FullContent
	FROM Fetched AS F
	WHERE F.Number = (CASE WHEN F.[Count] > 90 THEN 90 ELSE F.[Count] END)
	
	RETURN @Ret
END

GO


SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[KW_FN_GetWFVersionID]') 
            AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
DROP FUNCTION [dbo].[KW_FN_GetWFVersionID]
GO

CREATE FUNCTION [dbo].[KW_FN_GetWFVersionID](
	@ApplicationID	uniqueidentifier,
	@KnowledgeID	uniqueidentifier
)	
RETURNS int
WITH ENCRYPTION
AS
BEGIN
	RETURN ISNULL((
		SELECT TOP(1) MAX(H.WFVersionID)
		FROM [dbo].[KW_History] AS H
		WHERE H.ApplicationID = @ApplicationID AND H.KnowledgeID = @KnowledgeID
	), 1)
END

GO




/****** Object:  StoredProcedure [dbo].[aspnet_Membership_ChangePasswordQuestionAndAnswer]    Script Date: 06/28/2012 15:18:34 ******/
SET ANSI_NULLS ON
GO

/*SET QUOTED_IDENTIFIER OFF
GO*/

SET QUOTED_IDENTIFIER ON /* This was originally off */
GO


/*     Drop old procedures     */
IF OBJECT_ID ('dbo.aspnet_Applications_CreateApplication', 'procedure') IS NOT NULL
DROP PROCEDURE [dbo].[aspnet_Applications_CreateApplication]
GO

IF OBJECT_ID ('dbo.aspnet_CheckSchemaVersion', 'procedure') IS NOT NULL
DROP PROCEDURE [dbo].[aspnet_CheckSchemaVersion]
GO

IF OBJECT_ID ('dbo.aspnet_Users_CreateUser', 'procedure') IS NOT NULL
DROP PROCEDURE [dbo].[aspnet_Users_CreateUser]
GO

IF OBJECT_ID ('dbo.aspnet_Users_DeleteUser', 'procedure') IS NOT NULL
DROP PROCEDURE [dbo].[aspnet_Users_DeleteUser]
GO

IF OBJECT_ID ('dbo.aspnet_UsersInRoles_AddUsersToRoles', 'procedure') IS NOT NULL
DROP PROCEDURE [dbo].[aspnet_UsersInRoles_AddUsersToRoles]
GO

IF OBJECT_ID ('dbo.aspnet_UsersInRoles_FindUsersInRole', 'procedure') IS NOT NULL
DROP PROCEDURE [dbo].[aspnet_UsersInRoles_FindUsersInRole]
GO

IF OBJECT_ID ('dbo.aspnet_UsersInRoles_GetRolesForUser', 'procedure') IS NOT NULL
DROP PROCEDURE [dbo].[aspnet_UsersInRoles_GetRolesForUser]
GO

IF OBJECT_ID ('dbo.aspnet_UsersInRoles_GetUsersInRoles', 'procedure') IS NOT NULL
DROP PROCEDURE [dbo].[aspnet_UsersInRoles_GetUsersInRoles]
GO

IF OBJECT_ID ('dbo.aspnet_UsersInRoles_IsUserInRole', 'procedure') IS NOT NULL
DROP PROCEDURE [dbo].[aspnet_UsersInRoles_IsUserInRole]
GO

IF OBJECT_ID ('dbo.aspnet_UsersInRoles_RemoveUsersFromRoles', 'procedure') IS NOT NULL
DROP PROCEDURE [dbo].[aspnet_UsersInRoles_RemoveUsersFromRoles]
GO

IF OBJECT_ID ('dbo.aspnet_WebEvent_LogEvent', 'procedure') IS NOT NULL
DROP PROCEDURE [dbo].[aspnet_WebEvent_LogEvent]
GO

IF OBJECT_ID ('dbo.aspnet_Membership_ChangePasswordQuestionAndAnswer', 'procedure') IS NOT NULL
DROP PROCEDURE [dbo].[aspnet_Membership_ChangePasswordQuestionAndAnswer]
GO

IF OBJECT_ID ('dbo.aspnet_Membership_CreateUser', 'procedure') IS NOT NULL
DROP PROCEDURE [dbo].[aspnet_Membership_CreateUser]
GO

IF OBJECT_ID ('dbo.aspnet_Membership_FindUsersByEmail', 'procedure') IS NOT NULL
DROP PROCEDURE [dbo].[aspnet_Membership_FindUsersByEmail]
GO

IF OBJECT_ID ('dbo.aspnet_Membership_FindUsersByName', 'procedure') IS NOT NULL
DROP PROCEDURE [dbo].[aspnet_Membership_FindUsersByName]
GO

IF OBJECT_ID ('dbo.aspnet_Membership_GetAllUsers', 'procedure') IS NOT NULL
DROP PROCEDURE [dbo].[aspnet_Membership_GetAllUsers]
GO

IF OBJECT_ID ('dbo.aspnet_Membership_GetNumberOfUsersOnline', 'procedure') IS NOT NULL
DROP PROCEDURE [dbo].[aspnet_Membership_GetNumberOfUsersOnline]
GO

IF OBJECT_ID ('dbo.aspnet_Membership_GetPassword', 'procedure') IS NOT NULL
DROP PROCEDURE [dbo].[aspnet_Membership_GetPassword]
GO

IF OBJECT_ID ('dbo.aspnet_Membership_GetPasswordWithFormat', 'procedure') IS NOT NULL
DROP PROCEDURE [dbo].[aspnet_Membership_GetPasswordWithFormat]
GO

IF OBJECT_ID ('dbo.aspnet_Membership_GetUserByEmail', 'procedure') IS NOT NULL
DROP PROCEDURE [dbo].[aspnet_Membership_GetUserByEmail]
GO

IF OBJECT_ID ('dbo.aspnet_Membership_GetUserByName', 'procedure') IS NOT NULL
DROP PROCEDURE [dbo].[aspnet_Membership_GetUserByName]
GO

IF OBJECT_ID ('dbo.aspnet_Membership_GetUserByUserId', 'procedure') IS NOT NULL
DROP PROCEDURE [dbo].[aspnet_Membership_GetUserByUserId]
GO

IF OBJECT_ID ('dbo.aspnet_Membership_ResetPassword', 'procedure') IS NOT NULL
DROP PROCEDURE [dbo].[aspnet_Membership_ResetPassword]
GO

IF OBJECT_ID ('dbo.aspnet_Membership_SetPassword', 'procedure') IS NOT NULL
DROP PROCEDURE [dbo].[aspnet_Membership_SetPassword]
GO

IF OBJECT_ID ('dbo.aspnet_Membership_UnlockUser', 'procedure') IS NOT NULL
DROP PROCEDURE [dbo].[aspnet_Membership_UnlockUser]
GO

IF OBJECT_ID ('dbo.aspnet_Membership_UpdateUser', 'procedure') IS NOT NULL
DROP PROCEDURE [dbo].[aspnet_Membership_UpdateUser]
GO

IF OBJECT_ID ('dbo.aspnet_Membership_UpdateUserInfo', 'procedure') IS NOT NULL
DROP PROCEDURE [dbo].[aspnet_Membership_UpdateUserInfo]
GO
/*     end of Drop old procedures     */


/*     Create new membership procedures     */
CREATE PROCEDURE [dbo].[aspnet_Applications_CreateApplication]
    @ApplicationName      nvarchar(256),
    @ApplicationId        uniqueidentifier OUTPUT
AS
BEGIN
    SELECT  @ApplicationId = ApplicationId FROM dbo.aspnet_Applications WHERE LOWER(@ApplicationName) = LoweredApplicationName

    IF(@ApplicationId IS NULL)
    BEGIN
        DECLARE @TranStarted   bit
        SET @TranStarted = 0

        IF( @@TRANCOUNT = 0 )
        BEGIN
	        BEGIN TRANSACTION
	        SET @TranStarted = 1
        END
        ELSE
    	    SET @TranStarted = 0

        SELECT  @ApplicationId = ApplicationId
        FROM dbo.aspnet_Applications WITH (UPDLOCK, HOLDLOCK)
        WHERE LOWER(@ApplicationName) = LoweredApplicationName

        IF(@ApplicationId IS NULL)
        BEGIN
            SELECT  @ApplicationId = NEWID()
            INSERT  dbo.aspnet_Applications (ApplicationId, ApplicationName, LoweredApplicationName)
            VALUES  (@ApplicationId, @ApplicationName, LOWER(@ApplicationName))
        END


        IF( @TranStarted = 1 )
        BEGIN
            IF(@@ERROR = 0)
            BEGIN
	        SET @TranStarted = 0
	        COMMIT TRANSACTION
            END
            ELSE
            BEGIN
                SET @TranStarted = 0
                ROLLBACK TRANSACTION
            END
        END
    END
END

GO


CREATE PROCEDURE [dbo].[aspnet_CheckSchemaVersion]
    @Feature                   nvarchar(128),
    @CompatibleSchemaVersion   nvarchar(128)
AS
BEGIN
    IF (EXISTS( SELECT  *
                FROM    dbo.aspnet_SchemaVersions
                WHERE   Feature = LOWER( @Feature ) AND
                        CompatibleSchemaVersion = @CompatibleSchemaVersion ))
        RETURN 0

    RETURN 1
END

GO


CREATE PROCEDURE [dbo].[aspnet_Users_CreateUser]
    @ApplicationId    uniqueidentifier,
    @UserName         nvarchar(256),
    @IsUserAnonymous  bit,
    @LastActivityDate DATETIME,
    @UserId           uniqueidentifier OUTPUT
AS
BEGIN
    IF( @UserId IS NULL )
        SELECT @UserId = NEWID()
    ELSE
    BEGIN
        IF( EXISTS( SELECT UserId FROM dbo.aspnet_Users
                    WHERE @UserId = UserId ) )
            RETURN -1
    END

    INSERT dbo.aspnet_Users (UserId, UserName, LoweredUserName, IsAnonymous, LastActivityDate)
    VALUES (@UserId, @UserName, LOWER(@UserName), @IsUserAnonymous, @LastActivityDate)

    RETURN 0
END

GO


CREATE PROCEDURE [dbo].[aspnet_Users_DeleteUser]
    @ApplicationName  nvarchar(256),
    @UserName         nvarchar(256),
    @TablesToDeleteFrom int,
    @NumTablesDeletedFrom int OUTPUT
AS
BEGIN
    DECLARE @UserId               uniqueidentifier
    SELECT  @UserId               = NULL
    SELECT  @NumTablesDeletedFrom = 0

    DECLARE @TranStarted   bit
    SET @TranStarted = 0

    IF( @@TRANCOUNT = 0 )
    BEGIN
	    BEGIN TRANSACTION
	    SET @TranStarted = 1
    END
    ELSE
	SET @TranStarted = 0

    DECLARE @ErrorCode   int
    DECLARE @RowCount    int

    SET @ErrorCode = 0
    SET @RowCount  = 0

    SELECT  @UserId = u.UserId
    FROM    dbo.aspnet_Users u, dbo.aspnet_Applications a, dbo.USR_UserApplications app
    WHERE   u.LoweredUserName       = LOWER(@UserName)
        AND LOWER(@ApplicationName) = a.LoweredApplicationName
        AND app.UserID				= u.UserId
        AND app.ApplicationID		= a.ApplicationId

    IF (@UserId IS NULL)
    BEGIN
        GOTO Cleanup
    END

    -- Delete from Membership table if (@TablesToDeleteFrom & 1) is set
    IF ((@TablesToDeleteFrom & 1) <> 0 AND
        (EXISTS (SELECT name FROM sysobjects WHERE (name = N'vw_aspnet_MembershipUsers') AND (type = 'V'))))
    BEGIN
        DELETE FROM dbo.aspnet_Membership WHERE @UserId = UserId

        SELECT @ErrorCode = @@ERROR,
               @RowCount = @@ROWCOUNT

        IF( @ErrorCode <> 0 )
            GOTO Cleanup

        IF (@RowCount <> 0)
            SELECT  @NumTablesDeletedFrom = @NumTablesDeletedFrom + 1
    END

    -- Delete from aspnet_UsersInRoles table if (@TablesToDeleteFrom & 2) is set
    IF ((@TablesToDeleteFrom & 2) <> 0  AND
        (EXISTS (SELECT name FROM sysobjects WHERE (name = N'vw_aspnet_UsersInRoles') AND (type = 'V'))) )
    BEGIN
        DELETE FROM dbo.aspnet_UsersInRoles WHERE @UserId = UserId

        SELECT @ErrorCode = @@ERROR,
                @RowCount = @@ROWCOUNT

        IF( @ErrorCode <> 0 )
            GOTO Cleanup

        IF (@RowCount <> 0)
            SELECT  @NumTablesDeletedFrom = @NumTablesDeletedFrom + 1
    END

    -- Delete from aspnet_Profile table if (@TablesToDeleteFrom & 4) is set
    IF ((@TablesToDeleteFrom & 4) <> 0  AND
        (EXISTS (SELECT name FROM sysobjects WHERE (name = N'vw_aspnet_Profiles') AND (type = 'V'))) )
    BEGIN
        DELETE FROM dbo.aspnet_Profile WHERE @UserId = UserId

        SELECT @ErrorCode = @@ERROR,
                @RowCount = @@ROWCOUNT

        IF( @ErrorCode <> 0 )
            GOTO Cleanup

        IF (@RowCount <> 0)
            SELECT  @NumTablesDeletedFrom = @NumTablesDeletedFrom + 1
    END

    -- Delete from aspnet_PersonalizationPerUser table if (@TablesToDeleteFrom & 8) is set
    IF ((@TablesToDeleteFrom & 8) <> 0  AND
        (EXISTS (SELECT name FROM sysobjects WHERE (name = N'vw_aspnet_WebPartState_User') AND (type = 'V'))) )
    BEGIN
        DELETE FROM dbo.aspnet_PersonalizationPerUser WHERE @UserId = UserId

        SELECT @ErrorCode = @@ERROR,
                @RowCount = @@ROWCOUNT

        IF( @ErrorCode <> 0 )
            GOTO Cleanup

        IF (@RowCount <> 0)
            SELECT  @NumTablesDeletedFrom = @NumTablesDeletedFrom + 1
    END

    -- Delete from aspnet_Users table if (@TablesToDeleteFrom & 1,2,4 & 8) are all set
    IF ((@TablesToDeleteFrom & 1) <> 0 AND
        (@TablesToDeleteFrom & 2) <> 0 AND
        (@TablesToDeleteFrom & 4) <> 0 AND
        (@TablesToDeleteFrom & 8) <> 0 AND
        (EXISTS (SELECT UserId FROM dbo.aspnet_Users WHERE @UserId = UserId)))
    BEGIN
        DELETE FROM dbo.aspnet_Users WHERE @UserId = UserId

        SELECT @ErrorCode = @@ERROR,
                @RowCount = @@ROWCOUNT

        IF( @ErrorCode <> 0 )
            GOTO Cleanup

        IF (@RowCount <> 0)
            SELECT  @NumTablesDeletedFrom = @NumTablesDeletedFrom + 1
    END

    IF( @TranStarted = 1 )
    BEGIN
	    SET @TranStarted = 0
	    COMMIT TRANSACTION
    END

    RETURN 0

Cleanup:
    SET @NumTablesDeletedFrom = 0

    IF( @TranStarted = 1 )
    BEGIN
        SET @TranStarted = 0
	    ROLLBACK TRANSACTION
    END

    RETURN @ErrorCode

END

GO


CREATE PROCEDURE [dbo].[aspnet_UsersInRoles_AddUsersToRoles]
	@ApplicationName  nvarchar(256),
	@UserNames		  nvarchar(4000),
	@RoleNames		  nvarchar(4000),
	@CurrentTimeUtc   datetime
AS
BEGIN
	DECLARE @AppId uniqueidentifier
	SELECT  @AppId = NULL
	SELECT  @AppId = ApplicationId FROM aspnet_Applications WHERE LOWER(@ApplicationName) = LoweredApplicationName
	IF (@AppId IS NULL)
		RETURN(2)
	DECLARE @TranStarted   bit
	SET @TranStarted = 0

	IF( @@TRANCOUNT = 0 )
	BEGIN
		BEGIN TRANSACTION
		SET @TranStarted = 1
	END

	DECLARE @tbNames	table(Name nvarchar(256) NOT NULL PRIMARY KEY)
	DECLARE @tbRoles	table(RoleId uniqueidentifier NOT NULL PRIMARY KEY)
	DECLARE @tbUsers	table(UserId uniqueidentifier NOT NULL PRIMARY KEY)
	DECLARE @Num		int
	DECLARE @Pos		int
	DECLARE @NextPos	int
	DECLARE @Name		nvarchar(256)

	SET @Num = 0
	SET @Pos = 1
	WHILE(@Pos <= LEN(@RoleNames))
	BEGIN
		SELECT @NextPos = CHARINDEX(N',', @RoleNames,  @Pos)
		IF (@NextPos = 0 OR @NextPos IS NULL)
			SELECT @NextPos = LEN(@RoleNames) + 1
		SELECT @Name = RTRIM(LTRIM(SUBSTRING(@RoleNames, @Pos, @NextPos - @Pos)))
		SELECT @Pos = @NextPos+1

		INSERT INTO @tbNames VALUES (@Name)
		SET @Num = @Num + 1
	END

	INSERT INTO @tbRoles
	  SELECT RoleId
	  FROM   dbo.aspnet_Roles ar, @tbNames t
	  WHERE  LOWER(t.Name) = ar.LoweredRoleName AND ar.ApplicationId = @AppId

	IF (@@ROWCOUNT <> @Num)
	BEGIN
		SELECT TOP 1 Name
		FROM   @tbNames
		WHERE  LOWER(Name) NOT IN (SELECT ar.LoweredRoleName FROM dbo.aspnet_Roles ar,  @tbRoles r WHERE r.RoleId = ar.RoleId)
		IF( @TranStarted = 1 )
			ROLLBACK TRANSACTION
		RETURN(2)
	END

	DELETE FROM @tbNames WHERE 1=1
	SET @Num = 0
	SET @Pos = 1

	WHILE(@Pos <= LEN(@UserNames))
	BEGIN
		SELECT @NextPos = CHARINDEX(N',', @UserNames,  @Pos)
		IF (@NextPos = 0 OR @NextPos IS NULL)
			SELECT @NextPos = LEN(@UserNames) + 1
		SELECT @Name = RTRIM(LTRIM(SUBSTRING(@UserNames, @Pos, @NextPos - @Pos)))
		SELECT @Pos = @NextPos+1

		INSERT INTO @tbNames VALUES (@Name)
		SET @Num = @Num + 1
	END

	INSERT INTO @tbUsers
	  SELECT ar.UserId
	  FROM   dbo.aspnet_Users ar, @tbNames t, dbo.USR_UserApplications app
	  WHERE  LOWER(t.Name) = ar.LoweredUserName AND 
		app.UserID = ar.UserId AND app.ApplicationId = @AppId

	IF (@@ROWCOUNT <> @Num)
	BEGIN
		DELETE FROM @tbNames
		WHERE LOWER(Name) IN (SELECT LoweredUserName FROM dbo.aspnet_Users au,  @tbUsers u WHERE au.UserId = u.UserId)

		INSERT dbo.aspnet_Users (UserId, UserName, LoweredUserName, IsAnonymous, LastActivityDate)
		  SELECT NEWID(), Name, LOWER(Name), 0, @CurrentTimeUtc
		  FROM   @tbNames

		INSERT INTO @tbUsers
		  SELECT  au.UserId
		  FROM	dbo.aspnet_Users au, @tbNames t, dbo.USR_UserApplications app
		  WHERE   LOWER(t.Name) = au.LoweredUserName AND 
			app.UserID = au.UserId AND app.ApplicationId = @AppId
	END

	IF (EXISTS (SELECT * FROM dbo.aspnet_UsersInRoles ur, @tbUsers tu, @tbRoles tr WHERE tu.UserId = ur.UserId AND tr.RoleId = ur.RoleId))
	BEGIN
		SELECT TOP 1 UserName, RoleName
		FROM		 dbo.aspnet_UsersInRoles ur, @tbUsers tu, @tbRoles tr, aspnet_Users u, aspnet_Roles r
		WHERE		u.UserId = tu.UserId AND r.RoleId = tr.RoleId AND tu.UserId = ur.UserId AND tr.RoleId = ur.RoleId

		IF( @TranStarted = 1 )
			ROLLBACK TRANSACTION
		RETURN(3)
	END

	INSERT INTO dbo.aspnet_UsersInRoles (UserId, RoleId)
	SELECT UserId, RoleId
	FROM @tbUsers, @tbRoles

	IF( @TranStarted = 1 )
		COMMIT TRANSACTION
	RETURN(0)
END

GO


CREATE PROCEDURE [dbo].[aspnet_UsersInRoles_FindUsersInRole]
    @ApplicationName  nvarchar(256),
    @RoleName         nvarchar(256),
    @UserNameToMatch  nvarchar(256)
AS
BEGIN
    DECLARE @ApplicationId uniqueidentifier
    SELECT  @ApplicationId = NULL
    SELECT  @ApplicationId = ApplicationId FROM aspnet_Applications WHERE LOWER(@ApplicationName) = LoweredApplicationName
    IF (@ApplicationId IS NULL)
        RETURN(1)
     DECLARE @RoleId uniqueidentifier
     SELECT  @RoleId = NULL

     SELECT  @RoleId = RoleId
     FROM    dbo.aspnet_Roles
     WHERE   LOWER(@RoleName) = LoweredRoleName AND ApplicationId = @ApplicationId

     IF (@RoleId IS NULL)
         RETURN(1)

    SELECT u.UserName
    FROM   dbo.aspnet_Users u, dbo.aspnet_UsersInRoles ur, dbo.USR_UserApplications app
    WHERE  u.UserId = ur.UserId AND @RoleId = ur.RoleId AND 
		LoweredUserName LIKE LOWER(@UserNameToMatch) AND
		app.UserID = u.UserId AND app.ApplicationId = @ApplicationId
    ORDER BY u.UserName
    RETURN(0)
END

GO


CREATE PROCEDURE [dbo].[aspnet_UsersInRoles_GetRolesForUser]
    @ApplicationName  nvarchar(256),
    @UserName         nvarchar(256)
AS
BEGIN
    DECLARE @ApplicationId uniqueidentifier
    SELECT  @ApplicationId = NULL
    SELECT  @ApplicationId = ApplicationId FROM aspnet_Applications WHERE LOWER(@ApplicationName) = LoweredApplicationName
    IF (@ApplicationId IS NULL)
        RETURN(1)
    DECLARE @UserId uniqueidentifier
    SELECT  @UserId = NULL

    SELECT  @UserId = U.UserId
    FROM    dbo.aspnet_Users AS U
		INNER JOIN [dbo].[USR_UserApplications] AS APP
		ON APP.ApplicationID = @ApplicationId AND APP.UserID = U.UserId
    WHERE   U.LoweredUserName = LOWER(@UserName)

    IF (@UserId IS NULL)
        RETURN(1)

    SELECT r.RoleName
    FROM   dbo.aspnet_Roles r, dbo.aspnet_UsersInRoles ur
    WHERE  r.RoleId = ur.RoleId AND r.ApplicationId = @ApplicationId AND ur.UserId = @UserId
    ORDER BY r.RoleName
    RETURN (0)
END

GO


CREATE PROCEDURE [dbo].[aspnet_UsersInRoles_GetUsersInRoles]
    @ApplicationName  nvarchar(256),
    @RoleName         nvarchar(256)
AS
BEGIN
    DECLARE @ApplicationId uniqueidentifier
    SELECT  @ApplicationId = NULL
    SELECT  @ApplicationId = ApplicationId FROM aspnet_Applications WHERE LOWER(@ApplicationName) = LoweredApplicationName
    IF (@ApplicationId IS NULL)
        RETURN(1)
     DECLARE @RoleId uniqueidentifier
     SELECT  @RoleId = NULL

     SELECT  @RoleId = RoleId
     FROM    dbo.aspnet_Roles
     WHERE   LOWER(@RoleName) = LoweredRoleName AND ApplicationId = @ApplicationId

     IF (@RoleId IS NULL)
         RETURN(1)

    SELECT u.UserName
    FROM   dbo.aspnet_Users u, dbo.aspnet_UsersInRoles ur, dbo.USR_UserApplications app
    WHERE  u.UserId = ur.UserId AND @RoleId = ur.RoleId AND 
		app.UserID = u.UserId AND app.ApplicationId = @ApplicationId
    ORDER BY u.UserName
    RETURN(0)
END

GO


CREATE PROCEDURE [dbo].[aspnet_UsersInRoles_IsUserInRole]
    @ApplicationName  nvarchar(256),
    @UserName         nvarchar(256),
    @RoleName         nvarchar(256)
AS
BEGIN
    DECLARE @ApplicationId uniqueidentifier
    SELECT  @ApplicationId = NULL
    SELECT  @ApplicationId = ApplicationId FROM aspnet_Applications WHERE LOWER(@ApplicationName) = LoweredApplicationName
    IF (@ApplicationId IS NULL)
        RETURN(2)
    DECLARE @UserId uniqueidentifier
    SELECT  @UserId = NULL
    DECLARE @RoleId uniqueidentifier
    SELECT  @RoleId = NULL

    SELECT  @UserId = U.UserId
    FROM    dbo.aspnet_Users AS U
		INNER JOIN [dbo].[USR_UserApplications] AS APP
		ON APP.ApplicationID = @ApplicationId AND APP.UserID = U.UserId
    WHERE   U.LoweredUserName = LOWER(@UserName)

    IF (@UserId IS NULL)
        RETURN(2)

    SELECT  @RoleId = RoleId
    FROM    dbo.aspnet_Roles
    WHERE   LoweredRoleName = LOWER(@RoleName) AND ApplicationId = @ApplicationId

    IF (@RoleId IS NULL)
        RETURN(3)

    IF (EXISTS( SELECT * FROM dbo.aspnet_UsersInRoles WHERE  UserId = @UserId AND RoleId = @RoleId))
        RETURN(1)
    ELSE
        RETURN(0)
END

GO


CREATE PROCEDURE [dbo].[aspnet_UsersInRoles_RemoveUsersFromRoles]
	@ApplicationName  nvarchar(256),
	@UserNames		  nvarchar(4000),
	@RoleNames		  nvarchar(4000)
AS
BEGIN
	DECLARE @AppId uniqueidentifier
	SELECT  @AppId = NULL
	SELECT  @AppId = ApplicationId FROM aspnet_Applications WHERE LOWER(@ApplicationName) = LoweredApplicationName
	IF (@AppId IS NULL)
		RETURN(2)


	DECLARE @TranStarted   bit
	SET @TranStarted = 0

	IF( @@TRANCOUNT = 0 )
	BEGIN
		BEGIN TRANSACTION
		SET @TranStarted = 1
	END

	DECLARE @tbNames  table(Name nvarchar(256) NOT NULL PRIMARY KEY)
	DECLARE @tbRoles  table(RoleId uniqueidentifier NOT NULL PRIMARY KEY)
	DECLARE @tbUsers  table(UserId uniqueidentifier NOT NULL PRIMARY KEY)
	DECLARE @Num	  int
	DECLARE @Pos	  int
	DECLARE @NextPos  int
	DECLARE @Name	  nvarchar(256)
	DECLARE @CountAll int
	DECLARE @CountU	  int
	DECLARE @CountR	  int


	SET @Num = 0
	SET @Pos = 1
	WHILE(@Pos <= LEN(@RoleNames))
	BEGIN
		SELECT @NextPos = CHARINDEX(N',', @RoleNames,  @Pos)
		IF (@NextPos = 0 OR @NextPos IS NULL)
			SELECT @NextPos = LEN(@RoleNames) + 1
		SELECT @Name = RTRIM(LTRIM(SUBSTRING(@RoleNames, @Pos, @NextPos - @Pos)))
		SELECT @Pos = @NextPos+1

		INSERT INTO @tbNames VALUES (@Name)
		SET @Num = @Num + 1
	END

	INSERT INTO @tbRoles
	  SELECT RoleId
	  FROM   dbo.aspnet_Roles ar, @tbNames t
	  WHERE  LOWER(t.Name) = ar.LoweredRoleName AND ar.ApplicationId = @AppId
	SELECT @CountR = @@ROWCOUNT

	IF (@CountR <> @Num)
	BEGIN
		SELECT TOP 1 N'', Name
		FROM   @tbNames
		WHERE  LOWER(Name) NOT IN (SELECT ar.LoweredRoleName FROM dbo.aspnet_Roles ar,  @tbRoles r WHERE r.RoleId = ar.RoleId)
		IF( @TranStarted = 1 )
			ROLLBACK TRANSACTION
		RETURN(2)
	END


	DELETE FROM @tbNames WHERE 1=1
	SET @Num = 0
	SET @Pos = 1


	WHILE(@Pos <= LEN(@UserNames))
	BEGIN
		SELECT @NextPos = CHARINDEX(N',', @UserNames,  @Pos)
		IF (@NextPos = 0 OR @NextPos IS NULL)
			SELECT @NextPos = LEN(@UserNames) + 1
		SELECT @Name = RTRIM(LTRIM(SUBSTRING(@UserNames, @Pos, @NextPos - @Pos)))
		SELECT @Pos = @NextPos+1

		INSERT INTO @tbNames VALUES (@Name)
		SET @Num = @Num + 1
	END

	INSERT INTO @tbUsers
	  SELECT ar.UserId
	  FROM   dbo.aspnet_Users ar, @tbNames t, dbo.USR_UserApplications app
	  WHERE  LOWER(t.Name) = ar.LoweredUserName AND 
		app.UserID = ar.UserId AND app.ApplicationId = @AppId

	SELECT @CountU = @@ROWCOUNT
	IF (@CountU <> @Num)
	BEGIN
		SELECT TOP 1 Name, N''
		FROM   @tbNames
		WHERE  LOWER(Name) NOT IN (SELECT au.LoweredUserName FROM dbo.aspnet_Users au,  @tbUsers u WHERE u.UserId = au.UserId)

		IF( @TranStarted = 1 )
			ROLLBACK TRANSACTION
		RETURN(1)
	END

	SELECT  @CountAll = COUNT(*)
	FROM	dbo.aspnet_UsersInRoles ur, @tbUsers u, @tbRoles r
	WHERE   ur.UserId = u.UserId AND ur.RoleId = r.RoleId

	IF (@CountAll <> @CountU * @CountR)
	BEGIN
		SELECT TOP 1 UserName, RoleName
		FROM		 @tbUsers tu, @tbRoles tr, dbo.aspnet_Users u, dbo.aspnet_Roles r
		WHERE		 u.UserId = tu.UserId AND r.RoleId = tr.RoleId AND
					 tu.UserId NOT IN (SELECT ur.UserId FROM dbo.aspnet_UsersInRoles ur WHERE ur.RoleId = tr.RoleId) AND
					 tr.RoleId NOT IN (SELECT ur.RoleId FROM dbo.aspnet_UsersInRoles ur WHERE ur.UserId = tu.UserId)
		IF( @TranStarted = 1 )
			ROLLBACK TRANSACTION
		RETURN(3)
	END

	DELETE FROM dbo.aspnet_UsersInRoles
	WHERE UserId IN (SELECT UserId FROM @tbUsers)
	  AND RoleId IN (SELECT RoleId FROM @tbRoles)
	IF( @TranStarted = 1 )
		COMMIT TRANSACTION
	RETURN(0)
END

GO


CREATE PROCEDURE [dbo].[aspnet_WebEvent_LogEvent]
        @EventId         char(32),
        @EventTimeUtc    datetime,
        @EventTime       datetime,
        @EventType       nvarchar(256),
        @EventSequence   decimal(19,0),
        @EventOccurrence decimal(19,0),
        @EventCode       int,
        @EventDetailCode int,
        @Message         nvarchar(1024),
        @ApplicationPath nvarchar(256),
        @ApplicationVirtualPath nvarchar(256),
        @MachineName    nvarchar(256),
        @RequestUrl      nvarchar(1024),
        @ExceptionType   nvarchar(256),
        @Details         ntext
AS
BEGIN
    INSERT
        dbo.aspnet_WebEvent_Events
        (
            EventId,
            EventTimeUtc,
            EventTime,
            EventType,
            EventSequence,
            EventOccurrence,
            EventCode,
            EventDetailCode,
            Message,
            ApplicationPath,
            ApplicationVirtualPath,
            MachineName,
            RequestUrl,
            ExceptionType,
            Details
        )
    VALUES
    (
        @EventId,
        @EventTimeUtc,
        @EventTime,
        @EventType,
        @EventSequence,
        @EventOccurrence,
        @EventCode,
        @EventDetailCode,
        @Message,
        @ApplicationPath,
        @ApplicationVirtualPath,
        @MachineName,
        @RequestUrl,
        @ExceptionType,
        @Details
    )
END

GO


CREATE PROCEDURE [dbo].[aspnet_Membership_ChangePasswordQuestionAndAnswer]
    @ApplicationName       nvarchar(256),
    @UserName              nvarchar(256),
    @NewPasswordQuestion   nvarchar(256),
    @NewPasswordAnswer     nvarchar(128)
AS
BEGIN
    DECLARE @UserId uniqueidentifier
    SELECT  @UserId = NULL
    SELECT  @UserId = u.UserId
    FROM    dbo.aspnet_Membership m, dbo.aspnet_Users u, dbo.aspnet_Applications a, dbo.USR_UserApplications app
    WHERE   LoweredUserName = LOWER(@UserName) AND
            LOWER(@ApplicationName) = a.LoweredApplicationName AND
            u.UserId = m.UserId AND
            app.ApplicationId = a.ApplicationId
    IF (@UserId IS NULL)
    BEGIN
        RETURN(1)
    END

    UPDATE dbo.aspnet_Membership
    SET    PasswordQuestion = @NewPasswordQuestion, PasswordAnswer = @NewPasswordAnswer
    WHERE  UserId=@UserId
    RETURN(0)
END
GO


CREATE PROCEDURE [dbo].[aspnet_Membership_CreateUser]
    @ApplicationName                        nvarchar(256),
    @UserName                               nvarchar(256),
    @Password                               nvarchar(128),
    @PasswordSalt                           nvarchar(128),
    @Email                                  nvarchar(256),
    @PasswordQuestion                       nvarchar(256),
    @PasswordAnswer                         nvarchar(128),
    @IsApproved                             bit,
    @CurrentTimeUtc                         datetime,
    @CreateDate                             datetime = NULL,
    @UniqueEmail                            int      = 0,
    @PasswordFormat                         int      = 0,
    @UserId                                 uniqueidentifier OUTPUT
AS
BEGIN
    DECLARE @ApplicationId uniqueidentifier
    SELECT  @ApplicationId = NULL

    DECLARE @NewUserId uniqueidentifier
    SELECT @NewUserId = NULL

    DECLARE @IsLockedOut bit
    SET @IsLockedOut = 0

    DECLARE @LastLockoutDate  datetime
    SET @LastLockoutDate = CONVERT( datetime, '17540101', 112 )

    DECLARE @FailedPasswordAttemptCount int
    SET @FailedPasswordAttemptCount = 0

    DECLARE @FailedPasswordAttemptWindowStart  datetime
    SET @FailedPasswordAttemptWindowStart = CONVERT( datetime, '17540101', 112 )

    DECLARE @FailedPasswordAnswerAttemptCount int
    SET @FailedPasswordAnswerAttemptCount = 0

    DECLARE @FailedPasswordAnswerAttemptWindowStart  datetime
    SET @FailedPasswordAnswerAttemptWindowStart = CONVERT( datetime, '17540101', 112 )

    DECLARE @NewUserCreated bit
    DECLARE @ReturnValue   int
    SET @ReturnValue = 0

    DECLARE @ErrorCode     int
    SET @ErrorCode = 0

    DECLARE @TranStarted   bit
    SET @TranStarted = 0

    IF( @@TRANCOUNT = 0 )
    BEGIN
	    BEGIN TRANSACTION
	    SET @TranStarted = 1
    END
    ELSE
    	SET @TranStarted = 0

    EXEC dbo.aspnet_Applications_CreateApplication @ApplicationName, @ApplicationId OUTPUT

    IF( @@ERROR <> 0 )
    BEGIN
        SET @ErrorCode = -1
        GOTO Cleanup
    END

    SET @CreateDate = @CurrentTimeUtc

    SELECT  @NewUserId = U.UserId 
    FROM dbo.aspnet_Users AS U 
		INNER JOIN [dbo].[USR_UserApplications] AS APP
		ON APP.ApplicationID = @ApplicationId AND APP.UserID = U.UserId
    WHERE LOWER(@UserName) = U.LoweredUserName
    
    IF ( @NewUserId IS NULL )
    BEGIN
        SET @NewUserId = @UserId
        EXEC @ReturnValue = dbo.aspnet_Users_CreateUser @ApplicationId, @UserName, 0, @CreateDate, @NewUserId OUTPUT
        SET @NewUserCreated = 1
    END
    ELSE
    BEGIN
        SET @NewUserCreated = 0
        IF( @NewUserId <> @UserId AND @UserId IS NOT NULL )
        BEGIN
            SET @ErrorCode = 6
            GOTO Cleanup
        END
    END

    IF( @@ERROR <> 0 )
    BEGIN
        SET @ErrorCode = -1
        GOTO Cleanup
    END

    IF( @ReturnValue = -1 )
    BEGIN
        SET @ErrorCode = 10
        GOTO Cleanup
    END

    IF ( EXISTS ( SELECT UserId
                  FROM   dbo.aspnet_Membership
                  WHERE  @NewUserId = UserId ) )
    BEGIN
        SET @ErrorCode = 6
        GOTO Cleanup
    END

    SET @UserId = @NewUserId

    IF (@UniqueEmail = 1)
    BEGIN
        IF (EXISTS (SELECT *
                    FROM  dbo.aspnet_Membership m WITH ( UPDLOCK, HOLDLOCK )
						INNER JOIN [dbo].[USR_UserApplications] AS APP
						ON APP.ApplicationID = @ApplicationId AND APP.UserID = m.UserId
                    WHERE LoweredEmail = LOWER(@Email)))
        BEGIN
            SET @ErrorCode = 7
            GOTO Cleanup
        END
    END

    IF (@NewUserCreated = 0)
    BEGIN
        UPDATE dbo.aspnet_Users
        SET    LastActivityDate = @CreateDate
        WHERE  @UserId = UserId
        IF( @@ERROR <> 0 )
        BEGIN
            SET @ErrorCode = -1
            GOTO Cleanup
        END
    END

    INSERT INTO dbo.aspnet_Membership
                ( UserId,
                  [Password],
                  PasswordSalt,
                  Email,
                  LoweredEmail,
                  PasswordQuestion,
                  PasswordAnswer,
                  PasswordFormat,
                  IsApproved,
                  IsLockedOut,
                  CreateDate,
                  LastLoginDate,
                  LastPasswordChangedDate,
                  LastLockoutDate,
                  FailedPasswordAttemptCount,
                  FailedPasswordAttemptWindowStart,
                  FailedPasswordAnswerAttemptCount,
                  FailedPasswordAnswerAttemptWindowStart )
         VALUES ( @UserId,
                  @Password,
                  @PasswordSalt,
                  @Email,
                  LOWER(@Email),
                  @PasswordQuestion,
                  @PasswordAnswer,
                  @PasswordFormat,
                  @IsApproved,
                  @IsLockedOut,
                  @CreateDate,
                  @CreateDate,
                  @CreateDate,
                  @LastLockoutDate,
                  @FailedPasswordAttemptCount,
                  @FailedPasswordAttemptWindowStart,
                  @FailedPasswordAnswerAttemptCount,
                  @FailedPasswordAnswerAttemptWindowStart )

    IF( @@ERROR <> 0 )
    BEGIN
        SET @ErrorCode = -1
        GOTO Cleanup
    END

    IF( @TranStarted = 1 )
    BEGIN
	    SET @TranStarted = 0
	    COMMIT TRANSACTION
    END

    RETURN 0

Cleanup:

    IF( @TranStarted = 1 )
    BEGIN
        SET @TranStarted = 0
    	ROLLBACK TRANSACTION
    END

    RETURN @ErrorCode

END
GO



CREATE PROCEDURE [dbo].[aspnet_Membership_FindUsersByEmail]
    @ApplicationName       nvarchar(256),
    @EmailToMatch          nvarchar(256),
    @PageIndex             int,
    @PageSize              int
AS
BEGIN
    DECLARE @ApplicationId uniqueidentifier
    SELECT  @ApplicationId = NULL
    SELECT  @ApplicationId = ApplicationId FROM dbo.aspnet_Applications WHERE LOWER(@ApplicationName) = LoweredApplicationName
    IF (@ApplicationId IS NULL)
        RETURN 0

    -- Set the page bounds
    DECLARE @PageLowerBound int
    DECLARE @PageUpperBound int
    DECLARE @TotalRecords   int
    SET @PageLowerBound = @PageSize * @PageIndex
    SET @PageUpperBound = @PageSize - 1 + @PageLowerBound

    -- Create a temp table TO store the select results
    CREATE TABLE #PageIndexForUsers
    (
        IndexId int IDENTITY (0, 1) NOT NULL,
        UserId uniqueidentifier
    )

    -- Insert into our temp table
    IF( @EmailToMatch IS NULL )
        INSERT INTO #PageIndexForUsers (UserId)
            SELECT u.UserId
            FROM   dbo.aspnet_Users u, dbo.aspnet_Membership m, dbo.USR_UserApplications app
            WHERE  app.ApplicationId = @ApplicationId AND app.UserID = u.UserId AND m.UserId = u.UserId AND m.Email IS NULL
            ORDER BY m.LoweredEmail
    ELSE
        INSERT INTO #PageIndexForUsers (UserId)
            SELECT u.UserId
            FROM   dbo.aspnet_Users u, dbo.aspnet_Membership m, dbo.USR_UserApplications app
            WHERE  app.ApplicationId = @ApplicationId AND app.UserID = u.UserId AND 
				m.UserId = u.UserId AND m.LoweredEmail LIKE LOWER(@EmailToMatch)
            ORDER BY m.LoweredEmail

    SELECT  u.UserName, m.Email, m.PasswordQuestion, m.Comment, m.IsApproved,
            m.CreateDate,
            m.LastLoginDate,
            u.LastActivityDate,
            m.LastPasswordChangedDate,
            u.UserId, m.IsLockedOut,
            m.LastLockoutDate
    FROM   dbo.aspnet_Membership m, dbo.aspnet_Users u, #PageIndexForUsers p
    WHERE  u.UserId = p.UserId AND u.UserId = m.UserId AND
           p.IndexId >= @PageLowerBound AND p.IndexId <= @PageUpperBound
    ORDER BY m.LoweredEmail

    SELECT  @TotalRecords = COUNT(*)
    FROM    #PageIndexForUsers
    RETURN @TotalRecords
END
GO


CREATE PROCEDURE [dbo].[aspnet_Membership_FindUsersByName]
    @ApplicationName       nvarchar(256),
    @UserNameToMatch       nvarchar(256),
    @PageIndex             int,
    @PageSize              int
AS
BEGIN
    DECLARE @ApplicationId uniqueidentifier
    SELECT  @ApplicationId = NULL
    SELECT  @ApplicationId = ApplicationId FROM dbo.aspnet_Applications WHERE LOWER(@ApplicationName) = LoweredApplicationName
    IF (@ApplicationId IS NULL)
        RETURN 0

    -- Set the page bounds
    DECLARE @PageLowerBound int
    DECLARE @PageUpperBound int
    DECLARE @TotalRecords   int
    SET @PageLowerBound = @PageSize * @PageIndex
    SET @PageUpperBound = @PageSize - 1 + @PageLowerBound

    -- Create a temp table TO store the select results
    CREATE TABLE #PageIndexForUsers
    (
        IndexId int IDENTITY (0, 1) NOT NULL,
        UserId uniqueidentifier
    )

    -- Insert into our temp table
    INSERT INTO #PageIndexForUsers (UserId)
        SELECT u.UserId
        FROM   dbo.aspnet_Users u, dbo.aspnet_Membership m, dbo.USR_UserApplications app
        WHERE  app.ApplicationId = @ApplicationId AND app.UserID = u.UserId AND 
			m.UserId = u.UserId AND u.LoweredUserName LIKE LOWER(@UserNameToMatch)
        ORDER BY u.UserName


    SELECT  u.UserName, m.Email, m.PasswordQuestion, m.Comment, m.IsApproved,
            m.CreateDate,
            m.LastLoginDate,
            u.LastActivityDate,
            m.LastPasswordChangedDate,
            u.UserId, m.IsLockedOut,
            m.LastLockoutDate
    FROM   dbo.aspnet_Membership m, dbo.aspnet_Users u, #PageIndexForUsers p
    WHERE  u.UserId = p.UserId AND u.UserId = m.UserId AND
           p.IndexId >= @PageLowerBound AND p.IndexId <= @PageUpperBound
    ORDER BY u.UserName

    SELECT  @TotalRecords = COUNT(*)
    FROM    #PageIndexForUsers
    RETURN @TotalRecords
END
GO


CREATE PROCEDURE [dbo].[aspnet_Membership_GetAllUsers]
    @ApplicationName       nvarchar(256),
    @PageIndex             int,
    @PageSize              int
AS
BEGIN
    DECLARE @ApplicationId uniqueidentifier
    SELECT  @ApplicationId = NULL
    SELECT  @ApplicationId = ApplicationId FROM dbo.aspnet_Applications WHERE LOWER(@ApplicationName) = LoweredApplicationName
    IF (@ApplicationId IS NULL)
        RETURN 0


    -- Set the page bounds
    DECLARE @PageLowerBound int
    DECLARE @PageUpperBound int
    DECLARE @TotalRecords   int
    SET @PageLowerBound = @PageSize * @PageIndex
    SET @PageUpperBound = @PageSize - 1 + @PageLowerBound

    -- Create a temp table TO store the select results
    CREATE TABLE #PageIndexForUsers
    (
        IndexId int IDENTITY (0, 1) NOT NULL,
        UserId uniqueidentifier
    )

    -- Insert into our temp table
    INSERT INTO #PageIndexForUsers (UserId)
    SELECT u.UserId
    FROM   dbo.aspnet_Membership m, dbo.aspnet_Users u, dbo.USR_UserApplications app
    WHERE  app.ApplicationId = @ApplicationId AND app.UserID = u.UserId AND u.UserId = m.UserId
    ORDER BY u.UserName

    SELECT @TotalRecords = @@ROWCOUNT

    SELECT u.UserName, m.Email, m.PasswordQuestion, m.Comment, m.IsApproved,
            m.CreateDate,
            m.LastLoginDate,
            u.LastActivityDate,
            m.LastPasswordChangedDate,
            u.UserId, m.IsLockedOut,
            m.LastLockoutDate
    FROM   dbo.aspnet_Membership m, dbo.aspnet_Users u, #PageIndexForUsers p
    WHERE  u.UserId = p.UserId AND u.UserId = m.UserId AND
           p.IndexId >= @PageLowerBound AND p.IndexId <= @PageUpperBound
    ORDER BY u.UserName
    RETURN @TotalRecords
END
GO


CREATE PROCEDURE [dbo].[aspnet_Membership_GetNumberOfUsersOnline]
    @ApplicationName            nvarchar(256),
    @MinutesSinceLastInActive   int,
    @CurrentTimeUtc             datetime
AS
BEGIN
    DECLARE @DateActive datetime
    SELECT  @DateActive = DATEADD(minute,  -(@MinutesSinceLastInActive), @CurrentTimeUtc)

    DECLARE @NumOnline int
    SELECT  @NumOnline = COUNT(*)
    FROM    dbo.aspnet_Users u(NOLOCK),
            dbo.aspnet_Applications a(NOLOCK),
            dbo.aspnet_Membership m(NOLOCK),
            dbo.USR_UserApplications app(NOLOCK)
    WHERE   app.ApplicationId = a.ApplicationId                  AND
			app.UserID = u.UserId								AND
            LastActivityDate > @DateActive                     AND
            a.LoweredApplicationName = LOWER(@ApplicationName) AND
            u.UserId = m.UserId
    RETURN(@NumOnline)
END
GO


CREATE PROCEDURE [dbo].[aspnet_Membership_GetPassword]
    @ApplicationName                nvarchar(256),
    @UserName                       nvarchar(256),
    @MaxInvalidPasswordAttempts     int,
    @PasswordAttemptWindow          int,
    @CurrentTimeUtc                 datetime,
    @PasswordAnswer                 nvarchar(128) = NULL
AS
BEGIN
    DECLARE @UserId                                 uniqueidentifier
    DECLARE @PasswordFormat                         int
    DECLARE @Password                               nvarchar(128)
    DECLARE @passAns                                nvarchar(128)
    DECLARE @IsLockedOut                            bit
    DECLARE @LastLockoutDate                        datetime
    DECLARE @FailedPasswordAttemptCount             int
    DECLARE @FailedPasswordAttemptWindowStart       datetime
    DECLARE @FailedPasswordAnswerAttemptCount       int
    DECLARE @FailedPasswordAnswerAttemptWindowStart datetime

    DECLARE @ErrorCode     int
    SET @ErrorCode = 0

    DECLARE @TranStarted   bit
    SET @TranStarted = 0

    IF( @@TRANCOUNT = 0 )
    BEGIN
	    BEGIN TRANSACTION
	    SET @TranStarted = 1
    END
    ELSE
    	SET @TranStarted = 0

    SELECT  @UserId = u.UserId,
            @Password = m.Password,
            @passAns = m.PasswordAnswer,
            @PasswordFormat = m.PasswordFormat,
            @IsLockedOut = m.IsLockedOut,
            @LastLockoutDate = m.LastLockoutDate,
            @FailedPasswordAttemptCount = m.FailedPasswordAttemptCount,
            @FailedPasswordAttemptWindowStart = m.FailedPasswordAttemptWindowStart,
            @FailedPasswordAnswerAttemptCount = m.FailedPasswordAnswerAttemptCount,
            @FailedPasswordAnswerAttemptWindowStart = m.FailedPasswordAnswerAttemptWindowStart
    FROM    dbo.aspnet_Applications a, dbo.aspnet_Users u, dbo.aspnet_Membership m WITH ( UPDLOCK ), dbo.USR_UserApplications app
    WHERE   LOWER(@ApplicationName) = a.LoweredApplicationName AND
            app.ApplicationId = a.ApplicationId    AND
            app.UserID = u.UserId AND
            u.UserId = m.UserId AND
            LOWER(@UserName) = u.LoweredUserName

    IF ( @@rowcount = 0 )
    BEGIN
        SET @ErrorCode = 1
        GOTO Cleanup
    END

    IF( @IsLockedOut = 1 )
    BEGIN
        SET @ErrorCode = 99
        GOTO Cleanup
    END

    IF ( NOT( @PasswordAnswer IS NULL ) )
    BEGIN
        IF( ( @passAns IS NULL ) OR ( LOWER( @passAns ) <> LOWER( @PasswordAnswer ) ) )
        BEGIN
            IF( @CurrentTimeUtc > DATEADD( minute, @PasswordAttemptWindow, @FailedPasswordAnswerAttemptWindowStart ) )
            BEGIN
                SET @FailedPasswordAnswerAttemptWindowStart = @CurrentTimeUtc
                SET @FailedPasswordAnswerAttemptCount = 1
            END
            ELSE
            BEGIN
                SET @FailedPasswordAnswerAttemptCount = @FailedPasswordAnswerAttemptCount + 1
                SET @FailedPasswordAnswerAttemptWindowStart = @CurrentTimeUtc
            END

            BEGIN
                IF( @FailedPasswordAnswerAttemptCount >= @MaxInvalidPasswordAttempts )
                BEGIN
                    SET @IsLockedOut = 1
                    SET @LastLockoutDate = @CurrentTimeUtc
                END
            END

            SET @ErrorCode = 3
        END
        ELSE
        BEGIN
            IF( @FailedPasswordAnswerAttemptCount > 0 )
            BEGIN
                SET @FailedPasswordAnswerAttemptCount = 0
                SET @FailedPasswordAnswerAttemptWindowStart = CONVERT( datetime, '17540101', 112 )
            END
        END

        UPDATE dbo.aspnet_Membership
        SET IsLockedOut = @IsLockedOut, LastLockoutDate = @LastLockoutDate,
            FailedPasswordAttemptCount = @FailedPasswordAttemptCount,
            FailedPasswordAttemptWindowStart = @FailedPasswordAttemptWindowStart,
            FailedPasswordAnswerAttemptCount = @FailedPasswordAnswerAttemptCount,
            FailedPasswordAnswerAttemptWindowStart = @FailedPasswordAnswerAttemptWindowStart
        WHERE @UserId = UserId

        IF( @@ERROR <> 0 )
        BEGIN
            SET @ErrorCode = -1
            GOTO Cleanup
        END
    END

    IF( @TranStarted = 1 )
    BEGIN
	SET @TranStarted = 0
	COMMIT TRANSACTION
    END

    IF( @ErrorCode = 0 )
        SELECT @Password, @PasswordFormat

    RETURN @ErrorCode

Cleanup:

    IF( @TranStarted = 1 )
    BEGIN
        SET @TranStarted = 0
    	ROLLBACK TRANSACTION
    END

    RETURN @ErrorCode

END
GO


CREATE PROCEDURE [dbo].[aspnet_Membership_GetPasswordWithFormat]
    @ApplicationName                nvarchar(256),
    @UserName                       nvarchar(256),
    @UpdateLastLoginActivityDate    bit,
    @CurrentTimeUtc                 datetime
AS
BEGIN
    DECLARE @IsLockedOut                        bit
    DECLARE @UserId                             uniqueidentifier
    DECLARE @Password                           nvarchar(128)
    DECLARE @PasswordSalt                       nvarchar(128)
    DECLARE @PasswordFormat                     int
    DECLARE @FailedPasswordAttemptCount         int
    DECLARE @FailedPasswordAnswerAttemptCount   int
    DECLARE @IsApproved                         bit
    DECLARE @LastActivityDate                   datetime
    DECLARE @LastLoginDate                      datetime

    SELECT  @UserId          = NULL

    SELECT  @UserId = u.UserId, @IsLockedOut = m.IsLockedOut, @Password=Password, @PasswordFormat=PasswordFormat,
            @PasswordSalt=PasswordSalt, @FailedPasswordAttemptCount=FailedPasswordAttemptCount,
		    @FailedPasswordAnswerAttemptCount=FailedPasswordAnswerAttemptCount, @IsApproved=IsApproved,
            @LastActivityDate = LastActivityDate, @LastLoginDate = LastLoginDate
    FROM    dbo.aspnet_Applications a, dbo.aspnet_Users u, dbo.aspnet_Membership m, dbo.USR_UserApplications app
    WHERE   LOWER(@ApplicationName) = a.LoweredApplicationName AND
            app.ApplicationId = a.ApplicationId    AND
            app.UserID = u.UserId AND
            u.UserId = m.UserId AND
            LOWER(@UserName) = u.LoweredUserName

    IF (@UserId IS NULL)
        RETURN 1

    IF (@IsLockedOut = 1)
        RETURN 99

    SELECT   @Password, @PasswordFormat, @PasswordSalt, @FailedPasswordAttemptCount,
             @FailedPasswordAnswerAttemptCount, @IsApproved, @LastLoginDate, @LastActivityDate

    IF (@UpdateLastLoginActivityDate = 1 AND @IsApproved = 1)
    BEGIN
        UPDATE  dbo.aspnet_Membership
        SET     LastLoginDate = @CurrentTimeUtc
        WHERE   UserId = @UserId

        UPDATE  dbo.aspnet_Users
        SET     LastActivityDate = @CurrentTimeUtc
        WHERE   @UserId = UserId
    END


    RETURN 0
END
GO


CREATE PROCEDURE [dbo].[aspnet_Membership_GetUserByEmail]
    @ApplicationName  nvarchar(256),
    @Email            nvarchar(256)
AS
BEGIN
    IF( @Email IS NULL )
        SELECT  u.UserName
        FROM    dbo.aspnet_Applications a, dbo.aspnet_Users u, dbo.aspnet_Membership m, dbo.USR_UserApplications app
        WHERE   LOWER(@ApplicationName) = a.LoweredApplicationName AND
                app.ApplicationId = a.ApplicationId    AND
                app.UserID = u.UserId AND
                u.UserId = m.UserId AND
                m.LoweredEmail IS NULL
    ELSE
        SELECT  u.UserName
        FROM    dbo.aspnet_Applications a, dbo.aspnet_Users u, dbo.aspnet_Membership m, dbo.USR_UserApplications app
        WHERE   LOWER(@ApplicationName) = a.LoweredApplicationName AND
                app.ApplicationId = a.ApplicationId    AND
                app.UserID = u.UserId AND
                u.UserId = m.UserId AND
                LOWER(@Email) = m.LoweredEmail

    IF (@@rowcount = 0)
        RETURN(1)
    RETURN(0)
END
GO


CREATE PROCEDURE [dbo].[aspnet_Membership_GetUserByName]
    @ApplicationName      nvarchar(256),
    @UserName             nvarchar(256),
    @CurrentTimeUtc       datetime,
    @UpdateLastActivity   bit = 0
AS
BEGIN
    DECLARE @UserId uniqueidentifier

    IF (@UpdateLastActivity = 1)
    BEGIN
        -- select user ID from aspnet_users table
        SELECT TOP 1 @UserId = u.UserId
        FROM    dbo.aspnet_Applications a, dbo.aspnet_Users u, dbo.aspnet_Membership m, dbo.USR_UserApplications app
        WHERE    LOWER(@ApplicationName) = a.LoweredApplicationName AND
                app.ApplicationId = a.ApplicationId    AND
                app.UserID = u.UserId AND
                LOWER(@UserName) = u.LoweredUserName AND u.UserId = m.UserId

        IF (@@ROWCOUNT = 0) -- Username not found
            RETURN -1

        UPDATE   dbo.aspnet_Users
        SET      LastActivityDate = @CurrentTimeUtc
        WHERE    @UserId = UserId

        SELECT m.Email, m.PasswordQuestion, m.Comment, m.IsApproved,
                m.CreateDate, m.LastLoginDate, u.LastActivityDate, m.LastPasswordChangedDate,
                u.UserId, m.IsLockedOut, m.LastLockoutDate
        FROM    dbo.aspnet_Applications a, dbo.aspnet_Users u, dbo.aspnet_Membership m
        WHERE  @UserId = u.UserId AND u.UserId = m.UserId 
    END
    ELSE
    BEGIN
        SELECT TOP 1 m.Email, m.PasswordQuestion, m.Comment, m.IsApproved,
                m.CreateDate, m.LastLoginDate, u.LastActivityDate, m.LastPasswordChangedDate,
                u.UserId, m.IsLockedOut,m.LastLockoutDate
        FROM    dbo.aspnet_Applications a, dbo.aspnet_Users u, dbo.aspnet_Membership m, dbo.USR_UserApplications app
        WHERE    LOWER(@ApplicationName) = a.LoweredApplicationName AND
                app.ApplicationId = a.ApplicationId    AND
                app.UserID = u.UserId AND
                LOWER(@UserName) = u.LoweredUserName AND u.UserId = m.UserId

        IF (@@ROWCOUNT = 0) -- Username not found
            RETURN -1
    END

    RETURN 0
END
GO


CREATE PROCEDURE [dbo].[aspnet_Membership_GetUserByUserId]
    @UserId               uniqueidentifier,
    @CurrentTimeUtc       datetime,
    @UpdateLastActivity   bit = 0
AS
BEGIN
    IF ( @UpdateLastActivity = 1 )
    BEGIN
        UPDATE   dbo.aspnet_Users
        SET      LastActivityDate = @CurrentTimeUtc
        FROM     dbo.aspnet_Users
        WHERE    @UserId = UserId

        IF ( @@ROWCOUNT = 0 ) -- User ID not found
            RETURN -1
    END

    SELECT  m.Email, m.PasswordQuestion, m.Comment, m.IsApproved,
            m.CreateDate, m.LastLoginDate, u.LastActivityDate,
            m.LastPasswordChangedDate, u.UserName, m.IsLockedOut,
            m.LastLockoutDate
    FROM    dbo.aspnet_Users u, dbo.aspnet_Membership m
    WHERE   @UserId = u.UserId AND u.UserId = m.UserId

    IF ( @@ROWCOUNT = 0 ) -- User ID not found
       RETURN -1

    RETURN 0
END
GO


CREATE PROCEDURE [dbo].[aspnet_Membership_ResetPassword]
    @ApplicationName             nvarchar(256),
    @UserName                    nvarchar(256),
    @NewPassword                 nvarchar(128),
    @MaxInvalidPasswordAttempts  int,
    @PasswordAttemptWindow       int,
    @PasswordSalt                nvarchar(128),
    @CurrentTimeUtc              datetime,
    @PasswordFormat              int = 0,
    @PasswordAnswer              nvarchar(128) = NULL
AS
BEGIN
    DECLARE @IsLockedOut                            bit
    DECLARE @LastLockoutDate                        datetime
    DECLARE @FailedPasswordAttemptCount             int
    DECLARE @FailedPasswordAttemptWindowStart       datetime
    DECLARE @FailedPasswordAnswerAttemptCount       int
    DECLARE @FailedPasswordAnswerAttemptWindowStart datetime

    DECLARE @UserId                                 uniqueidentifier
    SET     @UserId = NULL

    DECLARE @ErrorCode     int
    SET @ErrorCode = 0

    DECLARE @TranStarted   bit
    SET @TranStarted = 0

    IF( @@TRANCOUNT = 0 )
    BEGIN
	    BEGIN TRANSACTION
	    SET @TranStarted = 1
    END
    ELSE
    	SET @TranStarted = 0

    SELECT  @UserId = u.UserId
    FROM    dbo.aspnet_Users u, dbo.aspnet_Applications a, dbo.aspnet_Membership m, dbo.USR_UserApplications app
    WHERE   LoweredUserName = LOWER(@UserName) AND
            app.ApplicationId = a.ApplicationId  AND
            app.UserID = u.UserId AND
            LOWER(@ApplicationName) = a.LoweredApplicationName AND
            u.UserId = m.UserId

    IF ( @UserId IS NULL )
    BEGIN
        SET @ErrorCode = 1
        GOTO Cleanup
    END

    SELECT @IsLockedOut = IsLockedOut,
           @LastLockoutDate = LastLockoutDate,
           @FailedPasswordAttemptCount = FailedPasswordAttemptCount,
           @FailedPasswordAttemptWindowStart = FailedPasswordAttemptWindowStart,
           @FailedPasswordAnswerAttemptCount = FailedPasswordAnswerAttemptCount,
           @FailedPasswordAnswerAttemptWindowStart = FailedPasswordAnswerAttemptWindowStart
    FROM dbo.aspnet_Membership WITH ( UPDLOCK )
    WHERE @UserId = UserId

    IF( @IsLockedOut = 1 )
    BEGIN
        SET @ErrorCode = 99
        GOTO Cleanup
    END

    UPDATE dbo.aspnet_Membership
    SET    Password = @NewPassword,
           LastPasswordChangedDate = @CurrentTimeUtc,
           PasswordFormat = @PasswordFormat,
           PasswordSalt = @PasswordSalt
    WHERE  @UserId = UserId AND
           ( ( @PasswordAnswer IS NULL ) OR ( LOWER( PasswordAnswer ) = LOWER( @PasswordAnswer ) ) )

    IF ( @@ROWCOUNT = 0 )
        BEGIN
            IF( @CurrentTimeUtc > DATEADD( minute, @PasswordAttemptWindow, @FailedPasswordAnswerAttemptWindowStart ) )
            BEGIN
                SET @FailedPasswordAnswerAttemptWindowStart = @CurrentTimeUtc
                SET @FailedPasswordAnswerAttemptCount = 1
            END
            ELSE
            BEGIN
                SET @FailedPasswordAnswerAttemptWindowStart = @CurrentTimeUtc
                SET @FailedPasswordAnswerAttemptCount = @FailedPasswordAnswerAttemptCount + 1
            END

            BEGIN
                IF( @FailedPasswordAnswerAttemptCount >= @MaxInvalidPasswordAttempts )
                BEGIN
                    SET @IsLockedOut = 1
                    SET @LastLockoutDate = @CurrentTimeUtc
                END
            END

            SET @ErrorCode = 3
        END
    ELSE
        BEGIN
            IF( @FailedPasswordAnswerAttemptCount > 0 )
            BEGIN
                SET @FailedPasswordAnswerAttemptCount = 0
                SET @FailedPasswordAnswerAttemptWindowStart = CONVERT( datetime, '17540101', 112 )
            END
        END

    IF( NOT ( @PasswordAnswer IS NULL ) )
    BEGIN
        UPDATE dbo.aspnet_Membership
        SET IsLockedOut = @IsLockedOut, LastLockoutDate = @LastLockoutDate,
            FailedPasswordAttemptCount = @FailedPasswordAttemptCount,
            FailedPasswordAttemptWindowStart = @FailedPasswordAttemptWindowStart,
            FailedPasswordAnswerAttemptCount = @FailedPasswordAnswerAttemptCount,
            FailedPasswordAnswerAttemptWindowStart = @FailedPasswordAnswerAttemptWindowStart
        WHERE @UserId = UserId

        IF( @@ERROR <> 0 )
        BEGIN
            SET @ErrorCode = -1
            GOTO Cleanup
        END
    END

    IF( @TranStarted = 1 )
    BEGIN
	SET @TranStarted = 0
	COMMIT TRANSACTION
    END

    RETURN @ErrorCode

Cleanup:

    IF( @TranStarted = 1 )
    BEGIN
        SET @TranStarted = 0
    	ROLLBACK TRANSACTION
    END

    RETURN @ErrorCode

END
GO


CREATE PROCEDURE [dbo].[aspnet_Membership_SetPassword]
    @ApplicationName  nvarchar(256),
    @UserName         nvarchar(256),
    @NewPassword      nvarchar(128),
    @PasswordSalt     nvarchar(128),
    @CurrentTimeUtc   datetime,
    @PasswordFormat   int = 0
AS
BEGIN
    DECLARE @UserId uniqueidentifier
    SELECT  @UserId = NULL
    SELECT  @UserId = u.UserId
    FROM    dbo.aspnet_Users u, dbo.aspnet_Applications a, dbo.aspnet_Membership m, dbo.USR_UserApplications app
    WHERE   LoweredUserName = LOWER(@UserName) AND
            app.ApplicationId = a.ApplicationId  AND
            app.UserID = u.UserId AND
            LOWER(@ApplicationName) = a.LoweredApplicationName AND
            u.UserId = m.UserId

    IF (@UserId IS NULL)
        RETURN(1)

    UPDATE dbo.aspnet_Membership
    SET Password = @NewPassword, PasswordFormat = @PasswordFormat, PasswordSalt = @PasswordSalt,
        LastPasswordChangedDate = @CurrentTimeUtc
    WHERE @UserId = UserId
    RETURN(0)
END
GO


CREATE PROCEDURE [dbo].[aspnet_Membership_UnlockUser]
    @ApplicationName                         nvarchar(256),
    @UserName                                nvarchar(256)
AS
BEGIN
    DECLARE @UserId uniqueidentifier
    SELECT  @UserId = NULL
    SELECT  @UserId = u.UserId
    FROM    dbo.aspnet_Users u, dbo.aspnet_Applications a, dbo.aspnet_Membership m, dbo.USR_UserApplications app
    WHERE   LoweredUserName = LOWER(@UserName) AND
            app.ApplicationId = a.ApplicationId  AND
            app.UserID = u.UserId AND
            LOWER(@ApplicationName) = a.LoweredApplicationName AND
            u.UserId = m.UserId

    IF ( @UserId IS NULL )
        RETURN 1

    UPDATE dbo.aspnet_Membership
    SET IsLockedOut = 0,
        FailedPasswordAttemptCount = 0,
        FailedPasswordAttemptWindowStart = CONVERT( datetime, '17540101', 112 ),
        FailedPasswordAnswerAttemptCount = 0,
        FailedPasswordAnswerAttemptWindowStart = CONVERT( datetime, '17540101', 112 ),
        LastLockoutDate = CONVERT( datetime, '17540101', 112 )
    WHERE @UserId = UserId

    RETURN 0
END
GO


CREATE PROCEDURE [dbo].[aspnet_Membership_UpdateUser]
    @ApplicationName      nvarchar(256),
    @UserName             nvarchar(256),
    @Email                nvarchar(256),
    @Comment              ntext,
    @IsApproved           bit,
    @LastLoginDate        datetime,
    @LastActivityDate     datetime,
    @UniqueEmail          int,
    @CurrentTimeUtc       datetime
AS
BEGIN
    DECLARE @UserId uniqueidentifier
    DECLARE @ApplicationId uniqueidentifier
    SELECT  @UserId = NULL
    SELECT  @UserId = u.UserId, @ApplicationId = a.ApplicationId
    FROM    dbo.aspnet_Users u, dbo.aspnet_Applications a, dbo.aspnet_Membership m, dbo.USR_UserApplications app
    WHERE   LoweredUserName = LOWER(@UserName) AND
            app.ApplicationId = a.ApplicationId  AND
            app.UserID = u.UserId AND
            LOWER(@ApplicationName) = a.LoweredApplicationName AND
            u.UserId = m.UserId

    IF (@UserId IS NULL)
        RETURN(1)

    IF (@UniqueEmail = 1)
    BEGIN
        IF (EXISTS (SELECT *
                    FROM  dbo.aspnet_Membership m WITH (UPDLOCK, HOLDLOCK)
						INNER JOIN dbo.USR_UserApplications app
						ON app.UserID = m.UserId AND app.ApplicationID = @ApplicationId
                    WHERE @UserId <> m.UserId AND m.LoweredEmail = LOWER(@Email)))
        BEGIN
            RETURN(7)
        END
    END

    DECLARE @TranStarted   bit
    SET @TranStarted = 0

    IF( @@TRANCOUNT = 0 )
    BEGIN
	    BEGIN TRANSACTION
	    SET @TranStarted = 1
    END
    ELSE
	SET @TranStarted = 0

    UPDATE dbo.aspnet_Users WITH (ROWLOCK)
    SET
         LastActivityDate = @LastActivityDate
    WHERE
       @UserId = UserId

    IF( @@ERROR <> 0 )
        GOTO Cleanup

    UPDATE dbo.aspnet_Membership WITH (ROWLOCK)
    SET
         Email            = @Email,
         LoweredEmail     = LOWER(@Email),
         Comment          = @Comment,
         IsApproved       = @IsApproved,
         LastLoginDate    = @LastLoginDate
    WHERE
       @UserId = UserId

    IF( @@ERROR <> 0 )
        GOTO Cleanup

    IF( @TranStarted = 1 )
    BEGIN
	SET @TranStarted = 0
	COMMIT TRANSACTION
    END

    RETURN 0

Cleanup:

    IF( @TranStarted = 1 )
    BEGIN
        SET @TranStarted = 0
    	ROLLBACK TRANSACTION
    END

    RETURN -1
END
GO


CREATE PROCEDURE [dbo].[aspnet_Membership_UpdateUserInfo]
    @ApplicationName                nvarchar(256),
    @UserName                       nvarchar(256),
    @IsPasswordCorrect              bit,
    @UpdateLastLoginActivityDate    bit,
    @MaxInvalidPasswordAttempts     int,
    @PasswordAttemptWindow          int,
    @CurrentTimeUtc                 datetime,
    @LastLoginDate                  datetime,
    @LastActivityDate               datetime
AS
BEGIN
    DECLARE @UserId                                 uniqueidentifier
    DECLARE @IsApproved                             bit
    DECLARE @IsLockedOut                            bit
    DECLARE @LastLockoutDate                        datetime
    DECLARE @FailedPasswordAttemptCount             int
    DECLARE @FailedPasswordAttemptWindowStart       datetime
    DECLARE @FailedPasswordAnswerAttemptCount       int
    DECLARE @FailedPasswordAnswerAttemptWindowStart datetime

    DECLARE @ErrorCode     int
    SET @ErrorCode = 0

    DECLARE @TranStarted   bit
    SET @TranStarted = 0

    IF( @@TRANCOUNT = 0 )
    BEGIN
	    BEGIN TRANSACTION
	    SET @TranStarted = 1
    END
    ELSE
    	SET @TranStarted = 0

    SELECT  @UserId = u.UserId,
            @IsApproved = m.IsApproved,
            @IsLockedOut = m.IsLockedOut,
            @LastLockoutDate = m.LastLockoutDate,
            @FailedPasswordAttemptCount = m.FailedPasswordAttemptCount,
            @FailedPasswordAttemptWindowStart = m.FailedPasswordAttemptWindowStart,
            @FailedPasswordAnswerAttemptCount = m.FailedPasswordAnswerAttemptCount,
            @FailedPasswordAnswerAttemptWindowStart = m.FailedPasswordAnswerAttemptWindowStart
    FROM    dbo.aspnet_Applications a, dbo.aspnet_Users u, dbo.aspnet_Membership m WITH ( UPDLOCK ), dbo.USR_UserApplications app
    WHERE   LOWER(@ApplicationName) = a.LoweredApplicationName AND
            app.ApplicationId = a.ApplicationId    AND
            app.UserID = u.UserId AND
            u.UserId = m.UserId AND
            LOWER(@UserName) = u.LoweredUserName

    IF ( @@rowcount = 0 )
    BEGIN
        SET @ErrorCode = 1
        GOTO Cleanup
    END

    IF( @IsLockedOut = 1 )
    BEGIN
        GOTO Cleanup
    END

    IF( @IsPasswordCorrect = 0 )
    BEGIN
        IF( @CurrentTimeUtc > DATEADD( minute, @PasswordAttemptWindow, @FailedPasswordAttemptWindowStart ) )
        BEGIN
            SET @FailedPasswordAttemptWindowStart = @CurrentTimeUtc
            SET @FailedPasswordAttemptCount = 1
        END
        ELSE
        BEGIN
            SET @FailedPasswordAttemptWindowStart = @CurrentTimeUtc
            SET @FailedPasswordAttemptCount = @FailedPasswordAttemptCount + 1
        END

        BEGIN
            IF( @FailedPasswordAttemptCount >= @MaxInvalidPasswordAttempts )
            BEGIN
                SET @IsLockedOut = 1
                SET @LastLockoutDate = @CurrentTimeUtc
            END
        END
    END
    ELSE
    BEGIN
        IF( @FailedPasswordAttemptCount > 0 OR @FailedPasswordAnswerAttemptCount > 0 )
        BEGIN
            SET @FailedPasswordAttemptCount = 0
            SET @FailedPasswordAttemptWindowStart = CONVERT( datetime, '17540101', 112 )
            SET @FailedPasswordAnswerAttemptCount = 0
            SET @FailedPasswordAnswerAttemptWindowStart = CONVERT( datetime, '17540101', 112 )
            SET @LastLockoutDate = CONVERT( datetime, '17540101', 112 )
        END
    END

    IF( @UpdateLastLoginActivityDate = 1 )
    BEGIN
        UPDATE  dbo.aspnet_Users
        SET     LastActivityDate = @LastActivityDate
        WHERE   @UserId = UserId

        IF( @@ERROR <> 0 )
        BEGIN
            SET @ErrorCode = -1
            GOTO Cleanup
        END

        UPDATE  dbo.aspnet_Membership
        SET     LastLoginDate = @LastLoginDate
        WHERE   UserId = @UserId

        IF( @@ERROR <> 0 )
        BEGIN
            SET @ErrorCode = -1
            GOTO Cleanup
        END
    END


    UPDATE dbo.aspnet_Membership
    SET IsLockedOut = @IsLockedOut, LastLockoutDate = @LastLockoutDate,
        FailedPasswordAttemptCount = @FailedPasswordAttemptCount,
        FailedPasswordAttemptWindowStart = @FailedPasswordAttemptWindowStart,
        FailedPasswordAnswerAttemptCount = @FailedPasswordAnswerAttemptCount,
        FailedPasswordAnswerAttemptWindowStart = @FailedPasswordAnswerAttemptWindowStart
    WHERE @UserId = UserId

    IF( @@ERROR <> 0 )
    BEGIN
        SET @ErrorCode = -1
        GOTO Cleanup
    END

    IF( @TranStarted = 1 )
    BEGIN
	SET @TranStarted = 0
	COMMIT TRANSACTION
    END

    RETURN @ErrorCode

Cleanup:

    IF( @TranStarted = 1 )
    BEGIN
        SET @TranStarted = 0
    	ROLLBACK TRANSACTION
    END

    RETURN @ErrorCode

END
GO
/*     end of Create new membership procedures     */

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

-- EXEC SH_AddPost ''

IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[SH_AddPost]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[SH_AddPost]
GO

CREATE PROCEDURE [dbo].[SH_AddPost]
	@ApplicationID		uniqueidentifier,
    @ShareID 			uniqueidentifier,
    @PostTypeID         int,
    @Description        nvarchar(4000),
    @SharedObjectID     uniqueidentifier,
    @SenderUserID       uniqueidentifier,
    @SendDate		    datetime,
    @OwnerID			uniqueidentifier,
    @OwnerType			varchar(20),
    @HasPicture			bit,
    @Privacy            varchar(20) = N'Public'
WITH ENCRYPTION
AS
BEGIN TRANSACTION
	SET NOCOUNT ON

	SET @Description = [dbo].[GFN_VerifyString](@Description)
	
	DECLARE @_PostID uniqueidentifier
	SET @_PostID = NEWID()

    INSERT INTO [dbo].[SH_Posts] (
		[ApplicationID],
        [PostID],
		[PostTypeID],
		[Description],
		[SharedObjectID],
		[SenderUserID],
		[SendDate],
		[HasPicture],
		[Deleted]
    )
    VALUES (
		@ApplicationID,
        @_PostID,
        @PostTypeID,
        @Description,
        @SharedObjectID,
        @SenderUserID,
        @SendDate,
        ISNULL(@HasPicture, 0),
        0
    )
    
    DECLARE @_firstCount int
    SET @_firstCount = @@rowcount
    
    INSERT INTO [dbo].[SH_PostShares] (
		[ApplicationID],
		[ShareID],
        [PostID],
		[OwnerID],
		[SenderUserID],
		[SendDate],
		[ScoreDate],
		[Privacy],
		[Deleted],
		[OwnerType]
    )
    VALUES (
		@ApplicationID,
		@ShareID,
        @_PostID,
        @OwnerID,
        @SenderUserID,
        @SendDate,
        @SendDate,
        @Privacy,
        0,
        @OwnerType
    )
    
    DECLARE @_secondCount int
    SET @_secondCount = @@rowcount
    
IF(@_firstCount <> @_secondCount) BEGIN
	SELECT -1
	ROLLBACK TRANSACTION
END
ELSE BEGIN
	SELECT @_secondCount
	COMMIT TRANSACTION
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[SH_UpdatePost]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[SH_UpdatePost]
GO

CREATE PROCEDURE [dbo].[SH_UpdatePost]
	@ApplicationID			uniqueidentifier,
    @ShareID				uniqueidentifier,
	@Description			nvarchar(4000),
	@LastModifierUserID		uniqueidentifier,
	@LastModificationDate	datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SET @Description = [dbo].[GFN_VerifyString](@Description)
	
	-- Create a temp table TO store the select results
    CREATE TABLE #Temp
    (
        ShareID uniqueidentifier NOT NULL,
        ParentShareID uniqueidentifier NULL,
        PostID uniqueidentifier NOT NULL
    )
    
    INSERT INTO #Temp
    SELECT PS.ShareID, PS.ParentShareID, PS.PostID
    FROM [dbo].[SH_PostShares] AS PS
    WHERE PS.ApplicationID = @ApplicationID AND PS.ShareID = @ShareID
    
    DECLARE @_parentShareID uniqueidentifier
    DECLARE @_postID uniqueidentifier
    SET @_parentShareID = (SELECT #Temp.ParentShareID FROM #Temp)
    SET @_postID = (SELECT #Temp.PostID FROM #Temp)
    
    DROP TABLE #Temp
	
	IF (@_parentShareID IS NULL OR (@_parentShareID = @ShareID))
		UPDATE [dbo].[SH_Posts]
		SET [Description] = @Description,
			[LastModifierUserID] = @LastModifierUserID,
			[LastModificationDate] = @LastModificationDate
		WHERE ApplicationID = @ApplicationID AND PostID = @_postID
	ELSE
		UPDATE [dbo].[SH_PostShares]
		SET [Description] = @Description,
			[LastModifierUserID] = @LastModifierUserID,
			[LastModificationDate] = @LastModificationDate
		WHERE ApplicationID = @ApplicationID AND ShareID = @ShareID
	
	SELECT @@rowcount
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[SH_ArithmeticDeletePost]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[SH_ArithmeticDeletePost]
GO

CREATE PROCEDURE [dbo].[SH_ArithmeticDeletePost]
	@ApplicationID		uniqueidentifier,
    @ShareID	 		uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON

    UPDATE [dbo].[SH_PostShares]
	SET [Deleted] = 1
	WHERE ApplicationID = @ApplicationID AND ShareID = @ShareID
	
	SELECT @@rowcount
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[SH_P_GetPostsByIDs]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[SH_P_GetPostsByIDs]
GO

CREATE PROCEDURE [dbo].[SH_P_GetPostsByIDs]
	@ApplicationID	uniqueidentifier,
    @ShareIDs		GuidTableType readonly,
    @UserID			uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT PS.[ShareID] AS PostID,
		   PS.[ParentShareID] AS RefPostID,
		   P.[PostTypeID] AS PostTypeID,
		   PS.[Description] AS [Description],
		   P.[Description] AS OriginalDescription,
		   P.[SharedObjectID] AS SharedObjectID,
		   PS.[SenderUserID] AS SenderUserID,
		   PS.[SendDate] AS SendDate,
		   [ShareSender].[FirstName] AS FirstName,
		   [ShareSender].[LastName] AS LastName,
		   [ShareSender].[JobTitle] AS JobTitle,
		   P.[SenderUserID] AS OriginalSenderUserID,
		   P.[SendDate] AS OriginalSendDate,
		   [PostSender].[FirstName] AS OriginalFirstName,
		   [PostSender].[LastName] AS OriginalLastName,
		   [PostSender].[JobTitle] AS OriginalJobTitle,
		   PS.[LastModificationDate] AS LastModificationDate,
		   PS.[OwnerID] AS OwnerID,
		   PS.[OwnerType] AS OwnerType,
		   PS.[Privacy] AS Privacy,
		   P.[HasPicture] AS HasPicture,
		   (SELECT COUNT(*) FROM [dbo].[SH_Comments] AS C
			WHERE C.ApplicationID = @ApplicationID AND C.[ShareID] = PS.[ShareID] AND
				C.[Deleted] = 0) AS CommentsCount,
		   (SELECT COUNT(*) FROM [dbo].[SH_ShareLikes] AS L
			WHERE L.ApplicationID = @ApplicationID AND L.[ShareID] = PS.[ShareID] AND
				L.[Like] = 1) AS LikesCount,
			(SELECT COUNT(*) FROM [dbo].[SH_ShareLikes] AS L
			WHERE L.ApplicationID = @ApplicationID AND L.[ShareID] = PS.[ShareID] AND
				L.[Like] = 0) AS DislikesCount,
			(SELECT L.[Like] FROM [dbo].[SH_ShareLikes] AS L
			WHERE L.ApplicationID = @ApplicationID AND L.[ShareID] = PS.[ShareID] AND
				L.[UserID] = @UserID) AS LikeStatus
	FROM @ShareIDs AS ExternalIDs
		INNER JOIN [dbo].[SH_PostShares] AS PS
		ON PS.ApplicationID = @ApplicationID AND PS.[ShareID] = ExternalIDs.Value 
		INNER JOIN [dbo].[SH_Posts] AS P
		ON P.ApplicationID = @ApplicationID AND P.[PostID] = PS.[PostID]
		INNER JOIN [dbo].[Users_Normal] AS ShareSender
		ON ShareSender.ApplicationID = @ApplicationID AND ShareSender.[UserID] = PS.[SenderUserID]
		INNER JOIN [dbo].[Users_Normal] AS PostSender
		ON PostSender.ApplicationID = @ApplicationID AND PostSender.[UserID] = P.[SenderUserID]
	WHERE PS.[Deleted] = 0 AND ShareSender.IsApproved = 1
	ORDER BY PS.[ScoreDate] DESC
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[SH_GetPosts]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[SH_GetPosts]
GO

CREATE PROCEDURE [dbo].[SH_GetPosts]
	@ApplicationID	uniqueidentifier,
    @OwnerID	 	uniqueidentifier,
    @UserID			uniqueidentifier,
    @News			bit,
    @MaxDate		datetime,
    @MinDate		datetime,
    @Count			int
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @ShareIDs GuidTableType
	
	IF @UserID IS NULL OR @UserID <> @OwnerID OR ISNULL(@News, 0) = 0 BEGIN
		INSERT INTO @ShareIDs
		SELECT TOP (@Count)	PS.[ShareID] 
		FROM [dbo].[SH_PostShares] AS PS
		WHERE PS.ApplicationID = @ApplicationID AND PS.OwnerID = @OwnerID AND 
			  (@MaxDate IS NULL OR PS.SendDate <= @MaxDate) AND 
			  (@MinDate IS NULL OR PS.SendDate >= @MinDate) AND 
			  PS.Deleted = 0
		ORDER BY PS.[ScoreDate] DESC
	END
	ELSE BEGIN
		DECLARE @TempIDs Table(Value uniqueidentifier, [Date] DateTime)
		
		/* Public Posts */
		INSERT INTO @TempIDs
		SELECT TOP (@Count) PS.[ShareID], PS.[ScoreDate]
		FROM [dbo].[SH_PostShares] AS PS
		WHERE PS.ApplicationID = @ApplicationID AND 
			PS.[OwnerType] = N'User' AND PS.[Privacy] = N'Public' AND 
			(@MaxDate IS NULL OR PS.[SendDate] <= @MaxDate) AND 
			(@MinDate IS NULL OR PS.[SendDate] >= @MinDate) AND 
			PS.[Deleted] = 0
		ORDER BY PS.[ScoreDate] DESC
		/* end of Public Posts */
		
		DECLARE @MinPostsDate datetime, @CurCount int
		
		SET @MinPostsDate = (SELECT MIN(Ref.[Date]) FROM @TempIDs AS Ref)
		SET @CurCount = (SELECT DISTINCT COUNT(*) FROM @TempIDs)
		
		/* User's Posts */
		IF @Count <= @CurCount BEGIN
			INSERT INTO @TempIDs
			SELECT TOP (@Count)	PS.[ShareID], PS.[ScoreDate]
			FROM [dbo].[SH_PostShares] AS PS
			WHERE PS.ApplicationID = @ApplicationID AND 
				(PS.OwnerID = @OwnerID OR PS.SenderUserID = @UserID) AND 
				PS.[OwnerType] = N'User' AND
				(@MaxDate IS NULL OR PS.SendDate <= @MaxDate) AND 
				(@MinDate IS NULL OR PS.SendDate >= @MinDate) AND 
				PS.SendDate >= @MinPostsDate AND PS.Deleted = 0
			ORDER BY PS.[ScoreDate] DESC
		END
		ELSE BEGIN
			INSERT INTO @TempIDs
			SELECT TOP (@Count)	PS.[ShareID], PS.[ScoreDate]
			FROM [dbo].[SH_PostShares] AS PS
			WHERE PS.ApplicationID = @ApplicationID AND
				(PS.OwnerID = @OwnerID OR PS.SenderUserID = @UserID) AND 
				PS.[OwnerType] = N'User' AND
				(@MaxDate IS NULL OR PS.SendDate <= @MaxDate) AND
				(@MinDate IS NULL OR PS.SendDate >= @MinDate) AND
				PS.Deleted = 0
			ORDER BY PS.[ScoreDate] DESC
		END
		/* end of User's Posts */
		
		SET @MinPostsDate = (SELECT MIN(Ref.Date) FROM @TempIDs AS Ref)
		SET @CurCount = (SELECT DISTINCT COUNT(*) FROM @TempIDs)
		
		/* User's Friend's Posts */
		DECLARE @FriendIDs Table(Value uniqueidentifier primary key clustered)
		INSERT INTO @FriendIDs
		SELECT Ref.UserID
		FROM [dbo].[USR_FN_GetFriendIDs](@ApplicationID, @UserID, 1, 1, 1) AS Ref
		
		IF @Count <= @CurCount BEGIN
			INSERT INTO @TempIDs
			SELECT TOP (@Count) PS.[ShareID], PS.[ScoreDate]
			FROM @FriendIDs AS Friends
				INNER JOIN [dbo].[SH_PostShares] AS PS
				ON (PS.[SenderUserID] = Friends.Value OR PS.[OwnerID] = Friends.Value)
			WHERE PS.ApplicationID = @ApplicationID AND PS.[OwnerType] = N'User' AND
				  PS.[Privacy] = N'Friends' AND 
				  (@MaxDate IS NULL OR PS.[SendDate] <= @MaxDate) AND 
				  (@MinDate IS NULL OR PS.[SendDate] >= @MinDate) AND 
				  PS.SendDate >= @MinPostsDate AND
				  PS.[Deleted] = 0
			ORDER BY PS.[ScoreDate] DESC
		END
		ELSE BEGIN
			INSERT INTO @TempIDs
			SELECT TOP (@Count) PS.[ShareID], PS.[ScoreDate]
			FROM @FriendIDs AS Friends
				INNER JOIN [dbo].[SH_PostShares] AS PS
				ON (PS.[SenderUserID] = Friends.Value OR PS.[OwnerID] = Friends.Value)
			WHERE PS.ApplicationID = @ApplicationID AND PS.[OwnerType] = N'User' AND
				  PS.[Privacy] = N'Friends' AND 
				  (@MaxDate IS NULL OR PS.[SendDate] <= @MaxDate) AND 
				  (@MinDate IS NULL OR PS.[SendDate] >= @MinDate) AND 
				  PS.[Deleted] = 0
			ORDER BY PS.[ScoreDate] DESC
		END
		/* end of User's Friend's Posts */
		
		INSERT INTO @ShareIDs
		SELECT TOP (@Count) Ref.Value FROM @TempIDs AS Ref
		GROUP BY Ref.Value
		ORDER BY min(Ref.[Date]) DESC
	END
	
	EXEC [dbo].[SH_P_GetPostsByIDs] @ApplicationID, @ShareIDs, @UserID
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[SH_GetPostsByIDs]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[SH_GetPostsByIDs]
GO

CREATE PROCEDURE [dbo].[SH_GetPostsByIDs]
	@ApplicationID	uniqueidentifier,
    @strShareIDs 	varchar(8000),
    @delimiter		char,
    @UserID			uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @TempIDs GuidTableType
	
	INSERT INTO @TempIDs
	SELECT DISTINCT Ref.Value FROM GFN_StrToGuidTable(@strShareIDs, @delimiter) AS Ref
	
	EXEC [dbo].[SH_P_GetPostsByIDs] @ApplicationID, @TempIDs, @UserID
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[SH_GetPostOwnerID]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[SH_GetPostOwnerID]
GO

CREATE PROCEDURE [dbo].[SH_GetPostOwnerID]
	@ApplicationID		uniqueidentifier,
    @PostIDOrCommentID	uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	IF NOT EXISTS(
		SELECT TOP(1) ShareID
		FROM [dbo].[SH_PostShares]
		WHERE ApplicationID = @ApplicationID AND ShareID = @PostIDOrCommentID
	) BEGIN
		SELECT TOP(1) @PostIDOrCommentID = ShareID
		FROM [dbo].[SH_Comments]
		WHERE ApplicationID = @ApplicationID AND CommentID = @PostIDOrCommentID
	END
	
	SELECT OwnerID
	FROM [dbo].[SH_PostShares]
	WHERE ApplicationID = @ApplicationID AND ShareID = @PostIDOrCommentID
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[SH_GetPostSenderID]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[SH_GetPostSenderID]
GO

CREATE PROCEDURE [dbo].[SH_GetPostSenderID]
	@ApplicationID		uniqueidentifier,
    @PostIDOrCommentID	uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	IF NOT EXISTS(
		SELECT TOP(1) ShareID
		FROM [dbo].[SH_PostShares]
		WHERE ApplicationID = @ApplicationID AND ShareID = @PostIDOrCommentID
	) BEGIN
		SELECT TOP(1) @PostIDOrCommentID = ShareID
		FROM [dbo].[SH_Comments]
		WHERE ApplicationID = @ApplicationID AND CommentID = @PostIDOrCommentID
	END
	
	SELECT SenderUserID
	FROM [dbo].[SH_PostShares]
	WHERE ApplicationID = ApplicationID AND ShareID = @PostIDOrCommentID
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[SH_Share]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[SH_Share]
GO

CREATE PROCEDURE [dbo].[SH_Share]
	@ApplicationID	uniqueidentifier,
	@ShareID		uniqueidentifier,
	@ParentShareID	uniqueidentifier,
    @OwnerID		uniqueidentifier,
    @Description	nvarchar(4000),
    @SenderUserID	uniqueidentifier,
    @SendDate		datetime,
    @OwnerType		varchar(20),
    @Privacy		varchar(20) = N'Public'
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SET @Description = [dbo].[GFN_VerifyString](@Description)
	
	DECLARE @_PostID uniqueidentifier  = (
		SELECT TOP(1) PostID 
		FROM [dbo].[SH_PostShares]
		WHERE ApplicationID = @ApplicationID AND [ShareID] = @ParentShareID
	)

    INSERT INTO [dbo].[SH_PostShares] (
		[ApplicationID],
		[ShareID],
		[ParentShareID],
        [PostID],
		[OwnerID],
		[Description],
		[SenderUserID],
		[SendDate],
		[ScoreDate],
		[Privacy],
		[OwnerType],
		[Deleted]
    )
    VALUES (
		@ApplicationID,
		@ShareID,
		@ParentShareID,
        @_PostID,
        @OwnerID,
        @Description,
        @SenderUserID,
        @SendDate,
        @SendDate,
        @Privacy,
        @OwnerType,
        0
    )
    
    SELECT @@rowcount
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[SH_AddComment]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[SH_AddComment]
GO

CREATE PROCEDURE [dbo].[SH_AddComment]
	@ApplicationID	uniqueidentifier,
	@CommentID		uniqueidentifier,
    @ShareID		uniqueidentifier,
	@Description	nvarchar(4000),
	@SenderUserID	uniqueidentifier,
	@SendDate		datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SET @Description = [dbo].[GFN_VerifyString](@Description)
	
    INSERT INTO [dbo].[SH_Comments] (
		[ApplicationID],
		[CommentID],
		[ShareID],
        [Description],
		[SenderUserID],
		[SendDate],
		[Deleted]
    )
    VALUES (
		@ApplicationID,
		@CommentID,
		@ShareID,
		@Description,
        @SenderUserID,
        @SendDate,
        0
    )
	
	SELECT @@rowcount
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[SH_UpdateComment]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[SH_UpdateComment]
GO

CREATE PROCEDURE [dbo].[SH_UpdateComment]
	@ApplicationID			uniqueidentifier,
    @CommentID				uniqueidentifier,
	@Description			nvarchar(4000),
	@LastModifierUserID		uniqueidentifier,
	@LastModificationDate	datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SET @Description = [dbo].[GFN_VerifyString](@Description)
	
	UPDATE [dbo].[SH_Comments]
		SET [Description] = @Description,
			[LastModifierUserID] = @LastModifierUserID,
			[LastModificationDate] = @LastModificationDate
	WHERE ApplicationID = @ApplicationID AND CommentID = @CommentID
	
	SELECT @@rowcount
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[SH_ArithmeticDeleteComment]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[SH_ArithmeticDeleteComment]
GO

CREATE PROCEDURE [dbo].[SH_ArithmeticDeleteComment]
	@ApplicationID	uniqueidentifier,
    @CommentID		uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON

    UPDATE [dbo].[SH_Comments]
		SET [Deleted] = 1
	WHERE ApplicationID = @ApplicationID AND CommentID = @CommentID
	
    SELECT @@rowcount
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[SH_P_GetCommentsByIDs]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[SH_P_GetCommentsByIDs]
GO

CREATE PROCEDURE [dbo].[SH_P_GetCommentsByIDs]
	@ApplicationID	uniqueidentifier,
    @CommentIDs		GuidTableType readonly,
    @UserID	 		uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
    SELECT C.[CommentID] AS CommentID,
		   C.[ShareID] AS PostID,
		   C.[Description] AS [Description],
		   C.[SenderUserID] AS SenderUserID,
		   C.[SendDate] AS SendDate,
		   UN.[FirstName] AS FirstName,
		   UN.[Lastname] AS LastName,
		   (
				SELECT COUNT(*) 
				FROM [dbo].[SH_CommentLikes] AS CL
				WHERE CL.ApplicationID = @ApplicationID AND 
					CL.[CommentID] = C.[CommentID] AND CL.[Like] = 1
			) AS LikesCount,
			(
				SELECT COUNT(*) 
				FROM [dbo].[SH_CommentLikes] AS CL
				WHERE CL.ApplicationID = @ApplicationID AND 
					CL.[CommentID] = C.[CommentID] AND CL.[Like] = 0
			) AS DislikesCount,
			(
				SELECT CL.[Like] 
				FROM [dbo].[SH_CommentLikes] AS CL
				WHERE CL.ApplicationID = @ApplicationID AND CL.[CommentID] = 
					C.[CommentID] AND CL.[UserID] = @UserID
			) AS LikeStatus
	FROM @CommentIDs AS ExternalIDs
		INNER JOIN [dbo].[SH_Comments] AS C
		ON C.ApplicationID = @ApplicationID AND C.[CommentID] = ExternalIDs.Value
		INNER JOIN [dbo].[Users_Normal] AS UN
		ON UN.ApplicationID = @ApplicationID AND UN.[UserId] = C.[SenderUserID]
	ORDER BY C.SendDate
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[SH_GetCommentsByIDs]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[SH_GetCommentsByIDs]
GO

CREATE PROCEDURE [dbo].[SH_GetCommentsByIDs]
	@ApplicationID	uniqueidentifier,
    @strCommentIDs	varchar(max),
    @delimiter		char,
    @UserID	 		uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @CommentIDs GuidTableType
	INSERT INTO @CommentIDs
	SELECT Ref.Value FROM [dbo].[GFN_StrToGuidTable](@strCommentIDs, @delimiter) AS Ref
	
	EXEC [dbo].[SH_P_GetCommentsByIDs] @ApplicationID, @CommentIDs, @UserID
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[SH_GetComments]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[SH_GetComments]
GO

CREATE PROCEDURE [dbo].[SH_GetComments]
	@ApplicationID	uniqueidentifier,
    @strShareIDs	varchar(max),
    @delimiter		char,
    @UserID	 		uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @ShareIDs GuidTableType
	INSERT INTO @ShareIDs
	SELECT Ref.Value FROM [dbo].[GFN_StrToGuidTable](@strShareIDs, @delimiter) AS Ref
	
	DECLARE @CommentIDs GuidTableType
	
	INSERT INTO @CommentIDs
    SELECT C.[CommentID]
	FROM @ShareIDs AS ExternalIDs
		INNER JOIN [dbo].[SH_Comments] AS C
		ON C.[ShareID] = ExternalIDs.Value
	WHERE C.ApplicationID = @ApplicationID AND C.Deleted = 0
	
	EXEC [dbo].[SH_P_GetCommentsByIDs] @ApplicationID, @CommentIDs, @UserID
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[SH_GetCommentSenderID]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[SH_GetCommentSenderID]
GO

CREATE PROCEDURE [dbo].[SH_GetCommentSenderID]
	@ApplicationID	uniqueidentifier,
    @CommentID		uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT SenderUserID
	FROM [dbo].[SH_Comments]
	WHERE ApplicationID = @ApplicationID AND CommentID = @CommentID
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[SH_GetCommentSenderIDs]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[SH_GetCommentSenderIDs]
GO

CREATE PROCEDURE [dbo].[SH_GetCommentSenderIDs]
	@ApplicationID	uniqueidentifier,
    @PostID			uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT SenderUserID AS ID
	FROM [dbo].[SH_Comments]
	WHERE ApplicationID = @ApplicationID AND ShareID = @PostID AND Deleted = 0
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[SH_LikeDislikePost]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[SH_LikeDislikePost]
GO

CREATE PROCEDURE [dbo].[SH_LikeDislikePost]
	@ApplicationID	uniqueidentifier,
    @ShareID		uniqueidentifier,
    @UserID			uniqueidentifier,
    @Like			bit,
    @Score			float,
    @Date			datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON

	IF EXISTS (
		SELECT TOP(1) * 
		FROM [dbo].[SH_ShareLikes] 
		WHERE ApplicationID = @ApplicationID AND ShareID = @ShareID AND UserID = @UserID
	) BEGIN
		UPDATE [dbo].[SH_ShareLikes]
		SET [Like] = @Like,
			[Score] = ISNULL(@Score, 0),
			[Date] = @Date
		WHERE ApplicationID = @ApplicationID AND ShareID = @ShareID AND UserID = @UserID
	END
	ELSE BEGIN
		INSERT INTO [dbo].[SH_ShareLikes] (
			[ApplicationID],
			[ShareID],
			[UserID],
			[Like],
			[Score],
			[Date]
		)
		VALUES (
			@ApplicationID,
			@ShareID,
			@UserID,
			@Like,
			ISNULL(@Score, 0),
			@Date
		)
	END
	
    SELECT @@rowcount
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[SH_UnlikePost]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[SH_UnlikePost]
GO

CREATE PROCEDURE [dbo].[SH_UnlikePost]
	@ApplicationID	uniqueidentifier,
    @ShareID		uniqueidentifier,
    @UserID			uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON

	DELETE FROM [dbo].[SH_ShareLikes]
	WHERE ApplicationID = @ApplicationID AND [ShareID] = @ShareID AND [UserID] = @UserID
	
    SELECT @@rowcount
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[SH_GetPostFanIDs]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[SH_GetPostFanIDs]
GO

CREATE PROCEDURE [dbo].[SH_GetPostFanIDs]
	@ApplicationID	uniqueidentifier,
    @ShareID		uniqueidentifier,
    @LikeStatus		bit,
    @Count			int,
    @LowerBoundary	bigint
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	IF ISNULL(@Count, 0) <= 0 SET @Count = 1000000
	
	SELECT TOP(@Count)
		Ref.RowNumber AS [Order],
		(Ref.RowNumber + Ref.RevRowNumber - 1) AS TotalCount,
		Ref.UserID AS UserID
	FROM (
			SELECT	ROW_NUMBER() OVER (ORDER BY SL.[Date] DESC) AS RowNumber,
					ROW_NUMBER() OVER (ORDER BY SL.[Date] ASC) AS RevRowNumber,
					SL.UserID
			FROM [dbo].[SH_ShareLikes] AS SL
			WHERE SL.ApplicationID = @ApplicationID AND SL.ShareID = @ShareID AND 
				ISNULL(SL.[Like], 0) = ISNULL(@LikeStatus, 0)
		) AS Ref
	WHERE Ref.RowNumber >= ISNULL(@LowerBoundary, 0)
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[SH_GetCommentFanIDs]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[SH_GetCommentFanIDs]
GO

CREATE PROCEDURE [dbo].[SH_GetCommentFanIDs]
	@ApplicationID	uniqueidentifier,
    @CommentID		uniqueidentifier,
    @LikeStatus		bit,
    @Count			int,
    @LowerBoundary	bigint
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	IF ISNULL(@Count, 0) <= 0 SET @Count = 1000000
	
	SELECT TOP(@Count)
		Ref.RowNumber AS [Order],
		(Ref.RowNumber + Ref.RevRowNumber - 1) AS TotalCount,
		Ref.UserID AS UserID
	FROM (
			SELECT	ROW_NUMBER() OVER (ORDER BY CL.[Date] DESC) AS RowNumber,
					ROW_NUMBER() OVER (ORDER BY CL.[Date] ASC) AS RevRowNumber,
					CL.UserID
			FROM [dbo].[SH_CommentLikes] AS CL
			WHERE CL.ApplicationID = @ApplicationID AND CL.CommentID = @CommentID AND 
				ISNULL(CL.[Like], 0) = ISNULL(@LikeStatus, 0)
		) AS Ref
	WHERE Ref.RowNumber >= ISNULL(@LowerBoundary, 0)
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[SH_LikeDislikeComment]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[SH_LikeDislikeComment]
GO

CREATE PROCEDURE [dbo].[SH_LikeDislikeComment]
	@ApplicationID	uniqueidentifier,
    @CommentID		uniqueidentifier,
    @UserID			uniqueidentifier,
    @Like			bit,
    @Score			float,
    @Date			datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON

	IF EXISTS (
		SELECT * 
		FROM [dbo].[SH_CommentLikes] 
		WHERE ApplicationID = @ApplicationID AND CommentID = @CommentID AND UserID = @UserID
	) 
	BEGIN
		UPDATE [dbo].[SH_CommentLikes]
		SET [Like] = @Like,
			[Score] = ISNULL(@Score, 0),
			[Date] = @Date
		WHERE ApplicationID = @ApplicationID AND CommentID = @CommentID AND UserID = @UserID
	END
	ELSE BEGIN
		INSERT INTO [dbo].[SH_CommentLikes] (
			[ApplicationID],
			[CommentID],
			[UserID],
			[Like],
			[Score],
			[Date]
		)
		VALUES (
			@ApplicationID,
			@CommentID,
			@UserID,
			@Like,
			ISNULL(@Score, 0),
			@Date
		)
	END
	
    SELECT @@rowcount
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[SH_UnlikeComment]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[SH_UnlikeComment]
GO

CREATE PROCEDURE [dbo].[SH_UnlikeComment]
	@ApplicationID	uniqueidentifier,
    @CommentID		uniqueidentifier,
    @UserID			uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON

	DELETE FROM [dbo].[SH_CommentLikes]
	WHERE ApplicationID = @ApplicationID AND [CommentID] = @CommentID AND [UserID] = @UserID
	
    SELECT @@rowcount
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[SH_GetPostsCount]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[SH_GetPostsCount]
GO

CREATE PROCEDURE [dbo].[SH_GetPostsCount]
	@ApplicationID	uniqueidentifier,
    @OwnerID		uniqueidentifier,
    @SenderUserID	uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
    SELECT COUNT(*)
	FROM [dbo].[SH_PostShares]
	WHERE ApplicationID = @ApplicationID AND (@OwnerID IS NULL OR OwnerID = @OwnerID) AND 
		(@SenderUserID IS NULL OR SenderUserID = @SenderUserID) AND Deleted = 0
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[SH_GetSharesCount]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[SH_GetSharesCount]
GO

CREATE PROCEDURE [dbo].[SH_GetSharesCount]
	@ApplicationID	uniqueidentifier,
    @ShareID		uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @_PostID uniqueidentifier
	
	SET @_PostID = (
		SELECT PostID 
		FROM [dbo].[SH_PostShares] 
		WHERE ApplicationID = @ApplicationID AND [ShareID] = @ShareID
	)
	
    SELECT COUNT(*)
	FROM [dbo].[SH_PostShares]
	WHERE ApplicationID = @ApplicationID AND PostID = @_PostID AND Deleted = 0
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[SH_GetCommentsCount]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[SH_GetCommentsCount]
GO

CREATE PROCEDURE [dbo].[SH_GetCommentsCount]
	@ApplicationID	uniqueidentifier,
    @PostID			uniqueidentifier,
    @SenderUserID	uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
    SELECT COUNT(*)
	FROM [dbo].[SH_Comments]
	WHERE ApplicationID = @ApplicationID AND (@PostID IS NULL OR ShareID = @PostID) AND 
		(@SenderUserID IS NULL OR SenderUserID = @SenderUserID) AND Deleted = 0
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[SH_GetUserPostsCount]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[SH_GetUserPostsCount]
GO

CREATE PROCEDURE [dbo].[SH_GetUserPostsCount]
	@ApplicationID	uniqueidentifier,
    @UserID			uniqueidentifier,
    @PostTypeID		int = 0
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	IF @PostTypeID = 0 
		SELECT COUNT(*)
		FROM [dbo].[SH_PostShares]
		WHERE ApplicationID = @ApplicationID AND SenderUserID = @UserID AND Deleted = 0
	ELSE
		SELECT COUNT(*)
		FROM [dbo].[SH_PostShares] AS PS
			INNER JOIN [dbo].[SH_Posts]  AS P
			ON P.ApplicationID = @ApplicationID AND P.[PostID] = PS.[PostID]
		WHERE PS.ApplicationID = @ApplicationID AND PS.[SenderUserID] = @UserID AND 
			PS.[Deleted] = 0 AND P.[PostTypeID] = @PostTypeID
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[SH_GetPostLikesDislikesCount]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[SH_GetPostLikesDislikesCount]
GO

CREATE PROCEDURE [dbo].[SH_GetPostLikesDislikesCount]
	@ApplicationID	uniqueidentifier,
    @ShareID		uniqueidentifier,
    @Like			bit
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
    SELECT COUNT(*)
	FROM [dbo].[SH_ShareLikes]
	WHERE ApplicationID = @ApplicationID AND [ShareID] = @ShareID AND [Like] = @Like
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[SH_GetCommentLikesDislikesCount]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[SH_GetCommentLikesDislikesCount]
GO

CREATE PROCEDURE [dbo].[SH_GetCommentLikesDislikesCount]
	@ApplicationID	uniqueidentifier,
    @CommentID		uniqueidentifier,
    @Like			bit
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
    SELECT COUNT(*)
	FROM [dbo].[SH_CommentLikes]
	WHERE ApplicationID = @ApplicationID AND [CommentID] = @CommentID AND [Like] = @Like
END

GO



SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_P_InitializeNodeTypes]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_P_InitializeNodeTypes]
GO

CREATE PROCEDURE [dbo].[CN_P_InitializeNodeTypes]
	@ApplicationID	uniqueidentifier,
	@Now			datetime,
	@_Result		int output
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @CurNodeTypesCount int = (
		SELECT COUNT(*) 
		FROM [dbo].[CN_NodeTypes] 
		WHERE ApplicationID = @ApplicationID AND ISNUMERIC(ISNULL(AdditionalID, N'__')) = 1
	)
	
	IF @CurNodeTypesCount > 2 BEGIN
		SELECT 1
		RETURN
	END

	DECLARE @UserID uniqueidentifier = (
		SELECT TOP(1) UserID
		FROM [dbo].[Users_Normal] AS UN
		WHERE UN.ApplicationID = @ApplicationID AND LOWER(UN.UserName) = N'admin'
	)

	SET @Now = ISNULL(@Now, GETDATE())

	DECLARE @NodeTypes Table (AdditionalID varchar(20), Name nvarchar(500))

	INSERT INTO @NodeTypes (AdditionalID, Name)
	VALUES ('1', N' '), ('2', N''), ('3', N''), ('4', N' '), 
		('5', N''), ('6', N' '), ('7', N''), ('11', N'')

	INSERT INTO [dbo].[CN_NodeTypes] (
		[ApplicationID],
		[NodeTypeID], 
		[Name], 
		[Deleted], 
		[CreatorUserID], 
		[CreationDate],
		[AdditionalID]
	) 
	SELECT  @ApplicationID, 
			NEWID(), 
			[dbo].[GFN_VerifyString](NT.Name), 
			0, 
			@UserID, 
			@Now, 
			NT.AdditionalID
	FROM @NodeTypes AS NT
		LEFT JOIN [dbo].[CN_NodeTypes] AS T
		ON T.ApplicationID = @ApplicationID AND T.AdditionalID = NT.AdditionalID
	WHERE T.NodeTypeID IS NULL
	
	
	DECLARE @KnowledgeTypes Table (AdditionalID varchar(20), Name nvarchar(500))

	INSERT INTO @KnowledgeTypes (AdditionalID, Name)
	VALUES ('8', N''), ('9', N''), ('10', N'')
	
	DECLARE @KnowledgeTypeID uniqueidentifier = (
		SELECT TOP(1) NodeTypeID
		FROM [dbo].[CN_NodeTypes]
		WHERE ApplicationID = @ApplicationID AND AdditionalID = '5'
	)
	
	IF @KnowledgeTypeID IS NOT NULL BEGIN
		INSERT INTO [dbo].[CN_NodeTypes] (
			[ApplicationID],
			[NodeTypeID], 
			[Name], 
			[Deleted], 
			[CreatorUserID], 
			[CreationDate],
			[AdditionalID],
			[ParentID]
		) 
		SELECT  @ApplicationID, 
				NEWID(), 
				[dbo].[GFN_VerifyString](NT.Name), 
				0, 
				@UserID, 
				@Now, 
				NT.AdditionalID,
				@KnowledgeTypeID
		FROM @KnowledgeTypes AS NT
			LEFT JOIN [dbo].[CN_NodeTypes] AS T
			ON T.ApplicationID = @ApplicationID AND T.AdditionalID = NT.AdditionalID
		WHERE T.NodeTypeID IS NULL	
	END

	SET @_Result = 1
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_P_InitializeRelationTypes]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_P_InitializeRelationTypes]
GO

CREATE PROCEDURE [dbo].[CN_P_InitializeRelationTypes]
	@ApplicationID	uniqueidentifier,
	@_Result		int	output
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON

	DECLARE @TBL Table(AdditionalID int, Name nvarchar(100))
	
	INSERT INTO @TBL (AdditionalID, Name)
	VALUES	(1,	N' '),
			(2,	N' '),
			(3,	N'')
	
	INSERT INTO [dbo].[CN_Properties] (ApplicationID, PropertyID, AdditionalID, Name, Deleted)
	SELECT @ApplicationID, NEWID(), T.AdditionalID, T.Name, 0
	FROM @TBL AS T
		LEFT JOIN [dbo].[CN_Properties] AS P
		ON P.ApplicationID = @ApplicationID AND P.AdditionalID = T.AdditionalID
	WHERE P.PropertyID IS NULL
	
	SET @_Result = 1
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_Initialize]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_Initialize]
GO

CREATE PROCEDURE [dbo].[CN_Initialize]
	@ApplicationID	uniqueidentifier,
	@Now			datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @_Result int
	
	EXEC [dbo].[CN_P_InitializeNodeTypes] @ApplicationID, @Now, @_Result output
	EXEC [dbo].[CN_P_InitializeRelationTypes] @ApplicationID, @_Result output
	
	SELECT 1
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_AddNodeType]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_AddNodeType]
GO

CREATE PROCEDURE [dbo].[CN_AddNodeType]
	@ApplicationID		uniqueidentifier,
    @NodeTypeID 		uniqueidentifier,
    @AdditionalID		varchar(50),
    @Name				nvarchar(255),
    @ParentID			uniqueidentifier,
    @SetupService		bit,
    @TemplateNodeTypeID uniqueidentifier,
    @TemplateFormID 	uniqueidentifier,
    @CreatorUserID		uniqueidentifier,
    @CreationDate		datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON

	SET @Name = [dbo].[GFN_VerifyString](@Name)
	IF(@AdditionalID = N'') SET @AdditionalID = NULL
	
	IF @AdditionalID IS NULL OR NOT EXISTS(
		SELECT TOP(1) * 
		FROM [dbo].[CN_NodeTypes]
		WHERE ApplicationID = @ApplicationID AND AdditionalID = @AdditionalID
	) BEGIN
		INSERT INTO [dbo].[CN_NodeTypes](
			ApplicationID,
			NodeTypeID,
			TemplateTypeID,
			AdditionalID,
			Name,
			ParentID,
			CreatorUserID,
			CreationDate,
			Deleted
		)
		VALUES(
			@ApplicationID,
			@NodeTypeID,
			@TemplateNodeTypeID,
			@AdditionalID,
			@Name,
			@ParentID,
			@CreatorUserID,
			@CreationDate,
			0
		)
		
		DECLARE @_Result int = 0
		
		IF ISNULL(@SetupService, 0) = 1 BEGIN
			EXEC [dbo].[CN_P_InitializeService] @ApplicationID, @NodeTypeID, @_Result output
			
			UPDATE [dbo].[CN_Services]
				SET ServiceTitle = [dbo].[GFN_VerifyString](@Name)
			WHERE ApplicationID = @ApplicationID AND NodeTypeID = @NodeTypeID
			
			DECLARE @FormID uniqueidentifier = NEWID()
			
			DECLARE @FormTitle nvarchar(255) = [dbo].[GFN_VerifyString](@Name) + N' - ' + 
				CAST(FLOOR((RAND() * (99998 - 10001)) + 10001) AS nvarchar(100))
			
			EXEC [dbo].[FG_P_CreateForm] @ApplicationID, @FormID, @TemplateFormID, 
				@FormTitle, @CreatorUserID, @CreationDate, @_Result output
			
			EXEC [dbo].[FG_P_SetFormOwner] @ApplicationID, @NodeTypeID, @FormID, @CreatorUserID, @CreationDate, @_Result output
		END
		
		SELECT 1
	END

	SELECT 0
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_RenameNodeType]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_RenameNodeType]
GO

CREATE PROCEDURE [dbo].[CN_RenameNodeType]
	@ApplicationID			uniqueidentifier,
    @NodeTypeID 			uniqueidentifier,
    @Name					nvarchar(255),
    @LastModifierUserID		uniqueidentifier,
    @LastModificationDate	datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SET @Name = [dbo].[GFN_VerifyString](@Name)
	
	UPDATE [dbo].[CN_NodeTypes]
		SET Name = @Name,
			LastModifierUserID = @LastModifierUserID,
			LastModificationDate = @LastModificationDate
	WHERE ApplicationID = @ApplicationID AND NodeTypeID = @NodeTypeID

	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_SetNodeTypeAdditionalID]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_SetNodeTypeAdditionalID]
GO

CREATE PROCEDURE [dbo].[CN_SetNodeTypeAdditionalID]
	@ApplicationID			uniqueidentifier,
    @NodeTypeID 			uniqueidentifier,
    @AdditionalID			varchar(255),
    @LastModifierUserID		uniqueidentifier,
    @LastModificationDate	datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @CurrentAdditionalID varchar(255) = (
		SELECT TOP(1) AdditionalID
		FROM [dbo].[CN_NodeTypes]
		WHERE ApplicationID = @ApplicationID AND NodeTypeID = @NodeTypeID
	)
	
	IF LTRIM(RTRIM(ISNULL(@CurrentAdditionalID, ''))) = '6' BEGIN
		SELECT -1, N'CannotChangeTheAdditionalIDOFThisNodeType'
		RETURN
	END
	
	IF Exists(
		SELECT TOP(1) *
		FROM [dbo].[CN_NodeTypes]
		WHERE ApplicationID = @ApplicationID AND NodeTypeID <> @NodeTypeID AND 
			LOWER(AdditionalID) = LOWER(@AdditionalID)
	) BEGIN
		SELECT -1, N'ThereIsAlreadyANodeTypeWithTheSameAdditionalID'
		RETURN
	END
	
	UPDATE [dbo].[CN_NodeTypes]
		SET AdditionalID = @AdditionalID,
			LastModifierUserID = @LastModifierUserID,
			LastModificationDate = @LastModificationDate
	WHERE ApplicationID = @ApplicationID AND NodeTypeID = @NodeTypeID

	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_SetAdditionalIDPattern]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_SetAdditionalIDPattern]
GO

CREATE PROCEDURE [dbo].[CN_SetAdditionalIDPattern]
	@ApplicationID			uniqueidentifier,
    @NodeTypeID 			uniqueidentifier,
    @AdditionalIDPattern	varchar(255),
    @LastModifierUserID		uniqueidentifier,
    @LastModificationDate	datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[CN_NodeTypes]
		SET AdditionalIDPattern = @AdditionalIDPattern,
			LastModifierUserID = @LastModifierUserID,
			LastModificationDate = @LastModificationDate
	WHERE ApplicationID = @ApplicationID AND NodeTypeID = @NodeTypeID

	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_MoveNodeType]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_MoveNodeType]
GO

CREATE PROCEDURE [dbo].[CN_MoveNodeType]
	@ApplicationID			uniqueidentifier,
    @strNodeTypeIDs			varchar(max),
	@delimiter				char,
    @ParentID				uniqueidentifier,
    @LastModifierUserID		uniqueidentifier,
    @LastModificationDate	datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @NodeTypeIDs GuidTableType
	INSERT INTO @NodeTypeIDs
	SELECT Ref.Value FROM [dbo].[GFN_StrToGuidTable](@strNodeTypeIDs, @delimiter) AS Ref
	
	UPDATE [dbo].[CN_NodeTypes]
		SET ParentID = @ParentID,
			LastModifierUserID = @LastModifierUserID,
			LastModificationDate = @LastModificationDate
	WHERE ApplicationID = @ApplicationID AND 
		NodeTypeID IN(SELECT NT.Value FROM @NodeTypeIDs AS NT)

	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_P_GetNodeTypesByIDs]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_P_GetNodeTypesByIDs]
GO

CREATE PROCEDURE [dbo].[CN_P_GetNodeTypesByIDs]
	@ApplicationID		uniqueidentifier,
	@NodeTypeIDsTemp	KeyLessGuidTableType readonly
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @NodeTypeIDs KeyLessGuidTableType
	INSERT INTO @NodeTypeIDs (Value) SELECT Value FROM @NodeTypeIDsTemp
	
	SELECT NT.NodeTypeID,
		   NT.ParentID,
		   NT.Name,
		   NT.AdditionalID,
		   NT.AdditionalIDPattern,
		   NT.Deleted AS Archive,
		   CAST((CASE WHEN ISNULL(S.ServiceTitle, N'') = N'' THEN 0 ELSE 1 END) AS bit) AS IsService
	FROM @NodeTypeIDs AS Ref
		INNER JOIN [dbo].[CN_NodeTypes] AS NT
		ON NT.ApplicationID = @ApplicationID AND NT.NodeTypeID = Ref.Value
		LEFT JOIN [dbo].[CN_Services] AS S
		ON S.ApplicationID = @ApplicationID AND S.NodeTypeID = NT.NodeTypeID AND S.Deleted = 0
	ORDER BY (CASE WHEN NT.Deleted = 1 THEN NT.LastModificationDate ELSE Ref.SequenceNumber END) ASC
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_GetNodeTypesByIDs]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_GetNodeTypesByIDs]
GO

CREATE PROCEDURE [dbo].[CN_GetNodeTypesByIDs]
	@ApplicationID		uniqueidentifier,
	@strNodeTypeIDs		varchar(max),
	@delimiter			char,
	@GrabSubNodeTypes	bit
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @NodeTypeIDs KeyLessGuidTableType
	
	INSERT INTO @NodeTypeIDs (Value)
	SELECT DISTINCT Ref.Value 
	FROM [dbo].[GFN_StrToGuidTable](@strNodeTypeIDs, @delimiter) AS Ref
	
	IF @GrabSubNodeTypes = 1 BEGIN
		DECLARE @TempIDs GuidTableType
		
		INSERT INTO @TempIDs (Value)
		SELECT IDs.Value
		FROM @NodeTypeIDs AS IDs
	
		INSERT INTO @NodeTypeIDs (Value)
		SELECT DISTINCT Ref.NodeTypeID
		FROM @NodeTypeIDs AS IDs
			RIGHT JOIN [dbo].[CN_FN_GetChildNodeTypesDeepHierarchy](@ApplicationID, @TempIDs) AS Ref
			ON Ref.NodeTypeID = IDs.Value
		WHERE IDs.Value IS NULL
	END
	
	EXEC [dbo].[CN_P_GetNodeTypesByIDs] @ApplicationID, @NodeTypeIDs
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_GetNodeTypes]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_GetNodeTypes]
GO

CREATE PROCEDURE [dbo].[CN_GetNodeTypes]
	@ApplicationID	uniqueidentifier,
	@SearchText		nvarchar(1000),
	@IsKnowledge	bit,
	@IsDocument		bit,
	@Archive		bit,
	@strExtensions	nvarchar(1000),
	@delimiter		char,
	@Count			int,
	@LowerBoundary	bigint
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @IDs Table(NodeTypeID uniqueidentifier, TotalCount bigint)
	DECLARE @NodeTypeIDs KeyLessGuidTableType
	
	DECLARE @Extensions StringTableType
	
	INSERT INTO @Extensions (Value)
	SELECT DISTINCT Ref.Value
	FROM [dbo].[GFN_StrToStringTable](@strExtensions, @delimiter) AS Ref
	
	DECLARE @ExtensionsCount int = (SELECT TOP(1) COUNT(X.Value) FROM @Extensions AS X)
	
	IF ISNULL(@Count, 0) <= 0 SET @Count = 1000000
	
	IF ISNULL(@SearchText, N'') = N'' BEGIN
		INSERT INTO @IDs (NodeTypeID, TotalCount)
		SELECT TOP(@Count)
			Ref.NodeTypeID,
			(Ref.RowNumber + Ref.RevRowNumber - 1) AS TotalCount
		FROM (
				SELECT	ROW_NUMBER() OVER (ORDER BY ISNULL(MAX(NT.CreationDate), 
							'2000-02-15 10:48:39.330') DESC, NT.NodeTypeID DESC) AS RowNumber,
						ROW_NUMBER() OVER (ORDER BY ISNULL(MAX(NT.CreationDate), 
							'2000-02-15 10:48:39.330') ASC, NT.NodeTypeID ASC) AS RevRowNumber,
						NT.NodeTypeID,
						MAX(NT.SequenceNumber) AS SequenceNumber
				FROM [dbo].[CN_NodeTypes] AS NT
					LEFT JOIN [dbo].[CN_Services] AS S
					ON S.ApplicationID = @ApplicationID AND 
						S.NodeTypeID = NT.NodeTypeID AND S.Deleted = 0
					LEFT JOIN [dbo].[CN_Extensions] AS Ex
					ON @ExtensionsCount > 0 AND Ex.ApplicationID = @ApplicationID AND 
						Ex.OwnerID = NT.NodeTypeID AND Ex.Deleted = 0 AND
						Ex.Extension IN (SELECT XX.Value FROM @Extensions AS XX)
				WHERE NT.ApplicationID = @ApplicationID AND 
					(ISNULL(@IsKnowledge, 0) = 0 OR S.IsKnowledge = 1) AND
					(ISNULL(@IsDocument, 0) = 0 OR S.IsDocument = 1) AND
					(NT.Deleted = ISNULL(@Archive, 0)) AND
					(@ExtensionsCount = 0 OR Ex.OwnerID IS NOT NULL)
				GROUP BY NT.NodeTypeID
			) AS Ref
		WHERE Ref.RowNumber >= ISNULL(@LowerBoundary, 0)
		ORDER BY Ref.SequenceNumber ASC, Ref.RowNumber ASC
	END
	ELSE BEGIN
		INSERT INTO @IDs (NodeTypeID, TotalCount)
		SELECT TOP(@Count)
			Ref.NodeTypeID,
			(Ref.RowNumber + Ref.RevRowNumber - 1) AS TotalCount
		FROM (
				SELECT	ROW_NUMBER() OVER (ORDER BY MAX(SRCH.[Rank]) DESC, NT.NodeTypeID DESC) AS RowNumber,
						ROW_NUMBER() OVER (ORDER BY MAX(SRCH.[Rank]) ASC, NT.NodeTypeID ASC) AS RevRowNumber,
						NT.NodeTypeID,
						MAX(NT.SequenceNumber) AS SequenceNumber
				FROM CONTAINSTABLE([dbo].[CN_NodeTypes], ([Name]), @SearchText) AS SRCH
					INNER JOIN [dbo].[CN_NodeTypes] AS NT
					ON NT.ApplicationID = @ApplicationID AND NT.NodeTypeID = SRCH.[Key]
					LEFT JOIN [dbo].[CN_Services] AS S
					ON S.ApplicationID = @ApplicationID AND 
						S.NodeTypeID = NT.NodeTypeID AND S.Deleted = 0
					LEFT JOIN [dbo].[CN_Extensions] AS Ex
					ON @ExtensionsCount > 0 AND Ex.ApplicationID = @ApplicationID AND 
						Ex.OwnerID = NT.NodeTypeID AND Ex.Deleted = 0 AND
						Ex.Extension IN (SELECT XX.Value FROM @Extensions AS XX)
				WHERE (ISNULL(@IsKnowledge, 0) = 0 OR S.IsKnowledge = 1) AND
					(ISNULL(@IsDocument, 0) = 0 OR S.IsDocument = 1) AND
					(NT.Deleted = ISNULL(@Archive, 0)) AND
					(@ExtensionsCount = 0 OR Ex.OwnerID IS NOT NULL)
				GROUP BY NT.NodeTypeID
			) AS Ref
		WHERE Ref.RowNumber >= ISNULL(@LowerBoundary, 0)
		ORDER BY Ref.SequenceNumber ASC, Ref.RowNumber ASC
	END
	
	INSERT INTO @NodeTypeIDs (Value)
	SELECT Ref.NodeTypeID
	FROM @IDs AS Ref
	
	EXEC [dbo].[CN_P_GetNodeTypesByIDs] @ApplicationID, @NodeTypeIDs
	
	SELECT TOP(1) Ref.TotalCount
	FROM @IDs AS Ref
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_GetNodeType]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_GetNodeType]
GO

CREATE PROCEDURE [dbo].[CN_GetNodeType]
	@ApplicationID			uniqueidentifier,
	@NodeTypeID				uniqueidentifier,
	@NodeTypeAdditionalID	nvarchar(20),
	@NodeID					uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SET @NodeTypeID = ISNULL((SELECT TOP(1) NodeTypeID
		FROM [dbo].[CN_Nodes]
		WHERE ApplicationID = @ApplicationID AND NodeID = @NodeTypeID), @NodeTypeID)
	
	DECLARE @NodeTypeIDs KeyLessGuidTableType
	
	IF @NodeTypeID IS NOT NULL BEGIN
		INSERT INTO @NodeTypeIDs (Value)
		VALUES(@NodeTypeID)
	END
	ELSE IF @NodeID IS NOT NULL BEGIN
		INSERT INTO @NodeTypeIDs (Value)
		SELECT ND.NodeTypeID
		FROM [dbo].[CN_Nodes] AS ND
		WHERE ND.ApplicationID = @ApplicationID AND ND.[NodeID] = @NodeID
	END
	ELSE BEGIN
		INSERT INTO @NodeTypeIDs (Value)
		SELECT NodeTypeID
		FROM [dbo].[CN_NodeTypes]
		WHERE ApplicationID = @ApplicationID AND AdditionalID = @NodeTypeAdditionalID 
	END
	
	EXEC [dbo].[CN_P_GetNodeTypesByIDs] @ApplicationID, @NodeTypeIDs
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_HaveChildNodeTypes]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_HaveChildNodeTypes]
GO

CREATE PROCEDURE [dbo].[CN_HaveChildNodeTypes]
	@ApplicationID	uniqueidentifier,
	@strNodeTypeIDs	varchar(max),
	@delimiter		char
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @NodeTypeIDs GuidTableType
	INSERT INTO @NodeTypeIDs
	SELECT DISTINCT Ref.Value FROM [dbo].[GFN_StrToGuidTable](@strNodeTypeIDs, @delimiter) AS Ref
	
	SELECT ExternalIDs.Value AS ID
	FROM @NodeTypeIDs AS ExternalIDs
	WHERE EXISTS(
		SELECT TOP(1) * 
		FROM [dbo].[CN_NodeTypes] 
		WHERE ApplicationID = @ApplicationID AND 
			(ParentID = ExternalIDs.Value AND ParentID <> NodeTypeID) AND Deleted = 0
	)
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_GetChildNodeTypes]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_GetChildNodeTypes]
GO

CREATE PROCEDURE [dbo].[CN_GetChildNodeTypes]
	@ApplicationID	uniqueidentifier,
	@ParentID	uniqueidentifier,
	@Archive	bit
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @NodeTypeIDs KeyLessGuidTableType
	
	INSERT INTO @NodeTypeIDs (Value)
	SELECT NodeTypeID
	FROM [dbo].[CN_NodeTypes]
	WHERE ApplicationID = @ApplicationID AND
		((@ParentID IS NULL AND ParentID IS NULL) OR ParentID = @ParentID) AND 
		(@Archive IS NULL OR Deleted = @Archive)
	ORDER BY SequenceNumber ASC, CreationDate ASC
	
	EXEC [dbo].[CN_P_GetNodeTypesByIDs] @ApplicationID, @NodeTypeIDs
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_ArithmeticDeleteNodeTypes]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_ArithmeticDeleteNodeTypes]
GO

CREATE PROCEDURE [dbo].[CN_ArithmeticDeleteNodeTypes]
	@ApplicationID			uniqueidentifier,
    @strNodeTypeIDs 		varchar(max),
    @delimiter				char,
    @RemoveHierarchy		bit,
    @LastModifierUserID		uniqueidentifier,
    @LastModificationDate	datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @NodeTypeIDs GuidTableType
	
	INSERT INTO @NodeTypeIDs (Value)
	SELECT Ref.Value
	FROM [dbo].[GFN_StrToGuidTable](@strNodeTypeIDs, @delimiter) AS Ref
	
	IF ISNULL(@RemoveHierarchy, 0) = 0 BEGIN
		UPDATE NT
			SET Deleted = 1,
				LastModifierUserID = @LastModifierUserID,
				LastModificationDate = @LastModificationDate
		FROM @NodeTypeIDs AS Ref
			INNER JOIN [dbo].[CN_NodeTypes] AS NT
			ON NT.ApplicationID = @ApplicationID AND 
				NT.[NodeTypeID] = Ref.Value AND NT.[Deleted] = 0
		
		DECLARE @_Result int = @@ROWCOUNT
			
		UPDATE [dbo].[CN_NodeTypes]
			SET ParentID = NULL
		WHERE ApplicationID = @ApplicationID AND ParentID IN(SELECT * FROM @NodeTypeIDs)
		
		SELECT @_Result
	END
	ELSE BEGIN
		UPDATE NT
			SET Deleted = 1,
				LastModifierUserID = @LastModifierUserID,
				LastModificationDate = @LastModificationDate
		FROM [dbo].[CN_FN_GetChildNodeTypesHierarchy](@ApplicationID, @NodeTypeIDs) AS Ref
			INNER JOIN [dbo].[CN_NodeTypes] AS NT
			ON NT.ApplicationID = @ApplicationID AND NT.NodeTypeID = Ref.NodeTypeID
			
		SELECT @@ROWCOUNT
	END
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_RecoverNodeType]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_RecoverNodeType]
GO

CREATE PROCEDURE [dbo].[CN_RecoverNodeType]
	@ApplicationID			uniqueidentifier,
    @NodeTypeID 			uniqueidentifier,
    @LastModifierUserID		uniqueidentifier,
    @LastModificationDate	datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[CN_NodeTypes]
		SET Deleted = 0,
			LastModifierUserID = @LastModifierUserID,
			LastModificationDate = @LastModificationDate
	WHERE ApplicationID = @ApplicationID AND NodeTypeID = @NodeTypeID
	
	DECLARE @Result int = @@ROWCOUNT
	
	DECLARE @ParentDeleted bit = (
		SELECT TOP(1) P.Deleted
		FROM [dbo].[CN_NodeTypes] AS NT
			INNER JOIN [dbo].[CN_NodeTypes] AS P
			ON P.ApplicationID = @ApplicationID AND P.NodeTypeID = NT.ParentID
		WHERE NT.ApplicationID = @ApplicationID AND 
			NT.NodeTypeID = @NodeTypeID AND NT.ParentID IS NOT NULL
	)
	
	IF ISNULL(@ParentDeleted, 0) = 1 BEGIN
		UPDATE [dbo].[CN_NodeTypes]
			SET ParentID = NULL
		WHERE ApplicationID = @ApplicationID AND NodeTypeID = @NodeTypeID
	END

	SELECT @Result
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_AddRelationType]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_AddRelationType]
GO

CREATE PROCEDURE [dbo].[CN_AddRelationType]
	@ApplicationID	uniqueidentifier,
    @RelationTypeID uniqueidentifier,
    @Name			nvarchar(255),
    @Description	nvarchar(max),
    @CreatorUserID	uniqueidentifier,
    @CreationDate	datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SET @Name = [dbo].[GFN_VerifyString](@Name)
	SET @Description = [dbo].[GFN_VerifyString](@Description)
	
	IF EXISTS(
		SELECT TOP(1) * 
		FROM [dbo].[CN_Properties]
		WHERE ApplicationID = @ApplicationID AND Name = @Name AND Deleted = 1
	) BEGIN
		UPDATE [dbo].[CN_Properties]
			SET Deleted = 0
		WHERE ApplicationID = @ApplicationID AND Name = @Name AND Deleted = 1
	END
	ELSE BEGIN
		INSERT INTO [dbo].[CN_Properties](
			ApplicationID,
			PropertyID,
			Name,
			[Description],
			CreatorUserID,
			CreationDate,
			Deleted
		)
		VALUES(
			@ApplicationID,
			@RelationTypeID,
			@Name,
			@Description,
			@CreatorUserID,
			@CreationDate,
			0
		)
	END

	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_ModifyRelationType]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_ModifyRelationType]
GO

CREATE PROCEDURE [dbo].[CN_ModifyRelationType]
	@ApplicationID			uniqueidentifier,
    @RelationTypeID 		uniqueidentifier,
    @Name					nvarchar(255),
    @Description			nvarchar(max),
    @LastModifierUserID		uniqueidentifier,
    @LastModificationDate	datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SET @Name = [dbo].[GFN_VerifyString](@Name)
	SET @Description = [dbo].[GFN_VerifyString](@Description)
	
	UPDATE [dbo].[CN_Properties]
		SET Name = @Name,
			[Description] = @Description,
			LastModifierUserID = @LastModifierUserID,
			LastModificationDate = @LastModificationDate
	WHERE ApplicationID = @ApplicationID AND PropertyID = @RelationTypeID

	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_GetRelationTypes]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_GetRelationTypes]
GO

CREATE PROCEDURE [dbo].[CN_GetRelationTypes]
	@ApplicationID	uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT PropertyID AS RelationTypeID,
		   Name,
		   AdditionalID
	FROM [dbo].[CN_Properties]
	WHERE ApplicationID = @ApplicationID AND Deleted = 0
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_ArithmeticDeleteRelationType]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_ArithmeticDeleteRelationType]
GO

CREATE PROCEDURE [dbo].[CN_ArithmeticDeleteRelationType]
	@ApplicationID			uniqueidentifier,
    @RelationTypeID 		uniqueidentifier,
    @LastModifierUserID		uniqueidentifier,
    @LastModificationDate	datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[CN_Properties]
		SET Deleted = 1,
			LastModifierUserID = @LastModifierUserID,
			LastModificationDate = @LastModificationDate
	WHERE ApplicationID = @ApplicationID AND PropertyID = @RelationTypeID

	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_P_AddRelation]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_P_AddRelation]
GO

CREATE PROCEDURE [dbo].[CN_P_AddRelation]
	@ApplicationID		uniqueidentifier,
	@RelationsTemp		GuidTripleTableType readonly,
    @CreatorUserID		uniqueidentifier,
    @CreationDate		datetime,
    @SetNullsToDefault	bit,
    @_Result			int output
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @Relations GuidTripleTableType
	INSERT INTO @Relations SELECT * FROM @RelationsTemp
	
	SET @_Result = -1
	
	DECLARE @VerifiedRelations GuidTripleTableType
	INSERT INTO @VerifiedRelations SELECT * FROM @Relations
	
	IF @SetNullsToDefault = 1 BEGIN
		DECLARE @_RelatedRelationTypeID uniqueidentifier = 
			[dbo].[CN_FN_GetRelatedRelationTypeID](@ApplicationID)
			
		UPDATE @VerifiedRelations
			SET ThirdValue = @_RelatedRelationTypeID
		WHERE ThirdValue = N'00000000-0000-0000-0000-000000000000'
	END
	
	DECLARE @_existingRelations GuidTripleTableType, 
		@_notExistingRelations GuidTripleTableType
	DECLARE @_count int
	
	INSERT INTO @_existingRelations
	SELECT RN.FirstValue, RN.SecondValue, RN.ThirdValue
	FROM @VerifiedRelations AS RN
		INNER JOIN [dbo].[CN_NodeRelations] AS NR
		ON NR.SourceNodeID = RN.FirstValue AND NR.DestinationNodeID = RN.SecondValue
	WHERE NR.ApplicationID = @ApplicationID AND NR.PropertyID = RN.ThirdValue
	
	SET @_count = (SELECT COUNT(*) FROM @_existingRelations)
	
	IF @_count > 0 BEGIN
		UPDATE [dbo].[CN_NodeRelations]
			SET LastModifierUserID = @CreatorUserID,
				LastModificationDate = @CreationDate,
				Deleted = 0
		FROM @_existingRelations AS ER
			INNER JOIN [dbo].[CN_NodeRelations] AS NR
			ON NR.SourceNodeID = ER.FirstValue AND NR.DestinationNodeID = ER.SecondValue
		WHERE NR.ApplicationID = @ApplicationID AND NR.PropertyID = ER.ThirdValue
		
		IF @@ROWCOUNT <= 0 RETURN
	END
	
	
	INSERT INTO @_notExistingRelations
	SELECT RN.FirstValue, RN.SecondValue, RN.ThirdValue
	FROM @VerifiedRelations AS RN
	WHERE NOT EXISTS(SELECT TOP(1) * FROM @_existingRelations AS Ref
		WHERE RN.FirstValue = Ref.FirstValue AND RN.SecondValue = Ref.SecondValue)
	
	SET @_count = (SELECT COUNT(*) FROM @_notExistingRelations)
	
	IF @_count > 0 BEGIN
		INSERT INTO [dbo].[CN_NodeRelations](
			ApplicationID,
			SourceNodeID,
			DestinationNodeID,
			PropertyID,
			CreatorUserID,
			CreationDate,
			Deleted,
			UniqueID
		)
		SELECT @ApplicationID, NER.FirstValue, NER.SecondValue, NER.ThirdValue, 
			@CreatorUserID, @CreationDate, 0, NEWID()
		FROM @_notExistingRelations AS NER
	
		IF @@ROWCOUNT <= 0 RETURN
	END	

	SET @_Result = 1
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_AddRelation]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_AddRelation]
GO

CREATE PROCEDURE [dbo].[CN_AddRelation]
	@ApplicationID		uniqueidentifier,
	@strRelations		varchar(max),
	@innerDelimiter		char,
	@outerDelimiter		char,
    @CreatorUserID		uniqueidentifier,
    @CreationDate		datetime
WITH ENCRYPTION
AS
BEGIN TRANSACTION
	SET NOCOUNT ON
	
	DECLARE @Relations GuidTripleTableType
	INSERT INTO @Relations(FirstValue, SecondValue, ThirdValue)
	SELECT Ref.FirstValue, Ref.SecondValue, Ref.ThirdValue
	FROM [dbo].[GFN_StrToGuidTripleTable](@strRelations, @innerDelimiter, @outerDelimiter) 
		AS Ref
	
	DECLARE @_Result int
	
	EXEC [dbo].[CN_P_AddRelation] @ApplicationID, @Relations, 
		@CreatorUserID, @CreationDate, 1, @_Result output
	
	IF @_Result <= 0 BEGIN
		SELECT -1
		ROLLBACK TRANSACTION
		RETURN
	END
		
	SELECT @_Result
COMMIT TRANSACTION

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_SaveRelations]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_SaveRelations]
GO

CREATE PROCEDURE [dbo].[CN_SaveRelations]
	@ApplicationID		uniqueidentifier,
	@NodeID				uniqueidentifier,
	@strRelatedNodeIDs	varchar(max),
	@delimiter			char,
    @CreatorUserID		uniqueidentifier,
    @CreationDate		datetime
WITH ENCRYPTION
AS
BEGIN TRANSACTION
	SET NOCOUNT ON
	
	IF EXISTS(
		SELECT TOP(1) * 
		FROM [dbo].[CN_NodeRelations]
		WHERE ApplicationID = @ApplicationID AND SourceNodeID = @NodeID AND Deleted = 0
	) BEGIN
		UPDATE [dbo].[CN_NodeRelations]
			SET Deleted = 1
		WHERE ApplicationID = @ApplicationID AND SourceNodeID = @NodeID AND Deleted = 0
		
		IF @@ROWCOUNT <= 0 BEGIN
			SELECT -1
			ROLLBACK TRANSACTION
			RETURN
		END
	END
	
	DECLARE @_RelatedRelationTypeID uniqueidentifier = [dbo].[CN_FN_GetRelatedRelationTypeID](@ApplicationID)
	
	DECLARE @Relations GuidTripleTableType
	INSERT INTO @Relations(FirstValue, SecondValue, ThirdValue)
	SELECT @NodeID, Ref.Value, @_RelatedRelationTypeID
	FROM [dbo].[GFN_StrToGuidTable](@strRelatedNodeIDs, @delimiter) AS Ref
	
	DECLARE @_Result int
	
	EXEC [dbo].[CN_P_AddRelation] @ApplicationID, @Relations, 
		@CreatorUserID, @CreationDate, 1, @_Result output
	
	IF @_Result <= 0 BEGIN
		SELECT -1
		ROLLBACK TRANSACTION
		RETURN
	END
		
	SELECT @_Result
COMMIT TRANSACTION

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_P_MakeParent]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_P_MakeParent]
GO

CREATE PROCEDURE [dbo].[CN_P_MakeParent]
	@ApplicationID		uniqueidentifier,
	@PairNodeIDsTemp	GuidPairTableType readonly,
    @CreatorUserID		uniqueidentifier,
    @CreationDate		datetime,
    @_Result			int output
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @PairNodeIDs GuidPairTableType
	INSERT INTO @PairNodeIDs SELECT * FROM @PairNodeIDsTemp
	
	SET @_Result = -1
	
	DECLARE @_ParentRelationTypeID uniqueidentifier,
		@_ChildRelationTypeID uniqueidentifier
	SET @_ParentRelationTypeID = [dbo].[CN_FN_GetParentRelationTypeID](@ApplicationID)
	SET @_ChildRelationTypeID = [dbo].[CN_FN_GetChildRelationTypeID](@ApplicationID)
	
	DECLARE @Relations GuidTripleTableType
	
	INSERT INTO @Relations (FirstValue, SecondValue, ThirdValue)
	SELECT Ref.FirstValue, Ref.SecondValue, @_ParentRelationTypeID
	FROM @PairNodeIDs AS Ref
	
	INSERT INTO @Relations (FirstValue, SecondValue, ThirdValue)
	SELECT Ref.SecondValue, Ref.FirstValue, @_ChildRelationTypeID
	FROM @PairNodeIDs AS Ref
		
	EXEC [dbo].[CN_P_AddRelation] @ApplicationID, @Relations, 
		@CreatorUserID, @CreationDate, 0, @_Result output
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_P_MakeCorrelation]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_P_MakeCorrelation]
GO

CREATE PROCEDURE [dbo].[CN_P_MakeCorrelation]
	@ApplicationID		uniqueidentifier,
	@PairNodeIDsTemp	GuidPairTableType readonly,
    @CreatorUserID		uniqueidentifier,
    @CreationDate		datetime,
    @_Result			int output
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @PairNodeIDs GuidPairTableType
	INSERT INTO @PairNodeIDs SELECT * FROM @PairNodeIDsTemp
	
	DECLARE @_RelatedRelationTypeID uniqueidentifier
	SET @_RelatedRelationTypeID = [dbo].[CN_FN_GetRelatedRelationTypeID](@ApplicationID)
	
	DECLARE @Relations GuidTripleTableType
	
	INSERT INTO @Relations (FirstValue, SecondValue, ThirdValue)
	SELECT Ref.FirstValue, Ref.SecondValue, @_RelatedRelationTypeID
	FROM @PairNodeIDs AS Ref
	
	INSERT INTO @Relations (FirstValue, SecondValue, ThirdValue)
	SELECT Ref.SecondValue, Ref.FirstValue, @_RelatedRelationTypeID
	FROM @PairNodeIDs AS Ref
		
	EXEC [dbo].[CN_P_AddRelation] @ApplicationID, @Relations, 
		@CreatorUserID, @CreationDate, 0, @_Result output
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_MakeParent]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_MakeParent]
GO

CREATE PROCEDURE [dbo].[CN_MakeParent]
	@ApplicationID		uniqueidentifier,
	@strPairNodeIDs		varchar(max),
	@innerDelimiter		char,
	@outerDelimiter		char,
    @CreatorUserID		uniqueidentifier,
    @CreationDate		datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @PairNodeIDs GuidPairTableType
	INSERT INTO @PairNodeIDs (FirstValue, SecondValue)
	SELECT Ref.FirstValue, Ref.SecondValue
	FROM dbo.GFN_StrToGuidPairTable(@strPairNodeIDs, @innerDelimiter, @outerDelimiter) AS Ref
	
	DECLARE @_Result int
	
	EXEC [dbo].[CN_P_MakeParent] @ApplicationID, @PairNodeIDs, @CreatorUserID, 
		@CreationDate, @_Result output

	SELECT @_Result
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_MakeCorrelation]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_MakeCorrelation]
GO

CREATE PROCEDURE [dbo].[CN_MakeCorrelation]
	@ApplicationID		uniqueidentifier,
	@strPairNodeIDs		varchar(max),
	@innerDelimiter		char,
	@outerDelimiter		char,
    @CreatorUserID		uniqueidentifier,
    @CreationDate		datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @PairNodeIDs GuidPairTableType
	INSERT INTO @PairNodeIDs (FirstValue, SecondValue)
	SELECT Ref.FirstValue, Ref.SecondValue
	FROM dbo.GFN_StrToGuidPairTable(@strPairNodeIDs, @innerDelimiter, @outerDelimiter) AS Ref
	
	DECLARE @_Result int
	
	EXEC [dbo].[CN_P_MakeCorrelation] @ApplicationID, @PairNodeIDs, @CreatorUserID, 
		@CreationDate, @_Result output

	SELECT @_Result
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_P_ArithmeticDeleteRelations]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_P_ArithmeticDeleteRelations]
GO

CREATE PROCEDURE [dbo].[CN_P_ArithmeticDeleteRelations]
	@ApplicationID			uniqueidentifier,
	@PairNodeIDsTemp		GuidPairTableType readonly,
    @RelationTypeID 		uniqueidentifier,
    @LastModifierUserID		uniqueidentifier,
    @LastModificationDate	datetime,
    @ReverseAlso			bit,
    @_Result				int output
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @PairNodeIDs GuidPairTableType
	INSERT INTO @PairNodeIDs SELECT * FROM @PairNodeIDsTemp
	
	DECLARE @_PairIDs GuidPairTableType
	
	INSERT INTO @_PairIDs (FirstValue, SecondValue)
	SELECT Ref.FirstValue, Ref.SecondValue FROM @PairNodeIDs AS Ref
	
	IF @ReverseAlso = 1 BEGIN
		INSERT INTO @_PairIDs (FirstValue, SecondValue)
		SELECT Ref.SecondValue, Ref.FirstValue
		FROM @PairNodeIDs AS Ref 
		WHERE NOT EXISTS(
			SELECT TOP(1) * 
			FROM @PairNodeIDs AS PN
			WHERE Ref.SecondValue = PN.FirstValue AND Ref.FirstValue = PN.SecondValue
		)
	END
	
	UPDATE NR
		SET LastModifierUserID = @LastModifierUserID,
			LastModificationDate = @LastModificationDate,
			Deleted = 1
	FROM @_PairIDs AS ExternalIDs
		INNER JOIN [dbo].[CN_NodeRelations] AS NR
		ON NR.ApplicationID = @ApplicationID AND NR.[SourceNodeID] = ExternalIDs.FirstValue AND
			NR.[DestinationNodeID] = ExternalIDs.SecondValue
	WHERE (@RelationTypeID IS NULL OR PropertyID = @RelationTypeID) AND Deleted = 0

	SET @_Result = @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_ArithmeticDeleteRelations]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_ArithmeticDeleteRelations]
GO

CREATE PROCEDURE [dbo].[CN_ArithmeticDeleteRelations]
	@ApplicationID			uniqueidentifier,
	@strPairNodeIDs			varchar(max),
	@innerDelimiter			char,
	@outerDelimiter			char,
    @RelationTypeID 		uniqueidentifier,
    @LastModifierUserID		uniqueidentifier,
    @LastModificationDate	datetime,
    @ReverseAlso			bit
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @PairNodeIDs GuidPairTableType
	INSERT INTO @PairNodeIDs (FirstValue, SecondValue)
	SELECT Ref.FirstValue, Ref.SecondValue
	FROM [dbo].[GFN_StrToGuidPairTable](@strPairNodeIDs, @innerDelimiter, @outerDelimiter) AS Ref

	DECLARE @_Result int
	
	EXEC [dbo].[CN_P_ArithmeticDeleteRelations] @ApplicationID, @PairNodeIDs, @RelationTypeID,
		@LastModifierUserID, @LastModificationDate, @ReverseAlso, @_Result output

	SELECT @_Result
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_ArithmeticDeleteCorrelations]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_ArithmeticDeleteCorrelations]
GO

CREATE PROCEDURE [dbo].[CN_ArithmeticDeleteCorrelations]
	@ApplicationID			uniqueidentifier,
	@strPairNodeIDs			varchar(max),
	@innerDelimiter			char,
	@outerDelimiter			char,
    @LastModifierUserID		uniqueidentifier,
    @LastModificationDate	datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @_RelatedRelationTypeID uniqueidentifier
	SET @_RelatedRelationTypeID = [dbo].[CN_FN_GetRelatedRelationTypeID](@ApplicationID)
	
	DECLARE @PairNodeIDs GuidPairTableType
	INSERT INTO @PairNodeIDs (FirstValue, SecondValue)
	SELECT Ref.FirstValue, Ref.SecondValue
	FROM [dbo].[GFN_StrToGuidPairTable](@strPairNodeIDs, @innerDelimiter, @outerDelimiter) AS Ref

	DECLARE @_Result int
	
	EXEC [dbo].[CN_P_ArithmeticDeleteRelations] @ApplicationID, @PairNodeIDs, 
		@_RelatedRelationTypeID, @LastModifierUserID, @LastModificationDate, 1, @_Result output

	SELECT @_Result
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_Unparent]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_Unparent]
GO

CREATE PROCEDURE [dbo].[CN_Unparent]
	@ApplicationID			uniqueidentifier,
	@strPairNodeIDs			varchar(max),
	@innerDelimiter			char,
	@outerDelimiter			char,
	@LastModifierUserID		uniqueidentifier,
    @LastModificationDate	datetime
WITH ENCRYPTION
AS
BEGIN TRANSACTION
	SET NOCOUNT ON
	
	DECLARE @_ParentRelationTypeID uniqueidentifier,
		@_ChildRelationTypeID uniqueidentifier
	SET @_ParentRelationTypeID = [dbo].[CN_FN_GetParentRelationTypeID](@ApplicationID)
	SET @_ChildRelationTypeID = [dbo].[CN_FN_GetChildRelationTypeID](@ApplicationID)
	
	DECLARE @PairNodeIDs GuidPairTableType
	INSERT INTO @PairNodeIDs (FirstValue, SecondValue)
	SELECT Ref.FirstValue, Ref.SecondValue
	FROM [dbo].[GFN_StrToGuidPairTable](@strPairNodeIDs, @innerDelimiter, @outerDelimiter) AS Ref

	DECLARE @_Result int
	
	EXEC [dbo].[CN_P_ArithmeticDeleteRelations] @ApplicationID, @PairNodeIDs, 
		@_ParentRelationTypeID, @LastModifierUserID, @LastModificationDate, 0, @_Result output
		
	IF @_Result <= 0 BEGIN
		SELECT -1
		ROLLBACK TRANSACTION
		RETURN
	END
	
	DECLARE @_ReversePairs GuidPairTableType
	INSERT INTO @_ReversePairs (FirstValue, SecondValue)
	SELECT Ref.SecondValue, Ref.FirstValue
	FROM @PairNodeIDs AS Ref

	EXEC [dbo].[CN_P_ArithmeticDeleteRelations] @ApplicationID, @_ReversePairs, 
		@_ChildRelationTypeID, @LastModifierUserID, @LastModificationDate, 0, @_Result output
		
	IF @_Result <= 0 BEGIN
		SELECT -1
		ROLLBACK TRANSACTION
		RETURN
	END

	SELECT 1
COMMIT TRANSACTION

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_P_ArithmeticDeleteAllRelations]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_P_ArithmeticDeleteAllRelations]
GO

CREATE PROCEDURE [dbo].[CN_P_ArithmeticDeleteAllRelations]
	@ApplicationID			uniqueidentifier,
	@NodeID					uniqueidentifier,
	@LastModifierUserID		uniqueidentifier,
	@LastModificationDate	datetime,
    @_Result				int output
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	IF EXISTS(
		SELECT TOP(1) * 
		FROM [dbo].[CN_NodeRelations]
		WHERE ApplicationID = @ApplicationID AND 
			(SourceNodeID = @NodeID OR DestinationNodeID = @NodeID) AND Deleted = 0
	) BEGIN
		UPDATE [dbo].[CN_NodeRelations]
			SET Deleted = 1,
				LastModifierUserID = @LastModifierUserID,
				LastModificationDate = @LastModificationDate
		WHERE ApplicationID = @ApplicationID AND 
			(SourceNodeID = @NodeID OR DestinationNodeID = @NodeID) AND Deleted = 0
		
		SET @_Result = @@ROWCOUNT
	END
	ELSE BEGIN
		SET @_Result = 1
	END
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_P_AddAcceptedMembers]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_P_AddAcceptedMembers]
GO

CREATE PROCEDURE [dbo].[CN_P_AddAcceptedMembers]
	@ApplicationID	uniqueidentifier,
	@MembersTemp	GuidPairTableType readonly,
    @Now			datetime,
    @_Result		int output
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @Members GuidPairTableType
	INSERT INTO @Members SELECT * FROM @MembersTemp
	
	IF NOT EXISTS(SELECT TOP(1) * FROM @Members) BEGIN
		SET @_Result = 1
		RETURN
	END
	
	DECLARE @Status varchar(20) = N'Accepted'
	
	DECLARE @TBL TABLE (
		NodeID				uniqueidentifier NOT NULL,
		UserID				uniqueidentifier NOT NULL,
		NodeTypeID			uniqueidentifier NOT NULL,
		UniqueMembership	bit NULL
	)
	
	INSERT INTO @TBL (NodeID, UserID, NodeTypeID, UniqueMembership)
	SELECT ND.NodeID, M.SecondValue, ND.NodeTypeID, ISNULL(S.UniqueMembership, 0)
	FROM @Members AS M
		INNER JOIN [dbo].[CN_Nodes] AS ND
		ON ND.ApplicationID = @ApplicationID AND ND.NodeID = M.FirstValue
		LEFT JOIN [dbo].[CN_Services] AS S
		ON S.ApplicationID = @ApplicationID AND S.NodeTypeID = ND.NodeTypeID
	
	-- Remove existing members with UniqueMembership enabled
	UPDATE NM
		SET Deleted = 1
	FROM (
			SELECT T.UserID, T.NodeTypeID
			FROM @TBL AS T
			WHERE T.UniqueMembership = 1
			GROUP BY T.UserID, T.NodeTypeID
		) AS X
		INNER JOIN [dbo].[CN_Nodes] AS ND
		ON ND.ApplicationID = @ApplicationID AND ND.NodeTypeID = X.NodeTypeID
		INNER JOIN [dbo].[CN_NodeMembers] AS NM
		ON NM.ApplicationID = @ApplicationID AND 
			NM.NodeID = ND.NodeID AND NM.UserID = X.UserID
	-- end of Remove existing members with UniqueMembership enabled
	
	-- Update existing items
	UPDATE NM
		SET Deleted = 0,
			[Status] = @Status,
			AcceptionDate = ISNULL(AcceptionDate, @Now),
			IsAdmin = CASE WHEN Deleted = 1 THEN 0 ELSE IsAdmin END,
			MembershipDate = ISNULL(MembershipDate, @Now)
	FROM @TBL AS T
		INNER JOIN [dbo].[CN_NodeMembers] AS NM
		ON NM.ApplicationID = @ApplicationID AND 
			NM.NodeID = T.NodeID AND NM.UserID = T.UserID
	-- end of Update existing items
	
	SET @_Result = @@ROWCOUNT
	
	-- Insert New Items
	INSERT INTO [dbo].[CN_NodeMembers](
		ApplicationID,
		NodeID,
		UserID,
		MembershipDate,
		IsAdmin,
		[Status],
		AcceptionDate,
		Deleted,
		UniqueID
	)
	SELECT @ApplicationID, T.NodeID, T.UserID, @Now, 0, @Status, @Now, 0, NEWID()
	FROM @TBL AS T
		LEFT JOIN [dbo].[CN_NodeMembers] AS NM
		ON NM.ApplicationID = @ApplicationID AND 
			NM.NodeID = T.NodeID AND NM.UserID = T.UserID
	WHERE NM.NodeID IS NULL
	-- end of Insert New Items
    
    SET @_Result = @@ROWCOUNT + @_Result
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_P_UpdateMembers]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_P_UpdateMembers]
GO

CREATE PROCEDURE [dbo].[CN_P_UpdateMembers]
	@ApplicationID		uniqueidentifier,
	@MembersTemp		GuidPairTableType readonly,
    @MembershipDate		datetime,
    @IsAdmin			bit,
    @IsPending			bit,
    @AcceptionDate		datetime,
    @Position			nvarchar(255),
    @Deleted			bit,
    @_Result			int output
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @Members GuidPairTableType
	INSERT INTO @Members SELECT * FROM @MembersTemp
	
	IF NOT EXISTS(SELECT TOP(1) * FROM @Members) BEGIN
		SET @_Result = 1
		RETURN
	END
	
	DECLARE @Status varchar(20) = NULL
	
	IF @IsPending IS NOT NULL
		SET @Status = (CASE WHEN @IsPending = 1 THEN N'Pending' ELSE N'Accepted' END)
		
	DECLARE @TBL Table (
		NodeID			uniqueidentifier NOT NULL,
		UserID			uniqueidentifier NOT NULL,
		MembershipDate	datetime,
		IsAdmin			bit NOT NULL,
		[Status]		varchar(20) NOT NULL,
		AcceptionDate	datetime,
		Position		nvarchar(255),
		Deleted			bit NOT NULL,
		[Exists]		bit NOT NULL,
		UniqueID		uniqueidentifier NOT NULL
	)
	
	INSERT INTO @TBL(
		NodeID,
		UserID,
		MembershipDate,
		IsAdmin,
		[Status],
		AcceptionDate,
		Position,
		Deleted,
		[Exists],
		UniqueID
	)
	SELECT	M.FirstValue,
			M.SecondValue,
			ISNULL(@MembershipDate, NM.MembershipDate),
			ISNULL(ISNULL(@IsAdmin, NM.IsAdmin), 0),
			ISNULL(ISNULL(@Status, NM.[Status]), N'Accepted'),
			ISNULL(@AcceptionDate, NM.AcceptionDate),
			ISNULL(@Position, NM.Position),
			ISNULL(ISNULL(@Deleted, NM.Deleted), 0),
			CAST((CASE WHEN NM.NodeID IS NULL THEN 0 ELSE 1 END) AS bit) AS [Exists],
			ISNULL(NM.UniqueID, NEWID()) AS UniqueID
	FROM @Members AS M
		LEFT JOIN [dbo].[CN_NodeMembers] AS NM
		ON NM.ApplicationID = @ApplicationID AND 
			NM.NodeID = M.FirstValue AND NM.UserID = M.SecondValue
	
	-- Update Existing Data
	UPDATE NM
		SET MembershipDate = T.MembershipDate,
			IsAdmin = T.IsAdmin,
			[Status] = T.[Status],
			AcceptionDate = T.AcceptionDate,
			Position = T.Position,
			Deleted = T.Deleted
	FROM @TBL AS T
		INNER JOIN [dbo].[CN_NodeMembers] AS NM
		ON NM.ApplicationID = @ApplicationID AND 
			NM.NodeID = T.NodeID AND NM.UserID = T.UserID
	WHERE T.[Exists] = 1
	-- end of Update Existing Data
	
	SET @_Result = @@ROWCOUNT
	
	-- Insert New Data
	INSERT INTO [dbo].[CN_NodeMembers](
		ApplicationID,
		NodeID,
		UserID,
		MembershipDate,
		IsAdmin,
		[Status],
		AcceptionDate,
		Position,
		Deleted,
		UniqueID
	)
	SELECT	@ApplicationID,
			Ref.NodeID, 
			Ref.UserID, 
			Ref.MembershipDate, 
			Ref.IsAdmin, 
			Ref.[Status], 
			Ref.AcceptionDate, 
			Ref.Position, 
			Ref.Deleted,
			Ref.UniqueID
	FROM @TBL AS Ref
	WHERE Ref.[Exists] = 0
	-- end of Insert New Data
    
    SET @_Result = @@ROWCOUNT + @_Result
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_P_UpdateMember]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_P_UpdateMember]
GO

CREATE PROCEDURE [dbo].[CN_P_UpdateMember]
	@ApplicationID		uniqueidentifier,
	@NodeID				uniqueidentifier,
	@UserID				uniqueidentifier,
    @MembershipDate		datetime,
    @IsAdmin			bit,
    @IsPending			bit,
    @AcceptionDate		datetime,
    @Position			nvarchar(255),
    @Deleted			bit,
    @_Result			int output
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @Members GuidPairTableType
	
	INSERT INTO @Members (FirstValue, SecondValue)
	VALUES (@NodeID, @UserID)
	
	EXEC [dbo].[CN_P_UpdateMembers] @ApplicationID, @Members, @MembershipDate, 
		@IsAdmin, @IsPending, @AcceptionDate, @Position, @Deleted, @_Result output
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_P_AddMember]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_P_AddMember]
GO

CREATE PROCEDURE [dbo].[CN_P_AddMember]
	@ApplicationID		uniqueidentifier,
    @NodeID				uniqueidentifier,
    @UserID				uniqueidentifier,
    @MembershipDate		datetime,
    @IsAdmin			bit,
    @IsPending			bit,
    @AcceptionDate		datetime,
    @Position			nvarchar(255),
    @_Result			int output
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @NodeTypeID uniqueidentifier
	DECLARE @UniqueMembership bit, @UniqueAdmin bit
	
	SELECT	@NodeTypeID = ND.NodeTypeID, 
			@UniqueMembership = ISNULL(S.UniqueMemberShip, 0), 
			@UniqueAdmin = ISNULL(S.UniqueAdminMember, 0)
	FROM [dbo].[CN_Nodes] AS ND
		LEFT JOIN [dbo].[CN_Services] AS S
		ON S.ApplicationID = @ApplicationID AND S.NodeTypeID = ND.NodeTypeID
	WHERE ND.ApplicationID = @ApplicationID AND ND.NodeID = @NodeID
	
	IF @UniqueMembership = 1 BEGIN
		DECLARE @Members GuidPairTableType
		
		INSERT INTO @Members
		SELECT NM.NodeID, NM.UserID
		FROM [dbo].[CN_NodeMembers] AS NM
			INNER JOIN [dbo].[CN_Nodes] AS ND 
			ON ND.ApplicationID = @ApplicationID AND 
				ND.NodeTypeID = @NodeTypeID AND ND.NodeID = NM.NodeID
		WHERE NM.ApplicationID = @ApplicationID AND NM.UserID = @UserID AND NM.Deleted = 0
		
		EXEC [dbo].[CN_P_UpdateMembers] @ApplicationID, @Members, 
			NULL, NULL, NULL, NULL, NULL, 1, @_Result output
		
		IF @_Result <= 0 RETURN
	END
	
	EXEC [dbo].[CN_P_UpdateMember] @ApplicationID, @NodeID, @UserID, @MembershipDate, 
		@IsAdmin, @IsPending, @AcceptionDate, @Position, 0, @_Result output
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_P_AddNode]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_P_AddNode]
GO

CREATE PROCEDURE [dbo].[CN_P_AddNode]
	@ApplicationID			uniqueidentifier,
    @NodeID					uniqueidentifier,
    @AdditionalID			varchar(50),
    @NodeTypeID				uniqueidentifier,
    @NodeTypeAdditionalID	nvarchar(50),
    @DocumentTreeNodeID		uniqueidentifier,
    @PreviousVersionID		uniqueidentifier,
    @Name					nvarchar(255),
    @Description			nvarchar(max),
    @Tags					nvarchar(2000),
    @Searchable				bit,
    @CreatorUserID			uniqueidentifier,
    @CreationDate			datetime,
    @ParentNodeID			uniqueidentifier,
    @OwnerID				uniqueidentifier,
    @AddMember				bit,
    @_Result				int output,
    @_ErrorMessage			varchar(1000) output
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SET @Name = [dbo].[GFN_VerifyString](@Name)
	SET @Description = [dbo].[GFN_VerifyString](@Description)
	SET @Tags = [dbo].[GFN_VerifyString](@Tags)
	
	SET @_Result = -1
	
	IF @NodeTypeID IS NULL 
		SET @NodeTypeID = [dbo].[CN_FN_GetNodeTypeID](@ApplicationID, @NodeTypeAdditionalID)
		
	IF @NodeTypeID IS NULL AND @ParentNodeID IS NOT NULL
		SET @NodeTypeID = (
			SELECT NodeTypeID 
			FROM [dbo].[CN_Nodes] 
			WHERE ApplicationID = @ApplicationID AND NodeID = @ParentNodeID
		)
			
	
	IF EXISTS(
		SELECT TOP(1) * 
		FROM [dbo].[CN_Nodes]
		WHERE ApplicationID = @ApplicationID AND NodeTypeID = @NodeTypeID AND 
			@AdditionalID IS NOT NULL AND @AdditionalID <> '' AND AdditionalID = @AdditionalID
	) BEGIN
		SET @_Result = -50
		SET @_ErrorMessage = N'AdditionalIDAlreadyExists'
		RETURN
	END
	
	SET @Searchable = ISNULL(@Searchable, CAST(1 AS bit))
	IF @PreviousVersionID = @NodeID SET @PreviousVersionID = NULL
	
	INSERT INTO [dbo].[CN_Nodes](
		ApplicationID,
		NodeID,
		AdditionalID,
		NodeTypeID,
		DocumentTreeNodeID,
		PreviousVersionID,
		Name,
		[Description],
		Tags,
		CreatorUserID,
		CreationDate,
		Deleted,
		ParentNodeID,
		OwnerID,
		Searchable
	)
	VALUES(
		@ApplicationID,
		@NodeID,
		@AdditionalID,
		@NodeTypeID,
		@DocumentTreeNodeID,
		@PreviousVersionID,
		@Name,
		@Description,
		@Tags,
		@CreatorUserID,
		@CreationDate,
		0,
		@ParentNodeID,
		@OwnerID,
		@Searchable
	)
	
	EXEC [dbo].[PRVC_P_AddAudience] @ApplicationID, @NodeID, @NodeID, N'View',
		1, NULL, NULL, NULL, @_Result output
	
	IF @_Result <= 0 BEGIN
		SET @_Result = -3
		RETURN
	END
	
	IF @AddMember = 1 BEGIN
		EXEC [dbo].[CN_P_AddMember] @ApplicationID, @NodeID, @CreatorUserID, 
			@CreationDate, 1, 0, @CreationDate, NULL, @_Result output
		
		IF @_Result <= 0 BEGIN
			SET @_Result = -4
			RETURN
		END
	END
	
	IF @Searchable = 1 AND @PreviousVersionID IS NOT NULL BEGIN
		UPDATE [dbo].[CN_Nodes]
			SET Searchable = 0
		WHERE ApplicationID = @ApplicationID AND NodeID = @PreviousVersionID
	END

	SET @_Result = 1
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_AddNode]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_AddNode]
GO

CREATE PROCEDURE [dbo].[CN_AddNode]
	@ApplicationID			uniqueidentifier,
    @NodeID					uniqueidentifier,
    @AdditionalID_Main		varchar(300),
    @AdditionalID			varchar(50),
    @NodeTypeID				uniqueidentifier,
    @NodeTypeAdditionalID	nvarchar(20),
    @DocumentTreeNodeID		uniqueidentifier,
    @Name					nvarchar(255),
    @Description			nvarchar(max),
    @Tags					nvarchar(2000),
    @Searchable				bit,
    @CreatorUserID			uniqueidentifier,
    @CreationDate			datetime,
    @ParentNodeID			uniqueidentifier,
    @AddMember				bit
WITH ENCRYPTION
AS
BEGIN TRANSACTION
	SET NOCOUNT ON
	
	DECLARE @_Result int, @_ErrorMessage varchar(1000)
	
	SET @Searchable = ISNULL(@Searchable, 1)
	
	EXEC [dbo].[CN_P_AddNode] @ApplicationID, @NodeID, @AdditionalID, @NodeTypeID, 
		@NodeTypeAdditionalID, @DocumentTreeNodeID, NULL, @Name, @Description, @Tags, 
		@Searchable, @CreatorUserID, @CreationDate, @ParentNodeID, null, 
		@AddMember, @_Result output, @_ErrorMessage output
		
	UPDATE [dbo].[CN_Nodes]
		SET AdditionalID_Main = @AdditionalID_Main
	WHERE ApplicationID = @ApplicationID AND NodeID = @NodeID
	
	SELECT @_Result
	
	IF @_Result <= 0 ROLLBACK TRANSACTION
COMMIT TRANSACTION

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_SetAdditionalID]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_SetAdditionalID]
GO

CREATE PROCEDURE [dbo].[CN_SetAdditionalID]
	@ApplicationID		uniqueidentifier,
    @ID					uniqueidentifier,
    @AdditionalID_Main	varchar(300),
    @AdditionalID		varchar(50),
    @CurrentUserID		uniqueidentifier,
    @Now				datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	IF EXISTS(
		SELECT TOP(1) NodeID 
		FROM [dbo].[CN_Nodes] 
		WHERE ApplicationID = @ApplicationID AND NodeID = @ID
	) BEGIN
		UPDATE [dbo].[CN_Nodes]
			SET AdditionalID_Main = @AdditionalID_Main,
				AdditionalID = @AdditionalID,
				LastModifierUserID = @CurrentUserID,
				LastModificationDate = @Now
		WHERE ApplicationID = @ApplicationID AND NodeID = @ID
	END
	ELSE BEGIN
		UPDATE [dbo].[CN_NodeTypes]
			SET AdditionalID = @AdditionalID,
				LastModifierUserID = @CurrentUserID,
				LastModificationDate = @Now
		WHERE ApplicationID = @ApplicationID AND NodeTypeID = @ID
	END
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_P_ModifyNode]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_P_ModifyNode]
GO

CREATE PROCEDURE [dbo].[CN_P_ModifyNode]
	@ApplicationID			uniqueidentifier,
    @NodeID					uniqueidentifier,
    @Name					nvarchar(255),
    @Description			nvarchar(max),
    @Tags					nvarchar(2000),
    @LastModifierUserID		uniqueidentifier,
    @LastModificationDate	datetime,
    @_Result				int output
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SET @Name = [dbo].[GFN_VerifyString](@Name)
	SET @Description = [dbo].[GFN_VerifyString](@Description)
	SET @Tags = [dbo].[GFN_VerifyString](@Tags)
	
	UPDATE [dbo].[CN_Nodes]
		SET Name = CASE WHEN ISNULL(@Name, N'') = N'' THEN Name ELSE @Name END,
			[Description] = @Description,
			Tags = @Tags,
			LastModifierUserID = @LastModifierUserID,
			LastModificationDate = @LastModificationDate
	WHERE ApplicationID = @ApplicationID AND NodeID = @NodeID

	SET @_Result = @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_ChangeNodeType]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_ChangeNodeType]
GO

CREATE PROCEDURE [dbo].[CN_ChangeNodeType]
	@ApplicationID			uniqueidentifier,
    @NodeID					uniqueidentifier,
    @NodeTypeID				uniqueidentifier,
    @LastModifierUserID		uniqueidentifier,
    @LastModificationDate	datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[CN_Nodes]
		SET NodeTypeID = @NodeTypeID,
			LastModifierUserID = @LastModifierUserID,
			LastModificationDate = @LastModificationDate
	WHERE ApplicationID = @ApplicationID AND NodeID = @NodeID

	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_SetDocumentTreeNodeID]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_SetDocumentTreeNodeID]
GO

CREATE PROCEDURE [dbo].[CN_SetDocumentTreeNodeID]
	@ApplicationID			uniqueidentifier,
    @strNodeIDs				varchar(max),
	@delimiter				char,
    @DocumentTreeNodeID		uniqueidentifier,
    @LastModifierUserID		uniqueidentifier,
    @LastModificationDate	datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @NodeIDs GuidTableType
	INSERT INTO @NodeIDs
	SELECT Ref.Value FROM [dbo].[GFN_StrToGuidTable](@strNodeIDs, @delimiter) AS Ref
	
	UPDATE [dbo].[CN_Nodes]
		SET DocumentTreeNodeID = @DocumentTreeNodeID,
			LastModifierUserID = @LastModifierUserID,
			LastModificationDate = @LastModificationDate
	FROM @NodeIDs AS Ref
		INNER JOIN [dbo].[CN_Nodes] AS ND
		ON ND.ApplicationID = @ApplicationID AND ND.[NodeID] = Ref.Value
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_P_ModifyNodeName]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_P_ModifyNodeName]
GO

CREATE PROCEDURE [dbo].[CN_P_ModifyNodeName]
	@ApplicationID			uniqueidentifier,
    @NodeID					uniqueidentifier,
    @Name					nvarchar(255),
    @LastModifierUserID		uniqueidentifier,
    @LastModificationDate	datetime,
    @_Result				int output
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SET @Name = [dbo].[GFN_VerifyString](@Name)
	
	UPDATE [dbo].[CN_Nodes]
		SET Name = @Name,
			LastModifierUserID = @LastModifierUserID,
			LastModificationDate = @LastModificationDate
	WHERE ApplicationID = @ApplicationID AND NodeID = @NodeID

	SET @_Result = @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_P_ModifyNodeDescription]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_P_ModifyNodeDescription]
GO

CREATE PROCEDURE [dbo].[CN_P_ModifyNodeDescription]
	@ApplicationID			uniqueidentifier,
    @NodeID					uniqueidentifier,
    @Description			nvarchar(max),
    @LastModifierUserID		uniqueidentifier,
    @LastModificationDate	datetime,
    @_Result				int output
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SET @Description = [dbo].[GFN_VerifyString](@Description)
	
	UPDATE [dbo].[CN_Nodes]
		SET [Description] = @Description,
			LastModifierUserID = @LastModifierUserID,
			LastModificationDate = @LastModificationDate
	WHERE ApplicationID = @ApplicationID AND NodeID = @NodeID

	SET @_Result = @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_ModifyNodeTags]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_ModifyNodeTags]
GO

CREATE PROCEDURE [dbo].[CN_ModifyNodeTags]
	@ApplicationID			uniqueidentifier,
    @NodeID					uniqueidentifier,
    @Tags					nvarchar(max),
    @LastModifierUserID		uniqueidentifier,
    @LastModificationDate	datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SET @Tags = [dbo].[GFN_VerifyString](@Tags)
	
	UPDATE [dbo].[CN_Nodes]
		SET [Tags] = @Tags,
			LastModifierUserID = @LastModifierUserID,
			LastModificationDate = @LastModificationDate
	WHERE ApplicationID = @ApplicationID AND NodeID = @NodeID

	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_P_ModifyNodeWFState]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_P_ModifyNodeWFState]
GO

CREATE PROCEDURE [dbo].[CN_P_ModifyNodeWFState]
	@ApplicationID			uniqueidentifier,
    @NodeID					uniqueidentifier,
    @WFState				nvarchar(1000),
    @HideCreators			bit,
    @LastModifierUserID		uniqueidentifier,
    @LastModificationDate	datetime,
    @_Result				int output
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SET @WFState = [dbo].[GFN_VerifyString](@WFState)
	
	UPDATE [dbo].[CN_Nodes]
		SET WFState = @WFState,
			HideCreators = ISNULL(@HideCreators, 0),
			LastModifierUserID = @LastModifierUserID,
			LastModificationDate = @LastModificationDate
	WHERE ApplicationID = @ApplicationID AND NodeID = @NodeID

	SET @_Result = @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_ModifyNode]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_ModifyNode]
GO

CREATE PROCEDURE [dbo].[CN_ModifyNode]
	@ApplicationID			uniqueidentifier,
    @NodeID					uniqueidentifier,
    @Name					nvarchar(255),
    @Description			nvarchar(max),
    @Tags					nvarchar(2000),
    @LastModifierUserID		uniqueidentifier,
    @LastModificationDate	datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @_Result int
	
	EXEC [dbo].[CN_P_ModifyNode] @ApplicationID, @NodeID, @Name, @Description, @Tags, 
		@LastModifierUserID, @LastModificationDate, @_Result output

	SELECT @_Result
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_ModifyNodeName]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_ModifyNodeName]
GO

CREATE PROCEDURE [dbo].[CN_ModifyNodeName]
	@ApplicationID			uniqueidentifier,
    @NodeID					uniqueidentifier,
    @Name					nvarchar(255),
    @LastModifierUserID		uniqueidentifier,
    @LastModificationDate	datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @_Result int
	
	EXEC [dbo].[CN_P_ModifyNodeName] @ApplicationID, @NodeID, @Name, 
		@LastModifierUserID, @LastModificationDate, @_Result output

	SELECT @_Result
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_ModifyNodeDescription]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_ModifyNodeDescription]
GO

CREATE PROCEDURE [dbo].[CN_ModifyNodeDescription]
	@ApplicationID			uniqueidentifier,
    @NodeID					uniqueidentifier,
    @Description			nvarchar(max),
    @LastModifierUserID		uniqueidentifier,
    @LastModificationDate	datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @_Result int
	
	EXEC [dbo].[CN_P_ModifyNodeDescription] @ApplicationID, @NodeID, @Description, 
		@LastModifierUserID, @LastModificationDate, @_Result output

	SELECT @_Result
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_ModifyNodePublicDescription]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_ModifyNodePublicDescription]
GO

CREATE PROCEDURE [dbo].[CN_ModifyNodePublicDescription]
	@ApplicationID	uniqueidentifier,
    @NodeID			uniqueidentifier,
    @Description	nvarchar(max)
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[CN_Nodes]
		SET PublicDescription = [dbo].[GFN_VerifyString](@Description)
	WHERE ApplicationID = @ApplicationID AND NodeID = @NodeID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_SetNodeExpirationDate]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_SetNodeExpirationDate]
GO

CREATE PROCEDURE [dbo].[CN_SetNodeExpirationDate]
	@ApplicationID	uniqueidentifier,
    @NodeID			uniqueidentifier,
    @ExpirationDate	datetime
WITH ENCRYPTION
AS
BEGIN TRANSACTION
	SET NOCOUNT ON
	
	UPDATE [dbo].[CN_Nodes]
		SET ExpirationDate = @ExpirationDate
	WHERE ApplicationID = @ApplicationID AND NodeID = @NodeID
	
	-- remove dashboards
	IF @ExpirationDate IS NULL BEGIN
		DECLARE @_Result int = 0
    
		EXEC [dbo].[NTFN_P_ArithmeticDeleteDashboards] @ApplicationID, 
			NULL, @NodeID, NULL, N'Knowledge', N'ExpirationDate', 
			@_Result output
			
		IF @_Result <= 0 BEGIN
			SELECT -1
			ROLLBACK TRANSACTION
			RETURN
		END
	END
	-- end of remove dashboards
	
	SELECT 1
COMMIT TRANSACTION

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_SetExpiredNodesAsNotSearchable]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_SetExpiredNodesAsNotSearchable]
GO

CREATE PROCEDURE [dbo].[CN_SetExpiredNodesAsNotSearchable]
	@ApplicationID	uniqueidentifier,
    @Now			datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[CN_Nodes]
		SET Searchable = 0
	WHERE ApplicationID = @ApplicationID AND 
		ExpirationDate < @Now AND Deleted = 0
	
	SELECT @@ROWCOUNT + 1
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_GetNodeIDsThatWillBeExpiredSoon]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_GetNodeIDsThatWillBeExpiredSoon]
GO

CREATE PROCEDURE [dbo].[CN_GetNodeIDsThatWillBeExpiredSoon]
	@ApplicationID	uniqueidentifier,
    @Date			datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT ND.NodeID AS ID
	FROM [dbo].[CN_Nodes] AS ND
		LEFT JOIN [dbo].[NTFN_Dashboards] AS D
		ON D.ApplicationID = @ApplicationID AND D.NodeID = ND.NodeID AND 
			D.Deleted = 0 AND D.Done = 0 AND
			D.[Type] = N'Knowledge' AND D.SubType = N'ExpirationDate'
	WHERE ND.ApplicationID = @ApplicationID AND ND.Deleted = 0 AND
		ND.ExpirationDate IS NOT NULL AND ND.ExpirationDate <= @Date AND
		D.ID IS NULL
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_NotifyNodeExpiration]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_NotifyNodeExpiration]
GO

CREATE PROCEDURE [dbo].[CN_NotifyNodeExpiration]
	@ApplicationID	uniqueidentifier,
    @NodeID			uniqueidentifier,
    @UserID			uniqueidentifier,
    @Now			datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	-- Send new dashboards
    IF @UserID IS NOT NULL BEGIN
		DECLARE @Dashboards DashboardTableType
		
		INSERT INTO @Dashboards(UserID, NodeID, RefItemID, [Type], SubType, Removable, SendDate)
		VALUES (@UserID, @NodeID, @NodeID, N'Knowledge', N'ExpirationDate', 0, @Now)
		
		DECLARE @_Result int = 0
		
		EXEC [dbo].[NTFN_P_SendDashboards] @ApplicationID, @Dashboards, @_Result output
		
		IF @_Result <= 0 BEGIN
			SELECT -1
			ROLLBACK TRANSACTION
			RETURN
		END
		ELSE BEGIN
			SELECT * 
			FROM @Dashboards
		END
	END
	-- end of send new dashboards
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_SetPreviousVersion]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_SetPreviousVersion]
GO

CREATE PROCEDURE [dbo].[CN_SetPreviousVersion]
	@ApplicationID			uniqueidentifier,
    @NodeID					uniqueidentifier,
    @PreviousVersionID		uniqueidentifier,
    @LastModifierUserID		uniqueidentifier,
    @LastModificationDate	datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[CN_Nodes]
		SET PreviousVersionID = @PreviousVersionID,
			LastModifierUserID = @LastModifierUserID,
			LastModificationDate = @LastModificationDate
	WHERE ApplicationID = @ApplicationID AND NodeID = @NodeID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_GetPreviousVersions]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_GetPreviousVersions]
GO

CREATE PROCEDURE [dbo].[CN_GetPreviousVersions]
	@ApplicationID	uniqueidentifier,
    @NodeID			uniqueidentifier,
    @CurrentUserID	uniqueidentifier,
	@CheckPrivacy	bit,
	@Now			datetime,
	@DefaultPrivacy	varchar(50)
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON

	DECLARE @NodeIDs KeyLessGuidTableType
	
	;WITH hirarchy (NodeID, PreviousVersionID, [Level], Name)
	AS
	(
		SELECT NodeID, PreviousVersionID, 0 AS [Level], Name
		FROM [dbo].[CN_Nodes]
		WHERE ApplicationID = @ApplicationID AND NodeID = @NodeID
		
		UNION ALL
		
		SELECT ND.NodeID, ND.PreviousVersionID, [Level] + 1, ND.Name
		FROM [dbo].[CN_Nodes] AS ND
			INNER JOIN hirarchy AS HR
			ON ND.ApplicationID = @ApplicationID AND ND.NodeID = HR.PreviousVersionID
		WHERE ND.NodeID <> HR.NodeID AND ND.Deleted = 0
	)
	
	INSERT INTO @NodeIDs (Value)
	SELECT NodeID
	FROM hirarchy
	WHERE NodeID <> @NodeID
	ORDER BY [Level] ASC
	
	IF @CheckPrivacy = 1 BEGIN
		DECLARE @RetIDs GuidTableType
	
		DECLARE	@PermissionTypes StringPairTableType
		
		INSERT INTO @PermissionTypes (FirstValue, SecondValue)
		VALUES (N'View', @DefaultPrivacy)
	
		INSERT INTO @RetIDs (Value)
		SELECT Ref.ID
		FROM [dbo].[PRVC_FN_CheckAccess](@ApplicationID, @CurrentUserID, 
			@NodeIDs, N'Node', @Now, @PermissionTypes) AS Ref
		
		DELETE @NodeIDs
		
		INSERT INTO @NodeIDs (Value)
		SELECT Ref.Value
		FROM @RetIDs AS Ref
	END
	
	EXEC [dbo].[CN_P_GetNodesByIDs] @ApplicationID, @NodeIDs, NULL, NULL
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_GetNewVersions]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_GetNewVersions]
GO

CREATE PROCEDURE [dbo].[CN_GetNewVersions]
	@ApplicationID	uniqueidentifier,
    @NodeID			uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @NodeIDs KeyLessGuidTableType
	
	INSERT INTO @NodeIDs (Value)
	SELECT NodeID
	FROM [dbo].[CN_Nodes]
	WHERE ApplicationID = @ApplicationID AND PreviousVersionID = @NodeID AND Deleted = 0
	
	EXEC [dbo].[CN_P_GetNodesByIDs] @ApplicationID, @NodeIDs, NULL, NULL
	
	/*
	;WITH hierarchy (ID, ParentID, [Level], Name)
	AS
	(
		SELECT NodeID AS ID, PreviousVersionID AS ParentID, 0 AS [Level], Name AS Name
		FROM [dbo].[CN_Nodes]
		WHERE NodeID = @NodeID
		
		UNION ALL
		
		SELECT ND.NodeID AS ID, ND.PreviousVersionID AS ParentID, 
			[Level] + 1, ND.Name AS Name
		FROM [dbo].[CN_Nodes] AS ND
			INNER JOIN hierarchy AS HR
			ON ND.PreviousVersionID = HR.ID
		WHERE ND.NodeID <> HR.ID AND ND.Deleted = 0
	)

	SELECT * FROM hierarchy
	*/
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_GetNodeDescription]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_GetNodeDescription]
GO

CREATE PROCEDURE [dbo].[CN_GetNodeDescription]
	@ApplicationID	uniqueidentifier,
    @NodeID			uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT [Description]
	FROM [dbo].[CN_Nodes]
	WHERE ApplicationID = @ApplicationID AND NodeID = @NodeID
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_SetNodesSearchability]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_SetNodesSearchability]
GO

CREATE PROCEDURE [dbo].[CN_SetNodesSearchability]
	@ApplicationID			uniqueidentifier,
    @strNodeIDs				varchar(max),
    @delimiter				char,
    @Searchable				bit,
    @LastModifierUserID		uniqueidentifier,
    @LastModificationDate	datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON

	DECLARE @NodeIDs GuidTableType
	
	INSERT INTO @NodeIDs
	SELECT Ref.Value
	FROM [dbo].[GFN_StrToGuidTable](@strNodeIDs, @delimiter) AS Ref

    UPDATE ND
        SET Searchable = @Searchable,
			LastModifierUserID = @LastModifierUserID,
			LastModificationDate = @LastModificationDate
    FROM @NodeIDs AS Ref
		INNER JOIN [dbo].[CN_Nodes] AS ND
		ON ND.ApplicationID = @ApplicationID AND ND.[NodeID] = Ref.Value
	
	SELECT @@ROWCOUNT
END 

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_P_ArithmeticDeleteNodes]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_P_ArithmeticDeleteNodes]
GO

CREATE PROCEDURE [dbo].[CN_P_ArithmeticDeleteNodes]
	@ApplicationID			uniqueidentifier,
    @NodeIDsTemp			GuidTableType readonly,
    @RemoveHierarchy		bit,
    @LastModifierUserID		uniqueidentifier,
    @LastModificationDate	datetime,
    @_Result				int output
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @NodeIDs GuidTableType
	INSERT INTO @NodeIDs SELECT * FROM @NodeIDsTemp

	IF ISNULL(@RemoveHierarchy, 0) = 0 BEGIN
		UPDATE ND
			SET Deleted = 1,
				LastModifierUserID = @LastModifierUserID,
				LastModificationDate = @LastModificationDate
		FROM @NodeIDs AS Ref
			INNER JOIN [dbo].[CN_Nodes] AS ND
			ON ND.ApplicationID = @ApplicationID AND 
				ND.[NodeID] = Ref.Value AND ND.[Deleted] = 0
		
		SET @_Result = @@ROWCOUNT
			
		UPDATE [dbo].[CN_Nodes]
			SET ParentNodeID = NULL
		WHERE ApplicationID = @ApplicationID AND ParentNodeID IN(SELECT * FROM @NodeIDs)
	END
	ELSE BEGIN
		UPDATE ND
			SET Deleted = 1,
				LastModifierUserID = @LastModifierUserID,
				LastModificationDate = @LastModificationDate
		FROM [dbo].[CN_FN_GetChildNodesHierarchy](@ApplicationID, @NodeIDs) AS Ref
			INNER JOIN [dbo].[CN_Nodes] AS ND
			ON ND.ApplicationID = @ApplicationID AND ND.NodeID = Ref.NodeID
			
		SELECT @@ROWCOUNT
	END
END 

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_ArithmeticDeleteNodes]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_ArithmeticDeleteNodes]
GO

CREATE PROCEDURE [dbo].[CN_ArithmeticDeleteNodes]
	@ApplicationID			uniqueidentifier,
    @strNodeIDs				varchar(max),
    @delimiter				char,
    @RemoveHierarchy		bit,
    @LastModifierUserID		uniqueidentifier,
    @LastModificationDate	datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON

	DECLARE @NodeIDs GuidTableType
	
	INSERT INTO @NodeIDs
	SELECT DISTINCT Ref.Value FROM GFN_StrToGuidTable(@strNodeIDs, @delimiter) AS Ref
	
	DECLARE @_Result int

	EXEC [dbo].[CN_P_ArithmeticDeleteNodes] @ApplicationID, @NodeIDs, @RemoveHierarchy, 
		@LastModifierUserID, @LastModificationDate, @_Result output

    SELECT @_Result
END 

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_RecycleNodes]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_RecycleNodes]
GO

CREATE PROCEDURE [dbo].[CN_RecycleNodes]
	@ApplicationID	uniqueidentifier,
    @strNodeIDs		varchar(max),
    @delimiter		char,
    @CurrentUserID	uniqueidentifier,
    @Now			datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON

	UPDATE ND
		SET Deleted = 0,
			LastModifierUserID = @CurrentUserID,
			LastModificationDate = @Now
	FROM [dbo].[GFN_StrToGuidTable](@strNodeIDs, @delimiter) AS Ref
		INNER JOIN [dbo].[CN_Nodes] AS ND
		ON ND.ApplicationID = @ApplicationID AND 
			ND.[NodeID] = Ref.Value AND ND.[Deleted] = 1
	
	SELECT @@ROWCOUNT
END 

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_SetNodeTypesOrder]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_SetNodeTypesOrder]
GO

CREATE PROCEDURE [dbo].[CN_SetNodeTypesOrder]
	@ApplicationID	uniqueidentifier,
	@strIDs	varchar(max),
	@delimiter		char
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @IDs TABLE (
		SequenceNo int identity(1, 1) primary key, 
		ID uniqueidentifier
	)
	
	INSERT INTO @IDs (ID)
	SELECT Ref.Value
	FROM [dbo].[GFN_StrToGuidTable](@strIDs, @delimiter) AS Ref
	
	DECLARE @ParentID uniqueidentifier = NULL
	
	SELECT TOP(1) @ParentID = ParentID
	FROM [dbo].[CN_NodeTypes]
	WHERE ApplicationID = @ApplicationID AND 
		NodeTypeID = (SELECT TOP (1) Ref.ID FROM @IDs AS Ref)
	
	INSERT INTO @IDs (ID)
	SELECT NT.NodeTypeID
	FROM @IDs AS Ref
		RIGHT JOIN [dbo].[CN_NodeTypes] AS NT
		ON NT.ApplicationID = @ApplicationID AND NT.NodeTypeID = Ref.ID
	WHERE NT.ApplicationID = @ApplicationID AND (
			(NT.ParentID IS NULL AND @ParentID IS NULL) OR 
			NT.ParentID = @ParentID
		) AND Ref.ID IS NULL
	ORDER BY NT.SequenceNumber
	
	UPDATE [dbo].[CN_NodeTypes]
		SET SequenceNumber = Ref.SequenceNo
	FROM @IDs AS Ref
		INNER JOIN [dbo].[CN_NodeTypes] AS NT
		ON NT.NodeTypeID = Ref.ID
	WHERE NT.ApplicationID = @ApplicationID AND (
			(NT.ParentID IS NULL AND @ParentID IS NULL) OR 
			NT.ParentID = @ParentID
		)
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_SetNodesOrder]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_SetNodesOrder]
GO

CREATE PROCEDURE [dbo].[CN_SetNodesOrder]
	@ApplicationID	uniqueidentifier,
	@strIDs	varchar(max),
	@delimiter		char
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @IDs TABLE (
		SequenceNo int identity(1, 1) primary key, 
		ID uniqueidentifier
	)
	
	INSERT INTO @IDs (ID)
	SELECT Ref.Value
	FROM [dbo].[GFN_StrToGuidTable](@strIDs, @delimiter) AS Ref
	
	DECLARE @ParentID uniqueidentifier = NULL, @TypeID uniqueidentifier = NULL
	
	SELECT TOP(1) @ParentID = ParentNodeID, @TypeID = NodeTypeID
	FROM [dbo].[CN_Nodes]
	WHERE ApplicationID = @ApplicationID AND 
		NodeID = (SELECT TOP (1) Ref.ID FROM @IDs AS Ref)
	
	INSERT INTO @IDs (ID)
	SELECT ND.NodeID
	FROM @IDs AS Ref
		RIGHT JOIN [dbo].[CN_Nodes] AS ND
		ON ND.ApplicationID = @ApplicationID AND ND.NodeID = Ref.ID
	WHERE ND.ApplicationID = @ApplicationID AND ND.NodeTypeID = @TypeID AND (
			(ND.ParentNodeID IS NULL AND @ParentID IS NULL) OR 
			ND.ParentNodeID = @ParentID
		) AND Ref.ID IS NULL
	ORDER BY ND.SequenceNumber
	
	UPDATE [dbo].[CN_Nodes]
		SET SequenceNumber = Ref.SequenceNo
	FROM @IDs AS Ref
		INNER JOIN [dbo].[CN_Nodes] AS ND
		ON ND.NodeID = Ref.ID
	WHERE ND.ApplicationID = @ApplicationID AND ND.NodeTypeID = @TypeID AND (
			(ND.ParentNodeID IS NULL AND @ParentID IS NULL) OR 
			ND.ParentNodeID = @ParentID
		)
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_GetNodesCount]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_GetNodesCount]
GO

CREATE PROCEDURE [dbo].[CN_GetNodesCount]
	@ApplicationID			uniqueidentifier,
    @strNodeTypeIDs			varchar(max),
    @delimiter				char,
    @NodeTypeAddtionalID	nvarchar(255),
    @LowerCreationDateLimit datetime,
    @UpperCreationDateLimit	datetime,
    @Root					bit,
    @Archive				bit
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	IF @Root = 0 SET @Root = NULL
	
	DECLARE @NodeTypeIDs GuidTableType
	INSERT INTO @NodeTypeIDs
	SELECT DISTINCT Ref.Value
	FROM [dbo].[GFN_StrToGuidTable](@strNodeTypeIDs, @delimiter) AS Ref
	
	IF @NodeTypeAddtionalID IS NOT NULL AND (SELECT COUNT(*) FROM @NodeTypeIDs) = 0 BEGIN
		INSERT INTO @NodeTypeIDs
		VALUES ([dbo].[CN_FN_GetNodeTypeID](@ApplicationID, @NodeTypeAddtionalID))
	END
	
	IF (SELECT COUNT(*) FROM @NodeTypeIDs) = 0 BEGIN
		INSERT INTO @NodeTypeIDs
		SELECT NodeTypeID
		FROM [dbo].[CN_NodeTypes]
		WHERE ApplicationID = @ApplicationID AND Deleted = 0
	END
	
	SELECT Ref.NodeTypeID AS NodeTypeID, 
		   ISNULL(NT.AdditionalID, N'') AS NodeTypeAdditionalID, 
		   NT.Name AS TypeName,
		   Ref.NodesCount AS NodesCount
	FROM (
			SELECT CVN.NodeTypeID AS NodeTypeID, 
				COUNT(CVN.NodeID) AS NodesCount
			FROM @NodeTypeIDs AS NTIDs
				INNER JOIN [dbo].[CN_Nodes] AS CVN
				ON CVN.ApplicationID = @ApplicationID AND CVN.NodeTypeID = NTIDs.Value
			WHERE (@LowerCreationDateLimit IS NULL OR 
				CVN.CreationDate >= @LowerCreationDateLimit) AND
				(@UpperCreationDateLimit IS NULL OR 
				CVN.CreationDate <= @UpperCreationDateLimit) AND
				(@Root IS NULL OR CVN.ParentNodeID IS NULL) AND
				(@Archive IS NULL OR CVN.Deleted = @Archive)
			GROUP BY CVN.NodeTypeID
		) AS Ref
		LEFT JOIN dbo.CN_NodeTypes AS NT
		ON NT.ApplicationID = @ApplicationID AND NT.NodeTypeID = Ref.NodeTypeID
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_GetMostPopulatedNodeTypes]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_GetMostPopulatedNodeTypes]
GO

CREATE PROCEDURE [dbo].[CN_GetMostPopulatedNodeTypes]
	@ApplicationID	uniqueidentifier,
	@Count			int,
	@LowerBoundary	int
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	IF ISNULL(@Count, 0) <= 0 SET @Count = 10000
	
	SELECT TOP(@Count) 
		Ref.RowNumber AS [Order],
		Ref.RevRowNumber AS [ReverseOrder],
		Ref.NodeTypeID AS NodeTypeID,
		Ref.TypeAdditionalID AS NodeTypeAdditionalID,
		Ref.NodeType AS TypeName,
		Ref.[Count] AS NodesCount
	FROM (
			SELECT	ROW_NUMBER() OVER (ORDER BY X.[Count] DESC, X.NodeTypeID DESC) AS RowNumber, 
					ROW_NUMBER() OVER (ORDER BY X.[Count] ASC, X.NodeTypeID ASC) AS RevRowNumber,
					X.*
			FROM (
					SELECT	NodeTypeID,
							MAX(ND.TypeAdditionalID) AS TypeAdditionalID,
							MAX(ND.TypeName) AS NodeType, 
							COUNT(ND.NodeID) AS [Count]
					FROM [dbo].[CN_View_Nodes_Normal] AS ND
					WHERE ND.ApplicationID = @ApplicationID AND 
						ND.TypeDeleted = 0 AND ND.Deleted = 0
					GROUP BY ND.NodeTypeID
				) AS X
		) AS Ref
	WHERE Ref.RowNumber >= ISNULL(@LowerBoundary, 0)
	ORDER BY Ref.RowNumber ASC
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_GetNodeRecordsCount]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_GetNodeRecordsCount]
GO

CREATE PROCEDURE [dbo].[CN_GetNodeRecordsCount]
	@ApplicationID	uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT (COUNT(*) + 1) 
	FROM [dbo].[CN_Nodes]
	WHERE ApplicationID = @ApplicationID
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_GetNodeTypeIDs]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_GetNodeTypeIDs]
GO

CREATE PROCEDURE [dbo].[CN_GetNodeTypeIDs]
	@ApplicationID			uniqueidentifier,
	@NodeTypeAdditionalIDs	nvarchar(max),
	@delimiter				char
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT X.ID
	FROM (
			SELECT [dbo].[CN_FN_GetNodeTypeID](@ApplicationID, Ref.Value) AS ID
			FROM [dbo].[GFN_StrToStringTable](@NodeTypeAdditionalIDs, @delimiter) AS Ref
		) AS X
	WHERE X.ID IS NOT NULL
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_GetNodeIDs]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_GetNodeIDs]
GO

CREATE PROCEDURE [dbo].[CN_GetNodeIDs]
	@ApplicationID			uniqueidentifier,
	@NodeAdditionalIDsTemp	StringTableType readonly,
    @NodeTypeID				uniqueidentifier,
    @NodeTypeAddtionalID	nvarchar(255)
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @NodeAdditionalIDs StringTableType
	INSERT INTO @NodeAdditionalIDs SELECT * FROM @NodeAdditionalIDsTemp
	
	IF @NodeTypeID IS NULL
		SET @NodeTypeID = [dbo].[CN_FN_GetNodeTypeID](@ApplicationID, @NodeTypeAddtionalID)
	
	SELECT NodeID AS ID
	FROM @NodeAdditionalIDs AS ExternalIDs 
		INNER JOIN [dbo].[CN_Nodes] AS ND
		ON ND.AdditionalID = ExternalIDs.Value
	WHERE ND.ApplicationID = @ApplicationID AND ND.NodeTypeID = @NodeTypeID
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_GetNodeIDsByAdditionalIDs]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_GetNodeIDsByAdditionalIDs]
GO

CREATE PROCEDURE [dbo].[CN_GetNodeIDsByAdditionalIDs]
	@ApplicationID	uniqueidentifier,
	@NodesTemp		StringPairTableType readonly
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @Nodes StringPairTableType
	INSERT INTO @Nodes SELECT * FROM @NodesTemp
	
	SELECT ND.NodeID AS ID
	FROM @Nodes AS Ref
		INNER JOIN [dbo].[CN_View_Nodes_Normal] AS ND
		ON ND.ApplicationID = @ApplicationID AND 
			ND.NodeAdditionalID = Ref.FirstValue AND ND.TypeAdditionalID = Ref.SecondValue
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_P_GetNodesByIDs]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_P_GetNodesByIDs]
GO

CREATE PROCEDURE [dbo].[CN_P_GetNodesByIDs]
	@ApplicationID	uniqueidentifier,
    @NodeIDsTemp	KeyLessGuidTableType readonly,
    @Full			bit,
    @ViewerUserID	uniqueidentifier
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @NodeIDs KeyLessGuidTableType
	INSERT INTO @NodeIDs (Value) SELECT Value FROM @NodeIDsTemp
	
	IF @Full IS NULL OR @Full = 0 BEGIN
		SELECT	ND.[NodeID] AS NodeID, 
				ND.[NodeName] AS Name,
				ND.[NodeAdditionalID_Main] AS AdditionalID_Main,
				ND.[NodeAdditionalID] AS AdditionalID,
				ND.[NodeTypeID] AS NodeTypeID,
				ND.[TypeName] AS NodeType,
				ND.[TypeAdditionalID] AS NodeTypeAdditionalID,
				ND.[ParentNodeID] AS ParentNodeID,
				ND.CreatorUserID AS CreatorUserID,
				ND.[CreationDate] AS CreationDate,
				ND.AreaID AS AdminAreaID,
				ND.DocumentTreeNodeID,
				ND.[Status],
				ND.[WFState],
				ND.Searchable,
				ND.HideCreators,
				ND.Deleted AS Archive
		FROM	@NodeIDs AS Ref
				INNER JOIN [dbo].[CN_View_Nodes_Normal] AS ND 
				ON ND.ApplicationID = @ApplicationID AND ND.[NodeID] = Ref.Value
		ORDER BY Ref.SequenceNumber ASC
	END
	ELSE BEGIN
		SELECT	Node.[NodeID] AS NodeID, 
				Node.[Name] AS Name,
				Node.[AdditionalID_Main] AS AdditionalID_Main,
				Node.[AdditionalID] AS AdditionalID,
				Node.DocumentTreeNodeID,
				TR.TreeID AS DocumentTreeID,
				TR.Name AS DocumentTreeName,
				PVersion.NodeID AS PreviousVersionID,
				PVersion.Name AS PreviousVersionName,
				Node.[Description] AS [Description],
				Node.PublicDescription,
				Node.[Tags] AS Tags,
				Node.[NodeTypeID] AS NodeTypeID,
				NY.[Name] AS NodeType,
				NY.[AdditionalID] AS NodeTypeAdditionalID,
				Node.CreatorUserID AS CreatorUserID,
				USR.UserName AS CreatorUserName,
				USR.FirstName AS CreatorFirstName,
				USR.LastName AS CreatorLastName,
				Node.CreationDate AS CreationDate,
				Node.ParentNodeID AS ParentNodeID,
				Node.[Status],
				Node.[WFState],
				ISNULL(Node.Searchable, 1) AS Searchable,
				ISNULL(Node.HideCreators, 0) AS HideCreators,
				Node.PublicationDate AS PublicationDate,
				Node.ExpirationDate,
				Node.Score AS Score,
				Area.NodeID AS AdminAreaID,
			    Area.NodeName AS AdminAreaName,
			    Area.TypeName AS AdminAreaType,
				CL.ID AS ConfidentialityLevelID,
				CL.LevelID AS ConfidentialityLevelNum,
			    CL.Title AS ConfidentialityLevel,
				OW.NodeID AS OwnerID,
				OW.Name AS OwnerName,
				Node.Deleted AS Archive,
				(
					SELECT COUNT(*) 
					FROM [dbo].[CN_NodeLikes] AS NL
					WHERE NL.ApplicationID = @ApplicationID AND 
						NL.[NodeID] = ExternalIDs.Value AND NL.[Deleted] = 0
				) AS LikesCount,
				(
					SELECT CAST(1 AS bit) 
					FROM [dbo].[CN_NodeLikes] AS NL
					WHERE NL.ApplicationID = @ApplicationID AND 
						NL.[NodeID] = ExternalIDs.Value AND 
						NL.[UserID] = @ViewerUserID AND NL.[Deleted] = 0
				) AS LikeStatus,
				(
					SELECT [Status]
					FROM [dbo].[CN_NodeMembers] AS NM
					WHERE NM.ApplicationID = @ApplicationID AND 
						NM.[NodeID] = ExternalIDs.Value AND
						NM.[UserID] = @ViewerUserID AND NM.[Deleted] = 0
				) AS MembershipStatus,
				(
					SELECT COUNT(*) 
					FROM [dbo].[USR_ItemVisits] AS IV
					WHERE IV.ApplicationID = @ApplicationID AND IV.[ItemID] = ExternalIDs.Value
				) AS VisitsCount,
				(
					SELECT TOP(1) CAST(1 AS bit)
					FROM [dbo].[CN_FreeUsers] AS FU 
					WHERE FU.ApplicationID = @ApplicationID AND 
						FU.NodeTypeID = Node.NodeTypeID AND 
						FU.UserID = @ViewerUserID AND FU.Deleted = 0
				) AS IsFreeUser,
				[dbo].[WK_FN_HasWikiContent](@ApplicationID, Node.NodeID) AS HasWikiContent,
				[dbo].[FG_FN_HasFormContent](@ApplicationID, Node.NodeID) AS HasFormContent
		FROM	@NodeIDs AS ExternalIDs
				INNER JOIN [dbo].[CN_Nodes] AS Node
				ON Node.ApplicationID = @ApplicationID AND Node.[NodeID] = ExternalIDs.Value
				INNER JOIN [dbo].[CN_NodeTypes] AS NY
				ON NY.ApplicationID = @ApplicationID AND NY.NodeTypeID = Node.NodeTypeID
				LEFT JOIN [dbo].[Users_Normal] AS USR
				ON USR.ApplicationID = @ApplicationID AND USR.UserID = Node.CreatorUserID
				LEFT JOIN [dbo].[CN_View_Nodes_Normal] AS Area
				ON Area.ApplicationID = @ApplicationID AND Area.NodeID = Node.AreaID
				LEFT JOIN [dbo].[PRVC_Settings] AS CONF
				INNER JOIN [dbo].[PRVC_ConfidentialityLevels] AS CL
				ON CL.ApplicationID = @ApplicationID AND CL.ID = CONF.ConfidentialityID
				ON CONF.ApplicationID = @ApplicationID AND CONF.ObjectID = Node.NodeID
				LEFT JOIN [dbo].[CN_Nodes] AS OW
				ON OW.ApplicationID = @ApplicationID AND OW.NodeID = Node.OwnerID
				LEFT JOIN [dbo].[DCT_TreeNodes] AS TN
				INNER JOIN [dbo].[DCT_Trees] AS TR
				ON TR.ApplicationID = @ApplicationID AND 
					TR.TreeID = TN.TreeID AND TR.Deleted = 0
				ON TN.ApplicationID = @ApplicationID AND 
					Node.DocumentTreeNodeID IS NOT NULL AND 
					TN.TreeNodeID = Node.DocumentTreeNodeID AND TN.Deleted = 0
				LEFT JOIN [dbo].[CN_Nodes] AS PVersion
				ON PVersion.ApplicationID = @ApplicationID AND 
					Node.PreviousVersionID IS NOT NULL AND 
					PVersion.NodeID = Node.PreviousVersionID
	END
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_GetNodesByIDs]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_GetNodesByIDs]
GO

CREATE PROCEDURE [dbo].[CN_GetNodesByIDs]
	@ApplicationID	uniqueidentifier,
    @strNodeIDs 	varchar(max),
    @delimiter		char,
    @Full			bit,
    @ViewerUserID	uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @NodeIDs KeyLessGuidTableType
	
	INSERT INTO @NodeIDs (Value)
	SELECT DISTINCT Ref.Value 
	FROM GFN_StrToGuidTable(@strNodeIDs, @delimiter) AS Ref
	
	EXEC [dbo].[CN_P_GetNodesByIDs] @ApplicationID, @NodeIDs, @Full, @ViewerUserID
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_GetNodeIDsByAdditionalID]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_GetNodeIDsByAdditionalID]
GO

CREATE PROCEDURE [dbo].[CN_GetNodeIDsByAdditionalID]
	@ApplicationID	uniqueidentifier,
	@NodeTypeID		uniqueidentifier,
    @strIDs			varchar(max),
    @delimiter		char
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @IDs StringTableType
	
	INSERT INTO @IDs (Value)
	SELECT DISTINCT Ref.Value 
	FROM GFN_StrToStringTable(@strIDs, @delimiter) AS Ref
	
	SELECT IDs.Value AS AdditionalID, ND.NodeID
	FROM @IDs AS IDs
		INNER JOIN [dbo].[CN_Nodes] AS ND
		ON ND.ApplicationID = @APplicationID AND 
			ND.NodeTypeID = @NodeTypeID AND ND.AdditionalID = IDs.Value
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_GetNodes]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_GetNodes]
GO

CREATE PROCEDURE [dbo].[CN_GetNodes]
	@ApplicationID			uniqueidentifier,
	@CurrentUserID			uniqueidentifier,
	@NodeTypeIDsTemp		GuidTableType readonly,
	@NodeTypeAdditionalID	nvarchar(50),
	@UseNodeTypeHierarchy	bit,
	@RelatedToIDsTemp		GuidTableType readonly,
    @SearchText				nvarchar(1000),
    @IsDocument				bit,
    @IsKnowledge			bit,
    @CreatorUserIDsTemp		GuidTableType readonly,
    @Searchable				bit,
    @Archive				bit,
    @GrabNoContentServices	bit,
    @LowerCreationDateLimit	datetime,
    @UpperCreationDateLimit	datetime,
    @Count					int,
    @LowerBoundary			bigint,
	@IsFavorite				bit,
	@IsGroup				bit,
	@IsExpertise			bit,
    @FormFiltersTemp		FormFilterTableType readonly,
    @MatchAllFilters		bit,
	@FetchCounts			bit,
    @CheckAccess			bit,
    @DefaultPrivacy			varchar(20),
    @GroupByFormElementID	uniqueidentifier,
	@Now					datetime
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @FormFilters FormFilterTableType
	INSERT INTO @FormFilters SELECT * FROM @FormFiltersTemp

	SET @SearchText = [dbo].[GFN_VerifyString](@SearchText)

	DECLARE @NodeTypeIDs KeyLessGuidTableType
	INSERT INTO @NodeTypeIDs ([Value]) SELECT Ref.[Value]  FROM @NodeTypeIDsTemp AS Ref

	DECLARE @RelatedToIDs GuidTableType
	INSERT INTO @RelatedToIDs ([Value]) SELECT Ref.[Value]  FROM @RelatedToIDsTemp AS Ref

	DECLARE @CreatorUserIDs GuidTableType
	INSERT INTO @CreatorUserIDs ([Value]) SELECT Ref.[Value]  FROM @CreatorUserIDsTemp AS Ref
	
	DECLARE @_cnt INT = (SELECT  COUNT(*) FROM @NodeTypeIDs)
	
	IF @_cnt = 0 BEGIN
		INSERT INTO @NodeTypeIDs ([Value])
		SELECT NodeTypeID
		FROM [dbo].[CN_NodeTypes]
		WHERE ApplicationID = @ApplicationID AND AdditionalID = @NodeTypeAdditionalID
		
		SET @_cnt = (SELECT  COUNT(*) FROM @NodeTypeIDs)
	END
	
	IF @UseNodeTypeHierarchy = 1 AND @_cnt > 0 BEGIN
		DECLARE @TempIDs GuidTableType
		
		INSERT INTO @TempIDs (Value)
		SELECT IDs.Value
		FROM @NodeTypeIDs AS IDs
	
		INSERT INTO @NodeTypeIDs (Value)
		SELECT DISTINCT Ref.NodeTypeID
		FROM @NodeTypeIDs AS IDs
			RIGHT JOIN [dbo].[CN_FN_GetChildNodeTypesDeepHierarchy](@ApplicationID, @TempIDs) AS Ref
			ON Ref.NodeTypeID = IDs.Value
		WHERE IDs.Value IS NULL
		
		SET @_cnt = (SELECT  COUNT(*) FROM @NodeTypeIDs)
	END
	
	DECLARE @AllIDs KeyLessGuidTableType
	
	IF ISNULL(@SearchText, N'') = N'' BEGIN
		INSERT INTO @AllIDs ([Value])
		SELECT	ND.NodeID
		FROM [dbo].[CN_View_Nodes_Normal] AS ND
			LEFT JOIN [dbo].[CN_Services] AS S
			ON S.ApplicationID = @ApplicationID AND S.NodeTypeID = ND.NodeTypeID AND S.Deleted = 0
		WHERE ND.ApplicationID = @ApplicationID AND 
			(@_cnt = 0 OR ND.NodeTypeID IN (SELECT Value FROM @NodeTypeIDs)) AND
			(@IsDocument IS NULL OR ISNULL(S.IsDocument, 0) = @IsDocument) AND
			(@IsKnowledge IS NULL OR ISNULL(S.IsKnowledge, 0) = @IsKnowledge) AND
			(@LowerCreationDateLimit IS NULL OR ND.CreationDate >= @LowerCreationDateLimit) AND
			(@UpperCreationDateLimit IS NULL OR ND.CreationDate <= @UpperCreationDateLimit) AND
			(@Archive IS NULL OR ND.[Deleted] = @Archive) AND
			(@Searchable IS NULL OR ISNULL(ND.Searchable, 1) = @Searchable) AND
			(
				(@_cnt = 1 AND (ISNULL(@GrabNoContentServices, 0) = 1 OR 
					ISNULL(S.NoContent, 0) = 0 OR ND.CreatorUserID = @CurrentUserID)) OR
				(@_cnt <> 1 AND ISNULL(S.NoContent, 0) = 0)
			)
		ORDER BY ND.CreationDate DESC
	END
	ELSE BEGIN
		INSERT INTO @AllIDs ([Value])
		SELECT ND.[NodeID]
		FROM CONTAINSTABLE([dbo].[CN_Nodes], ([Name], [AdditionalID], [Tags]), @SearchText) AS SRCH
			INNER JOIN [dbo].[CN_View_Nodes_Normal] AS ND
			ON SRCH.[Key] = ND.NodeID
			LEFT JOIN [dbo].[CN_Services] AS S
			ON S.ApplicationID = @ApplicationID AND S.NodeTypeID = ND.NodeTypeID AND S.Deleted = 0
		WHERE ND.ApplicationID = @ApplicationID AND 
			(@_cnt = 0 OR ND.NodeTypeID IN (SELECT Value FROM @NodeTypeIDs)) AND
			(@IsDocument IS NULL OR ISNULL(S.IsDocument, 0) = @IsDocument) AND
			(@IsKnowledge IS NULL OR ISNULL(S.IsKnowledge, 0) = @IsKnowledge) AND
			(@LowerCreationDateLimit IS NULL OR ND.CreationDate >= @LowerCreationDateLimit) AND
			(@UpperCreationDateLimit IS NULL OR ND.CreationDate <= @UpperCreationDateLimit) AND
			(@Archive IS NULL OR ND.[Deleted] = @Archive) AND
			(@Searchable IS NULL OR ISNULL(ND.Searchable, 1) = @Searchable) AND
			(
				(@_cnt = 1 AND (ISNULL(@GrabNoContentServices, 0) = 1 OR 
					ISNULL(S.NoContent, 0) = 0 OR ND.CreatorUserID = @CurrentUserID)) OR
				(@_cnt <> 1 AND ISNULL(S.NoContent, 0) = 0)
			)
		ORDER BY SRCH.[Rank] DESC, ND.CreationDate DESC
	END

	DECLARE @FilteredIDs KeyLessGuidTableType

	INSERT INTO @FilteredIDs ([Value])
	SELECT F.NodeID
	FROM [dbo].[CN_FN_GetFilteredNodes](@ApplicationID, @CurrentUserID, @AllIDs, @RelatedToIDs, @CreatorUserIDs, 
		@IsFavorite, @IsGroup, @IsExpertise, @CheckAccess, @DefaultPrivacy, @FormFilters, @MatchAllFilters, @Now) AS F
	ORDER BY F.SequenceNumber ASC

	DECLARE @TotalCount bigint = (SELECT COUNT(*) FROM @FilteredIDs)
	
	DECLARE @ElementType varchar(50) = NULL
	DECLARE @NodeTypeID uniqueidentifier = NULL
	
	IF @GroupByFormElementID IS NOT NULL AND @_cnt = 1 BEGIN
		SET @ElementType = (
			SELECT TOP(1) E.[Type]
			FROM [dbo].[FG_ExtendedFormElements] AS E
			WHERE E.ApplicationID = @ApplicationID AND E.ElementID = @GroupByFormElementID
		)
		
		IF @ElementType = N'Select' BEGIN 
			SELECT	E.TextValue, 
					CAST(NULL AS bit) AS BitValue, 
					@ElementType AS [Type], 
					COUNT(DISTINCT ND.[Value]) AS [Count]
			FROM @FilteredIDs AS ND
				LEFT JOIN [dbo].[FG_FormInstances] AS I
				ON I.ApplicationID = @ApplicationID AND I.OwnerID = ND.[Value]
				LEFT JOIN [dbo].[FG_InstanceElements] AS E
				ON E.ApplicationID = @ApplicationID AND E.InstanceID = I.InstanceID AND E.RefElementID = @GroupByFormElementID
			GROUP BY E.TextValue
			ORDER BY [Count] DESC
		END 
		ELSE IF @ElementType = N'Binary' BEGIN
			SELECT	CAST(NULL AS nvarchar(max)) AS TextValue, 
					E.BitValue, 
					@ElementType AS [Type], 
					COUNT(DISTINCT ND.[Value]) AS [Count]
			FROM @FilteredIDs AS ND
				LEFT JOIN [dbo].[FG_FormInstances] AS I
				ON I.ApplicationID = @ApplicationID AND I.OwnerID = ND.[Value]
				LEFT JOIN [dbo].[FG_InstanceElements] AS E
				ON E.ApplicationID = @ApplicationID AND E.InstanceID = I.InstanceID AND E.RefElementID = @GroupByFormElementID
			GROUP BY E.BitValue
			ORDER BY [Count] DESC
		END
	END
	ELSE BEGIN
		DECLARE @RetIDs KeyLessGuidTableType

		-- Pick Items
		IF ISNULL(@Count, 0) < 1 SET @Count = 1000000000
		IF ISNULL(@LowerBoundary, 0) < 1 SET @LowerBoundary = 1
		
		INSERT INTO @RetIDs ([Value])
		SELECT IDs.[Value]
		FROM @FilteredIDs AS IDs
		WHERE IDs.SequenceNumber BETWEEN @LowerBoundary AND (@LowerBoundary + @Count - 1)
		-- end of Pick Items
		
		EXEC [dbo].[CN_P_GetNodesByIDs] @ApplicationID, @RetIDs, 0, NULL
		
		SELECT @TotalCount

		IF @FetchCounts = 1 BEGIN
			SELECT	ND.NodeTypeID,
					MAX(ND.TypeAdditionalID) AS NodeTypeAdditionalID,
					MAX(ND.TypeName) AS TypeName,
					COUNT(DISTINCT ND.NodeID) AS NodesCount
			FROM @FilteredIDs AS IDs
				INNER JOIN [dbo].[CN_View_Nodes_Normal] AS ND
				ON ND.ApplicationID = @ApplicationID AND ND.NodeID = IDs.[Value]
			GROUP BY ND.NodeTypeID
		END
	END
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_GetMostPopularNodes]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_GetMostPopularNodes]
GO

CREATE PROCEDURE [dbo].[CN_GetMostPopularNodes]
	@ApplicationID	uniqueidentifier,
	@strNodeTypeIDs	varchar(max),
	@Delimiter		char,
	@ParentNodeID	uniqueidentifier,
    @Count			int,
    @LowerBoundary	bigint
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @NodeTypeIDs GuidTableType
	INSERT INTO @NodeTypeIDs
	SELECT Ref.Value FROM [dbo].[GFN_StrToGuidTable](@strNodeTypeIDs, @Delimiter) AS Ref
	
	DECLARE @_cnt INT = (SELECT  COUNT(*) FROM @NodeTypeIDs) 
	
	SELECT TOP(@Count)
		Ref.NodeID,
		Ref.NodeTypeID,
		Ref.Name,
		Ref.NodeType,
		Ref.VisitsCount,
		Ref.LikesCount,
		Ref.RowNumber AS [Order],
		(Ref.RowNumber + Ref.RevRowNumber - 1) AS TotalCount
	FROM (
			SELECT	ROW_NUMBER() OVER (ORDER BY (N.VisitsCount + N.LikesCount) DESC, N.NodeID DESC) AS RowNumber,
					ROW_NUMBER() OVER (ORDER BY (N.VisitsCount + N.LikesCount) ASC, N.NodeID ASC) AS RevRowNumber,
					N.*
			FROM (
					SELECT	V.NodeID,
							V.NodeTypeID,
							V.Name,
							V.NodeType,
							V.[Count] AS VisitsCount,
							ISNULL(L.[Count], 0) AS LikesCount
					FROM (
							SELECT	ND.NodeID,
									CAST(MAX(CAST(ND.NodeTypeID AS varchar(50))) 
										AS uniqueidentifier) AS NodeTypeID,
									MAX(ND.NodeName) AS Name,
									MAX(ND.TypeName) AS NodeType,
									COUNT(IV.UserID) AS [Count]
							FROM [dbo].[CN_View_Nodes_Normal] AS ND
								INNER JOIN [dbo].[USR_ItemVisits] AS IV
								ON IV.ApplicationID = @ApplicationID AND IV.ItemID = ND.NodeID
							WHERE ND.ApplicationID = @ApplicationID AND 
								(@_cnt = 0 OR ND.NodeTypeID IN (SELECT Value FROM @NodeTypeIDs)) AND--(@NodeTypeID IS NULL OR ND.NodeTypeID = @NodeTypeID) AND
								(@ParentNodeID IS NULL OR ND.ParentNodeID = @ParentNodeID) AND
								ND.Deleted = 0
							GROUP BY ND.NodeID
						) AS V
						LEFT JOIN (
							SELECT NL.NodeID, COUNT(NL.UserID) AS [Count]
							FROM [dbo].[CN_NodeLikes] AS NL
							WHERE NL.ApplicationID = @ApplicationID
							GROUP BY NL.NodeID
						) AS L
						ON L.NodeID = V.NodeID
				) AS N
		) AS Ref
	WHERE Ref.RowNumber >= ISNULL(@LowerBoundary, 0)
	ORDER BY Ref.RowNumber ASC
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_GetParentNodes]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_GetParentNodes]
GO

CREATE PROCEDURE [dbo].[CN_GetParentNodes]
	@ApplicationID	uniqueidentifier,
	@NodeID			uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON

	DECLARE @NodeTypeID uniqueidentifier, @_ChildTypeID uniqueidentifier
	
	SET @NodeTypeID = (
		SELECT NodeTypeID 
		FROM [dbo].[CN_Nodes] 
		WHERE ApplicationID = @ApplicationID AND NodeID = @NodeID
	)
	
	SET @_ChildTypeID = [dbo].[CN_FN_GetChildRelationTypeID](@ApplicationID)

	DECLARE @NodeIDs KeyLessGuidTableType
	
	INSERT INTO @NodeIDs (Value)
	SELECT NR.DestinationNodeID
	FROM [dbo].[CN_NodeRelations] AS NR
		INNER JOIN [dbo].[CN_Nodes] AS Nodes
		ON Nodes.ApplicationID = @ApplicationID AND Nodes.NodeID = NR.DestinationNodeID
	WHERE NR.ApplicationID = @ApplicationID AND 
		NR.SourceNodeID = @NodeID AND NR.PropertyID = @_ChildTypeID AND
		NR.Deleted = 0 AND Nodes.NodeTypeID = @NodeTypeID AND Nodes.Deleted = 0
	
	EXEC [dbo].[CN_P_GetNodesByIDs] @ApplicationID, @NodeIDs, 0, NULL
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_GetChildNodes]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_GetChildNodes]
GO

CREATE PROCEDURE [dbo].[CN_GetChildNodes]
	@ApplicationID	uniqueidentifier,
	@NodeID			uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON

	DECLARE @NodeTypeID uniqueidentifier, @_ParentTypeID uniqueidentifier
	
	SET @NodeTypeID = (
		SELECT NodeTypeID 
		FROM [dbo].[CN_Nodes] 
		WHERE ApplicationID = @ApplicationID AND NodeID = @NodeID
	)
	
	SET @_ParentTypeID = [dbo].[CN_FN_GetParentRelationTypeID](@ApplicationID)

	DECLARE @NodeIDs KeyLessGuidTableType
	
	INSERT INTO @NodeIDs (Value)
	SELECT NR.DestinationNodeID
	FROM [dbo].[CN_NodeRelations] AS NR
		INNER JOIN [dbo].[CN_Nodes] AS Nodes
		ON Nodes.ApplicationID = @ApplicationID AND Nodes.NodeID = NR.DestinationNodeID
	WHERE NR.ApplicationID = @ApplicationID AND
		NR.SourceNodeID = @NodeID AND NR.PropertyID = @_ParentTypeID AND
		NR.Deleted = 0 AND Nodes.NodeTypeID = @NodeTypeID AND Nodes.Deleted = 0
	
	EXEC [dbo].[CN_P_GetNodesByIDs] @ApplicationID, @NodeIDs, 0, NULL
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_GetDefaultRelatedNodes]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_GetDefaultRelatedNodes]
GO

CREATE PROCEDURE [dbo].[CN_GetDefaultRelatedNodes]
	@ApplicationID	uniqueidentifier,
	@NodeID			uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON

	DECLARE @NodeTypeID uniqueidentifier, @_RelatedTypeID uniqueidentifier
	
	SET @NodeTypeID = (
		SELECT NodeTypeID 
		FROM [dbo].[CN_Nodes] 
		WHERE ApplicationID = @ApplicationID AND NodeID = @NodeID
	)
	
	SET @_RelatedTypeID = [dbo].[CN_FN_GetRelatedRelationTypeID](@ApplicationID)

	DECLARE @NodeIDs KeyLessGuidTableType
	
	INSERT INTO @NodeIDs (Value)
	SELECT NR.DestinationNodeID
	FROM [dbo].[CN_NodeRelations] AS NR
		INNER JOIN [dbo].[CN_Nodes] AS Nodes
		ON Nodes.ApplicationID = @ApplicationID AND Nodes.NodeID = NR.DestinationNodeID
	WHERE NR.ApplicationID = @ApplicationID AND 
		NR.SourceNodeID = @NodeID AND NR.PropertyID = @_RelatedTypeID AND
		NR.Deleted = 0 AND Nodes.NodeTypeID = @NodeTypeID AND Nodes.Deleted = 0
	
	EXEC [dbo].[CN_P_GetNodesByIDs] @ApplicationID, @NodeIDs, 0, NULL
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_GetDefaultConnectedNodes]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_GetDefaultConnectedNodes]
GO

CREATE PROCEDURE [dbo].[CN_GetDefaultConnectedNodes]
	@ApplicationID	uniqueidentifier,
	@NodeID			uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON

	DECLARE @NodeIDs KeyLessGuidTableType
	
	INSERT INTO @NodeIDs (Value)
	SELECT NR.DestinationNodeID
	FROM [dbo].[CN_NodeRelations] AS NR
		INNER JOIN [dbo].[CN_View_Nodes_Normal] AS Nodes
		ON Nodes.ApplicationID = @ApplicationID AND Nodes.NodeID = NR.DestinationNodeID
	WHERE NR.ApplicationID = @ApplicationID AND NR.SourceNodeID = @NodeID AND NR.Deleted = 0 AND 
		(Nodes.TypeAdditionalID = N'1' OR Nodes.TypeAdditionalID = N'2' OR
		 Nodes.TypeAdditionalID = N'3' OR Nodes.TypeAdditionalID = N'4') AND Nodes.Deleted = 0
	
	EXEC [dbo].[CN_P_GetNodesByIDs] @ApplicationID, @NodeIDs, 0, NULL
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_GetBrotherNodes]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_GetBrotherNodes]
GO

CREATE PROCEDURE [dbo].[CN_GetBrotherNodes]
	@ApplicationID	uniqueidentifier,
	@NodeID			uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON

	DECLARE @NodeTypeID uniqueidentifier, @_ChildTypeID uniqueidentifier
	
	SET @NodeTypeID = (
		SELECT NodeTypeID 
		FROM [dbo].[CN_Nodes] 
		WHERE ApplicationID = @ApplicationID AND NodeID = @NodeID
	)
	
	SET @_ChildTypeID = [dbo].[CN_FN_GetChildRelationTypeID](@ApplicationID)

	DECLARE @ParentNodeIDs GuidTableType
	
	INSERT INTO @ParentNodeIDs
	SELECT NR.DestinationNodeID
	FROM [dbo].[CN_NodeRelations] AS NR
		INNER JOIN [dbo].[CN_Nodes] AS Nodes
		ON Nodes.ApplicationID = @ApplicationID AND Nodes.NodeID = NR.DestinationNodeID
	WHERE NR.ApplicationID = @ApplicationID AND 
		NR.SourceNodeID = @NodeID AND NR.PropertyID = @_ChildTypeID AND
		NR.Deleted = 0 AND Nodes.NodeTypeID = @NodeTypeID AND Nodes.Deleted = 0
	
		
	DECLARE @NodeIDs KeyLessGuidTableType
	
	INSERT INTO @NodeIDs (Value)
	SELECT NR.SourceNodeID
	FROM @ParentNodeIDs AS Ref
		INNER JOIN [dbo].[CN_NodeRelations] AS NR
		ON NR.DestinationNodeID = Ref.Value
		INNER JOIN [dbo].[CN_Nodes] AS Nodes
		ON Nodes.ApplicationID = @ApplicationID AND Nodes.NodeID = NR.SourceNodeID
	WHERE NR.ApplicationID = @ApplicationID AND 
		NR.PropertyID = @_ChildTypeID AND NR.Deleted = 0 AND 
		Nodes.NodeTypeID = @NodeTypeID AND Nodes.Deleted = 0
	
	
	EXEC [dbo].[CN_P_GetNodesByIDs] @ApplicationID, @NodeIDs, 0, NULL
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_GetDirectChilds]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_GetDirectChilds]
GO

CREATE PROCEDURE [dbo].[CN_GetDirectChilds]
	@ApplicationID			uniqueidentifier,
	@NodeID					uniqueidentifier,
	@NodeTypeID				uniqueidentifier,
	@NodeTypeAdditionalID	nvarchar(20),
	@Searchable				bit,
	@LowerBoundary			float,
	@Count					int,
	@OrderBy				varchar(100),
	@OrderByDesc			bit,
	@SearchText				nvarchar(1000),
	@CheckAccess			bit,
	@CurrentUserID			uniqueidentifier,
	@Now					datetime,
	@DefaultPrivacy			varchar(50)
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	IF @NodeTypeID IS NULL AND ISNULL(@NodeTypeAdditionalID, N'') <> N''
		SET @NodeTypeID = [dbo].[CN_FN_GetNodeTypeID](@ApplicationID, @NodeTypeAdditionalID)

	DECLARE @NodeIDs KeyLessGuidTableType
	DECLARE @TempIDs KeyLessGuidTableType
	
	IF ISNULL(@SearchText, N'') = N'' BEGIN
		CREATE TABLE #Results (NodeID uniqueidentifier)
		
		IF @OrderBy = 'Type' SET @OrderBy = 'TypeName'	
		ELSE IF @OrderBy = N'Date' SET @OrderBy = 'CreationDate'	
		ELSE IF @OrderBy = N'Name' SET @OrderBy = 'NodeName'
		ELSE SET @OrderBy = 'SequenceNumber'
		
		DECLARE @SortOrder varchar(10) = 'ASC'
		IF @OrderByDesc = 1 SET @SortOrder = 'DESC'
		
		DECLARE @SecondaryOrder varchar(100) = N''
		IF @OrderBy <> 'CreationDate' SET @SecondaryOrder = ', ND.CreationDate ASC'
		
		DECLARE @strSearchable varchar(100) = N''
		IF @Searchable IS NOT NULL BEGIN
			SET @strSearchable = N'ISNULL(ND.Searchable, 1) = ' + (CASE WHEN @Searchable = 1 THEN N'1' ELSE N'0' END) + ' AND '
		END
		
		DECLARE @ToBeExecuted varchar(2000) =
			'INSERT INTO #Results (NodeID) ' +
			'SELECT X.NodeID ' +
			'FROM ( ' +
					'SELECT	ROW_NUMBER() OVER (ORDER BY ND.' + @OrderBy + ' ' + 
								@SortOrder + @SecondaryOrder + ', ND.CreationDate ASC, ND.NodeID ' + @SortOrder + ') AS RowNumber, ' +
							'ND.NodeID ' +
					'FROM [dbo].[CN_View_Nodes_Normal] AS ND ' +
					'WHERE ND.ApplicationID = N''' + CAST(@ApplicationID AS varchar(100)) + ''' AND ' +
						CASE 
							WHEN @NodeTypeID IS NULL THEN '' 
							ELSE 'ND.NodeTypeID = N''' + CAST(@NodeTypeID AS varchar(100)) + ''' AND '
						END +
						CASE
							WHEN @NodeID IS NOT NULL THEN 
								'ND.ParentNodeID = N''' + CAST(@NodeID AS varchar(100)) + ''' AND ND.ParentNodeID <> ND.NodeID AND '
							ELSE '(ND.ParentNodeID IS NULL OR ND.ParentNodeID = ND.NodeID) AND '
						END +
						@strSearchable + ' ' + 'ND.Deleted = 0 ' +
				') AS X ' +
			'ORDER BY X.RowNumber ASC'
		
		EXEC (@ToBeExecuted)
		
		INSERT INTO @TempIDs (Value)
		SELECT *
		FROM #Results
	END
	ELSE BEGIN
		DECLARE @NIDs GuidTableType
	
		IF @NodeID IS NOT NULL BEGIN
			INSERT INTO @NIDs (Value)
			VALUES (@NodeID)
			
			INSERT INTO @NIDs (Value)
			SELECT DISTINCT H.NodeID
			FROM @NodeIDs AS N
				RIGHT JOIN [dbo].[CN_FN_GetChildNodesDeepHierarchy](@ApplicationID, @NIDs) AS H
				ON H.NodeID = N.Value
			WHERE N.Value IS NULL AND H.NodeID <> @NodeID
			
			DELETE @NIDs
			WHERE Value = @NodeID
		END
		
		DECLARE @NodeIDsCount int = (SELECT COUNT(*) FROM @NIDs)
		
		INSERT INTO @TempIDs (Value)
		SELECT X.NodeID
		FROM (
				SELECT	ROW_NUMBER() OVER (ORDER BY SRCH.[Rank] DESC, SRCH.[Key] ASC) AS RowNumber,
						SRCH.[Key] AS NodeID
				FROM CONTAINSTABLE([dbo].[CN_Nodes], ([Name], [AdditionalID]), @SearchText) AS SRCH
					INNER JOIN [dbo].[CN_View_Nodes_Normal] AS ND
					ON ND.NodeID = SRCH.[Key]
					LEFT JOIN @NIDs AS I
					ON I.Value = ND.NodeID
				WHERE ApplicationID = @ApplicationID AND 
					(@NodeTypeID IS NULL OR NodeTypeID = @NodeTypeID) AND 
					(@NodeIDsCount = 0 OR I.Value IS NOT NULL) AND 
					(@Searchable IS NULL OR ISNULL(ND.Searchable, 1) = @Searchable) AND ND.Deleted = 0
			) AS X
		ORDER BY X.RowNumber ASC
	END
	
	IF ISNULL(@CheckAccess, 0) = 1 BEGIN
		DECLARE	@PermissionTypes StringPairTableType
		
		INSERT INTO @PermissionTypes (FirstValue, SecondValue)
		VALUES (N'View', @DefaultPrivacy)
	
		DELETE T
		FROM @TempIDs AS T
			LEFT JOIN [dbo].[PRVC_FN_CheckAccess](@ApplicationID, @CurrentUserID, 
				@TempIDs, N'Node', @Now, @PermissionTypes) AS A
			ON A.ID = T.Value
		WHERE A.ID IS NULL
	END
	
	INSERT INTO @NodeIDs (Value)
	SELECT TOP(ISNULL(@Count, 1000000)) X.Value
	FROM @TempIDs AS X
	WHERE X.SequenceNumber >= ISNULL(@LowerBoundary, 0)
	ORDER BY X.SequenceNumber ASC
	
	EXEC [dbo].[CN_P_GetNodesByIDs] @ApplicationID, @NodeIDs, 0, NULL
	
	SELECT CAST(COUNT(ID.Value) AS bigint) AS TotalCount
	FROM @TempIDs AS ID
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_GetDirectParent]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_GetDirectParent]
GO

CREATE PROCEDURE [dbo].[CN_GetDirectParent]
	@ApplicationID	uniqueidentifier,
	@NodeID			uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON

	DECLARE @NodeIDs KeyLessGuidTableType
	
	INSERT INTO @NodeIDs (Value)
	SELECT Parent.NodeID
	FROM [dbo].[CN_Nodes] AS Node
		INNER JOIN [dbo].[CN_Nodes] AS Parent
		ON Parent.ApplicationID = @ApplicationID AND Parent.NodeID = Node.ParentNodeID
	WHERE Node.ApplicationID = @ApplicationID AND Node.NodeID = @NodeID AND 
		Node.ParentNodeID IS NOT NULL AND Parent.Deleted = 0
	
	EXEC [dbo].[CN_P_GetNodesByIDs] @ApplicationID, @NodeIDs, 0, NULL
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_SetDirectParent]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_SetDirectParent]
GO

CREATE PROCEDURE [dbo].[CN_SetDirectParent]
	@ApplicationID			uniqueidentifier,
	@strNodeIDs				varchar(max),
	@delimiter				char,
	@ParentNodeID			uniqueidentifier,
	@LastModifierUserID		uniqueidentifier,
	@LastModificationDate	datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @NodeIDs GuidTableType
	INSERT INTO @NodeIDs
	SELECT Ref.Value FROM [dbo].[GFN_StrToGuidTable](@strNodeIDs, @delimiter) AS Ref
	
	DECLARE @ParentHierarchy NodesHierarchyTableType
	
	IF @ParentNodeID IS NOT NULL BEGIN
		INSERT INTO @ParentHierarchy
		EXEC [dbo].[CN_P_GetNodeHierarchy] @ApplicationID, @ParentNodeID, 0
	END
	
	IF EXISTS(
		SELECT TOP(1) 1
		FROM @ParentHierarchy AS P
			INNER JOIN @NodeIDs AS N
			ON N.Value = P.NodeID
	) BEGIN
		SELECT -1, N'CannotTransferToChilds'
		RETURN
	END

	UPDATE ND
		SET LastModifierUserID = @LastModifierUserID,
			LastModificationDate = @LastModificationDate,
			ParentNodeID = @ParentNodeID
	FROM @NodeIDs AS Ref
		INNER JOIN [dbo].[CN_Nodes] AS ND
		ON ND.ApplicationID = @ApplicationID AND ND.[NodeID] = Ref.Value
	WHERE (@ParentNodeID IS NULL OR ND.[NodeID] <> @ParentNodeID)
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_HaveChilds]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_HaveChilds]
GO

CREATE PROCEDURE [dbo].[CN_HaveChilds]
	@ApplicationID	uniqueidentifier,
	@strNodeIDs		varchar(max),
	@delimiter		char
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @NodeIDs GuidTableType
	INSERT INTO @NodeIDs
	SELECT DISTINCT Ref.Value FROM [dbo].[GFN_StrToGuidTable](@strNodeIDs, @delimiter) AS Ref
	
	SELECT ExternalIDs.Value AS ID
	FROM @NodeIDs AS ExternalIDs
	WHERE EXISTS(
		SELECT TOP(1) * 
		FROM [dbo].[CN_Nodes] 
		WHERE ApplicationID = @ApplicationID AND 
			(ParentNodeID = ExternalIDs.Value AND ParentNodeID <> NodeID) AND Deleted = 0)
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_P_GetRelatedNodeIDs]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_P_GetRelatedNodeIDs]
GO

CREATE PROCEDURE [dbo].[CN_P_GetRelatedNodeIDs]
	@ApplicationID		uniqueidentifier,
	@NodeIDOrUserID		uniqueidentifier,
	@RelatedNodeTypeID	uniqueidentifier,
	@SearchText			nvarchar(1000),
	@In					bit,
	@Out				bit,
	@InTags				bit,
	@OutTags			bit,
	@Count				int,
	@LowerBoundary		int
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SET @SearchText = [dbo].[GFN_VerifyString](@SearchText)

	DECLARE @SourceIDs GuidTableType
	
	IF @NodeIDOrUserID IS NOT NULL BEGIN
		INSERT INTO @SourceIDs(Value) VALUES(@NodeIDOrUserID)
	END
	
	DECLARE @RelatedTypeIDs GuidTableType
	
	IF @RelatedNodeTypeID IS NOT NULL BEGIN
		INSERT INTO @RelatedTypeIDs(Value) VALUES(@RelatedNodeTypeID)
	END
	
	DECLARE @NodeIDs KeyLessGuidTableType
	
	IF EXISTS(
		SELECT TOP(1) UN.UserID
		FROM [dbo].[Users_Normal] AS UN 
		WHERE UN.ApplicationID = @ApplicationID AND UN.UserID = @NodeIDOrUserID
	) BEGIN
		INSERT INTO @NodeIDs (Value)
		SELECT Ref.RelatedNodeID
		FROM [dbo].[CN_FN_GetUserRelatedNodeIDs](@ApplicationID, @SourceIDs, @RelatedTypeIDs) AS Ref
	END
	ELSE BEGIN
		DECLARE @SourceNodeTypeIDs GuidTableType

		INSERT INTO @NodeIDs (Value)
		SELECT Ref.RelatedNodeID
		FROM [dbo].[CN_FN_GetRelatedNodeIDs](@ApplicationID, 
			@SourceIDs, @SourceNodeTypeIDs, @RelatedTypeIDs, @In, @Out, @InTags, @OutTags) AS Ref
	END
	
	
	IF ISNULL(@SearchText, N'') = N'' BEGIN
		SELECT TOP(ISNULL(@Count, 1000000)) ND.Value AS ID
		FROM @NodeIDs AS ND
		WHERE ND.SequenceNumber >= ISNULL(@LowerBoundary, 0)
		ORDER BY ND.SequenceNumber ASC
	END
	ELSE BEGIN
		SELECT TOP(ISNULL(@Count, 1000000)) X.NodeID AS ID
		FROM (
				SELECT	ROW_NUMBER() OVER (ORDER BY SRCH.[Rank] DESC, ND.SequenceNumber ASC) AS RowNumber,
						ND.Value AS NodeID
				FROM CONTAINSTABLE([dbo].[CN_Nodes], (Name, Tags, AdditionalID), @SearchText) AS SRCH
					INNER JOIN @NodeIDs AS ND
					ON ND.Value = SRCH.[Key]
			) AS X
		WHERE X.RowNumber >= ISNULL(@LowerBoundary, 0)
		ORDER BY X.RowNumber ASC
	END
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_GetRelatedNodeIDs]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_GetRelatedNodeIDs]
GO

CREATE PROCEDURE [dbo].[CN_GetRelatedNodeIDs]
	@ApplicationID		uniqueidentifier,
	@NodeID				uniqueidentifier,
	@RelatedNodeTypeID	uniqueidentifier,
	@SearchText			nvarchar(1000),
	@In					bit,
	@Out				bit,
	@InTags				bit,
	@OutTags			bit,
	@Count				int,
	@LowerBoundary		int
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	EXEC [dbo].[CN_P_GetRelatedNodeIDs] @ApplicationID, @NodeID, @RelatedNodeTypeID, 
		@SearchText, @In, @Out, @InTags, @OutTags, @Count, @LowerBoundary
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_GetRelatedNodes]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_GetRelatedNodes]
GO

CREATE PROCEDURE [dbo].[CN_GetRelatedNodes]
	@ApplicationID		uniqueidentifier,
	@NodeID				uniqueidentifier,
	@RelatedNodeTypeID	uniqueidentifier,
	@SearchText			nvarchar(1000),
	@In					bit,
	@Out				bit,
	@InTags				bit,
	@OutTags			bit,
	@Count				int,
	@LowerBoundary		int
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @NodeIDs KeyLessGuidTableType
	
	INSERT INTO @NodeIDs (Value)
	EXEC [dbo].[CN_P_GetRelatedNodeIDs] @ApplicationID, @NodeID, @RelatedNodeTypeID, 
		@SearchText, @In, @Out, @InTags, @OutTags, @Count, @LowerBoundary
	
	EXEC [dbo].[CN_P_GetNodesByIDs] @ApplicationID, @NodeIDs, 0, NULL
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_GetRelatedNodesCount]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_GetRelatedNodesCount]
GO

CREATE PROCEDURE [dbo].[CN_GetRelatedNodesCount]
	@ApplicationID		uniqueidentifier,
	@NodeID				uniqueidentifier,
	@RelatedNodeTypeID	uniqueidentifier,
	@SearchText			nvarchar(1000),
	@In					bit,
	@Out				bit,
	@InTags				bit,
	@OutTags			bit,
	@Count				int,
	@LowerBoundary		int
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @NodeIDs KeyLessGuidTableType
	
	INSERT INTO @NodeIDs (Value)
	EXEC [dbo].[CN_P_GetRelatedNodeIDs] @ApplicationID, @NodeID, @RelatedNodeTypeID, 
		@SearchText, @In, @Out, @InTags, @OutTags, @Count, @LowerBoundary
	
	SELECT *
	FROM (
			SELECT	ND.NodeTypeID,
					MAX(ND.TypeAdditionalID) AS NodeTypeAdditionalID,
					MAX(ND.TypeName) AS TypeName,
					COUNT(ND.NodeID) AS NodesCount
			FROM @NodeIDs AS IDs
				INNER JOIN [dbo].[CN_View_Nodes_Normal] AS ND
				ON ND.ApplicationID = @ApplicationID AND ND.NodeID = IDs.Value
			GROUP BY ND.NodeTypeID
		) AS X
	ORDER BY X.NodesCount DESC
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_GetRelatedNodesPartitioned]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_GetRelatedNodesPartitioned]
GO

CREATE PROCEDURE [dbo].[CN_GetRelatedNodesPartitioned]
	@ApplicationID	uniqueidentifier,
	@NodeID			uniqueidentifier,
	@strNodeTypeIDs varchar(max),
	@delimiter		char,
	@In				bit,
	@Out			bit,
	@InTags			bit,
	@OutTags		bit,
	@Count			int
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @TypeIDs GuidTableType
	
	INSERT INTO @TypeIDs (Value)
	SELECT DISTINCT Ref.Value
	FROM [dbo].[GFN_StrToGuidTable](@strNodeTypeIDs, @delimiter) AS Ref
	
	DECLARE @HasNodeTypeID bit = (SELECT TOP(1) CAST(1 AS bit) FROM @TypeIDs)
	
	DECLARE @NodeIDs KeyLessGuidTableType
	
	INSERT INTO @NodeIDs (Value)
	EXEC [dbo].[CN_P_GetRelatedNodeIDs] @ApplicationID, @NodeID, NULL, 
		NULL, @In, @Out, @InTags, @OutTags, 1000000, NULL
	
	DECLARE @RetIDs KeyLessGuidTableType
	
	INSERT INTO @RetIDs (Value)
	SELECT X.NodeID
	FROM (
			SELECT	ROW_NUMBER() OVER (PARTITION BY N.NodeTypeID ORDER BY N.CreationDate DESC, N.NodeID DESC) AS Number,
					N.NodeID
			FROM @NodeIDs AS ID
				INNER JOIN [dbo].[CN_View_Nodes_Normal] AS N
				ON N.ApplicationID = @ApplicationID AND N.NodeID = ID.Value
			WHERE @HasNodeTypeID = 0 OR N.NodeTypeID IN (SELECT T.Value FROM @TypeIDs AS T)
		) AS X
	WHERE X.Number <= ISNULL(@Count, 5)
	
	EXEC [dbo].[CN_P_GetNodesByIDs] @ApplicationID, @RetIDs, 0, NULL
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_RelationExists]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_RelationExists]
GO

CREATE PROCEDURE [dbo].[CN_RelationExists]
	@ApplicationID				uniqueidentifier,
	@SourceNodeID				uniqueidentifier,
	@DestinationNodeID			uniqueidentifier,
	@ReverseAlso				bit
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT CAST(1 AS bit) 
	FROM [dbo].[CN_NodeRelations]
	WHERE ApplicationID = @ApplicationID AND 
		((SourceNodeID = @SourceNodeID AND DestinationNodeID = @DestinationNodeID) OR
		(@ReverseAlso = 1 AND SourceNodeID = @DestinationNodeID AND
		  DestinationNodeID = @SourceNodeID)) AND Deleted = 0
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_P_GetNodeHierarchy]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_P_GetNodeHierarchy]
GO

CREATE PROCEDURE [dbo].[CN_P_GetNodeHierarchy]
	@ApplicationID	uniqueidentifier,
	@NodeID			uniqueidentifier,
	@SameType		bit
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @NodeTypeID uniqueidentifier = NULL
		
	IF @SameType = 1 BEGIN
		SET @NodeTypeID = (
			SELECT TOP(1) NodeTypeID 
			FROM [dbo].[CN_Nodes] 
			WHERE ApplicationID = @ApplicationID AND NodeID = @NodeID
		)
	END
 	
	;WITH hierarchy (ID, ParentID, [Level], Name)
	AS
	(
		SELECT NodeID AS ID, ParentNodeID AS ParentID, 0 AS [Level], Name
		FROM [dbo].[CN_Nodes]
		WHERE ApplicationID = @ApplicationID AND NodeID = @NodeID
		
		UNION ALL
		
		SELECT Node.NodeID AS ID, Node.ParentNodeID AS ParentID, [Level] + 1, Node.Name
		FROM [dbo].[CN_Nodes] AS Node
			INNER JOIN hierarchy AS HR
			ON HR.ParentID = Node.NodeID
		WHERE ApplicationID = @ApplicationID AND 
			(@NodeTypeID IS NULL OR Node.NodeTypeID = @NodeTypeID) AND
			Node.NodeID <> HR.ID AND Node.Deleted = 0
	)
	
	SELECT * 
	FROM hierarchy
	ORDER BY hierarchy.[Level] ASC
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_GetNodeHierarchy]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_GetNodeHierarchy]
GO

CREATE PROCEDURE [dbo].[CN_GetNodeHierarchy]
	@ApplicationID	uniqueidentifier,
	@NodeID			uniqueidentifier,
	@SameType		bit
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	EXEC [dbo].[CN_P_GetNodeHierarchy] @ApplicationID, @NodeID, @SameType
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_GetNodeTypesHierarchy]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_GetNodeTypesHierarchy]
GO

CREATE PROCEDURE [dbo].[CN_GetNodeTypesHierarchy]
	@ApplicationID	uniqueidentifier,
	@strNodeTypeIDs	nvarchar(max),
	@delimiter		char
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @NodeTypeIds GuidTableType
	
	INSERT INTO @NodeTypeIDs (Value)
	SELECT Ref.Value
	FROM [dbo].[GFN_StrToGuidTable](@strNodeTypeIds, @delimiter) AS Ref
	
	;WITH hierarchy (ID, ParentID, [Level], Name)
	AS
	(
		SELECT NT.NodeTypeID AS ID, NT.ParentID, 0 AS [Level], NT.Name
		FROM @NodeTypeIDs AS R
			INNER JOIN [dbo].[CN_NodeTypes] AS NT
			ON NT.ApplicationID = @ApplicationID AND NT.NodeTypeID = R.Value
		
		UNION ALL
		
		SELECT NT.NodeTypeID AS ID, NT.ParentID, [Level] + 1, NT.Name
		FROM [dbo].[CN_NodeTypes] AS NT
			INNER JOIN hierarchy AS HR
			ON HR.ParentID = NT.NodeTypeID
		WHERE NT.ApplicationID = @ApplicationID AND NT.NodeTypeID <> HR.ID AND NT.Deleted = 0
	)
	
	SELECT * 
	FROM hierarchy
	ORDER BY hierarchy.[Level] ASC
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_GetTreeDepth]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_GetTreeDepth]
GO

CREATE PROCEDURE [dbo].[CN_GetTreeDepth]
	@ApplicationID	uniqueidentifier,
	@NodeTypeID		uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @NodeIDs GuidTableType

	INSERT INTO @NodeIDs (Value)
	SELECT ND.NodeID
	FROM [dbo].[CN_Nodes] AS ND
	WHERE ND.ApplicationID = @ApplicationID AND ND.NodeTypeID = @NodeTypeID AND 
		ND.ParentNodeID IS NULL AND ND.Deleted = 0
		
	SELECT TOP(1) MAX(Ref.[Level]) + 1 AS Value
	FROM [dbo].[CN_FN_GetChildNodesDeepHierarchy](@ApplicationID, @NodeIDs) AS Ref
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_AddMember]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_AddMember]
GO

CREATE PROCEDURE [dbo].[CN_AddMember]
	@ApplicationID		uniqueidentifier,
    @NodeID				uniqueidentifier,
    @UserID				uniqueidentifier,
    @MembershipDate		datetime,
    @IsAdmin			bit,
    @IsPending			bit,
    @AcceptionDate		datetime,
    @Position			nvarchar(255)
WITH ENCRYPTION
AS
BEGIN TRANSACTION
	SET NOCOUNT ON
	
	DECLARE @_Result int
	
	EXEC [dbo].[CN_P_AddMember] @ApplicationID, @NodeID, @UserID, @MembershipDate, 
		@IsAdmin, @IsPending, @AcceptionDate, @Position, @_Result output
	
	IF @_Result <= 0 BEGIN
		ROLLBACK TRANSACTION
		RETURN
	END
	
	-- Send new dashboards
	IF @IsPending = 1 BEGIN 
		DECLARE @AdminIDs GuidTableType
		
		INSERT INTO @AdminIDs (Value)
		SELECT NM.UserID
		FROM [dbo].[CN_View_NodeMembers] AS NM
		WHERE NM.ApplicationID = @ApplicationID AND NM.NodeID = @NodeID AND 
			NM.IsAdmin = 1 AND NM.IsPending = 0 AND NM.UserID <> @UserID
	
		DECLARE @Dashboards DashboardTableType
		
		INSERT INTO @Dashboards(UserID, NodeID, RefItemID, [Type], Removable, SendDate)
		SELECT	Ref.Value, 
				@NodeID,
				@UserID,
				N'MembershipRequest',
				0,
				@MembershipDate
		FROM @AdminIDs AS Ref
		
		EXEC [dbo].[NTFN_P_SendDashboards] @ApplicationID, @Dashboards, @_Result output
		
		IF @_Result <= 0 BEGIN
			SELECT -1
			ROLLBACK TRANSACTION
			RETURN
		END
		ELSE BEGIN
			SELECT @_Result
		
			SELECT * 
			FROM @Dashboards
		END	
	END
	ELSE SELECT @_Result
	-- end of send new dashboards
COMMIT TRANSACTION

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_ArithmeticDeleteMember]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_ArithmeticDeleteMember]
GO

CREATE PROCEDURE [dbo].[CN_ArithmeticDeleteMember]
	@ApplicationID	uniqueidentifier,
    @NodeID			uniqueidentifier,
    @UserID			uniqueidentifier
WITH ENCRYPTION
AS
BEGIN TRANSACTION
	SET NOCOUNT ON
	
	DECLARE @_Result int
	
	EXEC [dbo].[CN_P_UpdateMember] @ApplicationID, @NodeID, @UserID, NULL, 
		NULL, NULL, NULL, NULL, 1, @_Result output
	
    IF @_Result <= 0 BEGIN
		ROLLBACK TRANSACTION
		RETURN
    END
    
    IF @_Result > 0 BEGIN
		EXEC [dbo].[NTFN_P_ArithmeticDeleteDashboards] @ApplicationID, 
			NULL, @NodeID, @UserID, N'MembershipRequest', NULL, @_Result output
			
		IF @_Result <= 0 BEGIN
			ROLLBACK TRANSACTION
			RETURN
		END
	END
	
	SELECT @_Result
COMMIT TRANSACTION

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_AcceptMember]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_AcceptMember]
GO

CREATE PROCEDURE [dbo].[CN_AcceptMember]
	@ApplicationID	uniqueidentifier,
    @NodeID			uniqueidentifier,
    @UserID			uniqueidentifier,
    @AcceptionDate	datetime
WITH ENCRYPTION
AS
BEGIN TRANSACTION
	SET NOCOUNT ON
	
	DECLARE @_Result int
	
	EXEC [dbo].[CN_P_UpdateMember] @ApplicationID, @NodeID, @UserID, NULL,
		NULL, 0, @AcceptionDate, NULL, NULL, @_Result output
	
    IF @_Result <= 0 BEGIN
		ROLLBACK TRANSACTION
		RETURN
    END
    
    IF @_Result > 0 BEGIN
		EXEC [dbo].[NTFN_P_ArithmeticDeleteDashboards] @ApplicationID, 
			NULL, @NodeID, @UserID, N'MembershipRequest', NULL, @_Result output
			
		IF @_Result <= 0 BEGIN
			ROLLBACK TRANSACTION
			RETURN
		END
	END
	
	SELECT @_Result
COMMIT TRANSACTION

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_SetMemberPosition]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_SetMemberPosition]
GO

CREATE PROCEDURE [dbo].[CN_SetMemberPosition]
	@ApplicationID	uniqueidentifier,
    @NodeID			uniqueidentifier,
    @UserID			uniqueidentifier,
    @Position		nvarchar(255)
WITH ENCRYPTION
AS
BEGIN TRANSACTION
	SET NOCOUNT ON
	
	DECLARE @_Result int
	
	EXEC [dbo].[CN_P_UpdateMember] @ApplicationID, @NodeID, @UserID, NULL,
		NULL, NULL, NULL, @Position, NULL, @_Result output
	
	SELECT @_Result
	
    IF @_Result <= 0 BEGIN
		ROLLBACK TRANSACTION
		RETURN
    END
COMMIT TRANSACTION

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_P_IsNodeCreator]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_P_IsNodeCreator]
GO

CREATE PROCEDURE [dbo].[CN_P_IsNodeCreator]
	@ApplicationID	uniqueidentifier,
    @NodeID			uniqueidentifier,
    @UserID			uniqueidentifier,
    @_IsCreator		bit output
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON

    SELECT @_IsCreator = CAST(1 as bit) 
    WHERE EXISTS(
			SELECT TOP(1) * 
			FROM [dbo].[CN_Nodes]
			WHERE ApplicationID = @ApplicationID AND 
				NodeID = @NodeID AND CreatorUserID = @UserID
		) OR EXISTS(
			SELECT TOP(1) * 
			FROM [dbo].[CN_NodeCreators]
			WHERE ApplicationID = @ApplicationID AND 
				NodeID = @NodeID AND UserID = @UserID AND Deleted = 0
		)
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_IsNodeCreator]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_IsNodeCreator]
GO

CREATE PROCEDURE [dbo].[CN_IsNodeCreator]
	@ApplicationID	uniqueidentifier,
    @NodeID			uniqueidentifier,
    @NodeTypeID		uniqueidentifier,
    @AdditionalID	varchar(50),
    @UserID			uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	IF @NodeID IS NULL AND @AdditionalID IS NOT NULL BEGIN
		;WITH X (NodeID)
		AS
		(
			SELECT NodeID 
			FROM [dbo].[CN_Nodes] 
			WHERE ApplicationID = @ApplicationID AND 
				(@NodeTypeID IS NULL OR NodeTypeID = @NodeTypeID) AND 
				AdditionalID = @AdditionalID
		)
		SELECT TOP(1) @NodeID = X.NodeID
		FROM X
		WHERE (SELECT COUNT(*) FROM X) = 1
	END
	
	DECLARE @IsCreator bit

    EXEC [dbo].[CN_P_IsNodeCreator] @ApplicationID, @NodeID, @UserID, @IsCreator output
    
    SELECT @IsCreator
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_P_IsNodeMember]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_P_IsNodeMember]
GO

CREATE PROCEDURE [dbo].[CN_P_IsNodeMember]
	@ApplicationID	uniqueidentifier,
    @NodeID			uniqueidentifier,
    @UserID			uniqueidentifier,
    @IsAdmin		bit,
    @Status			varchar(20),
    @_IsMember		bit output
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON

    SELECT @_IsMember = CAST(1 as bit) 
    WHERE EXISTS(
			SELECT TOP(1) *
			FROM [dbo].[CN_NodeMembers]
			WHERE ApplicationID = @ApplicationID AND 
				NodeID = @NodeID AND UserID = @UserID AND Deleted = 0 AND
				(@IsAdmin IS NULL OR IsAdmin = @IsAdmin) AND
				(@Status IS NULL OR Status = @Status)
		)
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_IsNodeMember]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_IsNodeMember]
GO

CREATE PROCEDURE [dbo].[CN_IsNodeMember]
	@ApplicationID	uniqueidentifier,
    @NodeID			uniqueidentifier,
    @UserID			uniqueidentifier,
    @IsAdmin		bit,
    @Status			varchar(20)
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON

	DECLARE @IsMember bit

    EXEC [dbo].[CN_P_IsNodeMember] @ApplicationID, @NodeID, @UserID, 
		@IsAdmin, @Status, @IsMember output
    
    SELECT @IsMember
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_P_IsNodeAdmin]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_P_IsNodeAdmin]
GO

CREATE PROCEDURE [dbo].[CN_P_IsNodeAdmin]
	@ApplicationID	uniqueidentifier,
    @NodeID			uniqueidentifier,
    @UserID			uniqueidentifier,
    @_IsAdmin		bit output
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
    SELECT TOP(1) @_IsAdmin = IsAdmin
    FROM [dbo].[CN_NodeMembers]
    WHERE ApplicationID = @ApplicationID AND
		NodeID = @NodeID AND UserID = @UserID AND Deleted = 0
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_IsNodeAdmin]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_IsNodeAdmin]
GO

CREATE PROCEDURE [dbo].[CN_IsNodeAdmin]
	@ApplicationID	uniqueidentifier,
    @NodeID			uniqueidentifier,
    @UserID			uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON

	DECLARE @IsAdmin bit
	EXEC [dbo].[CN_P_IsNodeAdmin] @ApplicationID, @NodeID, @UserID, @IsAdmin output

    SELECT @IsAdmin
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_HasAdmin]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_HasAdmin]
GO

CREATE PROCEDURE [dbo].[CN_HasAdmin]
	@ApplicationID	uniqueidentifier,
    @NodeID			uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON

    SELECT CAST(1 AS bit) 
    WHERE EXISTS(
			SELECT TOP(1) * 
			FROM [dbo].[CN_NodeMembers] AS NM
				INNER JOIN [dbo].[Users_Normal] AS UN
				ON UN.ApplicationID = @ApplicationID AND UN.UserID = NM.UserID
			WHERE NM.ApplicationID = @ApplicationID AND 
				NM.NodeID = @NodeID AND NM.IsAdmin = 1 AND 
				NM.[Status] <> N'Pending' AND NM.Deleted = 0 AND UN.IsApproved = 1
		)
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_SetUnsetNodeAdmin]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_SetUnsetNodeAdmin]
GO

CREATE PROCEDURE [dbo].[CN_SetUnsetNodeAdmin]
	@ApplicationID	uniqueidentifier,
    @NodeID			uniqueidentifier,
    @UserID			uniqueidentifier,
    @Admin			bit,
    @Unique			bit
WITH ENCRYPTION
AS
BEGIN TRANSACTION
	SET NOCOUNT ON
	
	DECLARE @_Result int
	
	IF @Admin IS NULL SET @Admin = 0
	
	IF @Admin = 1 AND @Unique = 1 BEGIN
		DECLARE @Members GuidPairTableType
		
		INSERT INTO @Members (FirstValue, SecondValue)
		SELECT NM.NodeID, NM.UserID
		FROM [dbo].[CN_NodeMembers] AS NM
		WHERE NM.ApplicationID = @ApplicationID AND NM.NodeID = @NodeID AND NM.IsAdmin = 1
		
		EXEC [dbo].[CN_P_UpdateMembers] @ApplicationID, @Members, NULL, 0, 
			NULL, NULL, NULL, NULL, @_Result output
		
		IF @_Result <= 0 BEGIN
			SELECT @_Result
			ROLLBACK TRANSACTION
			RETURN
		END
	END
	
	EXEC [dbo].[CN_P_UpdateMember] @ApplicationID, @NodeID, @UserID, NULL, 
		@Admin, NULL, NULL, NULL, NULL, @_Result output
	
	SELECT @_Result
	
	IF @_Result <= 0 BEGIN
		ROLLBACK TRANSACTION
		RETURN
	END
COMMIT TRANSACTION

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_AddComplexAdmin]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_AddComplexAdmin]
GO

CREATE PROCEDURE [dbo].[CN_AddComplexAdmin]
	@ApplicationID	uniqueidentifier,
	@ListID			uniqueidentifier,
	@UserID			uniqueidentifier,
	@CurrentUserID	uniqueidentifier,
	@Now			datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	IF EXISTS(
		SELECT TOP(1) * 
		FROM [dbo].[CN_ListAdmins]
		WHERE ApplicationID = @ApplicationID AND ListID = @ListID AND UserID = @UserID
	) BEGIN
		
		UPDATE [dbo].[CN_ListAdmins]
			SET LastModifierUserID = @CurrentUserID,
				LastModificationDate = @Now,
				Deleted = 0
		WHERE ApplicationID = @ApplicationID AND ListID = @ListID AND UserID = @UserID
	END
	ELSE BEGIN
		INSERT INTO [dbo].[CN_ListAdmins](
			ApplicationID,
			ListID,
			UserID,
			CreatorUserID,
			CreationDate,
			Deleted
		)
		VALUES(
			@ApplicationID,
			@ListID,
			@UserID,
			@CurrentUserID,
			@Now,
			0
		)
	END
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_RemoveComplexAdmin]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_RemoveComplexAdmin]
GO

CREATE PROCEDURE [dbo].[CN_RemoveComplexAdmin]
	@ApplicationID		uniqueidentifier,
	@ListID				uniqueidentifier,
	@UserID				uniqueidentifier,
	@CurrentUserID		uniqueidentifier,
	@Now				datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[CN_ListAdmins]
		SET LastModifierUserID = @CurrentUserID,
			LastModificationDate = @Now,
			Deleted = 1
	WHERE ApplicationID = @ApplicationID AND ListID = @ListID AND UserID = @UserID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_GetComplexAdmins]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_GetComplexAdmins]
GO

CREATE PROCEDURE [dbo].[CN_GetComplexAdmins]
	@ApplicationID		uniqueidentifier,
	@ListIDOrNodeID		uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @IsList bit = (
		SELECT TOP(1) CAST(1 AS bit) 
		FROM [dbo].[CN_Lists] 
		WHERE ApplicationID = @ApplicationID AND ListID = @ListIDOrNodeID
	)
	
	IF @IsList = 1 BEGIN
		SELECT DISTINCT UserID AS ID
		FROM [dbo].[CN_View_ListAdmins]
		WHERE ApplicationID = @ApplicationID AND ListID = @ListIDOrNodeID
	END
	ELSE BEGIN
		SELECT DISTINCT UserID AS ID
		FROM [dbo].[CN_View_ListAdmins]
		WHERE ApplicationID = @ApplicationID AND NodeID = @ListIDOrNodeID
	END
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_GetComplexTypeID]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_GetComplexTypeID]
GO

CREATE PROCEDURE [dbo].[CN_GetComplexTypeID]
	@ApplicationID	uniqueidentifier,
	@ListID			uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT NodeTypeID AS ID
	FROM [dbo].[CN_Lists]
	WHERE ApplicationID = @ApplicationID AND ListID = @ListID
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_IsComplexAdmin]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_IsComplexAdmin]
GO

CREATE PROCEDURE [dbo].[CN_IsComplexAdmin]
	@ApplicationID	uniqueidentifier,
    @NodeID			uniqueidentifier,
    @UserID			uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON

	SELECT TOP(1) CAST(1 AS bit)
	FROM [dbo].[CN_View_ListAdmins]
	WHERE ApplicationID = @ApplicationID AND NodeID = @NodeID AND UserID = @UserID
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_GetUser2NodeStatus]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_GetUser2NodeStatus]
GO

CREATE PROCEDURE [dbo].[CN_GetUser2NodeStatus]
	@ApplicationID	uniqueidentifier,
	@UserID			uniqueidentifier,
    @NodeID			uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON

	SELECT TOP(1)
		ND.NodeTypeID AS NodeTypeID,
		ND.AreaID AS AreaID,
		CASE
			WHEN ND.CreatorUserID = @UserID THEN CAST(1 AS bit)
			ELSE CAST(0 AS bit)
		END AS IsCreator,
		CASE
			WHEN NC.UserID IS NULL THEN CAST(0 AS bit)
			ELSE CAST(1 AS bit)
		END AS IsContributor,
		CASE
			WHEN Ex.UserID IS NULL THEN CAST(0 AS bit)
			ELSE CAST(1 AS bit)
		END AS IsExpert,
		CASE
			WHEN NM.UserID IS NULL THEN CAST(0 AS bit)
			ELSE CAST(1 AS bit)
		END AS IsMember,
		CASE
			WHEN NM.UserID IS NULL OR ISNULL(NM.IsAdmin, 0) = 0 THEN CAST(0 AS bit)
			ELSE CAST(1 AS bit)
		END AS IsAdminMember,
		CASE
			WHEN SA.UserID IS NULL THEN CAST(0 AS bit)
			ELSE CAST(1 AS bit)
		END AS IsServiceAdmin
	FROM [dbo].[CN_Nodes] AS ND
		LEFT JOIN [dbo].[CN_NodeCreators] AS NC
		ON NC.ApplicationID = @ApplicationID AND 
			NC.NodeID = ND.NodeID AND NC.UserID = @UserID AND NC.Deleted = 0
		LEFT JOIN [dbo].[CN_View_Experts] AS Ex
		ON EX.ApplicationID = @ApplicationID AND 
			EX.UserID = @UserID AND EX.NodeID = ND.NodeID
		LEFT JOIN [dbo].[CN_View_NodeMembers] AS NM
		ON NM.ApplicationID = @ApplicationID AND 
			NM.UserID = @UserID AND NM.NodeID = ND.NodeID AND NM.IsPending = 0
		LEFT JOIN [dbo].[CN_ServiceAdmins] AS SA
		ON SA.ApplicationID = @ApplicationID AND 
			SA.NodeTypeID = ND.NodeTypeID AND SA.UserID = @UserID AND SA.Deleted = 0
	WHERE ND.ApplicationID = @ApplicationID AND ND.NodeID = @NodeID
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_P_GetNodeHierarchyAdminIDs]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_P_GetNodeHierarchyAdminIDs]
GO

CREATE PROCEDURE [dbo].[CN_P_GetNodeHierarchyAdminIDs]
	@ApplicationID	uniqueidentifier,
    @NodeID			uniqueidentifier,
    @SameType		bit
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON

	DECLARE @NodeTypeID uniqueidentifier = NULL
		
	IF @SameType = 1 BEGIN
		SET @NodeTypeID = (
			SELECT NodeTypeID 
			FROM [dbo].[CN_Nodes] 
			WHERE ApplicationID = @ApplicationID AND NodeID = @NodeID
		)
	END

	DECLARE @NodeHierarchy NodesHierarchyTableType
	INSERT INTO @NodeHierarchy
    EXEC [dbo].[CN_P_GetNodeHierarchy] @ApplicationID, @NodeID, @SameType
    
    DECLARE @Admins GuidPairTableType
    INSERT INTO @Admins
    SELECT DISTINCT NM.NodeID, NM.UserID
    FROM @NodeHierarchy AS HRC
		INNER JOIN [dbo].[CN_NodeMembers] AS NM 
		ON NM.ApplicationID = @ApplicationID AND NM.NodeID = HRC.NodeID
		INNER JOIN [dbo].[Users_Normal] AS USR 
		ON USR.ApplicationID = @ApplicationID AND USR.UserID = NM.UserID
	WHERE NM.IsAdmin = 1 AND NM.Deleted = 0 AND USR.IsApproved = 1
    
    
    SELECT NH.NodeID AS NodeID, AD.SecondValue AS UserID, NH.[Level] AS [Level]
    FROM @NodeHierarchy AS NH
		INNER JOIN @Admins AS AD
		ON NH.NodeID = AD.FirstValue 
	ORDER BY NH.[Level] ASC
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_GetNodeHierarchyAdminIDs]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_GetNodeHierarchyAdminIDs]
GO

CREATE PROCEDURE [dbo].[CN_GetNodeHierarchyAdminIDs]
	@ApplicationID	uniqueidentifier,
    @NodeID			uniqueidentifier,
    @SameType		bit
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	EXEC [dbo].[CN_P_GetNodeHierarchyAdminIDs] @ApplicationID, @NodeID, @SameType
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_P_GetMembers]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_P_GetMembers]
GO

CREATE PROCEDURE [dbo].[CN_P_GetMembers]
	@ApplicationID	uniqueidentifier,
    @MembersTemp	GuidPairTableType readonly
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @Members GuidPairTableType
	INSERT INTO @Members SELECT * FROM @MembersTemp

    SELECT NM.NodeID AS NodeID,
		   NM.UserID AS UserID,
		   NM.MembershipDate AS MembershipDate,
		   NM.IsAdmin AS IsAdmin,
		   CAST((CASE WHEN NM.[Status] = 'Pending' THEN 1 ELSE 0 END) AS bit) AS IsPending,
		   NM.[Status] AS [Status],
		   NM.AcceptionDate AS AcceptionDate,
		   NM.Position AS Position,
		   USR.UserName AS UserName,
		   USR.FirstName AS FirstName,
		   USR.LastName AS LastName
    FROM @Members AS ExternalIDs
		INNER JOIN [dbo].[CN_NodeMembers] AS NM 
		ON NM.ApplicationID = @ApplicationID AND 
			NM.NodeID = ExternalIDs.FirstValue AND NM.UserID = ExternalIDs.SecondValue
		INNER JOIN [dbo].[Users_Normal] AS USR 
		ON USR.ApplicationID = @ApplicationID AND USR.UserID = NM.UserID
	ORDER BY USR.LastActivityDate DESC
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_GetMembers]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_GetMembers]
GO

CREATE PROCEDURE [dbo].[CN_GetMembers]
	@ApplicationID	uniqueidentifier,
    @strNodeIDs		varchar(max),
    @delimiter		char,
    @IsPending		bit,
    @IsAdmin		bit,
    @SearchText		nvarchar(255),
    @Count			int,
    @LowerBoundary	bigint
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @NodeIDs GuidTableType
	
	INSERT INTO @NodeIDs
	SELECT Ref.Value
	FROM [dbo].[GFN_StrToGuidTable](@strNodeIDs, @delimiter) AS Ref

	DECLARE @Members GuidPairTableType
	
	DECLARE @MMS Table (NodeID uniqueidentifier, UserID uniqueidentifier, TotalCount bigint)
	
	IF ISNULL(@Count, 0) <= 0 SET @Count = 1000000
	
	IF @IsPending = 1 SET @IsAdmin = NULL
	
	IF ISNULL(@SearchText, N'') = N'' BEGIN
		INSERT INTO @MMS (NodeID, UserID, TotalCount)
		SELECT TOP(@Count) 
			Ref.NodeID, 
			Ref.UserID, 
			(Ref.RowNumber + Ref.RevRowNumber - 1)
		FROM (
				SELECT	ROW_NUMBER() OVER (ORDER BY NM.IsAdmin DESC, NM.NodeID DESC, NM.UserID DESC) AS RowNumber,
						ROW_NUMBER() OVER (ORDER BY NM.IsAdmin ASC, NM.NodeID ASC, NM.UserID ASC) AS RevRowNumber,
						NM.NodeID AS NodeID,
						NM.UserID AS UserID
				FROM @NodeIDs AS Ref
					INNER JOIN [dbo].[CN_View_NodeMembers] AS NM 
					ON NM.NodeID = Ref.Value
				WHERE NM.ApplicationID = @ApplicationID AND 
					(@IsPending IS NULL OR NM.IsPending = @IsPending) AND
					(@IsAdmin IS NULL OR NM.IsAdmin = @IsAdmin)
			) AS Ref
		WHERE Ref.RowNumber >= ISNULL(@LowerBoundary, 0)
		ORDER BY Ref.RowNumber ASC
	END
	ELSE BEGIN
		INSERT INTO @MMS (NodeID, UserID, TotalCount)
		SELECT TOP(@Count) 
			Ref.NodeID, 
			Ref.UserID, 
			(Ref.RowNumber + Ref.RevRowNumber - 1)
		FROM (
				SELECT	ROW_NUMBER() OVER (ORDER BY SRCH.[Rank] DESC, NM.NodeID DESC, NM.UserID DESC) AS RowNumber,
						ROW_NUMBER() OVER (ORDER BY SRCH.[Rank] ASC, NM.NodeID ASC, NM.UserID ASC) AS RevRowNumber,
						NM.NodeID AS NodeID,
						NM.UserID AS UserID
				FROM @NodeIDs AS Ref
					INNER JOIN [dbo].[CN_View_NodeMembers] AS NM 
					ON NM.NodeID = Ref.Value
					INNER JOIN CONTAINSTABLE([dbo].[USR_View_Users], ([UserName], [FirstName], [LastName]), @SearchText) AS SRCH
					ON SRCH.[Key] = NM.UserID
				WHERE NM.ApplicationID = @ApplicationID AND 
					(@IsPending IS NULL OR NM.IsPending = @IsPending) AND
					(@IsAdmin IS NULL OR NM.IsAdmin = @IsAdmin)
			) AS Ref
		WHERE Ref.RowNumber >= ISNULL(@LowerBoundary, 0)
		ORDER BY Ref.RowNumber ASC
	END
	
	INSERT INTO @Members (FirstValue, SecondValue)
	SELECT M.NodeID, M.UserID
	FROM @MMS AS M
		
	EXEC [dbo].[CN_P_GetMembers] @ApplicationID, @Members
	
	SELECT TOP(1) M.TotalCount
	FROM @MMS AS M
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_GetMember]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_GetMember]
GO

CREATE PROCEDURE [dbo].[CN_GetMember]
	@ApplicationID	uniqueidentifier,
    @NodeID			uniqueidentifier,
    @UserID			uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON

	DECLARE @Members GuidPairTableType

	INSERT INTO @Members (FirstValue, SecondValue)
    SELECT NM.NodeID, NM.UserID
    FROM [dbo].[CN_NodeMembers] AS NM
    WHERE NM.ApplicationID = @ApplicationID AND 
		NM.NodeID = @NodeID AND NM.UserID = @UserID AND NM.Deleted = 0
		
	EXEC [dbo].[CN_P_GetMembers] @ApplicationID, @Members
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_P_GetMemberUserIDs]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_P_GetMemberUserIDs]
GO

CREATE PROCEDURE [dbo].[CN_P_GetMemberUserIDs]
	@ApplicationID	uniqueidentifier,
    @NodeIDsTemp	GuidTableType readonly,
    @Status			varchar(20),
    @IsAdmin		bit
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @NodeIDs GuidTableType
	INSERT INTO @NodeIDs SELECT * FROM @NodeIDsTemp

	SELECT DISTINCT NM.UserID AS ID
    FROM @NodeIDs AS ExternalIDs
		INNER JOIN [dbo].[CN_NodeMembers] AS NM 
		ON NM.ApplicationID = @ApplicationID AND NM.NodeID = ExternalIDs.Value
		INNER JOIN [dbo].[Users_Normal] AS USR 
		ON USR.ApplicationID = @ApplicationID AND 
			USR.UserID = NM.UserID AND USR.IsApproved = 1
	WHERE (@Status IS NULL OR NM.[Status] = @Status) AND
		(@IsAdmin IS NULL OR NM.IsAdmin = @IsAdmin) AND NM.Deleted = 0
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_GetMemberUserIDs]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_GetMemberUserIDs]
GO

CREATE PROCEDURE [dbo].[CN_GetMemberUserIDs]
	@ApplicationID	uniqueidentifier,
    @strNodeIDs		varchar(max),
    @delimiter		char,
    @Status			varchar(20),
    @IsAdmin		bit
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @NodeIDs GuidTableType
	INSERT INTO @NodeIDs
	SELECT DISTINCT Ref.Value FROM GFN_StrToGuidTable(@strNodeIDs, @delimiter) AS Ref

	EXEC [dbo].[CN_P_GetMemberUserIDs] @ApplicationID, @NodeIDs, @Status, @IsAdmin
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_GetMembersCount]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_GetMembersCount]
GO

CREATE PROCEDURE [dbo].[CN_GetMembersCount]
	@ApplicationID	uniqueidentifier,
    @NodeID			uniqueidentifier,
    @Status			varchar(20),
    @IsAdmin		bit
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON

    SELECT COUNT(*)
    FROM [dbo].[CN_NodeMembers] AS NM 
		INNER JOIN [dbo].[Users_Normal] AS USR 
		ON USR.ApplicationID = @ApplicationID AND 
			USR.UserID = NM.UserID AND USR.IsApproved = 1
	WHERE NM.ApplicationID = @ApplicationID AND 
		NM.NodeID = @NodeID AND (@Status IS NULL OR NM.[Status] = @Status) AND
		(@IsAdmin IS NULL OR NM.IsAdmin = @IsAdmin) AND NM.Deleted = 0
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_GetChildHierarchyMemberIDs]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_GetChildHierarchyMemberIDs]
GO

CREATE PROCEDURE [dbo].[CN_GetChildHierarchyMemberIDs]
	@ApplicationID	uniqueidentifier,
    @NodeID			uniqueidentifier,
    @SearchText		nvarchar(255),
    @Count			int,
    @LowerBoundary	bigint
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @IDs GuidTableType
	
	INSERT INTO @IDs
	SELECT @NodeID
	
	DECLARE @NodeIDs GuidTableType
	
	INSERT INTO @NodeIDs (Value)
	SELECT DISTINCT Ref.NodeID
	FROM [dbo].[CN_FN_GetChildNodesDeepHierarchy](@ApplicationID, @IDs) AS Ref

	DECLARE @Members GuidPairTableType
	
	DECLARE @US Table (UserID uniqueidentifier, TotalCount bigint)
	
	IF ISNULL(@Count, 0) <= 0 SET @Count = 1000000
	
	IF ISNULL(@SearchText, N'') = N'' BEGIN
		INSERT INTO @US (UserID, TotalCount)
		SELECT TOP(@Count) 
			Ref.UserID, 
			(Ref.RowNumber + Ref.RevRowNumber - 1)
		FROM (
				SELECT	ROW_NUMBER() OVER (ORDER BY U.UserID ASC) AS RowNumber,
						ROW_NUMBER() OVER (ORDER BY U.UserID DESC) AS RevRowNumber,
						U.UserID AS UserID
				FROM (
						SELECT DISTINCT NM.UserID
						FROM @NodeIDs AS Ref
							INNER JOIN [dbo].[CN_View_NodeMembers] AS NM 
							ON NM.NodeID = Ref.Value
						WHERE NM.ApplicationID = @ApplicationID AND NM.IsPending = 0
					) AS U
					INNER JOIN [dbo].[Users_Normal] AS UN
					ON UN.ApplicationID = @ApplicationID AND
						UN.UserID = U.UserID AND UN.IsApproved = 1
			) AS Ref
		WHERE Ref.RowNumber >= ISNULL(@LowerBoundary, 0)
		ORDER BY Ref.RowNumber ASC
	END
	ELSE BEGIN
		INSERT INTO @US (UserID, TotalCount)
		SELECT TOP(@Count) 
			Ref.UserID, 
			(Ref.RowNumber + Ref.RevRowNumber - 1)
		FROM (
				SELECT	ROW_NUMBER() OVER (ORDER BY SRCH.[Rank] DESC, U.UserID ASC) AS RowNumber,
						ROW_NUMBER() OVER (ORDER BY SRCH.[Rank] ASC, U.UserID DESC) AS RevRowNumber,
						U.UserID AS UserID
				FROM (
						SELECT DISTINCT NM.UserID
						FROM @NodeIDs AS Ref
							INNER JOIN [dbo].[CN_View_NodeMembers] AS NM 
							ON NM.NodeID = Ref.Value
						WHERE NM.ApplicationID = @ApplicationID AND NM.IsPending = 0
					) AS U
					INNER JOIN [dbo].[Users_Normal] AS UN
					ON UN.ApplicationID = @ApplicationID AND
						UN.UserID = U.UserID AND UN.IsApproved = 1
					INNER JOIN CONTAINSTABLE([dbo].[USR_View_Users], ([UserName], [FirstName], [LastName]), @SearchText) AS SRCH
					ON SRCH.[Key] = UN.UserID
			) AS Ref
		WHERE Ref.RowNumber >= ISNULL(@LowerBoundary, 0)
		ORDER BY Ref.RowNumber ASC
	END
	
	SELECT U.UserID AS ID
	FROM @US AS U
	
	SELECT TOP(1) U.TotalCount
	FROM @US AS U
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_GetChildHierarchyExpertIDs]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_GetChildHierarchyExpertIDs]
GO

CREATE PROCEDURE [dbo].[CN_GetChildHierarchyExpertIDs]
	@ApplicationID	uniqueidentifier,
    @NodeID			uniqueidentifier,
    @SearchText		nvarchar(255),
    @Count			int,
    @LowerBoundary	bigint
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @IDs GuidTableType
	
	INSERT INTO @IDs
	SELECT @NodeID
	
	DECLARE @NodeIDs GuidTableType
	
	INSERT INTO @NodeIDs (Value)
	SELECT DISTINCT Ref.NodeID
	FROM [dbo].[CN_FN_GetChildNodesDeepHierarchy](@ApplicationID, @IDs) AS Ref

	DECLARE @Members GuidPairTableType
	
	DECLARE @US Table (UserID uniqueidentifier, TotalCount bigint)
	
	IF ISNULL(@Count, 0) <= 0 SET @Count = 1000000
	
	IF ISNULL(@SearchText, N'') = N'' BEGIN
		INSERT INTO @US (UserID, TotalCount)
		SELECT TOP(@Count) 
			Ref.UserID, 
			(Ref.RowNumber + Ref.RevRowNumber - 1)
		FROM (
				SELECT	ROW_NUMBER() OVER (ORDER BY U.UserID ASC) AS RowNumber,
						ROW_NUMBER() OVER (ORDER BY U.UserID DESC) AS RevRowNumber,
						U.UserID AS UserID
				FROM (
						SELECT DISTINCT Ex.UserID
						FROM @NodeIDs AS Ref
							INNER JOIN [dbo].[CN_View_Experts] AS Ex
							ON Ex.NodeID = Ref.Value
						WHERE Ex.ApplicationID = @ApplicationID
					) AS U
					INNER JOIN [dbo].[Users_Normal] AS UN
					ON UN.ApplicationID = @ApplicationID AND
						UN.UserID = U.UserID AND UN.IsApproved = 1
			) AS Ref
		WHERE Ref.RowNumber >= ISNULL(@LowerBoundary, 0)
		ORDER BY Ref.RowNumber ASC
	END
	ELSE BEGIN
		INSERT INTO @US (UserID, TotalCount)
		SELECT TOP(@Count) 
			Ref.UserID, 
			(Ref.RowNumber + Ref.RevRowNumber - 1)
		FROM (
				SELECT	ROW_NUMBER() OVER (ORDER BY SRCH.[Rank] DESC, U.UserID ASC) AS RowNumber,
						ROW_NUMBER() OVER (ORDER BY SRCH.[Rank] ASC, U.UserID DESC) AS RevRowNumber,
						U.UserID AS UserID
				FROM (
						SELECT DISTINCT Ex.UserID
						FROM @NodeIDs AS Ref
							INNER JOIN [dbo].[CN_View_Experts] AS Ex
							ON Ex.NodeID = Ref.Value
						WHERE Ex.ApplicationID = @ApplicationID
					) AS U
					INNER JOIN [dbo].[Users_Normal] AS UN
					ON UN.ApplicationID = @ApplicationID AND
						UN.UserID = U.UserID AND UN.IsApproved = 1
					INNER JOIN CONTAINSTABLE([dbo].[USR_View_Users], ([UserName], [FirstName], [LastName]), @SearchText) AS SRCH
					ON SRCH.[Key] = UN.UserID
			) AS Ref
		WHERE Ref.RowNumber >= ISNULL(@LowerBoundary, 0)
		ORDER BY Ref.RowNumber ASC
	END
	
	SELECT U.UserID AS ID
	FROM @US AS U
	
	SELECT TOP(1) U.TotalCount
	FROM @US AS U
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_GetUserManagedNodeIDs]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_GetUserManagedNodeIDs]
GO

CREATE PROCEDURE [dbo].[CN_GetUserManagedNodeIDs]
	@ApplicationID	uniqueidentifier,
    @UserID			uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON

    SELECT NodeID 
    FROM [dbo].[CN_NodeMembers]
    WHERE ApplicationID = @ApplicationID AND UserID = @UserID AND IsAdmin = 1
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_GetMembershipRequestsDashboards]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_GetMembershipRequestsDashboards]
GO

CREATE PROCEDURE [dbo].[CN_GetMembershipRequestsDashboards]
	@ApplicationID	uniqueidentifier,
    @UserID			uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON

	DECLARE @NodeIDs GuidTableType
	INSERT INTO @NodeIDs
	EXEC [dbo].[CN_GetUserManagedNodeIDs] @ApplicationID, @UserID

    SELECT NM.NodeID AS NodeID,
		   NM.UserID AS UserID,
		   NM.MembershipDate AS MembershipDate,
		   NM.IsAdmin AS IsAdmin,
		   NM.[Status] AS [Status],
		   NM.AcceptionDate AS AcceptionDate,
		   NM.Position AS Position,
		   USR.UserName AS UserName,
		   USR.FirstName AS FirstName,
		   USR.LastName AS LastName,
		   VN.NodeAdditionalID AS NodeAdditionalID,
		   VN.NodeName AS NodeName,
		   VN.NodeTypeID AS NodeTypeID,
		   VN.TypeName AS NodeType
    FROM @NodeIDs AS ExternalIDs 
		INNER JOIN [dbo].[CN_NodeMembers] AS NM 
		ON NM.ApplicationID = @ApplicationID AND NM.NodeID = ExternalIDs.Value
		INNER JOIN [dbo].[Users_Normal] AS USR 
		ON USR.ApplicationID = @ApplicationID AND USR.UserID = NM.UserID
		INNER JOIN [dbo].[CN_View_Nodes_Normal] AS VN 
		ON VN.ApplicationID = @ApplicationID AND VN.NodeID = NM.NodeID
	WHERE NM.[Status] = N'Pending' AND NM.Deleted = 0 AND 
		USR.IsApproved = 1 AND VN.Deleted = 0
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_GetMembershipRequestsDashboardsCount]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_GetMembershipRequestsDashboardsCount]
GO

CREATE PROCEDURE [dbo].[CN_GetMembershipRequestsDashboardsCount]
	@ApplicationID	uniqueidentifier,
    @UserID			uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON

	DECLARE @NodeIDs GuidTableType
	INSERT INTO @NodeIDs
	EXEC [dbo].[CN_GetUserManagedNodeIDs] @ApplicationID, @UserID

    SELECT COUNT(NM.NodeID)
    FROM @NodeIDs AS ExternalIDs 
		INNER JOIN [dbo].[CN_NodeMembers] AS NM 
		ON NM.ApplicationID = @ApplicationID AND NM.NodeID = ExternalIDs.Value
		INNER JOIN [dbo].[Users_Normal] AS USR 
		ON USR.ApplicationID = @ApplicationID AND USR.UserID = NM.UserID
		INNER JOIN [dbo].[CN_View_Nodes_Normal] AS VN 
		ON VN.ApplicationID = @ApplicationID AND VN.NodeID = NM.NodeID
	WHERE NM.[Status] = N'Pending' AND NM.Deleted = 0 AND 
		USR.IsApproved = 1 AND VN.Deleted = 0
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_GetMembershipDomainsCount]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_GetMembershipDomainsCount]
GO

CREATE PROCEDURE [dbo].[CN_GetMembershipDomainsCount]
	@ApplicationID	uniqueidentifier,
	@UserID			uniqueidentifier,
	@NodeTypeID		uniqueidentifier,
	@NodeID			uniqueidentifier,
	@AdditionalID	varchar(50),
	@LowerDateLimit	datetime,
	@UpperDateLimit	datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	IF @NodeID IS NOT NULL SET @NodeTypeID = NULL
	IF @NodeID IS NOT NULL OR @AdditionalID = N'' SET @AdditionalID = NULL
	
	SELECT	ND.NodeTypeID, 
			MAX(ND.TypeAdditionalID) AS NodeTypeAdditionalID,
			MAX(ND.TypeName) AS TypeName, 
			COUNT(ND.NodeID) AS NodesCount
	FROM [dbo].[CN_View_NodeMembers] AS NM
		INNER JOIN [dbo].[CN_View_Nodes_Normal] AS ND
		ON ND.ApplicationID = @ApplicationID AND ND.NodeID = NM.NodeID
	WHERE NM.ApplicationID = @ApplicationID AND NM.UserID = @UserID AND 
		NM.IsPending = 0 AND (@NodeID IS NULL OR ND.NodeID = @NodeID) AND
		(@NodeTypeID IS NULL OR ND.NodeTypeID = @NodeTypeID) AND 
		(@AdditionalID IS NULL OR ND.NodeAdditionalID = @AdditionalID) AND
		(@LowerDateLimit IS NULL OR ND.CreationDate>= @LowerDateLimit) AND
		(@UpperDateLimit IS NULL OR ND.CreationDate <= @UpperDateLimit) AND
		ND.Deleted = 0
	GROUP BY ND.NodeTypeID
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_GetMembershipDomains]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_GetMembershipDomains]
GO

CREATE PROCEDURE [dbo].[CN_GetMembershipDomains]
	@ApplicationID	uniqueidentifier,
	@UserID			uniqueidentifier,
	@strNodeTypeIDs	varchar(max),
	@delimiter		char,
	@NodeID			uniqueidentifier,
	@AdditionalID	varchar(50),
	@SearchText		nvarchar(1000),
	@LowerDateLimit	datetime,
	@UpperDateLimit	datetime,
	@LowerBoundary	int,
	@Count			int
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @NodeTypeIDs GuidTableType
	
	INSERT INTO @NodeTypeIDs (Value)
	SELECT DISTINCT Ref.Value
	FROM [dbo].[GFN_StrToGuidTable](@strNodeTypeIDs, @delimiter) AS Ref
	
	DECLARE @NTCount int = (SELECT COUNT(*) FROM @NodeTypeIDs)
	
	IF @NodeID IS NOT NULL SET @NTCount = 0
	IF @NodeID IS NOT NULL OR @AdditionalID = N'' SET @AdditionalID = NULL
	IF @Count IS NULL OR @Count <= 0 SET @Count = 10
	
	SET @SearchText = [dbo].[GFN_VerifyString](@SearchText)
	IF @SearchText IS NULL OR @SearchText = N'' SET @SearchText = NULL
	
	DECLARE @SelectedIDs KeyLessGuidTableType
	
	IF @SearchText IS NULL BEGIN
		INSERT INTO @SelectedIDs (Value)
		SELECT Ref.NodeID
		FROM (
				SELECT ROW_NUMBER() OVER (ORDER BY ND.CreationDate DESC, ND.NodeID DESC) AS RowNumber, ND.NodeID
				FROM [dbo].[CN_View_NodeMembers] AS NM
					INNER JOIN [dbo].[CN_View_Nodes_Normal] AS ND
					ON ND.ApplicationID = @ApplicationID AND ND.NodeID = NM.NodeID
				WHERE NM.ApplicationID = @ApplicationID AND NM.UserID = @UserID AND 
					NM.IsPending = 0 AND (@NodeID IS NULL OR ND.NodeID = @NodeID) AND
					(@NTCount = 0 OR ND.NodeTypeID IN (SELECT NTIDs.Value FROM @NodeTypeIDs AS NTIDs)) AND 
					(@AdditionalID IS NULL OR ND.NodeAdditionalID = @AdditionalID) AND
					(@LowerDateLimit IS NULL OR ND.CreationDate>= @LowerDateLimit) AND
					(@UpperDateLimit IS NULL OR ND.CreationDate <= @UpperDateLimit) AND
					ND.Deleted = 0
			) AS Ref
		ORDER BY Ref.RowNumber ASC
	END
	ELSE BEGIN
		INSERT INTO @SelectedIDs (Value)
		SELECT Ref.NodeID
		FROM (
				SELECT ROW_NUMBER() OVER (ORDER BY SRCH.[Rank] DESC, SRCH.[Key] DESC) AS RowNumber, ND.NodeID
				FROM CONTAINSTABLE([dbo].[CN_Nodes], ([Name], [AdditionalID]), @SearchText) AS SRCH
					INNER JOIN [dbo].[CN_View_NodeMembers] AS NM
					INNER JOIN [dbo].[CN_View_Nodes_Normal] AS ND
					ON ND.ApplicationID = @ApplicationID AND ND.NodeID = NM.NodeID
					ON ND.NodeID = SRCH.[Key]
				WHERE ND.ApplicationID = @ApplicationID AND NM.UserID = @UserID AND 
					NM.IsPending = 0 AND (@NodeID IS NULL OR ND.NodeID = @NodeID) AND
					(@NTCount = 0 OR ND.NodeTypeID IN (SELECT NTIDs.Value FROM @NodeTypeIDs AS NTIDs)) AND 
					(@AdditionalID IS NULL OR ND.NodeAdditionalID = @AdditionalID) AND
					(@LowerDateLimit IS NULL OR ND.CreationDate>= @LowerDateLimit) AND
					(@UpperDateLimit IS NULL OR ND.CreationDate <= @UpperDateLimit) AND
					ND.Deleted = 0
			) AS Ref
		ORDER BY Ref.RowNumber ASC
	END
	
	DECLARE @NodeIDs KeyLessGuidTableType

	INSERT INTO @NodeIDs (Value)
	SELECT TOP(@Count) S.Value 
	FROM @SelectedIDs AS S
	WHERE S.SequenceNumber >= ISNULL(@LowerBoundary, 0)
	
	EXEC [dbo].[CN_P_GetNodesByIDs] @ApplicationID, @NodeIDs, 0, NULL
	
	SELECT TOP(1) COUNT(S.Value) AS TotalCount FROM @SelectedIDs AS S
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_P_GetMemberNodes]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_P_GetMemberNodes]
GO

CREATE PROCEDURE [dbo].[CN_P_GetMemberNodes]
	@ApplicationID		uniqueidentifier,
    @NodeUserIDsTemp	GuidPairTableType readonly
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @NodeUserIDs GuidPairTableType
	INSERT INTO @NodeUserIDs SELECT * FROM @NodeUserIDsTemp

    SELECT NM.NodeID AS NodeID,
		   NM.UserID AS UserID,
		   NM.MembershipDate AS MembershipDate,
		   NM.IsAdmin AS IsAdmin,
		   CAST((CASE WHEN NM.[Status] = 'Pending' THEN 1 ELSE 0 END) AS bit) AS IsPending,
		   NM.[Status] AS [Status],
		   NM.AcceptionDate AS AcceptionDate,
		   NM.Position AS Position,
		   VN.NodeAdditionalID AS NodeAdditionalID,
		   VN.NodeName AS NodeName,
		   VN.NodeTypeID AS NodeTypeID,
		   VN.TypeName AS NodeType
    FROM @NodeUserIDs AS ExternalIDs
		INNER JOIN [dbo].[CN_NodeMembers] AS NM 
		ON NM.ApplicationID = @ApplicationID AND
			NM.NodeID = ExternalIDs.FirstValue AND NM.UserID = ExternalIDs.SecondValue
		INNER JOIN [dbo].[CN_View_Nodes_Normal] AS VN 
		ON VN.ApplicationID = @ApplicationID AND VN.NodeID = NM.NodeID
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_GetMemberNodes]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_GetMemberNodes]
GO

CREATE PROCEDURE [dbo].[CN_GetMemberNodes]
	@ApplicationID			uniqueidentifier,
    @strUserIDs				varchar(max),
    @strNodeTypeIDs			varchar(max),
    @delimiter				char,
    @NodeTypeAdditionalID	varchar(20),
    @IsAdmin				bit
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @NodeTypeIDs GuidTableType, @UserIDs GuidTableType
	DECLARE @NTCount int
	
	INSERT INTO @UserIDs
	SELECT Ref.Value FROM [dbo].[GFN_StrToGuidTable](@strUserIDs, @delimiter) AS Ref
	
	INSERT INTO @NodeTypeIDs
	SELECT Ref.Value FROM [dbo].[GFN_StrToGuidTable](@strNodeTypeIDs, @delimiter) AS Ref
	
	DECLARE @AddID uniqueidentifier = [dbo].[CN_FN_GetNodeTypeID](@ApplicationID, @NodeTypeAdditionalID)
	IF @AddID IS NOT NULL BEGIN
		INSERT INTO @NodeTypeIDs(Value)
		VALUES(@AddID)
	END
	
	SET @NTCount = (SELECT COUNT(*) FROM @NodeTypeIDs)
	
	DECLARE @NodeUserIDs GuidPairTableType

	INSERT INTO @NodeUserIDs (FirstValue, SecondValue)
    SELECT NM.NodeID, NM.UserID
    FROM @UserIDs AS U
		INNER JOIN [dbo].[CN_View_NodeMembers] AS NM 
		ON NM.ApplicationID = @ApplicationID AND NM.UserID = U.Value
	WHERE (@NTCount = 0 OR NM.NodeTypeID IN(SELECT * FROM @NodeTypeIDs)) AND
		(@IsAdmin IS NULL OR NM.IsAdmin = @IsAdmin) AND NM.IsPending = 0
		
	EXEC [dbo].[CN_P_GetMemberNodes] @ApplicationID, @NodeUserIDs
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_P_GetMemberNodeIDs]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_P_GetMemberNodeIDs]
GO

CREATE PROCEDURE [dbo].[CN_P_GetMemberNodeIDs]
	@ApplicationID			uniqueidentifier,
    @UserID					uniqueidentifier,
    @NodeTypeAdditionalID	varchar(20),
    @Status					varchar(20),
    @IsAdmin				bit
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON

    SELECT NM.NodeID AS ID
    FROM [dbo].[CN_NodeMembers] AS NM 
		INNER JOIN [dbo].[CN_View_Nodes_Normal] AS VN 
		ON VN.ApplicationID = @ApplicationID AND VN.NodeID = NM.NodeID AND 
			(@NodeTypeAdditionalID IS NULL OR VN.TypeAdditionalID = @NodeTypeAdditionalID) AND 
			VN.Deleted = 0
	WHERE NM.ApplicationID = @ApplicationID AND NM.UserID = @UserID AND 
		(@Status IS NULL OR NM.[Status] = @Status) AND
		(@IsAdmin IS NULL OR NM.IsAdmin = @IsAdmin) AND NM.Deleted = 0
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_GetUsersDepartments]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_GetUsersDepartments]
GO

CREATE PROCEDURE [dbo].[CN_GetUsersDepartments]
	@ApplicationID	uniqueidentifier,
    @strUserIDs		varchar(max),
    @delimiter		char
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @UserIDs GuidTableType
	INSERT INTO @UserIDs
	SELECT DISTINCT Ref.Value FROM [dbo].[GFN_StrToGuidTable](@strUserIDs, @delimiter) AS Ref
	
	DECLARE @DepTypeIDs GuidTableType
	INSERT INTO @DepTypeIDs (Value)
	SELECT Ref.NodeTypeID
	FROM [dbo].[CN_FN_GetDepartmentNodeTypeIDs](@ApplicationID) AS Ref
	
	DECLARE @NodeUserIDs GuidPairTableType

	INSERT INTO @NodeUserIDs (FirstValue, SecondValue)
    SELECT NM.NodeID, NM.UserID
    FROM @UserIDs AS ExternalIDs
		INNER JOIN [dbo].[CN_NodeMembers] AS NM 
		ON NM.ApplicationID = @ApplicationID AND NM.UserID = ExternalIDs.Value
		INNER JOIN [dbo].[CN_View_Nodes_Normal] AS VN 
		ON VN.ApplicationID = @ApplicationID AND VN.NodeID = NM.NodeID
	WHERE VN.NodeTypeID IN (SELECT Value FROM @DepTypeIDs) AND 
		NM.Deleted = 0 AND VN.Deleted = 0
		
	EXEC [dbo].[CN_P_GetMemberNodes] @ApplicationID, @NodeUserIDs
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_LikeNodes]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_LikeNodes]
GO

CREATE PROCEDURE [dbo].[CN_LikeNodes]
	@ApplicationID	uniqueidentifier,
	@strNodeIDs		varchar(max),
	@delimiter		char,
    @UserID			uniqueidentifier,
    @LikeDate		datetime
WITH ENCRYPTION
AS
BEGIN TRANSACTION
	SET NOCOUNT ON

	DECLARE @NodeIDs GuidTableType
	INSERT INTO @NodeIDs
	SELECT Ref.Value FROM [dbo].[GFN_StrToGuidTable](@strNodeIDs, @delimiter) AS Ref
	
	DECLARE @Existing GuidTableType
	INSERT INTO @Existing
	SELECT Ref.Value
	FROM @NodeIDs AS Ref
		INNER JOIN [dbo].[CN_NodeLikes] AS NL
		ON NL.ApplicationID = @ApplicationID AND NL.NodeID = Ref.Value
	WHERE NL.UserID = @UserID
	
	DECLARE @NotExisting GuidTableType
	INSERT INTO @NotExisting
	SELECT Ref.Value
	FROM @NodeIDs AS Ref
	WHERE Ref.Value NOT IN (SELECT * FROM @Existing)
	
	IF EXISTS(SELECT TOP(1) * FROM @Existing) BEGIN
		UPDATE NL
			SET LikeDate = @LikeDate,
				Deleted = 0
		FROM @Existing AS Ref
			INNER JOIN [dbo].[CN_NodeLikes] AS NL
			ON NL.ApplicationID = @ApplicationID AND NL.[NodeID] = Ref.Value
		WHERE NL.[UserID] = @UserID
		
		IF @@ROWCOUNT <= 0 BEGIN
			SELECT -1
			ROLLBACK TRANSACTION
			RETURN
		END
	END
	
	IF EXISTS(SELECT TOP(1) * FROM @NotExisting) BEGIN
		INSERT INTO [dbo].[CN_NodeLikes](
			ApplicationID,
			NodeID,
			UserID,
			LikeDate,
			Deleted,
			UniqueID
		)
		SELECT @ApplicationID, Ref.Value, @UserID, @LikeDate, 0, NEWID()
		FROM @NotExisting AS Ref
		
		IF @@ROWCOUNT <= 0 BEGIN
			SELECT -1
			ROLLBACK TRANSACTION
			RETURN
		END
	END

	SELECT 1
COMMIT TRANSACTION

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_UnlikeNodes]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_UnlikeNodes]
GO

CREATE PROCEDURE [dbo].[CN_UnlikeNodes]
	@ApplicationID	uniqueidentifier,
    @strNodeIDs		varchar(max),
    @delimiter		char,
    @UserID			uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @NodeIDs GuidTableType
	INSERT INTO @NodeIDs
	SELECT Ref.Value FROM [dbo].[GFN_StrToGuidTable](@strNodeIDs, @delimiter) AS Ref

	UPDATE NL
		SET Deleted = 1
	FROM @NodeIDs AS Ref
		INNER JOIN [dbo].[CN_NodeLikes] AS NL
		ON NL.ApplicationID = @ApplicationID AND NL.[NodeID] = Ref.Value
	WHERE NL.[UserID] = @UserID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_IsFan]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_IsFan]
GO

CREATE PROCEDURE [dbo].[CN_IsFan]
	@ApplicationID	uniqueidentifier,
    @strNodeIDs		varchar(max),
    @delimiter		char,
    @UserID			uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @NodeIDs GuidTableType
	INSERT INTO @NodeIDs
	SELECT Ref.Value FROM [dbo].[GFN_StrToGuidTable](@strNodeIDs, @delimiter) AS Ref

	SELECT Ref.Value AS ID
	FROM @NodeIDs AS Ref
		INNER JOIN [dbo].[CN_NodeLikes] AS NL
		ON NL.ApplicationID = @ApplicationID AND NL.NodeID = Ref.Value
	WHERE NL.UserID = @UserID AND NL.Deleted = 0
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_GetNodeFansUserIDs]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_GetNodeFansUserIDs]
GO

CREATE PROCEDURE [dbo].[CN_GetNodeFansUserIDs]
	@ApplicationID	uniqueidentifier,
    @NodeID			uniqueidentifier,
    @Count			int,
    @LowerBoundary	bigint
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	IF ISNULL(@Count, 0) <= 0 SET @Count = 1000000
	
	SELECT TOP(@Count)
		Ref.RowNumber AS [Order],
		(Ref.RowNumber + Ref.RevRowNumber - 1) AS TotalCount,
		Ref.UserID AS UserID
	FROM (
			SELECT	ROW_NUMBER() OVER (ORDER BY NL.LikeDate DESC, NL.UserID DESC) AS RowNumber,
					ROW_NUMBER() OVER (ORDER BY NL.LikeDate ASC, NL.UserID ASC) AS RevRowNumber,
					NL.UserID
			FROM [dbo].[CN_NodeLikes] AS NL
			WHERE NL.ApplicationID = @ApplicationID AND NL.NodeID = @NodeID AND NL.Deleted = 0
		) AS Ref
	WHERE Ref.RowNumber >= ISNULL(@LowerBoundary, 0)
	ORDER BY Ref.RowNumber ASC
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_GetFavoriteNodesCount]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_GetFavoriteNodesCount]
GO

CREATE PROCEDURE [dbo].[CN_GetFavoriteNodesCount]
	@ApplicationID	uniqueidentifier,
	@UserID			uniqueidentifier,
	@NodeTypeID		uniqueidentifier,
	@NodeID			uniqueidentifier,
	@AdditionalID	varchar(50),
	@IsDocument		bit,
	@LowerDateLimit	datetime,
	@UpperDateLimit	datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	IF @NodeID IS NOT NULL SET @NodeTypeID = NULL
	IF @NodeID IS NOT NULL OR @AdditionalID = N'' SET @AdditionalID = NULL
	
	SELECT	ND.NodeTypeID, 
			MAX(ND.TypeAdditionalID) AS NodeTypeAdditionalID,
			MAX(ND.TypeName) AS TypeName, 
			COUNT(ND.NodeID) AS NodesCount
	FROM [dbo].[CN_NodeLikes] AS NL
		INNER JOIN [dbo].[CN_View_Nodes_Normal] AS ND
		ON ND.ApplicationID = @ApplicationID AND ND.NodeID = NL.NodeID
		LEFT JOIN [dbo].[CN_Services] AS S
		ON S.ApplicationID = @ApplicationID AND S.NodeTypeID = ND.NodeTypeID AND S.Deleted = 0
	WHERE NL.ApplicationID = @ApplicationID AND NL.UserID = @UserID AND 
		(@NodeID IS NULL OR ND.NodeID = @NodeID) AND
		(@NodeTypeID IS NULL OR ND.NodeTypeID = @NodeTypeID) AND 
		(@AdditionalID IS NULL OR ND.NodeAdditionalID = @AdditionalID) AND
		(@IsDocument IS NULL OR ISNULL(S.IsDocument, 0) = @IsDocument) AND
		(@LowerDateLimit IS NULL OR ND.CreationDate>= @LowerDateLimit) AND
		(@UpperDateLimit IS NULL OR ND.CreationDate <= @UpperDateLimit) AND
		 NL.Deleted = 0 AND ND.Deleted = 0
	GROUP BY ND.NodeTypeID
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_GetFavoriteNodes]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_GetFavoriteNodes]
GO

CREATE PROCEDURE [dbo].[CN_GetFavoriteNodes]
	@ApplicationID			uniqueidentifier,
    @UserID					uniqueidentifier,
	@strNodeTypeIDs			nvarchar(max),
	@delimiter				char,
	@NodeID					uniqueidentifier,
	@AdditionalID			varchar(50),
	@SearchText				nvarchar(1000),
	@IsDocument				bit,
	@LowerDateLimit			datetime,
	@UpperDateLimit			datetime,
	@LowerBoundary			int,
	@Count					int
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON

	DECLARE @NodeTypeIDs KeyLessGuidTableType
	
	INSERT INTO @NodeTypeIDs ([Value])
	SELECT DISTINCT Ref.[Value]
	FROM [dbo].[GFN_StrToGuidTable](@strNodeTypeIDs, @delimiter) AS Ref
	
	DECLARE @NTCount int = (SELECT COUNT(*) FROM @NodeTypeIDs)
	
	IF @NodeID IS NOT NULL SET @NTCount = 0
	IF @NodeID IS NOT NULL OR @AdditionalID = N'' SET @AdditionalID = NULL
	IF @Count IS NULL OR @Count <= 0 SET @Count = 10
	
	SET @SearchText = [dbo].[GFN_VerifyString](@SearchText)
	IF @SearchText IS NULL OR @SearchText = N'' SET @SearchText = NULL

	DECLARE @SelectedIDs KeyLessGuidTableType

	IF @SearchText IS NULL BEGIN
		INSERT INTO @SelectedIDs (Value)
		SELECT Ref.NodeID
		FROM (
				SELECT ROW_NUMBER() OVER (ORDER BY NL.LikeDate DESC, NL.NodeID DESC) AS RowNumber, ND.NodeID
				FROM [dbo].[CN_NodeLikes] AS NL
					INNER JOIN [dbo].[CN_View_Nodes_Normal] AS ND
					ON ND.ApplicationID = @ApplicationID AND ND.NodeID = NL.NodeID
					LEFT JOIN [dbo].[CN_Services] AS S
					ON S.ApplicationID = @ApplicationID AND S.NodeTypeID = ND.NodeTypeID AND S.Deleted = 0
				WHERE NL.ApplicationID = @ApplicationID AND NL.UserID = @UserID AND 
					(@NodeID IS NULL OR ND.NodeID = @NodeID) AND
					(@NTCount = 0 OR ND.NodeTypeID IN (SELECT NTIDs.Value FROM @NodeTypeIDs AS NTIDs)) AND 
					(@AdditionalID IS NULL OR ND.NodeAdditionalID = @AdditionalID) AND
					(@IsDocument IS NULL OR ISNULL(S.IsDocument, 0) = @IsDocument) AND
					(@LowerDateLimit IS NULL OR ND.CreationDate >= @LowerDateLimit) AND
					(@UpperDateLimit IS NULL OR ND.CreationDate <= @UpperDateLimit) AND
					NL.Deleted = 0 AND ND.Deleted = 0
			) AS Ref
		ORDER BY Ref.RowNumber ASC
	END
	ELSE BEGIN
		INSERT INTO @SelectedIDs (Value)
		SELECT Ref.NodeID
		FROM (
				SELECT ROW_NUMBER() OVER (ORDER BY SRCH.[Rank] DESC, SRCH.[Key] DESC) AS RowNumber, ND.NodeID
				FROM CONTAINSTABLE([dbo].[CN_Nodes], ([Name], [AdditionalID]), @SearchText) AS SRCH
					INNER JOIN [dbo].[CN_NodeLikes] AS NL
					INNER JOIN [dbo].[CN_View_Nodes_Normal] AS ND
					ON ND.ApplicationID = @ApplicationID AND ND.NodeID = NL.NodeID
					ON ND.NodeID = SRCH.[Key]
					LEFT JOIN [dbo].[CN_Services] AS S
					ON S.ApplicationID = @ApplicationID AND S.NodeTypeID = ND.NodeTypeID AND S.Deleted = 0
				WHERE NL.ApplicationID = @ApplicationID AND NL.UserID = @UserID AND 
					(@NodeID IS NULL OR ND.NodeID = @NodeID) AND
					(@NTCount = 0 OR ND.NodeTypeID IN (SELECT NTIDs.Value FROM @NodeTypeIDs AS NTIDs)) AND 
					(@AdditionalID IS NULL OR ND.NodeAdditionalID = @AdditionalID) AND
					(@IsDocument IS NULL OR ISNULL(S.IsDocument, 0) = @IsDocument) AND
					(@LowerDateLimit IS NULL OR ND.CreationDate >= @LowerDateLimit) AND
					(@UpperDateLimit IS NULL OR ND.CreationDate <= @UpperDateLimit) AND
					NL.Deleted = 0 AND ND.Deleted = 0
			) AS Ref
		ORDER BY Ref.RowNumber ASC	
	END

	DECLARE @NodeIDs KeyLessGuidTableType

	INSERT INTO @NodeIDs (Value)
	SELECT TOP(@Count) S.Value 
	FROM @SelectedIDs AS S
	WHERE S.SequenceNumber >= ISNULL(@LowerBoundary, 0)
	
	EXEC [dbo].[CN_P_GetNodesByIDs] @ApplicationID, @NodeIDs, 0, NULL
	
	SELECT TOP(1) COUNT(S.[Value]) AS TotalCount FROM @SelectedIDs AS S
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_AddComplex]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_AddComplex]
GO

CREATE PROCEDURE [dbo].[CN_AddComplex]
	@ApplicationID			uniqueidentifier,
    @ListID					uniqueidentifier,
    @NodeTypeID				uniqueidentifier,
    @Name					nvarchar(255),
    @Description			nvarchar(2000),
    @CreatorUserID			uniqueidentifier,
    @CreationDate			datetime,
    @ParentListID			uniqueidentifier,
    @OwnerID				uniqueidentifier,
    @OwnerType				varchar(20)
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SET @Name = [dbo].[GFN_VerifyString](@Name)
	SET @Description = [dbo].[GFN_VerifyString](@Description)

	INSERT INTO [dbo].[CN_Lists](
		ApplicationID,
		ListID,
		NodeTypeID,
		Name,
		[Description],
		CreatorUserID,
		CreationDate,
		ParentListID,
		OwnerID,
		OwnerType,
		Deleted
	)
	VALUES(
		@ApplicationID,
		@ListID,
		@NodeTypeID,
		@Name,
		@Description,
		@CreatorUserID,
		@CreationDate,
		@ParentListID,
		@OwnerID,
		@OwnerType,
		0
	)

	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_ModifyComplex]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_ModifyComplex]
GO

CREATE PROCEDURE [dbo].[CN_ModifyComplex]
	@ApplicationID			uniqueidentifier,
    @ListID					uniqueidentifier,
    @Name					nvarchar(255),
    @Description			nvarchar(2000),
    @LastModifierUserID		uniqueidentifier,
    @LastModificationDate	datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON

	SET @Name = [dbo].[GFN_VerifyString](@Name)
	SET @Description = [dbo].[GFN_VerifyString](@Description)

	UPDATE [dbo].[CN_Lists]
		SET Name = @Name,
			[Description] = @Description,
			LastModifierUserID = @LastModifierUserID,
			LastModificationDate = @LastModificationDate
	WHERE ApplicationID = @ApplicationID AND ListID = @ListID

	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_ArithmeticDeleteComplexes]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_ArithmeticDeleteComplexes]
GO

CREATE PROCEDURE [dbo].[CN_ArithmeticDeleteComplexes]
	@ApplicationID			uniqueidentifier,
    @strListIDs				varchar(max),
    @delimiter				char,
    @LastModifierUsreID		uniqueidentifier,
    @LastModificationDate	datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON

	DECLARE @ListIDs GuidTableType
	INSERT INTO @ListIDs 
	SELECT DISTINCT Ref.Value FROM [dbo].[GFN_StrToGuidTable](@strListIDs, @delimiter) AS Ref

	UPDATE L
		SET Deleted = 1,
			LastModifierUserID = @LastModifierUsreID,
			LastModificationDate = @LastModificationDate
	FROM @ListIDs AS ExternalIDs
		INNER JOIN [dbo].[CN_Lists] AS L
		ON L.ApplicationID = @ApplicationID AND L.[ListID] = ExternalIDs.Value
	WHERE L.[Deleted] = 0

	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_P_GetListsByIDs]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_P_GetListsByIDs]
GO

CREATE PROCEDURE [dbo].[CN_P_GetListsByIDs]
	@ApplicationID	uniqueidentifier,
    @ListIDsTemp	GuidTableType readonly
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @ListIDs GuidTableType
	INSERT INTO @ListIDs SELECT * FROM @ListIDsTemp
	
	SELECT LS.ListID AS ListID,
		   LS.Name AS ListName,
		   LS.[Description] AS [Description],
		   LS.AdditionalID AS AdditionalID,
		   LS.NodeTypeID AS NodeTypeID,
		   NT.Name AS NodeType,
		   OwnerID AS OwnerID,
		   OwnerType AS OwnerType
	FROM @ListIDs AS Ref
		INNER JOIN [dbo].[CN_Lists] AS LS
		ON LS.ApplicationID = @ApplicationID AND LS.ListID = Ref.Value
		INNER JOIN [dbo].[CN_NodeTypes] AS NT
		ON NT.ApplicationID = @ApplicationID AND NT.NodeTypeID = LS.NodeTypeID
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_GetListsByIDs]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_GetListsByIDs]
GO

CREATE PROCEDURE [dbo].[CN_GetListsByIDs]
	@ApplicationID	uniqueidentifier,
	@strListIDs		varchar(max),
	@delimiter		char
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON

	DECLARE @ListIDs GuidTableType
	INSERT INTO @ListIDs
	SELECT DISTINCT Ref.Value FROM [dbo].[GFN_StrToGuidTable](@strListIDs, @delimiter) AS Ref
	
	EXEC [dbo].[CN_P_GetListsByIDs] @ApplicationID, @ListIDs
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_GetLists]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_GetLists]
GO

CREATE PROCEDURE [dbo].[CN_GetLists]
	@ApplicationID			uniqueidentifier,
	@NodeTypeID				uniqueidentifier,
	@NodeTypeAdditionalID	varchar(50),
    @SearchText				nvarchar(1000),
    @Count					int,
    @MinID					uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON

	SET @SearchText = [dbo].[GFN_VerifyString](@SearchText)
	
	IF @NodeTypeID IS NULL AND @NodeTypeAdditionalID IS NOT NULL BEGIN
		SET @NodeTypeID = (
			SELECT TOP(1) NodeTypeID 
			FROM [dbo].[CN_NodeTypes] 
			WHERE ApplicationID = @ApplicationID AND AdditionalID = @NodeTypeAdditionalID
		)
	END

	DECLARE @TempIDs Table(sqno bigint IDENTITY(1, 1), ListID uniqueidentifier)
	DECLARE @ListIDs GuidTableType
	
	DECLARE @_ST nvarchar(1000) = @SearchText
	IF @SearchText IS NULL OR @SearchText = N'' SET @_ST = NULL
	
	IF @Count IS NULL OR @Count <= 0 SET @Count = 1000
	
	IF @_ST IS NULL BEGIN
		INSERT INTO @TempIDs
		SELECT LS.[ListID] 
		FROM [dbo].[CN_Lists] AS LS
		WHERE LS.ApplicationID = @ApplicationID AND 
			(@NodeTypeID IS NULL OR LS.[NodeTypeID] = @NodeTypeID) AND LS.[Deleted] = 0
	END
	ELSE BEGIN
		INSERT INTO @ListIDs
		SELECT LS.[ListID] 
		FROM [dbo].[CN_Lists] AS LS
		WHERE LS.ApplicationID = @ApplicationID AND 
			(@NodeTypeID IS NULL OR LS.[NodeTypeID] = @NodeTypeID) AND 
			LS.[Deleted] = 0 AND CONTAINS(LS.[Name], @_ST)
	END
	
	DECLARE @Loc bigint = 0
	IF @MinID IS NOT NULL 
		SET @Loc = (SELECT TOP(1) Ref.sqno FROM @TempIDs AS Ref WHERE Ref.ListID = @MinID)
	IF @Loc IS NULL SET @Loc = 0
	
	INSERT INTO @ListIDs
	SELECT TOP(@Count) Ref.ListID FROM @TempIDs AS Ref WHERE Ref.sqno > @Loc
	
	EXEC [dbo].[CN_P_GetListsByIDs] @ApplicationID, @ListIDs
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_P_AddNodesToList]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_P_AddNodesToList]
GO

CREATE PROCEDURE [dbo].[CN_P_AddNodesToList]
	@ApplicationID	uniqueidentifier,
	@ListID			uniqueidentifier,
    @NodeIDsTemp	GuidTableType readonly,
    @CreatorUserID	uniqueidentifier,
    @CreationDate	datetime,
    @_Result		int output
WITH ENCRYPTION, RECOMPILE
AS
BEGIN TRANSACTION
	SET NOCOUNT ON
	
	DECLARE @NodeIDs GuidTableType
	INSERT INTO @NodeIDs SELECT * FROM @NodeIDsTemp
	
	SET @_Result = -1
	
	DECLARE @_existingNodes GuidTableType, @_notExistingNodes GuidTableType
	DECLARE @_count int
	
	INSERT INTO @_existingNodes
	SELECT NID.Value
	FROM @NodeIDs AS NID
		INNER JOIN [dbo].[CN_ListNodes] AS LN
		ON LN.ApplicationID = @ApplicationID AND LN.NodeID = NID.Value
	WHERE LN.ListID = @ListID
	
	SET @_count = (SELECT COUNT(*) FROM @_existingNodes)
	
	IF @_count > 0 BEGIN
		UPDATE LN
			SET LastModifierUserID = @CreatorUserID,
				LastModificationDate = @CreationDate,
				Deleted = 0
		FROM @_existingNodes AS EN
			INNER JOIN [dbo].[CN_ListNodes] AS LN
			ON LN.NodeID = EN.Value
		WHERE LN.ApplicationID = @ApplicationID AND LN.ListID = @ListID
		
		IF @@ROWCOUNT <= 0 BEGIN
			ROLLBACK TRANSACTION
			RETURN
		END
	END
	
	
	INSERT INTO @_notExistingNodes
	SELECT NID.Value
	FROM @NodeIDs AS NID
	WHERE NOT EXISTS(SELECT TOP(1) * FROM @_existingNodes AS Ref
		WHERE NID.Value = Ref.Value)
	
	SET @_count = (SELECT COUNT(*) FROM @_notExistingNodes)
	
	IF @_count > 0 BEGIN
		INSERT INTO [dbo].[CN_ListNodes](
			ApplicationID,
			ListID,
			NodeID,
			CreatorUserID,
			CreationDate,
			Deleted
		)
		SELECT @ApplicationID, @ListID, NEN.Value, @CreatorUserID, @CreationDate, 0
		FROM @_notExistingNodes AS NEN
	
		IF @@ROWCOUNT <= 0 BEGIN
			ROLLBACK TRANSACTION
			RETURN
		END
	END	

	SET @_Result = 1
COMMIT TRANSACTION

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_AddNodesToComplex]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_AddNodesToComplex]
GO

CREATE PROCEDURE [dbo].[CN_AddNodesToComplex]
	@ApplicationID	uniqueidentifier,
	@ListID			uniqueidentifier,
    @strNodeIDs		varchar(max),
    @delimiter		char,
    @CreatorUserID	uniqueidentifier,
    @CreationDate	datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @NodeIDs GuidTableType
	INSERT INTO @NodeIDs
	SELECT DISTINCT Ref.Value FROM [dbo].[GFN_StrToGuidTable](@strNodeIDs, @delimiter) AS Ref
	
	DECLARE @_Result int
	
	EXEC [dbo].[CN_P_AddNodesToList] @ApplicationID, @ListID, @NodeIDs, 
		@CreatorUserID, @CreationDate, @_Result output
		
	SELECT @_Result
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_ArithmeticDeleteComplexNodes]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_ArithmeticDeleteComplexNodes]
GO

CREATE PROCEDURE [dbo].[CN_ArithmeticDeleteComplexNodes]
	@ApplicationID			uniqueidentifier,
	@ListID					uniqueidentifier,
    @strNodeIDs				varchar(max),
    @delimiter				char,
    @LastModifierUserID		uniqueidentifier,
    @LastModificationDate	datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @NodeIDs GuidTableType
	INSERT INTO @NodeIDs
	SELECT DISTINCT Ref.Value FROM [dbo].[GFN_StrToGuidTable](@strNodeIDs, @delimiter) AS Ref
		
	UPDATE LN
		SET Deleted = 1,
			LastModifierUserID = @LastModifierUserID,
			LastModificationDate = @LastModificationDate
	FROM @NodeIDs AS NID
		INNER JOIN [dbo].[CN_ListNodes] AS LN
		ON LN.NodeID = NID.Value
	WHERE LN.ApplicationID = @ApplicationID AND LN.ListID = @ListID AND LN.Deleted = 0

	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_GetListNodes]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_GetListNodes]
GO

CREATE PROCEDURE [dbo].[CN_GetListNodes]
	@ApplicationID			uniqueidentifier,
	@ListID					uniqueidentifier,
	@NodeTypeID				uniqueidentifier,
	@NodeTypeAdditionalID	varchar(50)
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	IF @NodeTypeID IS NULL 
		SET @NodeTypeID = [dbo].[CN_FN_GetNodeTypeID](@ApplicationID, @NodeTypeAdditionalID)
	
	DECLARE @NodeIDs KeyLessGuidTableType
	
	INSERT INTO @NodeIDs (Value)
	SELECT LN.NodeID
	FROM [dbo].[CN_ListNodes] AS LN
		INNER JOIN [dbo].[CN_Nodes] AS Node
		ON Node.ApplicationID = @ApplicationID AND Node.NodeID = LN.NodeID
	WHERE LN.ApplicationID = @ApplicationID AND LN.ListID = @ListID AND LN.Deleted = 0 AND 
		(@NodeTypeID IS NULL OR Node.NodeTypeID = @NodeTypeID) AND Node.Deleted = 0

	EXEC [dbo].[CN_P_GetNodesByIDs] @ApplicationID, @NodeIDs, 0, NULL
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_P_AddTags]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_P_AddTags]
GO

CREATE PROCEDURE [dbo].[CN_P_AddTags]
	@ApplicationID	uniqueidentifier,
	@TagsTemp		StringTableType readonly,
	@CreatorUserID	uniqueidentifier,
	@CreationDate	datetime,
	@TagID			uniqueidentifier output
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @Tags StringTableType
	INSERT INTO @Tags SELECT * FROM @TagsTemp
	
	DECLARE @VerifiedTags GuidStringTableType
	INSERT INTO @VerifiedTags (FirstValue, SecondValue)
	SELECT NEWID(), Ref.Val
	FROM (
			SELECT DISTINCT [dbo].[GFN_VerifyString](TG.Value) AS Val
			FROM @Tags AS TG
		) AS Ref
	
	DECLARE @ExistingTags GuidPairTableType
	INSERT INTO @ExistingTags
	SELECT TG.TagID, Ref.FirstValue
	FROM @VerifiedTags AS Ref
		INNER JOIN [dbo].[CN_Tags] AS TG
		ON TG.ApplicationID = @ApplicationID AND TG.Tag = Ref.SecondValue
		
	DECLARE @NotExistingTags GuidStringTableType
	INSERT INTO @NotExistingTags
	SELECT Ref.FirstValue, Ref.SecondValue
	FROM @VerifiedTags AS Ref
	WHERE Ref.FirstValue NOT IN (SELECT ET.SecondValue FROM @ExistingTags AS ET)
	
	IF EXISTS(SELECT TOP(1) * FROM @ExistingTags) BEGIN
		SET @TagID = (SELECT TOP(1) FirstValue FROM @ExistingTags AS Ref)
		
		UPDATE TG
			SET CallsCount = CallsCount + 1
		FROM @ExistingTags AS ET
			INNER JOIN [dbo].[CN_Tags] AS TG
			ON TG.ApplicationID = @ApplicationID AND TG.TagID = ET.FirstValue
	END
	ELSE BEGIN
		SET @TagID = (SELECT TOP(1) FirstValue FROM @NotExistingTags AS Ref)
		
		INSERT INTO [dbo].[CN_Tags](
			ApplicationID,
			TagID,
			Tag,
			IsApproved,
			CallsCount,
			CreatorUserID,
			CreationDate,
			Deleted
		)
		SELECT @ApplicationID, Ref.FirstValue, Ref.SecondValue, 0, 0, 
			@CreatorUserID, @CreationDate, 0
		FROM @NotExistingTags AS Ref
	END
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_AddTags]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_AddTags]
GO

CREATE PROCEDURE [dbo].[CN_AddTags]
	@ApplicationID	uniqueidentifier,
	@TagsTemp		StringTableType readonly,
	@CreatorUserID	uniqueidentifier,
	@CreationDate	datetime
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @Tags StringTableType
	INSERT INTO @Tags SELECT * FROM @TagsTemp
	
	DECLARE @TagID uniqueidentifier
	
	EXEC [dbo].[CN_P_AddTags] @ApplicationID, @Tags, 
		@CreatorUserID, @CreationDate, @TagID output
	
	SELECT @TagID AS ID
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_P_SearchTags]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_P_SearchTags]
GO

CREATE PROCEDURE [dbo].[CN_P_SearchTags]
	@ApplicationID	uniqueidentifier,
	@SearchText		nvarchar(1000),
	@Count			int,
	@LowerBoundary	int
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SET @SearchText = [dbo].[GFN_VerifyString](@SearchText)
	
	IF @Count IS NULL OR @Count <= 0 SET @Count = 1000
	
	IF ISNULL(@SearchText, N'') = N'' BEGIN
		SELECT TOP(@Count) X.TagID, X.Tag, X.IsApproved, X.CallsCount
		FROM (
				SELECT	ROW_NUMBER() OVER (ORDER BY Tag ASC) AS RowNumber,
						TagID, 
						Tag, 
						IsApproved, 
						CallsCount
				FROM [dbo].[CN_Tags] AS TG
				WHERE TG.ApplicationID = @ApplicationID AND TG.Deleted = 0 AND ISNULL(TG.Tag, N'') <> N''
			) AS X
		WHERE X.RowNumber >= ISNULL(@LowerBoundary, 0)
		ORDER BY X.RowNumber ASC
	END
	ELSE BEGIN
		SELECT TOP(@Count) X.TagID, X.Tag, X.IsApproved, X.CallsCount
		FROM (
				SELECT	ROW_NUMBER() OVER (ORDER BY SRCH.[Rank] DESC, Tag ASC) AS RowNumber,
						TagID, 
						Tag, 
						IsApproved, 
						CallsCount
				FROM CONTAINSTABLE([dbo].[CN_Tags], Tag, @SearchText) AS SRCH
					INNER JOIN [dbo].[CN_Tags] AS TG
					ON TG.ApplicationID = @ApplicationID AND TG.TagID = SRCH.[Key] AND TG.Deleted = 0
			) AS X
		WHERE X.RowNumber >= ISNULL(@LowerBoundary, 0)
		ORDER BY X.RowNumber ASC
	END
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_SearchTags]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_SearchTags]
GO

CREATE PROCEDURE [dbo].[CN_SearchTags]
	@ApplicationID	uniqueidentifier,
	@SearchText		nvarchar(1000),
	@Count			int,
	@LowerBoundary	int
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	EXEC [dbo].[CN_P_SearchTags] @ApplicationID, @SearchText, @Count, @LowerBoundary
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_P_SetNodeCreators]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_P_SetNodeCreators]
GO

CREATE PROCEDURE [dbo].[CN_P_SetNodeCreators]
	@ApplicationID	uniqueidentifier,
	@NodeID			uniqueidentifier,
	@CreatorsTemp	GuidFloatTableType readonly,
	@Status			varchar(20),
	@CreatorUserID	uniqueidentifier,
	@CreationDate	datetime,
	@_Result		int	output
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @Creators GuidFloatTableType
	INSERT INTO @Creators SELECT * FROM @CreatorsTemp
	
	IF (SELECT COUNT(*) FROM @Creators) = 0 BEGIN
		SET @_Result = 1
		RETURN
	END
	
	DECLARE @Shares Table (UserID uniqueidentifier, Share float, [Exists] bit)
	
	INSERT INTO @Shares (UserID, Share, [Exists])
	SELECT Ref.FirstValue, Ref.SecondValue, CASE WHEN NC.NodeID IS NULL THEN 0 ELSE 1 END
	FROM @Creators AS Ref
		LEFT JOIN [dbo].[CN_NodeCreators] AS NC
		ON NC.ApplicationID = @ApplicationID AND 
			NC.NodeID = @NodeID AND NC.UserID = Ref.FirstValue
	
		
	UPDATE [dbo].[CN_NodeCreators]
		SET Deleted = 1,
			LastModifierUserID = @CreatorUserID,
			LastModificationDate = @CreationDate
	FROM [dbo].[CN_NodeCreators]
	WHERE ApplicationID = @ApplicationID AND NodeID = @NodeID
		
		
	IF EXISTS(SELECT TOP(1) UserID FROM @Shares WHERE [Exists] = 1) BEGIN
		UPDATE NC
			SET Deleted = 0,
				CollaborationShare = Ref.Share,
				[Status] = @Status,
				LastModifierUserID = @CreatorUserID,
				LastModificationDate = @CreationDate
		FROM @Shares AS Ref
			INNER JOIN [dbo].[CN_NodeCreators] AS NC
			ON NC.UserID = Ref.UserID
		WHERE NC.ApplicationID = @ApplicationID AND NC.NodeID = @NodeID
		
		IF @@ROWCOUNT <= 0 BEGIN
			SET @_Result = -1
			RETURN
		END
	END
	
	IF EXISTS(SELECT TOP(1) UserID FROM @Shares WHERE [Exists] = 0) BEGIN
		INSERT INTO [dbo].[CN_NodeCreators](
			ApplicationID,
			NodeID,
			UserID,
			CollaborationShare,
			[Status],
			CreatorUserID,
			CreationDate,
			Deleted,
			UniqueID
		)
		SELECT	@ApplicationID, @NodeID, Ref.UserID, Ref.Share, @Status, 
				@CreatorUserID, @CreationDate, 0, NEWID()
		FROM @Shares AS Ref
		WHERE Ref.[Exists] = 0
		
		IF @@ROWCOUNT <= 0 BEGIN
			SET @_Result = -1
			RETURN
		END
	END
	
	SET @_Result = 1
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_SetContributors]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_SetContributors]
GO

CREATE PROCEDURE [dbo].[CN_SetContributors]
	@ApplicationID			uniqueidentifier,
	@NodeID					uniqueidentifier,
	@ContributorsTemp		GuidFloatTableType readonly,
	@OwnerID				uniqueidentifier,
	@LastModifierUserID		uniqueidentifier,
	@LastModificationDate	datetime
WITH ENCRYPTION, RECOMPILE
AS
BEGIN TRANSACTION
	SET NOCOUNT ON
	
	DECLARE @Contributors GuidFloatTableType
	INSERT INTO @Contributors SELECT * FROM @ContributorsTemp
	
	DECLARE @_Result int = 0
	
	EXEC [dbo].[CN_P_SetNodeCreators] @ApplicationID, @NodeID, @Contributors, N'Accepted', 
		@LastModifierUserID, @LastModificationDate, @_Result output 
	
	IF @_Result <= 0 BEGIN
		SELECT -1, N'ErrorInAddingNodeCreators'
		ROLLBACK TRANSACTION
		RETURN
	END
	
	UPDATE [dbo].[CN_Nodes]
		SET OwnerID = @OwnerID,
			LastModifierUserID = @LastModifierUserID,
			LastModificationDate = @LastModificationDate
	WHERE ApplicationID = @ApplicationID AND NodeID = @NodeID
	
	IF @@ROWCOUNT <= 0 BEGIN
		SELECT -1, N'SettingNodeOwnerFailed'
		ROLLBACK TRANSACTION
		RETURN
	END
	
	SELECT 1
COMMIT TRANSACTION

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_GetNodeCreators]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_GetNodeCreators]
GO

CREATE PROCEDURE [dbo].[CN_GetNodeCreators]
	@ApplicationID	uniqueidentifier,
	@NodeID			uniqueidentifier,
	@Full			bit
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	IF @Full IS NULL OR @Full = 0 BEGIN
		SELECT NodeID AS NodeID,
			   UserID AS UserID,
			   CollaborationShare AS CollaborationShare,
			   [Status] AS [Status]
		FROM [dbo].[CN_NodeCreators]
		WHERE ApplicationID = @ApplicationID AND NodeID = @NodeID AND Deleted = 0
	END
	ELSE BEGIN
		SELECT NC.NodeID AS NodeID,
			   NC.UserID AS UserID,
			   UN.UserName AS UserName,
			   UN.FirstName AS FirstName,
			   UN.LastName AS LastName,
			   NC.CollaborationShare AS CollaborationShare,
			   NC.[Status] AS [Status]
		FROM [dbo].[CN_NodeCreators] AS NC
			LEFT JOIN [dbo].[Users_Normal] AS UN
			ON UN.ApplicationID = @ApplicationID AND UN.UserID = NC.UserID
		WHERE NC.ApplicationID = @ApplicationID AND NC.NodeID = @NodeID AND NC.Deleted = 0
	END
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_P_GetCreatedNodeIDs]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_P_GetCreatedNodeIDs]
GO

CREATE PROCEDURE [dbo].[CN_P_GetCreatedNodeIDs]
	@ApplicationID	uniqueidentifier,
	@UserID			uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT NodeID AS ID
	FROM [dbo].[CN_Nodes]
	WHERE ApplicationID = @ApplicationID AND CreatorUserID = @UserID AND Deleted = 0
	
	UNION ALL
	
	SELECT NC.NodeID
	FROM [dbo].[CN_NodeCreators] AS NC
		INNER JOIN [dbo].[CN_Nodes] AS ND
		ON ND.ApplicationID = @ApplicationID AND ND.NodeID = NC.NodeID
	WHERE NC.ApplicationID = @ApplicationID AND NC.UserID = @UserID AND NC.Deleted = 0 AND 
		ND.CreatorUserID <> @UserID AND ND.Deleted = 0
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_GetCreatorNodes]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_GetCreatorNodes]
GO

CREATE PROCEDURE [dbo].[CN_GetCreatorNodes]
	@ApplicationID	uniqueidentifier,
	@UserID			uniqueidentifier,
	@NodeTypeID		uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @NodeIDs KeyLessGuidTableType
	
	INSERT INTO @NodeIDs (Value)
	SELECT NC.NodeID
	FROM [dbo].[CN_NodeCreators] AS NC
		INNER JOIN [dbo].[CN_Nodes] AS ND
		ON ND.ApplicationID = @ApplicationID AND ND.NodeID = NC.NodeID
	WHERE NC.ApplicationID = @ApplicationID AND NC.UserID = @UserID AND 
		(@NodeTypeID IS NULL OR ND.NodeTypeID = @NodeTypeID) AND 
		NC.Deleted = 0 AND ND.Deleted = 0
	
	EXEC [dbo].[CN_P_GetNodesByIDs] @ApplicationID, @NodeIDs, NULL, NULL
END

GO


/*     Expert related procedures     */

IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_P_AddExperts]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_P_AddExperts]
GO

CREATE PROCEDURE [dbo].[CN_P_AddExperts]
	@ApplicationID		uniqueidentifier,
    @NodeID 			uniqueidentifier,
    @UserIDsTemp		GuidTableType readonly,
    @_Result			int output
WITH ENCRYPTION, RECOMPILE
AS
BEGIN TRANSACTION
	SET NOCOUNT ON
	
	DECLARE @UserIDs GuidTableType
	INSERT INTO @UserIDs SELECT * FROM @UserIDsTemp
	
	DECLARE @ExistingIDs GuidTableType, @NotExistingIDs GuidTableType
	
	INSERT INTO @ExistingIDs
	SELECT Ref.Value
	FROM @UserIDs AS Ref
		INNER JOIN [dbo].[CN_Experts] AS Ex
		ON Ex.UserID = Ref.Value
	WHERE Ex.ApplicationID = @ApplicationID AND Ex.NodeID = @NodeID
	
	INSERT INTO @NotExistingIDs 
	SELECT Ref.Value
	FROM @UserIDs AS Ref
	EXCEPT(SELECT * FROM @ExistingIDs)
	
	IF (SELECT COUNT(*) FROM @ExistingIDs) > 0 BEGIN
		UPDATE [dbo].[CN_Experts]
			SET Approved = 1
		FROM @ExistingIDs AS Ref
			INNER JOIN [dbo].[CN_Experts] AS Ex
			ON Ex.[UserID] = Ref.Value
		WHERE Ex.ApplicationID = @ApplicationID AND Ex.[NodeID] = @NodeID
		
		IF @@ROWCOUNT <= 0 BEGIN
			SET @_Result = -1
			ROLLBACK TRANSACTION
			RETURN
		END
	END
	
	IF (SELECT COUNT(*) FROM @NotExistingIDs) > 0 BEGIN
		INSERT INTO [dbo].[CN_Experts] (
			[ApplicationID],
			[NodeID],
			[UserID],
			[Approved],
			[ReferralsCount],
			[ConfirmsPercentage],
			[SocialApproved],
			[UniqueID]
		)
		SELECT @ApplicationID, @NodeID, Ref.Value, 1, 0, 0, 0, NEWID()
		FROM @NotExistingIDs AS Ref
		
		IF @@ROWCOUNT <= 0 BEGIN
			SET @_Result = -1
			ROLLBACK TRANSACTION
			RETURN
		END
	END
    
    SET @_Result = 1
COMMIT TRANSACTION

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_AddExperts]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_AddExperts]
GO

CREATE PROCEDURE [dbo].[CN_AddExperts]
	@ApplicationID		uniqueidentifier,
    @NodeID 			uniqueidentifier,
    @strUserIDs			varchar(max),
    @delimiter			char
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @UserIDs GuidTableType
	
	INSERT INTO @UserIDs
	SELECT DISTINCT Ref.Value FROM GFN_StrToGuidTable(@strUserIDs, @delimiter) AS Ref
	
	DECLARE @_Result int
	
	EXEC [dbo].[CN_P_AddExperts] @ApplicationID, @NodeID, @UserIDs, @_Result output
	
	SELECT @_Result
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_P_AddExpert]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_P_AddExpert]
GO

CREATE PROCEDURE [dbo].[CN_P_AddExpert]
	@ApplicationID		uniqueidentifier,
    @NodeID 			uniqueidentifier,
    @UserID				uniqueidentifier,
    @_Result			int output
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @UserIDs GuidTableType
	INSERT INTO @UserIDs (Value) VALUES(@UserID)
	
	EXEC [dbo].[CN_P_AddExperts] @ApplicationID, @NodeID, @UserIDs, @_Result output
	
	SELECT @_Result
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_ArithmeticDeleteExperts]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_ArithmeticDeleteExperts]
GO

CREATE PROCEDURE [dbo].[CN_ArithmeticDeleteExperts]
	@ApplicationID	uniqueidentifier,
    @NodeID 		uniqueidentifier,
    @strUserIDs		varchar(max),
    @delimiter		char
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON

	DECLARE @UserIDs GuidTableType
	
	INSERT INTO @UserIDs
	SELECT DISTINCT Ref.Value FROM GFN_StrToGuidTable(@strUserIDs, @delimiter) AS Ref

    UPDATE [dbo].[CN_Experts]
        SET Approved = 0
    WHERE ApplicationID = @ApplicationID AND [NodeID] = @NodeID AND
		EXISTS(SELECT TOP(1) * FROM @UserIDs AS Ref WHERE [UserID] = Ref.Value)
    
    SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_GetExpertiseDomainsCount]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_GetExpertiseDomainsCount]
GO

CREATE PROCEDURE [dbo].[CN_GetExpertiseDomainsCount]
	@ApplicationID	uniqueidentifier,
	@UserID			uniqueidentifier,
	@NodeTypeID		uniqueidentifier,
	@NodeID			uniqueidentifier,
	@AdditionalID	varchar(50),
	@LowerDateLimit	datetime,
	@UpperDateLimit	datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	IF @NodeID IS NOT NULL SET @NodeTypeID = NULL
	IF @NodeID IS NOT NULL OR @AdditionalID = N'' SET @AdditionalID = NULL
	
	SELECT	ND.NodeTypeID, 
			MAX(ND.TypeAdditionalID) AS NodeTypeAdditionalID,
			MAX(ND.TypeName) AS TypeName, 
			COUNT(ND.NodeID) AS NodesCount
	FROM [dbo].[CN_View_Experts] AS EX
		INNER JOIN [dbo].[CN_View_Nodes_Normal] AS ND
		ON ND.ApplicationID = @ApplicationID AND ND.NodeID = EX.NodeID
	WHERE EX.ApplicationID = @ApplicationID AND EX.UserID = @UserID AND 
		(@NodeID IS NULL OR ND.NodeID = @NodeID) AND
		(@NodeTypeID IS NULL OR ND.NodeTypeID = @NodeTypeID) AND 
		(@AdditionalID IS NULL OR ND.NodeAdditionalID = @AdditionalID) AND
		(@LowerDateLimit IS NULL OR ND.CreationDate>= @LowerDateLimit) AND
		(@UpperDateLimit IS NULL OR ND.CreationDate <= @UpperDateLimit) AND
		ND.Deleted = 0
	GROUP BY ND.NodeTypeID
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_GetExpertiseDomains]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_GetExpertiseDomains]
GO

CREATE PROCEDURE [dbo].[CN_GetExpertiseDomains]
	@ApplicationID	uniqueidentifier,
	@UserID			uniqueidentifier,
	@strNodeTypeIDs	varchar(max),
	@delimiter		char,
	@NodeID			uniqueidentifier,
	@AdditionalID	varchar(50),
	@SearchText		nvarchar(1000),
	@LowerDateLimit	datetime,
	@UpperDateLimit	datetime,
	@LowerBoundary	int,
	@Count			int
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @NodeTypeIDs GuidTableType
	
	INSERT INTO @NodeTypeIDs (Value)
	SELECT DISTINCT Ref.Value
	FROM [dbo].[GFN_StrToGuidTable](@strNodeTypeIDs, @delimiter) AS Ref
	
	DECLARE @NTCount int = (SELECT COUNT(*) FROM @NodeTypeIDs)
	
	IF @NodeID IS NOT NULL SET @NTCount = 0
	IF @NodeID IS NOT NULL OR @AdditionalID = N'' SET @AdditionalID = NULL
	IF @Count IS NULL OR @Count <= 0 SET @Count = 10
	
	SET @SearchText = [dbo].[GFN_VerifyString](@SearchText)
	IF @SearchText IS NULL OR @SearchText = N'' SET @SearchText = NULL
	
	DECLARE @SelectedIDs KeyLessGuidTableType
	
	IF @SearchText IS NULL BEGIN
		INSERT INTO @SelectedIDs (Value)
		SELECT Ref.NodeID
		FROM (
				SELECT ROW_NUMBER() OVER (ORDER BY ND.CreationDate DESC, EX.NodeID DESC) AS RowNumber, ND.NodeID
				FROM [dbo].[CN_View_Experts] AS EX
					INNER JOIN [dbo].[CN_View_Nodes_Normal] AS ND
					ON ND.ApplicationID = @ApplicationID AND ND.NodeID = EX.NodeID
				WHERE EX.ApplicationID = @ApplicationID AND EX.UserID = @UserID AND 
					(@NodeID IS NULL OR ND.NodeID = @NodeID) AND
					(@NTCount = 0 OR ND.NodeTypeID IN (SELECT NTIDs.Value FROM @NodeTypeIDs AS NTIDs)) AND 
					(@AdditionalID IS NULL OR ND.NodeAdditionalID = @AdditionalID) AND
					(@LowerDateLimit IS NULL OR ND.CreationDate>= @LowerDateLimit) AND
					(@UpperDateLimit IS NULL OR ND.CreationDate <= @UpperDateLimit) AND
					ND.Deleted = 0
			) AS Ref
		ORDER BY Ref.RowNumber ASC
	END
	ELSE BEGIN
		INSERT INTO @SelectedIDs (Value)
		SELECT Ref.NodeID
		FROM (
				SELECT ROW_NUMBER() OVER (ORDER BY SRCH.[Rank] DESC, SRCH.[Key] DESC) AS RowNumber, ND.NodeID
				FROM CONTAINSTABLE([dbo].[CN_Nodes], ([Name], [AdditionalID]), @SearchText) AS SRCH
					INNER JOIN [dbo].[CN_View_Experts] AS EX
					INNER JOIN [dbo].[CN_View_Nodes_Normal] AS ND
					ON ND.ApplicationID = @ApplicationID AND ND.NodeID = EX.NodeID
					ON ND.NodeID = SRCH.[Key]
				WHERE EX.ApplicationID = @ApplicationID AND EX.UserID = @UserID AND 
					(@NodeID IS NULL OR ND.NodeID = @NodeID) AND
					(@NTCount = 0 OR ND.NodeTypeID IN (SELECT NTIDs.Value FROM @NodeTypeIDs AS NTIDs)) AND 
					(@AdditionalID IS NULL OR ND.NodeAdditionalID = @AdditionalID) AND
					(@LowerDateLimit IS NULL OR ND.CreationDate>= @LowerDateLimit) AND
					(@UpperDateLimit IS NULL OR ND.CreationDate <= @UpperDateLimit) AND
					ND.Deleted = 0
			) AS Ref
		ORDER BY Ref.RowNumber ASC
	END
	
	DECLARE @NodeIDs KeyLessGuidTableType

	INSERT INTO @NodeIDs (Value)
	SELECT TOP(@Count) S.Value 
	FROM @SelectedIDs AS S
	WHERE S.SequenceNumber >= ISNULL(@LowerBoundary, 0)
	
	EXEC [dbo].[CN_P_GetNodesByIDs] @ApplicationID, @NodeIDs, 0, NULL
	
	SELECT TOP(1) COUNT(S.Value) AS TotalCount FROM @SelectedIDs AS S
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_P_GetUsersExpertiseDomains]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_P_GetUsersExpertiseDomains]
GO

CREATE PROCEDURE [dbo].[CN_P_GetUsersExpertiseDomains]
	@ApplicationID	uniqueidentifier,
    @UserIDsTemp	GuidTableType ReadOnly,
    @NodeTypeID		uniqueidentifier,
    @Approved		bit,
    @SocialApproved bit,
    @All			bit
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @UserIDs GuidTableType
	INSERT INTO @UserIDs SELECT * FROM @UserIDsTemp
	
	SELECT EX.[NodeID] AS NodeID,
		   VN.[NodeAdditionalID] AS NodeAdditionalID,
		   VN.[NodeName] AS NodeName,
		   VN.[NodeTypeID] AS NodeTypeID,
		   VN.[TypeName] AS NodeType,
		   EX.[UserID] AS ExpertUserID,
		   UN.[UserName] AS ExpertUserName,
		   UN.[FirstName] AS ExpertFirstName,
		   UN.[LastName] AS ExpertLastName,
		   EX.[Approved] AS Approved,
		   EX.[SocialApproved] AS SocialApproved,
		   EX.ReferralsCount AS ReferralsCount,
		   EX.ConfirmsPercentage AS ConfirmsPercentage
	FROM @UserIDs AS ExternalIDs
		INNER JOIN [dbo].[CN_Experts] AS EX
		ON EX.ApplicationID = @ApplicationID AND EX.[UserID] = ExternalIDs.Value
		INNER JOIN [dbo].[CN_View_Nodes_Normal] AS VN
		ON VN.ApplicationID = @ApplicationID AND VN.[NodeID] = EX.[NodeID]
		INNER JOIN [dbo].[Users_Normal] AS UN
		ON UN.ApplicationID = @ApplicationID AND UN.[UserID] = EX.[UserID]
	WHERE (@NodeTypeID IS NULL OR VN.NodeTypeID = @NodeTypeID) AND 
		(
			(@All = 1 AND EX.SocialApproved IS NOT NULL) OR 
			(@Approved = 1 AND EX.Approved = 1) OR
			(@SocialApproved = 1 AND EX.SocialApproved = 1)
		) AND
		VN.Deleted = 0 AND UN.IsApproved = 1
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_P_GetUsersExpertiseDomainIDs]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_P_GetUsersExpertiseDomainIDs]
GO

CREATE PROCEDURE [dbo].[CN_P_GetUsersExpertiseDomainIDs]
	@ApplicationID	uniqueidentifier,
    @UserIDsTemp	GuidTableType ReadOnly,
    @Approved		bit,
    @SocialApproved bit
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @UserIDs GuidTableType
	INSERT INTO @UserIDs SELECT * FROM @UserIDsTemp
	
	SELECT EX.[NodeID] AS ID
	FROM @UserIDs AS ExternalIDs
		INNER JOIN [dbo].[CN_Experts] AS EX
		ON EX.[UserID] = ExternalIDs.Value
		INNER JOIN [dbo].[CN_View_Nodes_Normal] AS ND
		ON ND.ApplicationID = @ApplicationID AND ND.[NodeID] = EX.[NodeID]
	WHERE EX.ApplicationID = @ApplicationID AND ((@Approved = 1 AND EX.Approved = 1) OR 
		(@SocialApproved = 1 AND EX.SocialApproved = 1)) AND
		ND.[Deleted] = 0
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_GetExperts]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_GetExperts]
GO

CREATE PROCEDURE [dbo].[CN_GetExperts]
	@ApplicationID	uniqueidentifier,
    @strNodeIDs		varchar(max),
	@delimiter		char,
	@SearchText		nvarchar(255),
	@Hierarchy		bit,
    @Count			int,
    @LowerBoundary	bigint
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @NodeIDs GuidTableType
	
	INSERT INTO @NodeIDs
	SELECT DISTINCT Ref.Value
	FROM [dbo].[GFN_StrToGuidTable](@strNodeIDs, @delimiter) AS Ref
	
	IF @Hierarchy = 1 BEGIN
		INSERT INTO @NodeIDs (Value)
		SELECT DISTINCT T.NodeID
		FROM [dbo].[CN_FN_GetNodesHierarchy](@ApplicationID, @NodeIDs) AS T
			LEFT JOIN @NodeIDs AS IDs
			ON IDs.Value = T.NodeID
		WHERE IDs.Value IS NULL
	END
	
	IF ISNULL(@Count, 0) <= 0 SET @Count = 1000000
	
	IF ISNULL(@SearchText, N'') = N'' BEGIN
		SELECT TOP(@Count)
			Ref.RowNumber AS [Order],
			(Ref.RowNumber + Ref.RevRowNumber - 1) AS TotalCount,
			Ref.NodeID,
			Ref.UserID AS ExpertUserID,
			ND.[NodeAdditionalID] AS NodeAdditionalID,
			ND.[NodeName] AS NodeName,
			ND.[NodeTypeID] AS NodeTypeID,
			ND.[TypeName] AS NodeType,
			UN.[UserName] AS ExpertUserName,
			UN.[FirstName] AS ExpertFirstName,
			UN.[LastName] AS ExpertLastName
		FROM (
				SELECT	ROW_NUMBER() OVER (ORDER BY Ex.NodeID DESC, Ex.UserID DESC) AS RowNumber,
						ROW_NUMBER() OVER (ORDER BY Ex.NodeID ASC, Ex.UserID ASC) AS RevRowNumber,
						Ex.NodeID,
						Ex.UserID
				FROM @NodeIDs AS N
					INNER JOIN [dbo].[CN_View_Experts] AS Ex
					ON Ex.ApplicationID = @ApplicationID AND Ex.NodeID = N.Value
			) AS Ref
			INNER JOIN [dbo].[Users_Normal] AS UN
			ON UN.ApplicationID = @ApplicationID AND UN.UserID = Ref.UserID
			INNER JOIN [dbo].[CN_View_Nodes_Normal] AS ND
			ON ND.ApplicationID = @ApplicationID AND ND.NodeID = Ref.NodeID
		WHERE Ref.RowNumber >= ISNULL(@LowerBoundary, 0)
		ORDER BY Ref.RowNumber ASC
	END
	ELSE BEGIN
		SELECT TOP(@Count)
			Ref.RowNumber AS [Order],
			(Ref.RowNumber + Ref.RevRowNumber - 1) AS TotalCount,
			Ref.NodeID,
			Ref.UserID AS ExpertUserID,
			ND.[NodeAdditionalID] AS NodeAdditionalID,
			ND.[NodeName] AS NodeName,
			ND.[NodeTypeID] AS NodeTypeID,
			ND.[TypeName] AS NodeType,
			UN.[UserName] AS ExpertUserName,
			UN.[FirstName] AS ExpertFirstName,
			UN.[LastName] AS ExpertLastName
		FROM (
				SELECT	ROW_NUMBER() OVER (ORDER BY SRCH.[Rank] DESC, Ex.NodeID DESC, Ex.UserID DESC) AS RowNumber,
						ROW_NUMBER() OVER (ORDER BY SRCH.[Rank] ASC, Ex.NodeID ASC, Ex.UserID ASC) AS RevRowNumber,
						Ex.NodeID,
						Ex.UserID
				FROM @NodeIDs AS N
					INNER JOIN [dbo].[CN_View_Experts] AS Ex
					ON Ex.ApplicationID = @ApplicationID AND Ex.NodeID = N.Value
					INNER JOIN CONTAINSTABLE([dbo].[USR_View_Users], ([UserName], [FirstName], [LastName]), @SearchText) AS SRCH
					ON SRCH.[Key] = Ex.UserID
			) AS Ref
			INNER JOIN [dbo].[Users_Normal] AS UN
			ON UN.ApplicationID = @ApplicationID AND UN.UserID = Ref.UserID
			INNER JOIN [dbo].[CN_View_Nodes_Normal] AS ND
			ON ND.ApplicationID = @ApplicationID AND ND.NodeID = Ref.NodeID
		WHERE Ref.RowNumber >= ISNULL(@LowerBoundary, 0)
		ORDER BY Ref.RowNumber ASC
	END
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_GetUsersExpertiseDomains]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_GetUsersExpertiseDomains]
GO

CREATE PROCEDURE [dbo].[CN_GetUsersExpertiseDomains]
	@ApplicationID	uniqueidentifier,
    @strUserIDs		varchar(max),
    @delimiter		char,
    @NodeTypeID		uniqueidentifier,
    @Approved		bit,
    @SocialApproved bit,
    @All			bit
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @UserIDs GuidTableType
	
	INSERT INTO @UserIDs
	SELECT DISTINCT Ref.Value FROM GFN_StrToGuidTable(@strUserIDs, @delimiter) AS Ref
	
	EXEC [dbo].[CN_P_GetUsersExpertiseDomains] @ApplicationID, 
		@UserIDs, @NodeTypeID, @Approved, @SocialApproved, @All
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_GetUsersExpertiseDomainIDs]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_GetUsersExpertiseDomainIDs]
GO

CREATE PROCEDURE [dbo].[CN_GetUsersExpertiseDomainIDs]
	@ApplicationID	uniqueidentifier,
    @strUserIDs		varchar(max),
    @delimiter		char,
    @Approved		bit,
    @SocialApproved bit
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @UserIDs GuidTableType
	
	INSERT INTO @UserIDs
	SELECT DISTINCT Ref.Value FROM GFN_StrToGuidTable(@strUserIDs, @delimiter) AS Ref
	
	EXEC [dbo].[CN_P_GetUsersExpertiseDomainIDs] @ApplicationID, 
		@UserIDs, @Approved, @SocialApproved
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_IsExpert]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_IsExpert]
GO

CREATE PROCEDURE [dbo].[CN_IsExpert]
	@ApplicationID	uniqueidentifier,
    @UserID			uniqueidentifier,
    @NodeID			uniqueidentifier,
    @Approved		bit,
    @SocialApproved bit
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT 1 
	WHERE EXISTS(
			SELECT * 
			FROM [dbo].[CN_Experts] AS EX
			WHERE EX.ApplicationID = @ApplicationID AND 
				((@Approved = 1 AND EX.Approved = 1) OR 
				(@SocialApproved = 1 AND EX.SocialApproved = 1)) AND
				EX.UserID = @UserID AND EX.NodeID = @NodeID
		)
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_GetExpertsCount]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_GetExpertsCount]
GO

CREATE PROCEDURE [dbo].[CN_GetExpertsCount]
	@ApplicationID	uniqueidentifier,
	@NodeID			uniqueidentifier,
	@DistinctUsers	bit,
	@Approved		bit,
	@SocialApproved bit
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	IF @DistinctUsers = 1 BEGIN
		SELECT COUNT(*) FROM
		(SELECT COUNT(*) AS CNT 
		FROM [dbo].[CN_Experts] AS EX
			INNER JOIN [dbo].[Users_Normal] AS UN
			ON UN.ApplicationID = @ApplicationID AND UN.[UserID] = EX.[UserID]
			INNER JOIN [dbo].[CN_View_Nodes_Normal] AS ND
			ON ND.ApplicationID = @ApplicationID AND ND.[NodeID] = EX.[NodeID]
		WHERE EX.ApplicationID = @ApplicationID AND 
			(@NodeID IS NULL OR EX.[NodeID] = @NodeID) AND
			((@Approved = 1 AND EX.Approved = 1) OR 
			(@SocialApproved = 1 AND EX.SocialApproved = 1)) AND
			UN.IsApproved = 1 AND ND.[Deleted] = 0
		GROUP BY UN.[UserID]) AS Ref
	END
	ELSE BEGIN
		SELECT COUNT(*) 
		FROM [dbo].[CN_Experts] AS EX
			INNER JOIN [dbo].[Users_Normal] AS UN
			ON UN.ApplicationID = @ApplicationID AND UN.[UserID] = EX.[UserID]
			INNER JOIN [dbo].[CN_View_Nodes_Normal] AS ND
			ON ND.ApplicationID = @ApplicationID AND ND.[NodeID] = EX.[NodeID]
		WHERE EX.ApplicationID = @ApplicationID AND 
			(@NodeID IS NULL OR EX.[NodeID] = @NodeID) AND
			((@Approved = 1 AND EX.Approved = 1) OR 
			(@SocialApproved = 1 AND EX.SocialApproved = 1)) AND
			UN.IsApproved = 1 AND ND.Deleted = 0
	END
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_P_CalculateSocialExpertise]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_P_CalculateSocialExpertise]
GO

CREATE PROCEDURE [dbo].[CN_P_CalculateSocialExpertise]
	@ApplicationID							uniqueidentifier,
	@NodeID									uniqueidentifier,
	@UserID									uniqueidentifier,
	@DefaultMinAcceptableReferralsCount		int,
	@DefaultMinAcceptableConfirmsPercentage int,
	@_Result								int output
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @ReferralsCount int, @ConfirmsPercentage float, @SocialApproved bit = 0
	
	SELECT @ReferralsCount = COUNT(*)
	FROM [dbo].[CN_ExpertiseReferrals]
	WHERE ApplicationID = @ApplicationID AND NodeID = @NodeID AND 
		UserID = @UserID AND [Status] IS NOT NULL
	
	SELECT @ConfirmsPercentage = (
		CASE
			WHEN @ReferralsCount = 0 THEN 0 
			ELSE (CAST(COUNT(*) AS float) / CAST(@ReferralsCount AS float)) * 100 
		END
	)
	
	FROM [dbo].[CN_ExpertiseReferrals]
	WHERE ApplicationID = @ApplicationID AND 
		NodeID = @NodeID AND UserID = @UserID AND [Status] = 1
	
	IF @ReferralsCount >= @DefaultMinAcceptableReferralsCount AND
		@ConfirmsPercentage >= @DefaultMinAcceptableConfirmsPercentage
		SET @SocialApproved = 1
		
	UPDATE [dbo].[CN_Experts]
		SET ReferralsCount = @ReferralsCount,
			ConfirmsPercentage = @ConfirmsPercentage,
			SocialApproved = @SocialApproved
	WHERE ApplicationID = @ApplicationID AND NodeID = @NodeID AND UserID = @UserID
	
	SET @_Result = @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_VoteExpertise]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_VoteExpertise]
GO

CREATE PROCEDURE [dbo].[CN_VoteExpertise]
	@ApplicationID							uniqueidentifier,
	@ReferrerUserID							uniqueidentifier,
	@NodeID									uniqueidentifier,
	@UserID									uniqueidentifier,
	@Status									bit,
	@SendDate								datetime,
	@DefaultMinAcceptableReferralsCount		int,
	@DefaultMinAcceptableConfirmsPercentage int
WITH ENCRYPTION
AS
BEGIN TRANSACTION
	SET NOCOUNT ON
		
	IF EXISTS(
		SELECT TOP(1) * 
		FROM [dbo].[CN_ExpertiseReferrals]
		WHERE ApplicationID = @ApplicationID AND 
			ReferrerUserID = @ReferrerUserID AND NodeID = @NodeID AND UserID = @UserID
	) BEGIN
		UPDATE [dbo].[CN_ExpertiseReferrals]
			SET [Status] = @Status,
				SendDate = @SendDate
		WHERE ApplicationID = @ApplicationID AND 
			ReferrerUserID = @ReferrerUserID AND NodeID = @NodeID AND UserID = @UserID
	END
	ELSE BEGIN
		INSERT INTO [dbo].[CN_ExpertiseReferrals](
			ApplicationID,
			ReferrerUserID,
			NodeID,
			UserID,
			[Status],
			SendDate
		)
		VALUES(
			@ApplicationID,
			@ReferrerUserID,
			@NodeID,
			@UserID,
			@Status,
			@SendDate
		)
	END
	
	IF @@ROWCOUNT <= 0 BEGIN
		SELECT -1
		ROLLBACK TRANSACTION
		RETURN
	END
	
	DECLARE @_Result int
	
	EXEC [dbo].[CN_P_CalculateSocialExpertise] @ApplicationID, @NodeID, @UserID, 
		@DefaultMinAcceptableReferralsCount, @DefaultMinAcceptableConfirmsPercentage, 
		@_Result output
		
	IF @_Result <= 0 BEGIN
		SELECT -1
		ROLLBACK TRANSACTION
		RETURN
	END	
	
	SELECT 1
COMMIT TRANSACTION

GO

/*
IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_IAmExpert]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_IAmExpert]
GO

CREATE PROCEDURE [dbo].[CN_IAmExpert]
	@ApplicationID							uniqueidentifier,
	@UserID									uniqueidentifier,
	@ExpertiseDomain						nvarchar(255),
	@Now									datetime,
	@DefaultMinAcceptableReferralsCount		int,
	@DefaultMinAcceptableConfirmsPercentage int
WITH ENCRYPTION
AS
BEGIN TRANSACTION
	SET NOCOUNT ON
	
	SET @ExpertiseDomain = [dbo].[GFN_VerifyString](@ExpertiseDomain)
	
	DECLARE @NodeTypeID uniqueidentifier = [dbo].[CN_FN_GetExpertiseNodeTypeID](@ApplicationID)
	
	DECLARE @NodeID uniqueidentifier = (
		SELECT TOP(1) NodeID 
		FROM [dbo].[CN_Nodes] 
		WHERE ApplicationID = @ApplicationID AND 
			NodeTypeID = @NodeTypeID AND Name = @ExpertiseDomain
	)
	
	DECLARE @_Result int, @_ErrorMessage varchar(1000)
	
	IF @NodeID IS NULL BEGIN
		SET @NodeID = NEWID()
		
		EXEC [dbo].[CN_P_AddNode] @ApplicationID, @NodeID, NULL, @NodeTypeID, 
			NULL, NULL, NULL, @ExpertiseDomain, NULL, NULL, 0, @UserID, @Now, NULL, 
			NULL, NULL, @_Result output, @_ErrorMessage output
			
		IF @_Result <= 0 BEGIN
			SELECT -1
			ROLLBACK TRANSACTION
			RETURN
		END
	END
	
	IF EXISTS(SELECT TOP(1) * FROM [dbo].[CN_Experts]
		WHERE NodeID = @NodeID AND UserID = @UserID) BEGIN
	
		EXEC [dbo].[CN_P_CalculateSocialExpertise] @ApplicationID, @NodeID, @UserID, 
			@DefaultMinAcceptableReferralsCount, @DefaultMinAcceptableConfirmsPercentage, 
			@_Result output
	END
	ELSE BEGIN
		INSERT INTO [dbo].[CN_Experts](
			ApplicationID,
			NodeID,
			UserID,
			Approved,
			ReferralsCount,
			ConfirmsPercentage,
			SocialApproved,
			UniqueID
		)
		VALUES(
			@ApplicationID,
			@NodeID,
			@UserID,
			0,
			0,
			0,
			0,
			NEWID()
		)
		
		SET @_Result = @@ROWCOUNT
	END
	
	IF @_Result <= 0 SELECT NULL
	ELSE SELECT @NodeID
COMMIT TRANSACTION

GO
*/


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_IAmNotExpert]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_IAmNotExpert]
GO

CREATE PROCEDURE [dbo].[CN_IAmNotExpert]
	@ApplicationID	uniqueidentifier,
	@UserID			uniqueidentifier,
	@NodeID			uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[CN_Experts]
		SET SocialApproved = NULL
	WHERE ApplicationID = @ApplicationID AND NodeID = @NodeID AND UserID = @UserID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_GetReferralsCount]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_GetReferralsCount]
GO

CREATE PROCEDURE [dbo].[CN_GetReferralsCount]
	@ApplicationID	uniqueidentifier,
	@UserID			uniqueidentifier,
	@NodeID			uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT TOP(1) ReferralsCount
	FROM [dbo].[CN_Experts]
	WHERE ApplicationID = @ApplicationID AND NodeID = @NodeID AND UserID = @UserID
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_GetExpertiseSuggestions]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_GetExpertiseSuggestions]
GO

CREATE PROCEDURE [dbo].[CN_GetExpertiseSuggestions]
	@ApplicationID	uniqueidentifier,
	@UserID			uniqueidentifier,
	@Count			int,
	@LowerBoundary	int
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	IF @Count IS NULL SET @Count = 10
	/*
	SELECT TOP(@Count)
		ND.NodeID AS NodeID,
		ND.NodeName AS NodeName,
		ND.TypeName AS NodeType,
		Ref.UserID AS ExpertUserID,
		UN.UserName AS ExpertUserName,
		UN.FirstName AS ExpertFirstName,
		UN.LastName AS ExpertLastName
	FROM
		(
			SELECT ROW_NUMBER() OVER(ORDER BY ER.ReferralsCount) AS ID,
				   ReferrerUserID, UserID, NodeID
			FROM [dbo].[CN_View_ExpertiseReferrals] AS ER
			WHERE ER.ApplicationID = @ApplicationID AND ReferrerUserID = @UserID
		) AS Ref
		INNER JOIN [dbo].[CN_View_Nodes_Normal] AS ND
		ON ND.ApplicationID = @ApplicationID AND ND.NodeID = Ref.NodeID
		INNER JOIN [dbo].[Users_Normal] AS UN
		ON UN.ApplicationID = @ApplicationID AND UN.UserID = Ref.UserID
	WHERE @LowerBoundary IS NULL OR Ref.ID > @LowerBoundary
	*/
END

GO

/*     end of Expert related procedures     */


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_SuggestNodeRelations]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_SuggestNodeRelations]
GO

CREATE PROCEDURE [dbo].[CN_SuggestNodeRelations]
	@ApplicationID		uniqueidentifier,
	@UserID				uniqueidentifier,
	@NodeTypeID			uniqueidentifier,
	@RelatedNodeTypeID	uniqueidentifier,
	@Count				int,
	@Now				datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @NodeIDs KeyLessGuidTableType
	
	INSERT INTO @NodeIDs (Value)
	SELECT TOP(@Count) Ref.NodeID
	FROM (
			SELECT ISNULL(EX.NodeID, R.NodeID) AS NodeID,
				((CASE
					WHEN EX.NodeID IS NOT NULL AND R.NodeID IS NOT NULL THEN 2
					ELSE 1
				END) * (
					(CASE 
						WHEN (EX.[Rank] IS NULL OR EX.[Rank] = 0) THEN 1 
						ELSE EX.[Rank] 
					END) + 
					ISNULL(R.[Rank], 0))) AS [Rank]
			FROM (
					SELECT EX.NodeID,
						((ISNULL(EX.ConfirmsPercentage, 0) / CAST(100 AS float)) * 
						 ISNULL(EX.ReferralsCount, 0)) AS [Rank]
					FROM [dbo].[CN_Experts] AS EX
						INNER JOIN [dbo].[CN_View_Nodes_Normal] AS ND
						ON ND.ApplicationID = @ApplicationID AND ND.NodeID = EX.NodeID
						LEFT JOIN [dbo].[CN_NodeCreators] AS NC
						ON NC.ApplicationID = @ApplicationID AND 
							NC.NodeID = EX.NodeID AND NC.UserID = @UserID AND NC.Deleted = 0
					WHERE EX.ApplicationID = @ApplicationID AND EX.UserID = @UserID AND 
						(EX.Approved = 1 OR EX.SocialApproved = 1) AND
						(@RelatedNodeTypeID IS NULL OR ND.NodeTypeID = @RelatedNodeTypeID) AND
						NC.NodeID IS NULL AND ND.Deleted = 0 AND ND.TypeDeleted = 0
				) AS EX
				FULL OUTER JOIN (
					SELECT RN.NodeID, 
						(AVG(
							CASE
								WHEN DATEDIFF(DAY, KW.CreationDate, @Now) < 365
									THEN 365 - DATEDIFF(DAY, KW.CreationDate, @Now)
								ELSE 0
							END
						) / CAST(365 AS float)) * COUNT(RN.NodeID) AS [Rank]
					FROM [dbo].[KW_View_Knowledges] AS KW
						INNER JOIN [dbo].[CN_View_OutRelatedNodes] AS RN
						ON RN.ApplicationID = @ApplicationID AND RN.NodeID = KW.KnowledgeID
						INNER JOIN [dbo].[CN_View_Nodes_Normal] AS ND
						ON ND.ApplicationID = @ApplicationID AND ND.NodeID = RN.NodeID
					WHERE KW.ApplicationID = @ApplicationID AND 
						KW.CreatorUserID = @UserID AND KW.Deleted = 0 AND 
						(@RelatedNodeTypeID IS NULL OR ND.NodeTypeID = @RelatedNodeTypeID) AND
						ND.Deleted = 0 AND ND.TypeDeleted = 0
					GROUP BY RN.NodeID
				) AS R
				ON EX.NodeID = R.NodeID
		) AS Ref
	WHERE Ref.[Rank] > 0
	ORDER BY Ref.[Rank] DESC
	
	IF (SELECT COUNT(*) FROM @NodeIDs) = 0 BEGIN
		INSERT INTO @NodeIDs (Value)
		SELECT TOP(@Count) NodeID
		FROM [dbo].[CN_Nodes]
		WHERE ApplicationID = @ApplicationID AND 
			(@RelatedNodeTypeID IS NULL OR NodeTypeID = @RelatedNodeTypeID) AND Deleted = 0
	END
	
	EXEC [dbo].[CN_P_GetNodesByIDs] @ApplicationID, @NodeIDs, NULL, NULL
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_SuggestNodeTypesForRelations]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_SuggestNodeTypesForRelations]
GO

CREATE PROCEDURE [dbo].[CN_SuggestNodeTypesForRelations]
	@ApplicationID	uniqueidentifier,
	@UserID			uniqueidentifier,
	@NodeTypeID		uniqueidentifier,
	@Count			int,
	@Now			datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON

	DECLARE @NodeTypeIDs KeyLessGuidTableType
	
	INSERT INTO @NodeTypeIDs (Value)
	SELECT TOP(@Count) Ref.ID
	FROM (
			SELECT ND.NodeTypeID AS ID, SUM(Ref.[Rank]) AS [Rank]
			FROM (
					SELECT ISNULL(EX.NodeID, R.NodeID) AS NodeID,
						((CASE
							WHEN EX.NodeID IS NOT NULL AND R.NodeID IS NOT NULL THEN 2
							ELSE 1
						END) * (
							(CASE 
								WHEN (EX.[Rank] IS NULL OR EX.[Rank] = 0) THEN 1 
								ELSE EX.[Rank] 
							END) + 
							ISNULL(R.[Rank], 0))) AS [Rank]
					FROM (
							SELECT EX.NodeID,
								((ISNULL(EX.ConfirmsPercentage, 0) / CAST(100 AS float)) * 
								 ISNULL(EX.ReferralsCount, 0)) AS [Rank]
							FROM [dbo].[CN_Experts] AS EX
								LEFT JOIN [dbo].[CN_NodeCreators] AS NC
								ON NC.ApplicationID = @ApplicationID AND
									NC.NodeID = EX.NodeID AND NC.UserID = @UserID AND 
									NC.Deleted = 0
							WHERE EX.ApplicationID = @ApplicationID AND EX.UserID = @UserID AND 
								(EX.Approved = 1 OR EX.SocialApproved = 1) AND
								NC.NodeID IS NULL
						) AS EX
						FULL OUTER JOIN (
							SELECT RN.NodeID, 
								(AVG(
									CASE
										WHEN DATEDIFF(DAY, KW.CreationDate, @Now) < 365
											THEN 365 - DATEDIFF(DAY, KW.CreationDate, @Now)
										ELSE 0
									END
								) / CAST(365 AS float)) * COUNT(RN.NodeID) AS [Rank]
							FROM [dbo].[KW_View_Knowledges] AS KW
								INNER JOIN [dbo].[CN_View_OutRelatedNodes] AS RN
								ON RN.ApplicationID = @ApplicationID AND 
									RN.NodeID = KW.KnowledgeID
							WHERE KW.ApplicationID = @ApplicationID AND 
								KW.CreatorUserID = @UserID AND KW.Deleted = 0
							GROUP BY RN.NodeID
						) AS R
						ON EX.NodeID = R.NodeID
				) AS Ref
				INNER JOIN [dbo].[CN_View_Nodes_Normal] AS ND
				ON ND.ApplicationID = @ApplicationID AND ND.NodeID = Ref.NodeID
			WHERE Ref.[Rank] > 0 AND ND.Deleted = 0 AND ND.TypeDeleted = 0
			GROUP BY ND.NodeTypeID
		) AS Ref
	ORDER BY Ref.[Rank] DESC
	
	IF (SELECT COUNT(*) FROM @NodeTypeIDs) = 0 BEGIN
		INSERT INTO @NodeTypeIDs (Value)
		SELECT TOP(10) NT.NodeTypeID
		FROM [dbo].[CN_NodeTypes] AS NT
			LEFT JOIN [dbo].[CN_Extensions] AS X
			ON X.ApplicationID = @ApplicationID AND X.Extension = N'Browser'
		WHERE NT.ApplicationID = @ApplicationID
		ORDER BY (CASE WHEN X.OwnerID IS NULL THEN 0 ELSE 1 END) DESC
	END
	
	EXEC [dbo].[CN_P_GetNodeTypesByIDs] @ApplicationID, @NodeTypeIDs
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_SuggestSimilarNodes]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_SuggestSimilarNodes]
GO

CREATE PROCEDURE [dbo].[CN_SuggestSimilarNodes]
	@ApplicationID	uniqueidentifier,
	@NodeID			uniqueidentifier,
	@Count			int
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT TOP(ISNULL(@Count, 20)) Ref.*
	FROM (
			SELECT	IDs.NodeID, 
					CAST(((8 * SUM(IDs.Tags)) + (5 * SUM(IDs.Relations)) + 
						(4 * SUM(IDs.Experts)) + (1 * SUM(IDs.Favorites))) AS float) AS [Rank],
					CAST((CASE WHEN SUM(IDs.Tags) > 0 THEN 1 ELSE 0 END) AS bit) AS Tags,
					CAST((CASE WHEN SUM(IDs.Favorites) > 0 THEN 1 ELSE 0 END) AS bit) AS Favorites,
					CAST((CASE WHEN SUM(IDs.Relations) > 0 THEN 1 ELSE 0 END) AS bit) AS Relations,
					CAST((CASE WHEN SUM(IDs.Experts) > 0 THEN 1 ELSE 0 END) AS bit) AS Experts
			FROM (
					-- tagged together
					SELECT	Dst.TaggedID AS NodeID, 
							COUNT(Dst.ContextID) AS Tags,
							CAST(0 AS int) AS Favorites,
							CAST(0 AS int) AS Relations,
							CAST(0 AS int) AS Experts
					FROM [dbo].[RV_TaggedItems] AS Ref
						INNER JOIN [dbo].[RV_TaggedItems] AS Dst
						ON Dst.ApplicationID = @ApplicationID AND Dst.ContextID = Ref.ContextID
					WHERE Ref.ApplicationID = @ApplicationID AND 
						Ref.TaggedID = @NodeID AND Dst.TaggedType = N'Node'
					GROUP BY Dst.TaggedID
					-- end of tagged together

					UNION ALL

					-- favorites
					SELECT	Dst.NodeID, 
							0 AS Tags,
							COUNT(Dst.UserID) AS Favorites,
							0 AS Relations,
							0 AS Experts
					FROM [dbo].[CN_NodeLikes] AS Ref
						INNER JOIN [dbo].[CN_NodeLikes] AS Dst
						ON Dst.ApplicationID = @ApplicationID AND Dst.UserID = Ref.UserID
					WHERE Ref.ApplicationID = @ApplicationID AND 
						Ref.NodeID = @NodeID AND Ref.Deleted = 0 AND Dst.Deleted = 0
					GROUP BY Dst.NodeID
					-- end of favorites

					UNION ALL

					-- related nodes
					SELECT	Dst.RelatedNodeID AS NodeID, 
							0 AS Tags,
							0 AS Favorites,
							COUNT(Dst.NodeID) AS Relations,
							0 AS Experts
					FROM [dbo].[CN_View_OutRelatedNodes] AS Ref
						INNER JOIN [dbo].[CN_View_OutRelatedNodes] AS Dst
						ON Dst.ApplicationID = @ApplicationID AND Dst.NodeID = Ref.NodeID
					WHERE Ref.ApplicationID = @ApplicationID AND Ref.RelatedNodeID = @NodeID
					GROUP BY Dst.RelatedNodeID
					-- end of related nodes

					UNION ALL

					-- experts
					SELECT	Dst.NodeID,
							0 AS Tags,
							0 AS Favorites,
							0 AS Relations,
							COUNT(Dst.UserID) AS Experts
					FROM [dbo].[CN_View_Experts] AS Ref
						INNER JOIN [dbo].[CN_View_Experts] AS Dst
						ON Dst.ApplicationID = @ApplicationID AND Dst.UserID = Ref.UserID
					WHERE Ref.ApplicationID = @ApplicationID AND Ref.NodeID = @NodeID
					GROUP BY Dst.NodeID
					-- end of experts
				) AS IDs
			GROUP BY IDs.NodeID
		) AS Ref
		INNER JOIN [dbo].[CN_Nodes] AS ND
		ON ND.ApplicationID = @ApplicationID AND 
			ND.NodeID = Ref.NodeID AND ND.Deleted = 0
	WHERE Ref.NodeID <> @NodeID
	ORDER BY Ref.[Rank] DESC
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_SuggestKnowledgableUsers]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_SuggestKnowledgableUsers]
GO

CREATE PROCEDURE [dbo].[CN_SuggestKnowledgableUsers]
	@ApplicationID	uniqueidentifier,
	@NodeID			uniqueidentifier,
	@Count			int
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT TOP(ISNULL(@Count, 20)) Ref.*
	FROM (
			SELECT	IDs.UserID, 
					CAST(((8 * SUM(IDs.Expert)) + (8 * SUM(IDs.Contributor)) + 
						(4 * SUM(IDs.WikiEditor)) + (4 * SUM(IDs.Member)) + 
						(2 * SUM(IDs.ExpertOfRelatedNode)) + 
						(2 * SUM(IDs.ContributorOfRelatedNode)) + 
						(1 * SUM(IDs.MemberOfRelatedNode))) AS float) AS [Rank],
					CAST((CASE WHEN SUM(IDs.Expert) > 0 THEN 1 ELSE 0 END) AS bit) AS Expert,
					CAST((CASE WHEN SUM(IDs.Contributor) > 0 THEN 1 ELSE 0 END) AS bit) AS Contributor,
					CAST((CASE WHEN SUM(IDs.WikiEditor) > 0 THEN 1 ELSE 0 END) AS bit) AS WikiEditor,
					CAST((CASE WHEN SUM(IDs.Member) > 0 THEN 1 ELSE 0 END) AS bit) AS Member,
					CAST((CASE WHEN SUM(IDs.ExpertOfRelatedNode) > 0 THEN 1 ELSE 0 END) AS bit) AS ExpertOfRelatedNode,
					CAST((CASE WHEN SUM(IDs.ContributorOfRelatedNode) > 0 THEN 1 ELSE 0 END) AS bit) AS ContributorOfRelatedNode,
					CAST((CASE WHEN SUM(IDs.MemberOfRelatedNode) > 0 THEN 1 ELSE 0 END) AS bit) AS MemberOfRelatedNode
			FROM (
					-- experts
					SELECT	Dst.UserID, 
							CAST(1 AS int) AS Expert,
							CAST(0 AS int) AS Contributor,
							CAST(0 AS int) AS WikiEditor,
							CAST(0 AS int) AS Member,
							CAST(0 AS int) AS ExpertOfRelatedNode,
							CAST(0 AS int) AS ContributorOfRelatedNode,
							CAST(0 AS int) AS MemberOfRelatedNode
					FROM [dbo].[CN_View_Experts] AS Dst
					WHERE Dst.ApplicationID = @ApplicationID AND Dst.NodeID = @NodeID
					-- end of experts

					UNION ALL

					-- contributors
					SELECT	Dst.UserID, 
							0 AS Expert,
							1 AS Contributor,
							0 AS WikiEditor,
							0 AS Member,
							0 AS ExpertOfRelatedNode,
							0 AS ContributorOfRelatedNode,
							0 AS MemberOfRelatedNode
					FROM [dbo].[CN_NodeCreators] AS Dst
					WHERE Dst.ApplicationID = @ApplicationID AND 
						Dst.NodeID = @NodeID AND Dst.Deleted = 0
					-- end of contributors

					UNION ALL

					-- wiki editors
					SELECT	C.UserID, 
							0 AS Expert,
							0 AS Contributor,
							COUNT(DISTINCT P.ParagraphID) AS WikiEditor,
							0 AS Member,
							0 AS ExpertOfRelatedNode,
							0 AS ContributorOfRelatedNode,
							0 AS MemberOfRelatedNode
					FROM [dbo].[WK_Titles] AS T
						INNER JOIN [dbo].[WK_Paragraphs] AS P
						ON P.ApplicationID = @ApplicationID AND P.TitleID = T.TitleID
						INNER JOIN [dbo].[WK_Changes] AS C
						ON C.ApplicationID = @ApplicationID AND 
							C.ParagraphID = P.ParagraphID AND C.Applied = 1
					WHERE T.ApplicationID = @ApplicationID AND T.OwnerID = @NodeID
					GROUP BY C.UserID
					-- end of wiki editors
					
					UNION ALL
					
					-- experts
					SELECT	Dst.UserID, 
							0 AS Expert,
							0 AS Contributor,
							0 AS WikiEditor,
							1 AS Member,
							0 AS ExpertOfRelatedNode,
							0 AS ContributorOfRelatedNode,
							0 AS MemberOfRelatedNode
					FROM [dbo].[CN_View_NodeMembers] AS Dst
					WHERE Dst.ApplicationID = @ApplicationID AND 
						Dst.NodeID = @NodeID AND Dst.IsPending = 0
					-- end of experts

					UNION ALL

					-- experts of related nodes
					SELECT	Dst.UserID, 
							0 AS Expert,
							0 AS Contributor,
							0 AS WikiEditor,
							0 AS Member,
							COUNT(Dst.NodeID) AS ExpertOfRelatedNode,
							0 AS ContributorOfRelatedNode,
							0 AS MemberOfRelatedNode
					FROM [dbo].[CN_View_OutRelatedNodes] AS Ref
						INNER JOIN [dbo].[CN_View_Experts] AS Dst
						ON Dst.ApplicationID = @ApplicationID AND Dst.NodeID = Ref.RelatedNodeID
					WHERE Ref.ApplicationID = @ApplicationID AND Ref.NodeID = @NodeID
					GROUP BY Dst.UserID
					-- end of experts of related nodes

					UNION ALL

					-- contributors of related nodes
					SELECT	Dst.UserID, 
							0 AS Expert,
							0 AS Contributor,
							0 AS WikiEditor,
							0 AS Member,
							0 AS ExpertOfRelatedNode,
							COUNT(Dst.NodeID) AS ContributorOfRelatedNode,
							0 AS MemberOfRelatedNode
					FROM [dbo].[CN_View_OutRelatedNodes] AS Ref
						INNER JOIN [dbo].[CN_NodeCreators] AS Dst
						ON Dst.ApplicationID = @ApplicationID AND Dst.NodeID = Ref.RelatedNodeID
					WHERE Ref.ApplicationID = @ApplicationID AND Ref.NodeID = @NodeID
					GROUP BY Dst.UserID
					-- end of contributors of related nodes

					UNION ALL

					-- members of related nodes
					SELECT	Dst.UserID, 
							0 AS Expert,
							0 AS Contributor,
							0 AS WikiEditor,
							0 AS Member,
							0 AS ExpertOfRelatedNode,
							0 AS ContributorOfRelatedNode,
							COUNT(Dst.NodeID) AS MemberOfRelatedNode
					FROM [dbo].[CN_View_OutRelatedNodes] AS Ref
						INNER JOIN [dbo].[CN_View_NodeMembers] AS Dst
						ON Dst.ApplicationID = @ApplicationID AND Dst.NodeID = Ref.RelatedNodeID
					WHERE Ref.ApplicationID = @ApplicationID AND 
						Ref.NodeID = @NodeID AND Dst.IsPending = 0
					GROUP BY Dst.UserID
					-- end of members of related nodes
				) AS IDs
			GROUP BY IDs.UserID
		) AS Ref
		INNER JOIN [dbo].[Users_Normal] AS UN
		ON UN.ApplicationID = @ApplicationID AND 
			UN.UserID = Ref.UserID AND UN.IsApproved = 1
	ORDER BY Ref.[Rank] DESC
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_GetExistingNodeIDs]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_GetExistingNodeIDs]
GO

CREATE PROCEDURE [dbo].[CN_GetExistingNodeIDs]
	@ApplicationID	uniqueidentifier,
	@strNodeIDs		varchar(max),
	@delimiter		char,
	@Searchable		bit,
	@NoContent		bit
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT NodeID AS ID
	FROM [dbo].[GFN_StrToGuidTable](@strNodeIDs, @delimiter) AS IDs
		INNER JOIN [dbo].[CN_Nodes] AS ND
		ON ND.NodeID = IDs.Value
		LEFT JOIN [dbo].[CN_Services] AS S
		ON S.ApplicationID = @ApplicationID AND S.NodeTypeID = ND.NodeTypeID AND S.Deleted = 0
	WHERE ND.ApplicationID = @ApplicationID AND ND.Deleted = 0 AND 
		(@Searchable IS NULL OR ISNULL(ND.Searchable, 1) = @Searchable) AND
		(@NoContent IS NULL OR ISNULL(S.NoContent, 0) = @NoContent)
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_GetExistingNodeTypeIDs]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_GetExistingNodeTypeIDs]
GO

CREATE PROCEDURE [dbo].[CN_GetExistingNodeTypeIDs]
	@ApplicationID	uniqueidentifier,
	@strNodeTypeIDs	varchar(max),
	@delimiter		char,
	@NoContent		bit
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT NT.NodeTypeID AS ID
	FROM [dbo].[GFN_StrToGuidTable](@strNodeTypeIDs, @delimiter) AS IDs
		INNER JOIN [dbo].[CN_NodeTypes] AS NT
		ON NT.NodeTypeID = IDs.Value
		LEFT JOIN [dbo].[CN_Services] AS S
		ON S.ApplicationID = @ApplicationID AND S.NodeTypeID = NT.NodeTypeID AND S.Deleted = 0
	WHERE NT.ApplicationID = @ApplicationID AND NT.Deleted = 0 AND
		(@NoContent IS NULL OR ISNULL(S.NoContent, 0) = @NoContent)
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_GetNodeInfo]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_GetNodeInfo]
GO

CREATE PROCEDURE [dbo].[CN_GetNodeInfo]
	@ApplicationID		uniqueidentifier,
	@strNodeIDs			varchar(max),
    @delimiter			char,
    @CurrentUserID		uniqueidentifier,
    @Tags				bit,
    @Description		bit,
    @Creator			bit,
    @ContributorsCount	bit,
    @LikesCount			bit,
    @VisitsCount		bit,
    @ExpertsCount		bit,
    @MembersCount		bit,
    @ChildsCount		bit,
    @RelatedNodesCount	bit,
    @LikeStatus			bit
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @NodeIDs GuidTableType
	
	INSERT INTO @NodeIDs
	SELECT Ref.Value
	FROM [dbo].[GFN_StrToGuidTable](@strNodeIDs, @delimiter) AS Ref
	
	SELECT	N.Value AS NodeID,
			ND.NodeTypeID,
			(CASE WHEN @Tags = 1 THEN ND.Tags ELSE NULL END) AS Tags,
			(CASE WHEN @Description = 1 THEN ND.[Description] ELSE NULL END) AS [Description],
			UN.UserID AS CreatorUserID,
			UN.UserName AS CreatorUserName,
			UN.FirstName AS CreatorFirstName,
			UN.LastName AS CreatorLastName,
			NC.ContributorsCount,
			NL.LikesCount,
			IV.VisitsCount,
			EX.ExpertsCount,
			NM.MembersCount,
			CH.ChildsCount,
			RL.RelatedNodesCount,
			CAST((CASE WHEN NLikes.NodeID IS NULL THEN 0 ELSE 1 END) AS bit) AS LikeStatus
	FROM @NodeIDs AS N
		INNER JOIN [dbo].[CN_Nodes] AS ND
		ON ND.ApplicationID = @ApplicationID AND ND.NodeID = N.Value
		LEFT JOIN [dbo].[Users_Normal] AS UN
		ON UN.ApplicationID = @ApplicationID AND @Creator = 1 AND UN.UserID = ND.CreatorUserID
		LEFT JOIN (
			SELECT NC.NodeID, COUNT(NC.UserID) AS ContributorsCount
			FROM @NodeIDs AS Ref
				INNER JOIN [dbo].[CN_NodeCreators] AS NC
				ON NC.NodeID = Ref.Value
			WHERE NC.ApplicationID = @ApplicationID AND NC.Deleted = 0
			GROUP BY NC.NodeID
		) AS NC
		ON @ContributorsCount = 1 AND NC.NodeID = N.Value
		LEFT JOIN (
			SELECT NL.NodeID, COUNT(NL.UserID) AS LikesCount
			FROM @NodeIDs AS Ref
				INNER JOIN [dbo].[CN_NodeLikes] AS NL
				ON NL.NodeID = Ref.Value
			WHERE NL.ApplicationID = @ApplicationID AND NL.Deleted = 0
			GROUP BY NL.NodeID
		) AS NL
		ON @LikesCount = 1 AND NL.NodeID = N.Value
		LEFT JOIN (
			SELECT IV.ItemID, COUNT(IV.UserID) AS VisitsCount
			FROM @NodeIDs AS Ref
				INNER JOIN [dbo].[USR_ItemVisits] AS IV
				ON IV.ApplicationID = @ApplicationID AND IV.ItemID = Ref.Value
			GROUP BY IV.ItemID
		) AS IV
		ON @VisitsCount = 1 AND IV.ItemID = N.Value
		LEFT JOIN (
			SELECT EX.NodeID, COUNT(EX.UserID) AS ExpertsCount
			FROM @NodeIDs AS Ref
				INNER JOIN [dbo].[CN_View_Experts] AS EX
				ON EX.ApplicationID = @ApplicationID AND EX.NodeID = Ref.Value
			GROUP BY EX.NodeID
		) AS EX
		ON @ExpertsCount = 1 AND EX.NodeID = N.Value
		LEFT JOIN (
			SELECT NM.NodeID, COUNT(NM.UserID) AS MembersCount
			FROM @NodeIDs AS Ref
				INNER JOIN [dbo].[CN_View_NodeMembers] AS NM
				ON NM.ApplicationID = @ApplicationID AND NM.NodeID = Ref.Value AND
					NM.IsPending = 0
			GROUP BY NM.NodeID
		) AS NM
		ON @MembersCount = 1 AND NM.NodeID = N.Value
		LEFT JOIN (
			SELECT CH.ParentNodeID AS NodeID, COUNT(CH.NodeID) AS ChildsCount
			FROM @NodeIDs AS Ref
				INNER JOIN [dbo].[CN_Nodes] AS CH
				ON CH.ParentNodeID = Ref.Value
			WHERE CH.ApplicationID = @ApplicationID AND CH.Deleted = 0
			GROUP BY CH.ParentNodeID
		) AS CH
		ON @ChildsCount = 1 AND CH.NodeID = N.Value
		LEFT JOIN (
			SELECT RL.NodeID, COUNT(DISTINCT RL.RelatedNodeID) AS RelatedNodesCount
			FROM (
					SELECT InR.NodeID, InR.RelatedNodeID, InR.PropertyID
					FROM @NodeIDs AS Ref
						INNER JOIN [dbo].[CN_View_InRelatedNodes] AS InR
						ON InR.ApplicationID = @ApplicationID AND InR.NodeID = Ref.Value
					
					UNION
					
					SELECT OuR.NodeID, Our.RelatedNodeID, OuR.PropertyID
					FROM @NodeIDs AS Ref
						INNER JOIN [dbo].[CN_View_OutRelatedNodes] AS OuR
						ON OuR.ApplicationID = @ApplicationID AND OuR.NodeID = Ref.Value
				) AS RL
			GROUP BY RL.NodeID
		) AS RL
		ON @RelatedNodesCount = 1 AND RL.NodeID = N.Value
		LEFT JOIN [dbo].[CN_NodeLikes] AS NLikes
		ON NLikes.ApplicationID = @ApplicationID AND 
			@CurrentUserID IS NOT NULL AND @LikeStatus = 1 AND 
			NLikes.NodeID = N.Value AND NLikes.UserID = @CurrentUserID AND NLikes.Deleted = 0
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_InitializeExtensions]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_InitializeExtensions]
GO

CREATE PROCEDURE [dbo].[CN_InitializeExtensions]
	@ApplicationID			uniqueidentifier,
	@OwnerID				uniqueidentifier,
	@strEnabledExtensions	varchar(max),
	@strDisabledExtensions	varchar(max),
	@delimiter				char,
	@CreatorUserID			uniqueidentifier,
	@CreationDate			datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @SequenceNumber int = ISNULL(
			(
				SELECT MAX(SequenceNumber) 
				FROM [dbo].[CN_Extensions] 
				WHERE ApplicationID = @ApplicationID AND OwnerID = @OwnerID
			), 0
		)
	
	DECLARE @Extensions Table (ID int IDENTITY(1, 1) primary key clustered, 
		[Disabled] bit, Ext varchar(50))
	
	INSERT INTO @Extensions (Ext, [Disabled])
	SELECT Ref.Value, [Disabled]
	FROM (
			SELECT Ref.Value, CAST(0 AS bit) AS [Disabled]
			FROM [dbo].[GFN_StrToStringTable](@strEnabledExtensions, @delimiter) AS Ref
			
			UNION ALL
			
			SELECT Ref.Value, CAST(1 AS bit)
			FROM [dbo].[GFN_StrToStringTable](@strDisabledExtensions, @delimiter) AS Ref
		) AS Ref
	WHERE Ref.Value NOT IN (
			SELECT Ex.Extension
			FROM [dbo].[CN_Extensions] AS Ex
			WHERE Ex.ApplicationID = @ApplicationID AND Ex.OwnerID = @OwnerID
		)
	
	IF (SELECT COUNT(*) FROM @Extensions) > 0 BEGIN
		INSERT INTO [dbo].[CN_Extensions](
			ApplicationID,
			OwnerID,
			Extension,
			SequenceNumber,
			CreatorUserID,
			CreationDate,
			Deleted
		)
		SELECT @ApplicationID,
			   @OwnerID, 
			   Ex.Ext,
			   Ex.ID + @SequenceNumber,
			   @CreatorUserID,
			   @CreationDate,
			   Ex.[Disabled]
		FROM @Extensions AS Ex
		
		SELECT @@ROWCOUNT
	END
	ELSE SELECT 1
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_EnableDisableExtension]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_EnableDisableExtension]
GO

CREATE PROCEDURE [dbo].[CN_EnableDisableExtension]
	@ApplicationID	uniqueidentifier,
	@OwnerID		uniqueidentifier,
	@Extension		varchar(50),
	@Disable		bit,
	@CreatorUserID	uniqueidentifier,
	@CreationDate	datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[CN_Extensions]
		SET Deleted = ISNULL(@Disable, 0),
			LastModifierUserID = @CreatorUserID,
			LastModificationDate = @CreationDate
	WHERE ApplicationID = @ApplicationID AND OwnerID = @OwnerID AND Extension = @Extension
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_SetExtensionTitle]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_SetExtensionTitle]
GO

CREATE PROCEDURE [dbo].[CN_SetExtensionTitle]
	@ApplicationID			uniqueidentifier,
	@OwnerID				uniqueidentifier,
	@Extension				varchar(50),
	@Title					nvarchar(100),
	@LastModifierUserID		uniqueidentifier,
	@LastModificationDate	datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[CN_Extensions]
		SET Title = [dbo].[GFN_VerifyString](@Title),
			LastModifierUserID = @LastModifierUserID,
			LastModificationDate = @LastModificationDate
	WHERE ApplicationID = @ApplicationID AND OwnerID = @OwnerID AND Extension = @Extension
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_MoveExtension]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_MoveExtension]
GO

CREATE PROCEDURE [dbo].[CN_MoveExtension]
	@ApplicationID	uniqueidentifier,
	@OwnerID		uniqueidentifier,
	@Extension		varchar(50),
	@MoveDown		bit
WITH ENCRYPTION
AS
BEGIN TRANSACTION
	SET NOCOUNT ON
	
	DECLARE @SequenceNo int
	
	SELECT @SequenceNo = SequenceNumber
	FROM [dbo].[CN_Extensions]
	WHERE ApplicationID = @ApplicationID AND OwnerID = @OwnerID AND Extension = @Extension
		
	DECLARE @OtherExtension varchar(50)
	DECLARE @OtherSequenceNumber int
	
	IF @MoveDown = 1 BEGIN
		SELECT TOP(1) @OtherExtension = Extension, @OtherSequenceNumber = SequenceNumber
		FROM [dbo].[CN_Extensions]
		WHERE ApplicationID = @ApplicationID AND 
			OwnerID = @OwnerID AND SequenceNumber > @SequenceNo
		ORDER BY SequenceNumber
	END
	ELSE BEGIN
		SELECT TOP(1) @OtherExtension = Extension, @OtherSequenceNumber = SequenceNumber
		FROM [dbo].[CN_Extensions]
		WHERE ApplicationID = @ApplicationID AND 
			OwnerID = @OwnerID AND SequenceNumber < @SequenceNo
		ORDER BY SequenceNumber DESC
	END
	
	IF @OtherExtension IS NULL BEGIN
		SELECT -1
		ROLLBACK TRANSACTION
		RETURN
	END
	
	UPDATE [dbo].[CN_Extensions]
		SET SequenceNumber = @OtherSequenceNumber
	WHERE ApplicationID = @ApplicationID AND OwnerID = @OwnerID AND Extension = @Extension
	
	IF @@ROWCOUNT <= 0 BEGIN
		SELECT -1
		ROLLBACK TRANSACTION
		RETURN
	END
	
	UPDATE [dbo].[CN_Extensions]
		SET SequenceNumber = @SequenceNo
	WHERE ApplicationID = @ApplicationID AND 
		OwnerID = @OwnerID AND Extension = @OtherExtension
	
	IF @@ROWCOUNT <= 0 BEGIN
		SELECT -1
		ROLLBACK TRANSACTION
		RETURN
	END
	
	SELECT 1
COMMIT TRANSACTION

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_SaveExtensions]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_SaveExtensions]
GO

CREATE PROCEDURE [dbo].[CN_SaveExtensions]
	@ApplicationID	uniqueidentifier,
	@OwnerID		uniqueidentifier,
	@ExtensionsTemp	CNExtensionTableType readonly,
	@CurrentUserID	uniqueidentifier,
	@Now			datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @Extensions CNExtensionTableType
	INSERT INTO @Extensions SELECT * FROM @ExtensionsTemp
	
	
	DECLARE @TBL TABLE (Extension varchar(50), Title nvarchar(100), SequenceNumber int IDENTITY(1, 1), Deleted bit)
	
	INSERT INTO @TBL (Extension, Title, Deleted)
	SELECT X.Extension, X.Title, ISNULL(X.[Disabled], 0)
	FROM @Extensions AS X
	
	
	UPDATE X
	SET Title = T.Title,
		Deleted = CASE WHEN T.Extension IS NULL THEN 1 ELSE T.Deleted END,
		LastModifierUserID = @CurrentUserID,
		LastModificationDate = @Now
	FROM [dbo].[CN_Extensions] AS X
		LEFT JOIN @TBL AS T
		ON T.Extension = X.Extension
	WHERE X.ApplicationID = @ApplicationID AND X.OwnerID = @OwnerID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_GetExtensions]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_GetExtensions]
GO

CREATE PROCEDURE [dbo].[CN_GetExtensions]
	@ApplicationID	uniqueidentifier,
	@OwnerID		uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @NodeTypeID uniqueidentifier = (
		SELECT TOP(1) NodeTypeID
		FROM [dbo].[CN_Nodes]
		WHERE ApplicationID = @ApplicationID AND NodeID = @OwnerID
	)
	
	IF @NodeTypeID IS NOT NULL SET @OwnerID = @NodeTypeID
	
	SELECT OwnerID,
		   Extension,
		   Title,
		   Deleted AS [Disabled]
	FROM [dbo].[CN_Extensions]
	WHERE ApplicationID = @ApplicationID AND OwnerID = @OwnerID
	ORDER BY SequenceNumber
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_HasExtension]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_HasExtension]
GO

CREATE PROCEDURE [dbo].[CN_HasExtension]
	@ApplicationID	uniqueidentifier,
	@OwnerID		uniqueidentifier,
	@Extension		varchar(50)
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @NodeTypeID uniqueidentifier = (
		SELECT TOP(1) NodeTypeID
		FROM [dbo].[CN_Nodes]
		WHERE ApplicationID = @ApplicationID AND NodeID = @OwnerID
	)
	
	IF @NodeTypeID IS NOT NULL SET @OwnerID = @NodeTypeID
	
	SELECT CAST(1 AS bit)
	FROM [dbo].[CN_Extensions]
	WHERE ApplicationID = @ApplicationID AND 
		OwnerID = @OwnerID AND Extension = @Extension AND Deleted = 0
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_GetNodeTypesWithExtension]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_GetNodeTypesWithExtension]
GO

CREATE PROCEDURE [dbo].[CN_GetNodeTypesWithExtension]
	@ApplicationID	uniqueidentifier,
	@strExtensions	varchar(max),
	@delimiter		char
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @Extensions StringTableType
	
	INSERT INTO @Extensions (Value)
	SELECT Ref.Value
	FROM [dbo].[GFN_StrToStringTable](@strExtensions, @delimiter) AS Ref
	
	DECLARE @NodeTypeIDs KeyLessGuidTableType
	
	INSERT INTO @NodeTypeIDs (Value)
	SELECT DISTINCT NT.NodeTypeID
	FROM @Extensions AS E
		INNER JOIN [dbo].[CN_Extensions] AS X
		ON X.ApplicationID = @ApplicationID AND X.Extension = E.Value AND X.Deleted = 0
		INNER JOIN [dbo].[CN_NodeTypes] AS NT
		ON NT.ApplicationID = @ApplicationID AND NT.NodeTypeID = X.OwnerID AND NT.Deleted = 0
		
	EXEC [dbo].[CN_P_GetNodeTypesByIDs] @ApplicationID, @NodeTypeIDs
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_GetIntellectualPropertiesCount]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_GetIntellectualPropertiesCount]
GO

CREATE PROCEDURE [dbo].[CN_GetIntellectualPropertiesCount]
	@ApplicationID	uniqueidentifier,
	@UserID			uniqueidentifier,
	@NodeTypeID		uniqueidentifier,
	@NodeID			uniqueidentifier,
	@AdditionalID	varchar(50),
	@CurrentUserID	uniqueidentifier,
	@IsDocument		bit,
	@LowerDateLimit	datetime,
	@UpperDateLimit	datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	IF @NodeID IS NOT NULL SET @NodeTypeID = NULL
	IF @NodeID IS NOT NULL OR @AdditionalID = N'' SET @AdditionalID = NULL
	
	DECLARE @IsSystemAdmin bit = (SELECT [dbo].[GFN_IsSystemAdmin](@ApplicationID, @CurrentUserID))
	
	DECLARE @ServiceAdminIDs GuidTableType
	
	INSERT INTO @ServiceAdminIDs (Value)
	SELECT DISTINCT A.NodeTypeID
	FROM [dbo].[CN_ServiceAdmins] AS A
	WHERE A.ApplicationID = @ApplicationID AND A.UserID = @CurrentUserID AND A.Deleted = 0
	
	
	SELECT	X.NodeTypeID,
			MAX(X.NodeTypeAdditionalID) AS NodeTypeAdditionalID,
			MAX(X.TypeName) AS TypeName,
			COUNT(X.NodeID) AS NodesCount
	FROM (
			SELECT	ND.NodeID,
					CAST(MAX(CAST(ND.NodeTypeID AS varchar(50))) AS uniqueidentifier) AS NodeTypeID,
					MAX(ND.TypeAdditionalID) AS NodeTypeAdditionalID,
					MAX(ND.TypeName) AS TypeName,
					CAST(MAX(CAST(ND.Searchable AS int)) AS bit) AS Searchable,
					CAST(MAX(CAST(ND.HideCreators AS int)) AS bit) AS HideCreators,
					CAST(MAX(
						CASE 
							WHEN @CurrentUserID IS NOT NULL AND NC.UserID = @CurrentUserID THEN 1 
							ELSE 0 
						END
					) AS bit) AS CurUser,
					CAST(MAX(CASE WHEN NC.UserID = @UserID THEN 1 ELSE 0 END) AS bit) AS TheUser
			FROM [dbo].[CN_NodeCreators] AS NC
				INNER JOIN [dbo].[CN_View_Nodes_Normal] AS ND
				ON ND.ApplicationID = @ApplicationID AND ND.NodeID = NC.NodeID
				LEFT JOIN [dbo].[CN_Services] AS S
				ON S.ApplicationID = @ApplicationID AND S.NodeTypeID = ND.NodeTypeID AND S.Deleted = 0
			WHERE NC.ApplicationID = @ApplicationID AND 
				(NC.UserID = @UserID OR (
					@CurrentUserID IS NOT NULL AND NC.UserID = @CurrentUserID
				)) AND 
				(@NodeID IS NULL OR ND.NodeID = @NodeID) AND
				(@NodeTypeID IS NULL OR ND.NodeTypeID = @NodeTypeID) AND 
				(@AdditionalID IS NULL OR ND.NodeAdditionalID = @AdditionalID) AND
				(@IsDocument IS NULL OR ISNULL(S.IsDocument, 0) = @IsDocument) AND
				(@LowerDateLimit IS NULL OR ND.CreationDate>= @LowerDateLimit) AND
				(@UpperDateLimit IS NULL OR ND.CreationDate <= @UpperDateLimit) AND
				NC.Deleted = 0 AND ND.Deleted = 0
			GROUP BY ND.NodeID
		) AS X
		LEFT JOIN @ServiceAdminIDs AS S
		ON S.Value = X.NodeTypeID
		LEFT JOIN [dbo].[CN_Services] AS SSS
		ON SSS.ApplicationID = @ApplicationID AND X.NodeTypeID = SSS.NodeTypeID AND SSS.Deleted = 0
	WHERE ISNULL(SSS.NoContent, 0) = 0 AND X.TheUser = 1 AND (@IsSystemAdmin = 1 OR S.Value IS NOT NULL OR 
		(X.Searchable = 1 AND X.HideCreators = 0) OR X.CurUser = 1)
	GROUP BY X.NodeTypeID
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_GetIntellectualProperties]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_GetIntellectualProperties]
GO

CREATE PROCEDURE [dbo].[CN_GetIntellectualProperties]
	@ApplicationID	uniqueidentifier,
	@UserID			uniqueidentifier,
	@strNodeTypeIDs	varchar(max),
	@delimiter		char,
	@NodeID			uniqueidentifier,
	@AdditionalID	varchar(50),
	@CurrentUserID	uniqueidentifier,
	@SearchText		nvarchar(1000),
	@IsDocument		bit,
	@LowerDateLimit	datetime,
	@UpperDateLimit	datetime,
	@LowerBoundary	int,
	@Count			int
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @NodeTypeIDs GuidTableType
	
	INSERT INTO @NodeTypeIDs (Value)
	SELECT DISTINCT Ref.Value
	FROM [dbo].[GFN_StrToGuidTable](@strNodeTypeIDs, @delimiter) AS Ref
	
	DECLARE @NTCount int = (SELECT COUNT(*) FROM @NodeTypeIDs)
	
	IF @NodeID IS NOT NULL SET @NTCount = 0
	IF @NodeID IS NOT NULL OR @AdditionalID = N'' SET @AdditionalID = NULL
	IF @Count IS NULL OR @Count <= 0 SET @Count = 10
	
	SET @SearchText = [dbo].[GFN_VerifyString](@SearchText)
	IF @SearchText IS NULL OR @SearchText = N'' SET @SearchText = NULL
	
	DECLARE @TempIDs KeyLessGuidTableType
	DECLARE @NodeIDs KeyLessGuidTableType
	
	-- Admins
	DECLARE @IsSystemAdmin bit = (SELECT [dbo].[GFN_IsSystemAdmin](@ApplicationID, @CurrentUserID))
	
	DECLARE @ServiceAdminIDs GuidTableType
	
	INSERT INTO @ServiceAdminIDs (Value)
	SELECT DISTINCT A.NodeTypeID
	FROM [dbo].[CN_ServiceAdmins] AS A
	WHERE A.ApplicationID = @ApplicationID AND A.UserID = @CurrentUserID AND A.Deleted = 0
	-- end of Admins
	
	INSERT INTO @TempIDs(Value)
	SELECT X.NodeID
	FROM (
			SELECT	ND.NodeID,
					CAST(MAX(CAST(ND.NodeTypeID AS varchar(50))) AS uniqueidentifier) AS NodeTypeID,
					MAX(ND.CreationDate) AS CreationDate,
					CAST(MAX(CAST(ND.Searchable AS int)) AS bit) AS Searchable,
					CAST(MAX(CAST(ND.HideCreators AS int)) AS bit) AS HideCreators,
					CAST(MAX(
						CASE 
							WHEN @CurrentUserID IS NOT NULL AND NC.UserID = @CurrentUserID THEN 1 
							ELSE 0 
						END
					) AS bit) AS CurUser,
					CAST(MAX(CASE WHEN NC.UserID = @UserID THEN 1 ELSE 0 END) AS bit) AS TheUser
			FROM [dbo].[CN_NodeCreators] AS NC
				INNER JOIN [dbo].[CN_View_Nodes_Normal] AS ND
				ON ND.ApplicationID = @ApplicationID AND ND.NodeID = NC.NodeID
				LEFT JOIN [dbo].[CN_Services] AS S
				ON S.ApplicationID = @ApplicationID AND S.NodeTypeID = ND.NodeTypeID AND S.Deleted = 0
			WHERE NC.ApplicationID = @ApplicationID AND 
				(NC.UserID = @UserID OR (
					@CurrentUserID IS NOT NULL AND NC.UserID = @CurrentUserID
				)) AND 
				(@NodeID IS NULL OR ND.NodeID = @NodeID) AND
				(@NTCount = 0 OR ND.NodeTypeID IN (SELECT NTIDs.Value FROM @NodeTypeIDs AS NTIDs)) AND 
				(@AdditionalID IS NULL OR ND.NodeAdditionalID = @AdditionalID) AND
				(@IsDocument IS NULL OR ISNULL(S.IsDocument, 0) = @IsDocument) AND
				(@LowerDateLimit IS NULL OR ND.CreationDate>= @LowerDateLimit) AND
				(@UpperDateLimit IS NULL OR ND.CreationDate <= @UpperDateLimit) AND
				NC.Deleted = 0 AND ND.Deleted = 0
			GROUP BY ND.NodeID
		) AS X
		LEFT JOIN @ServiceAdminIDs AS S
		ON S.Value = X.NodeTypeID
		LEFT JOIN [dbo].[CN_Services] AS SSS
		ON SSS.ApplicationID = @ApplicationID AND X.NodeTypeID = SSS.NodeTypeID AND SSS.Deleted = 0
	WHERE ISNULL(SSS.NoContent, 0) = 0 AND X.TheUser = 1 AND (@IsSystemAdmin = 1 OR S.Value IS NOT NULL OR 
		(X.Searchable = 1 AND X.HideCreators = 0) OR X.CurUser = 1)
	ORDER BY X.CreationDate DESC, X.NodeID DESC
	
	DECLARE @TotalCount bigint = 0
	
	IF @SearchText IS NULL BEGIN
		SET @TotalCount = (SELECT COUNT(*) FROM @TempIDs)
	
		INSERT INTO @NodeIDs (Value)
		SELECT TOP(@Count) Ref.Value
		FROM @TempIDs AS Ref
		WHERE Ref.SequenceNumber >= ISNULL(@LowerBoundary, 0)
		ORDER BY Ref.SequenceNumber ASC
	END
	ELSE BEGIN
		DECLARE @SelectedIDs KeyLessGuidTableType
	
		INSERT INTO @SelectedIDs (Value)
		SELECT Ref.Value
		FROM (
				SELECT ROW_NUMBER() OVER (ORDER BY SRCH.[Rank] DESC, SRCH.[Key] DESC) AS RowNumber, T.Value
				FROM CONTAINSTABLE([dbo].[CN_Nodes], ([Name], [AdditionalID]), @SearchText) AS SRCH
					INNER JOIN @TempIDs AS T
					ON T.Value = SRCH.[Key]
			) AS Ref
		ORDER BY Ref.RowNumber ASC
		
		SET @TotalCount = (SELECT COUNT(*) FROM @SelectedIDs)
		
		INSERT INTO @NodeIDs (Value)
		SELECT TOP(@Count) S.Value 
		FROM @SelectedIDs AS S
		WHERE S.SequenceNumber >= ISNULL(@LowerBoundary, 0)
	END
	
	EXEC [dbo].[CN_P_GetNodesByIDs] @ApplicationID, @NodeIds, NULL, NULL
	
	SELECT @TotalCount AS TotalCount
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_GetIntellectualPropertiesOfFriends]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_GetIntellectualPropertiesOfFriends]
GO

CREATE PROCEDURE [dbo].[CN_GetIntellectualPropertiesOfFriends]
	@ApplicationID	uniqueidentifier,
	@UserID			uniqueidentifier,
	@NodeTypeID		uniqueidentifier,
	@LowerBoundary	int,
	@Count			int
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	IF @Count IS NULL OR @Count <= 0 SET @Count = 10
	
	DECLARE @NodeIDs KeyLessGuidTableType
	
	INSERT INTO @NodeIDs (Value)
	SELECT TOP(@Count) Ref.NodeID
	FROM (
			SELECT	ROW_NUMBER() OVER (ORDER BY ND.CreationDate DESC) AS RowNumber,
					ND.NodeID
			FROM (
					SELECT DISTINCT NC.NodeID
					FROM [dbo].[USR_View_Friends] AS F
						INNER JOIN [dbo].[CN_NodeCreators] AS NC
						ON NC.ApplicationID = @ApplicationID AND NC.UserID = F.FriendID
					WHERE F.ApplicationID = @ApplicationID AND 
						F.UserID = @UserID AND F.AreFriends = 1 AND NC.Deleted = 0
				) AS NID
				INNER JOIN [dbo].[CN_Nodes] AS ND
				ON ND.ApplicationID = @ApplicationID AND ND.NodeID = NID.NodeID
				LEFT JOIN [dbo].[CN_Services] AS S
				ON S.ApplicationID = @ApplicationID AND S.NodeTypeID = ND.NodeTypeID AND S.Deleted = 0
			WHERE (@NodeTypeID IS NULL OR ND.NodeTypeID = @NodeTypeID) AND ND.Deleted = 0 AND
				ND.Searchable = 1 AND ISNULL(ND.HideCreators, 0) = 0 AND ISNULL(S.NoContent, 0) = 0
		) AS Ref
	WHERE Ref.RowNumber >= ISNULL(@LowerBoundary, 0)
	ORDER BY Ref.RowNumber ASC
	
	EXEC [dbo].[CN_P_GetNodesByIDs] @ApplicationID, @NodeIds, NULL, NULL
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_GetDocumentTreeNodeItems]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_GetDocumentTreeNodeItems]
GO

CREATE PROCEDURE [dbo].[CN_GetDocumentTreeNodeItems]
	@ApplicationID	uniqueidentifier,
	@TreeNodeID		uniqueidentifier,
	@CurrentUserID	uniqueidentifier,
	@CheckPrivacy	bit,
	@Now			datetime,
	@DefaultPrivacy varchar(20),
	@Count			int,
	@LowerBoundary	int
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @TempIDs KeyLessGuidTableType
	
	INSERT INTO @TempIDs (Value)
	SELECT DISTINCT T.NodeID
	FROM [dbo].[CN_Nodes] ND
		RIGHT JOIN (
			SELECT ND.NodeID
			FROM [dbo].[CN_Nodes] AS ND
			WHERE ND.ApplicationID = @ApplicationID AND ND.DocumentTreeNodeID = @TreeNodeID AND	
				ND.[Deleted] = 0 AND ISNULL(ND.Searchable, 1) = 1 AND
				(ISNULL(ND.[Status], N'') = N'' OR ND.[Status] = N'Accepted')
		) AS T
		ON ND.ApplicationID = @ApplicationID AND T.NodeID = ND.PreviousVersionID AND 
			ND.[Deleted] = 0 AND ISNULL(ND.Searchable, 1) = 1 AND
			(ISNULL(ND.[Status], N'') = N'' OR ND.[Status] = N'Accepted')
	WHERE ND.NodeID IS NULL
	
	DECLARE @IDs KeyLessGuidTableType
	
	IF @CheckPrivacy = 1 BEGIN
		DECLARE	@PermissionTypes StringPairTableType
		
		INSERT INTO @PermissionTypes (FirstValue, SecondValue)
		VALUES (N'View', @DefaultPrivacy)
	
		INSERT INTO @IDs (Value)
		SELECT Ref.ID
		FROM [dbo].[PRVC_FN_CheckAccess](@ApplicationID, @CurrentUserID, 
			@tempIDs, N'Node', @Now, @PermissionTypes) AS Ref
	END
	ELSE BEGIN
		INSERT INTO @IDs (Value)
		SELECT Ref.Value AS ID
		FROM @TempIDs AS Ref
	END
	
	DELETE @TempIDs
	
	INSERT INTO @TempIDs (Value)
	SELECT TOP(ISNULL(@Count, 1000)) X.Value
	FROM (
			SELECT	ROW_NUMBER() OVER(ORDER BY ID.SequenceNumber ASC) AS RowNumber,
					ID.Value
			FROM @IDs AS ID
		) AS X
	WHERE X.RowNumber >= ISNULL(@LowerBoundary, 0)
	ORDER BY X.RowNumber ASC
	
	EXEC [dbo].[CN_P_GetNodesByIDs] @ApplicationID, @TempIDs, NULL, NULL
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_GetDocumentTreeNodeContents]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_GetDocumentTreeNodeContents]
GO

CREATE PROCEDURE [dbo].[CN_GetDocumentTreeNodeContents]
	@ApplicationID	uniqueidentifier,
	@TreeNodeID		uniqueidentifier,
	@CurrentUserID	uniqueidentifier,
	@CheckPrivacy	bit,
	@Now			datetime,
	@DefaultPrivacy varchar(20),
	@Count			int,
	@LowerBoundary	int,
	@SearchText		nvarchar(500)
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @TempIDs KeyLessGuidTableType
	
	DECLARE @TreeID uniqueidentifier = (
		SELECT TOP(1) TreeID
		FROM [dbo].[DCT_Trees]
		WHERE ApplicationID = @ApplicationID AND TreeID = @TreeNodeID
	)
	
	IF @TreeID IS NOT NULL SET @TreeNodeID = NULL
	
	IF ISNULL(@SearchText, N'') = N'' BEGIN
		INSERT INTO @TempIDs (Value)
		SELECT X.NodeID
		FROM (
				SELECT ND.NodeID, MAX(ISNULL(C.CreationDate, ND.CreationDate)) AS CreationDate
				FROM [dbo].[DCT_TreeNodes] AS T
					LEFT JOIN [dbo].[DCT_TreeNodeContents] AS C
					ON C.ApplicationID = @ApplicationID AND C.TreeNodeID = T.TreeNodeID AND C.Deleted = 0
					INNER JOIN [dbo].[CN_Nodes] AS ND
					ON ND.ApplicationID = @ApplicationID AND ND.Deleted = 0 AND 
						(
							(C.NodeID IS NOT NULL AND ND.NodeID = C.NodeID) OR 
							(ND.DocumentTreeNodeID IS NOT NULL AND ND.DocumentTreeNodeID = T.TreeNodeID)
						)
				WHERE T.ApplicationID = @ApplicationID AND
					(
						(@TreeID IS NOT NULL AND T.TreeID = @TreeID AND T.Deleted = 0) OR
						(@TreeNodeID IS NOT NULL AND T.TreeNodeID = @TreeNodeID)
					)
				GROUP BY ND.NodeID
			) AS X
		ORDER BY X.CreationDate DESC
	END
	ELSE BEGIN
		DECLARE @TNIDs GuidTableType
		
		IF @TreeID IS NULL AND @TreeNodeID IS NOT NULL BEGIN
			INSERT INTO @TNIDs (Value)
			VALUES (@TreeNodeID)
		
			INSERT INTO @TNIDs (Value)
			SELECT DISTINCT Ref.NodeID
			FROM [DCT_FN_GetChildNodesDeepHierarchy](@ApplicationID, @TNIDs) AS Ref
			WHERE Ref.NodeID <> @TreeNodeID
		END
	
	
		INSERT INTO @TempIDs (Value)
		SELECT X.NodeID
		FROM (
				SELECT A.NodeID, MAX(A.RowNumber) AS RowNumber
				FROM (
						SELECT	ROW_NUMBER() OVER (ORDER BY SRCH.[Rank] DESC, SRCH.[Key] ASC) AS RowNumber,
								SRCH.[Key] AS NodeID
						FROM CONTAINSTABLE([dbo].[CN_Nodes], (Name), @SearchText) AS SRCH
							INNER JOIN [dbo].[DCT_TreeNodes] AS T
							LEFT JOIN [dbo].[DCT_TreeNodeContents] AS C
							ON C.ApplicationID = @ApplicationID AND C.TreeNodeID = T.TreeNodeID AND C.Deleted = 0
							INNER JOIN [dbo].[CN_Nodes] AS ND
							ON ND.ApplicationID = @ApplicationID AND ND.Deleted = 0 AND 
								(
									(C.NodeID IS NOT NULL AND ND.NodeID = C.NodeID) OR 
									(ND.DocumentTreeNodeID IS NOT NULL AND ND.DocumentTreeNodeID = T.TreeNodeID)
								)
							ON ND.NodeID = SRCH.[Key]
						WHERE T.ApplicationID = @ApplicationID AND
							(
								(@TreeID IS NOT NULL AND T.TreeID = @TreeID AND T.Deleted = 0) OR
								(@TreeNodeID IS NOT NULL AND T.TreeNodeID IN (SELECT B.Value FROM @TNIDs AS B))
							)
					) AS A
				GROUP BY A.NodeID
			) AS X
		ORDER BY X.RowNumber ASC
	END
	
	DECLARE @IDs KeyLessGuidTableType
	
	IF @CheckPrivacy = 1 BEGIN
		DECLARE	@PermissionTypes StringPairTableType
		
		INSERT INTO @PermissionTypes (FirstValue, SecondValue)
		VALUES (N'View', @DefaultPrivacy)
	
		INSERT INTO @IDs (Value)
		SELECT Ref.ID
		FROM [dbo].[PRVC_FN_CheckAccess](@ApplicationID, @CurrentUserID, 
			@tempIDs, N'Node', @Now, @PermissionTypes) AS Ref
	END
	ELSE BEGIN
		INSERT INTO @IDs (Value)
		SELECT Ref.Value AS ID
		FROM @TempIDs AS Ref
	END
	
	DELETE @TempIDs
	
	INSERT INTO @TempIDs (Value)
	SELECT TOP(ISNULL(@Count, 1000)) X.Value
	FROM (
			SELECT	ROW_NUMBER() OVER(ORDER BY ID.SequenceNumber ASC) AS RowNumber,
					ID.Value
			FROM @IDs AS ID
		) AS X
	WHERE X.RowNumber >= ISNULL(@LowerBoundary, 0)
	ORDER BY X.RowNumber ASC
	
	EXEC [dbo].[CN_P_GetNodesByIDs] @ApplicationID, @TempIDs, NULL, NULL
	
	SELECT CAST(COUNT(ID.Value) AS bigint) AS TotalCount
	FROM @IDs AS ID
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_IsNodeType]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_IsNodeType]
GO

CREATE PROCEDURE [dbo].[CN_IsNodeType]
	@ApplicationID	uniqueidentifier,
	@strIDs			varchar(max),
	@delimiter		char
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT Ref.Value AS ID
	FROM [dbo].[GFN_StrToGuidTable](@strIDs, @delimiter) AS Ref
		INNER JOIN [dbo].[CN_NodeTypes] AS NT
		ON NT.ApplicationID = @ApplicationID AND NT.NodeTypeID = Ref.Value
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_IsNode]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_IsNode]
GO

CREATE PROCEDURE [dbo].[CN_IsNode]
	@ApplicationID	uniqueidentifier,
	@strIDs			varchar(max),
	@delimiter		char
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT Ref.Value AS ID
	FROM [dbo].[GFN_StrToGuidTable](@strIDs, @delimiter) AS Ref
		INNER JOIN [dbo].[CN_Nodes] AS NT
		ON NT.ApplicationID = @ApplicationID AND NT.NodeID = Ref.Value
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_Explore]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_Explore]
GO

CREATE PROCEDURE [dbo].[CN_Explore]
	@ApplicationID		uniqueidentifier,
	@BaseID				uniqueidentifier,
	@RelatedID			uniqueidentifier,
	@strBaseTypeIDs		varchar(max),
	@strRelatedTypeIDs	varchar(max),
	@delimiter			char,
	@SecondLevelNodeID	uniqueidentifier,
	@RegistrationArea	bit,
	@Tags				bit,
	@Relations			bit,
	@LowerBoundary		int,
	@Count				int,
	@OrderBy			varchar(100),
	@OrderByDesc		bit,
	@SearchText			nvarchar(1000),
	@CheckAccess		bit,
	@CurrentUserID		uniqueidentifier,
	@Now				datetime,
	@DefaultPrivacy		varchar(50)
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @BaseTypeIDs GuidTableType, @RelatedTypeIDs GuidTableType
	
	INSERT INTO @BaseTypeIDs
	SELECT *
	FROM [dbo].[GFN_StrToGuidTable](@strBaseTypeIDs, @delimiter)
	
	INSERT INTO @RelatedTypeIDs
	SELECT *
	FROM [dbo].[GFN_StrToGuidTable](@strRelatedTypeIDs, @delimiter)
	
	IF @OrderBy = 'Type' SET @OrderBy = 'RelatedType'	
	ELSE IF @OrderBy = N'Date' SET @OrderBy = 'RelatedCreationDate'	
	ELSE SET @OrderBy = 'RelatedName'
	
	DECLARE @SortOrder varchar(10) = 'ASC', @RevSortOrder varchar(10) = 'DESC'
	IF @OrderByDesc = 1 BEGIN 
		SET @SortOrder = 'DESC'
		SET @RevSortOrder = 'ASC'
	END
	
	DECLARE @BaseIDs GuidTableType
	
	IF @BaseID IS NOT NULL BEGIN
		INSERT INTO @BaseIDs (Value)
		VALUES (@BaseID)
		
		IF ISNULL(@SearchText, N'') <> N'' BEGIN
			INSERT INTO @BaseIDs (Value)
			SELECT DISTINCT H.NodeID
			FROM @BaseIDs AS B
				RIGHT JOIN [dbo].[CN_FN_GetChildNodesDeepHierarchy](@ApplicationID, @BaseIDs) AS H
				ON H.NodeID = B.Value
			WHERE B.Value IS NULL AND H.NodeID <> @BaseID
		END
	END
	
	CREATE TABLE #Items (BaseID uniqueidentifier,
		BaseTypeID uniqueidentifier, BaseName nvarchar(2000), BaseType nvarchar(2000), 
		RelatedID uniqueidentifier, RelatedTypeID uniqueidentifier, RelatedName nvarchar(2000),
		RelatedType nvarchar(2000), RelatedCreationDate datetime,
		IsTag bit, IsRelation bit, IsRegistrationArea bit,
		PRIMARY KEY (BaseID, RelatedID)
	)

	INSERT INTO #Items
	SELECT	Ref.BaseID,
			CAST(MAX(CAST(Ref.BaseTypeID AS varchar(100))) AS uniqueidentifier),
			MAX(Ref.BaseName),
			MAX(Ref.BaseType),
			Ref.RelatedID,
			CAST(MAX(CAST(Ref.RelatedTypeID AS varchar(100))) AS uniqueidentifier),
			MAX(Ref.RelatedName),
			MAX(Ref.RelatedType),
			MAX(Ref.RelatedCreationDate),
			CAST(MAX(CAST(Ref.IsTag AS int)) AS bit),
			CAST(MAX(CAST(Ref.IsRelation AS int)) AS bit),
			CAST(MAX(CAST(Ref.IsRegistrationArea AS int)) AS bit)
	FROM [dbo].[CN_FN_Explore](@ApplicationID, @BaseIDs, @BaseTypeIDs, 
		@RelatedID, @RelatedTypeIDs, @RegistrationArea, @Tags, @Relations) AS Ref
	GROUP By Ref.BaseID, Ref.RelatedID
	
	IF @SecondLevelNodeID IS NOT NULL BEGIN
		DECLARE @BIDs GuidTableType
		DECLARE @BTIDs GuidTableType
		
		INSERT INTO @BIDs (Value) VALUES (@SecondLevelNodeID)
	
		DELETE I
		FROM #Items AS I
			LEFT JOIN (
				SELECT R.NodeID, R.RelatedNodeID
				FROM [dbo].[CN_FN_GetRelatedNodeIDs](@ApplicationID, 
					@BIDs, @BTIDs, @RelatedTypeIDs, @Relations, @Relations, @Tags, @Tags) AS R
			) AS X
			ON X.RelatedNodeID = I.RelatedID
		WHERE X.RelatedNodeID IS NULL
	END
	
	
	IF ISNULL(@CheckAccess, 0) = 1 BEGIN
		DECLARE @TempIDs KeyLessGuidTableType
		
		INSERT INTO @TempIDs (Value)
		SELECT RelatedID
		FROM #Items
		
		DECLARE	@PermissionTypes StringPairTableType
		
		INSERT INTO @PermissionTypes (FirstValue, SecondValue)
		VALUES (N'View', @DefaultPrivacy)
	
		DELETE I
		FROM #Items AS I
			LEFT JOIN [dbo].[PRVC_FN_CheckAccess](@ApplicationID, @CurrentUserID, 
				@TempIDs, N'Node', @Now, @PermissionTypes) AS A
			ON A.ID = I.RelatedID
		WHERE A.ID IS NULL
	END
	
	IF ISNULL(@SearchText, N'') = N'' BEGIN	
		DECLARE @ToBeExecuted varchar(2000) = 
			'SELECT TOP(' + CAST(ISNULL(@Count, 100) AS varchar(100)) + ') ' +
				'CAST((X.RowNumber + X.RevRowNumber - 1) AS bigint) AS TotalCount, ' +
				'X.BaseID, X.BaseTypeID, X.BaseName, X.BaseType, ' +
				'X.RelatedID, X.RelatedTypeID, X.RelatedName, X.RelatedType, ' +
				'X.RelatedCreationDate, X.IsTag, X.IsRelation, X.IsRegistrationArea ' +
			'FROM ( ' +
					'SELECT	ROW_NUMBER() OVER (ORDER BY I.' + @OrderBy + ' ' + 
								@SortOrder + ', I.RelatedID ASC) AS RowNumber, ' +
							'ROW_NUMBER() OVER (ORDER BY I.' + @OrderBy + ' ' + 
								@RevSortOrder + ', I.RelatedID DESC) AS RevRowNumber, ' +
							'I.* ' +
					'FROM #Items AS I ' +
				') AS X ' +
			'WHERE X.RowNumber >= ' + CAST(ISNULL(@LowerBoundary, 0) AS varchar(100)) + ' ' +
			'ORDER BY X.RowNumber ASC '
			
		EXEC (@ToBeExecuted)
	END
	ELSE BEGIN
		SELECT TOP(ISNULL(@Count, 100))
			CAST((X.RowNumber + X.RevRowNumber - 1) AS bigint) AS TotalCount,
			X.BaseID, X.BaseTypeID, X.BaseName, X.BaseType,
			X.RelatedID, X.RelatedTypeID, X.RelatedName, X.RelatedType,
			X.RelatedCreationDate, X.IsTag, X.IsRelation, X.IsRegistrationArea
		FROM (
				SELECT	ROW_NUMBER() OVER (ORDER BY SRCH.[Rank] DESC, SRCH.[Key] ASC) AS RowNumber,
						ROW_NUMBER() OVER (ORDER BY SRCH.[Rank] ASC, SRCH.[Key] DESC) AS RevRowNumber,
						Ref.*
				FROM CONTAINSTABLE([dbo].[CN_Nodes], ([Name], [AdditionalID]), @SearchText) AS SRCH
					INNER JOIN (
						SELECT	CAST(MAX(CAST(I.BaseID AS varchar(100))) AS uniqueidentifier) AS BaseID,
								CAST(MAX(CAST(I.BaseTypeID AS varchar(100))) AS uniqueidentifier) AS BaseTypeID,
								MAX(I.BaseName) AS BaseName,
								MAX(I.BaseType) AS BaseType,
								I.RelatedID,
								CAST(MAX(CAST(I.RelatedTypeID AS varchar(100))) AS uniqueidentifier) AS RelatedTypeID,
								MAX(I.RelatedName) AS RelatedName,
								MAX(I.RelatedType) AS RelatedType,
								MAX(I.RelatedCreationDate) AS RelatedCreationDate,
								CAST(MAX(CAST(I.IsTag AS int)) AS bit) AS IsTag,
								CAST(MAX(CAST(I.IsRelation AS int)) AS bit) AS IsRelation,
								CAST(MAX(CAST(I.IsRegistrationArea AS int)) AS bit) AS IsRegistrationArea
						FROM #Items AS I
						GROUP BY I.RelatedID
					) AS Ref
					ON Ref.RelatedID = SRCH.[Key]
			) AS X
		WHERE X.RowNumber >= ISNULL(@LowerBoundary, 0)
		ORDER BY X.RowNumber ASC
	END
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_P_UpdateFormAndWikiTags]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_P_UpdateFormAndWikiTags]
GO

CREATE PROCEDURE [dbo].[CN_P_UpdateFormAndWikiTags]
	@ApplicationID	uniqueidentifier,
	@NodeIDsTemp	GuidTableType readonly,
	@CreatorUserID	uniqueidentifier,
	@Form			bit,
	@Wiki			bit,
	@_Result		int output
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @NodeIDs GuidTableType
	INSERT INTO @NodeIDs SELECT * FROM @NodeIDsTemp
	
	DELETE T
	FROM @NodeIDs AS IDs 
		INNER JOIN [dbo].[RV_TaggedItems] AS T
		ON T.ApplicationID = @ApplicationID AND T.ContextID = IDs.Value AND
			(
				(@Form = 1 AND T.TaggedType IN (N'Node_Form', N'User_Form')) OR 
				(@Wiki = 1 AND T.TaggedType IN (N'Node_Wiki', N'User_Wiki'))
			)

	;WITH hierarchy (ElementID, NodeID, [Level], [Type])
	AS
	(
		SELECT E.ElementID, N.Value AS NodeID, 0 AS [Level], E.[Type]
		FROM @NodeIDs AS N
			INNER JOIN [dbo].[FG_FormInstances] AS I
			ON I.ApplicationID = @ApplicationID AND I.OwnerID = N.Value AND I.Deleted = 0
			INNER JOIN [dbo].[FG_InstanceElements] AS E
			ON E.ApplicationID = @ApplicationID AND E.InstanceID = I.InstanceID AND E.Deleted = 0
		WHERE @Form = 1
		
		UNION ALL
		
		SELECT E.ElementID, HR.NodeID, [Level] + 1, E.[Type]
		FROM hierarchy AS HR
			INNER JOIN [dbo].[FG_FormInstances] AS I
			ON I.ApplicationID = @ApplicationID AND I.OwnerID = HR.ElementID AND I.Deleted = 0
			INNER JOIN [dbo].[FG_InstanceElements] AS E
			ON E.ApplicationID = @ApplicationID AND E.InstanceID = I.InstanceID AND E.Deleted = 0
		WHERE @Form = 1 AND E.ElementID <> HR.ElementID
	)


	INSERT INTO [dbo].[RV_TaggedItems] (
		ApplicationID, 
		ContextID, 
		ContextType, 
		TaggedID, 
		TaggedType, 
		UniqueID, 
		CreatorUserID
	)
	SELECT @ApplicationID, X.NodeID, N'Node', X.TaggedID, X.TaggedType, NEWID(), @CreatorUserID
	FROM (
			SELECT A.NodeID, A.TaggedID, MAX(A.TaggedType) AS TaggedType
			FROM (
					SELECT H.NodeID, T.TaggedID, T.TaggedType + N'_Form' AS TaggedType
					FROM hierarchy AS H
						INNER JOIN [dbo].[RV_TaggedItems] AS T
						ON T.ApplicationID = @ApplicationID AND T.ContextID = H.ElementID AND 
							T.TaggedType IN (N'Node', N'User')
					
					UNION

					SELECT H.NodeID, S.SelectedID AS TaggedID, H.[Type] + N'_Form' AS TaggedType
					FROM hierarchy AS H
						INNER JOIN [dbo].[FG_SelectedItems] AS S
						ON S.ApplicationID = @ApplicationID AND S.ElementID = H.ElementID AND S.Deleted = 0
					WHERE H.[Type] IN (N'Node', N'User')
					
					UNION
					
					SELECT T.ContextID AS NodeID, T.TaggedID, T.TaggedType + N'_Wiki' AS TaggedType
					FROM @NodeIDs AS IDs
						INNER JOIN [dbo].[CN_View_TagRelations_WikiContext] AS T
						ON T.ApplicationID = @ApplicationID AND T.ContextID = IDs.Value
					WHERE @Wiki = 1
				) AS A
			GROUP BY A.NodeID, A.TaggedID
		) AS X
		LEFT JOIN [dbo].[CN_Nodes] AS ND
		ON ND.ApplicationID = @ApplicationID AND ND.NodeID = X.TaggedID AND ND.Deleted = 0
		LEFT JOIN [dbo].[Users_Normal] AS UN
		ON UN.ApplicationID = @ApplicationID AND UN.UserID = X.TaggedID AND UN.IsApproved = 1
		LEFT JOIN [dbo].[RV_TaggedItems] AS T
		ON T.ApplicationID = @ApplicationID AND T.ContextID = X.NodeID AND
			T.TaggedID = X.TaggedID AND T.CreatorUserID = @CreatorUserID
	WHERE T.ContextID IS NULL AND (ND.NodeID IS NOT NULL OR UN.UserID IS NOT NULL)
		
	SET @_Result = 1
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_UpdateFormAndWikiTags]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_UpdateFormAndWikiTags]
GO

CREATE PROCEDURE [dbo].[CN_UpdateFormAndWikiTags]
	@ApplicationID	uniqueidentifier,
	@strNodeIDs		varchar(max),
	@delimiter		char,
	@CreatorUserID	uniqueidentifier,
	@Count			int,
	@Form			bit,
	@Wiki			bit
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @NodeIDs GuidTableType
	
	INSERT INTO @NodeIDs (Value)
	SELECT Ref.Value
	FROM [dbo].[GFN_StrToGuidTable](@strNodeIDs, @delimiter) AS Ref
	
	IF (SELECT COUNT(*) FROM @NodeIDs) = 0 BEGIN
		INSERT INTO @NodeIDs (Value)
		SELECT TOP(ISNULL(@Count, 200)) ND.NodeID
		FROM [dbo].[CN_Nodes] AS ND
		WHERE ND.ApplicationID = @ApplicationID AND ND.Deleted = 0
		ORDER BY ND.IndexLastUpdateDate ASC
	END
	
	IF @CreatorUserID IS NULL SET @CreatorUserID = (
		SELECT TOP(1) UserID
		FROM [dbo].[Users_Normal] AS UN
		WHERE UN.ApplicationID = @ApplicationID AND LOWER(UserName) = N'admin'
	)

	IF @CreatorUserID IS NULL SET @CreatorUserID = (
		SELECT TOP(1) App.CreatorUserID
		FROM [dbo].[aspnet_Applications] AS App
		WHERE App.ApplicationId = @ApplicationID
	)
	
	DECLARE @_Result int
	
	EXEC [dbo].[CN_P_UpdateFormAndWikiTags] @ApplicationID, @NodeIDs, @CreatorUserID, 
		@Form, @Wiki, @_Result output
	
	SELECT @_Result
END

GO



SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[DCT_CreateTree]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[DCT_CreateTree]
GO

CREATE PROCEDURE [dbo].[DCT_CreateTree]
	@ApplicationID		uniqueidentifier,
    @TreeID 			uniqueidentifier,
    @IsPrivate			bit,
    @OwnerID			uniqueidentifier,
    @Name				nvarchar(256),
    @Description		nvarchar(1000),
    @CreatorUserID		uniqueidentifier,
    @CreationDate		datetime,
    @Privacy			varchar(20),
    @IsTemplate			bit
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SET @Name = [dbo].[GFN_VerifyString](@Name)
	SET @Description = [dbo].[GFN_VerifyString](@Description)
	
	INSERT INTO [dbo].[DCT_Trees](
		ApplicationID,
		TreeID,
		IsPrivate,
		OwnerID,
		Name,
		[Description],
		CreatorUserID,
		CreationDate,
		Privacy,
		IsTemplate,
		Deleted
	)
	VALUES(
		@ApplicationID,
		@TreeID,
		@IsPrivate,
		@OwnerID,
		@Name,
		@Description,
		@CreatorUserID,
		@CreationDate,
		@Privacy,
		@IsTemplate,
		0
	)
	
    SELECT @@ROWCOUNT
END

GO



IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[DCT_ChangeTree]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[DCT_ChangeTree]
GO

CREATE PROCEDURE [dbo].[DCT_ChangeTree]
	@ApplicationID			uniqueidentifier,
    @TreeID					uniqueidentifier,
    @NewName				nvarchar(256),
    @NewDescription			nvarchar(1000),
    @LastModifierUserID		uniqueidentifier,
    @LastModificationDate	datetime,
    @IsTemplate				bit
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SET @NewName = [dbo].[GFN_VerifyString](@NewName)
	SET @NewDescription = [dbo].[GFN_VerifyString](@NewDescription)
	
	UPDATE [dbo].[DCT_Trees]
		SET Name = @NewName,
			[Description] = @NewDescription,
			LastModifierUserID = @LastModifierUserID,
			LastModificationDate = @LastModificationDate,
			IsTemplate = @IsTemplate
	WHERE ApplicationID = @ApplicationID AND TreeID = @TreeID
	
    SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[DCT_P_RemoveTrees]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[DCT_P_RemoveTrees]
GO

CREATE PROCEDURE [dbo].[DCT_P_RemoveTrees]
	@ApplicationID	uniqueidentifier,
    @TreeIDsTemp	GuidTableType readonly,
    @OwnerID		uniqueidentifier,
    @CurrentUserID	uniqueidentifier,
    @Now			datetime,
    @_Result		int output
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @TreeIDs GuidTableType
	INSERT INTO @TreeIDs SELECT * FROM @TreeIDsTemp
	
	UPDATE T
		SET Deleted = 1,
			LastModifierUserID = @CurrentUserID,
			LastModificationDate = @Now
	FROM @TreeIDs AS IDs
		INNER JOIN [dbo].[DCT_Trees] AS T
		ON T.ApplicationID = @ApplicationID AND T.TreeID = IDs.Value AND
			((@OwnerID IS NULL AND T.OwnerID IS NULL) OR T.OwnerID = @OwnerID)
	
    SET @_Result = @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[DCT_ArithmeticDeleteTree]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[DCT_ArithmeticDeleteTree]
GO

CREATE PROCEDURE [dbo].[DCT_ArithmeticDeleteTree]
	@ApplicationID	uniqueidentifier,
    @strTreeIDs		varchar(max),
    @delimiter		char,
    @OwnerID		uniqueidentifier,
    @CurrentUserID	uniqueidentifier,
    @Now			datetime
WITH ENCRYPTION
AS
BEGIN TRANSACTION
	SET NOCOUNT ON
	
	DECLARE @TreeIDs GuidTableType
	
	INSERT INTO @TreeIDs (Value)
	SELECT DISTINCT Ref.Value
	FROM [dbo].[GFN_StrToGuidTable](@strTreeIDs, @delimiter) AS Ref
	
	DECLARE @_Result int = 0
	
	EXEC [dbo].[DCT_P_RemoveTrees] @ApplicationID, @TreeIDs, 
		@OwnerID, @CurrentUserID, @Now, @_Result output
		
	IF (@_Result <> (SELECT COUNT(*) FROM @TreeIDs)) BEGIN
		SELECT -1
		ROLLBACK TRANSACTION
		RETURN
	END
	
	SELECT @_Result
COMMIT TRANSACTION

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[DCT_RecycleTree]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[DCT_RecycleTree]
GO

CREATE PROCEDURE [dbo].[DCT_RecycleTree]
	@ApplicationID	uniqueidentifier,
    @TreeID			uniqueidentifier,
    @CurrentUserID	uniqueidentifier,
    @Now			datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[DCT_Trees]
		SET Deleted = 0,
			LastModifierUserID = @CurrentUserID,
			LastModificationDate = @Now
	WHERE ApplicationID = @ApplicationID AND TreeID = @TreeID
	
    SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[DCT_P_GetTreesByIDs]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[DCT_P_GetTreesByIDs]
GO

CREATE PROCEDURE [dbo].[DCT_P_GetTreesByIDs]
	@ApplicationID	uniqueidentifier,
    @TreeIDsTemp	GuidTableType readonly
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @TreeIDs GuidTableType
	INSERT INTO @TreeIDs SELECT * FROM @TreeIDsTemp
	
	SELECT T.[TreeID] AS TreeID,
		   T.[Name] AS Name,
		   T.[Description] AS [Description],
		   T.[IsTemplate] AS IsTemplate
	FROM @TreeIDs AS ExternalIDs 
		INNER JOIN [dbo].[DCT_Trees] AS T
		ON T.ApplicationID = @ApplicationID AND ExternalIDs.Value = T.[TreeID]
	ORDER BY (CASE WHEN T.Deleted = 1 THEN T.SequenceNumber ELSE T.CreationDate END) ASC
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[DCT_GetTreesByIDs]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[DCT_GetTreesByIDs]
GO

CREATE PROCEDURE [dbo].[DCT_GetTreesByIDs]
	@ApplicationID	uniqueidentifier,
    @strTreeIDs		varchar(max),
    @delimiter		char
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @TreeIDs GuidTableType
	INSERT INTO @TreeIDs 
	SELECT DISTINCT Ref.Value FROM [dbo].[GFN_StrToGuidTable](@strTreeIDs, @delimiter) AS Ref
	
	UPDATE IDs
		SET Value = N.TreeID
	FROM @TreeIDs AS IDs
		INNER JOIN [dbo].[DCT_TreeNodes] AS N
		ON N.ApplicationID = @ApplicationID AND N.TreeNodeID = IDs.Value
	
	EXEC [dbo].[DCT_P_GetTreesByIDs] @ApplicationID, @TreeIDs
END

GO



IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[DCT_GetTrees]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[DCT_GetTrees]
GO

CREATE PROCEDURE [dbo].[DCT_GetTrees]
	@ApplicationID	uniqueidentifier,
    @OwnerID		uniqueidentifier,
    @Archive		bit
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @TreeIDs GuidTableType
	
	INSERT INTO @TreeIDs
	SELECT Ref.TreeID
	FROM [dbo].[DCT_Trees] AS Ref
	WHERE Ref.ApplicationID = @ApplicationID AND 
		((@OwnerID IS NULL AND Ref.IsPrivate = 0) OR Ref.OwnerID = @OwnerID) AND
		Ref.Deleted = ISNULL(@Archive, 0)
	
	EXEC [dbo].[DCT_P_GetTreesByIDs] @ApplicationID, @TreeIDs
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[DCT_AddTreeNode]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[DCT_AddTreeNode]
GO

CREATE PROCEDURE [dbo].[DCT_AddTreeNode]
	@ApplicationID	uniqueidentifier,
    @TreeNodeID		uniqueidentifier,
    @TreeID			uniqueidentifier,
    @ParentNodeID	uniqueidentifier,
    @Name			nvarchar(256),
    @Description	nvarchar(1000),
    @CreatorUserID	uniqueidentifier,
    @CreationDate	datetime,
    @Privacy		varchar(20)
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SET @Name = [dbo].[GFN_VerifyString](@Name)
	SET @Description = [dbo].[GFN_VerifyString](@Description)
	
	INSERT INTO [dbo].[DCT_TreeNodes](
		ApplicationID,
		TreeNodeID,
		TreeID,
		ParentNodeID,
		Name,
		[Description],
		CreatorUserID,
		CreationDate,
		Privacy,
		Deleted
	)
	VALUES(
		@ApplicationID,
		@TreeNodeID,
		@TreeID,
		@ParentNodeID,
		@Name,
		@Description,
		@CreatorUserID,
		@CreationDate,
		@Privacy,
		0
	)
	
    SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[DCT_ChangeTreeNode]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[DCT_ChangeTreeNode]
GO

CREATE PROCEDURE [dbo].[DCT_ChangeTreeNode]
	@ApplicationID			uniqueidentifier,
    @TreeNodeID				uniqueidentifier,
    @NewName				nvarchar(256),
    @NewDescription			nvarchar(1000),
    @LastModifierUserID		uniqueidentifier,
    @LastModificationDate	datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SET @NewName = [dbo].[GFN_VerifyString](@NewName)
	SET @NewDescription = [dbo].[GFN_VerifyString](@NewDescription)
	
	UPDATE [dbo].[DCT_TreeNodes]
		SET Name = (CASE WHEN ISNULL(@NewName, N'') = N'' THEN Name ELSE @NewName END),
			[Description] = @NewDescription,
			LastModifierUserID = @LastModifierUserID,
			LastModificationDate = @LastModificationDate
	WHERE ApplicationID = @ApplicationID AND TreeNodeID = @TreeNodeID
	
    SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[DCT_P_GetTreeNodeHierarchy]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[DCT_P_GetTreeNodeHierarchy]
GO

CREATE PROCEDURE [dbo].[DCT_P_GetTreeNodeHierarchy]
	@ApplicationID	uniqueidentifier,
	@TreeNodeID		uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @TreeID uniqueidentifier = (
		SELECT TOP(1) TreeID 
		FROM [dbo].[DCT_TreeNodes] 
		WHERE ApplicationID = @ApplicationID AND TreeNodeID = @TreeNodeID
	)
 	
	;WITH hierarchy (ID, ParentID, [Level], Name)
	AS
	(
		SELECT TreeNodeID AS ID, ParentNodeID AS ParentID, 0 AS [Level], Name
		FROM [dbo].[DCT_TreeNodes]
		WHERE ApplicationID = @ApplicationID AND TreeNodeID = @TreeNodeID
		
		UNION ALL
		
		SELECT Node.TreeNodeID AS ID, Node.ParentNodeID AS ParentID, [Level] + 1, Node.Name
		FROM [dbo].[DCT_TreeNodes] AS Node
			INNER JOIN hierarchy AS HR
			ON Node.TreeNodeID = HR.ParentID
		WHERE Node.ApplicationID = @ApplicationID AND 
			Node.TreeID = @TreeID AND Node.TreeNodeID <> HR.ID AND Node.Deleted = 0
	)
	
	SELECT * 
	FROM hierarchy
	ORDER BY hierarchy.[Level] ASC
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[DCT_CopyTreesOrTreeNodes]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[DCT_CopyTreesOrTreeNodes]
GO

CREATE PROCEDURE [dbo].[DCT_CopyTreesOrTreeNodes]
	@ApplicationID		uniqueidentifier,
    @TreeIDOrTreeNodeID	uniqueidentifier,
    @strCopiedIDs		varchar(max),
    @delimiter			char,
    @CurrentUserID		uniqueidentifier,
    @Now				datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @CopiedIDs GuidTableType
	
	INSERT INTO @CopiedIDs (Value)
	SELECT DISTINCT Ref.Value
	FROM [dbo].[GFN_StrToGuidTable](@strCopiedIDs, @delimiter) AS Ref
	
	DECLARE @TBL TABLE (ID uniqueidentifier, Name nvarchar(500), 
		ParentID uniqueidentifier, [NewID] uniqueidentifier, [Level] int, Seq int)
	
	INSERT INTO @TBL (ID, Name, ParentID, [NewID], [Level], Seq)
	SELECT Ref.NodeID, Ref.Name, Ref.ParentID, NEWID(), Ref.[Level], Ref.SequenceNumber
	FROM [dbo].[DCT_FN_GetChildNodesHierarchy](@ApplicationID, @CopiedIDs, 0) AS Ref
	
	DECLARE @TreeID uniqueidentifier = NULL
	DECLARE @TreeNodeID uniqueidentifier = NULL
	
	SELECT @TreeID = T.TreeID
	FROM [dbo].[DCT_Trees] AS T
	WHERE T.ApplicationID = @ApplicationID AND T.TreeID = @TreeIDOrTreeNodeID
	
	SELECT @TreeID = TN.TreeID, @TreeNodeID = TN.TreeNodeID
	FROM [dbo].[DCT_TreeNodes] AS TN
	WHERE TN.ApplicationID = @ApplicationID AND TN.TreeNodeID = @TreeIDOrTreeNodeID
	
	IF @TreeID IS NULL BEGIN
		SELECT CAST(NULL AS uniqueidentifier) AS ID
		SELECT -1
		RETURN
	END
	
	DECLARE @RootSeq int = 1 + ISNULL((
		SELECT MAX(TN.SequenceNumber) + COUNT(TN.TreeNodeID)
		FROM [dbo].[DCT_TreeNodes] AS TN
		WHERE TN.ApplicationID = @ApplicationID AND TN.TreeID = @TreeID AND
			(
				(@TreeNodeID IS NULL AND TN.ParentNodeID IS NULL) OR
				TN.ParentNodeID = @TreeNodeID
			)
	), 0)
	
	UPDATE X
		SET Seq = Ref.RowNumber + @RootSeq
	FROM @TBL AS X
		INNER JOIN (
			SELECT	ROW_NUMBER() OVER(ORDER BY 
						ISNULL(T.SequenceNumber, 10000) ASC, 
						T.Name ASC,
						ISNULL(ND.Seq, 10000) ASC,
						ND.Name ASC,
						TN.CreationDate ASC
					) AS RowNumber,
					TN.TreeNodeID
			FROM @TBL AS ND
				INNER JOIN [dbo].[DCT_TreeNodes] AS TN
				ON TN.ApplicationID = @ApplicationID AND TN.TreeNodeID = ND.ID
				INNER JOIN [dbo].[DCT_Trees] AS T
				ON T.ApplicationID = @ApplicationID AND T.TreeID = TN.TreeID
			WHERE ND.[Level] = 0
		) AS Ref
		ON Ref.TreeNodeID = X.ID
	
	INSERT INTO [dbo].[DCT_TreeNodes](
		ApplicationID,
		TreeNodeID,
		TreeID,
		Name,
		SequenceNumber,
		CreatorUserID,
		CreationDate,
		Deleted
	)
	SELECT @ApplicationID, T.[NewID], @TreeID, T.Name, T.Seq, @CurrentUserID, @Now, 0
	FROM @TBL AS T
	
	UPDATE TN
		SET ParentNodeID = CASE WHEN Node.[Level] = 0 THEN @TreeNodeID ELSE Parent.[NewID] END
	FROM @TBL AS Node
		LEFT JOIN @TBL AS Parent
		ON Parent.ID = Node.ParentID
		INNER JOIN [dbo].[DCT_TreeNodes] AS TN
		ON TN.ApplicationID = @ApplicationID AND TN.TreeNodeID = Node.[NewID]
	
    SELECT T.[NewID] AS ID
    FROM @TBL AS T
    WHERE T.[Level] = 0
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[DCT_MoveTreesOrTreeNodes]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[DCT_MoveTreesOrTreeNodes]
GO

CREATE PROCEDURE [dbo].[DCT_MoveTreesOrTreeNodes]
	@ApplicationID		uniqueidentifier,
    @TreeIDOrTreeNodeID	uniqueidentifier,
    @strMovedIDs		varchar(max),
    @delimiter			char,
    @CurrentUserID		uniqueidentifier,
    @Now				datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @MovedIDs GuidTableType
	
	INSERT INTO @MovedIDs (Value)
	SELECT DISTINCT Ref.Value
	FROM [dbo].[GFN_StrToGuidTable](@strMovedIDs, @delimiter) AS Ref
	
	IF EXISTS(
		SELECT TOP(1) 1
		FROM @MovedIDs AS M
		WHERE M.Value = @TreeIDOrTreeNodeID
	) BEGIN
		SELECT CAST(NULL AS uniqueidentifier) AS ID
		SELECT -1, N'CannotTransferToChilds'
		RETURN
	END
	
	DECLARE @TBL TABLE (ID uniqueidentifier, Name nvarchar(500), 
		ParentID uniqueidentifier, [Level] int, Seq int)
	
	INSERT INTO @TBL (ID, Name, ParentID, [Level], Seq)
	SELECT Ref.NodeID, Ref.Name, Ref.ParentID, Ref.[Level], Ref.SequenceNumber
	FROM [dbo].[DCT_FN_GetChildNodesHierarchy](@ApplicationID, @MovedIDs, NULL) AS Ref
	
	IF EXISTS(
		SELECT TOP(1) 1
		FROM @TBL AS T
		WHERE T.ID = @TreeIDOrTreeNodeID
	) BEGIN
		SELECT CAST(NULL AS uniqueidentifier) AS ID
		SELECT -1, N'CannotTransferToChilds'
		RETURN
	END
	
	DECLARE @TreeID uniqueidentifier = NULL
	DECLARE @TreeNodeID uniqueidentifier = NULL
	
	SELECT @TreeID = T.TreeID
	FROM [dbo].[DCT_Trees] AS T
	WHERE T.ApplicationID = @ApplicationID AND T.TreeID = @TreeIDOrTreeNodeID
	
	SELECT @TreeID = TN.TreeID, @TreeNodeID = TN.TreeNodeID
	FROM [dbo].[DCT_TreeNodes] AS TN
	WHERE TN.ApplicationID = @ApplicationID AND TN.TreeNodeID = @TreeIDOrTreeNodeID
	
	IF @TreeID IS NULL BEGIN
		SELECT CAST(NULL AS uniqueidentifier) AS ID
		SELECT -1
		RETURN
	END
	
	DECLARE @RootSeq int = 1 + ISNULL((
		SELECT MAX(TN.SequenceNumber) + COUNT(TN.TreeNodeID)
		FROM [dbo].[DCT_TreeNodes] AS TN
		WHERE TN.ApplicationID = @ApplicationID AND TN.TreeID = @TreeID AND
			(
				(@TreeNodeID IS NULL AND TN.ParentNodeID IS NULL) OR
				TN.ParentNodeID = @TreeNodeID
			)
	), 0)
	
	UPDATE X
		SET Seq = Ref.RowNumber + @RootSeq
	FROM @TBL AS X
		INNER JOIN (
			SELECT	ROW_NUMBER() OVER(ORDER BY 
						ISNULL(T.SequenceNumber, 10000) ASC, 
						T.Name ASC,
						ISNULL(ND.Seq, 10000) ASC,
						ND.Name ASC,
						TN.CreationDate ASC
					) AS RowNumber,
					TN.TreeNodeID
			FROM @TBL AS ND
				INNER JOIN [dbo].[DCT_TreeNodes] AS TN
				ON TN.ApplicationID = @ApplicationID AND TN.TreeNodeID = ND.ID
				INNER JOIN [dbo].[DCT_Trees] AS T
				ON T.ApplicationID = @ApplicationID AND T.TreeID = TN.TreeID
			WHERE ND.[Level] = 0
		) AS Ref
		ON Ref.TreeNodeID = X.ID
	
	UPDATE TN
		SET TreeID = @TreeID,
			ParentNodeID = CASE WHEN Node.[Level] = 0 THEN @TreeNodeID ELSE ParentNodeID END,
			SequenceNumber = CASE WHEN Node.[Level] = 0 THEN Node.Seq ELSE SequenceNumber END,
			LastModifierUserID = @CurrentUserID,
			LastModificationDate = @Now
	FROM @TBL AS Node
		INNER JOIN [dbo].[DCT_TreeNodes] AS TN
		ON TN.ApplicationID = @ApplicationID AND TN.TreeNodeID = Node.ID
		
	UPDATE T
		SET Deleted = 1,
			LastModifierUserID = @CurrentUserID,
			LastModificationDate = @Now
	FROM @MovedIDs AS IDs
		INNER JOIN [dbo].[DCT_Trees] AS T
		ON T.ApplicationID = @ApplicationID AND T.TreeID = IDs.Value
	
    SELECT T.ID AS ID
    FROM @TBL AS T
    WHERE T.[Level] = 0
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[DCT_MoveTreeNode]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[DCT_MoveTreeNode]
GO

CREATE PROCEDURE [dbo].[DCT_MoveTreeNode]
	@ApplicationID			uniqueidentifier,
    @strTreeNodeIDs			varchar(max),
	@delimiter				char,
    @NewParentNodeID		uniqueidentifier,
    @LastModifierUserID		uniqueidentifier,
    @LastModificationDate	datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @TreeNodeIDs GuidTableType
	INSERT INTO @TreeNodeIDs
	SELECT Ref.Value FROM [dbo].[GFN_StrToGuidTable](@strTreeNodeIDs, @delimiter) AS Ref
	
	DECLARE @ParentHierarchy NodesHierarchyTableType
	
	IF @NewParentNodeID IS NOT NULL BEGIN
		INSERT INTO @ParentHierarchy
		EXEC [dbo].[DCT_P_GetTreeNodeHierarchy] @ApplicationID, @NewParentNodeID
	END
	
	IF EXISTS(
		SELECT TOP(1) 1
		FROM @ParentHierarchy AS P
			INNER JOIN @TreeNodeIDs AS N
			ON N.Value = P.NodeID
	) BEGIN
		SELECT -1, N'CannotTransferToChilds'
		RETURN
	END
	
	UPDATE TN
		SET LastModifierUserID = @LastModifierUserID,
			LastModificationDate = @LastModificationDate,
			ParentNodeID = @NewParentNodeID
	FROM @TreeNodeIDs AS Ref
		INNER JOIN [dbo].[DCT_TreeNodes] AS TN
		ON TN.[TreeNodeID] = Ref.Value
	WHERE TN.ApplicationID = @ApplicationID AND 
		(@NewParentNodeID IS NULL OR TN.[TreeNodeID] <> @NewParentNodeID)
	
    SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[DCT_P_RemoveTreeNodes]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[DCT_P_RemoveTreeNodes]
GO

CREATE PROCEDURE [dbo].[DCT_P_RemoveTreeNodes]
	@ApplicationID		uniqueidentifier,
    @TreeNodeIDsTemp	GuidTableType readonly,
    @TreeOwnerID		uniqueidentifier,
    @RemoveHierarchy	bit,
    @CurrentUserID		uniqueidentifier,
    @Now				datetime,
    @_Result			int output
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @TreeNodeIDs GuidTableType
	INSERT INTO @TreeNodeIDs SELECT * FROM @TreeNodeIDsTemp
	
	IF ISNULL(@RemoveHierarchy, 0) = 0 BEGIN
		UPDATE TN
			SET Deleted = 1,
				LastModifierUserID = @CurrentUserID,
				LastModificationDate = @Now
		FROM @TreeNodeIDs AS Ref
			INNER JOIN [dbo].[DCT_TreeNodes] AS TN
			ON TN.ApplicationID = @ApplicationID AND 
				TN.[TreeNodeID] = Ref.Value AND TN.Deleted = 0
			INNER JOIN [dbo].[DCT_Trees] AS T
			ON T.ApplicationID = @ApplicationID AND T.TreeID = TN.TreeID AND
				((@TreeOwnerID IS NULL AND T.OwnerID IS NULL) OR T.OwnerID = @TreeOwnerID)
			
		SET @_Result = @@ROWCOUNT
		
		UPDATE TN
			SET ParentNodeID = NULL,
				LastModifierUserID = @CurrentUserID,
				LastModificationDate = @Now
		FROM [dbo].[DCT_TreeNodes] AS TN
			INNER JOIN [dbo].[DCT_Trees] AS T
			ON T.ApplicationID = @ApplicationID AND T.TreeID = TN.TreeID AND
				((@TreeOwnerID IS NULL AND T.OwnerID IS NULL) OR T.OwnerID = @TreeOwnerID)
		WHERE TN.ApplicationID = @ApplicationID AND 
			TN.ParentNodeID IN(SELECT * FROM @TreeNodeIDs) AND TN.Deleted = 0
		
		SET @_Result = MAX(@@ROWCOUNT + @_Result)
	END
	ELSE BEGIN
		UPDATE TN
			SET Deleted = 1,
				LastModifierUserID = @CurrentUserID,
				LastModificationDate = @Now
		FROM [dbo].[DCT_FN_GetChildNodesHierarchy](@ApplicationID, @TreeNodeIDs, 0) AS Ref
			INNER JOIN [dbo].[DCT_TreeNodes] AS TN
			ON TN.ApplicationID = @ApplicationID AND 
				TN.TreeNodeID = Ref.NodeID AND TN.Deleted = 0
			INNER JOIN [dbo].[DCT_Trees] AS T
			ON T.ApplicationID = @ApplicationID AND T.TreeID = TN.TreeID AND
				((@TreeOwnerID IS NULL AND T.OwnerID IS NULL) OR T.OwnerID = @TreeOwnerID)
			
		SET @_Result = @@ROWCOUNT
	END
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[DCT_ArithmeticDeleteTreeNode]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[DCT_ArithmeticDeleteTreeNode]
GO

CREATE PROCEDURE [dbo].[DCT_ArithmeticDeleteTreeNode]
	@ApplicationID		uniqueidentifier,
    @strTreeNodeIDs		varchar(max),
    @delimiter			char,
    @TreeOwnerID		uniqueidentifier,
    @RemoveHierarchy	bit,
    @CurrentUserID		uniqueidentifier,
    @Now				datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @TreeNodeIDs GuidTableType
	
	INSERT INTO @TreeNodeIDs
	SELECT DISTINCT Ref.Value FROM GFN_StrToGuidTable(@strTreeNodeIDs, @delimiter) AS Ref
	
	DECLARE @_Result int = 0
	
	EXEC [dbo].[DCT_P_RemoveTreeNodes] @ApplicationID, @TreeNodeIDs, @TreeOwnerID, 
		@RemoveHierarchy, @CurrentUserID, @Now, @_Result output
	
	SELECT @_Result
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[DCT_P_GetTreeNodesByIDs]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[DCT_P_GetTreeNodesByIDs]
GO

CREATE PROCEDURE [dbo].[DCT_P_GetTreeNodesByIDs]
	@ApplicationID		uniqueidentifier,
    @TreeNodeIDsTemp	KeyLessGuidTableType readonly
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @TreeNodeIDs KeyLessGuidTableType
	INSERT INTO @TreeNodeIDs (Value) SELECT Value FROM @TreeNodeIDsTemp
	
	SELECT TN.[TreeNodeID] AS TreeNodeID,
		   TN.[TreeID] AS TreeID,
		   TN.[ParentNodeID] AS ParentNodeID,
		   TN.[Name] AS Name,
		   (
				SELECT CAST(1 AS bit) 
				WHERE EXISTS(
						SELECT TOP(1)* 
						FROM [dbo].[DCT_TreeNodes] AS TN
						WHERE TN.ApplicationID = @ApplicationID AND 
							TN.ParentNodeID = Ref.Value AND TN.Deleted = 0
					)
			) AS HasChild
	FROM @TreeNodeIDs AS Ref
		INNER JOIN [dbo].[DCT_TreeNodes] AS TN
		ON TN.[TreeNodeID] = Ref.Value
	WHERE TN.ApplicationID = @ApplicationID AND TN.[Deleted] = 0
	ORDER BY Ref.SequenceNumber ASC
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[DCT_GetTreeNodesByIDs]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[DCT_GetTreeNodesByIDs]
GO

CREATE PROCEDURE [dbo].[DCT_GetTreeNodesByIDs]
	@ApplicationID		uniqueidentifier,
    @strTreeNodeIDs		varchar(max),
    @delimiter			char
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @TreeNodeIDs KeyLessGuidTableType
	
	INSERT INTO @TreeNodeIDs (Value)
	SELECT DISTINCT Ref.Value 
	FROM GFN_StrToGuidTable(@strTreeNodeIDs, @delimiter) AS Ref
	
	EXEC [dbo].[DCT_P_GetTreeNodesByIDs] @ApplicationID, @TreeNodeIDs
END

GO



IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[DCT_GetTreeNodes]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[DCT_GetTreeNodes]
GO

CREATE PROCEDURE [dbo].[DCT_GetTreeNodes]
	@ApplicationID	uniqueidentifier,
    @TreeID			uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @TreeNodeIDs KeyLessGuidTableType
	
	INSERT INTO @TreeNodeIDs (Value)
	SELECT TreeNodeID
	FROM [dbo].[DCT_TreeNodes]
	WHERE ApplicationID = @ApplicationID AND TreeID = @TreeID AND Deleted = 0
	ORDER BY ISNULL(SequenceNumber, 100000) ASC, Name ASC, CreationDate ASC
	
	EXEC [dbo].[DCT_P_GetTreeNodesByIDs] @ApplicationID, @TreeNodeIDs
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[DCT_GetRootNodes]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[DCT_GetRootNodes]
GO

CREATE PROCEDURE [dbo].[DCT_GetRootNodes]
	@ApplicationID	uniqueidentifier,
    @TreeID			uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @TreeNodeIDs KeyLessGuidTableType
	
	INSERT INTO @TreeNodeIDs (Value)
	SELECT TreeNodeID
	FROM [dbo].[DCT_TreeNodes]
	WHERE ApplicationID = @ApplicationID AND TreeID = @TreeID AND Deleted = 0 AND 
		(ParentNodeID IS NULL OR ParentNodeID = TreeNodeID)
	ORDER BY ISNULL(SequenceNumber, 100000) ASC, Name ASC, CreationDate ASC
	
	EXEC [dbo].[DCT_P_GetTreeNodesByIDs] @ApplicationID, @TreeNodeIDs
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[DCT_GetChildNodes]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[DCT_GetChildNodes]
GO

CREATE PROCEDURE [dbo].[DCT_GetChildNodes]
	@ApplicationID	uniqueidentifier,
    @ParentNodeID	uniqueidentifier,
    @TreeID			uniqueidentifier,
    @SearchText		nvarchar(500)
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	IF @TreeID IS NULL AND @ParentNodeID IS NULL RETURN
	
	DECLARE @TreeNodeIDs KeyLessGuidTableType
	
	IF ISNULL(@SearchText, N'') = N'' BEGIN
		INSERT INTO @TreeNodeIDs (Value)
		SELECT TreeNodeID
		FROM [dbo].[DCT_TreeNodes]
		WHERE ApplicationID = @ApplicationID AND Deleted = 0 AND 
			(@TreeID IS NULL OR TreeID = @TreeID) AND
			(
				(@ParentNodeID IS NULL AND ParentNodeID IS NULL) OR 
				(@ParentNodeID IS NOT NULL AND ParentNodeID = @ParentNodeID)
			)
		ORDER BY ISNULL(SequenceNumber, 100000) ASC, Name ASC, CreationDate ASC
	END
	ELSE BEGIN
		DECLARE @IDs GuidTableType
	
		IF @ParentNodeID IS NOT NULL BEGIN
			INSERT INTO @IDs (Value)
			VALUES (@ParentNodeID)
			
			INSERT INTO @IDs (Value)
			SELECT DISTINCT H.NodeID
			FROM [dbo].[DCT_FN_GetChildNodesDeepHierarchy](@ApplicationID, @IDs) AS H
			WHERE H.NodeID <> @ParentNodeID
			
			DELETE @IDs
			WHERE Value = @ParentNodeID
		END
		
		DECLARE @NodeIDsCount int = (SELECT COUNT(*) FROM @IDs)
	
		INSERT INTO @TreeNodeIDs (Value)
		SELECT X.NodeID
		FROM (
				SELECT	ROW_NUMBER() OVER (ORDER BY SRCH.[Rank] DESC, SRCH.[Key] ASC) AS RowNumber,
						SRCH.[Key] AS NodeID
				FROM CONTAINSTABLE([dbo].[DCT_TreeNodes], (Name), @SearchText) AS SRCH
					INNER JOIN [dbo].[DCT_TreeNodes] AS TN
					ON TN.TreeNodeID = SRCH.[Key]
					LEFT JOIN @IDs AS I
					ON I.Value = TN.TreeNodeID
				WHERE TN.ApplicationID = @ApplicationID AND TN.Deleted = 0 AND 
					(@NodeIDsCount = 0 OR I.Value IS NOT NULL) AND 
					(@TreeID IS NULL OR TN.TreeID = @TreeID)
			) AS X
		ORDER BY X.RowNumber ASC
	END
	
	EXEC [dbo].[DCT_P_GetTreeNodesByIDs] @ApplicationID, @TreeNodeIDs
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[DCT_GetParentNode]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[DCT_GetParentNode]
GO

CREATE PROCEDURE [dbo].[DCT_GetParentNode]
	@ApplicationID	uniqueidentifier,
    @TreeNodeID		uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @TreeNodeIDs KeyLessGuidTableType
	
	INSERT INTO @TreeNodeIDs (Value)
	SELECT [First].ParentNodeID
	FROM [dbo].[DCT_TreeNodes] AS [First] 
		INNER JOIN [dbo].[DCT_TreeNodes] AS [Second]
		ON [Second].ApplicationID = @ApplicationID AND 
			[Second].TreeNodeID = [First].ParentNodeID
	WHERE [First].ApplicationID = @ApplicationID AND 
		[First].TreeNodeID = @TreeNodeID AND [Second].Deleted = 0
	
	EXEC [dbo].[DCT_P_GetTreeNodesByIDs] @ApplicationID, @TreeNodeIDs
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[DCT_P_AddFiles]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[DCT_P_AddFiles]
GO

CREATE PROCEDURE [dbo].[DCT_P_AddFiles]
	@ApplicationID	uniqueidentifier,
    @OwnerID		uniqueidentifier,
    @OwnerType		varchar(20),
    @DocFilesTemp	DocFileInfoTableType readonly,
    @CurrentUserID	uniqueidentifier,
    @Now			datetime,
    @_Result		int output
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @DocFiles DocFileInfoTableType
	INSERT INTO @DocFiles SELECT * FROM @DocFilesTemp
	
	UPDATE D
		SET Deleted = 0
	FROM @DocFiles AS F
		INNER JOIN [dbo].[DCT_Files] AS D
		ON D.ApplicationID = @ApplicationID AND (D.ID = F.FileID OR D.FileNameGuid = F.FileID) AND
			((F.OwnerID IS NULL AND D.OwnerID IS NULL) OR (D.OwnerID = ISNULL(@OwnerID, F.OwnerID)))
	
	INSERT INTO [dbo].[DCT_Files] (
		ApplicationID,
		ID,
		OwnerID,
		OwnerType,
		FileNameGuid,
		Extension,
		[FileName],
		MIME,
		Size,
		CreatorUserID,
		CreationDate,
		Deleted
	)
	SELECT	@ApplicationID, 
			NEWID(),
			ISNULL(@OwnerID, F.OwnerID),
			ISNULL(@OwnerType, F.OwnerType),
			F.FileID,
			F.Extension,
			F.[FileName],
			F.MIME,
			F.Size,
			@CurrentUserID,
			@Now,
			0
	FROM @DocFiles AS F
		LEFT JOIN [dbo].[DCT_Files] AS D
		ON D.ApplicationID = @ApplicationID AND (D.ID = F.FileID OR D.FileNameGuid = F.FileID) AND
			((F.OwnerID IS NULL AND D.OwnerID IS NULL) OR (D.OwnerID = ISNULL(@OwnerID, F.OwnerID)))
	WHERE D.ID IS NULL
	
	SET @_Result = @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[DCT_AddFiles]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[DCT_AddFiles]
GO

CREATE PROCEDURE [dbo].[DCT_AddFiles]
	@ApplicationID	uniqueidentifier,
    @OwnerID		uniqueidentifier,
    @OwnerType		varchar(50),
    @DocFilesTemp	DocFileInfoTableType readonly,
    @CurrentUserID	uniqueidentifier,
    @Now			datetime
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @DocFiles DocFileInfoTableType
	INSERT INTO @DocFiles SELECT * FROM @DocFilesTemp
	
	DECLARE @_Result int
	
	EXEC [dbo].[DCT_P_AddFiles] @ApplicationID, @OwnerID, @OwnerType, @DocFiles,
		@CurrentUserID, @Now, @_Result output
	
	SELECT @_Result
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[DCT_P_RemoveOwnerFiles]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[DCT_P_RemoveOwnerFiles]
GO

CREATE PROCEDURE [dbo].[DCT_P_RemoveOwnerFiles]
	@ApplicationID	uniqueidentifier,
    @OwnerID		uniqueidentifier,
    @_Result		int output
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	IF EXISTS(
		SELECT TOP(1) * 
		FROM [dbo].[DCT_Files]
		WHERE ApplicationID = @ApplicationID AND OwnerID = @OwnerID AND Deleted = 0
	) BEGIN
		UPDATE [dbo].[DCT_Files]
			SET Deleted = 1
		WHERE ApplicationID = @ApplicationID AND OwnerID = @OwnerID AND Deleted = 0
		
		SET @_Result = @@ROWCOUNT
	END
	ELSE BEGIN
		SET @_Result = 1
	END
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[DCT_P_RemoveOwnersFiles]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[DCT_P_RemoveOwnersFiles]
GO

CREATE PROCEDURE [dbo].[DCT_P_RemoveOwnersFiles]
	@ApplicationID	uniqueidentifier,
    @OwnerIDsTemp	GuidTableType readonly,
    @_Result		int output
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @OwnerIDs GuidTableType
	INSERT INTO @OwnerIDs SELECT * FROM @OwnerIDsTemp
	
	IF EXISTS(
		SELECT TOP(1) * 
		FROM @OwnerIDs AS IDs
			INNER JOIN [dbo].[DCT_Files] AS F
			ON F.ApplicationID = @ApplicationID AND F.OwnerID = IDs.Value AND F.Deleted = 0
	) BEGIN
		UPDATE F
			SET Deleted = 1
		FROM @OwnerIDs AS IDs
			INNER JOIN [dbo].[DCT_Files] AS F
			ON F.ApplicationID = @ApplicationID AND F.OwnerID = IDs.Value AND F.Deleted = 0
		
		SET @_Result = @@ROWCOUNT
	END
	ELSE BEGIN
		SET @_Result = 1
	END
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[DCT_RenameFile]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[DCT_RenameFile]
GO

CREATE PROCEDURE [dbo].[DCT_RenameFile]
	@ApplicationID	uniqueidentifier,
    @FileID			uniqueidentifier,
    @Name			nvarchar(255)
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE AF
		SET [FileName] = [dbo].[GFN_VerifyString](ISNULL(@Name, N'file'))
	FROM [dbo].[DCT_Files] AS AF
	WHERE AF.ApplicationID = @ApplicationID AND  (AF.[ID] = @FileID OR AF.[FileNameGuid] = @FileID)
		
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[DCT_ArithmeticDeleteFiles]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[DCT_ArithmeticDeleteFiles]
GO

CREATE PROCEDURE [dbo].[DCT_ArithmeticDeleteFiles]
	@ApplicationID	uniqueidentifier,
	@OwnerID		uniqueidentifier,
    @strFileIDs		varchar(max),
    @delimiter		char
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @FileIDs GuidTableType
	INSERT INTO @FileIDs
	SELECT DISTINCT Ref.Value FROM [dbo].[GFN_StrToGuidTable](@strFileIDs, @delimiter) AS Ref
	
	IF @OwnerID IS NULL BEGIN
		UPDATE AF
			SET Deleted = 1
		FROM @FileIDs AS ExternalIDs
			INNER JOIN [dbo].[DCT_Files] AS AF
			ON AF.ApplicationID = @ApplicationID AND 
				(AF.[ID] = ExternalIDs.Value OR AF.[FileNameGuid] = ExternalIDs.Value)
	END
	ELSE BEGIN
		UPDATE AF
			SET Deleted = 1
		FROM @FileIDs AS ExternalIDs
			INNER JOIN [dbo].[DCT_Files] AS AF
			ON AF.[ID] = ExternalIDs.Value OR AF.[FileNameGuid] = ExternalIDs.Value
		WHERE AF.ApplicationID = @ApplicationID AND AF.OwnerID = @OwnerID AND AF.Deleted = 0
	END
		
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[DCT_CopyFile]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[DCT_CopyFile]
GO

CREATE PROCEDURE [dbo].[DCT_CopyFile]
	@ApplicationID	uniqueidentifier,
	@OwnerID		uniqueidentifier,
    @FileID			uniqueidentifier,
    @OwnerType		varchar(50),
    @CurrentUserID	uniqueidentifier,
    @Now			datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	IF EXISTS(
		SELECT TOP(1) * 
		FROM [dbo].[DCT_Files] AS AF
		WHERE AF.ApplicationID = @ApplicationID AND 
			AF.OwnerID = @OwnerID AND (AF.ID = @FileID OR AF.FileNameGuid = @FileID)
	) BEGIN
		UPDATE AF
			SET Deleted = 0
		FROM [dbo].[DCT_Files] AS AF
		WHERE AF.ApplicationID = @ApplicationID AND 
			AF.OwnerID = @OwnerID AND (AF.ID = @FileID OR AF.FileNameGuid = @FileID)
		
		SELECT @@ROWCOUNT
	END
	ELSE BEGIN
		INSERT INTO [dbo].[DCT_Files] (
			ApplicationID,
			ID,
			OwnerID,
			OwnerType,
			FileNameGuid,
			Extension,
			[FileName],
			MIME,
			Size,
			CreatorUserID,
			CreationDate,
			Deleted
		)
		SELECT TOP(1) 
			@ApplicationID, 
			NEWID(), 
			@OwnerID,
			@OwnerType,
			AF.FileNameGuid, 
			AF.Extension, 
			AF.[FileName], 
			AF.MIME, 
			AF.Size, 
			@CurrentUserID,
			@Now,
			0
		FROM [dbo].[DCT_Files] AS AF
		WHERE AF.ApplicationID = @ApplicationID AND 
			(AF.ID = @FileID OR AF.FileNameGuid = @FileID)
	
		SELECT @@ROWCOUNT
	END
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[DCT_P_CopyAttachments]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[DCT_P_CopyAttachments]
GO

CREATE PROCEDURE [dbo].[DCT_P_CopyAttachments]
	@ApplicationID	uniqueidentifier,
	@FromOwnerID	uniqueidentifier,
    @ToOwnerID		uniqueidentifier,
    @ToOwnerType	varchar(50),
    @CurrentUserID	uniqueidentifier,
    @Now			datetime,
    @_Result		int output
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	INSERT INTO [dbo].[DCT_Files] (
		ApplicationID,
		ID,
		OwnerID,
		OwnerType,
		FileNameGuid,
		Extension,
		[FileName],
		MIME,
		Size,
		CreatorUserID,
		CreationDate,
		Deleted
	)
	SELECT	@ApplicationID,
			NEWID(),
			@ToOwnerID,
			@ToOwnerType,
			AF.FileNameGuid,
			AF.Extension,
			AF.[FileName],
			AF.MIME,
			AF.Size,
			@CurrentUserID,
			@Now,
			AF.Deleted
	FROM [dbo].[DCT_Files] AS AF
	WHERE AF.ApplicationID = @ApplicationID AND AF.OwnerID = @FromOwnerID AND AF.Deleted = 0
	
	SET @_Result = @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[DCT_P_GetFilesByIDs]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[DCT_P_GetFilesByIDs]
GO

CREATE PROCEDURE [dbo].[DCT_P_GetFilesByIDs]
	@ApplicationID	uniqueidentifier,
    @FileIDsTemp	GuidTableType readonly
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @FileIDs GuidTableType
	INSERT INTO @FileIDs SELECT * FROM @FileIDsTemp
	
	SELECT AF.OwnerID,
		   AF.OwnerType,
		   AF.FileNameGuid AS FileID,
		   AF.[FileName],
		   AF.Extension,
		   AF.MIME,
		   AF.Size
	FROM @FileIDs AS ExternalIDs
		INNER JOIN [dbo].[DCT_Files] AS AF
		ON AF.ApplicationID = @ApplicationID AND 
			ExternalIDs.Value = AF.ID OR ExternalIDs.Value = AF.FileNameGuid
	ORDER BY AF.CreationDate ASC, AF.[FileName] ASC
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[DCT_GetOwnerFiles]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[DCT_GetOwnerFiles]
GO

CREATE PROCEDURE [dbo].[DCT_GetOwnerFiles]
	@ApplicationID	uniqueidentifier,
    @strOwnerIDs	varchar(max),
    @delimiter		char,
    @Type			varchar(50)
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @OwnerIDs GuidTableType
	INSERT INTO @OwnerIDs
	SELECT DISTINCT Ref.Value FROM [dbo].[GFN_StrToGuidTable](@strOwnerIDs, @delimiter) AS Ref
	
	DECLARE @FileIDs GuidTableType
	
	INSERT INTO @FileIDs
	SELECT AF.ID
	FROM @OwnerIDs AS ExternalIDs
		INNER JOIN [dbo].[DCT_Files] AS AF
		ON AF.ApplicationID = @ApplicationID AND 
			AF.OwnerID = ExternalIDs.Value AND AF.Deleted = 0 AND
			(@Type IS NULL OR AF.OwnerType = @Type)
		
	EXEC [dbo].[DCT_P_GetFilesByIDs] @ApplicationID, @FileIDs
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[DCT_GetFilesByIDs]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[DCT_GetFilesByIDs]
GO

CREATE PROCEDURE [dbo].[DCT_GetFilesByIDs]
	@ApplicationID	uniqueidentifier,
    @strFileIDs		varchar(max),
    @delimiter		char
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @FileIDs GuidTableType
	INSERT INTO @FileIDs
	SELECT DISTINCT Ref.Value FROM [dbo].[GFN_StrToGuidTable](@strFileIDs, @delimiter) AS Ref
	
	EXEC [dbo].[DCT_P_GetFilesByIDs] @ApplicationID, @FileIDs
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[DCT_GetFileOwnerNodes]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[DCT_GetFileOwnerNodes]
GO

CREATE PROCEDURE [dbo].[DCT_GetFileOwnerNodes]
	@ApplicationID	uniqueidentifier,
	@strFileIDs		varchar(max),
	@delimiter		char
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @IDs GuidTableType
	
	INSERT INTO @IDs (Value)
	SELECT DISTINCT Ref.Value
	FROM [dbo].[GFN_StrToGuidTable](@strFileIDs, @delimiter) AS Ref
	
	SELECT Ref.FileID, Ref.NodeID, Ref.NodeName AS Name, Ref.NodeType
	FROM [dbo].[DCT_FN_GetFileOwnerNodes](@ApplicationID, @IDs) AS Ref
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[DCT_GetNotExtractedFiles]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[DCT_GetNotExtractedFiles]
GO

CREATE PROCEDURE [dbo].[DCT_GetNotExtractedFiles]
	@ApplicationID		uniqueidentifier,
	@AllowedExtensions	varchar(max),
	@Delimiter			char,
	@Count				int
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @Ext stringTableType
	
	INSERT INTO @Ext 
	SELECT LOWER(Ref.Value) 
	FROM dbo.GFN_StrToStringTable(@AllowedExtensions,@Delimiter) AS Ref
	
	DECLARE @FileIDs GuidTableType
	
	INSERT INTO @FileIDs (Value)
	SELECT TOP (ISNULL(@Count, 20)) AF.ID
	FROM @Ext AS Ex
		INNER JOIN [dbo].[DCT_Files] AS AF
		ON Ex.Value = LOWER(AF.Extension)
		LEFT JOIN [dbo].[DCT_FileContents] AS FC
		ON FC.ApplicationID = @ApplicationID AND FC.FileID = AF.FileNameGuid
	WHERE AF.ApplicationID = @ApplicationID AND AF.Deleted = 0 AND FC.FileID IS NULL AND 
		(AF.OwnerType = N'Node' OR AF.OwnerType = N'WikiContent' OR 
			AF.OwnerType = N'FormElement')
		
	EXEC [dbo].[DCT_P_GetFilesByIDs] @ApplicationID, @FileIDs
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[DCT_SaveFileContent]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[DCT_SaveFileContent]
GO

CREATE PROCEDURE [dbo].[DCT_SaveFileContent]
	@ApplicationID	uniqueidentifier,
	@FileID			UNIQUEIDENTIFIER,
	@Content		NVARCHAR(MAX),
	@NotExtractable BIT,
	@FileNotFount	BIT,
	@Duration		BIGINT,
	@ExtractionDate DATETIME,
	@Error			NVARCHAR(MAX)
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SET @Content = [dbo].[GFN_VerifyString](ISNULL(@Content, N''))
	
    INSERT INTO DCT_FileContents (
		ApplicationID,
		FileID, 
		Content, 
		NotExtractable,
		FileNotFound, 
		Duration, 
		ExtractionDate, 
		Error
	)
    VALUES (@ApplicationID, @FileID, @Content, @NotExtractable, @FileNotFount, 
		@Duration , @ExtractionDate, @Error)
    
    SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[DCT_GetTreeNodeHierarchy]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[DCT_GetTreeNodeHierarchy]
GO

CREATE PROCEDURE [dbo].[DCT_GetTreeNodeHierarchy]
	@ApplicationID	uniqueidentifier,
	@TreeNodeID		uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	;WITH hierarchy (ID, ParentID, [Level], Name)
	AS
	(
		SELECT TreeNodeID AS ID, ParentNodeID, 0 AS [Level], Name
		FROM [dbo].[DCT_TreeNodes]
		WHERE ApplicationID = @ApplicationID AND TreeNodeID = @TreeNodeID
		
		UNION ALL
		
		SELECT TN.TreeNodeID AS ID, TN.ParentNodeID, [Level] + 1, TN.Name
		FROM [dbo].[DCT_TreeNodes] AS TN
			INNER JOIN hierarchy AS HR
			ON TN.TreeNodeID = HR.ParentID
		WHERE TN.ApplicationID = @ApplicationID AND TN.TreeNodeID <> HR.ID AND TN.Deleted = 0
	)
	
	SELECT * FROM hierarchy
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[DCT_SetTreeNodesOrder]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[DCT_SetTreeNodesOrder]
GO

CREATE PROCEDURE [dbo].[DCT_SetTreeNodesOrder]
	@ApplicationID	uniqueidentifier,
	@strTreeNodeIDs	varchar(max),
	@delimiter		char
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @TreeNodeIDs TABLE (
		SequenceNo int identity(1, 1) primary key, 
		TreeNodeID uniqueidentifier
	)
	
	INSERT INTO @TreeNodeIDs (TreeNodeID)
	SELECT Ref.Value
	FROM [dbo].[GFN_StrToGuidTable](@strTreeNodeIDs, @delimiter) AS Ref
	
	DECLARE @ParentNodeID uniqueidentifier = NULL, @TreeID uniqueidentifier = NULL
	
	SELECT TOP(1) @ParentNodeID = ParentNodeID, @TreeID = TreeID
	FROM [dbo].[DCT_TreeNodes]
	WHERE ApplicationID = @ApplicationID AND 
		TreeNodeID = (SELECT TOP (1) Ref.TreeNodeID FROM @TreeNodeIDs AS Ref)
	
	INSERT INTO @TreeNodeIDs (TreeNodeID)
	SELECT TN.TreeNodeID
	FROM @TreeNodeIDs AS Ref
		RIGHT JOIN [dbo].[DCT_TreeNodes] AS TN
		ON TN.ApplicationID = @ApplicationID AND TN.TreeNodeID = Ref.TreeNodeID
	WHERE TN.ApplicationID = @ApplicationID AND TN.TreeID = @TreeID AND (
			(TN.ParentNodeID IS NULL AND @ParentNodeID IS NULL) OR 
			TN.ParentNodeID = @ParentNodeID
		) AND Ref.TreeNodeID IS NULL
	ORDER BY TN.SequenceNumber
	
	UPDATE [dbo].[DCT_TreeNodes]
		SET SequenceNumber = Ref.SequenceNo
	FROM @TreeNodeIDs AS Ref
		INNER JOIN [dbo].[DCT_TreeNodes] AS TN
		ON TN.TreeNodeID = Ref.TreeNodeID
	WHERE TN.ApplicationID = @ApplicationID AND TN.TreeID = @TreeID AND (
			(TN.ParentNodeID IS NULL AND @ParentNodeID IS NULL) OR 
			TN.ParentNodeID = @ParentNodeID
		)
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[DCT_IsPrivateTree]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[DCT_IsPrivateTree]
GO

CREATE PROCEDURE [dbo].[DCT_IsPrivateTree]
	@ApplicationID		uniqueidentifier,
	@TreeIDOrTreeNodeID	uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT CAST(1 AS bit)
	WHERE EXISTS(
			SELECT TOP(1) TreeID
			FROM [dbo].[DCT_Trees]
			WHERE ApplicationID = @ApplicationID AND 
				TreeID = @TreeIDOrTreeNodeID AND IsPrivate = 1
		) OR EXISTS(
			SELECT TOP(1) N.TreeNodeID
			FROM [dbo].[DCT_TreeNodes] AS N
				INNER JOIN [dbo].[DCT_Trees] AS T
				ON T.ApplicationID = @ApplicationID AND T.TreeID = N.TreeID
			WHERE N.ApplicationID = @ApplicationID AND 
				N.TreeNodeID = @TreeIDOrTreeNodeID AND T.IsPrivate = 1
		)
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[DCT_AddOwnerTree]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[DCT_AddOwnerTree]
GO

CREATE PROCEDURE [dbo].[DCT_AddOwnerTree]
	@ApplicationID	uniqueidentifier,
	@OwnerID		uniqueidentifier,
	@TreeID			uniqueidentifier,
	@CurrentUserID	uniqueidentifier,
	@Now			datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	IF EXISTS(
		SELECT TOP(1) * 
		FROM [dbo].[DCT_TreeOwners]
		WHERE ApplicationID = @ApplicationID AND
			OwnerID = @OwnerID AND TreeID = @TreeID
	) BEGIN
		UPDATE [dbo].[DCT_TreeOwners]
			SET Deleted = 0,
				LastModifierUserID = @CurrentUserID,
				LastModificationDate = @Now
		WHERE ApplicationID = @ApplicationID AND 
			OwnerID = @OwnerID AND TreeID = @TreeID
	END
	ELSE BEGIN
		INSERT INTO [dbo].[DCT_TreeOwners](
			ApplicationID,
			OwnerID,
			TreeID,
			UniqueID,
			CreatorUserID,
			CreationDate,
			Deleted
		)
		VALUES(
			@ApplicationID,
			@OwnerID,
			@TreeID,
			NEWID(),
			@CurrentUserID,
			@Now,
			0
		)
	END
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[DCT_ArithmeticDeleteOwnerTree]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[DCT_ArithmeticDeleteOwnerTree]
GO

CREATE PROCEDURE [dbo].[DCT_ArithmeticDeleteOwnerTree]
	@ApplicationID	uniqueidentifier,
	@OwnerID		uniqueidentifier,
	@TreeID			uniqueidentifier,
	@CurrentUserID	uniqueidentifier,
	@Now			datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[DCT_TreeOwners]
		SET Deleted = 1,
			LastModifierUserID = @CurrentUserID,
			LastModificationDate = @Now
	WHERE ApplicationID = @ApplicationID AND 
		OwnerID = @OwnerID AND TreeID = @TreeID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[DCT_GetTreeOwnerID]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[DCT_GetTreeOwnerID]
GO

CREATE PROCEDURE [dbo].[DCT_GetTreeOwnerID]
	@ApplicationID		uniqueidentifier,
	@TreeIDOrTreeNodeID	uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SET @TreeIDOrTreeNodeID = ISNULL((
		SELECT TOP(1) TreeID
		FROM [dbo].[DCT_TreeNodes]
		WHERE ApplicationID = @ApplicationID AND TreeNodeID = @TreeIDOrTreeNodeID
	), @TreeIDOrTreeNodeID)
	
	SELECT TOP(1) OwnerID AS ID
	FROM [dbo].[DCT_Trees]
	WHERE TreeID = @TreeIDOrTreeNodeID
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[DCT_GetOwnerTrees]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[DCT_GetOwnerTrees]
GO

CREATE PROCEDURE [dbo].[DCT_GetOwnerTrees]
	@ApplicationID	uniqueidentifier,
	@OwnerID		uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON

	DECLARE @TreeIDs GuidTableType
	
	INSERT INTO @TreeIDs
	SELECT TreeID
	FROM [dbo].[DCT_TreeOwners]
	WHERE ApplicationID = @ApplicationID AND OwnerID = @OwnerID AND Deleted = 0
	
	EXEC [dbo].[DCT_P_GetTreesByIDs] @ApplicationID, @TreeIDs
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[DCT_CloneTrees]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[DCT_CloneTrees]
GO

CREATE PROCEDURE [dbo].[DCT_CloneTrees]
	@ApplicationID	uniqueidentifier,
	@strTreeIDs		varchar(max),
	@delimiter		char,
	@OwnerID		uniqueidentifier,
	@AllowMultiple	bit,
	@CurrentUserID	uniqueidentifier,
	@Now			datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @TreeIDs TABLE (
		TreeID uniqueidentifier, 
		TreeID_New uniqueidentifier,
		AlreadyCreated bit,
		Seq int IDENTITY(1, 1)
	)

	INSERT INTO @TreeIDs (TreeID, TreeID_New, AlreadyCreated)
	SELECT	Ref.Value, 
			ISNULL(T.TreeID, NEWID()), 
			CASE WHEN T.TreeID IS NULL THEN 0 ELSE 1 END
	FROM [dbo].[GFN_StrToGuidTable](@strTreeIDs, @delimiter) AS Ref
		LEFT JOIN [dbo].[DCT_Trees] AS T
		ON T.ApplicationID = @ApplicationID AND T.OwnerID = @OwnerID AND 
			T.RefTreeID = Ref.Value AND ISNULL(@AllowMultiple, 0) = 0

	INSERT INTO [dbo].[DCT_Trees] (
		ApplicationID,
		TreeID,
		RefTreeID,
		IsPrivate,
		OwnerID,
		Name,
		CreatorUserID,
		CreationDate,
		Deleted
	)
	SELECT	T.ApplicationID, 
			ID.TreeID_New, 
			ID.TreeID, 
			CASE WHEN @OwnerID IS NULL THEN 0 ELSE 1 END, 
			@OwnerID, 
			T.Name, 
			@CurrentUserID, 
			@Now, 
			0
	FROM @TreeIDs AS ID
		INNER JOIN [dbo].[DCT_Trees] AS T
		ON T.ApplicationID = @ApplicationID AND T.TreeID = ID.TreeID
	WHERE ID.AlreadyCreated = 0

	DECLARE @TreeNodes TABLE (
		TreeID uniqueidentifier, 
		ID uniqueidentifier, 
		ParentID uniqueidentifier,
		TreeID_New uniqueidentifier, 
		ID_New uniqueidentifier, 
		ParentID_New uniqueidentifier
	)
		
	INSERT INTO @TreeNodes (TreeID, ID, ParentID, TreeID_New, ID_New)
	SELECT N.TreeID, N.TreeNodeID, N.ParentNodeID, ID.TreeID_New, NEWID()
	FROM @TreeIDs AS ID
		INNER JOIN [dbo].[DCT_TreeNodes] AS N
		ON N.ApplicationID = @ApplicationID AND 
			N.TreeID = ID.TreeID AND N.Deleted = 0
	WHERE ID.AlreadyCreated = 0

	UPDATE T
		SET ParentID_New = P.ID_New
	FROM @TreeNodes AS T
		INNER JOIN @TreeNodes AS P
		ON P.TreeID = T.TreeID AND P.ID = T.ParentID

	INSERT INTO [dbo].[DCT_TreeNodes] (
		ApplicationID,
		TreeNodeID,
		TreeID,
		Name,
		CreatorUserID,
		CreationDate,
		SequenceNumber,
		Deleted
	)
	SELECT @ApplicationID, T.ID_New, T.TreeID_New, 
		N.Name, @CurrentUserID, @Now, N.SequenceNumber, 0
	FROM @TreeNodes AS T
		INNER JOIN [dbo].[DCT_TreeNodes] AS N
		ON N.ApplicationID = @ApplicationID AND N.TreeNodeID = T.ID

	UPDATE N
		SET ParentNodeID = T.ParentID_New
	FROM @TreeNodes AS T
		INNER JOIN [dbo].[DCT_TreeNodes] AS N
		ON N.ApplicationID = @ApplicationID AND N.TreeNodeID = T.ID_New
	WHERE T.ParentID_New IS NOT NULL AND T.ID_New <> T.ParentID_New

	DECLARE @IDs GuidTableType
	
	INSERT INTO @IDs (Value)
	SELECT T.TreeID_New
	FROM @TreeIDs AS T

	EXEC [dbo].[DCT_P_GetTreesByIDs] @ApplicationID, @IDs
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[DCT_P_AddTreeNodeContents]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[DCT_P_AddTreeNodeContents]
GO

CREATE PROCEDURE [dbo].[DCT_P_AddTreeNodeContents]
	@ApplicationID	uniqueidentifier,
	@TreeNodeID		uniqueidentifier,
	@NodeIDsTemp	GuidTableType readonly,
	@RemoveFrom		uniqueidentifier,
	@CurrentUserID	uniqueidentifier,
	@Now			datetime,
	@_Result		int output
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @NodeIDs GuidTableType
	INSERT INTO @NodeIDs SELECT * FROM @NodeIDsTemp

	IF @RemoveFrom IS NOT NULL AND @RemoveFrom <> @TreeNodeID BEGIN
		UPDATE C
			SET Deleted = 1,
				LastModifierUserID = @CurrentUserID,
				LastModificationDate = @Now
		FROM @NodeIDs AS IDs
			INNER JOIN [dbo].[DCT_TreeNodeContents] AS C
			ON C.ApplicationID = @ApplicationID AND C.TreeNodeID = @RemoveFrom AND 
				C.NodeID = IDs.Value AND C.Deleted = 0
	END
	
	UPDATE C
		SET Deleted = 0,
			LastModifierUserID = @CurrentUserID,
			LastModificationDate = @Now
	FROM @NodeIDs AS IDs
		INNER JOIN [dbo].[DCT_TreeNodeContents] AS C
		ON C.ApplicationID = @ApplicationID AND 
			C.TreeNodeID = @TreeNodeID AND C.NodeID = IDs.Value
			
	INSERT INTO [dbo].[DCT_TreeNodeContents] (
		ApplicationID,
		TreeNodeID,
		NodeID,
		CreatorUserID,
		CreationDate,
		Deleted
	)
	SELECT @ApplicationID, @TreeNodeID, IDs.Value, @CurrentUserID, @Now, 0
	FROM @NodeIDs AS IDs
		LEFT JOIN [dbo].[DCT_TreeNodeContents] AS C
		ON C.ApplicationID = @ApplicationID AND 
			C.TreeNodeID = @TreeNodeID AND C.NodeID = IDs.Value
	WHERE C.TreeNodeID IS NULL
	
	SET @_Result = 1
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[DCT_AddTreeNodeContents]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[DCT_AddTreeNodeContents]
GO

CREATE PROCEDURE [dbo].[DCT_AddTreeNodeContents]
	@ApplicationID	uniqueidentifier,
	@TreeNodeID		uniqueidentifier,
	@strNodeIDs		varchar(max),
	@delimiter		char,
	@RemoveFrom		uniqueidentifier,
	@CurrentUserID	uniqueidentifier,
	@Now			datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON

	DECLARE @NodeIDs GuidTableType
	
	INSERT INTO @NodeIDs (Value)
	SELECT Ref.Value
	FROM [dbo].[GFN_StrToGuidTable](@strNodeIDs, @delimiter) AS Ref
	
	DECLARE @_Result int = 0
	
	EXEC [dbo].[DCT_P_AddTreeNodeContents] @ApplicationID, @TreeNodeID, @NodeIDs, 
		@RemoveFrom, @CurrentUserID, @Now, @_Result output
		
	SELECT @_Result
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[DCT_P_RemoveTreeNodeContents]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[DCT_P_RemoveTreeNodeContents]
GO

CREATE PROCEDURE [dbo].[DCT_P_RemoveTreeNodeContents]
	@ApplicationID	uniqueidentifier,
	@TreeNodeID		uniqueidentifier,
	@NodeIDsTemp	GuidTableType readonly,
	@CurrentUserID	uniqueidentifier,
	@Now			datetime,
	@_Result		int output
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @NodeIDs GuidTableType
	INSERT INTO @NodeIDs SELECT * FROM @NodeIDsTemp

	UPDATE C
		SET Deleted = 1,
			LastModifierUserID = @CurrentUserID,
			LastModificationDate = @Now
	FROM @NodeIDs AS IDs
		INNER JOIN [dbo].[DCT_TreeNodeContents] AS C
		ON C.ApplicationID = @ApplicationID AND 
			C.TreeNodeID = @TreeNodeID AND C.NodeID = IDs.Value
	
	SET @_Result = @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[DCT_RemoveTreeNodeContents]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[DCT_RemoveTreeNodeContents]
GO

CREATE PROCEDURE [dbo].[DCT_RemoveTreeNodeContents]
	@ApplicationID	uniqueidentifier,
	@TreeNodeID		uniqueidentifier,
	@strNodeIDs		varchar(max),
	@delimiter		char,
	@CurrentUserID	uniqueidentifier,
	@Now			datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON

	DECLARE @NodeIDs GuidTableType
	
	INSERT INTO @NodeIDs (Value)
	SELECT Ref.Value
	FROM [dbo].[GFN_StrToGuidTable](@strNodeIDs, @delimiter) AS Ref
	
	DECLARE @_Result int = 0
	
	EXEC [dbo].[DCT_P_RemoveTreeNodeContents] @ApplicationID, @TreeNodeID, 
		@NodeIDs, @CurrentUserID, @Now, @_Result output
	
	SELECT @_Result
END

GO

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_GetUsersCount]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_GetUsersCount]
GO

CREATE PROCEDURE [dbo].[USR_GetUsersCount]
	@ApplicationID				uniqueidentifier,
	@CreationDateLowerThreshold datetime,
	@CreationDateUpperThreshold datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON

	SELECT COUNT(Ref.UserID)
	FROM [dbo].[Users_Normal] AS Ref
	WHERE ApplicationID = @ApplicationID AND 
		(@CreationDateLowerThreshold IS NULL OR 
		Ref.CreationDate >= @CreationDateLowerThreshold) AND
		(@CreationDateUpperThreshold IS NULL OR 
		Ref.CreationDate <= @CreationDateUpperThreshold) AND Ref.IsApproved = 1
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_GetUserIDs]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_GetUserIDs]
GO

CREATE PROCEDURE [dbo].[USR_GetUserIDs]
	@ApplicationID	uniqueidentifier,
    @UserNamesTemp	StringTableType readonly
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @UserNames StringTableType
	INSERT INTO @UserNames SELECT * FROM @UserNamesTemp
	
	IF @ApplicationID IS NULL BEGIN
		SELECT UN.UserID AS ID
		FROM @UserNames AS Ref
			INNER JOIN [dbo].[USR_View_Users] AS UN
			ON UN.LoweredUserName = LOWER(Ref.Value)
	END
	ELSE BEGIN
		SELECT UN.UserID AS ID
		FROM @UserNames AS Ref
			INNER JOIN [dbo].[Users_Normal] AS UN
			ON UN.ApplicationID = @ApplicationID AND UN.LoweredUserName = LOWER(Ref.Value)
	END
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_P_GetUsersByIDs]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_P_GetUsersByIDs]
GO

CREATE PROCEDURE [dbo].[USR_P_GetUsersByIDs]
	@ApplicationID	uniqueidentifier,
    @UserIDsTemp	KeyLessGuidTableType readonly
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @UserIDs KeyLessGuidTableType
	INSERT INTO @UserIDs (Value) SELECT Value FROM @UserIDsTemp

	IF @ApplicationID IS NULL BEGIN
		SELECT	UN.[UserID], 
				UN.[UserName],
				UN.[FirstName], 
				UN.[LastName], 
				UN.[BirthDay],
				N'' AS AboutMe,
				N'' AS City,
				N'' AS Organization,
				N'' AS Department,
				N'' AS JobTitle,
				UN.[MainPhoneID],
				UN.[MainEmailID],
				UN.Settings,
				UN.TwoStepAuthentication,
				UN.[IsApproved], 
				UN.[IsLockedOut]
		FROM	@UserIDs AS Ref
				INNER JOIN [dbo].[USR_View_Users] AS UN
				ON UN.[UserID] = Ref.[Value]
	END
	ELSE BEGIN
		SELECT	UN.[UserID], 
				UN.[UserName],
				UN.[FirstName], 
				UN.[LastName], 
				UN.[BirthDay],
				UN.AboutMe,
				UN.City,
				UN.Organization,
				UN.Department,
				UN.JobTitle,
				UN.[MainPhoneID],
				UN.[MainEmailID],
				UN.Settings,
				UN.TwoStepAuthentication,
				UN.[IsApproved], 
				UN.[IsLockedOut]
		FROM	@UserIDs AS Ref
				INNER JOIN [dbo].[Users_Normal] AS UN
				ON UN.ApplicationID = @ApplicationID AND UN.[UserID] = Ref.[Value]
	END
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_GetUsersByIDs]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_GetUsersByIDs]
GO

CREATE PROCEDURE [dbo].[USR_GetUsersByIDs]
	@ApplicationID	uniqueidentifier,
	@strUserIDs 	varchar(max),
    @delimiter		char
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @UserIDs KeyLessGuidTableType
	
	INSERT INTO @UserIDs (Value)
	SELECT Ref.Value FROM GFN_StrToGuidTable(@strUserIDs, @delimiter) AS Ref
	
	EXEC [dbo].[USR_P_GetUsersByIDs] @ApplicationID, @UserIDs
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_GetUsersByUserName]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_GetUsersByUserName]
GO

CREATE PROCEDURE [dbo].[USR_GetUsersByUserName]
	@ApplicationID	uniqueidentifier,
    @UserNamesTemp	StringTableType readonly
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @UserNames StringTableType
	INSERT INTO @UserNames (Value)
	SELECT DISTINCT LOWER(T.Value)
	FROM @UserNamesTemp AS T
	
	DECLARE @UserIDs KeyLessGuidTableType
	
	INSERT INTO @UserIDs (Value)
	SELECT DISTINCT UN.UserID
	FROM @UserNames AS Ref
		INNER JOIN [dbo].[Users_Normal] AS UN
		ON UN.ApplicationID = @ApplicationID AND LOWER(UN.UserName) = Ref.Value
	
	EXEC [dbo].[USR_P_GetUsersByIDs] @ApplicationID, @UserIDs
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_GetUsers]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_GetUsers]
GO

CREATE PROCEDURE [dbo].[USR_GetUsers]
	@ApplicationID	uniqueidentifier,
    @SearchText 	nvarchar(1000),
    @LowerBoundary	bigint,
    @Count			int,
    @IsOnline		bit,
    @IsApproved		bit,
    @Now			datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SET @SearchText = [dbo].[GFN_VerifyString](@SearchText)
	
	IF @Count IS NULL SET @Count = 20
	IF @IsOnline IS NULL SET @IsOnline = 0
	
	DECLARE @OnlineTimeTreshold datetime = DATEADD(MINUTE, -1, @Now)
	
	DECLARE @UserIDs KeyLessGuidTableType
	
	DECLARE @TBL Table (UserID uniqueidentifier, TotalCount bigint, RowNumber int)
	DECLARE @TotalCount bigint = 0
	
	IF @SearchText IS NULL OR @SearchText = '' BEGIN
		INSERT INTO @TBL (UserID, TotalCount, RowNumber)
		SELECT TOP(@Count) U.UserID, (U.RowNumber + U.RevRowNumber - 1) AS TotalCount, U.RowNumber
		FROM (	
				SELECT	ROW_NUMBER() OVER (ORDER BY UN.CreationDate DESC, UN.UserID DESC) AS RowNumber,
						ROW_NUMBER() OVER (ORDER BY UN.CreationDate ASC, UN.UserID ASC) AS RevRowNumber,
						UN.UserID
				FROM [dbo].[Users_Normal] AS UN
				WHERE UN.ApplicationID = @ApplicationID AND 
					(@IsApproved IS NULL OR ISNULL(UN.IsApproved, 1) = @IsApproved) AND
					(@IsOnline = 0 OR UN.LastActivityDate >= @OnlineTimeTreshold)
			) AS U
		WHERE U.RowNumber >= ISNULL(@LowerBoundary, 0)
		ORDER BY U.RowNumber ASC
	END
	ELSE BEGIN
		INSERT INTO @TBL (UserID, TotalCount, RowNumber)
		SELECT TOP(@Count) U.UserID, (U.[No] + U.[RevNo] - 1) AS TotalCount, U.RowNumber
		FROM (	
				SELECT	
						ROW_NUMBER() OVER (ORDER BY SRCH.[Rank] DESC) AS RowNumber,
						ROW_NUMBER() OVER (ORDER BY SRCH.[Rank] DESC, UN.UserID DESC) AS [No],
						ROW_NUMBER() OVER (ORDER BY SRCH.[Rank] ASC, UN.UserID ASC) AS RevNo,
						UN.UserID
				FROM CONTAINSTABLE([dbo].[USR_View_Users] , 
						(FirstName, LastName, UserName), @SearchText) AS SRCH
					INNER JOIN [dbo].[Users_Normal] AS UN
					ON UN.UserID = SRCH.[Key]
				WHERE UN.ApplicationID = @ApplicationID AND 
					(@IsApproved IS NULL OR ISNULL(UN.IsApproved, 1) = @IsApproved) AND
					(@IsOnline = 0 OR UN.LastActivityDate >= @OnlineTimeTreshold)
			) AS U
		WHERE U.RowNumber >= ISNULL(@LowerBoundary, 0)
		ORDER BY U.RowNumber ASC
	END
	
	INSERT INTO @UserIDs (Value)
	SELECT T.UserID
	FROM @TBL AS T
	ORDER BY T.RowNumber ASC
	
	EXEC [dbo].[USR_P_GetUsersByIDs] @ApplicationID, @UserIDs
	
	SELECT TOP(1) T.TotalCount AS TotalCount
	FROM @TBL AS T
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_GetApplicationUsersPartitioned]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_GetApplicationUsersPartitioned]
GO

CREATE PROCEDURE [dbo].[USR_GetApplicationUsersPartitioned]
	@strApplicationIDs	varchar(max),
	@delimiter			char,
	@Count				int
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @ApplicationIDs GuidTableType
	
	INSERT INTO @ApplicationIDs (Value)
	SELECT DISTINCT Ref.Value
	FROM [dbo].[GFN_StrToGuidTable](@strApplicationIDs, @delimiter) AS Ref
	
	SELECT	X.ApplicationId AS ApplicationID,
			X.UserID,
			X.UserName,
			X.FirstName,
			X.LastName,
			(X.RowNumber + X.RevRowNumber - 1) AS TotalCount
	FROM (
			SELECT	ROW_NUMBER() OVER(PARTITION BY Ref.ApplicationID ORDER BY Ref.RandomID ASC) AS RowNumber,
					ROW_NUMBER() OVER(PARTITION BY Ref.ApplicationID ORDER BY Ref.RandomID DESC) AS RevRowNumber,
					Ref.*
			FROM (
					SELECT	App.ApplicationId,
							USR.*,
							NEWID() AS RandomID
					FROM @ApplicationIDs AS IDs
						INNER JOIN [dbo].[aspnet_Applications] AS App
						ON App.ApplicationId = IDs.Value
						INNER JOIN [dbo].[USR_UserApplications] AS UA
						ON UA.ApplicationID = App.ApplicationId
						INNER JOIN [dbo].[USR_View_Users] AS USR
						ON USR.UserID = UA.UserID AND USR.IsApproved = 1
				) AS Ref
		) AS X
	WHERE X.RowNumber <= @Count
	ORDER BY X.ApplicationId ASC, X.RowNumber ASC
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_AdvancedUserSearch]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_AdvancedUserSearch]
GO

CREATE PROCEDURE [dbo].[USR_AdvancedUserSearch]
	@ApplicationID	uniqueidentifier,
	@RawSearchText	nvarchar(1000),
	@SearchText 	nvarchar(1000),
	@strNodeTypeIDs varchar(max),
	@strNodeIDs		varchar(max),
	@delimiter		char,
	@Members		bit,
	@Experts		bit,
	@Contributors	bit,
	@PropertyOwners	bit,
	@Resume			bit,
    @LowerBoundary	bigint,
    @Count			int
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SET @SearchText = [dbo].[GFN_VerifyString](@SearchText)
	
	DECLARE @NodeIDs GuidTableType
	DECLARE @NodeTypeIDs GuidTableType
	
	INSERT INTO @NodeIDs (Value)
	SELECT DISTINCT Ref.Value
	FROM [dbo].[GFN_StrToGuidTable](@strNodeIDs, @delimiter) AS Ref
	
	DECLARE @NCount int = (SELECT COUNT(*) FROM @NodeIDs)
	
	IF @NCount = 0 BEGIN
		INSERT INTO @NodeTypeIDs (Value)
		SELECT DISTINCT Ref.Value
		FROM [dbo].[GFN_StrToGuidTable](@strNodeTypeIDs, @delimiter) AS Ref
	END
	ELSE SET @SearchText = NULL
	
	DECLARE @NTCount int = (SELECT COUNT(*) FROM @NodeTypeIDs)

	DECLARE @Nodes TABLE (NodeID uniqueidentifier, [Rank] float)
	
	DECLARE @Users TABLE (
		UserID uniqueidentifier, 
		[Rank] float,
		IsMemberCount int,
		IsExpertCount int,
		IsContributorCount int,
		HasPropertyCount int,
		[Resume] int
	)
	
	IF @NCount > 0 BEGIN
		INSERT INTO @Nodes (NodeID, [Rank])
		SELECT Ref.Value, 1
		FROM @NodeIDs AS Ref
	END
	ELSE BEGIN
		INSERT INTO @Nodes (NodeID, [Rank])
		SELECT	ND.NodeID,
				ROW_NUMBER() OVER (ORDER BY SRCH.[Rank] ASC, ND.NodeID ASC)
		FROM CONTAINSTABLE([dbo].[CN_Nodes], ([Name]), @SearchText) AS SRCH
			INNER JOIN [dbo].[CN_Nodes] AS ND
			ON ND.ApplicationID = @ApplicationID AND ND.NodeID = SRCH.[Key] AND
				ND.Deleted = 0 AND ISNULL(ND.Searchable, 0) = 1 AND 
				(@NTCount = 0 OR ND.NodeTypeID IN (SELECT Value FROM @NodeTypeIDs))
	END
	
	DECLARE @SearchedUserIDs TABLE (UserID uniqueidentifier, [Rank] float)
	DECLARE @SearchedResume TABLE (UserID uniqueidentifier, ResumeRank int)
	
	IF @NCount = 0 AND ISNULL(@SearchText, N'') <> N'' BEGIN
		INSERT INTO @SearchedUserIDs (UserID, [Rank])
		SELECT	UN.UserID,
				(ROW_NUMBER() OVER (ORDER BY SRCH.[Rank] ASC, UN.UserID ASC)) AS [Rank]
		FROM CONTAINSTABLE([dbo].[USR_View_Users] , 
				(FirstName, LastName, UserName), @SearchText) AS SRCH
			INNER JOIN [dbo].[Users_Normal] AS UN
			ON UN.ApplicationID = @ApplicationID AND UN.UserID = SRCH.[Key]
			
			
		INSERT INTO @SearchedResume (UserID, ResumeRank)
		SELECT X.UserID, SUM(X.[Rank])
		FROM (
				SELECT	EA.UserID,
						CAST(1 AS int) AS [Rank]
				FROM [dbo].[USR_EmailAddresses] AS EA
					INNER JOIN [dbo].[Users_Normal] AS UN
					ON UN.ApplicationID = @ApplicationID AND UN.UserID = EA.UserID
				WHERE LOWER(EA.EmailAddress) LIKE (N'%' + LOWER(@RawSearchText) + '%') AND EA.Deleted = 0
					
				UNION ALL
				
				SELECT	PN.UserID,
						CAST(1 AS int) AS [Rank]
				FROM [dbo].[USR_PhoneNumbers] AS PN
					INNER JOIN [dbo].[Users_Normal] AS UN
					ON UN.ApplicationID = @ApplicationID AND UN.UserID = PN.UserID
				WHERE PN.PhoneNumber LIKE (N'%' + LOWER(@RawSearchText) + '%') AND PN.Deleted = 0
		
				UNION ALL
		
				SELECT	E.UserID,
						CAST(1 AS int) AS [Rank]
				FROM CONTAINSTABLE([dbo].[USR_EducationalExperiences], 
						(School, StudyField), @SearchText) AS SRCH
					INNER JOIN [dbo].[USR_EducationalExperiences] AS E
					ON E.ApplicationID = @ApplicationID AND E.EducationID = SRCH.[Key]
					
				UNION ALL
				
				SELECT	H.UserID,
						CAST(1 AS int) AS [Rank]
				FROM CONTAINSTABLE([dbo].[USR_HonorsAndAwards], 
						(Title, Issuer, Occupation, [Description]), @SearchText) AS SRCH
					INNER JOIN [dbo].[USR_HonorsAndAwards] AS H
					ON H.ApplicationID = @ApplicationID AND H.ID = SRCH.[Key]
				
				UNION ALL
				
				SELECT	J.UserID,
						CAST(1 AS int) AS [Rank]
				FROM CONTAINSTABLE([dbo].[USR_JobExperiences], 
						(Title, Employer), @SearchText) AS SRCH
					INNER JOIN [dbo].[USR_JobExperiences] AS J
					ON J.ApplicationID = @ApplicationID AND J.JobID = SRCH.[Key]
					
				UNION ALL
				
				SELECT	U.UserID,
						CAST(1 AS int) AS [Rank]
				FROM CONTAINSTABLE([dbo].[USR_LanguageNames], 
						(LanguageName), @SearchText) AS SRCH
					INNER JOIN [dbo].[USR_LanguageNames] AS L
					ON L.ApplicationID = @ApplicationID AND L.LanguageID = SRCH.[Key]
					INNER JOIN [dbo].[USR_UserLanguages] AS U
					ON U.ApplicationID = @ApplicationID AND U.LanguageID = L.LanguageID
			) AS X
		GROUP BY X.UserID
	END

	INSERT INTO @Users (
		UserID, 
		[Rank], 
		IsMemberCount, 
		IsExpertCount, 
		IsContributorCount,
		HasPropertyCount,
		[Resume]
	)
	SELECT	Users.UserID,
			(SUM(Users.[Rank]) + SUM(Users.IsMember) + 
			SUM(Users.IsExpert) + SUM(Users.IsContributor) + 
			SUM(Users.HasProperty) + SUM(Users.[Resume])) AS [Rank],
			SUM(Users.IsMember) AS IsMemberCount,
			SUM(Users.IsExpert) AS IsExpertCount,
			SUM(Users.IsContributor) AS IsContributosCount,
			SUM(Users.HasProperty) AS HasPropertyCount,
			SUM(Users.[Resume]) AS [Resume]
	FROM (
			SELECT	U.UserID,
					2 * U.[Rank] AS [Rank],
					CAST(0 AS int) AS IsMember,
					CAST(0 AS int) AS IsExpert,
					CAST(0 AS int) AS IsContributor,
					CAST(0 AS int) AS HasProperty,
					CAST(0 AS int) AS [Resume]
			FROM @SearchedUserIDs AS U
			
			UNION ALL
			
			SELECT	M.UserID,
					Nodes.[Rank],
					CAST(1 AS int) AS IsMember,
					CAST(0 AS int) AS IsExpert,
					CAST(0 AS int) AS IsContributor,
					CAST(0 AS int) AS HasProperty,
					CAST(0 AS int) AS [Resume]
			FROM @Nodes AS Nodes 
				INNER JOIN [dbo].[CN_View_NodeMembers] AS M
				ON M.ApplicationID = @ApplicationID AND 
					M.NodeID = Nodes.NodeID AND M.IsPending = 0
			WHERE @Members = 1
			
			UNION ALL
			
			SELECT	E.UserID,
					Nodes.[Rank],
					CAST(0 AS int) AS IsMember,
					CAST(1 AS int) AS IsExpert,
					CAST(0 AS int) AS IsContributor,
					CAST(0 AS int) AS HasProperty,
					CAST(0 AS int) AS [Resume]
			FROM @Nodes AS Nodes 
				INNER JOIN [dbo].[CN_View_Experts] AS E
				ON E.ApplicationID = @ApplicationID AND E.NodeID = Nodes.NodeID
			WHERE @Experts = 1
				
			UNION ALL
			
			SELECT	C.UserID,
					Nodes.[Rank],
					CAST(0 AS int) AS IsMember,
					CAST(0 AS int) AS IsExpert,
					CAST(1 AS int) AS IsContributor,
					CAST(0 AS int) AS HasProperty,
					CAST(0 AS int) AS [Resume]
			FROM @Nodes AS Nodes 
				INNER JOIN [dbo].[CN_NodeCreators] AS C
				ON C.ApplicationID = @ApplicationID AND 
					C.NodeID = Nodes.NodeID AND C.Deleted = 0
			WHERE @Contributors = 1
				
			UNION ALL
			
			SELECT	C.UserID,
					Nodes.SeqNo AS [Rank],
					CAST(0 AS int) AS IsMember,
					CAST(0 AS int) AS IsExpert,
					CAST(0 AS int) AS IsContributor,
					CAST(1 AS int) AS HasProperty,
					CAST(0 AS int) AS [Resume]
			FROM (
					SELECT N.NodeID, MAX(N.[Rank]) AS SeqNo
					FROM (
							SELECT I.RelatedNodeID AS NodeID, Nodes.[Rank]
							FROM @Nodes AS Nodes 
								INNER JOIN [dbo].[CN_View_InRelatedNodes] AS I
								ON I.ApplicationID = @ApplicationID AND 
									I.NodeID = Nodes.NodeID
								
							UNION ALL
							
							SELECT O.RelatedNodeID AS NodeID, Nodes.[Rank]
							FROM @Nodes AS Nodes 
								INNER JOIN [dbo].[CN_View_OutRelatedNodes] AS O
								ON O.ApplicationID = @ApplicationID AND 
									O.NodeID = Nodes.NodeID
						) AS N
					GROUP BY N.NodeID
				) AS Nodes
				INNER JOIN [dbo].[CN_NodeCreators] AS C
				ON C.ApplicationID = @ApplicationID AND 
					C.NodeID = Nodes.NodeID AND C.Deleted = 0
			WHERE @PropertyOwners = 1
			
			UNION ALL
			
			SELECT	R.UserID,
					1 AS [Rank],
					CAST(0 AS int) AS IsMember,
					CAST(0 AS int) AS IsExpert,
					CAST(0 AS int) AS IsContributor,
					CAST(0 AS int) AS HasProperty,
					R.ResumeRank AS [Resume]
			FROM @SearchedResume AS R
			WHERE @Resume = 1
		) AS Users
	GROUP BY Users.UserID

	SELECT TOP(ISNULL(@Count, 20)) 
		X.UserID, 
		(X.RowNumber + X.RevRowNumber - 1) AS TotalCount,
		X.[Rank],
		X.IsMemberCount,
		X.IsExpertCount,
		X.IsContributorCount,
		X.HasPropertyCount,
		X.[Resume]
	FROM (
			SELECT	ROW_NUMBER() OVER (ORDER BY U.[Rank] DESC, U.UserID ASC) AS RowNumber,
					ROW_NUMBER() OVER (ORDER BY U.[Rank] ASC, U.UserID DESC) AS RevRowNumber,
					U.*
			FROM @Users AS U
				INNER JOIN [dbo].[Users_Normal] AS UN
				ON UN.ApplicationID = @ApplicationID AND 
					UN.UserID = U.UserID AND UN.IsApproved = 1
		) AS X
	WHERE X.RowNumber >= ISNULL(@LowerBoundary, 0)
	ORDER BY X.RowNumber ASC
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_AdvancedUserSearchMeta]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_AdvancedUserSearchMeta]
GO

CREATE PROCEDURE [dbo].[USR_AdvancedUserSearchMeta]
	@ApplicationID	uniqueidentifier,
	@UserID			uniqueidentifier,
	@SearchText 	nvarchar(1000),
	@strNodeTypeIDs varchar(max),
	@strNodeIDs		varchar(max),
	@delimiter		char,
	@Members		bit,
	@Experts		bit,
	@Contributors	bit,
	@PropertyOwners	bit
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SET @SearchText = [dbo].[GFN_VerifyString](@SearchText)
	
	DECLARE @NodeIDs GuidTableType
	DECLARE @NodeTypeIDs GuidTableType
	
	INSERT INTO @NodeIDs (Value)
	SELECT DISTINCT Ref.Value
	FROM [dbo].[GFN_StrToGuidTable](@strNodeIDs, @delimiter) AS Ref
	
	DECLARE @NCount int = (SELECT COUNT(*) FROM @NodeIDs)
	
	IF @NCount = 0 BEGIN
		INSERT INTO @NodeTypeIDs (Value)
		SELECT DISTINCT Ref.Value
		FROM [dbo].[GFN_StrToGuidTable](@strNodeTypeIDs, @delimiter) AS Ref
	END
	ELSE SET @SearchText = NULL
	
	DECLARE @NTCount int = (SELECT COUNT(*) FROM @NodeTypeIDs)

	DECLARE @Nodes TABLE (NodeID uniqueidentifier, [Rank] float)

	IF @NCount > 0 BEGIN
		INSERT INTO @Nodes (NodeID, [Rank])
		SELECT Ref.Value, 1
		FROM @NodeIDs AS Ref
	END
	ELSE BEGIN
		INSERT INTO @Nodes (NodeID, [Rank])
		SELECT	ND.NodeID,
				ROW_NUMBER() OVER (ORDER BY SRCH.[Rank] ASC, ND.NodeID ASC)
		FROM CONTAINSTABLE([dbo].[CN_Nodes], ([Name]), @SearchText) AS SRCH
			INNER JOIN [dbo].[CN_Nodes] AS ND
			ON ND.ApplicationID = @ApplicationID AND ND.NodeID = SRCH.[Key] AND
				ND.Deleted = 0 AND ISNULL(ND.Searchable, 0) = 1 AND 
				(@NTCount = 0 OR ND.NodeTypeID IN (SELECT Value FROM @NodeTypeIDs))
	END

	SELECT	Nodes.NodeID,
			SUM(Nodes.[Rank]) AS [Rank],
			CAST(MAX(Nodes.IsMember) AS bit) AS IsMember,
			CAST(MAX(Nodes.IsExpert) AS bit) AS IsExpert,
			CAST(MAX(Nodes.IsContributor) AS bit) AS IsContributor,
			CAST(MAX(Nodes.HasProperty) AS bit) AS HasProperty
	FROM (	
			SELECT	M.NodeID,
					Nodes.[Rank],
					CAST(1 AS int) AS IsMember,
					CAST(0 AS int) AS IsExpert,
					CAST(0 AS int) AS IsContributor,
					CAST(0 AS int) AS HasProperty
			FROM @Nodes AS Nodes 
				INNER JOIN [dbo].[CN_View_NodeMembers] AS M
				ON M.ApplicationID = @ApplicationID AND 
					M.NodeID = Nodes.NodeID AND M.IsPending = 0
			WHERE @Members = 1 AND M.UserID = @UserID
			
			UNION ALL
			
			SELECT	E.NodeID,
					Nodes.[Rank],
					CAST(0 AS int) AS IsMember,
					CAST(1 AS int) AS IsExpert,
					CAST(0 AS int) AS IsContributor,
					CAST(0 AS int) AS HasProperty
			FROM @Nodes AS Nodes 
				INNER JOIN [dbo].[CN_View_Experts] AS E
				ON E.ApplicationID = @ApplicationID AND E.NodeID = Nodes.NodeID
			WHERE @Experts = 1 AND E.UserID = @UserID
				
			UNION ALL
			
			SELECT	C.NodeID,
					Nodes.[Rank],
					CAST(0 AS int) AS IsMember,
					CAST(0 AS int) AS IsExpert,
					CAST(1 AS int) AS IsContributor,
					CAST(0 AS int) AS HasProperty
			FROM @Nodes AS Nodes 
				INNER JOIN [dbo].[CN_NodeCreators] AS C
				ON C.ApplicationID = @ApplicationID AND 
					C.NodeID = Nodes.NodeID AND C.Deleted = 0
			WHERE @Contributors = 1 AND C.UserID = @UserID
				
			UNION ALL
			
			SELECT	Nodes.BaseNodeID AS NodeID,
					MAX(Nodes.SeqNo) AS [Rank],
					CAST(0 AS int) AS IsMember,
					CAST(0 AS int) AS IsExpert,
					CAST(0 AS int) AS IsContributor,
					CAST(1 AS int) AS HasProperty
			FROM (
					SELECT	N.NodeID, 
							CAST(MAX(CAST(N.BaseNodeID AS varchar(50))) AS uniqueidentifier) AS BaseNodeID, 
							MAX(N.[Rank]) AS SeqNo
					FROM (
							SELECT	I.NodeID AS BaseNodeID, 
									I.RelatedNodeID AS NodeID, 
									Nodes.[Rank]
							FROM @Nodes AS Nodes 
								INNER JOIN [dbo].[CN_View_InRelatedNodes] AS I
								ON I.ApplicationID = @ApplicationID AND 
									I.NodeID = Nodes.NodeID
								
							UNION ALL
							
							SELECT	O.NodeID AS BaseNodeID,
									O.RelatedNodeID AS NodeID, 
									Nodes.[Rank]
							FROM @Nodes AS Nodes 
								INNER JOIN [dbo].[CN_View_OutRelatedNodes] AS O
								ON O.ApplicationID = @ApplicationID AND 
									O.NodeID = Nodes.NodeID
						) AS N
					GROUP BY N.NodeID
				) AS Nodes
				INNER JOIN [dbo].[CN_NodeCreators] AS C
				ON C.ApplicationID = @ApplicationID AND 
					C.NodeID = Nodes.NodeID AND C.Deleted = 0
			WHERE @PropertyOwners = 1 AND C.UserID = @UserID
			GROUP BY Nodes.BaseNodeID
		) AS Nodes
	GROUP BY Nodes.NodeID
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_P_CreateSystemUser]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_P_CreateSystemUser]
GO

CREATE PROCEDURE [dbo].[USR_P_CreateSystemUser]
	@ApplicationID	uniqueidentifier,
	@UserID			uniqueidentifier,
	@_Result		int output
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	IF NOT EXISTS(
		SELECT TOP(1) * 
		FROM [dbo].[Users_Normal]
		WHERE (@ApplicationID IS NULL OR ApplicationId = @ApplicationID) AND LoweredUserName = N'system'
	) BEGIN
		INSERT INTO [dbo].[aspnet_Users] ([UserId], [UserName], 
			[LoweredUserName], [MobileAlias], [IsAnonymous], [LastActivityDate]) 
		VALUES (@UserID, N'system', N'system', NULL, 0, CAST(0x0000A1A900C898BC AS DateTime))
		
		INSERT INTO [dbo].[USR_Profile] ( 
			[UserId], 
			[FirstName],
			[Lastname], 
			[BirthDay]
		) 
		VALUES (@UserID, N'', N'', NULL)
			
		INSERT INTO [dbo].[aspnet_Membership] ([UserId], [Password], 
			[PasswordFormat], [PasswordSalt], [MobilePIN], [Email], [LoweredEmail], 
			[PasswordQuestion], [PasswordAnswer], [IsApproved], [IsLockedOut], [CreateDate], 
			[LastLoginDate], [LastPasswordChangedDate], [LastLockoutDate], 
			[FailedPasswordAttemptCount], [FailedPasswordAttemptWindowStart], 
			[FailedPasswordAnswerAttemptCount], [FailedPasswordAnswerAttemptWindowStart], 
			[Comment]) 
		VALUES (@UserID, N'saS+wizpq8cetvwnCAdCAHek3Ls=', 1, N'0QnG9cGvuzB99qo+ycdaow==', NULL, NULL, NULL, NULL, 
			NULL, 1, 0, CAST(0x0000A1A900C898BC AS DateTime), CAST(0x0000A1A900C898BC AS DateTime), 
			CAST(0x0000A1A900C898BC AS DateTime), CAST(0xFFFF2FB300000000 AS DateTime), 0, 
			CAST(0xFFFF2FB300000000 AS DateTime), 0, CAST(0xFFFF2FB300000000 AS DateTime), NULL)
			
		IF @ApplicationID IS NOT NULL BEGIN
			INSERT INTO [dbo].[USR_UserApplications] (ApplicationID, UserID)
			VALUES (@ApplicationID, @UserID)
		END
	END
	
	SET @_Result = 1
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_GetSystemUser]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_GetSystemUser]
GO

CREATE PROCEDURE [dbo].[USR_GetSystemUser]
	@ApplicationID	uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @UserIDs KeyLessGuidTableType
	
	IF NOT EXISTS(
		SELECT TOP(1) * 
		FROM [dbo].[Users_Normal]
		WHERE (@ApplicationID IS NULL OR ApplicationId = @ApplicationID) AND LoweredUserName = N'system'
	) BEGIN
		DECLARE @UserID uniqueidentifier = NEWID()
		DECLARE @_Result int
		
		INSERT INTO @UserIDs (Value) 
		VALUES (@UserID)
		
		EXEC [dbo].[USR_P_CreateSystemUser] @ApplicationID, @UserID, @_Result output
	END
	ELSE BEGIN
		IF @ApplicationID IS NULL BEGIN
			INSERT INTO @UserIDs (Value)
			SELECT UserId
			FROM [dbo].[USR_View_Users]
			WHERE LoweredUserName = N'system'
		END
		ELSE BEGIN
			INSERT INTO @UserIDs (Value)
			SELECT UserId
			FROM [dbo].[Users_Normal]
			WHERE ApplicationID = @ApplicationID AND LoweredUserName = N'system'
		END
	END
	
	EXEC [dbo].[USR_P_GetUsersByIDs] @ApplicationID, @UserIDs
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_CreateAdminUser]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_CreateAdminUser]
GO

CREATE PROCEDURE [dbo].[USR_CreateAdminUser]
	@ApplicationID	uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	IF NOT EXISTS(
		SELECT TOP(1) * 
		FROM [dbo].[Users_Normal]
		WHERE ApplicationId = @ApplicationID AND LoweredUserName = N'admin'
	) BEGIN
		DECLARE @AdminRoleID uniqueidentifier = (
			SELECT TOP(1) RoleID
			FROM [dbo].[aspnet_Roles]
			WHERE ApplicationID = @ApplicationID AND LoweredRoleName = N'admins'
		)
	
		IF @AdminRoleID IS NULL BEGIN
			SET @AdminRoleID = NEWID()
		
			INSERT INTO [dbo].[aspnet_Roles] (
				ApplicationID,
				RoleID,
				RoleName,
				LoweredRoleName
			)
			VALUES (
				@ApplicationID,
				@AdminRoleID,
				N'Admins',
				N'admins'
			)
		END
	
		DECLARE @UserID uniqueidentifier = NEWID()
	
		INSERT INTO [dbo].[aspnet_Users] ([UserId], [UserName], 
			[LoweredUserName], [MobileAlias], [IsAnonymous], [LastActivityDate]) 
		VALUES (@UserID, N'admin', N'admin', NULL, 0, CAST(0x0000A1A900C898BC AS DateTime))
			
		INSERT INTO [dbo].[aspnet_UsersInRoles] (UserID, RoleID)
		VALUES (@UserID, @AdminRoleID)
		
		INSERT INTO [dbo].[USR_Profile] (
			[UserId], 
			[FirstName],
			[Lastname], 
			[BirthDay]
		) 
		VALUES (@UserID, N'', N'', NULL)
			
		INSERT INTO [dbo].[aspnet_Membership] ([UserId], [Password], 
			[PasswordFormat], [PasswordSalt], [MobilePIN], [Email], [LoweredEmail], 
			[PasswordQuestion], [PasswordAnswer], [IsApproved], [IsLockedOut], [CreateDate], 
			[LastLoginDate], [LastPasswordChangedDate], [LastLockoutDate], 
			[FailedPasswordAttemptCount], [FailedPasswordAttemptWindowStart], 
			[FailedPasswordAnswerAttemptCount], [FailedPasswordAnswerAttemptWindowStart], 
			[Comment]) 
		VALUES (@UserID, N'hzpljiwy35CCLSmxIuTk49mhDI4=', 1, N'6rG7hIBmkJ6cfestS4Ycow==', NULL, NULL, NULL, NULL, 
			NULL, 1, 0, CAST(0x0000A1A900C898BC AS DateTime), CAST(0x0000A1A900C898BC AS DateTime), 
			CAST(0x0000A1A900C898BC AS DateTime), CAST(0xFFFF2FB300000000 AS DateTime), 0, 
			CAST(0xFFFF2FB300000000 AS DateTime), 0, CAST(0xFFFF2FB300000000 AS DateTime), NULL)
			
		INSERT INTO [dbo].[USR_UserApplications] (ApplicationID, UserID)
		VALUES (@ApplicationID, @UserID)
	END
	
	SELECT 1
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_GetNotExistingUsers]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_GetNotExistingUsers]
GO

CREATE PROCEDURE [dbo].[USR_GetNotExistingUsers]
	@ApplicationID	uniqueidentifier,
    @UserNamesTemp	StringTableType readonly
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @UserNames StringTableType
	INSERT INTO @UserNames SELECT * FROM @UserNamesTemp
	
	SELECT DISTINCT Ref.Value AS Value
	FROM @UserNames AS Ref
	WHERE NOT EXISTS(
			SELECT TOP(1) * 
			FROM [dbo].[Users_Normal]
			WHERE ApplicationID = @ApplicationID AND 
				UserName = Ref.Value OR LoweredUserName = LOWER(Ref.Value)
		)
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_RegisterItemVisit]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_RegisterItemVisit]
GO

CREATE PROCEDURE [dbo].[USR_RegisterItemVisit]
	@ApplicationID	uniqueidentifier,
    @ItemID			uniqueidentifier,
    @UserID			uniqueidentifier,
    @VisitDate		datetime,
    @ItemType		varchar(20)
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	INSERT INTO [dbo].[USR_ItemVisits](
		ApplicationID,
		ItemID,
		VisitDate,
		UserID,
		ItemType,
		UniqueID
	)
	VALUES(
		@ApplicationID,
		@ItemID,
		@VisitDate,
		@UserID,
		@ItemType,
		NEWID()
	)
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_GetItemsVisitsCount]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_GetItemsVisitsCount]
GO

CREATE PROCEDURE [dbo].[USR_GetItemsVisitsCount]
	@ApplicationID	uniqueidentifier,
    @strItemIDs		uniqueidentifier,
    @delimiter		char,
    @lowerDateLimit	datetime,
    @upperDateLimit	datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @ItemIDs GuidTableType
	INSERT INTO @ItemIDs
	SELECT DISTINCT Ref.Value FROM GFN_StrToGuidTable(@strItemIDs, @delimiter) AS Ref
	
	SELECT ExternalIDs.Value AS ItemID,
		   (
				SELECT COUNT(*) 
				FROM [dbo].[USR_ItemVisits]
				WHERE ApplicationID = @ApplicationID AND ItemID = ExternalIDs.Value AND
					(@lowerDateLimit IS NULL OR VisitDate >= @lowerDateLimit) AND
					(@upperDateLimit IS NULL OR VisitDate <= @upperDateLimit)
			) AS VisitsCount
	FROM @ItemIDs AS ExternalIDs
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_SendFriendshipRequest]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_SendFriendshipRequest]
GO

CREATE PROCEDURE [dbo].[USR_SendFriendshipRequest]
	@ApplicationID	uniqueidentifier,
    @UserID			uniqueidentifier,
    @ReceiverUserID	uniqueidentifier,
    @RequestDate	datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	IF NOT EXISTS(
		SELECT TOP(1) * 
		FROM [dbo].[USR_Friends]
		WHERE ApplicationID = @ApplicationID AND 
			((SenderUserID = @UserID AND ReceiverUserID = @ReceiverUserID) OR
			(SenderUserID = @ReceiverUserID AND ReceiverUserID = @UserID))
	) BEGIN
		INSERT INTO [dbo].[USR_Friends](
			ApplicationID,
			SenderUserID,
			ReceiverUserID,
			RequestDate,
			AreFriends,
			Deleted,
			UniqueID
		)
		VALUES(
			@ApplicationID,
			@UserID,
			@ReceiverUserID,
			@RequestDate,
			0,
			0,
			NEWID()
		)
	END
	ELSE BEGIN
		UPDATE [dbo].[USR_Friends]
			SET SenderUserID = @UserID,
				ReceiverUserID = @ReceiverUserID,
				RequestDate = @RequestDate,
				AcceptionDate = NULL,
				AreFriends = 0,
				Deleted = 0
		WHERE ApplicationID = @ApplicationID AND
			(SenderUserID = @UserID AND ReceiverUserID = @ReceiverUserID) OR
			(SenderUserID = @ReceiverUserID AND ReceiverUserID = @UserID)
	END
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_AcceptFriendship]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_AcceptFriendship]
GO

CREATE PROCEDURE [dbo].[USR_AcceptFriendship]
	@ApplicationID	uniqueidentifier,
    @UserID			uniqueidentifier,
    @SenderUserID	uniqueidentifier,
    @AcceptionDate	datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[USR_Friends]
		SET AreFriends = 1,
			AcceptionDate = @AcceptionDate
	WHERE ApplicationID = @ApplicationID AND 
		SenderUserID = @SenderUserID AND ReceiverUserID = @UserID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_RejectFriendship]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_RejectFriendship]
GO

CREATE PROCEDURE [dbo].[USR_RejectFriendship]
	@ApplicationID	uniqueidentifier,
    @UserID			uniqueidentifier,
    @FriendUserID	uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[USR_Friends]
		SET AreFriends = 0,
			Deleted = 1
	WHERE ApplicationID = @ApplicationID AND 
		(SenderUserID = @UserID AND ReceiverUserID = @FriendUserID) OR
		(SenderUserID = @FriendUserID AND ReceiverUserID = @UserID)
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_GetFriendshipStatus]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_GetFriendshipStatus]
GO

CREATE PROCEDURE [dbo].[USR_GetFriendshipStatus]
	@ApplicationID		uniqueidentifier,
    @UserID				uniqueidentifier,
    @strOtherUserIDs	varchar(max),
    @delimiter			char,
    @MutualsCount		bit
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @OtherUserIDs GuidTableType
	INSERT INTO @OtherUserIDs
	SELECT Ref.Value
	FROM [dbo].[GFN_StrToGuidTable](@strOtherUserIDs, @delimiter) AS Ref
	
	DECLARE @RetTbl TABLE (
		UserID				uniqueidentifier,
		IsFriend			bit,
		IsSender			bit,
		MutualFriendsCount	int
	)
	
	INSERT INTO @RetTbl (UserID, IsFriend, IsSender)
	SELECT	O.Value AS UserID,
			ISNULL(F.AreFriends, 0) AS IsFriend,
			ISNULL(F.IsSender, 0) AS IsSender
	FROM @OtherUserIDs AS O
		INNER JOIN [dbo].[USR_View_Friends] AS F
		ON F.UserID = @UserID AND F.FriendID = O.Value
	WHERE F.ApplicationID = @ApplicationID
		
	IF @MutualsCount = 1 BEGIN
		UPDATE Ref
			SET MutualFriendsCount = M.MutualFriendsCount
		FROM @RetTbl AS Ref
			LEFT JOIN [dbo].[USR_FN_GetMutualFriendsCount](@ApplicationID, @UserID, @OtherUserIDs) AS M
			ON Ref.UserID = M.UserID
	END
	
	SELECT *
	FROM @RetTbl
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_P_UpdateFriendSuggestions]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_P_UpdateFriendSuggestions]
GO

CREATE PROCEDURE [dbo].[USR_P_UpdateFriendSuggestions]
	@ApplicationID	uniqueidentifier,
    @UserIDsTemp	GuidTableType readonly,
    @_Result		int output
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @UserIDs GuidTableType
	INSERT INTO @UserIDs SELECT * FROM @UserIDsTemp
	
	DECLARE @Suggestions TABLE (
		UserID UNIQUEIDENTIFIER, 
		OtherUserID UNIQUEIDENTIFIER, 
		Score FLOAT
	)
	
	
	-- Fetch All of the Selected Data and Calculate Score for Each Suggestion
	
	INSERT INTO @Suggestions (UserID, OtherUserID, Score)
	SELECT	D.UserID, 
			D.OtherUserID,
			(
				(20 * MAX(D.GroupsCount)) + 
				(50 * MAX(D.HasInvitation)) + 
				(10 * MAX(D.MutualsCount))
			) AS Score
	FROM (
			-- Select FriendsOfFriends With Mutual Friends Count
			
			SELECT	F.UserID, 
					F2.FriendID AS OtherUserID, 
					COUNT(F.FriendID) AS MutualsCount,
					CAST(0 AS int) AS HasInvitation, 
					CAST(0 AS int) AS GroupsCount
			FROM @UserIDs AS Ref
				INNER JOIN [dbo].[USR_View_Friends] AS F
				ON F.UserID = Ref.Value
				INNER JOIN [dbo].[USR_View_Friends] AS F2
				ON F2.ApplicationID = @ApplicationID AND 
					F2.UserID = F.FriendID AND F2.FriendID <> F.UserID
				LEFT JOIN [dbo].[USR_View_Friends] AS L1
				ON L1.ApplicationID = @ApplicationID AND 
					L1.UserID = F.UserID AND L1.FriendID = F2.FriendID
			WHERE F.ApplicationID = @ApplicationID AND 
				F.AreFriends = 1 AND F2.AreFriends = 1 AND L1.UserID IS NULL
			GROUP BY F.UserID, F2.FriendID
			
			-- end of Select FriendsOfFriends With Mutual Friends Count
			
			UNION ALL
			
			-- Calculate Mutual Friends Count for 'Invitations' and 'Groupmates'

			SELECT	Y.UserID, 
					Y.OtherUserID, 
					SUM(
						CASE 
							WHEN F.UserID IS NOT NULL AND F2.UserID IS NOT NULL AND
								F.AreFriends = 1 AND F2.AreFriends = 1 AND 
								F2.FriendID <> Y.UserID AND F.FriendID <> Y.OtherUserID
							THEN 1
							ELSE 0
						END
					) AS MutualsCount,
					MAX(Y.HasInvitation) AS HasInvitation, 
					MAX(Y.GroupsCount) AS GroupsCount
			FROM (
					-- Fetch 'Invitations' and 'Groupmates' and Remove Pairs Who Are Already Friends
					
					SELECT	Ref.UserID, 
							Ref.OtherUserID, 
							SUM(Ref.HasInvitation) AS HasInvitation,
							SUM(Ref.GroupsCount) AS GroupsCount
					FROM (
							-- Suggest Friends Based on Invitations
							
							SELECT DISTINCT
									Ref.Value AS UserID,
									(
										CASE 
											WHEN I.SenderUserID = Ref.Value THEN I.CreatedUserID 
											ELSE I.SenderUserID END
									) AS OtherUserID,
									CAST(1 AS int) AS HasInvitation,
									0 AS GroupsCount
							FROM @UserIDs AS Ref
								INNER JOIN [dbo].[USR_Invitations] AS I
								ON I.ApplicationID = @ApplicationID AND
									I.SenderUserID = Ref.Value OR I.CreatedUserID = Ref.Value
								INNER JOIN [dbo].[Users_Normal] AS UN
								ON UN.ApplicationID = @ApplicationID AND 
									UN.UserID = I.CreatedUserID
								
							-- end of Suggest Friends Based on Invitations
								
							UNION ALL
							
							-- Suggest Friends Based on Being Groupmate
							
							SELECT	NM.UserID, 
									NM2.UserID AS OtherUserID, 
									0 AS HasInvitation,
									COUNT(NM.NodeID) AS GroupsCount
							FROM @UserIDs AS Ref
								INNER JOIN [dbo].[CN_View_NodeMembers] AS NM
								ON NM.ApplicationID = @ApplicationID AND 
									NM.UserID = Ref.Value AND NM.IsPending = 0
								INNER JOIN [dbo].[CN_View_NodeMembers] AS NM2
								ON NM2.ApplicationID = @ApplicationID AND 
									NM2.NodeID = NM.NodeID AND NM2.UserID <> NM.UserID AND
									NM2.IsPending = 0
							GROUP BY NM.UserID, NM2.UserID
							
							-- end of Suggest Friends Based on Being Groupmate
						) AS Ref
						LEFT JOIN [dbo].[USR_View_Friends] AS F
						ON F.ApplicationID = @ApplicationID AND 
							F.UserID = Ref.UserID AND F.FriendID = Ref.OtherUserID
					WHERE F.UserID IS NULL
					GROUP BY Ref.UserID, Ref.OtherUserID
					
					-- end of Fetch 'Invitations' and 'Groupmates' and Remove Pairs Who Are Already Friends
				) AS Y
				LEFT JOIN [dbo].[USR_View_Friends] AS F
				ON F.ApplicationID = @ApplicationID AND F.UserID = Y.UserID
				LEFT JOIN [dbo].[USR_View_Friends] AS F2
				ON F2.ApplicationID = @ApplicationID AND 
					F2.UserID = Y.OtherUserID AND F2.FriendID = F.FriendID
			GROUP BY Y.UserID, Y.OtherUserID
			
			-- end of Calculate Mutual Friends Count for 'Invitations' and 'Groupmates'
		) AS D
	GROUP BY D.UserID, D.OtherUserID
	
	-- end of Fetch All of the Selected Data and Calculate Score for Each Suggestion
	
	
	-- Remove Suggestions Collected for Target Users
	
	DELETE FS
	FROM @UserIDs AS Ref
		INNER JOIN [dbo].[USR_FriendSuggestions] AS FS
		ON FS.ApplicationID = @ApplicationID AND FS.UserID = Ref.Value
		
	-- end of Remove Suggestions Collected for Target Users	
	
	
	-- Insert Collected Suggestions Into USR_FriendSuggestions Table

	INSERT INTO [dbo].[USR_FriendSuggestions] (
		ApplicationID,
		UserID, 
		SuggestedUserID, 
		Score
	)
	SELECT DISTINCT
		@ApplicationID,
		FS.UserID,
		FS.OtherUserID,
		FS.Score
	FROM @Suggestions AS FS
	WHERE FS.UserID <> FS.OtherUserID
	
	-- end of Insert Collected Suggestions Into USR_FriendSuggestions Table
	

	SET @_Result = 1
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_UpdateFriendSuggestions]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_UpdateFriendSuggestions]
GO

CREATE PROCEDURE [dbo].[USR_UpdateFriendSuggestions]
	@ApplicationID	uniqueidentifier,
    @UserID			uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @IDs TABLE (ID bigint IDENTITY(1, 1) primary key clustered, UserID uniqueidentifier)
	
	IF @UserID IS NULL BEGIN
		INSERT INTO @IDs (UserID)
		SELECT DISTINCT F.UserID
		FROM [dbo].[USR_View_Friends] AS F
		WHERE F.ApplicationID = @ApplicationID
	END
	ELSE INSERT INTO @IDs (UserID) VALUES(@UserID)
	
	DECLARE @_Result int = 0
	
	DECLARE @UserIDs GuidTableType
	DECLARE @Count bigint = (SELECT MAX(ID) FROM @IDs)
	DECLARE @BatchSize bigint = 50, @Lower bigint = 0
	
	WHILE @Count > 0 BEGIN
		DELETE @UserIDs
		
		INSERT INTO @UserIDs(Value)
		SELECT Ref.UserID
		FROM @IDs AS Ref
		WHERE Ref.ID > @Lower AND Ref.ID <= @Lower + @BatchSize
	
		EXEC [dbo].[USR_P_UpdateFriendSuggestions] @ApplicationID, @UserIDs, @_Result output
		
		SET @Lower = @Lower + @BatchSize
		SET @Count = @Count - @BatchSize
	END
	
	SELECT @_Result
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_GetFriendSuggestions]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_GetFriendSuggestions]
GO

CREATE PROCEDURE [dbo].[USR_GetFriendSuggestions]
	@ApplicationID	uniqueidentifier,
    @UserID			UNIQUEIDENTIFIER,
    @Count			INT,
    @LowerBoundary	int
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @RetTbl Table (UserID uniqueidentifier, FirstName nvarchar(500), 
		LastName nvarchar(500), MutualFriendsCount int, [Order] bigint, TotalCount bigint)
	
	INSERT INTO @RetTbl (UserID, FirstName, LastName, [Order], TotalCount)
	SELECT TOP(ISNULL(@Count, 100000))
		F.SuggestedUserID,
		F.FirstName,
		F.LastName,
		F.RowNumber AS [Order],
		(F.RowNumber + F.RevRowNumber - 1) AS TotalCount
	FROM (
			SELECT
				S.SuggestedUserID,
				UN.FirstName,
				UN.LastName,
				ROW_NUMBER() OVER (ORDER BY S.Score DESC, S.SuggestedUserID DESC) AS RowNumber,
				ROW_NUMBER() OVER (ORDER BY S.Score ASC, S.SuggestedUserID ASC) AS RevRowNumber
			FROM [dbo].[USR_FriendSuggestions] AS S
				LEFT JOIN [dbo].[USR_View_Friends] AS F
				ON F.ApplicationID = @ApplicationID AND 
					F.UserID = S.UserID AND F.FriendID = S.SuggestedUserID
				INNER JOIN [dbo].[Users_Normal] AS UN
				ON UN.ApplicationID = @ApplicationID AND UN.UserID = S.SuggestedUserID
			WHERE S.ApplicationID = @ApplicationID AND S.UserID = @UserID AND UN.IsApproved = 1 AND F.UserID IS NULL
		) AS F
	WHERE F.RowNumber >= ISNULL(@LowerBoundary, 0)
	ORDER BY F.RowNumber ASC
	
	DECLARE @OtherUserIDs GuidTableType
	INSERT INTO @OtherUserIDs
	SELECT Ref.UserID
	FROM @RetTbl AS Ref
	
	UPDATE Ref
		SET MutualFriendsCount = O.MutualFriendsCount
	FROM @RetTbl AS Ref
		INNER JOIN [dbo].[USR_FN_GetMutualFriendsCount](@ApplicationID, @UserID, @OtherUserIDs) AS O
		ON Ref.UserID = O.UserID
		
	SELECT *
	FROM @RetTbl AS Ref
	ORDER BY Ref.[Order] DESC
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_GetFriendIDs]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_GetFriendIDs]
GO

CREATE PROCEDURE [dbo].[USR_GetFriendIDs]
	@ApplicationID	uniqueidentifier,
    @UserID			uniqueidentifier,
    @AreFriends		bit,
    @Sent			bit,
    @Received		bit
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT Ref.UserID AS ID
	FROM [dbo].[USR_FN_GetFriendIDs](@ApplicationID, @UserID, @AreFriends, @Sent, @Received) AS Ref
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_GetFriends]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_GetFriends]
GO

CREATE PROCEDURE [dbo].[USR_GetFriends]
	@ApplicationID	uniqueidentifier,
    @UserID			uniqueidentifier,
    @strFriendIDs	varchar(max),
    @delimiter		char,
    @MutualsCount	bit,
    @AreFriends		bit,
    @IsSender		bit,
    @SearchText		nvarchar(1000),
    @Count			int,
    @LowerBoundary	bigint
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	IF @SearchText = N'' SET @SearchText = NULL
	
	DECLARE @FriendIDs GuidTableType
	INSERT INTO @FriendIDs
	SELECT Ref.Value
	FROM [dbo].[GFN_StrToGuidTable](@strFriendIDs, @delimiter) AS Ref
	
	DECLARE @FIDsCount int = (SELECT COUNT(*) FROM @FriendIDs)
	
	IF @FIDsCount > 0 SET @Count = 1000000
	
	DECLARE @x Table (FriendID uniqueidentifier primary key clustered,
		UserName nvarchar(1000), FirstName nvarchar(1000), LastName nvarchar(1000),
		RequestDate datetime, AcceptionDate datetime, AreFriends bit,
		IsSender bit, RowNumber bigint, RevRowNumber bigint)
	
	IF @SearchText IS NULL BEGIN
		INSERT INTO @x (
			FriendID, UserName, FirstName, LastName, RequestDate, 
			AcceptionDate, AreFriends, IsSender, RowNumber, RevRowNumber
		)
		SELECT f.FriendID, f.UserName, f.FirstName, f.LastName, 
			f.RequestDate, f.AcceptionDate, f.AreFriends, f.IsSender,
			ROW_NUMBER() OVER (ORDER BY f.LastActivityDate DESC, f.FriendID DESC) AS RowNumber,
			ROW_NUMBER() OVER (ORDER BY f.LastActivityDate ASC, f.FriendID ASC) AS RevRowNumber
		FROM (
			SELECT UN.UserID AS FriendID,
				   UN.UserName AS UserName,
				   UN.FirstName AS FirstName,
				   UN.LastName AS LastName,
				   FR.RequestDate AS RequestDate,
				   FR.AcceptionDate AS AcceptionDate,
				   FR.AreFriends AS AreFriends,
				   FR.IsSender AS IsSender,
				   UN.LastActivityDate
			FROM [dbo].[USR_View_Friends] AS FR
				LEFT JOIN [dbo].[Users_Normal] AS UN
				ON UN.ApplicationID = @ApplicationID AND UN.UserID = FR.FriendID
			WHERE FR.ApplicationID = @ApplicationID AND 
				@SearchText IS NULL AND FR.UserID = @UserID AND
				(@IsSender IS NULL OR FR.IsSender = @IsSender) AND
				(@FIDsCount = 0 OR FR.FriendID IN (SELECT * FROM @FriendIDs)) AND
				(@AreFriends IS NULL OR FR.AreFriends = @AreFriends)
		) AS f	
	END
	ELSE BEGIN
		INSERT INTO @x (
			FriendID, UserName, FirstName, LastName, RequestDate, 
			AcceptionDate, AreFriends, IsSender, RowNumber, RevRowNumber
		)
		SELECT f.FriendID, f.UserName, f.FirstName, f.LastName, 
			f.RequestDate, f.AcceptionDate, f.AreFriends, f.IsSender,
			ROW_NUMBER() OVER (ORDER BY f.[Rank] DESC, f.LastActivityDate DESC, f.FriendID DESC) AS RowNumber,
			ROW_NUMBER() OVER (ORDER BY f.[Rank] ASC, f.LastActivityDate ASC, f.FriendID ASC) AS RevRowNumber
		FROM (
			SELECT UN.UserID AS FriendID,
				   UN.UserName AS UserName,
				   UN.FirstName AS FirstName,
				   UN.LastName AS LastName,
				   FR.RequestDate AS RequestDate,
				   FR.AcceptionDate AS AcceptionDate,
				   FR.AreFriends AS AreFriends,
				   FR.IsSender AS IsSender,
				   UN.LastActivityDate,
				   SRCH.[Rank] AS [Rank]
			FROM CONTAINSTABLE([dbo].[USR_View_Users], 
					(FirstName, LastName, UserName), @SearchText) AS SRCH
				INNER JOIN [dbo].[USR_View_Friends] AS FR
				ON FR.FriendID = SRCH.[Key]
				LEFT JOIN [dbo].[Users_Normal] AS UN
				ON UN.ApplicationID = @ApplicationID AND UN.UserID = FR.FriendID
			WHERE FR.ApplicationID = @ApplicationID AND 
				@SearchText IS NOT NULL AND FR.UserID = @UserID AND
				(@IsSender IS NULL OR FR.IsSender = @IsSender) AND
				(@FIDsCount = 0 OR FR.FriendID IN (SELECT * FROM @FriendIDs)) AND
				(@AreFriends IS NULL OR FR.AreFriends = @AreFriends)
		) AS f
	END

	SELECT TOP(ISNULL(@Count, 1000000)) *
	FROM (
			SELECT
				MyFriends.FriendID,
				MAX(MyFriends.UserName) AS UserName,
				MAX(MyFriends.FirstName) AS FirstName,
				MAX(MyFriends.LastName) AS LastName,
				MAX(MyFriends.RequestDate) AS RequestDate,
				MAX(MyFriends.AcceptionDate) AS AcceptionDate,
				CAST(MAX(CAST(MyFriends.AreFriends AS int)) AS bit) AS AreFriends,
				CAST(MAX(CAST(MyFriends.IsSender AS int)) AS bit) AS IsSender,
				COUNT(FriendsOfFriends.FriendOfFriend) AS MutualFriendsCount,
				MAX(MyFriends.RowNumber) AS [Order],
				(MAX(MyFriends.RowNumber) + MAX(MyFriends.RevRowNumber) - 1) AS TotalCount
			FROM @x AS MyFriends
				LEFT JOIN (
					SELECT x.FriendID AS Friend, 
						CASE 
							WHEN UC.SenderUserID = x.FriendID THEN UC.ReceiverUserID
							ELSE UC.SenderUserID
						END AS FriendOfFriend
					FROM @x AS x
						INNER JOIN [dbo].[USR_Friends] AS UC
						ON UC.ApplicationID = @ApplicationID AND 
							UC.AreFriends = 1 AND UC.Deleted = 0 AND (
								UC.ReceiverUserID = x.FriendID OR UC.SenderUserID = x.FriendID
							)
				) FriendsOfFriends
				ON @MutualsCount = 1 AND MyFriends.FriendID = FriendsOfFriends.FriendOfFriend
			GROUP BY MyFriends.FriendID
		) AS F
	WHERE F.[Order] >= ISNULL(@LowerBoundary, 0)
	ORDER BY F.[Order] ASC
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_GetFriendsCount]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_GetFriendsCount]
GO

CREATE PROCEDURE [dbo].[USR_GetFriendsCount]
	@ApplicationID	uniqueidentifier,
    @UserID			uniqueidentifier,
    @AreFriends		bit,
    @Sent			bit,
    @Received		bit
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT COUNT(FriendID)
	FROM [dbo].[USR_View_Friends]
	WHERE ApplicationID = @ApplicationID AND 
		UserID = @UserID AND (@AreFriends IS NULL OR AreFriends = @AreFriends) AND
		((@Sent = 1 AND IsSender = 1) OR (@Received = 1 AND IsSender = 0))
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_P_SaveEmailContacts]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_P_SaveEmailContacts]
GO

CREATE PROCEDURE [dbo].[USR_P_SaveEmailContacts]	
	@ApplicationID	uniqueidentifier,
    @UserID			uniqueidentifier,
    @EmailsTemp		StringTableType readonly,
    @Now			datetime,
    @_Result		int output
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @Emails StringTableType
	INSERT INTO @Emails SELECT * FROM @EmailsTemp
	
	UPDATE C
		SET Deleted = 0
	FROM @Emails AS E
		INNER JOIN [dbo].[USR_EmailContacts] AS C
		ON C.Email = LOWER(E.Value)
	WHERE C.UserID = @UserID
	
	SET @_Result = @@ROWCOUNT
	
	INSERT INTO [dbo].[USR_EmailContacts](
		UserID,
		Email, 
		CreationDate, 
		Deleted, 
		UniqueID
	)
	SELECT Ref.UserID, Ref.Email, Ref.[Now], Ref.Deleted, NEWID()
	FROM (
			SELECT DISTINCT @UserID AS UserID, LOWER(E.Value) AS Email, 
				@Now AS [Now], 0 AS Deleted
			FROM @Emails AS E
				LEFT JOIN [dbo].[USR_EmailContacts] AS C
				ON C.UserID = @UserID AND C.Email = LOWER(E.Value)
			WHERE C.UserID IS NULL
		) AS Ref
	
	SET @_Result = @_Result + @@ROWCOUNT
	
	IF @_Result <= 0 AND (SELECT TOP (1) * FROM @Emails) IS NULL SET @_Result = 1
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_GetEmailContactsStatus]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_GetEmailContactsStatus]
GO

CREATE PROCEDURE [dbo].[USR_GetEmailContactsStatus]
	@ApplicationID	uniqueidentifier,
    @UserID			uniqueidentifier,
    @EmailsTemp		StringTableType readonly,
    @SaveEmails		bit,
    @Now			datetime
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @Emails StringTableType
	INSERT INTO @Emails SELECT * FROM @EmailsTemp
	
	IF @SaveEmails = 1 BEGIN
		DECLARE @_Result int = 0
	
		EXEC [dbo].[USR_P_SaveEmailContacts] @ApplicationID, 
			@UserID, @Emails, @Now, @_Result output
	END
	
	SELECT	Emails.Email,
			Emails.UserID,
			CAST((CASE WHEN Fr.IsSender IS NULL THEN 0 ELSE 1 END) AS bit) AS FriendRequestReceived
	FROM (
			SELECT DISTINCT
					EA.UserID,
					LOWER(E.Value) AS Email
			FROM @Emails AS E
				LEFT JOIN [dbo].[USR_EmailAddresses] AS EA
				ON EA.Deleted = 0 AND LOWER(EA.EmailAddress) = LOWER(E.Value)
			WHERE EA.UserID IS NULL OR EA.UserID <> @UserID
		) AS Emails
		LEFT JOIN [dbo].[USR_View_Friends] AS Fr
		ON Fr.ApplicationID = @ApplicationID AND 
			Fr.UserID = @UserID AND Fr.FriendID = Emails.UserID
	WHERE Fr.AreFriends IS NULL OR (Fr.AreFriends = 0 AND Fr.IsSender = 0)
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_SetTheme]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_SetTheme]
GO

CREATE PROCEDURE [dbo].[USR_SetTheme]
	@UserID			uniqueidentifier,
    @Theme			varchar(50)
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[USR_Profile]
		SET Theme = @Theme
	WHERE UserID = @UserID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_GetTheme]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_GetTheme]
GO

CREATE PROCEDURE [dbo].[USR_GetTheme]
	@UserID			uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT Theme
	FROM [dbo].[USR_Profile]
	WHERE UserID = @UserID
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_SetVerificationCodeMedia]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_SetVerificationCodeMedia]
GO

CREATE PROCEDURE [dbo].[USR_SetVerificationCodeMedia]
	@UserID		uniqueidentifier,
	@Media		varchar(50)
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[USR_Profile]
		SET TwoStepAuthentication = @Media
	WHERE UserID = @UserID

	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_SaveUserSettings]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_SaveUserSettings]
GO

CREATE PROCEDURE [dbo].[USR_SaveUserSettings]
	@UserID		uniqueidentifier,
	@Settings	nvarchar(max)
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[USR_Profile]
		SET Settings = @Settings
	WHERE UserID = @UserID

	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_GetApprovedUserIDs]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_GetApprovedUserIDs]
GO

CREATE PROCEDURE [dbo].[USR_GetApprovedUserIDs]
	@ApplicationID	uniqueidentifier,
    @strUserIDs		varchar(max),
    @delimiter		char
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @UserIDs GuidTableType
	
	INSERT INTO @UserIDs
	SELECT DISTINCT Ref.Value 
	FROM [dbo].[GFN_StrToGuidTable](@strUserIDs, @delimiter) AS Ref
	
	SELECT UN.UserID AS ID
	FROM @UserIDs AS U
		INNER JOIN [dbo].[Users_Normal] AS UN
		ON UN.ApplicationID = @ApplicationID AND UN.UserID = U.Value
	WHERE UN.IsApproved = 1
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_SetLastActivityDate]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_SetLastActivityDate]
GO

CREATE PROCEDURE [dbo].[USR_SetLastActivityDate]
    @UserID			uniqueidentifier,
    @Now			datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[aspnet_Users]
		SET LastActivityDate = @Now
	WHERE UserId = @UserID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_AddOrModifyRemoteServer]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_AddOrModifyRemoteServer]
GO

CREATE PROCEDURE [dbo].[USR_AddOrModifyRemoteServer]
	@ApplicationID	uniqueidentifier,
	@ServerID		uniqueidentifier,
	@UserID			uniqueidentifier,
	@Name			nvarchar(255),
	@URL			nvarchar(100),
	@UserName		nvarchar(100),
	@Password		varbinary(100),
	@Now			datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	IF EXISTS(
		SELECT TOP(1) ServerID
		FROM [dbo].[USR_RemoteServers]
		WHERE ApplicationID = @ApplicationID AND ServerID = @ServerID AND UserID = @UserID
	) BEGIN
		UPDATE [dbo].[USR_RemoteServers]
			Set Name = @Name,
				URL = @URL,
				UserName = @UserName,
				[Password] = @Password,
				LastModificationDate = @Now
		WHERE ApplicationID = @ApplicationID AND ServerID = @ServerID AND UserID = @UserID
	END
	ELSE BEGIN
		INSERT INTO [dbo].[USR_RemoteServers] (
			ApplicationID, ServerID, UserID, Name, URL, UserName, [Password], CreationDate
		)
		VALUES (@ApplicationID, @ServerID, @UserID, @Name, @URL, @UserName, @Password, @Now)
	END
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_RemoveRemoteServer]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_RemoveRemoteServer]
GO

CREATE PROCEDURE [dbo].[USR_RemoveRemoteServer]
	@ApplicationID	uniqueidentifier,
	@ServerID		uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DELETE [dbo].[USR_RemoteServers]
	WHERE ApplicationID = @ApplicationID AND ServerID = @ServerID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_GetRemoteServers]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_GetRemoteServers]
GO

CREATE PROCEDURE [dbo].[USR_GetRemoteServers]
	@ApplicationID	uniqueidentifier,
	@ServerID		uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT S.ServerID, S.UserID, S.Name, S.URL, S.UserName, S.[Password]
	FROM [dbo].[USR_RemoteServers] AS S
	WHERE S.ApplicationID = @ApplicationID AND 
		(@ServerID IS NULL OR ServerID = @ServerID)
	ORDER BY S.CreationDate DESC
END

GO


-- Profile

IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_P_SavePasswordHistoryBulk]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_P_SavePasswordHistoryBulk]
GO

CREATE PROCEDURE [dbo].[USR_P_SavePasswordHistoryBulk]
    @ItemsTemp		GuidStringTableType readonly,
    @AutoGenerated	bit,
    @Now			datetime,
    @_Result		int output
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @Items GuidStringTableType
	INSERT INTO @Items SELECT * FROM @ItemsTemp
	
	INSERT INTO [dbo].[USR_PasswordsHistory](
		UserID,
		[Password],
		[SetDate],
		AutoGenerated
	)
	SELECT	I.FirstValue,
			I.SecondValue,
			@Now,
			ISNULL(@AutoGenerated, 0)
	FROM @Items AS I

	SET @_Result = @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_P_SavePasswordHistory]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_P_SavePasswordHistory]
GO

CREATE PROCEDURE [dbo].[USR_P_SavePasswordHistory]
    @UserID 		uniqueidentifier,
    @Password		nvarchar(255),
    @AutoGenerated	bit,
    @Now			datetime,
    @_Result		int output
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	INSERT INTO [dbo].[USR_PasswordsHistory](
		UserID,
		[Password],
		[SetDate],
		AutoGenerated
	)
	VALUES(
		@UserID,
		@Password,
		@Now,
		ISNULL(@AutoGenerated, 0)
	)

	SET @_Result = @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_GetLastPasswords]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_GetLastPasswords]
GO

CREATE PROCEDURE [dbo].[USR_GetLastPasswords]
    @UserID 		uniqueidentifier,
    @AutoGenerated	bit,
    @Count			int
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT TOP(ISNULL(@Count, 1000)) [Password], AutoGenerated
	FROM [dbo].[USR_PasswordsHistory]
	WHERE UserID = @UserID AND (@AutoGenerated IS NULL OR ISNULL(AutoGenerated, 0) = @AutoGenerated)
	ORDER BY ID DESC
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_GetLastPasswordDate]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_GetLastPasswordDate]
GO

CREATE PROCEDURE [dbo].[USR_GetLastPasswordDate]
    @UserID 		uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT TOP(1) SetDate
	FROM [dbo].[USR_PasswordsHistory]
	WHERE UserID = @UserID
	ORDER BY ID DESC
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_GetCurrentPassword]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_GetCurrentPassword]
GO

CREATE PROCEDURE [dbo].[USR_GetCurrentPassword]
	@UserID			uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT TOP(1) M.[Password], M.PasswordSalt
	FROM [dbo].[aspnet_Membership] AS M
	WHERE M.UserId = @UserID
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_P_CreateUsers]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_P_CreateUsers]
GO

CREATE PROCEDURE [dbo].[USR_P_CreateUsers]
	@ApplicationID	uniqueidentifier,
	@UsersTemp		ExchangeUserTableType readonly,
    @Now			datetime,
    @_Result		int output,
    @_ErrorMessage	nvarchar(255) output
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @Users ExchangeUserTableType
	INSERT INTO @Users SELECT * FROM @UsersTemp
	
	
	IF @ApplicationID IS NOT NULL AND EXISTS(
		SELECT TOP(1) 1 
		FROM @Users AS Ref
			INNER JOIN [dbo].[Users_Normal] AS U
			ON (@ApplicationID IS NULL OR U.ApplicationID = @ApplicationID) AND 
				U.LoweredUserName = LOWER(Ref.UserName)
	) BEGIN
		SET @_Result = -1
		SET @_ErrorMessage = N'UserNameAlreadyExists'
		RETURN
	END
	ELSE IF @ApplicationID IS NULL AND EXISTS(
		SELECT TOP(1) 1 
		FROM @Users AS Ref
			INNER JOIN [dbo].[aspnet_Users] AS U
			ON U.LoweredUserName = LOWER(Ref.UserName)
	) BEGIN
		SET @_Result = -1
		SET @_ErrorMessage = N'UserNameAlreadyExists'
		RETURN
	END
	
	IF EXISTS(
		SELECT TOP(1) 1 
		FROM @Users AS Ref
			INNER JOIN [dbo].[USR_EmailAddresses] AS E
			ON LOWER(EmailAddress) = LOWER(Ref.Email) AND E.Deleted = 0
			INNER JOIN [dbo].[USR_Profile] AS P
			ON P.UserID = E.UserID AND P.MainEmailID = E.EmailID
		WHERE ISNULL(Ref.Email, N'') <> N''
	) BEGIN
		SELECT @_Result = -1, @_ErrorMessage = N'EmailAddressAlreadyExists'
		RETURN
	END
	
	IF EXISTS(
		SELECT TOP(1) 1 
		FROM @Users AS Ref
			INNER JOIN [dbo].[USR_PhoneNumbers] AS E
			ON E.PhoneNumber = LOWER(Ref.PhoneNumber) AND E.Deleted = 0
			INNER JOIN [dbo].[USR_Profile] AS P
			ON P.UserID = E.UserID AND P.MainPhoneID = E.NumberID
		WHERE ISNULL(Ref.PhoneNumber, N'') <> N''
	) BEGIN
		SELECT @_Result = -1, @_ErrorMessage = N'PhoneNumberAlreadyExists'
		RETURN
	END
	
	INSERT INTO [dbo].[aspnet_Users](
		UserId,
		UserName,
		LoweredUserName,
		IsAnonymous,
		LastActivityDate
	)
	SELECT	Ref.UserID, 
			Ref.UserName, 
			LOWER(Ref.UserName), 
			0, 
			N'1754-01-01 00:00:00.000'
	FROM @Users AS Ref
	WHERE Ref.UserID IS NOT NULL AND ISNULL(Ref.UserName, N'') <> N'' AND
		ISNULL(Ref.[Password], N'') <> N'' AND ISNULL(Ref.PasswordSalt, N'') <> N''

	INSERT INTO [dbo].[aspnet_Membership](
		UserId,
		[Password],
		PasswordFormat,
		PasswordSalt,
		IsApproved,
		IsLockedOut,
		CreateDate,
		LastLoginDate,
		LastPasswordChangedDate,
		LastLockoutDate,
		FailedPasswordAttemptCount,
		FailedPasswordAttemptWindowStart,
		FailedPasswordAnswerAttemptCount,
		FailedPasswordAnswerAttemptWindowStart
	)
	SELECT	Ref.UserID,
			Ref.[Password],
			N'1',
			Ref.PasswordSalt,
			1,
			0,
			@Now,
			N'1754-01-01 00:00:00.000',
			N'1754-01-01 00:00:00.000',
			N'1754-01-01 00:00:00.000',
			0,
			N'1754-01-01 00:00:00.000',
			0,
			N'1754-01-01 00:00:00.000'
	FROM @Users AS Ref
	WHERE Ref.UserID IS NOT NULL AND ISNULL(Ref.UserName, N'') <> N'' AND
		ISNULL(Ref.[Password], N'') <> N'' AND ISNULL(Ref.PasswordSalt, N'') <> N''
	
	INSERT INTO [dbo].[USR_Profile](
		UserID, 
		FirstName, 
		LastName
	)
	SELECT	Ref.UserID,
			Ref.FirstName,
			Ref.LastName
	FROM @Users AS Ref
	WHERE Ref.UserID IS NOT NULL AND ISNULL(Ref.UserName, N'') <> N'' AND
		ISNULL(Ref.[Password], N'') <> N'' AND ISNULL(Ref.PasswordSalt, N'') <> N''
	
	IF @ApplicationID IS NOT NULL BEGIN
		INSERT INTO [dbo].[USR_UserApplications](
			ApplicationID,
			UserID
		)
		SELECT	@ApplicationID,
				Ref.UserID
		FROM @Users AS Ref
		WHERE Ref.UserID IS NOT NULL AND ISNULL(Ref.UserName, N'') <> N'' AND
			ISNULL(Ref.[Password], N'') <> N'' AND ISNULL(Ref.PasswordSalt, N'') <> N''
	END
	
	
	-- Update Email Addresses
	DECLARE @Emails TABLE (UserID uniqueidentifier, EmailID uniqueidentifier, Email varchar(100))
	
	INSERT INTO @Emails (UserID, EmailID, Email)
	SELECT Ref.UserID, NEWID(), Ref.Email
	FROM @Users AS Ref
	WHERE Ref.UserID IS NOT NULL AND ISNULL(Ref.UserName, N'') <> N'' AND
		ISNULL(Ref.[Password], N'') <> N'' AND ISNULL(Ref.PasswordSalt, N'') <> N'' AND
		ISNULL(Ref.Email, N'') <> N''
		
	INSERT INTO [dbo].[USR_EmailAddresses](
		EmailID, 
		UserID, 
		EmailAddress,
		CreatorUserID, 
		CreationDate, 
		Validated,
		Deleted
	)
	SELECT	E.EmailID,
			E.UserID,
			LOWER(E.Email),
			E.UserID,
			@Now,
			1,
			0
	FROM @Emails AS E
	
	UPDATE P
		SET MainEmailID = E.EmailID
	FROM @Emails AS E
		INNER JOIN [dbo].[USR_Profile] AS P
		ON P.UserID = E.UserID
	-- end of Update Email Addresses
	
	
	-- Update Phone Numbers
	DECLARE @Numbers TABLE (UserID uniqueidentifier, NumberID uniqueidentifier, PhoneNumber varchar(100))
	
	INSERT INTO @Numbers(UserID, NumberID, PhoneNumber)
	SELECT Ref.UserID, NEWID(), Ref.PhoneNumber
	FROM @Users AS Ref
	WHERE Ref.UserID IS NOT NULL AND ISNULL(Ref.UserName, N'') <> N'' AND
		ISNULL(Ref.[Password], N'') <> N'' AND ISNULL(Ref.PasswordSalt, N'') <> N'' AND
		ISNULL(Ref.PhoneNumber, N'') <> N''
		
	INSERT INTO [dbo].[USR_PhoneNumbers](
		NumberID, 
		UserID, 
		PhoneNumber,
		CreatorUserID, 
		CreationDate, 
		Validated,
		Deleted
	)
	SELECT	E.NumberID,
			E.UserID,
			E.PhoneNumber,
			E.UserID,
			@Now,
			1,
			0
	FROM @Numbers AS E
	
	UPDATE P
		SET MainPhoneID = E.NumberID
	FROM @Numbers AS E
		INNER JOIN [dbo].[USR_Profile] AS P
		ON P.UserID = E.UserID
	-- end of Update Phone Numbers
	
	
	SET @_Result = 1
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_CreateUser]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_CreateUser]
GO

CREATE PROCEDURE [dbo].[USR_CreateUser]
	@ApplicationID		uniqueidentifier,
    @UserID 			uniqueidentifier,
    @UserName			nvarchar(255),
    @FirstName			nvarchar(255),
    @LastName			nvarchar(255),
    @Password			nvarchar(255),
    @PasswordSalt		nvarchar(255),
    @EncryptedPassword	nvarchar(255),
    @PassAutoGenerated	bit,
    @Email				varchar(100),
    @PhoneNumber		varchar(50),
    @Now				datetime
WITH ENCRYPTION
AS
BEGIN TRANSACTION
	SET NOCOUNT ON
	
	DECLARE @_Result int, @_ErrorMessage nvarchar(255)
	
	DECLARE @Users ExchangeUserTableType
	
	INSERT INTO @Users (UserID, UserName, FirstName, LastName, 
		[Password], PasswordSalt, EncryptedPassword, Email, PhoneNumber)
	VALUES (@UserID, @UserName, @FirstName, @LastName,
		@Password, @PasswordSalt, @EncryptedPassword, @Email, @PhoneNumber)
	
	EXEC [dbo].[USR_P_CreateUsers] @ApplicationID, @Users, @Now, 
		@_Result output, @_ErrorMessage output
	
	IF @_Result <= 0 BEGIN
		SELECT @_Result, @_ErrorMessage
		ROLLBACK TRANSACTION
		RETURN
	END
	
	EXEC [dbo].[USR_P_SavePasswordHistory] @UserID, @EncryptedPassword, @PassAutoGenerated, @Now, @_Result output
	
	IF @_Result <= 0 BEGIN
		SET @_ErrorMessage = NULL
		SELECT @_Result, @_ErrorMessage
		ROLLBACK TRANSACTION
		RETURN
	END
	
	SELECT @_Result, @_ErrorMessage
COMMIT TRANSACTION

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_CreateTemporaryUser]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_CreateTemporaryUser]
GO

CREATE PROCEDURE [dbo].[USR_CreateTemporaryUser]
    @UserID 			uniqueidentifier,
    @UserName			nvarchar(255),
    @FirstName			nvarchar(255),
    @LastName			nvarchar(255),
    @Password			nvarchar(255),
    @PasswordSalt		nvarchar(255),
    @EncryptedPassword	nvarchar(255),
    @PassAutoGenerated	bit,
    @Email				nvarchar(255),
    @PhoneNumber		varchar(50),
    @Now				datetime,
    @ExpirationDate		datetime,
    @ActivationCode		varchar(255),
    @InvitationID		uniqueidentifier
WITH ENCRYPTION
AS
BEGIN TRANSACTION
	SET NOCOUNT ON
	
	SET @UserName = [dbo].[GFN_VerifyString](@UserName)
	SET @FirstName = [dbo].[GFN_VerifyString](@FirstName)
	SET @LastName = [dbo].[GFN_VerifyString](@LastName)
	
	IF EXISTS(
		SELECT TOP(1) 1 
		FROM [dbo].[USR_View_Users] 
		WHERE LoweredUserName = LOWER(@UserName)
	) OR EXISTS(
		SELECT TOP(1) 1 
		FROM [dbo].[USR_TemporaryUsers] 
		WHERE LOWER(UserName) = LOWER(@UserName) AND
			(ExpirationDate IS NOT NULL AND ExpirationDate >= @Now)
	) BEGIN
		SELECT -1, N'UserNameAlreadyExists'
		RETURN
	END
	
	IF EXISTS(
		SELECT TOP(1) 1 
		FROM [dbo].[USR_EmailAddresses]  AS E
		WHERE LOWER(E.EmailAddress) = LOWER(@Email)
	) BEGIN
		SELECT -1, N'EmailAddressAlreadyExists'
		RETURN
	END
	
	IF EXISTS(
		SELECT TOP(1) 1 
		FROM [dbo].[USR_PhoneNumbers]  AS E
		WHERE LOWER(E.PhoneNumber) = LOWER(@PhoneNumber)
	) BEGIN
		SELECT -1, N'PhoneNumberAlreadyExists'
		RETURN
	END
	
	
	INSERT INTO [dbo].[USR_TemporaryUsers](
		UserID,
		UserName,
		FirstName,
		LastName,
		[Password],
		PasswordSalt,
		EMail,
		PhoneNumber,
		CreationDate,
		ExpirationDate,
		ActivationCode
	)
	VALUES(
		@UserID,
		@UserName,
		@FirstName,
		@LastName,
		@Password,
		@PasswordSalt,
		@EMail,
		@PhoneNumber,
		@Now,
		@ExpirationDate,
		@ActivationCode
	)
	
	IF @@ROWCOUNT <= 0 BEGIN
		SELECT -1
		ROLLBACK TRANSACTION
		RETURN
	END
	
	IF @InvitationID IS NOT NULL BEGIN
		UPDATE [dbo].[USR_Invitations]
			SET CreatedUserID = @UserID
		WHERE ID = @InvitationID
		
		IF @@ROWCOUNT <= 0 BEGIN
			SELECT -1
			ROLLBACK TRANSACTION
			RETURN
		END
	END
	
	DECLARE @_Result int
	
	EXEC [dbo].[USR_P_SavePasswordHistory] @UserID, @EncryptedPassword, @PassAutoGenerated, @Now, @_Result output
		
	IF @_Result <= 0 BEGIN
		SELECT -1
		ROLLBACK TRANSACTION
		RETURN
	END
	
	SELECT 1
COMMIT TRANSACTION

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_ActivateTemporaryUser]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_ActivateTemporaryUser]
GO

CREATE PROCEDURE [dbo].[USR_ActivateTemporaryUser]
    @ActivationCode	VARCHAR(255),
    @Now			DATETIME
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @UserID uniqueidentifier, @UserName nvarchar(255), @FirstName nvarchar(255),
		@LastName nvarchar(255), @Password nvarchar(255), @PasswordSalt nvarchar(255),
		@EMail nvarchar(255), @PhoneNumber varchar(50), @ApplicationID	uniqueidentifier
		
	IF (
		SELECT TOP(1) 1 
		FROM [dbo].[USR_View_Users]
		WHERE UserID = @UserID
	) IS NOT NULL BEGIN
		SELECT 1
		RETURN
	END
	
	SELECT TOP(1)	
			@UserID = T.UserID, @UserName = T.UserName, @FirstName = T.FirstName, @LastName = T.LastName,
			@EMail = T.EMail, @PhoneNumber = T.PhoneNumber, @Password = T.[Password], @PasswordSalt = T.PasswordSalt,
			@ApplicationID = I.ApplicationID
	FROM [dbo].[USR_TemporaryUsers] AS T
		LEFT JOIN [dbo].[USR_Invitations] AS I
		ON I.CreatedUserID = T.UserID
	WHERE T.ActivationCode = @ActivationCode
	
	DECLARE @_Result int, @_ErrorMessage nvarchar(255)
	
	DECLARE @Users ExchangeUserTableType
	
	INSERT INTO @Users (UserID, UserName, FirstName, LastName, 
		[Password], PasswordSalt, EncryptedPassword, Email, PhoneNumber)
	VALUES (@UserID, @UserName, @FirstName, @LastName,
		@Password, @PasswordSalt, @Password, @Email, @PhoneNumber)
	
	EXEC [dbo].[USR_P_CreateUsers] @ApplicationID, @Users, @Now, 
		@_Result output, @_ErrorMessage output
	
	SELECT @_Result, @_ErrorMessage
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_GetInvitationID]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_GetInvitationID]
GO

CREATE PROCEDURE [dbo].[USR_GetInvitationID]
	@ApplicationID	uniqueidentifier,
	@Email			nvarchar(255),
	@CheckIfNotUsed	bit
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT I.ID
	FROM [dbo].[USR_Invitations] AS I
	WHERE I.ApplicationID = @ApplicationID AND I.Email = LOWER(@Email) AND
		(ISNULL(@CheckIfNotUsed, 0) = 0 OR I.CreatedUserID IS NULL)
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_InviteUser]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_InviteUser]
GO

CREATE PROCEDURE [dbo].[USR_InviteUser]
	@ApplicationID	uniqueidentifier,
	@InvitationID	UNIQUEIDENTIFIER,
	@Email			NVARCHAR(255),
    @CurrentUserID	UNIQUEIDENTIFIER,
    @Now			DATETIME
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SET @Email = LOWER(@Email)

	INSERT INTO [dbo].[USR_Invitations] (
		ApplicationID,
		ID, 
		Email, 
		SenderUserID, 
		SendDate
	)
	VALUES (@ApplicationID, @InvitationID, LOWER(@Email), @CurrentUserID, @Now)

	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_GetInvitedUsersCount]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_GetInvitedUsersCount]
GO

CREATE PROCEDURE [dbo].[USR_GetInvitedUsersCount]
	@ApplicationID	uniqueidentifier,
    @UserID			UNIQUEIDENTIFIER
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT COUNT(Email)
	FROM [dbo].[USR_Invitations]
	WHERE ApplicationID = @ApplicationID AND @UserID IS NULL OR SenderUserID = @UserID
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_GetUserInvitations]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_GetUserInvitations]
GO

CREATE PROCEDURE [dbo].[USR_GetUserInvitations]
	@ApplicationID		uniqueidentifier,
	@SenderUserID		UNIQUEIDENTIFIER,
	@Count				INT,
	@LowerBoundary		BIGINT
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @Results TABLE (
		Email nvarchar(255), 
		SendDate datetime, 
		UserID uniqueidentifier,
		FirstName nvarchar(200),
		LastName nvarchar(200),
		Activated bit
	)
	
	
	-- Email Based Results
	INSERT INTO @Results (Email, SendDate, UserID, FirstName, LastName, Activated)
	SELECT	LOWER(I.Email), 
			MAX(I.SendDate),
			CAST(MAX(CAST(UN.UserID AS varchar(50))) AS uniqueidentifier),
			MAX(UN.FirstName),
			MAX(UN.LastName),
			1 AS Activated
	FROM [dbo].[USR_Invitations] AS I
		INNER JOIN [dbo].[Users_Normal] AS UN
		ON I.ApplicationID = UN.ApplicationID
		INNER JOIN [dbo].[USR_EmailAddresses] AS EA
		ON EA.UserID = UN.UserID AND LOWER(EA.EmailAddress) = LOWER(I.Email)
	WHERE I.ApplicationID = @ApplicationID AND I.SenderUserID = @SenderUserID
	GROUP BY LOWER(I.Email)
	-- end of Email Based Results
	
	
	-- Temp User Based Results
	INSERT INTO @Results (Email, SendDate, UserID, FirstName, LastName, Activated)
	SELECT X.Email, X.SendDate, X.UserID, X.FirstName, X.LastName, X.Activated
	FROM (
			SELECT	LOWER(I.Email) AS Email, 
					MAX(I.SendDate) AS SendDate,
					CAST(MAX(CAST(T.UserID AS varchar(50))) AS uniqueidentifier) AS UserID,
					MAX(T.FirstName) AS FirstName,
					MAX(T.LastName) AS LastName,
					MAX(CASE WHEN P.UserID IS NULL THEN 0 ELSE 1 END) AS Activated
			FROM [dbo].[USR_Invitations] AS I
				INNER JOIN [dbo].[USR_TemporaryUsers] AS T
				ON T.UserID = I.CreatedUserID
				LEFT JOIN [dbo].[USR_Profile] AS P
				ON P.UserID = T.UserID
			WHERE I.ApplicationID = @ApplicationID AND I.SenderUserID = @SenderUserID
			GROUP BY LOWER(I.Email)
		) AS X
		LEFT JOIN @Results AS R
		ON R.Email = X.Email
	WHERE R.Email IS NULL
	-- end of Temp User Based Results
	
	
	-- Not Activated Invites
	INSERT INTO @Results (Email, SendDate, UserID, FirstName, LastName, Activated)
	SELECT X.Email, X.SendDate, NULL, NULL, NULL, 0
	FROM (
			SELECT	LOWER(I.Email) AS Email, 
					MAX(I.SendDate) AS SendDate
			FROM [dbo].[USR_Invitations] AS I
			WHERE I.ApplicationID = @ApplicationID AND I.SenderUserID = @SenderUserID
			GROUP BY LOWER(I.Email)
		) AS X
		LEFT JOIN @Results AS R
		ON R.Email = X.Email
	WHERE R.Email IS NULL
	-- Not Activated Invites
	

	SELECT TOP(ISNULL(@Count, 1000000000)) 
		t.UserID AS ReceiverUserID,
		t.FirstName AS ReceiverFirstName,
		t.LastName AS ReceiverLastName,
		t.Email,
		t.SendDate,
		CAST(t.Activated AS bit) AS Activated,
		t.RowNum AS [Order],
		(t.RevRowNum + t.RowNum - 1) AS TotalCount
	FROM(
		SELECT 
			R.UserID,
			R.FirstName,
			R.LastName,
			R.Email,
			R.SendDate,
			R.Activated,
			ROW_NUMBER() OVER (ORDER BY R.SendDate DESC, R.UserID DESC) AS RowNum,
			ROW_NUMBER() OVER (ORDER BY R.SendDate ASC, R.UserID ASC) AS RevRowNum
		FROM @Results AS R
	) AS t
	WHERE t.RowNum >= ISNULL(@LowerBoundary,0)
	ORDER BY t.RowNum ASC
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_GetCurrentInvitations]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_GetCurrentInvitations]
GO

CREATE PROCEDURE [dbo].[USR_GetCurrentInvitations]
	@UserID			uniqueidentifier,
	@Email			nvarchar(255)
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT AppIDs.ApplicationID AS ID
	FROM (
			SELECT DISTINCT I.ApplicationID
			FROM [dbo].[USR_Invitations] AS I
			WHERE LOWER(I.Email) = LOWER(@Email)
		) AS AppIDs
		LEFT JOIN [dbo].[USR_UserApplications] AS A
		ON A.ApplicationID = AppIDs.ApplicationID AND A.UserID = @UserID
	WHERE A.UserID IS NULL
	

END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_GetInvitationApplicationID]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_GetInvitationApplicationID]
GO

CREATE PROCEDURE [dbo].[USR_GetInvitationApplicationID]
	@InvitationID		uniqueidentifier,
	@CheckIfNotUsed		bit
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON

	SELECT I.ApplicationID AS ID
	FROM [dbo].[USR_Invitations] AS I
	WHERE I.ID = @InvitationID AND (ISNULL(@CheckIfNotUsed, 0) = 0 OR I.CreatedUserID IS NULL)
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_SetPassResetTicket]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_SetPassResetTicket]
GO

CREATE PROCEDURE [dbo].[USR_SetPassResetTicket]
	@UserID			UNIQUEIDENTIFIER,
    @Ticket			UNIQUEIDENTIFIER
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	IF EXISTS(
		SELECT TOP(1) * 
		FROM [dbo].[USR_PassResetTickets] 
		WHERE UserID = @UserID
	) BEGIN
		UPDATE [dbo].[USR_PassResetTickets]
			SET Ticket = @Ticket
		WHERE UserID = @UserID
	END
	ELSE BEGIN
		INSERT INTO [dbo].[USR_PassResetTickets](
			UserID,
			Ticket
		)
		VALUES(
			@UserID,
			@Ticket
		)
	END
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_GetPassResetTicket]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_GetPassResetTicket]
GO

CREATE PROCEDURE [dbo].[USR_GetPassResetTicket]
	@UserID			UNIQUEIDENTIFIER
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT Ticket AS ID
	FROM [dbo].[USR_PassResetTickets]
	WHERE UserID = @UserID
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_P_SetFirstAndLastName]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_P_SetFirstAndLastName]
GO

CREATE PROCEDURE [dbo].[USR_P_SetFirstAndLastName]
    @UserID 		uniqueidentifier,
    @FirstName		nvarchar(255),
    @LastName		nvarchar(255),
    @_Result		int output
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SET @FirstName = [dbo].[GFN_VerifyString](@FirstName)
	SET @LastName = [dbo].[GFN_VerifyString](@LastName)

	IF EXISTS(SELECT TOP(1) * FROM [dbo].[USR_Profile] WHERE UserID = @UserID) BEGIN
		UPDATE [dbo].[USR_Profile]
			SET FirstName = @FirstName,
				LastName = @LastName
		WHERE UserId = @UserID
	END
	ELSE BEGIN
		INSERT INTO [dbo].[USR_Profile](
			UserID,
			FirstName,
			LastName
		)
		VALUES(
			@UserID,
			@FirstName,
			@LastName
		)
	END
	
	SET @_Result = @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_SetFirstAndLastName]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_SetFirstAndLastName]
GO

CREATE PROCEDURE [dbo].[USR_SetFirstAndLastName]
    @UserID 		uniqueidentifier,
    @FirstName		nvarchar(255),
    @LastName		nvarchar(255)
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @_Result int
	
	EXEC [dbo].[USR_P_SetFirstAndLastName] @UserID, @FirstName, @LastName, @_Result output

	SELECT @_Result
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_SetUserName]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_SetUserName]
GO

CREATE PROCEDURE [dbo].[USR_SetUserName]
	@ApplicationID	uniqueidentifier,
    @UserID 		uniqueidentifier,
    @UserName		nvarchar(255)
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @Exists bit = 0;

	IF @ApplicationID IS NULL BEGIN 
		SET @Exists = (
			SELECT TOP(1) CAST(1 AS bit) 
			FROM [dbo].[USR_View_Users]
			WHERE LoweredUserName = LOWER(@UserName) AND UserId <> @UserID
		)
	END
	ELSE BEGIN
		SET @Exists = (
			SELECT TOP(1) CAST(1 AS bit) 
			FROM [dbo].[Users_Normal]
			WHERE ApplicationID = @ApplicationID AND 
				LoweredUserName = LOWER(@UserName) AND UserId <> @UserID
		)
	END

	IF @UserName IS NOT NULL AND @UserName <> N'' AND ISNULL(@Exists, 0) = 0 BEGIN
		UPDATE [dbo].[aspnet_Users]
			SET UserName = @UserName,
				LoweredUserName = LOWER(@UserName)
		WHERE UserId = @UserID
		
		SELECT @@ROWCOUNT
	END
	ELSE BEGIN
		SELECT -1
	END
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_SetPassword]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_SetPassword]
GO

CREATE PROCEDURE [dbo].[USR_SetPassword]
    @UserID 			uniqueidentifier,
    @Password			nvarchar(255),
    @PasswordSalt		nvarchar(255),
    @EncryptedPassword	nvarchar(255),
    @AutoGenerated		bit,
    @Now				datetime
WITH ENCRYPTION
AS
BEGIN TRANSACTION
	SET NOCOUNT ON
	
	UPDATE [dbo].[aspnet_Membership]
		SET [Password] = @Password,
			PasswordSalt = @PasswordSalt,
			IsLockedOut = 0
	WHERE UserId = @UserID
	
	IF @@ROWCOUNT <= 0 BEGIN
		SELECT -1
		ROLLBACK TRANSACTION
		RETURN
	END
	
	DECLARE @_Result int
	
	EXEC [dbo].[USR_P_SavePasswordHistory] @UserID, @EncryptedPassword, @AutoGenerated, @Now, @_Result output
	
	IF @_Result <= 0 BEGIN
		SELECT -1
		ROLLBACK TRANSACTION
		RETURN
	END
	
	SELECT 1
COMMIT TRANSACTION

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_Locked]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_Locked]
GO

CREATE PROCEDURE [dbo].[USR_Locked]
    @UserID 		uniqueidentifier,
    @Locked			bit,
    @Now			datetime	
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	IF @Locked IS NULL BEGIN
		SELECT TOP(1) M.UserId AS UserID, M.IsLockedOut, M.LastLockoutDate, M.IsApproved
		FROM [dbo].[aspnet_Membership] AS M
		WHERE M.UserID = @UserID
	END
	ELSE BEGIN
		UPDATE M
			SET IsLockedOut = @Locked,
				LastLockoutDate = CASE WHEN @Locked = 1 THEN @Now ELSE LastLockoutDate END,
				FailedPasswordAttemptCount = 
					(CASE WHEN M.IsLockedOut = @Locked THEN FailedPasswordAttemptCount ELSE 0 END)
		FROM [dbo].[aspnet_Membership] AS M
		WHERE M.UserID = @UserID
		
		SELECT @@ROWCOUNT
	END
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_LoginAttempt]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_LoginAttempt]
GO

CREATE PROCEDURE [dbo].[USR_LoginAttempt]
    @UserID 		uniqueidentifier,
    @Succeed		bit
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE M
		SET FailedPasswordAttemptCount = 
				(CASE WHEN ISNULL(@Succeed, 0) = 0 THEN ISNULL(FailedPasswordAttemptCount, 0) + 1 ELSE 0 END)
	FROM [dbo].[aspnet_Membership] AS M
	WHERE M.UserID = @UserID
		
		
	SELECT TOP(1) 
		(CASE WHEN M.FailedPasswordAttemptCount <= 0 THEN 1 ELSE M.FailedPasswordAttemptCount END) AS Value
	FROM [dbo].[aspnet_Membership] AS M
	WHERE M.UserID = @UserID
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_IsApproved]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_IsApproved]
GO

CREATE PROCEDURE [dbo].[USR_IsApproved]
	@ApplicationID	uniqueidentifier,
    @UserID 		uniqueidentifier,
    @IsApproved		bit
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	IF @IsApproved IS NULL BEGIN
		SELECT TOP(1) IsApproved
		FROM [dbo].[aspnet_Membership] AS M
		WHERE UserId = @UserID
	END
	ELSE BEGIN
		UPDATE [dbo].[aspnet_Membership]
			SET IsApproved = @IsApproved
		WHERE UserId = @UserID
		
		SELECT @@ROWCOUNT
	END
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_SetBirthday]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_SetBirthday]
GO

CREATE PROCEDURE [dbo].[USR_SetBirthday]
	@ApplicationID	uniqueidentifier,
    @UserID 		uniqueidentifier,
    @Birthday		datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[USR_Profile]
		SET BirthDay = @Birthday
	WHERE UserId = @UserID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_SetAboutMe]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_SetAboutMe]
GO

CREATE PROCEDURE [dbo].[USR_SetAboutMe]
    @UserID uniqueidentifier,
    @Text	nvarchar(2000)
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SET @Text = [dbo].[GFN_VerifyString](@Text)
	
	UPDATE [dbo].[USR_Profile]
		SET AboutMe = @Text
	WHERE  UserID = @UserID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_SetCity]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_SetCity]
GO

CREATE PROCEDURE [dbo].[USR_SetCity]
    @UserID uniqueidentifier,
    @City	nvarchar(255)
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SET @City = [dbo].[GFN_VerifyString](@City)
	
	UPDATE [dbo].[USR_Profile]
		SET City = @City
	WHERE  UserID = @UserID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_SetOrganization]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_SetOrganization]
GO

CREATE PROCEDURE [dbo].[USR_SetOrganization]
	@ApplicationID	uniqueidentifier,
    @UserID 		uniqueidentifier,
    @Organization	nvarchar(255)
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SET @Organization = [dbo].[GFN_VerifyString](@Organization)
	
	UPDATE [dbo].[USR_UserApplications]
		SET Organization = @Organization
	WHERE  ApplicationID = @ApplicationID AND UserID = @UserID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_SetDepartment]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_SetDepartment]
GO

CREATE PROCEDURE [dbo].[USR_SetDepartment]
	@ApplicationID	uniqueidentifier,
    @UserID 		uniqueidentifier,
    @Department		nvarchar(255)
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SET @Department = [dbo].[GFN_VerifyString](@Department)
	
	UPDATE [dbo].[USR_UserApplications]
		SET Department = @Department
	WHERE  ApplicationID = @ApplicationID AND UserID = @UserID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_SetJobTitle]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_SetJobTitle]
GO

CREATE PROCEDURE [dbo].[USR_SetJobTitle]
	@ApplicationID	uniqueidentifier,
    @UserID 		uniqueidentifier,
    @JobTitle		nvarchar(255)
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SET @JobTitle = [dbo].[GFN_VerifyString](@JobTitle)
	
	UPDATE [dbo].[USR_UserApplications]
		SET JobTitle = @JobTitle
	WHERE  ApplicationID = @ApplicationID AND UserID = @UserID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_SetEmploymentType]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_SetEmploymentType]
GO

CREATE PROCEDURE [dbo].[USR_SetEmploymentType]
	@ApplicationID	uniqueidentifier,
    @UserID 		uniqueidentifier,
    @EmploymentType	varchar(50)
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[USR_UserApplications]
		SET EmploymentType = @EmploymentType
	WHERE ApplicationID = @ApplicationID AND UserID = @UserID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_SetPhoneNumber]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_SetPhoneNumber]
GO

CREATE PROCEDURE [dbo].[USR_SetPhoneNumber]
	@NumberID			uniqueidentifier,
    @UserID 			uniqueidentifier,
    @PhoneNumber		varchar(50),
    @PhoneNumberType	varchar(20),
    @CreatorUserID		uniqueidentifier,
    @CreationDate		datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	INSERT INTO USR_PhoneNumbers(
		NumberID,
		PhoneNumber,
		UserID,
		CreatorUserID,
		CreationDate,
		PhoneType, 
		Deleted
	)
	VALUES (
		@NumberID,
		@PhoneNumber,
		@UserID,
		@CreatorUserID,
		@CreationDate,
		@PhoneNumberType,
		0
	)
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_GetPhoneNumbers]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_GetPhoneNumbers]
GO

CREATE PROCEDURE [dbo].[USR_GetPhoneNumbers]
	@UserID			uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT	UserID,
			NumberID, 
			PhoneNumber, 
			PhoneType
	FROM [dbo].[USR_PhoneNumbers]
	WHERE UserID = @UserID AND Deleted = 0
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_GetPhoneNumber]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_GetPhoneNumber]
GO

CREATE PROCEDURE [dbo].[USR_GetPhoneNumber]
	@NumberID		uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT	UserID,
			NumberID, 
			PhoneNumber, 
			PhoneType
	FROM [dbo].[USR_PhoneNumbers]
	WHERE NumberID = @NumberID
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_EditPhoneNumber]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_EditPhoneNumber]
GO

CREATE PROCEDURE [dbo].[USR_EditPhoneNumber]
	@NumberID				UNIQUEIDENTIFIER,
	@PhoneNumber			VARCHAR(50),
	@PhoneType				VARCHAR(20),
	@LastModifierUserID		UNIQUEIDENTIFIER,
	@LastModificationDate	DATETIME
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[USR_PhoneNumbers]
		SET PhoneNumber = @PhoneNumber,
			PhoneType = @PhoneType,
			LastModifierUserID = @LastModifierUserID,
			LastModificationDate = @LastModificationDate
	WHERE NumberID = @NumberID AND Deleted = 0
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_RemovePhoneNumber]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_RemovePhoneNumber]
GO

CREATE PROCEDURE [dbo].[USR_RemovePhoneNumber]
	@NumberID				UNIQUEIDENTIFIER,
	@LastModifierUserID		UNIQUEIDENTIFIER,
	@LastModificationDate	DATETIME
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[USR_Profile]
		SET MainPhoneID = null
	WHERE MainPhoneID = @NumberID
	
	UPDATE [dbo].[USR_PhoneNumbers]
		SET Deleted = 1,
			LastModifierUserID = @LastModifierUserID,
			LastModificationDate = @LastModificationDate
	WHERE NumberID = @NumberID AND Deleted = 0
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_SetMainPhone]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_SetMainPhone]
GO

CREATE PROCEDURE [dbo].[USR_SetMainPhone]
	@NumberID		UNIQUEIDENTIFIER,
	@UserID			UNIQUEIDENTIFIER
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[USR_Profile]
		SET MainPhoneID = @NumberID
	WHERE UserID = @UserID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_GetMainPhone]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_GetMainPhone]
GO

CREATE PROCEDURE [dbo].[USR_GetMainPhone]
	@UserID			UNIQUEIDENTIFIER
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT MainPhoneID AS ID
	FROM [dbo].[USR_Profile]
	WHERE UserID = @UserID
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_SetEmailAddress]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_SetEmailAddress]
GO

CREATE PROCEDURE [dbo].[USR_SetEmailAddress]
	@EmailID		uniqueidentifier,
    @UserID 		uniqueidentifier,
    @EmailAddress	varchar(100),
	@IsMainEmail	bit,
	@CreatorUserID	uniqueidentifier,
	@CreationDate	datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	INSERT INTO USR_EmailAddresses(
		EmailID,
		EmailAddress,
		UserID,
		CreatorUserID,
		CreationDate,
		Deleted
	)
	VALUES (
		@EmailID,
		@EmailAddress,
		@UserID,
		@CreatorUserID,
		@CreationDate,
		0
	)
	
	DECLARE @Result int = @@ROWCOUNT
	
	IF @IsMainEmail = 1 BEGIN
		UPDATE [dbo].[USR_Profile]
			SET MainEmailID = @EmailID
		WHERE UserID = @UserID
	END

	SELECT @Result
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_GetEmailAddresses]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_GetEmailAddresses]
GO

CREATE PROCEDURE [dbo].[USR_GetEmailAddresses]
	@UserID			uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT	UserID,
			EmailID, 
			EmailAddress
	FROM [dbo].[USR_EmailAddresses]
	WHERE UserID = @UserID AND Deleted = 0
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_GetEmailAddress]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_GetEmailAddress]
GO

CREATE PROCEDURE [dbo].[USR_GetEmailAddress]
	@EmailID		UNIQUEIDENTIFIER
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT	UserID,
			EmailID, 
			EmailAddress
	FROM [dbo].[USR_EmailAddresses]
	WHERE EmailID = @EmailID
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_GetEmailOwners]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_GetEmailOwners]
GO

CREATE PROCEDURE [dbo].[USR_GetEmailOwners]
	@strEmails		varchar(max),
    @delimiter		char
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @Emails StringTableType
	
	INSERT INTO @Emails
	SELECT Ref.Value 
	FROM [dbo].[GFN_StrToStringTable](@strEmails, @delimiter) AS Ref

	SELECT	EA.UserID, 
			EA.EmailID, 
			EA.EmailAddress,
			CAST(CASE WHEN USR.UserID IS NULL THEN 0 ELSE 1 END AS bit) AS IsMain
	FROM @Emails AS E
		INNER JOIN [dbo].[USR_EmailAddresses] AS EA
		ON E.Value = EA.EmailAddress
		LEFT JOIN [dbo].[USR_Profile] AS USR
		ON USR.UserID = EA.UserID AND USR.MainEmailID = EA.EmailID
	WHERE EA.Deleted = 0
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_GetPhoneOwners]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_GetPhoneOwners]
GO

CREATE PROCEDURE [dbo].[USR_GetPhoneOwners]
	@strNumbers		varchar(max),
    @delimiter		char
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @Numbers StringTableType
	
	INSERT INTO @Numbers
	SELECT Ref.Value 
	FROM [dbo].[GFN_StrToStringTable](@strNumbers, @delimiter) AS Ref

	SELECT	PN.UserID, 
			PN.NumberID, 
			PN.PhoneNumber,
			CAST(CASE WHEN USR.UserID IS NULL THEN 0 ELSE 1 END AS bit) AS IsMain
	FROM @Numbers AS N
		INNER JOIN [dbo].[USR_PhoneNumbers] AS PN
		ON N.Value = PN.PhoneNumber
		LEFT JOIN [dbo].[USR_Profile] AS USR
		ON USR.UserID = PN.UserID AND USR.MainPhoneID = PN.NumberID
	WHERE PN.Deleted = 0
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_GetNotExistingEmails]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_GetNotExistingEmails]
GO

CREATE PROCEDURE [dbo].[USR_GetNotExistingEmails]
	@ApplicationID	uniqueidentifier,
    @EmailsTemp		StringTableType readonly
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @Emails StringTableType
	INSERT INTO @Emails SELECT * FROM @EmailsTemp
	
	IF @ApplicationID IS NULL BEGIN
		SELECT E.Value
		FROM @Emails AS E
			LEFT JOIN [dbo].[USR_EmailAddresses] AS A
			INNER JOIN [dbo].[USR_View_Users] AS UN
			ON UN.UserID = A.UserID
			ON LOWER(E.[Value]) = LOWER(A.EmailAddress) AND A.Deleted = 0
		WHERE A.EmailID IS NULL
	END
	ELSE BEGIN
		SELECT E.Value
		FROM @Emails AS E
			LEFT JOIN [dbo].[USR_EmailAddresses] AS A
			INNER JOIN [dbo].[Users_Normal] AS UN
			ON UN.ApplicationID = @ApplicationID AND UN.UserID = A.UserID
			ON LOWER(E.[Value]) = LOWER(A.EmailAddress) AND A.Deleted = 0
		WHERE A.EmailID IS NULL
	END
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_EditEmailAddress]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_EditEmailAddress]
GO

CREATE PROCEDURE [dbo].[USR_EditEmailAddress]
	@EmailID				UNIQUEIDENTIFIER,
	@Address				VARCHAR(100),
	@LastModifierUserID		UNIQUEIDENTIFIER,
	@LastModificationDate	DATETIME
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE USR_EmailAddresses
		SET EmailAddress = @Address,
			LastModifierUserID = @LastModifierUserID,
			LastModificationDate = @LastModificationDate
	WHERE EmailID = @EmailID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_RemoveEmailAddress]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_RemoveEmailAddress]
GO

CREATE PROCEDURE [dbo].[USR_RemoveEmailAddress]
	@EmailID				UNIQUEIDENTIFIER,
	@LastModifierUserID		UNIQUEIDENTIFIER,
	@LastModificationDate	DATETIME
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[USR_Profile]
		SET MainEmailID = null
	WHERE MainEmailID = @EmailID
	
	UPDATE [dbo].[USR_EmailAddresses]
		SET Deleted = 1,
			LastModifierUserID = @LastModifierUserID,
			LastModificationDate = @LastModificationDate
	WHERE EmailID = @EmailID AND Deleted = 0
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_SetMainEmail]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_SetMainEmail]
GO

CREATE PROCEDURE [dbo].[USR_SetMainEmail]
	@EmailID		UNIQUEIDENTIFIER,
	@UserID			UNIQUEIDENTIFIER
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[USR_Profile]
		SET MainEmailID = @EmailID
	WHERE UserID = @UserID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_GetMainEmail]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_GetMainEmail]
GO

CREATE PROCEDURE [dbo].[USR_GetMainEmail]
	@UserID			UNIQUEIDENTIFIER
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT MainEmailID AS ID
	FROM [dbo].[USR_Profile]
	WHERE UserID = @UserID
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_GetUsersMainEmail]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_GetUsersMainEmail]
GO

CREATE PROCEDURE [dbo].[USR_GetUsersMainEmail]
    @strUserIDs		varchar(max),
    @delimiter		char
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @UserIDs GuidTableType
	INSERT INTO @UserIDs
	SELECT Ref.Value FROM [dbo].[GFN_StrToGuidTable](@strUserIDs, @delimiter) AS Ref
	
	SELECT EA.EmailID, UN.UserID, EA.EmailAddress
	FROM @UserIDs AS UIDs
		INNER JOIN [dbo].[USR_Profile] AS UN
		ON un.UserID = UIDs.Value
		INNER JOIN [dbo].[USR_EmailAddresses] AS EA
		ON EA.EmailID = UN.MainEmailID
	WHERE EA.Deleted = 0 
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_GetUsersMainPhone]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_GetUsersMainPhone]
GO

CREATE PROCEDURE [dbo].[USR_GetUsersMainPhone]
    @strUserIDs		varchar(max),
    @delimiter		char
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @UserIDs GuidTableType
	INSERT INTO @UserIDs
	SELECT Ref.Value FROM [dbo].[GFN_StrToGuidTable](@strUserIDs, @delimiter) AS Ref
	
	SELECT PN.NumberID, UN.UserID, PN.PhoneNumber, PN.PhoneType
	FROM @UserIDs AS UIDs
		INNER JOIN [dbo].[USR_Profile] AS UN
		ON UN.UserID = UIDs.Value
		INNER JOIN [dbo].[USR_PhoneNumbers] AS PN
		ON PN.NumberID = UN.MainPhoneID
	WHERE PN.Deleted = 0
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_GetJobExperiences]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_GetJobExperiences]
GO

CREATE PROCEDURE [dbo].[USR_GetJobExperiences]
	@ApplicationID uniqueidentifier,
    @userId			UNIQUEIDENTIFIER
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT 
		je.JobID, 
		je.UserID,
		je.Title, 
		je.Employer,
		je.StartDate,
		je.EndDate
	FROM [dbo].[USR_JobExperiences] AS je
	WHERE je.ApplicationID = @ApplicationID AND je.UserID = @userId AND Deleted = 0
	ORDER BY je.StartDate DESC
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_GetJobExperience]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_GetJobExperience]
GO

CREATE PROCEDURE [dbo].[USR_GetJobExperience]
	@ApplicationID	uniqueidentifier,
    @JobID			UNIQUEIDENTIFIER
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT 
		je.JobID, 
		je.UserID,
		je.Title, 
		je.Employer,
		je.StartDate,
		je.EndDate
	FROM [dbo].[USR_JobExperiences] AS je
	WHERE je.ApplicationID = @ApplicationID AND je.JobID = @JobID
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_GetEducationalExperiences]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_GetEducationalExperiences]
GO

CREATE PROCEDURE [dbo].[USR_GetEducationalExperiences]
	@ApplicationID	uniqueidentifier,
    @userId			UNIQUEIDENTIFIER
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT 
		ee.[EducationID],
		ee.[UserID],
		ee.[School],
		ee.[StudyField],
		ee.[Level],
		ee.[StartDate],
		ee.[EndDate],
		ee.[GraduateDegree],
		ee.IsSchool
	FROM [dbo].[USR_EducationalExperiences] AS ee
	WHERE ee.ApplicationID = @ApplicationID AND ee.UserID = @userId AND Deleted = 0
	ORDER BY ee.StartDate DESC
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_GetEducationalExperience]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_GetEducationalExperience]
GO

CREATE PROCEDURE [dbo].[USR_GetEducationalExperience]
	@ApplicationID		uniqueidentifier,
    @EducationID		UNIQUEIDENTIFIER
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT 
		ee.[EducationID],
		ee.[UserID],
		ee.[School],
		ee.[StudyField],
		ee.[Level],
		ee.[StartDate],
		ee.[EndDate],
		ee.[GraduateDegree],
		ee.IsSchool
	FROM [dbo].[USR_EducationalExperiences] AS ee
	WHERE ee.ApplicationID = @ApplicationID AND ee.EducationID = @EducationID
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_GetHonorsAndAwards]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_GetHonorsAndAwards]
GO

CREATE PROCEDURE [dbo].[USR_GetHonorsAndAwards]
	@ApplicationID	uniqueidentifier,
    @userId			UNIQUEIDENTIFIER
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT 
		hnr.ID,
		hnr.UserID,
		hnr.Title,
		hnr.Issuer,
		hnr.Occupation,
		hnr.IssueDate,
		hnr.[Description]
	FROM [dbo].[USR_HonorsAndAwards] AS hnr
	WHERE hnr.ApplicationID = @ApplicationID AND hnr.UserID = @userId AND Deleted = 0
	ORDER BY hnr.IssueDate DESC
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_GetHonorOrAward]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_GetHonorOrAward]
GO

CREATE PROCEDURE [dbo].[USR_GetHonorOrAward]
	@ApplicationID	uniqueidentifier,
    @ID				uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT 
		hnr.ID,
		hnr.UserID,
		hnr.Title,
		hnr.Issuer,
		hnr.Occupation,
		hnr.IssueDate,
		hnr.[Description]
	FROM [dbo].[USR_HonorsAndAwards] AS hnr
	WHERE hnr.ApplicationID = @ApplicationID AND hnr.ID = @ID
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_GetUserLanguages]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_GetUserLanguages]
GO

CREATE PROCEDURE [dbo].[USR_GetUserLanguages]
	@ApplicationID	uniqueidentifier,
    @userId			UNIQUEIDENTIFIER
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT 
		UL.ID,
		UL.UserID,
		LN.LanguageName,
		UL.[Level]
	FROM [dbo].[USR_UserLanguages] AS UL
		INNER JOIN [dbo].[USR_LanguageNames] AS LN
		ON LN.ApplicationID = @ApplicationID AND LN.LanguageID = UL.LanguageID
	WHERE UL.ApplicationID = @ApplicationID AND UL.UserID = @userId AND Deleted = 0
	ORDER BY LN.LanguageName DESC
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_GetUserLanguage]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_GetUserLanguage]
GO

CREATE PROCEDURE [dbo].[USR_GetUserLanguage]
	@ApplicationID	uniqueidentifier,
    @ID				UNIQUEIDENTIFIER
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT 
		UL.ID,
		UL.UserID,
		LN.LanguageName,
		UL.[Level]
	FROM [dbo].[USR_UserLanguages] AS UL
		INNER JOIN [dbo].[USR_LanguageNames] AS LN
		ON LN.ApplicationID = @ApplicationID AND LN.LanguageID = UL.LanguageID
	WHERE UL.ApplicationID = @ApplicationID AND UL.ID = @ID
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_GetLanguages]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_GetLanguages]
GO

CREATE PROCEDURE [dbo].[USR_GetLanguages]
	@ApplicationID		uniqueidentifier,
	@strLanguageIDs		NVARCHAR(MAX),
	@delimiter			CHAR
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @getAll AS BIT
	
	IF(@strLanguageIDs IS NULL) SET @getAll = 1
	ELSE SET @getAll = 0
	
	DECLARE @LanguageIDs GuidTableType
	
	IF(@getAll = 0)
	BEGIN
		INSERT INTO @LanguageIDs
		SELECT Ref.Value FROM [dbo].[GFN_StrToGuidTable](@strLanguageIDs, ISNULL(@delimiter,',')) AS Ref
	END
	
	SELECT LN.LanguageID,
		LN.LanguageName
	FROM [dbo].[USR_LanguageNames] AS LN
		LEFT JOIN @LanguageIDs AS L
		ON LN.LanguageID = L.Value
	WHERE LN.ApplicationID = @ApplicationID AND (@getAll = 1 OR L.Value = LN.LanguageID)
	ORDER BY LN.LanguageName
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_SetJobExperience]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_SetJobExperience]
GO

CREATE PROCEDURE [dbo].[USR_SetJobExperience]
	@ApplicationID	uniqueidentifier,
	@jobId			UNIQUEIDENTIFIER,
    @userId			UNIQUEIDENTIFIER,
    @creatorUserId	UNIQUEIDENTIFIER,
	@creationDate	DATETIME,
    @title			NVARCHAR(256),
    @employer		NVARCHAR(256),
    @startDate		DATETIME,
    @endDate		DATETIME
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	IF EXISTS(
		SELECT TOP(1) * 
		FROM [dbo].[USR_JobExperiences] 
		WHERE ApplicationID = @ApplicationID AND JobID = @jobId
	) BEGIN
		UPDATE [dbo].[USR_JobExperiences]
			SET UserID = @userId,
				Title = @title,
				Employer = @employer,
				StartDate = @startDate,
				EndDate = @endDate
		WHERE ApplicationID = @ApplicationID AND JobID = @jobId
	END
	ELSE BEGIN
		INSERT INTO [dbo].[USR_JobExperiences](
			ApplicationID,
			JobID,
			UserID,
			Title,
			Employer,
			StartDate,
			EndDate,
			CreatorUserID,
			CreationDate,
			Deleted
		)
		VALUES(
			@ApplicationID,
			@jobId,
			@userId,
			@title,
			@employer,
			@startDate,
			@endDate,
			@creatorUserId,
			@creationDate,
			0
		)
	END
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_SetEducationalExperience]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_SetEducationalExperience]
GO

CREATE PROCEDURE [dbo].[USR_SetEducationalExperience]
	@ApplicationID	uniqueidentifier,
	@educationId	UNIQUEIDENTIFIER,
	@userId			UNIQUEIDENTIFIER,
	@creatorUserId	UNIQUEIDENTIFIER,
	@creationDate	DATETIME,
	@school			NVARCHAR(256),
	@studyField		NVARCHAR(256),
	@level			VARCHAR(50),
	@graduateDegree	VARCHAR(50),
	@startDate		DATETIME,
	@endDate		DATETIME,
	@isSchool		BIT
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	IF EXISTS(
		SELECT TOP(1) * 
		FROM [dbo].[USR_EducationalExperiences] 
		WHERE ApplicationID = @ApplicationID AND EducationID = @educationId
	) BEGIN	
		UPDATE [dbo].[USR_EducationalExperiences]
			SET UserID = @userId,
				School = @school,
				StudyField = @studyField,
				[Level] = @level,
				[GraduateDegree] = @graduateDegree,
				StartDate = @startDate,
				EndDate = @endDate,
				CreatorUserID = @creatorUserId,
				CreationDate = @creationDate,
				IsSchool = @isSchool
		WHERE ApplicationID = @ApplicationID AND EducationID = @educationId
	END
	ELSE BEGIN
		INSERT INTO [dbo].[USR_EducationalExperiences](
			ApplicationID,
			EducationID,
			UserID,
			School,
			StudyField,
			[Level],
			[GraduateDegree],
			StartDate,
			EndDate,
			CreatorUserID,
			CreationDate,
			IsSchool,
			Deleted
		)
		VALUES(
			@ApplicationID,
			@educationId,
			@userId,
			@school,
			@studyField,
			@level,
			@graduateDegree,
			@startDate,
			@endDate,
			@creatorUserId,
			@creationDate,
			@isSchool,
			0
		)
	END
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_SetHonorAndAward]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_SetHonorAndAward]
GO

CREATE PROCEDURE [dbo].[USR_SetHonorAndAward]
	@ApplicationID	uniqueidentifier,
	@honorId		UNIQUEIDENTIFIER,
	@userId			UNIQUEIDENTIFIER,
	@creatorUserId	UNIQUEIDENTIFIER,
	@creationDate	DATETIME,
	@title			NVARCHAR(512),
	@occupation		NVARCHAR(512),
	@issuer			NVARCHAR(512),
	@issueDate		DATETIME,
	@description	NVARCHAR(MAX)
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	IF EXISTS(
		SELECT TOP(1) * 
		FROM [dbo].[USR_HonorsAndAwards] 
		WHERE ApplicationID = @ApplicationID AND ID = @honorId
	) BEGIN
		UPDATE [dbo].[USR_HonorsAndAwards]
			SET UserID = @userId,
				Title = @title,
				Occupation = @occupation,
				Issuer = @issuer,
				IssueDate = @issueDate,
				[Description] = @description,
				CreatorUserID = @creatorUserId,
				CreationDate = @creationDate
		WHERE ApplicationID = @ApplicationID AND ID = @honorId
	END
	ELSE BEGIN
		INSERT INTO [dbo].[USR_HonorsAndAwards](
			ApplicationID,
			ID,
			UserID,
			Title,
			Occupation,
			Issuer,
			IssueDate,
			[Description],
			CreatorUserID,
			CreationDate,
			Deleted
		)
		VALUES(
			@ApplicationID,
			@honorId,
			@userId,
			@title,
			@occupation,
			@issuer,
			@issueDate,
			@description,
			@creatorUserId,
			@creationDate,
			0
		)
	END
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_SetLanguage]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_SetLanguage]
GO

CREATE PROCEDURE [dbo].[USR_SetLanguage]
	@ApplicationID	uniqueidentifier,
	@id				UNIQUEIDENTIFIER,
	@languageName	NVARCHAR(256),
	@userId			UNIQUEIDENTIFIER,
	@creatorUserId	UNIQUEIDENTIFIER,
	@creationDate	DATETIME,
	@level			NVARCHAR(50)
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SET @languageName = [dbo].[GFN_VerifyString](@languageName)
	
	DECLARE @languageId UNIQUEIDENTIFIER = (
		SELECT LanguageID 
		FROM [dbo].[USR_LanguageNames] 
		WHERE ApplicationID = @ApplicationID AND LanguageName = @languageName
	)
	
	IF (@languageId IS NULL) BEGIN
		SET @languageId = NEWID()
		
		INSERT INTO [dbo].[USR_LanguageNames](
			ApplicationID,
			LanguageID,
			LanguageName
		)
		VALUES(
			@ApplicationID,
			@languageId,
			@languageName
		)
	END
		
	IF EXISTS(
		SELECT TOP(1) * 
		FROM [dbo].[USR_UserLanguages] 
		WHERE ApplicationID = @ApplicationID AND ID = @id
	) BEGIN
		UPDATE [dbo].[USR_UserLanguages]
			SET UserID = @userId,
				LanguageID = @languageId,
				[Level]	= @level,
				CreatorUserID = @creatorUserId,
				CreationDate = @creationDate
		WHERE ApplicationID = @ApplicationID AND ID = @id
	END
	ELSE BEGIN
		INSERT INTO [dbo].[USR_UserLanguages](
			ApplicationID,
			ID,
			LanguageID,
			UserID,
			[Level],
			CreatorUserID,
			CreationDate,
			Deleted
		)
		VALUES(
			@ApplicationID,
			@id,
			@languageId,
			@userId,
			@level,
			@creatorUserId,
			@creationDate,
			0
		)
	ENd
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_RemoveJobExperience]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_RemoveJobExperience]
GO

CREATE PROCEDURE [dbo].[USR_RemoveJobExperience]
	@ApplicationID	uniqueidentifier,
	@jobID			UNIQUEIDENTIFIER
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[USR_JobExperiences]
		SET Deleted = 1
	WHERE ApplicationID = @ApplicationID AND JobID = @jobID AND Deleted = 0
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_RemoveEducationalExperience]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_RemoveEducationalExperience]
GO

CREATE PROCEDURE [dbo].[USR_RemoveEducationalExperience]
	@ApplicationID	uniqueidentifier,
	@educationID	UNIQUEIDENTIFIER
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[USR_EducationalExperiences]
		SET Deleted = 1
	WHERE ApplicationID = @ApplicationID AND EducationID = @educationID AND Deleted = 0
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_RemoveHonorAndAward]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_RemoveHonorAndAward]
GO

CREATE PROCEDURE [dbo].[USR_RemoveHonorAndAward]
	@ApplicationID	uniqueidentifier,
	@honorID		UNIQUEIDENTIFIER
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[USR_HonorsAndAwards]
		SET Deleted = 1
	WHERE ApplicationID = @ApplicationID AND ID = @honorID AND Deleted = 0
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_RemoveLanguage]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_RemoveLanguage]
GO

CREATE PROCEDURE [dbo].[USR_RemoveLanguage]
	@ApplicationID	uniqueidentifier,
	@id				UNIQUEIDENTIFIER
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[USR_UserLanguages]
		SET Deleted = 1
	WHERE ApplicationID = @ApplicationID AND ID = @id AND Deleted = 0
	
	SELECT @@ROWCOUNT
END

GO

-- end of Profile


-- User Groups

IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_CreateUserGroup]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_CreateUserGroup]
GO

CREATE PROCEDURE [dbo].[USR_CreateUserGroup]
	@ApplicationID	uniqueidentifier,
	@GroupID		uniqueidentifier,
	@Title			nvarchar(512),
	@Description	nvarchar(2000),
	@CreatorUserID	uniqueidentifier,
	@Now			datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SET @Title = [dbo].[GFN_VerifyString](@Title)
	SET @Description = [dbo].[GFN_VerifyString](@Description)
	
	INSERT [dbo].[USR_UserGroups] (
		ApplicationID,
		GroupID,
		Title,
		[Description],
		CreatorUserID,
		CreationDate,
		Deleted
	)
	VALUES (
		@ApplicationID,
		@GroupID,
		@Title,
		@Description,
		@CreatorUserID,
		@Now,
		0
	)
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_ModifyUserGroup]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_ModifyUserGroup]
GO

CREATE PROCEDURE [dbo].[USR_ModifyUserGroup]
	@ApplicationID		uniqueidentifier,
	@GroupID			uniqueidentifier,
	@Title				nvarchar(512),
	@Description		nvarchar(2000),
	@LastModifierUserID	uniqueidentifier,
	@Now				datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SET @Title = [dbo].[GFN_VerifyString](@Title)
	SET @Description = [dbo].[GFN_VerifyString](@Description)
	
	UPDATE [dbo].[USR_UserGroups]
		SET Title = @Title,
			[Description] = @Description,
			LastModifierUserID = @LastModifierUserID,
			LastModificationDate = @Now
	WHERE ApplicationID = @ApplicationID AND GroupID = @GroupID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_RemoveUserGroup]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_RemoveUserGroup]
GO

CREATE PROCEDURE [dbo].[USR_RemoveUserGroup]
	@ApplicationID		uniqueidentifier,
	@GroupID			uniqueidentifier,
	@LastModifierUserID	uniqueidentifier,
	@Now				datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[USR_UserGroups]
		SET Deleted = 1,
			LastModifierUserID = @LastModifierUserID,
			LastModificationDate = @Now
	WHERE ApplicationID = @ApplicationID AND GroupID = @GroupID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_AddUserGroupMembers]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_AddUserGroupMembers]
GO

CREATE PROCEDURE [dbo].[USR_AddUserGroupMembers]
	@ApplicationID		uniqueidentifier,
	@GroupID			uniqueidentifier,
	@strUserIDs			varchar(max),
	@delimiter			char,
	@CurrentUserID		uniqueidentifier,
	@Now				datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @UserIDs GuidTableType
	
	INSERT INTO @UserIDs (Value)
	SELECT DISTINCT Ref.Value
	FROM [dbo].[GFN_StrToGuidTable](@strUserIDs, @delimiter) AS Ref
	
	DECLARE @ChangedCount int = 0
	
	UPDATE M
		SET Deleted = 0,
			LastModifierUserID = @CurrentUserID,
			LastModificationDate = @Now
	FROM @UserIDs AS U
		INNER JOIN [dbo].[USR_UserGroupMembers] AS M
		ON M.UserID = U.Value
	WHERE M.ApplicationID = @ApplicationID AND M.GroupID = @GroupID
		
	SET @ChangedCount = @@ROWCOUNT
	
	INSERT INTO [dbo].[USR_UserGroupMembers] (
		ApplicationID,
		GroupID,
		UserID,
		CreatorUserID,
		CreationDate,
		Deleted
	)
	SELECT @ApplicationID, @GroupID, U.Value, @CurrentUserID, @Now, 0
	FROM @UserIDs AS U
		LEFT JOIN [dbo].[USR_UserGroupMembers] AS M
		ON M.ApplicationID = @ApplicationID AND M.GroupID = @GroupID AND M.UserID = U.Value
	WHERE M.GroupID IS NULL
	
	SELECT @@ROWCOUNT + @ChangedCount
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_RemoveUserGroupMembers]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_RemoveUserGroupMembers]
GO

CREATE PROCEDURE [dbo].[USR_RemoveUserGroupMembers]
	@ApplicationID		uniqueidentifier,
	@GroupID			uniqueidentifier,
	@strUserIDs			varchar(max),
	@delimiter			char,
	@CurrentUserID		uniqueidentifier,
	@Now				datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @UserIDs GuidTableType
	
	INSERT INTO @UserIDs (Value)
	SELECT DISTINCT Ref.Value
	FROM [dbo].[GFN_StrToGuidTable](@strUserIDs, @delimiter) AS Ref
	
	DECLARE @ChangedCount int = 0
	
	UPDATE M
		SET Deleted = 1,
			LastModifierUserID = @CurrentUserID,
			LastModificationDate = @Now
	FROM @UserIDs AS U
		INNER JOIN [dbo].[USR_UserGroupMembers] AS M
		ON M.UserID = U.Value
	WHERE M.ApplicationID = @ApplicationID AND M.GroupID = @GroupID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_SetUserGroupPermission]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_SetUserGroupPermission]
GO

CREATE PROCEDURE [dbo].[USR_SetUserGroupPermission]
	@ApplicationID		uniqueidentifier,
	@GroupID			uniqueidentifier,
	@RoleID				uniqueidentifier,
	@CurrentUserID		uniqueidentifier,
	@Now				datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	IF EXISTS(
		SELECT TOP(1) *
		FROM [dbo].[USR_UserGroupPermissions]
		WHERE ApplicationID = @ApplicationID AND GroupID = @GroupID AND RoleID = @RoleID
	) BEGIN
		UPDATE [dbo].[USR_UserGroupPermissions]
			SET Deleted = 0,
				LastModifierUserID = @CurrentUserID,
				LastModificationDate = @Now
		WHERE ApplicationID = @ApplicationID AND GroupID = @GroupID AND RoleID = @RoleID
	END
	ELSE BEGIN
		INSERT INTO [dbo].[USR_UserGroupPermissions] (
			ApplicationID,
			GroupID,
			RoleID,
			CreatorUserID,
			CreationDate,
			Deleted
		)
		VALUES (
			@ApplicationID,
			@GroupID,
			@RoleID,
			@CurrentUserID,
			@Now,
			0
		)
	END
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_UnsetUserGroupPermission]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_UnsetUserGroupPermission]
GO

CREATE PROCEDURE [dbo].[USR_UnsetUserGroupPermission]
	@ApplicationID		uniqueidentifier,
	@GroupID			uniqueidentifier,
	@RoleID				uniqueidentifier,
	@CurrentUserID		uniqueidentifier,
	@Now				datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[USR_UserGroupPermissions]
		SET Deleted = 1,
			LastModifierUserID = @CurrentUserID,
			LastModificationDate = @Now
	WHERE ApplicationID = @ApplicationID AND GroupID = @GroupID AND RoleID = @RoleID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_GetUserGroups]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_GetUserGroups]
GO

CREATE PROCEDURE [dbo].[USR_GetUserGroups]
	@ApplicationID		uniqueidentifier,
	@strGroupIDs		varchar(max),
	@delimiter			char
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @GroupIDs GuidTableType
	
	INSERT INTO @GroupIDs (Value)
	SELECT DISTINCT Ref.Value
	FROM [dbo].[GFN_StrToGuidTable](@strGroupIDs, @delimiter) AS Ref
	
	DECLARE @GroupsCount int = (SELECT COUNT(*) FROM @GroupIDs)
	
	SELECT	G.GroupID,
			G.Title,
			G.[Description]
	FROM [dbo].[USR_UserGroups] AS G
	WHERE G.ApplicationID = @ApplicationID AND 
		(@GroupsCount = 0 OR G.GroupID IN (SELECT Ref.Value FROM @GroupIDs AS Ref)) AND
		G.Deleted = 0
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_GetUserGroupMembers]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_GetUserGroupMembers]
GO

CREATE PROCEDURE [dbo].[USR_GetUserGroupMembers]
	@ApplicationID		uniqueidentifier,
	@GroupID			uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @UserIDs KeyLessGuidTableType
	
	INSERT INTO @UserIDs (Value)
	SELECT DISTINCT M.UserID
	FROM [dbo].[USR_UserGroups] AS G
		INNER JOIN [dbo].[USR_UserGroupMembers] AS M
		ON M.ApplicationID = @ApplicationID AND M.GroupID = G.GroupID
		INNER JOIN [dbo].[Users_Normal] AS UN
		ON UN.ApplicationID = @ApplicationID AND UN.UserID = M.UserID
	WHERE G.ApplicationID = @ApplicationID AND G.GroupID = @GroupID AND
		M.Deleted = 0 AND UN.IsApproved = 1
		
	EXEC [dbo].[USR_P_GetUsersByIDs] @ApplicationID, @UserIDs
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_P_GetAccessRolesByIDs]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_P_GetAccessRolesByIDs]
GO

CREATE PROCEDURE [dbo].[USR_P_GetAccessRolesByIDs]
	@ApplicationID	uniqueidentifier,
	@RoleIDsTemp	GuidTableType readonly
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @RoleIDs GuidTableType
	INSERT INTO @RoleIDs SELECT * FROM @RoleIDsTemp
	
	SELECT A.RoleID, A.Name, A.Title
	FROM @RoleIDs AS R
		INNER JOIN [dbo].[USR_AccessRoles] AS A
		ON A.RoleID = R.Value
	WHERE A.ApplicationID = @ApplicationID
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_GetAccessRoles]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_GetAccessRoles]
GO

CREATE PROCEDURE [dbo].[USR_GetAccessRoles]
	@ApplicationID		uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @RoleIDs GuidTableType
	
	INSERT INTO @RoleIDs (Value)
	SELECT RoleID
	FROM [dbo].[USR_AccessRoles]
	WHERE ApplicationID = @ApplicationID
	
	EXEC [dbo].[USR_P_GetAccessRolesByIDs] @ApplicationID, @RoleIDs
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_GetUserGroupAccessRoles]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_GetUserGroupAccessRoles]
GO

CREATE PROCEDURE [dbo].[USR_GetUserGroupAccessRoles]
	@ApplicationID		uniqueidentifier,
	@GroupID			uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @RoleIDs GuidTableType
	
	INSERT INTO @RoleIDs (Value)
	SELECT DISTINCT R.RoleID
	FROM [dbo].[USR_UserGroups] AS G
		INNER JOIN [dbo].[USR_UserGroupPermissions] AS P
		ON P.ApplicationID = @ApplicationID AND P.GroupID = G.GroupID
		INNER JOIN [dbo].[USR_AccessRoles] AS R
		ON R.ApplicationID = @ApplicationID AND R.RoleID = P.RoleID
	WHERE G.ApplicationID = @ApplicationID AND G.GroupID = @GroupID 
		AND G.Deleted = 0 AND P.Deleted = 0
	
	EXEC [dbo].[USR_P_GetAccessRolesByIDs] @ApplicationID, @RoleIDs
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_CheckUserGroupPermissions]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_CheckUserGroupPermissions]
GO

CREATE PROCEDURE [dbo].[USR_CheckUserGroupPermissions]
	@ApplicationID		uniqueidentifier,
	@UserID				uniqueidentifier,
	@PermissionsTemp	StringTableType readonly
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @Permissions StringTableType
	INSERT INTO @Permissions SELECT * FROM @PermissionsTemp
	
	SELECT DISTINCT R.Name AS Value
	FROM [dbo].[USR_UserGroupMembers] AS M
		INNER JOIN [dbo].[USR_UserGroups] AS G
		ON G.ApplicationID = @ApplicationID AND G.GroupID = M.GroupID
		INNER JOIN [dbo].[USR_UserGroupPermissions] AS P
		ON P.ApplicationID = @ApplicationID AND P.GroupID = G.GroupID
		INNER JOIN [dbo].[USR_AccessRoles] AS R
		ON R.ApplicationID = @ApplicationID AND R.RoleID = P.RoleID
	WHERE M.ApplicationID = @ApplicationID AND M.UserID = @UserID AND 
		(LOWER(R.Name) IN (SELECT LOWER(Ref.Value) FROM @Permissions AS Ref)) AND
		M.Deleted = 0 AND G.Deleted = 0 AND P.Deleted = 0
END

GO

-- end of User Groups

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[KW_P_InitializeForms]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[KW_P_InitializeForms]
GO

CREATE PROCEDURE [dbo].[KW_P_InitializeForms]
	@ApplicationID		uniqueidentifier,
	@AdminID			uniqueidentifier,
	@ExperienceTypeID	uniqueidentifier,
	@SkillTypeID		uniqueidentifier,
	@DocumentTypeID		uniqueidentifier,
	@_Result			int output
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @FormID uniqueidentifier = NULL

	IF @ExperienceTypeID IS NOT NULL AND NOT EXISTS(
		SELECT TOP(1) * 
		FROM [dbo].[FG_FormOwners] AS FO 
		WHERE FO.ApplicationID = @ApplicationID AND OwnerID = @ExperienceTypeID
	) BEGIN
		SET @FormID = NEWID()

		INSERT [dbo].[FG_ExtendedForms] ([ApplicationID], [FormID], [Title], 
			[CreatorUserID], [CreationDate], [Deleted]) 
		VALUES (@ApplicationID, @FormID, N'  ', @AdminID, 
			CAST(0x0000A49600C3C29A AS DateTime), 0)
		
		INSERT [dbo].[FG_ExtendedFormElements] ([ApplicationID], [ElementID], [FormID], 
			[Title], [SequenceNumber], [Type], [Info], [CreatorUserID], [CreationDate], 
			[Deleted], [Necessary]) 
		VALUES (@ApplicationID, NEWID(), @FormID, N' ', 7, N'Text', N'{}', 
			@AdminID, CAST(0x0000A49600C7EB49 AS DateTime), 0, 1)
		
		INSERT [dbo].[FG_ExtendedFormElements] ([ApplicationID], [ElementID], [FormID], 
			[Title], [SequenceNumber], [Type], [Info], [CreatorUserID], [CreationDate], 
			[Deleted], [Necessary]) 
		VALUES (@ApplicationID, NEWID(), @FormID, N' ', 9, N'Text', N'{}', 
			@AdminID, CAST(0x0000A49600C82B85 AS DateTime), 0, 1)

		INSERT INTO [dbo].[FG_FormOwners] (ApplicationID, OwnerID, FormID, 
			CreatorUserID, CreationDate, Deleted)
		VALUES (@ApplicationID, @ExperienceTypeID, @FormID, @AdminID, GETDATE(), 0)
	END


	IF @SkillTypeID IS NOT NULL AND NOT EXISTS(
		SELECT TOP(1) * 
		FROM [dbo].[FG_FormOwners] AS FO 
		WHERE ApplicationID = @ApplicationID AND OwnerID = @SkillTypeID
	) BEGIN
		SET @FormID = NEWID()

		INSERT [dbo].[FG_ExtendedForms] ([ApplicationID], [FormID], [Title], 
			[CreatorUserID], [CreationDate], [Deleted]) 
		VALUES (@ApplicationID, @FormID, N'  ', @AdminID, 
			CAST(0x0000A49600C3C29A AS DateTime), 0)
		
		INSERT [dbo].[FG_ExtendedFormElements] ([ApplicationID], [ElementID], [FormID], 
			[Title], [SequenceNumber], [Type], [Info], [CreatorUserID], [CreationDate], 
			[Deleted], [Necessary]) 
		VALUES (@ApplicationID, NEWID(), @FormID, N' ', 7, N'Text', N'{}', 
			@AdminID, CAST(0x0000A49600C7EB49 AS DateTime), 0, 1)
		
		INSERT [dbo].[FG_ExtendedFormElements] ([ApplicationID], [ElementID], [FormID], 
			[Title], [SequenceNumber], [Type], [Info], [CreatorUserID], [CreationDate], 
			[Deleted], [Necessary]) 
		VALUES (@ApplicationID, NEWID(), @FormID, N' ', 9, N'Text', N'{}', 
			@AdminID, CAST(0x0000A49600C82B85 AS DateTime), 0, 1)

		INSERT INTO [dbo].[FG_FormOwners] (ApplicationID, OwnerID, FormID, 
			CreatorUserID, CreationDate, Deleted)
		VALUES (@ApplicationID, @SkillTypeID, @FormID, @AdminID, GETDATE(), 0)
	END


	IF @DocumentTypeID IS NOT NULL AND NOT EXISTS(
		SELECT TOP(1) * 
		FROM [dbo].[FG_FormOwners] AS FO 
		WHERE ApplicationID = @ApplicationID AND OwnerID = @DocumentTypeID
	) BEGIN
		SET @FormID = NEWID()

		INSERT [dbo].[FG_ExtendedForms] ([ApplicationID], [FormID], [Title], 
			[CreatorUserID], [CreationDate], [Deleted]) 
		VALUES (@ApplicationID, @FormID, N'  ', @AdminID, 
			CAST(0x0000A49600C3C29A AS DateTime), 0)
		
		INSERT [dbo].[FG_ExtendedFormElements] ([ApplicationID], [ElementID], [FormID], 
			[Title], [SequenceNumber], [Type], [Info], [CreatorUserID], [CreationDate], 
			[Deleted], [Necessary]) 
		VALUES (@ApplicationID, NEWID(), @FormID, N' ', 7, N'Text', N'{}', 
			@AdminID, CAST(0x0000A49600C7EB49 AS DateTime), 0, 1)
		
		INSERT [dbo].[FG_ExtendedFormElements] ([ApplicationID], [ElementID], [FormID], 
			[Title], [SequenceNumber], [Type], [Info], [CreatorUserID], [CreationDate], 
			[Deleted], [Necessary]) 
		VALUES (@ApplicationID, NEWID(), @FormID, N' ', 9, N'Text', N'{}', 
			@AdminID, CAST(0x0000A49600C82B85 AS DateTime), 0, 1)

		INSERT INTO [dbo].[FG_FormOwners] (ApplicationID, OwnerID, FormID, 
			CreatorUserID, CreationDate, Deleted)
		VALUES (@ApplicationID, @DocumentTypeID, @FormID, @AdminID, GETDATE(), 0)
	END
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[KW_P_InitializeKnowledgeTypes]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[KW_P_InitializeKnowledgeTypes]
GO

CREATE PROCEDURE [dbo].[KW_P_InitializeKnowledgeTypes]
	@ApplicationID		uniqueidentifier,
	@AdminID			uniqueidentifier,
	@ExperienceTypeID	uniqueidentifier,
	@SkillTypeID		uniqueidentifier,
	@DocumentTypeID		uniqueidentifier,
	@_Result			int output
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @Now datetime = GETDATE()
	
	IF NOT EXISTS (
		SELECT TOP(1) *
		FROM [dbo].[KW_KnowledgeTypes]
		WHERE ApplicationID = @ApplicationID AND KnowledgeTypeID = @ExperienceTypeID
	) BEGIN
		INSERT INTO [dbo].[KW_KnowledgeTypes] (ApplicationID, KnowledgeTypeID,
			EvaluationType, Evaluators, SearchableAfter, ScoreScale, MinAcceptableScore,
			NodeSelectType, CreatorUserID, CreationDate, Deleted)
		VALUES (@ApplicationID, @ExperienceTypeID, N'EN', N'Experts',
			N'Evaluation', 10, 5, N'Free', @AdminID, @Now, 0)
	END
	
	IF NOT EXISTS (
		SELECT TOP(1) *
		FROM [dbo].[KW_KnowledgeTypes]
		WHERE ApplicationID = @ApplicationID AND KnowledgeTypeID = @SkillTypeID
	) BEGIN	
		INSERT INTO [dbo].[KW_KnowledgeTypes] (ApplicationID, KnowledgeTypeID,
			EvaluationType, Evaluators, SearchableAfter, ScoreScale, MinAcceptableScore,
			NodeSelectType, CreatorUserID, CreationDate, Deleted)
		VALUES (@ApplicationID, @SkillTypeID, N'EN', N'Experts',
			N'Evaluation', 10, 5, N'Free', @AdminID, @Now, 0)
	END
	
	IF NOT EXISTS (
		SELECT TOP(1) *
		FROM [dbo].[KW_KnowledgeTypes]
		WHERE ApplicationID = @ApplicationID AND KnowledgeTypeID = @DocumentTypeID
	) BEGIN	
		INSERT INTO [dbo].[KW_KnowledgeTypes] (ApplicationID, KnowledgeTypeID,
			EvaluationType, Evaluators, SearchableAfter, ScoreScale, MinAcceptableScore,
			NodeSelectType, CreatorUserID, CreationDate, Deleted)
		VALUES (@ApplicationID, @DocumentTypeID, N'EN', N'Experts',
			N'Evaluation', 10, 5, N'Free', @AdminID, @Now, 0)
	END
	
	SET @_Result = 1
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[KW_P_InitializeQuestions]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[KW_P_InitializeQuestions]
GO

CREATE PROCEDURE [dbo].[KW_P_InitializeQuestions]
	@ApplicationID		uniqueidentifier,
	@AdminID			uniqueidentifier,
	@ExperienceTypeID	uniqueidentifier,
	@SkillTypeID		uniqueidentifier,
	@DocumentTypeID		uniqueidentifier,
	@_Result			int output
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	IF EXISTS(
		SELECT TOP(1) *
		FROM [dbo].[KW_Questions] 
		WHERE ApplicationID = @ApplicationID
	) BEGIN
		SET @_Result = 1
		RETURN
	END
	
	DECLARE @Now datetime = GETDATE()
	
	DECLARE @TBL Table (TypeID uniqueidentifier, SequenceNumber int,
		QuestionID uniqueidentifier, Title nvarchar(1000))
		
	INSERT INTO @TBL (TypeID, QuestionID, SequenceNumber, Title)
	VALUES (
		@ExperienceTypeID, NEWID(), 1,
		N'                            '
	),
	(
		@ExperienceTypeID, NEWID(), 2,
		N'       (   =1    =10)'
	),
	(
		@ExperienceTypeID, NEWID(), 3,
		N'              '
	),
	(
		@ExperienceTypeID, NEWID(), 4,
		N'                '
	),
	(
		@ExperienceTypeID, NEWID(), 5,
		N'                  (   =10  100  =10)'
	),
	(
		@ExperienceTypeID, NEWID(), 6,
		N'                        ( =10  =1)'
	),
	(
		@SkillTypeID, NEWID(), 7,
		N'                            '
	),
	(
		@SkillTypeID, NEWID(), 8,
		N'       (   =1    =10)'
	),
	(
		@SkillTypeID, NEWID(), 9,
		N'                 '
	),
	(
		@SkillTypeID, NEWID(), 10,
		N'              '
	),
	(
		@SkillTypeID, NEWID(), 11,
		N'                  (   =1  100  =10)'
	),
	(
		@SkillTypeID, NEWID(), 12,
		N'                '
	),
	(
		@SkillTypeID, NEWID(), 13,
		N'             '
	),
	(
		@DocumentTypeID, NEWID(), 14,
		N'                            '
	),
	(
		@DocumentTypeID, NEWID(), 15,
		N'                 '
	),
	(
		@DocumentTypeID, NEWID(), 16,
		N'              '
	),
	(
		@DocumentTypeID, NEWID(), 17,
		N'                        '
	),
	(
		@DocumentTypeID, NEWID(), 18,
		N'                (  =1  100 =10)'
	),
	(
		@DocumentTypeID, NEWID(), 19,
		N'            '
	)
	
	
	INSERT INTO [dbo].[KW_Questions] (
		ApplicationID, QuestionID, Title, CreatorUserID, CreationDate, Deleted
	)
	SELECT @ApplicationID, T.QuestionID, T.Title, @AdminID, @Now, 0
	FROM @TBL AS T
	
	
	INSERT INTO [dbo].[KW_TypeQuestions] (
		ApplicationID, ID, KnowledgeTypeID, QuestionID, SequenceNumber, 
		CreatorUserID, CreationDate, Deleted
	)
	SELECT @ApplicationID, NEWID(), T.TypeID, T.QuestionID, T.SequenceNumber, 
		@AdminID, @Now, 0
	FROM @TBL AS T
	
	SET @_Result = 1
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[KW_P_InitializeServices]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[KW_P_InitializeServices]
GO

CREATE PROCEDURE [dbo].[KW_P_InitializeServices]
	@ApplicationID		uniqueidentifier,
	@ExperienceTypeID	uniqueidentifier,
	@SkillTypeID		uniqueidentifier,
	@DocumentTypeID		uniqueidentifier,
	@_Result			int output
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	IF EXISTS(
		SELECT TOP(1) *
		FROM [dbo].[KW_KnowledgeTypes] AS KT
			INNER JOIN [dbo].[CN_Services] AS S
			ON S.ApplicationID = @ApplicationID AND S.NodeTypeID = KT.KnowledgeTypeID
		WHERE KT.ApplicationID = @ApplicationID
	) BEGIN
		SET @_Result = 1
		RETURN
	END
	
	INSERT INTO [dbo].[CN_Services] (ApplicationID, NodeTypeID, ServiceTitle,
		EnableContribution, AdminType, MaxAcceptableAdminLevel, EditableForAdmin,
		EditableForCreator, EditableForOwners, EditableForExperts, EditableForMembers,
		Deleted, IsDocument, IsKnowledge, EditSuggestion, IsTree, SequenceNumber)
	VALUES (@ApplicationID, @ExperienceTypeID, N' ', 1, N'AreaAdmin',
		2, 1, 1, 1, 0, 0, 0, 0, 1, 1, 0, 0)
		
	INSERT INTO [dbo].[CN_Services] (ApplicationID, NodeTypeID, ServiceTitle,
		EnableContribution, AdminType, MaxAcceptableAdminLevel, EditableForAdmin,
		EditableForCreator, EditableForOwners, EditableForExperts, EditableForMembers,
		Deleted, IsDocument, IsKnowledge, EditSuggestion, IsTree, SequenceNumber)
	VALUES (@ApplicationID, @SkillTypeID, N' ', 0, N'AreaAdmin',
		2, 1, 1, 1, 0, 0, 0, 0, 1, 1, 0, 0)
		
	INSERT INTO [dbo].[CN_Services] (ApplicationID, NodeTypeID, ServiceTitle,
		EnableContribution, AdminType, MaxAcceptableAdminLevel, EditableForAdmin,
		EditableForCreator, EditableForOwners, EditableForExperts, EditableForMembers,
		Deleted, IsDocument, IsKnowledge, EditSuggestion, IsTree, SequenceNumber)
	VALUES (@ApplicationID, @DocumentTypeID, N' ', 1, N'AreaAdmin',
		2, 1, 1, 1, 0, 0, 0, 1, 1, 1, 0, 0)
	
	SET @_Result = 1
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[KW_Initialize]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[KW_Initialize]
GO

CREATE PROCEDURE [dbo].[KW_Initialize]
	@ApplicationID		uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @ExperienceTypeID uniqueidentifier = (
		SELECT TOP(1) NodeTypeID
		FROM [dbo].[CN_NodeTypes]
		WHERE ApplicationID = @ApplicationID AND AdditionalID = '9'
	)
	
	DECLARE @SkillTypeID uniqueidentifier = (
		SELECT TOP(1) NodeTypeID
		FROM [dbo].[CN_NodeTypes]
		WHERE ApplicationID = @ApplicationID AND AdditionalID = '8'
	)
	
	DECLARE @DocumentTypeID uniqueidentifier = (
		SELECT TOP(1) NodeTypeID
		FROM [dbo].[CN_NodeTypes]
		WHERE ApplicationID = @ApplicationID AND AdditionalID = '10'
	)
	
	DECLARE @AdminID uniqueidentifier = (
		SELECT TOP(1) UserID 
		FROM [dbo].[Users_Normal] 
		WHERE ApplicationID = @ApplicationID AND UserName = N'admin'
	)
	
	
	DECLARE @_Result int
	
	EXEC [dbo].[KW_P_InitializeForms] @ApplicationID, @AdminID,
		@ExperienceTypeID, @SkillTypeID, @DocumentTypeID, @_Result output
	
	EXEC [dbo].[KW_P_InitializeKnowledgeTypes] @ApplicationID, @AdminID,
		@ExperienceTypeID, @SkillTypeID, @DocumentTypeID, @_Result output
	
	EXEC [dbo].[KW_P_InitializeQuestions] @ApplicationID, @AdminID,
		@ExperienceTypeID, @SkillTypeID, @DocumentTypeID, @_Result output
		
	EXEC [dbo].[KW_P_InitializeServices] @ApplicationID, 
		@ExperienceTypeID, @SkillTypeID, @DocumentTypeID, @_Result output
	
	SELECT 1
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[KW_AddKnowledgeType]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[KW_AddKnowledgeType]
GO

CREATE PROCEDURE [dbo].[KW_AddKnowledgeType]
	@ApplicationID		uniqueidentifier,
	@KnowledgeTypeID	uniqueidentifier,
	@CreatorUserID		uniqueidentifier,
	@CreationDate		datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	IF ISNULL((
		SELECT TOP(1) 1
		FROM [dbo].[CN_Services] AS S
		WHERE S.ApplicationID = @ApplicationID AND 
			S.NodeTypeID = @KnowledgeTypeID AND ISNULL(S.IsKnowledge, 0) = 1
	), 0) = 0 BEGIN
		SELECT -1
		RETURN
	END
	
	IF EXISTS(SELECT TOP(1) * FROM [dbo].[KW_KnowledgeTypes] 
		WHERE KnowledgeTypeID = @KnowledgeTypeID) BEGIN
		UPDATE [dbo].[KW_KnowledgeTypes]
			SET Deleted = 0,
				LastModifierUserID = @CreatorUserID,
				LastModificationDate = @CreationDate
		WHERE ApplicationID = @ApplicationID AND KnowledgeTypeID = @KnowledgeTypeID
	END
	ELSE BEGIN
		INSERT INTO [dbo].[KW_KnowledgeTypes](
			ApplicationID,
			KnowledgeTypeID,
			CreatorUserID,
			CreationDate,
			ConvertEvaluatorsToExperts,
			Deleted
		)
		VALUES(
			@ApplicationID,
			@KnowledgeTypeID,
			@CreatorUserID,
			@CreationDate,
			0,
			0
		)
	END
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[KW_ArithmeticDeleteKnowledgeType]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[KW_ArithmeticDeleteKnowledgeType]
GO

CREATE PROCEDURE [dbo].[KW_ArithmeticDeleteKnowledgeType]
	@ApplicationID				uniqueidentifier,
	@KnowledgeTypeID			uniqueidentifier,
	@LastModifierUserID			uniqueidentifier,
	@LastModificationDate		datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[KW_KnowledgeTypes]
		SET Deleted = 1,
			LastModifierUserID = @LastModifierUserID,
			LastModificationDate = @LastModificationDate
	WHERE ApplicationID = @ApplicationID AND KnowledgeTypeID = @KnowledgeTypeID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[KW_P_GetKnowledgeTypesByIDs]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[KW_P_GetKnowledgeTypesByIDs]
GO

CREATE PROCEDURE [dbo].[KW_P_GetKnowledgeTypesByIDs]
	@ApplicationID			uniqueidentifier,
	@KnowledgeTypeIDsTemp	GuidTableType readonly
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @KnowledgeTypeIDs GuidTableType
	INSERT INTO @KnowledgeTypeIDs SELECT * FROM @KnowledgeTypeIDsTemp
	
	SELECT KT.KnowledgeTypeID,
		   NT.Name AS KnowledgeType,
		   KT.NodeSelectType,
		   KT.EvaluationType,
		   KT.Evaluators,
		   KT.PreEvaluateByOwner,
		   KT.ForceEvaluatorsDescribe,
		   KT.MinEvaluationsCount,
		   KT.SearchableAfter,
		   KT.ScoreScale,
		   KT.MinAcceptableScore,
		   KT.ConvertEvaluatorsToExperts,
		   KT.EvaluationsEditable,
		   KT.EvaluationsEditableForAdmin,
		   KT.EvaluationsRemovable,
		   KT.UnhideEvaluators,
		   KT.UnhideEvaluations,
		   KT.UnhideNodeCreators,
		   KT.TextOptions,
		   NT.AdditionalIDPattern
	FROM @KnowledgeTypeIDs AS Ref
		INNER JOIN [dbo].[KW_KnowledgeTypes] AS KT
		ON KT.ApplicationID = @ApplicationID AND KT.KnowledgeTypeID = Ref.Value
		INNER JOIN [dbo].[CN_NodeTypes] AS NT
		ON NT.ApplicationID = @ApplicationID AND NT.NodeTypeID = Ref.Value
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[KW_GetKnowledgeTypes]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[KW_GetKnowledgeTypes]
GO

CREATE PROCEDURE [dbo].[KW_GetKnowledgeTypes]
	@ApplicationID			uniqueidentifier,
	@strKnowledgeTypeIDs	varchar(max),
	@delimiter				char
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @KnowledgeTypeIDs GuidTableType
	
	INSERT INTO @KnowledgeTypeIDs
	SELECT Ref.Value FROM [dbo].[GFN_StrToGuidTable](@strKnowledgeTypeIDs, @delimiter) AS Ref
	
	IF (SELECT COUNT(*) FROM @KnowledgeTypeIDs) = 1 BEGIN
		DECLARE @ID uniqueidentifier = (SELECT TOP(1) * FROM @KnowledgeTypeIDs)
		
		DELETE @KnowledgeTypeIDs
		
		INSERT INTO @KnowledgeTypeIDs (Value)
		SELECT ISNULL(
			(
				SELECT TOP(1) NodeTypeID 
				FROM [dbo].[CN_Nodes] 
				WHERE ApplicationID = @ApplicationID AND NodeID = @ID
			), @ID)
	END
	
	IF (SELECT COUNT(*) FROM @KnowledgeTypeIDs) = 0 BEGIN
		INSERT INTO @KnowledgeTypeIDs
		SELECT KnowledgeTypeID
		FROM [dbo].[KW_KnowledgeTypes]
		WHERE ApplicationID = @ApplicationID AND Deleted = 0
	END
	
	EXEC [dbo].[KW_P_GetKnowledgeTypesByIDs] @ApplicationID, @KnowledgeTypeIDs
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[KW_SetEvaluationType]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[KW_SetEvaluationType]
GO

CREATE PROCEDURE [dbo].[KW_SetEvaluationType]
	@ApplicationID		uniqueidentifier,
	@KnowledgeTypeID	uniqueidentifier,
	@EvaluationType		varchar(20)
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[KW_KnowledgeTypes]
		SET EvaluationType = @EvaluationType
	WHERE ApplicationID = @ApplicationID AND KnowledgeTypeID = @KnowledgeTypeID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[KW_SetEvaluators]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[KW_SetEvaluators]
GO

CREATE PROCEDURE [dbo].[KW_SetEvaluators]
	@ApplicationID			uniqueidentifier,
	@KnowledgeTypeID		uniqueidentifier,
	@Evaluators				varchar(20),
	@MinEvaluationsCount	int
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[KW_KnowledgeTypes]
		SET Evaluators = @Evaluators,
			MinEvaluationsCount = @MinEvaluationsCount
	WHERE ApplicationID = @ApplicationID AND KnowledgeTypeID = @KnowledgeTypeID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[KW_SetPreEvaluateByOwner]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[KW_SetPreEvaluateByOwner]
GO

CREATE PROCEDURE [dbo].[KW_SetPreEvaluateByOwner]
	@ApplicationID		uniqueidentifier,
	@KnowledgeTypeID	uniqueidentifier,
	@Value				bit
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[KW_KnowledgeTypes]
		SET PreEvaluateByOwner = @Value
	WHERE ApplicationID = @ApplicationID AND KnowledgeTypeID = @KnowledgeTypeID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[KW_SetForceEvaluatorsDescribe]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[KW_SetForceEvaluatorsDescribe]
GO

CREATE PROCEDURE [dbo].[KW_SetForceEvaluatorsDescribe]
	@ApplicationID		uniqueidentifier,
	@KnowledgeTypeID	uniqueidentifier,
	@Value				bit
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[KW_KnowledgeTypes]
		SET ForceEvaluatorsDescribe = @Value
	WHERE ApplicationID = @ApplicationID AND KnowledgeTypeID = @KnowledgeTypeID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[KW_SetNodeSelectType]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[KW_SetNodeSelectType]
GO

CREATE PROCEDURE [dbo].[KW_SetNodeSelectType]
	@ApplicationID		uniqueidentifier,
	@KnowledgeTypeID	uniqueidentifier,
	@NodeSelectType		varchar(20)
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[KW_KnowledgeTypes]
		SET NodeSelectType = @NodeSelectType
	WHERE ApplicationID = @ApplicationID AND KnowledgeTypeID = @KnowledgeTypeID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[KW_SetSearchabilityType]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[KW_SetSearchabilityType]
GO

CREATE PROCEDURE [dbo].[KW_SetSearchabilityType]
	@ApplicationID		uniqueidentifier,
	@KnowledgeTypeID	uniqueidentifier,
	@SearchableAfter	varchar(20)
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[KW_KnowledgeTypes]
		SET SearchableAfter = @SearchableAfter
	WHERE ApplicationID = @ApplicationID AND KnowledgeTypeID = @KnowledgeTypeID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[KW_SetScoreScale]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[KW_SetScoreScale]
GO

CREATE PROCEDURE [dbo].[KW_SetScoreScale]
	@ApplicationID		uniqueidentifier,
	@KnowledgeTypeID	uniqueidentifier,
	@ScoreScale			int
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[KW_KnowledgeTypes]
		SET ScoreScale = @ScoreScale
	WHERE ApplicationID = @ApplicationID AND KnowledgeTypeID = @KnowledgeTypeID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[KW_SetMinAcceptableScore]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[KW_SetMinAcceptableScore]
GO

CREATE PROCEDURE [dbo].[KW_SetMinAcceptableScore]
	@ApplicationID		uniqueidentifier,
	@KnowledgeTypeID	uniqueidentifier,
	@MinAcceptableScore	float
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[KW_KnowledgeTypes]
		SET MinAcceptableScore = @MinAcceptableScore
	WHERE ApplicationID = @ApplicationID AND KnowledgeTypeID = @KnowledgeTypeID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[KW_SetEvaluationsEditable]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[KW_SetEvaluationsEditable]
GO

CREATE PROCEDURE [dbo].[KW_SetEvaluationsEditable]
	@ApplicationID		uniqueidentifier,
	@KnowledgeTypeID	uniqueidentifier,
	@Value				float
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[KW_KnowledgeTypes]
		SET EvaluationsEditable = @Value
	WHERE ApplicationID = @ApplicationID AND KnowledgeTypeID = @KnowledgeTypeID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[KW_SetEvaluationsEditableForAdmin]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[KW_SetEvaluationsEditableForAdmin]
GO

CREATE PROCEDURE [dbo].[KW_SetEvaluationsEditableForAdmin]
	@ApplicationID		uniqueidentifier,
	@KnowledgeTypeID	uniqueidentifier,
	@Value				bit
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[KW_KnowledgeTypes]
		SET EvaluationsEditableForAdmin = @Value
	WHERE ApplicationID = @ApplicationID AND KnowledgeTypeID = @KnowledgeTypeID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[KW_SetEvaluationsRemovable]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[KW_SetEvaluationsRemovable]
GO

CREATE PROCEDURE [dbo].[KW_SetEvaluationsRemovable]
	@ApplicationID		uniqueidentifier,
	@KnowledgeTypeID	uniqueidentifier,
	@Value				float
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[KW_KnowledgeTypes]
		SET EvaluationsRemovable = @Value
	WHERE ApplicationID = @ApplicationID AND KnowledgeTypeID = @KnowledgeTypeID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[KW_SetUnhideEvaluators]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[KW_SetUnhideEvaluators]
GO

CREATE PROCEDURE [dbo].[KW_SetUnhideEvaluators]
	@ApplicationID		uniqueidentifier,
	@KnowledgeTypeID	uniqueidentifier,
	@Value				float
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[KW_KnowledgeTypes]
		SET UnhideEvaluators = @Value
	WHERE ApplicationID = @ApplicationID AND KnowledgeTypeID = @KnowledgeTypeID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[KW_SetUnhideEvaluations]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[KW_SetUnhideEvaluations]
GO

CREATE PROCEDURE [dbo].[KW_SetUnhideEvaluations]
	@ApplicationID		uniqueidentifier,
	@KnowledgeTypeID	uniqueidentifier,
	@Value				float
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[KW_KnowledgeTypes]
		SET UnhideEvaluations = @Value
	WHERE ApplicationID = @ApplicationID AND KnowledgeTypeID = @KnowledgeTypeID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[KW_SetUnhideNodeCreators]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[KW_SetUnhideNodeCreators]
GO

CREATE PROCEDURE [dbo].[KW_SetUnhideNodeCreators]
	@ApplicationID		uniqueidentifier,
	@KnowledgeTypeID	uniqueidentifier,
	@Value				float
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[KW_KnowledgeTypes]
		SET UnhideNodeCreators = @Value
	WHERE ApplicationID = @ApplicationID AND KnowledgeTypeID = @KnowledgeTypeID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[KW_SetTextOptions]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[KW_SetTextOptions]
GO

CREATE PROCEDURE [dbo].[KW_SetTextOptions]
	@ApplicationID		uniqueidentifier,
	@KnowledgeTypeID	uniqueidentifier,
	@Value				nvarchar(max)
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[KW_KnowledgeTypes]
		SET TextOptions = @Value
	WHERE ApplicationID = @ApplicationID AND KnowledgeTypeID = @KnowledgeTypeID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[KW_SetConvertEvaluatorsToExperts]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[KW_SetConvertEvaluatorsToExperts]
GO

CREATE PROCEDURE [dbo].[KW_SetConvertEvaluatorsToExperts]
	@ApplicationID		uniqueidentifier,
	@KnowledgeTypeID	uniqueidentifier,
	@Value				bit
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[KW_KnowledgeTypes]
		SET ConvertEvaluatorsToExperts = ISNULL(@Value, 0)
	WHERE ApplicationID = @ApplicationID AND KnowledgeTypeID = @KnowledgeTypeID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[KW_SetCandidateRelations]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[KW_SetCandidateRelations]
GO

CREATE PROCEDURE [dbo].[KW_SetCandidateRelations]
	@ApplicationID		uniqueidentifier,
	@KnowledgeTypeID	uniqueidentifier,
	@strNodeTypeIDs		varchar(max),
	@strNodeIDs			varchar(max),
	@delimiter			char,
	@CreatorUserID		uniqueidentifier,
	@CreationDate		datetime
WITH ENCRYPTION
AS
BEGIN TRANSACTION
	SET NOCOUNT ON
	
	DECLARE @IDs Table(NodeTypeID uniqueidentifier, NodeID uniqueidentifier)
	
	INSERT INTO @IDs (NodeTypeID)
	SELECT Ref.Value FROM [dbo].[GFN_StrToGuidTable](@strNodeTypeIDs, @delimiter) AS Ref
	
	INSERT INTO @IDs (NodeID)
	SELECT Ref.Value FROM [dbo].[GFN_StrToGuidTable](@strNodeIDs, @delimiter) AS Ref
	
	DECLARE @ExistingIDs Table(NodeTypeID uniqueidentifier, NodeID uniqueidentifier)
	
	INSERT INTO @ExistingIDs(NodeTypeID, NodeID)
	SELECT CR.NodeTypeID, CR.NodeID
	FROM @IDs AS Ref
		INNER JOIN [dbo].[KW_CandidateRelations] AS CR
		ON CR.NodeTypeID = Ref.NodeTypeID OR CR.NodeID = Ref.NodeID
	WHERE CR.ApplicationID = @ApplicationID AND CR.KnowledgeTypeID = @KnowledgeTypeID
	
	DECLARE @Count int = (SELECT COUNT(*) FROM @IDs)
	DECLARE @ExistingCount int = (SELECT COUNT(*) FROM @ExistingIDs)
	
	IF EXISTS(SELECT * FROM [dbo].[KW_CandidateRelations]
		WHERE KnowledgeTypeID = @KnowledgeTypeID) BEGIN
		
		UPDATE [dbo].[KW_CandidateRelations]
			SET LastModifierUserID = @CreatorUserID,
				LastModificationDate = @CreationDate,
				Deleted = 1
		WHERE ApplicationID = @ApplicationID AND KnowledgeTypeID = @KnowledgeTypeID
		
		IF @@ROWCOUNT <= 0 BEGIN
			SELECT -1
			ROLLBACK TRANSACTION
			RETURN
		END
	END
	
	IF @ExistingCount > 0 BEGIN
		UPDATE CR
			SET LastModifierUserID = @CreatorUserID,
				LastModificationDate = @CreationDate,
				Deleted = 0
		FROM @ExistingIDs AS Ref
			INNER JOIN [dbo].[KW_CandidateRelations] AS CR
			ON CR.NodeTypeID = Ref.NodeTypeID OR CR.NodeID = Ref.NodeID
		WHERE CR.ApplicationID = @ApplicationID AND CR.KnowledgeTypeID = @KnowledgeTypeID
		
		IF @@ROWCOUNT <= 0 BEGIN
			SELECT -1
			ROLLBACK TRANSACTION
			RETURN
		END
	END
	
	IF @Count > @ExistingCount BEGIN
		INSERT INTO [dbo].[KW_CandidateRelations](
			ApplicationID,
			ID,
			KnowledgeTypeID,
			NodeID,
			NodeTypeID,
			CreatorUserID,
			CreationDate,
			Deleted
		)
		SELECT @ApplicationID, NEWID(), @KnowledgeTypeID, Ref.NodeID, Ref.NodeTypeID, 
			@CreatorUserID, @CreationDate, 0
		FROM (
				SELECT I.*
				FROM @IDs AS I
					LEFT JOIN @ExistingIDs AS E
					ON I.NodeID = E.NodeID OR I.NodeTypeID = E.NodeTypeID
				WHERE E.NodeID IS NULL AND E.NodeTypeID IS NULL
			) AS Ref
		
		IF @@ROWCOUNT <= 0 BEGIN
		select 6
			SELECT -1
			ROLLBACK TRANSACTION
			RETURN
		END
	END
	
	SELECT 1
COMMIT TRANSACTION

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[KW_GetCandidateNodeRelationIDs]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[KW_GetCandidateNodeRelationIDs]
GO

CREATE PROCEDURE [dbo].[KW_GetCandidateNodeRelationIDs]
	@ApplicationID					uniqueidentifier,
	@KnowledgeTypeIDOrKnowledgeID	uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SET @KnowledgeTypeIDOrKnowledgeID = ISNULL(
		(
			SELECT TOP(1) NodeTypeID
			FROM [dbo].[CN_Nodes]
			WHERE ApplicationID = @ApplicationID AND NodeID = @KnowledgeTypeIDOrKnowledgeID
		), @KnowledgeTypeIDOrKnowledgeID
	)
	
	SELECT NodeID AS ID
	FROM [dbo].[KW_CandidateRelations]
	WHERE ApplicationID = @ApplicationID AND 
		KnowledgeTypeID = @KnowledgeTypeIDOrKnowledgeID AND 
		NodeID IS NOT NULL AND Deleted = 0
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[KW_GetCandidateNodeTypeRelationIDs]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[KW_GetCandidateNodeTypeRelationIDs]
GO

CREATE PROCEDURE [dbo].[KW_GetCandidateNodeTypeRelationIDs]
	@ApplicationID					uniqueidentifier,
	@KnowledgeTypeIDOrKnowledgeID	uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SET @KnowledgeTypeIDOrKnowledgeID = ISNULL(
		(
			SELECT TOP(1) NodeTypeID
			FROM [dbo].[CN_Nodes]
			WHERE ApplicationID = @ApplicationID AND NodeID = @KnowledgeTypeIDOrKnowledgeID
		), @KnowledgeTypeIDOrKnowledgeID
	)
	
	SELECT NodeTypeID AS ID
	FROM [dbo].[KW_CandidateRelations]
	WHERE ApplicationID = @ApplicationID AND 
		KnowledgeTypeID = @KnowledgeTypeIDOrKnowledgeID AND 
		NodeTypeID IS NOT NULL AND Deleted = 0
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[KW_AddQuestion]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[KW_AddQuestion]
GO

CREATE PROCEDURE [dbo].[KW_AddQuestion]
	@ApplicationID		uniqueidentifier,
	@ID					uniqueidentifier,
	@KnowledgeTypeID	uniqueidentifier,
	@NodeID				uniqueidentifier,
	@QuestionBody		nvarchar(2000),
	@CreatorUserID		uniqueidentifier,
	@CreationDate		datetime
WITH ENCRYPTION
AS
BEGIN TRANSACTION
	SET NOCOUNT ON
	
	IF @QuestionBody IS NOT NULL SET @QuestionBody = [dbo].[GFN_VerifyString](@QuestionBody)
	
	DECLARE @QuestionID uniqueidentifier = (
		SELECT QuestionID 
		FROM [dbo].[KW_Questions] 
		WHERE ApplicationID = @ApplicationID AND Title = @QuestionBody
	)
	
	IF @QuestionID IS NOT NULL AND EXISTS(
		SELECT TOP(1) *
		FROM [dbo].[KW_TypeQuestions]
		WHERE ApplicationID = @ApplicationID AND KnowledgeTypeID = @KnowledgeTypeID AND
			QuestionID = @QuestionID AND Deleted = 0
	) BEGIN
		SELECT -1, N'QuestionAlreadyExists'
		ROLLBACK TRANSACTION
		RETURN
	END
	
	IF @QuestionID IS NULL BEGIN
		SET @QuestionID = NEWID()
		
		INSERT INTO [dbo].[KW_Questions](
			ApplicationID,
			QuestionID,
			Title,
			CreatorUserID,
			CreationDate,
			Deleted
		)
		VALUES(
			@ApplicationID,
			@QuestionID,
			@QuestionBody,
			@CreatorUserID,
			@CreationDate,
			0
		)
		
		IF @@ROWCOUNT <= 0 BEGIN
			SELECT -1
			ROLLBACK TRANSACTION
			RETURN
		END
	END
	
	DECLARE @SequenceNumber int = (
		SELECT MAX(SequenceNumber) 
		FROM [dbo].[KW_TypeQuestions]
		WHERE ApplicationID = @ApplicationID AND KnowledgeTypeID = @KnowledgeTypeID
	)
	
	SET @SequenceNumber = ISNULL(@SequenceNumber, 0) + 1
	
	INSERT INTO [dbo].[KW_TypeQuestions](
		ApplicationID,
		ID,
		KnowledgeTypeID,
		QuestionID,
		NodeID,
		SequenceNumber,
		CreatorUserID,
		CreationDate,
		Deleted
	)
	VALUES(
		@ApplicationID,
		@ID,
		@KnowledgeTypeID,
		@QuestionID,
		@NodeID,
		@SequenceNumber,
		@CreatorUserID,
		@CreationDate,
		0
	)
	
	IF @@ROWCOUNT <= 0 BEGIN
		SELECT -1
		ROLLBACK TRANSACTION
		RETURN
	END
	
	SELECT 1
COMMIT TRANSACTION

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[KW_ModifyQuestion]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[KW_ModifyQuestion]
GO

CREATE PROCEDURE [dbo].[KW_ModifyQuestion]
	@ApplicationID			uniqueidentifier,
	@ID						uniqueidentifier,
	@QuestionBody			nvarchar(2000),
	@LastModifierUserID		uniqueidentifier,
	@LastModificationDate	datetime
WITH ENCRYPTION
AS
BEGIN TRANSACTION
	SET NOCOUNT ON
	
	IF @QuestionBody IS NOT NULL SET @QuestionBody = [dbo].[GFN_VerifyString](@QuestionBody)
	
	DECLARE @QuestionID uniqueidentifier = (
		SELECT TOP(1) QuestionID 
		FROM [dbo].[KW_Questions] 
		WHERE ApplicationID = @ApplicationID AND Title = @QuestionBody AND Deleted = 0
	)
	
	IF @QuestionID IS NULL BEGIN
		SET @QuestionID = NEWID()
		
		INSERT INTO [dbo].[KW_Questions](
			ApplicationID,
			QuestionID,
			Title,
			CreatorUserID,
			CreationDate,
			Deleted
		)
		VALUES(
			@ApplicationID,
			@QuestionID,
			@QuestionBody,
			@LastModifierUserID,
			@LastModificationDate,
			0
		)
		
		IF @@ROWCOUNT <= 0 BEGIN
			SELECT -1
			ROLLBACK TRANSACTION
			RETURN
		END
	END
	
	UPDATE [dbo].[KW_TypeQuestions]
		SET QuestionID = @QuestionID,
			LastModifierUserID = @LastModifierUserID,
			LastModificationDate = @LastModificationDate
	WHERE ApplicationID = @ApplicationID AND ID = @ID
	
	IF @@ROWCOUNT <= 0 BEGIN
		SELECT -1
		ROLLBACK TRANSACTION
		RETURN
	END
	
	SELECT 1
COMMIT TRANSACTION

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[KW_SetQuestionsOrder]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[KW_SetQuestionsOrder]
GO

CREATE PROCEDURE [dbo].[KW_SetQuestionsOrder]
	@ApplicationID	uniqueidentifier,
	@strIDs			varchar(max),
	@delimiter		char
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @IDs TABLE (SequenceNo int identity(1, 1) primary key, ID uniqueidentifier)
	
	INSERT INTO @IDs (ID)
	SELECT Ref.Value
	FROM [dbo].[GFN_StrToGuidTable](@strIDs, @delimiter) AS Ref
	
	DECLARE @KnowledgeTypeID uniqueidentifier = NULL, @NodeID uniqueidentifier = NULL
	
	SELECT @KnowledgeTypeID = KnowledgeTypeID, @NodeID = NodeID
	FROM [dbo].[KW_TypeQuestions]
	WHERE ApplicationID = @ApplicationID AND 
		ID = (SELECT TOP (1) Ref.ID FROM @IDs AS Ref)
	
	IF @KnowledgeTypeID IS NULL BEGIN
		SELECT -1
		RETURN
	END
	
	INSERT INTO @IDs (ID)
	SELECT TQ.ID
	FROM @IDs AS Ref
		RIGHT JOIN [dbo].[KW_TypeQuestions] AS TQ
		ON TQ.ID = Ref.ID
	WHERE TQ.ApplicationID = @ApplicationID AND TQ.KnowledgeTypeID = @KnowledgeTypeID AND 
		((@NodeID IS NULL AND TQ.NodeID IS NULL) OR TQ.NodeID = @NodeID) AND Ref.ID IS NULL
	ORDER BY TQ.SequenceNumber
	
	UPDATE TQ
		SET SequenceNumber = Ref.SequenceNo
	FROM @IDs AS Ref
		INNER JOIN [dbo].[KW_TypeQuestions] AS TQ
		ON TQ.ID = Ref.ID
	WHERE TQ.ApplicationID = @ApplicationID AND TQ.KnowledgeTypeID = @KnowledgeTypeID AND 
		((@NodeID IS NULL AND TQ.NodeID IS NULL) OR TQ.NodeID = @NodeID)
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[KW_SetQuestionWeight]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[KW_SetQuestionWeight]
GO

CREATE PROCEDURE [dbo].[KW_SetQuestionWeight]
	@ApplicationID	uniqueidentifier,
	@ID				uniqueidentifier,
	@Weight			float
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	IF @Weight <= 0 SET @Weight = NULL
	
	UPDATE [dbo].[KW_TypeQuestions]
		SET [Weight] = @Weight
	WHERE ApplicationID = @ApplicationID AND ID = @ID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[KW_ArithmeticDeleteQuestion]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[KW_ArithmeticDeleteQuestion]
GO

CREATE PROCEDURE [dbo].[KW_ArithmeticDeleteQuestion]
	@ApplicationID			uniqueidentifier,
	@ID						uniqueidentifier,
	@LastModifierUserID		uniqueidentifier,
	@LastModificationDate	datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[KW_TypeQuestions]
		SET LastModifierUserID = @LastModifierUserID,
			LastModificationDate = @LastModificationDate,
			Deleted = 1
	WHERE ApplicationID = @ApplicationID AND ID = @ID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[KW_ArithmeticDeleteRelatedNodeQuestions]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[KW_ArithmeticDeleteRelatedNodeQuestions]
GO

CREATE PROCEDURE [dbo].[KW_ArithmeticDeleteRelatedNodeQuestions]
	@ApplicationID			uniqueidentifier,
	@KnowledgeTypeID		uniqueidentifier,
	@NodeID					uniqueidentifier,
	@LastModifierUserID		uniqueidentifier,
	@LastModificationDate	datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[KW_TypeQuestions]
		SET LastModifierUserID = @LastModifierUserID,
			LastModificationDate = @LastModificationDate,
			Deleted = 1
	WHERE ApplicationID = @ApplicationID AND 
		KnowledgeTypeID = @KnowledgeTypeID AND NodeID = @NodeID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[KW_AddAnswerOption]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[KW_AddAnswerOption]
GO

CREATE PROCEDURE [dbo].[KW_AddAnswerOption]
	@ApplicationID			uniqueidentifier,
	@ID						uniqueidentifier,
	@TypeQuestionID			uniqueidentifier,
	@Title					nvarchar(2000),
	@Value					float,
	@CurrentUserID			uniqueidentifier,
	@Now					datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	IF @Value IS NULL OR @Value < 0 OR @Value > 10 OR EXISTS(
		SELECT TOP(1) ID
		FROM [dbo].[KW_AnswerOptions]
		WHERE ApplicationID = @ApplicationID AND TypeQuestionID = @TypeQuestionID AND 
			Deleted = 0 AND Value = @Value
	) BEGIN
		SELECT -1, N'AnswerOptionValueIsNotValid'
		RETURN
	END
	
	DECLARE @SeqNo int = ISNULL(
		(
			SELECT MAX(SequenceNumber)
			FROM [dbo].[KW_AnswerOptions]
			WHERE ApplicationID = @ApplicationID AND 
				TypeQuestionID = @TypeQuestionID AND Deleted = 0
		), 0) + 1
	
	INSERT INTO [dbo].[KW_AnswerOptions] (
		ApplicationID,
		ID,
		TypeQuestionID,
		Title,
		Value,
		SequenceNumber,
		CreatorUserID,
		CreationDate,
		Deleted
	)
	VALUES (
		@ApplicationID,
		@ID,
		@TypeQuestionID,
		@Title,
		@Value,
		@SeqNo,
		@CurrentUserID,
		@Now,
		0
	)
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[KW_ModifyAnswerOption]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[KW_ModifyAnswerOption]
GO

CREATE PROCEDURE [dbo].[KW_ModifyAnswerOption]
	@ApplicationID			uniqueidentifier,
	@ID						uniqueidentifier,
	@Title					nvarchar(2000),
	@Value					float,
	@CurrentUserID			uniqueidentifier,
	@Now					datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @TypeQuestionID uniqueidentifier = (
		SELECT TOP(1) TypeQuestionID
		FROM [dbo].[KW_AnswerOptions]
		WHERE ApplicationID = @ApplicationID AND ID = @ID
	)
	
	IF @Value IS NULL OR @Value < 0 OR @Value > 10 OR EXISTS(
		SELECT TOP(1) ID
		FROM [dbo].[KW_AnswerOptions]
		WHERE ApplicationID = @ApplicationID AND TypeQuestionID = @TypeQuestionID AND 
			Deleted = 0 AND ID <> @ID AND Value = @Value
	) BEGIN
		SELECT -1, N'AnswerOptionValueIsNotValid'
		RETURN
	END
	
	UPDATE [dbo].[KW_AnswerOptions]
		SET Title = @Title,
			Value = @Value,
			LastModifierUserID = @CurrentUserID,
			LastModificationDate = @Now
	WHERE ApplicationID = @ApplicationID AND ID = @ID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[KW_SetAnswerOptionsOrder]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[KW_SetAnswerOptionsOrder]
GO

CREATE PROCEDURE [dbo].[KW_SetAnswerOptionsOrder]
	@ApplicationID	uniqueidentifier,
	@strIDs			varchar(max),
	@delimiter		char
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @IDs TABLE (SequenceNo int identity(1, 1) primary key, ID uniqueidentifier)
	
	INSERT INTO @IDs (ID)
	SELECT Ref.Value
	FROM [dbo].[GFN_StrToGuidTable](@strIDs, @delimiter) AS Ref
	
	DECLARE @QuestionID uniqueidentifier
	
	SELECT @QuestionID = TypeQuestionID
	FROM [dbo].[KW_AnswerOptions]
	WHERE ApplicationID = @ApplicationID AND 
		ID = (SELECT TOP (1) Ref.ID FROM @IDs AS Ref)
	
	IF @QuestionID IS NULL BEGIN
		SELECT -1
		RETURN
	END
	
	INSERT INTO @IDs (ID)
	SELECT AO.ID
	FROM @IDs AS Ref
		RIGHT JOIN [dbo].[KW_AnswerOptions] AS AO
		ON AO.ID = Ref.ID
	WHERE AO.ApplicationID = @ApplicationID AND AO.TypeQuestionID = @QuestionID AND Ref.ID IS NULL
	ORDER BY AO.SequenceNumber
	
	UPDATE AO
		SET SequenceNumber = Ref.SequenceNo
	FROM @IDs AS Ref
		INNER JOIN [dbo].[KW_AnswerOptions] AS AO
		ON AO.ID = Ref.ID
	WHERE AO.ApplicationID = @ApplicationID AND AO.TypeQuestionID = @QuestionID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[KW_ArithmeticDeleteAnswerOption]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[KW_ArithmeticDeleteAnswerOption]
GO

CREATE PROCEDURE [dbo].[KW_ArithmeticDeleteAnswerOption]
	@ApplicationID			uniqueidentifier,
	@ID						uniqueidentifier,
	@CurrentUserID			uniqueidentifier,
	@Now					datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[KW_AnswerOptions]
		SET LastModifierUserID = @CurrentUserID,
			LastModificationDate = @Now,
			Deleted = 1
	WHERE ApplicationID = @ApplicationID AND ID = @ID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[KW_GetQuestions]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[KW_GetQuestions]
GO

CREATE PROCEDURE [dbo].[KW_GetQuestions]
	@ApplicationID		uniqueidentifier,
	@KnowledgeTypeID	uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT	TQ.ID, 
			TQ.KnowledgeTypeID, 
			TQ.QuestionID, 
			Q.Title AS QuestionBody,
			ND.NodeID AS RelatedNodeID,
			ND.Name AS RelatedNodeName,
			TQ.[Weight]
	FROM [dbo].[KW_TypeQuestions] AS TQ
		INNER JOIN [dbo].[KW_Questions] AS Q
		ON Q.ApplicationID = @ApplicationID AND Q.QuestionID = TQ.QuestionID
		LEFT JOIN [dbo].[CN_Nodes] AS ND
		ON ND.ApplicationID = @ApplicationID AND ND.NodeID = TQ.NodeID
	WHERE TQ.ApplicationID = @ApplicationID AND TQ.KnowledgeTypeID = @KnowledgeTypeID AND 
		(ND.NodeID IS NULL OR ND.Deleted = 0) AND TQ.Deleted = 0
	ORDER BY TQ.SequenceNumber
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[KW_SearchQuestions]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[KW_SearchQuestions]
GO

CREATE PROCEDURE [dbo].[KW_SearchQuestions]
	@ApplicationID		uniqueidentifier,
	@SearchText			nvarchar(1000),
	@Count				int
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SET @SearchText = [dbo].[GFN_VerifyString](@SearchText)
	
	DECLARE @_ST nvarchar(1000) = @SearchText
	IF @SearchText IS NULL OR @SearchText = N'' SET @_ST = NULL
	
	IF @Count IS NULL OR @Count <= 0 SET @Count = 1000000000
	
	IF @_ST IS NULL BEGIN
		SELECT TOP(@Count) Title AS Value
		FROM [dbo].[KW_Questions]
		WHERE ApplicationID = @ApplicationID AND Deleted = 0
	END
	ELSE BEGIN
		SELECT TOP(@Count) Title AS Value
		FROM CONTAINSTABLE([dbo].[KW_Questions], [Title], @_ST) AS SRCH
			INNER JOIN [dbo].[KW_Questions] AS Q
			ON Q.QuestionID = [SRCH].[Key]
		WHERE Q.ApplicationID = @ApplicationID AND Deleted = 0
		ORDER BY SRCH.[Rank] DESC
	END
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[KW_GetAnswerOptions]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[KW_GetAnswerOptions]
GO

CREATE PROCEDURE [dbo].[KW_GetAnswerOptions]
	@ApplicationID		uniqueidentifier,
	@strTypeQuestionIDs	varchar(max),
	@delimiter			char
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @TypeQuestionIDs GuidTableType
	
	INSERT INTO @TypeQuestionIDs (Value)
	SELECT Ref.Value
	FROM [dbo].[GFN_StrToGuidTable](@strTypeQuestionIDs, @delimiter) AS Ref
	
	SELECT	AO.ID,
			AO.TypeQuestionID, 
			AO.Title,
			AO.Value
	FROM @TypeQuestionIDs AS IDs
		INNER JOIN [dbo].[KW_TypeQuestions] AS TQ
		ON TQ.ApplicationID = @ApplicationID AND TQ.ID = IDs.Value
		INNER JOIN [dbo].[KW_AnswerOptions] AS AO
		ON AO.ApplicationID = @ApplicationID AND AO.TypeQuestionID = TQ.ID
	WHERE TQ.Deleted = 0 AND AO.Deleted = 0
	ORDER BY AO.TypeQuestionID ASC, AO.SequenceNumber ASC
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[KW_GetFilledEvaluationForm]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[KW_GetFilledEvaluationForm]
GO

CREATE PROCEDURE [dbo].[KW_GetFilledEvaluationForm]
	@ApplicationID		uniqueidentifier,
    @KnowledgeID		uniqueidentifier,
    @UserID				uniqueidentifier,
    @WFVersionID		int
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @ScoreScale int = (
		SELECT TOP(1) ScoreScale
		FROM [dbo].[CN_Nodes] AS ND
			INNER JOIN [dbo].[KW_KnowledgeTypes] AS KT
			ON KT.ApplicationID = @ApplicationID AND KT.KnowledgeTypeID = ND.NodeTypeID
		WHERE ND.ApplicationID = @ApplicationID AND ND.NodeID = @KnowledgeID
	)
	
	DECLARE @Coeff float = CAST(ISNULL(@ScoreScale, 10) AS float) / 10.0
	
	DECLARE @LastWFVersionID int = [dbo].[KW_FN_GetWFVersionID](@ApplicationID, @KnowledgeID)
	
	IF @WFVersionID IS NULL OR @WFVersionID = @LastWFVersionID BEGIN
		SELECT	QA.QuestionID,
				QA.Title,
				O.Title AS TextValue,
				ISNULL(QA.AdminScore, QA.Score) * @Coeff AS Score,
				QA.EvaluationDate
		FROM [dbo].[KW_QuestionAnswers] AS QA
			INNER JOIN [dbo].[CN_Nodes] AS ND
			ON ND.ApplicationID = @ApplicationID AND ND.NodeID = QA.KnowledgeID
			LEFT JOIN [dbo].[KW_AnswerOptions] AS O
			ON O.ApplicationID = @ApplicationID AND O.ID = QA.SelectedOptionID
			LEFT JOIN [dbo].[KW_TypeQuestions] AS Q
			ON Q.ApplicationID = @ApplicationID AND 
				Q.KnowledgeTypeID = ND.NodeTypeID AND Q.QuestionID = QA.QuestionID
		WHERE QA.ApplicationID = @ApplicationID AND QA.KnowledgeID = @KnowledgeID AND 
			QA.UserID = @UserID AND QA.Deleted = 0
		ORDER BY Q.SequenceNumber ASC
	END
	ELSE BEGIN
		SELECT	QA.QuestionID,
				QA.Title,
				O.Title AS TextValue,
				ISNULL(QA.AdminScore, QA.Score) * @Coeff AS Score,
				QA.EvaluationDate
		FROM [dbo].[KW_QuestionAnswersHistory] AS QA
			INNER JOIN [dbo].[CN_Nodes] AS ND
			ON ND.ApplicationID = @ApplicationID AND ND.NodeID = QA.KnowledgeID
			LEFT JOIN [dbo].[KW_AnswerOptions] AS O
			ON O.ApplicationID = @ApplicationID AND O.ID = QA.SelectedOptionID
			LEFT JOIN [dbo].[KW_TypeQuestions] AS Q
			ON Q.ApplicationID = @ApplicationID AND 
				Q.KnowledgeTypeID = ND.NodeTypeID AND Q.QuestionID = QA.QuestionID
		WHERE QA.ApplicationID = @ApplicationID AND QA.KnowledgeID = @KnowledgeID AND 
			QA.UserID = @UserID AND QA.Deleted = 0 AND QA.WFVersionID = @WFVersionID
		ORDER BY Q.SequenceNumber ASC
	END
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[KW_P_CalculateKnowledgeScore]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[KW_P_CalculateKnowledgeScore]
GO

CREATE PROCEDURE [dbo].[KW_P_CalculateKnowledgeScore]
	@ApplicationID		uniqueidentifier,
    @KnowledgeID		uniqueidentifier,
    @_Result			int output
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @DateFrom datetime = (
		SELECT TOP(1) MIN(H.ActionDate)
		FROM [dbo].[KW_History] AS H
		WHERE H.ApplicationID = @ApplicationID AND
			H.KnowledgeID = @KnowledgeID AND H.[Action] = N'SendToAdmin'
	)
	
	DECLARE @Score float = 0
	
	IF EXISTS(
		SELECT TOP(1) *
		FROM [dbo].[KW_QuestionAnswers] AS QA
			LEFT JOIN [dbo].[CN_Nodes] AS ND
			INNER JOIN [dbo].[KW_TypeQuestions] AS TQ
			ON TQ.ApplicationID = @ApplicationID AND 
				TQ.KnowledgeTypeID = ND.NodeTypeID AND TQ.Deleted = 0
			ON ND.ApplicationID = @ApplicationID AND ND.NodeID = @KnowledgeID AND
				ND.NodeID = QA.KnowledgeID
		WHERE QA.ApplicationID = @ApplicationID AND QA.KnowledgeID = @KnowledgeID AND 
			QA.Deleted = 0 AND (TQ.[Weight] IS NULL OR TQ.[Weight] <= 0)
	) BEGIN
		SELECT TOP(1) @Score = (SUM(Ref.Score) / ISNULL(COUNT(Ref.UserID), 1))
		FROM (
				SELECT	QA.UserID, 
						SUM(ISNULL(ISNULL(QA.AdminScore, QA.Score), 0)) / ISNULL(COUNT(QA.QuestionID), 1) AS Score
				FROM [dbo].[KW_QuestionAnswers] AS QA
				WHERE QA.ApplicationID = @ApplicationID AND 
					QA.KnowledgeID = @KnowledgeID AND QA.Deleted = 0 AND
					(@DateFrom IS NULL OR QA.EvaluationDate > @DateFrom)
				GROUP BY QA.UserID
			) AS Ref
	END
	ELSE BEGIN
		SELECT TOP(1) @Score = (SUM(Ref.Score) / ISNULL(COUNT(Ref.UserID), 1))
		FROM (
				SELECT	QA.UserID,
						SUM((TQ.[Weight] * ISNULL(ISNULL(QA.AdminScore, QA.Score), 0))) / SUM(TQ.[Weight]) AS Score
				FROM [dbo].[KW_QuestionAnswers] AS QA
					INNER JOIN [dbo].[CN_Nodes] AS ND
					INNER JOIN [dbo].[KW_TypeQuestions] AS TQ
					ON TQ.ApplicationID = @ApplicationID AND 
						TQ.KnowledgeTypeID = ND.NodeTypeID AND TQ.Deleted = 0
					ON ND.ApplicationID = @ApplicationID AND ND.NodeID = @KnowledgeID AND
						ND.NodeID = QA.KnowledgeID
				WHERE QA.ApplicationID = @ApplicationID AND 
					QA.KnowledgeID = @KnowledgeID AND QA.Deleted = 0 AND
					(@DateFrom IS NULL OR QA.EvaluationDate > @DateFrom)
				GROUP BY QA.UserID
			) AS Ref
	END
	
	UPDATE [dbo].[CN_Nodes]
		SET Score = @Score
	WHERE ApplicationID = @ApplicationID AND NodeID = @KnowledgeID
	
	SET @_Result = @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[KW_GetEvaluationsDone]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[KW_GetEvaluationsDone]
GO

CREATE PROCEDURE [dbo].[KW_GetEvaluationsDone]
	@ApplicationID		uniqueidentifier,
    @KnowledgeID		uniqueidentifier,
    @WFVersionID		int
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @DateFrom datetime = (
		SELECT TOP(1) MIN(H.ActionDate)
		FROM [dbo].[KW_History] AS H
		WHERE H.ApplicationID = @ApplicationID AND
			H.KnowledgeID = @KnowledgeID AND H.[Action] = N'SendToAdmin'
	)
	
	DECLARE @LastVersionID int = [dbo].[KW_FN_GetWFVersionID](@ApplicationID, @KnowledgeID)
	
	SELECT *
	FROM (
			SELECT	Ref.UserID,
					UN.UserName,
					UN.FirstName,
					UN.LastName,
					Ref.Score,
					Ref.EvaluationDate,
					@LastVersionID AS WFVersionID
			FROM (
					SELECT A.UserID, (SUM(ISNULL(ISNULL(A.AdminScore, A.Score), 0)) / ISNULL(COUNT(A.UserID), 1)) AS Score,
						MAX(A.EvaluationDate) AS EvaluationDate
					FROM [dbo].[KW_QuestionAnswers] AS A
					WHERE A.ApplicationID = @ApplicationID AND 
						A.KnowledgeID = @KnowledgeID AND A.Deleted = 0 AND
						(@DateFrom IS NULL OR A.EvaluationDate > @DateFrom)
					GROUP BY A.UserID
				) AS Ref
				LEFT JOIN [dbo].[Users_Normal] AS UN
				ON UN.ApplicationID = @ApplicationID AND UN.UserID = Ref.UserID
			WHERE @WFVersionID IS NULL OR @LastVersionID = @WFVersionID
	
			UNION ALL
	
			SELECT	Ref.UserID,
					UN.UserName,
					UN.FirstName,
					UN.LastName,
					Ref.Score,
					Ref.EvaluationDate,
					Ref.WFVersionID
			FROM (
					SELECT A.UserID, (SUM(ISNULL(ISNULL(A.AdminScore, A.Score), 0)) / ISNULL(COUNT(A.UserID), 1)) AS Score,
						MAX(A.EvaluationDate) AS EvaluationDate, A.WFVersionID
					FROM [dbo].[KW_QuestionAnswersHistory] AS A
					WHERE A.ApplicationID = @ApplicationID AND 
						A.KnowledgeID = @KnowledgeID AND A.Deleted = 0 AND
						(@DateFrom IS NULL OR A.EvaluationDate > @DateFrom) AND
						(@WFVersionID IS NULL OR A.WFVersionID = @WFVersionID)
					GROUP BY A.UserID, A.WFVersionID
				) AS Ref
				LEFT JOIN [dbo].[Users_Normal] AS UN
				ON UN.ApplicationID = @ApplicationID AND UN.UserID = Ref.UserID
		) AS X
	ORDER BY X.WFVersionID DESC, X.EvaluationDate DESC
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[KW_HasEvaluated]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[KW_HasEvaluated]
GO

CREATE PROCEDURE [dbo].[KW_HasEvaluated]
	@ApplicationID	uniqueidentifier,
    @KnowledgeID	uniqueidentifier,
    @UserID			uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT TOP(1) CAST(1 AS bit)
	FROM [dbo].[KW_QuestionAnswers] AS A
	WHERE A.ApplicationID = @ApplicationID AND A.KnowledgeID = @KnowledgeID AND 
		A.UserID = @UserID AND A.Deleted = 0
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[KW_P_AutoSetKnowledgeStatus]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[KW_P_AutoSetKnowledgeStatus]
GO

CREATE PROCEDURE [dbo].[KW_P_AutoSetKnowledgeStatus]
	@ApplicationID				uniqueidentifier,
    @NodeID						uniqueidentifier,
    @Now						datetime,
    @_SearchabilityActivated	bit output,
    @_Accepted					bit output,
    @_Result					int output
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SET @_SearchabilityActivated = 0
	SET @_Accepted = 0
	
	DECLARE @EvaluatorsCount int, @CurEvaluatorsCount int, @MinEvaluatorsCount int
	
	EXEC [dbo].[NTFN_P_GetDashboardsCount] @ApplicationID, NULL, @NodeID, NULL, 
		N'Knowledge', N'Evaluator', @EvaluatorsCount output
	
	SELECT TOP(1) @MinEvaluatorsCount = KT.MinEvaluationsCount
	FROM [dbo].[CN_Nodes] AS ND
		INNER JOIN [dbo].[KW_KnowledgeTypes] AS KT
		ON KT.ApplicationID = @ApplicationID AND KT.KnowledgeTypeID = ND.NodeTypeID
	WHERE ND.ApplicationID = @ApplicationID AND ND.NodeID = @NodeID
	
	SET @CurEvaluatorsCount = ISNULL(
		(
			SELECT TOP(1) COUNT(DISTINCT UserID)
			FROM [dbo].[KW_QuestionAnswers] AS QA
			WHERE QA.ApplicationID = @ApplicationID AND 
				QA.KnowledgeID = @NodeID AND QA.Deleted = 0
			GROUP BY QA.UserID
		), 0
	)
	
	IF @MinEvaluatorsCount IS NULL OR @MinEvaluatorsCount <= 0 OR 
		@MinEvaluatorsCount > (@EvaluatorsCount + @CurEvaluatorsCount) 
		SET @MinEvaluatorsCount = @EvaluatorsCount + @CurEvaluatorsCount
	
	IF @CurEvaluatorsCount >= @MinEvaluatorsCount BEGIN
		EXEC [dbo].[NTFN_P_ArithmeticDeleteDashboards] @ApplicationID, 
			NULL, @NodeID, NULL, N'Knowledge', NULL, @_Result output
			
		IF @_Result <= 0 RETURN
	
		DECLARE @St varchar(50), @Sc float
		
		SELECT TOP(1) @St = ND.[Status], @Sc = ND.Score
		FROM [dbo].[CN_Nodes] AS ND 
		WHERE ND.ApplicationID = @ApplicationID AND ND.NodeID = @NodeID
		
		DECLARE @Acceptable bit = (
			SELECT TOP(1) 
				CASE
					WHEN ISNULL(@Sc, 0) >= (
							(ISNULL(KT.MinAcceptableScore, 0) * 10) / 
							ISNULL(CASE WHEN KT.ScoreScale = 0 THEN 1 ELSE KT.ScoreScale END, 1)
						) THEN CAST(1 AS bit)
					ELSE CAST(0 AS bit)
				END
			FROM [dbo].[CN_Nodes] AS ND
				INNER JOIN [dbo].[KW_KnowledgeTypes] AS KT
				ON KT.ApplicationID = @ApplicationID AND KT.KnowledgeTypeID = ND.NodeTypeID
			WHERE ND.ApplicationID = @ApplicationID AND ND.NodeID = @NodeID
		)
		
		IF (@Acceptable = 1 AND @St <> N'Accepted') OR 
			(ISNULL(@Acceptable, 0) = 0 AND @St <> N'Rejected') BEGIN
			UPDATE [dbo].[CN_Nodes]
				SET [Status] = CASE WHEN @Acceptable = 1 THEN N'Accepted' ELSE N'Rejected' END,
					[PublicationDate] = @Now
			WHERE ApplicationID = @ApplicationID AND NodeID = @NodeID
			
			IF @Acceptable = 1 SET @_Accepted = 1
		END
		
		DECLARE @IsSearchable bit = (
			SELECT TOP(1) ND.Searchable
			FROM [dbo].[CN_Nodes] AS ND 
			WHERE ND.ApplicationID = @ApplicationID AND ND.NodeID = @NodeID
		)
		
		IF ISNULL(@IsSearchable, 0) = 0 AND @_Accepted = 1 BEGIN
			UPDATE [dbo].[CN_Nodes]
				SET Searchable = 1
			WHERE ApplicationID = @ApplicationID AND NodeID = @NodeID
			
			-- Set searchability of previous version
			/*
			DECLARE @PreviousVersionID uniqueidentifier = (
				SELECT TOP(1) PreviousVersionID
				FROM [dbo].[CN_Nodes]
				WHERE ApplicationID = @ApplicationID AND NodeID = @NodeID
			)
			
			IF @PreviousVersionID IS NOT NULL BEGIN
				UPDATE [dbo].[CN_Nodes]
					SET [Searchable] = 0
				WHERE ApplicationID = @ApplicationID AND NodeID = @PreviousVersionID
			END
			*/
			-- end of Set searchability of previous version
			
			SET @_SearchabilityActivated = 1
		END
	END
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[KW_P_AcceptRejectKnowledge]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[KW_P_AcceptRejectKnowledge]
GO

CREATE PROCEDURE [dbo].[KW_P_AcceptRejectKnowledge]
	@ApplicationID	uniqueidentifier,
    @NodeID			uniqueidentifier,
    @Accept			bit,
    @_Result		int output
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @Searchable bit = CAST((CASE WHEN @Accept = 1 THEN 1 ELSE 0 END) AS bit)
	
	UPDATE [dbo].[CN_Nodes]
		SET [Status] = CASE WHEN @Accept = 1 THEN N'Accepted' ELSE N'Rejected' END,
			[Searchable] = @Searchable
	WHERE ApplicationID = @ApplicationID AND NodeID = @NodeID
	
	IF @@ROWCOUNT <= 0 BEGIN
		SET @_Result = -1
		RETURN
	END
	
	IF @Searchable = 1 BEGIN
		DECLARE @PreviousVersionID uniqueidentifier = (
			SELECT TOP(1) PreviousVersionID
			FROM [dbo].[CN_Nodes]
			WHERE ApplicationID = @ApplicationID AND NodeID = @NodeID
		)
		
		IF @PreviousVersionID IS NOT NULL BEGIN
			UPDATE [dbo].[CN_Nodes]
				SET [Searchable] = 0
			WHERE ApplicationID = @ApplicationID AND NodeID = @PreviousVersionID
		END
	END
	
	EXEC [dbo].[NTFN_P_ArithmeticDeleteDashboards] @ApplicationID, 
		NULL, @NodeID, NULL, N'Knowledge', NULL, @_Result output
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[KW_AcceptRejectKnowledge]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[KW_AcceptRejectKnowledge]
GO

CREATE PROCEDURE [dbo].[KW_AcceptRejectKnowledge]
	@ApplicationID	uniqueidentifier,
    @NodeID			uniqueidentifier,
    @CurrentUserID	uniqueidentifier,
    @Accept			bit,
    @TextOptions	nvarchar(1000),
    @Description	nvarchar(2000),
    @Now			datetime
WITH ENCRYPTION
AS
BEGIN TRANSACTION
	SET NOCOUNT ON
	
	DECLARE @_Result int
	
	EXEC [dbo].[KW_P_AcceptRejectKnowledge] @ApplicationID, @NodeID, @Accept, @_Result output
	
	IF @_Result <= 0 BEGIN
		SELECT @_Result
		ROLLBACK TRANSACTION
		RETURN
	END
	
	-- Create history
	INSERT INTO [dbo].[KW_History](
		ApplicationID,
		KnowledgeID,
		[Action],
		TextOptions,
		[Description],
		ActorUserID,
		ActionDate,
		WFVersionID,
		UniqueID
	)
	VALUES(
		@ApplicationID,
		@NodeID,
		CASE WHEN ISNULL(@Accept, 0) = 1 THEN N'Accept' ELSE N'Reject' END,
		@TextOptions,
		@Description,
		@CurrentUserID,
		@Now,
		[dbo].[KW_FN_GetWFVersionID](@ApplicationID, @NodeID),
		NEWID()
	)
	
	IF @@ROWCOUNT <= 0 BEGIN
		SELECT -1
		ROLLBACK TRANSACTION
		RETURN
	END
	-- end of create history
	
	SELECT 1
COMMIT TRANSACTION

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[KW_SendToAdmin]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[KW_SendToAdmin]
GO

CREATE PROCEDURE [dbo].[KW_SendToAdmin]
	@ApplicationID		uniqueidentifier,
    @NodeID				uniqueidentifier,
    @CurrentUserID		uniqueidentifier,
    @strAdminUserIDs	varchar(max),
    @delimiter			char,
    @Description		nvarchar(2000),
    @Now				datetime
WITH ENCRYPTION
AS
BEGIN TRANSACTION
	SET NOCOUNT ON
	
	/* Steps: */
	-- 1: Set knowledge status to 'SentToAdmin'
	-- 2: Create history
	-- 3: Send old evaluations to history
	-- 4: Remove all existing dashboards
	-- 5: Send new dashboards to admins
	
	-- Find AdminIDs
	DECLARE @AdminUserIDs GuidTableType
	
	INSERT INTO @AdminUserIDs
	SELECT Ref.Value
	FROM [dbo].[GFN_StrToGuidTable](@strAdminUserIDs, @delimiter) AS Ref
	-- end of Find AdminIDs
	
	
	-- Check if is new workflow
	DECLARE @IsNewVersion bit = 0
	
	IF EXISTS(
		SELECT TOP(1) ND.NodeID
		FROM [dbo].[CN_Nodes] AS ND
		WHERE ND.ApplicationID = @ApplicationID AND ND.NodeID = @NodeID AND ND.[Status] = N'Rejected'
	) SET @IsNewVersion = 1
	
	DECLARE @WFVersionID int = [dbo].[KW_FN_GetWFVersionID](@ApplicationID, @NodeID)
	DECLARE @NewWFVersionID int = @WFVersionID + (CASE WHEN @IsNewVersion = 1 THEN 1 ELSE 0 END)
	-- end of Check if is new workflow
	
	
	-- Set new knowledge status
	UPDATE [dbo].[CN_Nodes]
		SET [Status] = N'SentToAdmin'
	WHERE ApplicationID = @ApplicationID AND NodeID = @NodeID
	
	IF @@ROWCOUNT <= 0 BEGIN
		SELECT -1
		ROLLBACK TRANSACTION
		RETURN
	END
	-- end of set new knowledge status
	
	
	-- Create history
	INSERT INTO [dbo].[KW_History](
		ApplicationID,
		KnowledgeID,
		[Action],
		[Description],
		ActorUserID,
		ActionDate,
		WFVersionID,
		UniqueID
	)
	VALUES(
		@ApplicationID,
		@NodeID,
		N'SendToAdmin',
		@Description,
		@CurrentUserID,
		@Now,
		@NewWFVersionID,
		NEWID()
	)
	
	IF @@ROWCOUNT <= 0 BEGIN
		SELECT -1
		ROLLBACK TRANSACTION
		RETURN
	END
	-- end of create history
	
	-- send old evaluations to history
	
	DECLARE @VersionID uniqueidentifier = NEWID()
	
	INSERT INTO [dbo].[KW_QuestionAnswersHistory] (ApplicationID, VersionID, KnowledgeID, UserID, QuestionID,  Title, Score, 
		EvaluationDate, Deleted, SelectedOptionID, VersionDate, AdminScore, AdminSelectedOptionID, AdminID, WFVersionID)
	SELECT A.ApplicationID, @VersionID, A.KnowledgeID, A.UserID, A.QuestionID, A.Title, A.Score, 
		A.EvaluationDate, A.Deleted, A.SelectedOptionID, @Now, A.AdminScore, A.AdminSelectedOptionID, A.AdminID, @WFVersionID
	FROM [dbo].[KW_QuestionAnswers] AS A
	WHERE A.ApplicationID = @ApplicationID AND A.KnowledgeID = @NodeID
	
	DELETE [dbo].[KW_QuestionAnswers]
	WHERE ApplicationID = @ApplicationID AND KnowledgeID = @NodeID 
	
	-- end of send old evaluations to history
	
	DECLARE @_Result int
	
	-- Remove all existing dashboards
	EXEC [dbo].[NTFN_P_ArithmeticDeleteDashboards] @ApplicationID, 
		NULL, @NodeID, NULL, NULL, NULL, @_Result output
	
	IF @_Result <= 0 BEGIN
		SELECT -1
		ROLLBACK TRANSACTION
		RETURN
	END
	-- end of remove all existing dashboards
	
	-- Send new dashboards
	DECLARE @Dashboards DashboardTableType
	
	INSERT INTO @Dashboards(UserID, NodeID, RefItemID, [Type], SubType, Removable, SendDate, Info)
	SELECT	Ref.Value, 
			@NodeID,
			@NodeID,
			N'Knowledge',
			N'Admin',
			0,
			@Now,
			N'{"WFVersionID":' + CAST(@NewWFVersionID AS nvarchar(50)) + N'}'
	FROM @AdminUserIDs AS Ref
	
	EXEC [dbo].[NTFN_P_SendDashboards] @ApplicationID, @Dashboards, @_Result output
	
	IF @_Result <= 0 BEGIN
		SELECT -1
		ROLLBACK TRANSACTION
		RETURN
	END
	ELSE BEGIN
		SELECT * 
		FROM @Dashboards
	END
	-- end of send new dashboards
COMMIT TRANSACTION

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[KW_SendBackForRevision]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[KW_SendBackForRevision]
GO

CREATE PROCEDURE [dbo].[KW_SendBackForRevision]
	@ApplicationID		uniqueidentifier,
    @NodeID				uniqueidentifier,
    @CurrentUserID		uniqueidentifier,
    @TextOptions		nvarchar(1000),
    @Description		nvarchar(2000),
    @Now				datetime
WITH ENCRYPTION
AS
BEGIN TRANSACTION
	SET NOCOUNT ON
	
	/* Steps: */
	-- 1: Set knowledge status to 'SentBackForRevision'
	-- 2: Create history
	-- 3: Set current user's admin dashboard as done
	-- 4: Remove all existing dashboards
	-- 5: Send new dashboards to admins
	
	-- Set new knowledge status
	UPDATE [dbo].[CN_Nodes]
		SET [Status] = N'SentBackForRevision'
	WHERE ApplicationID = @ApplicationID AND NodeID = @NodeID
	
	IF @@ROWCOUNT <= 0 BEGIN
		SELECT -1
		ROLLBACK TRANSACTION
		RETURN
	END
	-- end of set new knowledge status
	
	-- Create history
	INSERT INTO [dbo].[KW_History](
		ApplicationID,
		KnowledgeID,
		[Action],
		TextOptions,
		[Description],
		ActorUserID,
		ActionDate,
		WFVersionID,
		UniqueID
	)
	VALUES(
		@ApplicationID,
		@NodeID,
		N'SendBackForRevision',
		@TextOptions,
		@Description,
		@CurrentUserID,
		@Now,
		[dbo].[KW_FN_GetWFVersionID](@ApplicationID, @NodeID),
		NEWID()
	)
	
	IF @@ROWCOUNT <= 0 BEGIN
		SELECT -1
		ROLLBACK TRANSACTION
		RETURN
	END
	-- end of create history
	
	DECLARE @_Result int
	
	-- Set dashboards as done
	EXEC [dbo].[NTFN_P_SetDashboardsAsDone] @ApplicationID,
		@CurrentUserID, @NodeID, NULL, N'Knowledge', N'Admin', @Now, @_Result output
	
	IF @_Result <= 0 BEGIN
		SELECT -1
		ROLLBACK TRANSACTION
		RETURN
	END
	-- end of set dashboards as done
	
	-- Remove all existing dashboards
	EXEC [dbo].[NTFN_P_ArithmeticDeleteDashboards] @ApplicationID, 
		NULL, @NodeID, NULL, NULL, NULL, @_Result output
	
	IF @_Result <= 0 BEGIN
		SELECT -1
		ROLLBACK TRANSACTION
		RETURN
	END
	-- end of remove all existing dashboards
	
	-- Send new dashboards
	DECLARE @Dashboards DashboardTableType
	
	INSERT INTO @Dashboards(UserID, NodeID, RefItemID, [Type], SubType, Removable, SendDate)
	SELECT	ND.CreatorUserID,
			@NodeID,
			@NodeID,
			N'Knowledge',
			N'Revision',
			1,
			@Now
	FROM [dbo].[CN_Nodes] AS ND
	WHERE ND.ApplicationID = @ApplicationID AND ND.NodeID = @NodeID
	
	EXEC [dbo].[NTFN_P_SendDashboards] @ApplicationID, @Dashboards, @_Result output
	
	IF @_Result <= 0 BEGIN
		SELECT -1
		ROLLBACK TRANSACTION
		RETURN
	END
	ELSE BEGIN
		SELECT * 
		FROM @Dashboards
	END
	-- end of send new dashboards
COMMIT TRANSACTION

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[KW_P_NewEvaluators]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[KW_P_NewEvaluators]
GO

CREATE PROCEDURE [dbo].[KW_P_NewEvaluators]
	@ApplicationID			uniqueidentifier,
    @NodeID					uniqueidentifier,
    @EvaluatorUserIDsTemp	GuidTableType readonly,
    @Now					datetime,
    @_Result				int output
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @EvaluatorUserIDs GuidTableType
	INSERT INTO @EvaluatorUserIDs SELECT * FROM @EvaluatorUserIDsTemp
	
	/* Steps: */
	-- 1: Send new dashboards to admins
	
	-- Send new dashboards
	DECLARE @Dashboards DashboardTableType
	
	INSERT INTO @Dashboards(UserID, NodeID, RefItemID, [Type], SubType, Removable, SendDate)
	SELECT	EV.Value,
			@NodeID,
			@NodeID,
			N'Knowledge',
			N'Evaluator',
			0,
			@Now
	FROM @EvaluatorUserIDs AS EV
	
	EXEC [dbo].[NTFN_P_SendDashboards] @ApplicationID, @Dashboards, @_Result output
	
	IF @_Result > 0 BEGIN
		SELECT * 
		FROM @Dashboards
	END
	-- end of send new dashboards
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[KW_NewEvaluators]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[KW_NewEvaluators]
GO

CREATE PROCEDURE [dbo].[KW_NewEvaluators]
	@ApplicationID			uniqueidentifier,
    @NodeID					uniqueidentifier,
    @strEvaluatorUserIDs	varchar(max),
    @delimiter				char,
    @Now					datetime
WITH ENCRYPTION
AS
BEGIN TRANSACTION
	SET NOCOUNT ON
	
	/* Steps: */
	-- 1: Send new dashboards to admins
	
	DECLARE @EvaluatorUserIDs GuidTableType
	
	INSERT INTO @EvaluatorUserIDs
	SELECT Ref.Value
	FROM [dbo].[GFN_StrToGuidTable](@strEvaluatorUserIDs, @delimiter) AS Ref
	
	DECLARE @_Result int
	
	-- Send new dashboards
	EXEC [dbo].[KW_P_NewEvaluators] @ApplicationID, 
		@NodeID, @EvaluatorUserIDs, @Now, @_Result output
	
	IF @_Result <= 0 BEGIN
		SELECT -1
		ROLLBACK TRANSACTION
		RETURN
	END
	-- end of send new dashboards
COMMIT TRANSACTION

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[KW_SendToEvaluators]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[KW_SendToEvaluators]
GO

CREATE PROCEDURE [dbo].[KW_SendToEvaluators]
	@ApplicationID			uniqueidentifier,
    @NodeID					uniqueidentifier,
    @CurrentUserID			uniqueidentifier,
    @strEvaluatorUserIDs	varchar(max),
    @delimiter				char,
    @Description			nvarchar(2000),
    @Now					datetime
WITH ENCRYPTION
AS
BEGIN TRANSACTION
	SET NOCOUNT ON
	
	/* Steps: */
	-- 1: Set knowledge status to 'SentToEvaluators'
	-- 2: Create History
	-- 3: Set current user's admin dashboard as done
	-- 4: Remove all existing dashboards
	-- 5: Send new dashboards to admins
	
	DECLARE @EvaluatorUserIDs GuidTableType
	
	INSERT INTO @EvaluatorUserIDs
	SELECT Ref.Value
	FROM [dbo].[GFN_StrToGuidTable](@strEvaluatorUserIDs, @delimiter) AS Ref
	
	DECLARE @SearchableAfter varchar(50) = (
		SELECT KT.SearchableAfter
		FROM [dbo].[CN_Nodes] AS ND
			INNER JOIN [dbo].[KW_KnowledgeTypes] AS KT
			ON KT.ApplicationID = @ApplicationID AND KT.KnowledgeTypeID = ND.NodeTypeID
		WHERE ND.ApplicationID = @ApplicationID AND ND.NodeID = @NodeID
	)
	
	-- Set new knowledge status
	DECLARE @SearchabilityStatus bit = ISNULL((
		SELECT TOP(1) Searchable
		FROM [dbo].[CN_Nodes]
		WHERE ApplicationID = @ApplicationID AND NodeID = @NodeID
	), 1)
	
	DECLARE @Searchable bit = CAST((
		CASE 
			WHEN @SearchableAfter = N'Confirmation' THEN 1 
			ELSE @SearchabilityStatus 
		END
	) AS bit)
	
	UPDATE [dbo].[CN_Nodes]
		SET [Status] = N'SentToEvaluators',
			Searchable = CASE WHEN @SearchableAfter = N'Confirmation' THEN 1 ELSE Searchable END
	WHERE ApplicationID = @ApplicationID AND NodeID = @NodeID
	
	IF @@ROWCOUNT <= 0 BEGIN
		SELECT -1
		ROLLBACK TRANSACTION
		RETURN
	END
	-- end of set new knowledge status
	
	-- Set searchability of previous version
	IF @SearchabilityStatus = 0 AND @Searchable = 1 BEGIN
		DECLARE @PreviousVersionID uniqueidentifier = (
			SELECT TOP(1) PreviousVersionID
			FROM [dbo].[CN_Nodes]
			WHERE ApplicationID = @ApplicationID AND NodeID = @NodeID
		)
		
		IF @PreviousVersionID IS NOT NULL BEGIN
			UPDATE [dbo].[CN_Nodes]
				SET [Searchable] = 0
			WHERE ApplicationID = @ApplicationID AND NodeID = @PreviousVersionID
		END
	END
	-- end of Set searchability of previous version
	
	-- Create history
	INSERT INTO [dbo].[KW_History](
		ApplicationID,
		KnowledgeID,
		[Action],
		[Description],
		ActorUserID,
		ActionDate,
		WFVersionID,
		UniqueID
	)
	VALUES(
		@ApplicationID,
		@NodeID,
		N'SendToEvaluators',
		@Description,
		@CurrentUserID,
		@Now,
		[dbo].[KW_FN_GetWFVersionID](@ApplicationID, @NodeID),
		NEWID()
	)
	
	IF @@ROWCOUNT <= 0 BEGIN
		SELECT -1
		ROLLBACK TRANSACTION
		RETURN
	END
	-- end of create history
	
	DECLARE @_Result int
	
	-- Set dashboards as done
	EXEC [dbo].[NTFN_P_SetDashboardsAsDone] @ApplicationID,
		@CurrentUserID, @NodeID, NULL, N'Knowledge', N'Admin', @Now, @_Result output
	
	IF @_Result <= 0 BEGIN
		SELECT -1
		ROLLBACK TRANSACTION
		RETURN
	END
	-- end of set dashboards as done
	
	-- Remove all existing dashboards
	EXEC [dbo].[NTFN_P_ArithmeticDeleteDashboards] @ApplicationID, 
		NULL, @NodeID, NULL, NULL, NULL, @_Result output
	
	IF @_Result <= 0 BEGIN
		SELECT -1
		ROLLBACK TRANSACTION
		RETURN
	END
	-- end of remove all existing dashboards
	
	-- Send new dashboards
	EXEC [dbo].[KW_P_NewEvaluators] @ApplicationID, 
		@NodeID, @EvaluatorUserIDs, @Now, @_Result output
	
	IF @_Result <= 0 BEGIN
		SELECT -1
		ROLLBACK TRANSACTION
		RETURN
	END
	-- end of send new dashboards
COMMIT TRANSACTION

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[KW_SendKnowledgeComment]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[KW_SendKnowledgeComment]
GO

CREATE PROCEDURE [dbo].[KW_SendKnowledgeComment]
	@ApplicationID		uniqueidentifier,
    @NodeID				uniqueidentifier,
    @UserID				uniqueidentifier,
    @ReplyToHistoryID	bigint,
    @strAudienceUserIDs	varchar(max),
    @delimiter			char,
    @Description		nvarchar(2000),
    @Now				datetime
WITH ENCRYPTION
AS
BEGIN TRANSACTION
	SET NOCOUNT ON
	
	DECLARE @AudienceUserIDs GuidTableType
	
	INSERT INTO @AudienceUserIDs (Value)
	SELECT DISTINCT Ref.Value
	FROM [dbo].[GFN_StrToGuidTable](@strAudienceUserIDs, @delimiter) AS Ref
	
	-- Create history
	INSERT INTO [dbo].[KW_History](
		ApplicationID,
		KnowledgeID,
		[Action],
		ActorUserID,
		ActionDate,
		[Description],
		ReplyToHistoryID,
		WFVersionID,
		UniqueID
	)
	VALUES(
		@ApplicationID,
		@NodeID,
		N'Comment',
		@UserID,
		@Now,
		[dbo].[GFN_VerifyString](@Description),
		@ReplyToHistoryID,
		[dbo].[KW_FN_GetWFVersionID](@ApplicationID, @NodeID),
		NEWID()
	)
	
	IF @@ROWCOUNT <= 0 BEGIN
		SELECT -1
		ROLLBACK TRANSACTION
		RETURN
	END
	-- end of create history
	
	DECLARE @_Result int = 0
	
	DECLARE @Dashboards DashboardTableType
	
	-- Send new dashboards
	
	DECLARE @CreatorUserID uniqueidentifier = (
		SELECT TOP(1) ND.CreatorUserID
		FROM [dbo].[CN_Nodes] AS ND
		WHERE ND.ApplicationID = @ApplicationID AND ND.NodeID = @NodeID
	)
	
	DECLARE @UserName nvarchar(1000), @FirstName nvarchar(1000), @LastName nvarchar(1000)
	
	SELECT TOP(1) @UserName = UserName, @FirstName = FirstName, @LastName = LastName
	FROM [dbo].[Users_Normal]
	WHERE ApplicationID = @ApplicationID AND UserID = @UserID
	
	INSERT INTO @Dashboards(UserID, NodeID, RefItemID, [Type], SubType, Removable, SendDate, Info)
	SELECT	A.Value,
			@NodeID,
			@NodeID,
			N'Knowledge',
			N'KnowledgeComment',
			1,
			@Now,
			N'{"UserID":"' + CAST(@UserID AS nvarchar(50)) + N'"' +
				N',"UserName":"' + [dbo].[GFN_Base64Encode](@UserName) + N'"' +
				N',"FirstName":"' + [dbo].[GFN_Base64Encode](@FirstName) + N'"' +
				N',"LastName":"' + [dbo].[GFN_Base64Encode](@LastName) + N'"' +
			N'}'
	FROM @AudienceUserIDs AS A
	
	EXEC [dbo].[NTFN_P_SendDashboards] @ApplicationID, @Dashboards, @_Result output
	
	IF @_Result <= 0 BEGIN
		SELECT -1
		ROLLBACK TRANSACTION
		RETURN
	END
	
	-- end of send new dashboards
	
	SELECT * 
	FROM @Dashboards
COMMIT TRANSACTION

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[KW_SaveEvaluationForm]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[KW_SaveEvaluationForm]
GO

CREATE PROCEDURE [dbo].[KW_SaveEvaluationForm]
	@ApplicationID		uniqueidentifier,
    @NodeID				uniqueidentifier,
    @UserID				uniqueidentifier,
    @CurrentUserID		uniqueidentifier,
    @AnswersTemp		GuidFloatTableType readonly,
    @Score				float,
    @EvaluationDate		datetime,
    @AdminUserIDsTemp	GuidTableType readonly,
    @TextOptions		nvarchar(1000),
    @Description		nvarchar(2000)
WITH ENCRYPTION, RECOMPILE
AS
BEGIN TRANSACTION
	SET NOCOUNT ON
	
	DECLARE @Answers GuidFloatTableType
	INSERT INTO @Answers SELECT * FROM @AnswersTemp
	
	DECLARE @AdminUserIDs GuidTableType
	INSERT INTO @AdminUserIDs SELECT * FROM @AdminUserIDsTemp
	
	DECLARE @Ans Table(QuestionID uniqueidentifier primary key clustered,
		Score float, [Exists] bit)
		
	INSERT INTO @Ans (QuestionID, Score, [Exists])
	SELECT Ref.FirstValue, Ref.SecondValue, CASE WHEN QA.KnowledgeID IS NULL THEN 0 ELSE 1 END
	FROM @Answers AS Ref
		LEFT JOIN [dbo].[KW_QuestionAnswers] AS QA
		ON QA.ApplicationID = @ApplicationID AND QA.KnowledgeID = @NodeID AND 
			QA.UserID = @UserID AND QA.QuestionID = Ref.FirstValue
			
	DECLARE @Count int = (SELECT COUNT(*) FROM @Ans)
	DECLARE @ExistingCount int = (SELECT COUNT(*) FROM @Ans WHERE [Exists] = 1)
	
	DECLARE @Devoluted bit = 0
	
	IF @CurrentUserID IS NOT NULL AND @UserID IS NOT NULL AND @CurrentUserID <> @UserID SET @Devoluted = 1
	
	IF @ExistingCount > 0 BEGIN
		UPDATE QA
			SET Title = Q.Title,
				Score = CASE WHEN @Devoluted = 1 THEN QA.Score ELSE Ref.Score END,
				--SelectedOptionID = CASE WHEN @Devoluted = 1 THEN QA.SelectedOptionID ELSE Ref.SelectedOptionID END,
				AdminID = CASE WHEN @Devoluted = 1 THEN @CurrentUserID ELSE NULL END,
				AdminScore = CASE WHEN @Devoluted = 1 THEN Ref.Score ELSE QA.AdminScore END,
				EvaluationDate = @EvaluationDate,
				Deleted = 0
		FROM @Ans AS Ref
			INNER JOIN [dbo].[KW_QuestionAnswers] AS QA
			ON QA.QuestionID = Ref.QuestionID
			INNER JOIN [dbo].[KW_Questions] AS Q
			ON Q.ApplicationID = @ApplicationID AND Q.QuestionID = Ref.QuestionID
		WHERE QA.ApplicationID = @ApplicationID AND Ref.[Exists] = 1 AND 
			QA.KnowledgeID = @NodeID AND QA.UserID = @UserID
			
		IF @@ROWCOUNT <= 0 BEGIN
			SELECT -1, N'SavingEvaluationFormFailed'
			ROLLBACK TRANSACTION
			RETURN
		END
	END
	
	IF @Count > @ExistingCount BEGIN
		INSERT INTO [dbo].[KW_QuestionAnswers](
			ApplicationID,
			KnowledgeID,
			UserID,
			QuestionID,
			Title,
			Score,
			AdminID,
			AdminScore,
			EvaluationDate,
			Deleted
		)
		SELECT	@ApplicationID,
				@NodeID, 
				@UserID, 
				Ref.QuestionID, 
				Q.Title, 
				Ref.Score,
				CASE WHEN @Devoluted = 1 THEN @CurrentUserID ELSE NULL END,
				CASE WHEN @Devoluted = 1 THEN Ref.Score ELSE NULL END,
				@EvaluationDate,
				0
		FROM @Ans AS Ref
			INNER JOIN [dbo].[KW_Questions] AS Q
			ON Q.QuestionID = Ref.QuestionID
		WHERE Q.ApplicationID = @ApplicationID AND ISNULL(Ref.[Exists], 0) = 0
		
		IF @@ROWCOUNT <= 0 BEGIN
			SELECT -1, N'SavingEvaluationFormFailed'
			ROLLBACK TRANSACTION
			RETURN
		END
	END
	
	-- Create history
	INSERT INTO [dbo].[KW_History](
		ApplicationID,
		KnowledgeID,
		[Action],
		ActorUserID,
		ActionDate,
		DeputyUserID,
		TextOptions,
		[Description],
		WFVersionID,
		UniqueID
	)
	VALUES(
		@ApplicationID,
		@NodeID,
		N'Evaluation',
		@UserID,
		@EvaluationDate,
		CASE WHEN @Devoluted = 1 THEN @CurrentUserID ELSE NULL END,
		@TextOptions,
		[dbo].[GFN_VerifyString](@Description),
		[dbo].[KW_FN_GetWFVersionID](@ApplicationID, @NodeID),
		NEWID()
	)
	
	IF @@ROWCOUNT <= 0 BEGIN
		SELECT -1
		ROLLBACK TRANSACTION
		RETURN
	END
	-- end of create history
	
	DECLARE @_Result int = 0
	
	EXEC [dbo].[KW_P_CalculateKnowledgeScore] @ApplicationID, @NodeID, @_Result output
	
	IF @_Result <= 0 BEGIN
		SELECT -1, N'ScoreCalculationFailed'
		ROLLBACK TRANSACTION
		RETURN
	END
	
	-- Set dashboard as done
	DECLARE @Uid uniqueidentifier = ISNULL(@UserID, @CurrentUserID)
	
	DECLARE @UserName nvarchar(1000), @FirstName nvarchar(1000), @LastName nvarchar(1000)
	
	SELECT TOP(1) @UserName = UserName, @FirstName = FirstName, @LastName = LastName
	FROM [dbo].[Users_Normal]
	WHERE ApplicationID = @ApplicationID AND UserID = @Uid
	
	EXEC [dbo].[NTFN_P_SetDashboardsAsDone] @ApplicationID, @Uid, @NodeID, NULL, 
		N'Knowledge', N'Evaluator', @EvaluationDate, @_Result output
	
	IF @_Result <= 0 BEGIN
		SELECT -1
		ROLLBACK TRANSACTION
		RETURN
	END
	-- end of set dashboard as done
	
	
	DECLARE @_SearchabilityActivated bit, @_Accepted bit
	
	EXEC [dbo].[KW_P_AutoSetKnowledgeStatus] @ApplicationID, @NodeID, @EvaluationDate, 
		@_SearchabilityActivated output, @_Accepted output, @_Result output
	
	IF @_Result <= 0 BEGIN
		SELECT -1, N'DeterminingKnowledgeStatusFailed'
		ROLLBACK TRANSACTION
		RETURN
	END
	
	DECLARE @Dashboards DashboardTableType
	
	--EXEC [dbo].[NTFN_P_DashboardExists] NULL, @NodeID, N'Knowledge', 
	--	NULL, NULL, 0, NULL, NULL, @_Result output
	
	-- Send new dashboards
	--IF @_Result > 0 BEGIN
	INSERT INTO @Dashboards(UserID, NodeID, RefItemID, [Type], SubType, Removable, SendDate, Info)
	SELECT	A.Value,
			@NodeID,
			@NodeID,
			N'Knowledge',
			N'EvaluationDone',
			1,
			@EvaluationDate,
			N'{"UserID":"' + CAST(@Uid AS nvarchar(50)) + N'"' +
				N',"UserName":"' + [dbo].[GFN_Base64Encode](@UserName) + N'"' +
				N',"FirstName":"' + [dbo].[GFN_Base64Encode](@FirstName) + N'"' +
				N',"LastName":"' + [dbo].[GFN_Base64Encode](@LastName) + N'"' +
			N'}'
	FROM @AdminUserIDs AS A
	
	EXEC [dbo].[NTFN_P_SendDashboards] @ApplicationID, @Dashboards, @_Result output
	
	IF @_Result <= 0 BEGIN
		SELECT -1
		ROLLBACK TRANSACTION
		RETURN
	END
	--END
	-- end of send new dashboards
	
	SELECT * 
	FROM @Dashboards
	
	DECLARE @Status varchar(100) = (
		SELECT TOP(1) ND.[Status]
		FROM [dbo].[CN_Nodes] AS ND 
		WHERE ND.ApplicationID = @ApplicationID AND ND.NodeID = @NodeID
	)
	
	SELECT CAST(1 AS int) AS Result, 
		@_Accepted AS Accepted, @_SearchabilityActivated AS SearchabilityActivated, @Status AS [Status]
COMMIT TRANSACTION

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[KW_RemoveEvaluator]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[KW_RemoveEvaluator]
GO

CREATE PROCEDURE [dbo].[KW_RemoveEvaluator]
	@ApplicationID	uniqueidentifier,
    @NodeID			uniqueidentifier,
    @UserID			uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @_Result int
	
	EXEC [dbo].[NTFN_P_ArithmeticDeleteDashboards] @ApplicationID, 
		@UserID, @NodeID, NULL, N'Knowledge', N'Evaluator', @_Result output
		
	UPDATE [dbo].[KW_QuestionAnswers]
		SET Deleted = 1
	WHERE ApplicationID = @ApplicationID AND KnowledgeID = @NodeID AND UserID = @UserID
	
	SELECT @_Result + @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[KW_RefuseEvaluation]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[KW_RefuseEvaluation]
GO

CREATE PROCEDURE [dbo].[KW_RefuseEvaluation]
	@ApplicationID		uniqueidentifier,
    @NodeID				uniqueidentifier,
    @UserID				uniqueidentifier,
    @Now				datetime,
    @strAdminUserIDs	varchar(max),
    @delimiter			char,
    @Description		nvarchar(2000)
WITH ENCRYPTION
AS
BEGIN TRANSACTION
	SET NOCOUNT ON
	
	-- Create history
	INSERT INTO [dbo].[KW_History](
		ApplicationID,
		KnowledgeID,
		[Action],
		ActorUserID,
		ActionDate,
		[Description],
		WFVersionID,
		UniqueID
	)
	VALUES(
		@ApplicationID,
		@NodeID,
		N'RefuseEvaluation',
		@UserID,
		@Now,
		@Description,
		[dbo].[KW_FN_GetWFVersionID](@ApplicationID, @NodeID),
		NEWID()
	)
	
	IF @@ROWCOUNT <= 0 BEGIN
		SELECT -1
		ROLLBACK TRANSACTION
		RETURN
	END
	-- end of create history
	
	
	DECLARE @_Result int
	
	
	-- Remove old dashboards
	EXEC [dbo].[NTFN_P_ArithmeticDeleteDashboards] @ApplicationID, 
		@UserID, @NodeID, NULL, N'Knowledge', N'Evaluator', @_Result output
		
	IF @_Result <= 0 BEGIN
		SELECT -1
		ROLLBACK TRANSACTION
		RETURN
	END
	-- end of remove old dashboards
	
	
	-- Send new dashboards
	DECLARE @AdminUserIDs GuidTableType
	INSERT INTO @AdminUserIDs 
	SELECT Ref.Value 
	FROM [dbo].[GFN_StrToGuidTable](@strAdminUserIDs, @delimiter) AS Ref
	
	DECLARE @UserName nvarchar(1000), @FirstName nvarchar(1000), @LastName nvarchar(1000)
	SELECT @UserName = UserName, @FirstName = FirstName, @LastName = LastName
	FROM [dbo].[Users_Normal]
	WHERE ApplicationID = @ApplicationID AND UserID = @UserID
	
	DECLARE @Dashboards DashboardTableType
	
	INSERT INTO @Dashboards(UserID, NodeID, RefItemID, [Type], SubType, Removable, SendDate, Info)
	SELECT	A.Value,
			@NodeID,
			@NodeID,
			N'Knowledge',
			N'EvaluationRefused',
			1,
			@Now,
			N'{"UserID":"' + CAST(@UserID AS nvarchar(50)) + N'"' +
				N',"UserName":"' + [dbo].[GFN_Base64Encode](@UserName) + N'"' +
				N',"FirstName":"' + [dbo].[GFN_Base64Encode](@FirstName) + N'"' +
				N',"LastName":"' + [dbo].[GFN_Base64Encode](@LastName) + N'"' +
			N'}'
	FROM @AdminUserIDs AS A
	
	EXEC [dbo].[NTFN_P_SendDashboards] @ApplicationID, @Dashboards, @_Result output
	
	IF @_Result <= 0 BEGIN
		SELECT -1
		ROLLBACK TRANSACTION
		RETURN
	END
	ELSE BEGIN
		SELECT * 
		FROM @Dashboards
	END
	-- end of send new dashboards
COMMIT TRANSACTION

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[KW_TerminateEvaluation]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[KW_TerminateEvaluation]
GO

CREATE PROCEDURE [dbo].[KW_TerminateEvaluation]
	@ApplicationID	uniqueidentifier,
    @NodeID			uniqueidentifier,
    @CurrentUserID	uniqueidentifier,
    @Description	nvarchar(2000),
    @Now			datetime
WITH ENCRYPTION
AS
BEGIN TRANSACTION
	SET NOCOUNT ON
	
	DECLARE @_Result int
	
	EXEC [dbo].[NTFN_P_ArithmeticDeleteDashboards] @ApplicationID, 
		NULL, @NodeID, NULL, N'Knowledge', NULL, @_Result output
		
	IF @_Result <= 0 BEGIN
		SELECT -1
		ROLLBACK TRANSACTION
		RETURN
	END
	
	DECLARE @_Accepted bit, @_SearchabilityActivated bit
	
	EXEC [dbo].[KW_P_AutoSetKnowledgeStatus] @ApplicationID, @NodeID, @Now, 
		@_SearchabilityActivated output, @_Accepted output, @_Result output 
		
	IF @_Result <= 0 BEGIN
		SELECT -1
		ROLLBACK TRANSACTION
		RETURN
	END
	
	-- Create history
	INSERT INTO [dbo].[KW_History](
		ApplicationID,
		KnowledgeID,
		[Action],
		[Description],
		ActorUserID,
		ActionDate,
		WFVersionID,
		UniqueID
	)
	VALUES(
		@ApplicationID,
		@NodeID,
		N'TerminateEvaluation',
		@Description,
		@CurrentUserID,
		@Now,
		[dbo].[KW_FN_GetWFVersionID](@ApplicationID, @NodeID),
		NEWID()
	)
	
	IF @@ROWCOUNT <= 0 BEGIN
		SELECT -1
		ROLLBACK TRANSACTION
		RETURN
	END
	-- end of create history
	
	SELECT CAST(1 AS int) AS Result, @_Accepted AS Accepted, 
		@_SearchabilityActivated AS SearchabilityActivated
COMMIT TRANSACTION

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[KW_GetLastHistoryVersionID]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[KW_GetLastHistoryVersionID]
GO

CREATE PROCEDURE [dbo].[KW_GetLastHistoryVersionID]
	@ApplicationID	uniqueidentifier,
    @KnowledgeID	uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT TOP(1) [dbo].[KW_FN_GetWFVersionID](@ApplicationID, @KnowledgeID) AS Value
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[KW_EditHistoryDescription]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[KW_EditHistoryDescription]
GO

CREATE PROCEDURE [dbo].[KW_EditHistoryDescription]
	@ApplicationID	uniqueidentifier,
    @ID				bigint,
    @Description	nvarchar(2000)
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[KW_History]
		SET [Description] = [dbo].[GFN_VerifyString](@Description)
	WHERE ApplicationID = @ApplicationID AND ID = @ID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[KW_GetHistory]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[KW_GetHistory]
GO

CREATE PROCEDURE [dbo].[KW_GetHistory]
	@ApplicationID	uniqueidentifier,
    @KnowledgeID	uniqueidentifier,
    @UserID			uniqueidentifier,
    @Action			varchar(50),
    @WFVersionID	int
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT	H.ID,
			H.KnowledgeID,
			H.[Action],
			H.TextOptions,
			H.[Description],
			H.ActorUserID,
			UN.UserName AS ActorUserName,
			UN.FirstName AS ActorFirstName,
			UN.LastName AS ActorLastName,
			H.DeputyUserID,
			DN.UserName AS DeputyUserName,
			DN.FirstName AS DeputyFirstName,
			DN.LastName AS DeputyLastName,
			H.ActionDate,
			H.ReplyToHistoryID,
			H.WFVersionID,
			CAST((CASE WHEN ND.CreatorUserID = H.ActorUserID THEN 1 ELSE 0 END) AS bit) AS IsCreator,
			CAST((
				SELECT TOP(1) 1
				FROM [dbo].[CN_NodeCreators] AS NC
				WHERE NC.ApplicationID = @ApplicationID AND NC.NodeID = H.KnowledgeID AND 
					NC.UserID = H.[ActorUserID] AND NC.Deleted = 0
			) AS bit) AS IsContributor
	FROM [dbo].[KW_History] AS H
		INNER JOIN [dbo].[CN_Nodes] AS ND
		ON ND.ApplicationID = @ApplicationID AND ND.NodeID = H.KnowledgeID
		LEFT JOIN [dbo].[Users_Normal] AS UN
		ON UN.ApplicationID = @ApplicationID AND UN.UserID = H.ActorUserID
		LEFT JOIN [dbo].[Users_Normal] AS DN
		ON DN.ApplicationID = @ApplicationID AND DN.UserID = H.DeputyUserID
	WHERE H.ApplicationID = @ApplicationID AND H.KnowledgeID = @KnowledgeID AND
		(@UserID IS NULL OR H.ActorUserID = @UserID) AND
		(@Action IS NULL OR H.[Action] = @Action) AND
		(@WFVersionID IS NULL OR H.WFVersionID = @WFVersionID)
	ORDER BY H.ID DESC
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[KW_GetHistoryByID]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[KW_GetHistoryByID]
GO

CREATE PROCEDURE [dbo].[KW_GetHistoryByID]
	@ApplicationID	uniqueidentifier,
    @ID				bigint
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT	H.ID,
			H.KnowledgeID,
			H.[Action],
			H.TextOptions,
			H.[Description],
			H.ActorUserID,
			UN.UserName AS ActorUserName,
			UN.FirstName AS ActorFirstName,
			UN.LastName AS ActorLastName,
			H.DeputyUserID,
			DN.UserName AS DeputyUserName,
			DN.FirstName AS DeputyFirstName,
			DN.LastName AS DeputyLastName,
			H.ActionDate,
			H.ReplyToHistoryID,
			H.WFVersionID,
			CAST((CASE WHEN ND.CreatorUserID = H.ActorUserID THEN 1 ELSE 0 END) AS bit) AS IsCreator,
			CAST((
				SELECT TOP(1) 1
				FROM [dbo].[CN_NodeCreators] AS NC
				WHERE NC.ApplicationID = @ApplicationID AND NC.NodeID = H.KnowledgeID AND 
					NC.UserID = H.[ActorUserID] AND NC.Deleted = 0
			) AS bit) AS IsContributor
	FROM [dbo].[KW_History] AS H
		INNER JOIN [dbo].[CN_Nodes] AS ND
		ON ND.ApplicationID = @ApplicationID AND ND.NodeID = H.KnowledgeID
		LEFT JOIN [dbo].[Users_Normal] AS UN
		ON UN.ApplicationID = @ApplicationID AND UN.UserID = H.ActorUserID
		LEFT JOIN [dbo].[Users_Normal] AS DN
		ON DN.ApplicationID = @ApplicationID AND DN.UserID = H.DeputyUserID
	WHERE H.ApplicationID = @ApplicationID AND H.ID = @ID
END

GO


/* Knowledge Feedbacks */

IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[KW_AddFeedBack]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[KW_AddFeedBack]
GO

CREATE PROCEDURE [dbo].[KW_AddFeedBack]
	@ApplicationID	uniqueidentifier,
	@KnowledgeID	uniqueidentifier,
	@UserID			uniqueidentifier,
	@FeedBackTypeID	int,
	@SendDate		datetime,
	@Value			float,
	@Description	nvarchar(2000)
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SET @Description = [dbo].[GFN_VerifyString](@Description)
	
	IF @Value IS NULL SET @Value = 0

	INSERT INTO [dbo].[KW_FeedBacks](
		ApplicationID,
		KnowledgeID,
		UserID,
		FeedBackTypeID,
		SendDate,
		Value,
		[Description],
		Deleted
	)
	VALUES(
		@ApplicationID,
		@KnowledgeID,
		@UserID,
		@FeedBackTypeID,
		@SendDate,
		@Value,
		@Description,
		0
	)
	
	SELECT @@IDENTITY
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[KW_ModifyFeedBack]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[KW_ModifyFeedBack]
GO

CREATE PROCEDURE [dbo].[KW_ModifyFeedBack]
	@ApplicationID	uniqueidentifier,
	@FeedBackID		bigint,
	@Value			float,
	@Description	nvarchar(2000)
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SET @Description = [dbo].[GFN_VerifyString](@Description)
	
	UPDATE [dbo].[KW_FeedBacks]
		SET Value = @Value,
			[Description] = @Description
	WHERE ApplicationID = @ApplicationID AND FeedBackID = @FeedBackID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[KW_ArithmeticDeleteFeedBack]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[KW_ArithmeticDeleteFeedBack]
GO

CREATE PROCEDURE [dbo].[KW_ArithmeticDeleteFeedBack]
	@ApplicationID	uniqueidentifier,
	@FeedBackID		bigint
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON

	UPDATE [dbo].[KW_FeedBacks]
		SET Deleted = 1
	WHERE ApplicationID = @ApplicationID AND FeedBackID = @FeedBackID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[KW_P_GetFeedBacksByIDs]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[KW_P_GetFeedBacksByIDs]
GO

CREATE PROCEDURE [dbo].[KW_P_GetFeedBacksByIDs]
	@ApplicationID		uniqueidentifier,
	@FeedBackIDsTemp	BigIntTableType readonly
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @FeedBackIDs BigIntTableType
	INSERT INTO @FeedBackIDs SELECT * FROM @FeedBackIDsTemp
	
	SELECT FB.FeedBackID,
		   FB.KnowledgeID,
		   FB.FeedBackTypeID,
		   FB.SendDate,
		   FB.Value,
		   FB.[Description],
		   USR.UserID,
		   USR.UserName,
		   USR.FirstName,
		   USR.LastName
	FROM @FeedBackIDs AS ExternalIDs  
		INNER JOIN [dbo].[KW_FeedBacks] AS FB
		ON FB.ApplicationID = @ApplicationID AND FB.FeedBackID = ExternalIDs.Value
		INNER JOIN [dbo].[Users_Normal] AS USR
		ON USR.ApplicationID = @ApplicationID AND USR.UserID = FB.UserID
	ORDER BY FB.SendDate DESC
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[KW_GetFeedBacksByIDs]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[KW_GetFeedBacksByIDs]
GO

CREATE PROCEDURE [dbo].[KW_GetFeedBacksByIDs]
	@ApplicationID		uniqueidentifier,
	@strFeedBackIDs		varchar(max),
	@delimiter			char
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @FeedBackIDs BigIntTableType
	
	INSERT INTO @FeedBackIDs
	SELECT DISTINCT Ref.Value FROM GFN_StrToBigIntTable(@strFeedBackIDs, @delimiter) AS Ref

	EXEC [dbo].[KW_P_GetFeedBacksByIDs] @ApplicationID, @FeedBackIDs
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[KW_GetKnowledgeFeedBacks]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[KW_GetKnowledgeFeedBacks]
GO

CREATE PROCEDURE [dbo].[KW_GetKnowledgeFeedBacks]
	@ApplicationID				uniqueidentifier,
	@KnowledgeID				uniqueidentifier,
	@UserID						uniqueidentifier,
	@FeedBackTypeID				int,
	@SendDateLowerThreshold		datetime,
	@SendDateUpperThreshold		datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @FeedBackIDs BigIntTableType
	
	INSERT INTO @FeedBackIDs
	SELECT FB.FeedBackID
	FROM [dbo].[KW_FeedBacks] AS FB
		INNER JOIN [dbo].[Users_Normal] AS USR
		ON USR.ApplicationID = @ApplicationID AND USR.UserID = FB.UserID
	WHERE FB.ApplicationID = @ApplicationID AND FB.KnowledgeID = @KnowledgeID AND 
		(@UserID IS NULL OR FB.UserID = @UserID) AND FB.Deleted = 0 AND
		(@FeedBackTypeID IS NULL OR FB.FeedBackTypeID = @FeedBackTypeID) AND
		(@SendDateLowerThreshold IS NULL OR FB.SendDate >= @SendDateLowerThreshold) AND
		(@SendDateUpperThreshold IS NULL OR FB.SendDate <= @SendDateUpperThreshold)

	EXEC [dbo].[KW_P_GetFeedBacksByIDs] @ApplicationID, @FeedBackIDs
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[KW_GetFeedBackStatus]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[KW_GetFeedBackStatus]
GO

CREATE PROCEDURE [dbo].[KW_GetFeedBackStatus]
	@ApplicationID	uniqueidentifier,
	@KnowledgeID	uniqueidentifier,
	@UserID			uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT TOP(1)
		SUM(CASE WHEN FB.FeedBackTypeID = 1 THEN FB.Value ELSE 0 END) AS TotalFinancialFeedBacks,
		SUM(CASE WHEN FB.FeedBackTypeID = 2 THEN FB.Value ELSE 0 END) AS TotalTemporalFeedBacks,
		SUM(CASE WHEN FB.UserID = @UserID AND FB.FeedBackTypeID = 1 THEN FB.Value ELSE 0 END) AS FinancialFeedBackStatus,
		SUM(CASE WHEN FB.UserID = @UserID AND FB.FeedBackTypeID = 2 THEN FB.Value ELSE 0 END) AS TemporalFeedBackStatus
	FROM [dbo].[KW_FeedBacks] AS FB
	WHERE FB.ApplicationID = @ApplicationID AND 
		FB.KnowledgeID = @KnowledgeID AND FB.Deleted = 0
END

GO

/* end of Knowledge Feedbacks */


/* Necessary Items */

IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[KW_GetNecessaryItems]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[KW_GetNecessaryItems]
GO

CREATE PROCEDURE [dbo].[KW_GetNecessaryItems]
	@ApplicationID			uniqueidentifier,
	@NodeTypeIDOrNodeID		uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SET @NodeTypeIDOrNodeID = ISNULL((
		SELECT TOP(1) NodeTypeID
		FROM [dbo].[CN_Nodes]
		WHERE ApplicationID = @ApplicationID AND NodeID = @NodeTypeIDOrNodeID
	), @NodeTypeIDOrNodeID)
	
	SELECT NI.ItemName
	FROM [dbo].[KW_NecessaryItems] AS NI
	WHERE NI.ApplicationID = @ApplicationID AND 
		NI.NodeTypeID = @NodeTypeIDOrNodeID AND NI.Deleted = 0
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[KW_ActivateNecessaryItem]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[KW_ActivateNecessaryItem]
GO

CREATE PROCEDURE [dbo].[KW_ActivateNecessaryItem]
	@ApplicationID	uniqueidentifier,
	@NodeTypeID		uniqueidentifier,
	@ItemName		varchar(50),
	@CurrentUserID	uniqueidentifier,
	@Now			datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	IF EXISTS(
		SELECT TOP(1) *
		FROM [dbo].[KW_NecessaryItems]
		WHERE ApplicationID = @ApplicationID AND 
			NodeTypeID = @NodeTypeID AND ItemName = @ItemName
	) BEGIN
		UPDATE [dbo].[KW_NecessaryItems]
			SET LastModifierUserID = @CurrentUserID,
				LastModificationDate = @Now,
				Deleted = 0
		WHERE ApplicationID = @ApplicationID AND 
			NodeTypeID = @NodeTypeID AND ItemName = @ItemName
	END
	ELSE BEGIN
		INSERT INTO [dbo].[KW_NecessaryItems] (
			ApplicationID,
			NodeTypeID,
			ItemName,
			CreatorUserID,
			CreationDate,
			Deleted
		)
		VALUES (
			@ApplicationID,
			@NodeTypeID,
			@ItemName,
			@CurrentUserID,
			@Now,
			0
		)
	END
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[KW_DeactiveNecessaryItem]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[KW_DeactiveNecessaryItem]
GO

CREATE PROCEDURE [dbo].[KW_DeactiveNecessaryItem]
	@ApplicationID	uniqueidentifier,
	@NodeTypeID		uniqueidentifier,
	@ItemName		varchar(50),
	@CurrentUserID	uniqueidentifier,
	@Now			datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[KW_NecessaryItems]
		SET LastModifierUserID = @CurrentUserID,
			LastModificationDate = @Now,
			Deleted = 1
	WHERE ApplicationID = @ApplicationID AND 
		NodeTypeID = @NodeTypeID AND ItemName = @ItemName
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[KW_CheckNecessaryItems]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[KW_CheckNecessaryItems]
GO

CREATE PROCEDURE [dbo].[KW_CheckNecessaryItems]
	@ApplicationID	uniqueidentifier,
	@NodeID			uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	-- meta data for NecessaryFieldsOfForm
	DECLARE @NodeTypeID uniqueidentifier = (
		SELECT TOP(1) NodeTypeID
		FROM [dbo].[CN_Nodes]
		WHERE ApplicationID = @ApplicationID AND NodeID = @NodeID
	)
	
	DECLARE @ElementLimits TABLE (ElementID uniqueidentifier, Necessary bit)

	INSERT INTO @ElementLimits (ElementID, Necessary)
	SELECT EL.ElementID, ISNULL(EL.Necessary, 0)
	FROM [dbo].[FG_ElementLimits] AS EL
	WHERE EL.ApplicationID = @ApplicationID AND 
		EL.OwnerID = @NodeTypeID AND EL.Deleted = 0
		
	DECLARE @HasFormLimit bit =
		CASE WHEN (SELECT COUNT(*) FROM @ElementLimits) > 0 THEN 1 ELSE 0 END
		
	DELETE @ElementLimits
	WHERE Necessary = 0
	-- end of meta data for NecessaryFieldsOfForm
	
	DECLARE @Items StringTableType
	
	;WITH X AS (
		SELECT TOP(1) *
		FROM [dbo].[CN_Nodes]
		WHERE ApplicationID = @ApplicationID AND NodeID = @NodeID
	)
	INSERT INTO @Items (Value)
	SELECT X.ItemName
	FROM (
			SELECT TOP(1) N'Abstract' AS ItemName
			FROM X
			WHERE ISNULL(X.[Description], N'') <> N''
			
			UNION
			
			SELECT TOP(1) N'Keywords'
			FROM X
			WHERE ISNULL(X.Tags, N'') <> N''
			
			UNION
			
			SELECT TOP(1) N'Wiki'
			FROM X
				INNER JOIN [dbo].[WK_Titles] AS T
				ON T.ApplicationID = @ApplicationID AND T.OwnerID = X.NodeID AND T.Deleted = 0
				INNER JOIN [dbo].[WK_Paragraphs] AS P
				ON P.ApplicationID = @ApplicationID AND P.TitleID = T.TitleID AND P.Deleted = 0 AND
					(P.[Status] = N'Accepted' OR P.[Status] = N'CitationNeeded')
					
			UNION
			
			SELECT TOP(1) N'RelatedNodes'
			FROM X
				LEFT JOIN [dbo].[CN_View_OutRelatedNodes] AS NR
				ON NR.ApplicationID = @ApplicationID AND 
					NR.NodeID = X.NodeID AND NR.RelatedNodeID <> X.NodeID
				LEFT JOIN [dbo].[CN_View_InRelatedNodes] AS NRIN
				ON NRIN.ApplicationID = @ApplicationID AND
					NRIN.NodeID = X.NodeID AND NRIN.RelatedNodeID <> X.NodeID
			WHERE NR.NodeID IS NOT NULL OR NRIN.NodeID IS NOT NULL
				
			UNION
			
			SELECT TOP(1) N'Attachments'
			FROM X
				INNER JOIN [dbo].[DCT_Files] AS ATT
				ON ATT.ApplicationID = @ApplicationID AND ATT.OwnerID = X.NodeID AND ATT.Deleted = 0
			
			UNION

			SELECT TOP(1) N'DocumentTree'
			FROM X
			WHERE X.DocumentTreeNodeID IS NOT NULL
			
			UNION
			
			SELECT TOP(1) N'NecessaryFieldsOfForm'
			WHERE NOT EXISTS (
					SELECT TOP(1) 1
					FROM X INNER JOIN 
						[dbo].[FG_FormOwners] AS O
						ON O.ApplicationID = @ApplicationID AND 
							O.OwnerID = X.NodeTypeID AND O.Deleted = 0
						INNER JOIN [dbo].[FG_FormInstances] AS I
						ON I.ApplicationID = @ApplicationID AND 
							I.FormID = O.FormID AND I.OwnerID = @NodeID AND 
							I.Deleted = 0
						INNER JOIN [dbo].[FG_ExtendedFormElements] AS FE
						ON FE.ApplicationID = @ApplicationID AND 
							FE.FormID = O.FormID AND FE.Deleted = 0 AND
							(@HasFormLimit = 1 OR FE.Necessary = 1)
						LEFT JOIN [dbo].[FG_InstanceElements] AS E
						ON E.ApplicationID = @ApplicationID AND 
							E.InstanceID = I.InstanceID AND 
							E.RefElementID = FE.ElementID AND E.Deleted = 0
					WHERE (
							ISNULL(@HasFormLimit, 0) = 0 OR 
							FE.ElementID IN (SELECT ElementID FROM @ElementLimits)
						) AND
						ISNULL([dbo].[FG_FN_ToString](
							@ApplicationID,
							E.ElementID,
							E.[Type],
							E.TextValue, 
							E.FloatValue,
							E.BitValue, 
							E.DateValue
						), N'') = N''
				)
		) AS X
		
	SELECT I.Value AS ItemName
	FROM @Items AS I
END

GO

/* end of Necessary Items */

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[QA_AddNewWorkFlow]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[QA_AddNewWorkFlow]
GO

CREATE PROCEDURE [dbo].[QA_AddNewWorkFlow]
	@ApplicationID	uniqueidentifier,
    @WorkFlowID 	uniqueidentifier,
    @Name			nvarchar(200),
    @CurrentUserID	uniqueidentifier,
    @Now			datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON

	SET @Name = [dbo].[GFN_VerifyString](@Name)
	
	DECLARE @SeqNo int = ISNULL((
		SELECT MAX(SequenceNumber) 
		FROM [dbo].[QA_WorkFlows]
		WHERE ApplicationID = @ApplicationID
	), 0) + 1

    INSERT INTO [dbo].[QA_WorkFlows] (
		[ApplicationID],
		[WorkFlowID],
        [Name],
        [SequenceNumber],
        [InitialCheckNeeded],
        [FinalConfirmationNeeded],
        [RemovableAfterConfirmation],
        [DisableComments],
        [DisableQuestionLikes],
        [DisableAnswerLikes],
        [DisableCommentLikes],
        [DisableBestAnswer],
        [CreatorUserID],
        [CreationDate],
        [Deleted]
    )
    VALUES (
		@ApplicationID,
		@WorkFlowID,
        @Name,
        @SeqNo,
        0,
        0,
        1,
        0,
        0,
        0,
        0,
        0,
        @CurrentUserID,
        @Now,
        0
    )
    
    SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[QA_RenameWorkFlow]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[QA_RenameWorkFlow]
GO

CREATE PROCEDURE [dbo].[QA_RenameWorkFlow]
	@ApplicationID	uniqueidentifier,
	@WorkFlowID		uniqueidentifier,
	@Name			nvarchar(200),
    @CurrentUserID	uniqueidentifier,
    @Now			datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SET @Name = [dbo].[GFN_VerifyString](@Name)
	
	UPDATE [dbo].[QA_WorkFlows]
	SET Name = @Name,
		LastModifierUserID = @CurrentUserID,
		LastModificationDate = @Now
	WHERE ApplicationID = @ApplicationID AND WorkFlowID = @WorkFlowID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[QA_SetWorkFlowDescription]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[QA_SetWorkFlowDescription]
GO

CREATE PROCEDURE [dbo].[QA_SetWorkFlowDescription]
	@ApplicationID	uniqueidentifier,
	@WorkFlowID		uniqueidentifier,
	@Description	nvarchar(2000),
    @CurrentUserID	uniqueidentifier,
    @Now			datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SET @Description = [dbo].[GFN_VerifyString](@Description)
	
	UPDATE [dbo].[QA_WorkFlows]
	SET [Description] = @Description,
		LastModifierUserID = @CurrentUserID,
		LastModificationDate = @Now
	WHERE ApplicationID = @ApplicationID AND WorkFlowID = @WorkFlowID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[QA_SetWorkFlowsOrder]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[QA_SetWorkFlowsOrder]
GO

CREATE PROCEDURE [dbo].[QA_SetWorkFlowsOrder]
	@ApplicationID	uniqueidentifier,
	@strWorkFlowIDs	varchar(max),
	@delimiter		char
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @WorkFlowIDs TABLE (
		SequenceNo int identity(1, 1) primary key, 
		WorkFlowID uniqueidentifier
	)
	
	INSERT INTO @WorkFlowIDs (WorkFlowID)
	SELECT Ref.Value
	FROM [dbo].[GFN_StrToGuidTable](@strWorkFlowIDs, @delimiter) AS Ref
	
	INSERT INTO @WorkFlowIDs (WorkFlowID)
	SELECT W.WorkFlowID
	FROM @WorkFlowIDs AS Ref
		RIGHT JOIN [dbo].[QA_WorkFlows] AS W
		ON W.ApplicationID = @ApplicationID AND W.WorkFlowID = Ref.WorkFlowID
	WHERE W.ApplicationID = @ApplicationID AND Ref.WorkFlowID IS NULL
	ORDER BY W.SequenceNumber
	
	UPDATE [dbo].[QA_WorkFlows]
		SET SequenceNumber = Ref.SequenceNo
	FROM @WorkFlowIDs AS Ref
		INNER JOIN [dbo].[QA_WorkFlows] AS W
		ON W.WorkFlowID = Ref.WorkFlowID
	WHERE W.ApplicationID = @ApplicationID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[QA_SetWorkFlowInitialCheckNeeded]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[QA_SetWorkFlowInitialCheckNeeded]
GO

CREATE PROCEDURE [dbo].[QA_SetWorkFlowInitialCheckNeeded]
	@ApplicationID	uniqueidentifier,
	@WorkFlowID		uniqueidentifier,
	@Value			bit,
    @CurrentUserID	uniqueidentifier,
    @Now			datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[QA_WorkFlows]
		SET InitialCheckNeeded = ISNULL(@Value, 0)
	WHERE ApplicationID = @ApplicationID AND WorkFlowID = @WorkFlowID
		
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[QA_SetWorkFlowFinalConfirmationNeeded]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[QA_SetWorkFlowFinalConfirmationNeeded]
GO

CREATE PROCEDURE [dbo].[QA_SetWorkFlowFinalConfirmationNeeded]
	@ApplicationID	uniqueidentifier,
	@WorkFlowID		uniqueidentifier,
	@Value			bit,
    @CurrentUserID	uniqueidentifier,
    @Now			datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[QA_WorkFlows]
		SET FinalConfirmationNeeded = ISNULL(@Value, 0)
	WHERE ApplicationID = @ApplicationID AND WorkFlowID = @WorkFlowID
		
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[QA_SetWorkFlowActionDeadline]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[QA_SetWorkFlowActionDeadline]
GO

CREATE PROCEDURE [dbo].[QA_SetWorkFlowActionDeadline]
	@ApplicationID	uniqueidentifier,
	@WorkFlowID		uniqueidentifier,
	@Value			int,
    @CurrentUserID	uniqueidentifier,
    @Now			datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[QA_WorkFlows]
		SET ActionDeadline = CASE WHEN ISNULL(@Value, 0) <= 0 THEN 0 ELSE @Value END
	WHERE ApplicationID = @ApplicationID AND WorkFlowID = @WorkFlowID
		
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[QA_SetWorkFlowAnswerBy]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[QA_SetWorkFlowAnswerBy]
GO

CREATE PROCEDURE [dbo].[QA_SetWorkFlowAnswerBy]
	@ApplicationID	uniqueidentifier,
	@WorkFlowID		uniqueidentifier,
	@Value			varchar(50),
    @CurrentUserID	uniqueidentifier,
    @Now			datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[QA_WorkFlows]
		SET AnswerBy = @Value
	WHERE ApplicationID = @ApplicationID AND WorkFlowID = @WorkFlowID
		
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[QA_SetWorkFlowPublishAfter]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[QA_SetWorkFlowPublishAfter]
GO

CREATE PROCEDURE [dbo].[QA_SetWorkFlowPublishAfter]
	@ApplicationID	uniqueidentifier,
	@WorkFlowID		uniqueidentifier,
	@Value			varchar(50),
    @CurrentUserID	uniqueidentifier,
    @Now			datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[QA_WorkFlows]
		SET PublishAfter = @Value
	WHERE ApplicationID = @ApplicationID AND WorkFlowID = @WorkFlowID
		
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[QA_SetWorkFlowRemovableAfterConfirmation]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[QA_SetWorkFlowRemovableAfterConfirmation]
GO

CREATE PROCEDURE [dbo].[QA_SetWorkFlowRemovableAfterConfirmation]
	@ApplicationID	uniqueidentifier,
	@WorkFlowID		uniqueidentifier,
	@Value			bit,
    @CurrentUserID	uniqueidentifier,
    @Now			datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[QA_WorkFlows]
		SET RemovableAfterConfirmation = ISNULL(@Value, 0)
	WHERE ApplicationID = @ApplicationID AND WorkFlowID = @WorkFlowID
		
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[QA_SetWorkFlowNodeSelectType]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[QA_SetWorkFlowNodeSelectType]
GO

CREATE PROCEDURE [dbo].[QA_SetWorkFlowNodeSelectType]
	@ApplicationID	uniqueidentifier,
	@WorkFlowID		uniqueidentifier,
	@Value			varchar(50),
    @CurrentUserID	uniqueidentifier,
    @Now			datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[QA_WorkFlows]
		SET NodeSelectType = @Value
	WHERE ApplicationID = @ApplicationID AND WorkFlowID = @WorkFlowID
		
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[QA_SetWorkFlowDisableComments]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[QA_SetWorkFlowDisableComments]
GO

CREATE PROCEDURE [dbo].[QA_SetWorkFlowDisableComments]
	@ApplicationID	uniqueidentifier,
	@WorkFlowID		uniqueidentifier,
	@Value			bit,
    @CurrentUserID	uniqueidentifier,
    @Now			datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[QA_WorkFlows]
		SET DisableComments = ISNULL(@Value, 0)
	WHERE ApplicationID = @ApplicationID AND WorkFlowID = @WorkFlowID
		
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[QA_SetWorkFlowDisableQuestionLikes]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[QA_SetWorkFlowDisableQuestionLikes]
GO

CREATE PROCEDURE [dbo].[QA_SetWorkFlowDisableQuestionLikes]
	@ApplicationID	uniqueidentifier,
	@WorkFlowID		uniqueidentifier,
	@Value			bit,
    @CurrentUserID	uniqueidentifier,
    @Now			datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[QA_WorkFlows]
		SET DisableQuestionLikes = ISNULL(@Value, 0)
	WHERE ApplicationID = @ApplicationID AND WorkFlowID = @WorkFlowID
		
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[QA_SetWorkFlowDisableAnswerLikes]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[QA_SetWorkFlowDisableAnswerLikes]
GO

CREATE PROCEDURE [dbo].[QA_SetWorkFlowDisableAnswerLikes]
	@ApplicationID	uniqueidentifier,
	@WorkFlowID		uniqueidentifier,
	@Value			bit,
    @CurrentUserID	uniqueidentifier,
    @Now			datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[QA_WorkFlows]
		SET DisableAnswerLikes = ISNULL(@Value, 0)
	WHERE ApplicationID = @ApplicationID AND WorkFlowID = @WorkFlowID
		
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[QA_SetWorkFlowDisableCommentLikes]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[QA_SetWorkFlowDisableCommentLikes]
GO

CREATE PROCEDURE [dbo].[QA_SetWorkFlowDisableCommentLikes]
	@ApplicationID	uniqueidentifier,
	@WorkFlowID		uniqueidentifier,
	@Value			bit,
    @CurrentUserID	uniqueidentifier,
    @Now			datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[QA_WorkFlows]
		SET DisableCommentLikes = ISNULL(@Value, 0)
	WHERE ApplicationID = @ApplicationID AND WorkFlowID = @WorkFlowID
		
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[QA_SetWorkFlowDisableBestAnswer]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[QA_SetWorkFlowDisableBestAnswer]
GO

CREATE PROCEDURE [dbo].[QA_SetWorkFlowDisableBestAnswer]
	@ApplicationID	uniqueidentifier,
	@WorkFlowID		uniqueidentifier,
	@Value			bit,
    @CurrentUserID	uniqueidentifier,
    @Now			datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[QA_WorkFlows]
		SET DisableBestAnswer = ISNULL(@Value, 0)
	WHERE ApplicationID = @ApplicationID AND WorkFlowID = @WorkFlowID
		
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[QA_RemoveWorkFlow]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[QA_RemoveWorkFlow]
GO

CREATE PROCEDURE [dbo].[QA_RemoveWorkFlow]
	@ApplicationID	uniqueidentifier,
	@WorkFlowID		uniqueidentifier,
	@CurrentUserID	uniqueidentifier,
	@Now			datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[QA_WorkFlows]
		SET Deleted = 1,
			LastModifierUserID = @CurrentUserID,
			LastModificationDate = @Now
	WHERE ApplicationID = @ApplicationID AND WorkFlowID = @WorkFlowID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[QA_RecycleWorkFlow]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[QA_RecycleWorkFlow]
GO

CREATE PROCEDURE [dbo].[QA_RecycleWorkFlow]
	@ApplicationID	uniqueidentifier,
	@WorkFlowID		uniqueidentifier,
	@CurrentUserID	uniqueidentifier,
	@Now			datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[QA_WorkFlows]
		SET Deleted = 0,
			LastModifierUserID = @CurrentUserID,
			LastModificationDate = @Now
	WHERE ApplicationID = @ApplicationID AND WorkFlowID = @WorkFlowID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[QA_P_GetWorkFlowsByIDs]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[QA_P_GetWorkFlowsByIDs]
GO

CREATE PROCEDURE [dbo].[QA_P_GetWorkFlowsByIDs]
	@ApplicationID		uniqueidentifier,
	@WorkFlowIDsTemp	KeyLessGuidTableType readonly
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @WorkFlowIDs KeyLessGuidTableType
	INSERT INTO @WorkFlowIDs (Value) SELECT Value FROM @WorkFlowIDsTemp
	
	SELECT	W.WorkFlowID,
			W.Name,
			W.[Description],
			W.InitialCheckNeeded,
			W.FinalConfirmationNeeded,
			W.ActionDeadline,
			W.AnswerBy,
			W.PublishAfter,
			W.RemovableAfterConfirmation,
			W.NodeSelectType,
			W.DisableComments,
			W.DisableQuestionLikes,
			W.DisableAnswerLikes,
			W.DisableCommentLikes,
			W.DisableBestAnswer
	FROM @WorkFlowIDs AS I
		INNER JOIN [dbo].[QA_WorkFlows] AS W
		ON W.ApplicationID = @ApplicationID AND W.WorkFlowID = I.Value
	ORDER BY I.SequenceNumber ASC
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[QA_GetWorkFlows]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[QA_GetWorkFlows]
GO

CREATE PROCEDURE [dbo].[QA_GetWorkFlows]
	@ApplicationID	uniqueidentifier,
	@Archive		bit
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @WorkFlowIDs KeyLessGuidTableType
	
	INSERT INTO @WorkFlowIDs (Value)
	SELECT	W.WorkFlowID
	FROM [dbo].[QA_WorkFlows] AS W
	WHERE W.ApplicationID = @ApplicationID AND W.Deleted = ISNULL(@Archive, 0)
	ORDER BY ISNULL(W.SequenceNumber, 1000000) ASC, W.CreationDate ASC
	
	EXEC [dbo].[QA_P_GetWorkFlowsByIDs] @ApplicationID, @WorkFlowIDs
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[QA_GetWorkFlow]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[QA_GetWorkFlow]
GO

CREATE PROCEDURE [dbo].[QA_GetWorkFlow]
	@ApplicationID						uniqueidentifier,
	@WorkFlowIDOrQuestionIDOrAnswerID	uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @WorkFlowIDs KeyLessGuidTableType
	
	SELECT TOP(1) @WorkFlowIDOrQuestionIDOrAnswerID = ISNULL(Q.WorkFlowID, @WorkFlowIDOrQuestionIDOrAnswerID)
	FROM [dbo].[QA_Answers] AS A
		INNER JOIN [dbo].[QA_Questions] AS Q
		ON Q.ApplicationID = @ApplicationID AND Q.QuestionID = A.QuestionID
	WHERE A.ApplicationID = @ApplicationID AND A.AnswerID = @WorkFlowIDOrQuestionIDOrAnswerID
	
	SELECT TOP(1) @WorkFlowIDOrQuestionIDOrAnswerID = ISNULL(Q.WorkFlowID, @WorkFlowIDOrQuestionIDOrAnswerID)
	FROM [dbo].[QA_Questions] AS Q
	WHERE Q.ApplicationID = @ApplicationID AND Q.QuestionID = @WorkFlowIDOrQuestionIDOrAnswerID
	
	INSERT INTO @WorkFlowIDs (Value)
	VALUES (@WorkFlowIDOrQuestionIDOrAnswerID)
	
	EXEC [dbo].[QA_P_GetWorkFlowsByIDs] @ApplicationID, @WorkFlowIDs
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[QA_IsWorkFlow]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[QA_IsWorkFlow]
GO

CREATE PROCEDURE [dbo].[QA_IsWorkFlow]
	@ApplicationID	uniqueidentifier,
    @strIDs			varchar(max),
    @delimter		char
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT W.WorkFlowID AS ID
	FROM [dbo].[GFN_StrToGuidTable](@strIDs, @delimter) AS Ref
		INNER JOIN [dbo].[QA_WorkFlows] AS W
		ON W.ApplicationID = @ApplicationID AND W.WorkFlowID = Ref.Value
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[QA_AddWorkFlowAdmin]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[QA_AddWorkFlowAdmin]
GO

CREATE PROCEDURE [dbo].[QA_AddWorkFlowAdmin]
	@ApplicationID	uniqueidentifier,
	@UserID			uniqueidentifier,
    @WorkFlowID 	uniqueidentifier,
    @CurrentUserID	uniqueidentifier,
    @Now			datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[QA_Admins]
	SET LastModifierUserID = @CurrentUserID,
		LastModificationDate = @Now,
		Deleted = 0
	WHERE ApplicationID = @ApplicationID AND UserID = @UserID AND
		((WorkFlowID IS NULL AND @WorkFlowID IS NULL) OR (WorkFlowID = @WorkFlowID))
	
    IF @@ROWCOUNT = 0 BEGIN
		INSERT INTO [dbo].[QA_Admins] (
			ApplicationID,
			UserID,
			WorkFlowID,
			CreatorUserID,
			CreationDate,
			Deleted
		)
		VALUES (
			@ApplicationID,
			@UserID,
			@WorkFlowID,
			@CurrentUserID,
			@Now,
			0
		)
		
		SELECT @@ROWCOUNT
    END
    ELSE SELECT 1
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[QA_RemoveWorkFlowAdmin]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[QA_RemoveWorkFlowAdmin]
GO

CREATE PROCEDURE [dbo].[QA_RemoveWorkFlowAdmin]
	@ApplicationID	uniqueidentifier,
	@UserID			uniqueidentifier,
    @WorkFlowID 	uniqueidentifier,
    @CurrentUserID	uniqueidentifier,
    @Now			datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[QA_Admins]
	SET Deleted = 1,
		LastModifierUserID = @CurrentUserID,
		LastModificationDate = @Now
	WHERE ApplicationID = @ApplicationID AND UserID = @UserID AND
		((WorkFlowID IS NULL AND @WorkFlowID IS NULL) OR (WorkFlowID = @WorkFlowID))
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[QA_IsWorkFlowAdmin]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[QA_IsWorkFlowAdmin]
GO

CREATE PROCEDURE [dbo].[QA_IsWorkFlowAdmin]
	@ApplicationID						uniqueidentifier,
	@UserID								uniqueidentifier,
    @WorkFlowIDOrQuestionIDOrAnswerID	uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	IF @WorkFlowIDOrQuestionIDOrAnswerID IS NOT NULL BEGIN
		SELECT @WorkFlowIDOrQuestionIDOrAnswerID = ISNULL(Q.WorkFlowID, @WorkFlowIDOrQuestionIDOrAnswerID)
		FROM [dbo].[QA_Answers] AS A
			INNER JOIN [dbo].[QA_Questions] AS Q
			ON Q.ApplicationID = @ApplicationID AND Q.QuestionID = A.QuestionID
		WHERE A.ApplicationID = @ApplicationID AND A.AnswerID = @WorkFlowIDOrQuestionIDOrAnswerID
		
		SELECT @WorkFlowIDOrQuestionIDOrAnswerID = ISNULL(WorkFlowID, @WorkFlowIDOrQuestionIDOrAnswerID)
		FROM [dbo].[QA_Questions]
		WHERE ApplicationID = @ApplicationID AND QuestionID = @WorkFlowIDOrQuestionIDOrAnswerID
	END
	
	SELECT 
		CASE 
			WHEN EXISTS (
				SELECT TOP(1) UserID
				FROM [dbo].[QA_Admins]
				WHERE ApplicationID = @ApplicationID AND UserID = @UserID AND
					(
						(WorkFlowID IS NULL AND @WorkFlowIDOrQuestionIDOrAnswerID IS NULL) OR 
						(WorkFlowID = @WorkFlowIDOrQuestionIDOrAnswerID)
					) AND Deleted = 0
			) THEN 1
			ELSE 0 
		END
			
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[QA_GetWorkFlowAdminIDs]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[QA_GetWorkFlowAdminIDs]
GO

CREATE PROCEDURE [dbo].[QA_GetWorkFlowAdminIDs]
	@ApplicationID						uniqueidentifier,
    @WorkFlowIDOrQuestionIDOrAnswerID	uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	IF @WorkFlowIDOrQuestionIDOrAnswerID IS NOT NULL BEGIN
		SELECT @WorkFlowIDOrQuestionIDOrAnswerID = ISNULL(Q.WorkFlowID, @WorkFlowIDOrQuestionIDOrAnswerID)
		FROM [dbo].[QA_Answers] AS A
			INNER JOIN [dbo].[QA_Questions] AS Q
			ON Q.ApplicationID = @ApplicationID AND Q.QuestionID = A.QuestionID
		WHERE A.ApplicationID = @ApplicationID AND A.AnswerID = @WorkFlowIDOrQuestionIDOrAnswerID
		
		SELECT @WorkFlowIDOrQuestionIDOrAnswerID = ISNULL(WorkFlowID, @WorkFlowIDOrQuestionIDOrAnswerID)
		FROM [dbo].[QA_Questions]
		WHERE ApplicationID = @ApplicationID AND QuestionID = @WorkFlowIDOrQuestionIDOrAnswerID
	END
	
	SELECT AD.UserID AS ID
	FROM [dbo].[QA_Admins] AS AD
		INNER JOIN [dbo].[Users_Normal] AS UN
		ON UN.ApplicationID = @ApplicationID AND UN.UserID = AD.UserID AND UN.IsApproved = 1
	WHERE AD.ApplicationID = @ApplicationID AND
		(
			(AD.WorkFlowID IS NULL AND @WorkFlowIDOrQuestionIDOrAnswerID IS NULL) OR 
			(AD.WorkFlowID = @WorkFlowIDOrQuestionIDOrAnswerID)
		) AND AD.Deleted = 0
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[QA_SetCandidateRelations]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[QA_SetCandidateRelations]
GO

CREATE PROCEDURE [dbo].[QA_SetCandidateRelations]
	@ApplicationID	uniqueidentifier,
	@WorkFlowID		uniqueidentifier,
	@strNodeTypeIDs	varchar(max),
	@strNodeIDs		varchar(max),
	@delimiter		char,
	@CreatorUserID	uniqueidentifier,
	@CreationDate	datetime
WITH ENCRYPTION
AS
BEGIN TRANSACTION
	SET NOCOUNT ON
	
	DECLARE @IDs Table(NodeTypeID uniqueidentifier, NodeID uniqueidentifier)
	
	INSERT INTO @IDs (NodeTypeID)
	SELECT Ref.Value FROM [dbo].[GFN_StrToGuidTable](@strNodeTypeIDs, @delimiter) AS Ref
	
	INSERT INTO @IDs (NodeID)
	SELECT Ref.Value FROM [dbo].[GFN_StrToGuidTable](@strNodeIDs, @delimiter) AS Ref
	
	DECLARE @ExistingIDs Table(NodeTypeID uniqueidentifier, NodeID uniqueidentifier)
	
	INSERT INTO @ExistingIDs(NodeTypeID, NodeID)
	SELECT CR.NodeTypeID, CR.NodeID
	FROM @IDs AS Ref
		INNER JOIN [dbo].[QA_CandidateRelations] AS CR
		ON CR.NodeTypeID = Ref.NodeTypeID OR CR.NodeID = Ref.NodeID
	WHERE CR.ApplicationID = @ApplicationID AND CR.WorkFlowID = @WorkFlowID
	
	DECLARE @Count int = (SELECT COUNT(*) FROM @IDs)
	DECLARE @ExistingCount int = (SELECT COUNT(*) FROM @ExistingIDs)
	
	IF EXISTS(SELECT * FROM [dbo].[QA_CandidateRelations]
		WHERE WorkFlowID = @WorkFlowID) BEGIN
		
		UPDATE [dbo].[QA_CandidateRelations]
			SET LastModifierUserID = @CreatorUserID,
				LastModificationDate = @CreationDate,
				Deleted = 1
		WHERE ApplicationID = @ApplicationID AND WorkFlowID = @WorkFlowID
		
		IF @@ROWCOUNT <= 0 BEGIN
			SELECT -1
			ROLLBACK TRANSACTION
			RETURN
		END
	END
	
	IF @ExistingCount > 0 BEGIN
		UPDATE CR
			SET LastModifierUserID = @CreatorUserID,
				LastModificationDate = @CreationDate,
				Deleted = 0
		FROM @ExistingIDs AS Ref
			INNER JOIN [dbo].[QA_CandidateRelations] AS CR
			ON CR.NodeTypeID = Ref.NodeTypeID OR CR.NodeID = Ref.NodeID
		WHERE CR.ApplicationID = @ApplicationID AND CR.WorkFlowID = @WorkFlowID
		
		IF @@ROWCOUNT <= 0 BEGIN
			SELECT -1
			ROLLBACK TRANSACTION
			RETURN
		END
	END
	
	IF @Count > @ExistingCount BEGIN
		INSERT INTO [dbo].[QA_CandidateRelations](
			ApplicationID,
			ID,
			WorkFlowID,
			NodeID,
			NodeTypeID,
			CreatorUserID,
			CreationDate,
			Deleted
		)
		SELECT @ApplicationID, NEWID(), @WorkFlowID, Ref.NodeID, Ref.NodeTypeID, 
			@CreatorUserID, @CreationDate, 0
		FROM (
				SELECT I.*
				FROM @IDs AS I
					LEFT JOIN @ExistingIDs AS E
					ON I.NodeID = E.NodeID OR I.NodeTypeID = E.NodeTypeID
				WHERE E.NodeID IS NULL AND E.NodeTypeID IS NULL
			) AS Ref
		
		IF @@ROWCOUNT <= 0 BEGIN
		select 6
			SELECT -1
			ROLLBACK TRANSACTION
			RETURN
		END
	END
	
	SELECT 1
COMMIT TRANSACTION

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[QA_GetCandidateNodeRelationIDs]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[QA_GetCandidateNodeRelationIDs]
GO

CREATE PROCEDURE [dbo].[QA_GetCandidateNodeRelationIDs]
	@ApplicationID						uniqueidentifier,
	@WorkFlowIDOrQuestionIDOrAnswerID	uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	IF @WorkFlowIDOrQuestionIDOrAnswerID IS NOT NULL BEGIN
		SELECT @WorkFlowIDOrQuestionIDOrAnswerID = ISNULL(Q.WorkFlowID, @WorkFlowIDOrQuestionIDOrAnswerID)
		FROM [dbo].[QA_Answers] AS A
			INNER JOIN [dbo].[QA_Questions] AS Q
			ON Q.ApplicationID = @ApplicationID AND Q.QuestionID = A.QuestionID
		WHERE A.ApplicationID = @ApplicationID AND A.AnswerID = @WorkFlowIDOrQuestionIDOrAnswerID
		
		SELECT @WorkFlowIDOrQuestionIDOrAnswerID = ISNULL(WorkFlowID, @WorkFlowIDOrQuestionIDOrAnswerID)
		FROM [dbo].[QA_Questions]
		WHERE ApplicationID = @ApplicationID AND QuestionID = @WorkFlowIDOrQuestionIDOrAnswerID
	END
	
	DECLARE @WorkFlowID uniqueidentifier = @WorkFlowIDOrQuestionIDOrAnswerID
	
	SELECT NodeID AS ID
	FROM [dbo].[QA_CandidateRelations]
	WHERE ApplicationID = @ApplicationID AND 
		WorkFlowID = @WorkFlowID AND NodeID IS NOT NULL AND Deleted = 0
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[QA_GetCandidateNodeTypeRelationIDs]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[QA_GetCandidateNodeTypeRelationIDs]
GO

CREATE PROCEDURE [dbo].[QA_GetCandidateNodeTypeRelationIDs]
	@ApplicationID						uniqueidentifier,
	@WorkFlowIDOrQuestionIDOrAnswerID	uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	IF @WorkFlowIDOrQuestionIDOrAnswerID IS NOT NULL BEGIN
		SELECT @WorkFlowIDOrQuestionIDOrAnswerID = ISNULL(Q.WorkFlowID, @WorkFlowIDOrQuestionIDOrAnswerID)
		FROM [dbo].[QA_Answers] AS A
			INNER JOIN [dbo].[QA_Questions] AS Q
			ON Q.ApplicationID = @ApplicationID AND Q.QuestionID = A.QuestionID
		WHERE A.ApplicationID = @ApplicationID AND A.AnswerID = @WorkFlowIDOrQuestionIDOrAnswerID
		
		SELECT @WorkFlowIDOrQuestionIDOrAnswerID = ISNULL(WorkFlowID, @WorkFlowIDOrQuestionIDOrAnswerID)
		FROM [dbo].[QA_Questions]
		WHERE ApplicationID = @ApplicationID AND QuestionID = @WorkFlowIDOrQuestionIDOrAnswerID
	END
	
	DECLARE @WorkFlowID uniqueidentifier = @WorkFlowIDOrQuestionIDOrAnswerID
	
	SELECT NodeTypeID AS ID
	FROM [dbo].[QA_CandidateRelations]
	WHERE ApplicationID = @ApplicationID AND 
		WorkFlowID = @WorkFlowID AND NodeTypeID IS NOT NULL AND Deleted = 0
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[QA_CreateFAQCategory]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[QA_CreateFAQCategory]
GO

CREATE PROCEDURE [dbo].[QA_CreateFAQCategory]
	@ApplicationID	uniqueidentifier,
	@CategoryID		uniqueidentifier,
	@ParentID		uniqueidentifier,
	@Name			nvarchar(200),
    @CurrentUserID	uniqueidentifier,
    @Now			datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SET @Name = [dbo].[GFN_VerifyString](@Name)
	
	DECLARE @SeqNo int = ISNULL((
		SELECT MAX(SequenceNumber) 
		FROM [dbo].[QA_FAQCategories]
		WHERE ApplicationID = @ApplicationID AND 
			((ParentID IS NULL AND @ParentID IS NULL) OR (ParentID = @ParentID))
	), 0) + 1
	
	INSERT INTO [dbo].[QA_FAQCategories] (
		ApplicationID,
		CategoryID,
		ParentID,
		SequenceNumber,
		Name,
		CreatorUserID,
		CreationDate,
		Deleted
	)
	VALUES (
		@ApplicationID,
		@CategoryID,
		@ParentID,
		@SeqNo,
		@Name,
		@CurrentUserID,
		@Now,
		0
	)
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[QA_RenameFAQCategory]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[QA_RenameFAQCategory]
GO

CREATE PROCEDURE [dbo].[QA_RenameFAQCategory]
	@ApplicationID	uniqueidentifier,
	@CategoryID		uniqueidentifier,
	@Name			nvarchar(200),
    @CurrentUserID	uniqueidentifier,
    @Now			datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SET @Name = [dbo].[GFN_VerifyString](@Name)
	
	UPDATE [dbo].[QA_FAQCategories]
	SET Name = @Name,
		LastModifierUserID = @CurrentUserID,
		LastModificationDate = @Now
	WHERE ApplicationID = @ApplicationID AND CategoryID = @CategoryID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[QA_MoveFAQCategories]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[QA_MoveFAQCategories]
GO

CREATE PROCEDURE [dbo].[QA_MoveFAQCategories]
	@ApplicationID	uniqueidentifier,
    @strCategoryIDs	varchar(max),
	@delimiter		char,
    @NewParentID	uniqueidentifier,
    @CurrentUserID	uniqueidentifier,
    @Now			datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @CategoryIDs GuidTableType
	INSERT INTO @CategoryIDs
	SELECT Ref.Value FROM [dbo].[GFN_StrToGuidTable](@strCategoryIDs, @delimiter) AS Ref
	
	DECLARE @ParentHierarchy NodesHierarchyTableType
	
	IF @NewParentID IS NOT NULL BEGIN
		INSERT INTO @ParentHierarchy
		SELECT *
		FROM [dbo].[QA_FN_GetParentCategoryHierarchy](@ApplicationID, @NewParentID)
	END
	
	IF EXISTS(
		SELECT TOP(1) 1
		FROM @ParentHierarchy AS P
			INNER JOIN @CategoryIDs AS C
			ON C.Value = P.NodeID
	) BEGIN
		SELECT -1, N'CannotTransferToChilds'
		RETURN
	END
	
	UPDATE C
		SET LastModifierUserID = @CurrentUserID,
			LastModificationDate = @Now,
			ParentID = @NewParentID
	FROM @CategoryIDs AS Ref
		INNER JOIN [dbo].[QA_FAQCategories] AS C
		ON C.[CategoryID] = Ref.Value
	WHERE C.ApplicationID = @ApplicationID AND 
		(@NewParentID IS NULL OR C.[CategoryID] <> @NewParentID)
	
    SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[QA_SetFAQCategoriesOrder]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[QA_SetFAQCategoriesOrder]
GO

CREATE PROCEDURE [dbo].[QA_SetFAQCategoriesOrder]
	@ApplicationID	uniqueidentifier,
	@strCategoryIDs	varchar(max),
	@delimiter		char
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @CategoryIDs TABLE (
		SequenceNo int identity(1, 1) primary key, 
		CategoryID uniqueidentifier
	)
	
	INSERT INTO @CategoryIDs (CategoryID)
	SELECT Ref.Value
	FROM [dbo].[GFN_StrToGuidTable](@strCategoryIDs, @delimiter) AS Ref
	
	DECLARE @ParentID uniqueidentifier = NULL
	
	SELECT TOP(1) @ParentID = ParentID
	FROM [dbo].[QA_FAQCategories]
	WHERE ApplicationID = @ApplicationID AND 
		CategoryID = (SELECT TOP (1) Ref.CategoryID FROM @CategoryIDs AS Ref)
	
	INSERT INTO @CategoryIDs (CategoryID)
	SELECT C.CategoryID
	FROM @CategoryIDs AS Ref
		RIGHT JOIN [dbo].[QA_FAQCategories] AS C
		ON C.ApplicationID = @ApplicationID AND C.CategoryID = Ref.CategoryID
	WHERE C.ApplicationID = @ApplicationID AND ((C.ParentID IS NULL AND @ParentID IS NULL) OR C.ParentID = @ParentID) AND 
		Ref.CategoryID IS NULL
	ORDER BY C.SequenceNumber
	
	UPDATE [dbo].[QA_FAQCategories]
		SET SequenceNumber = Ref.SequenceNo
	FROM @CategoryIDs AS Ref
		INNER JOIN [dbo].[QA_FAQCategories] AS C
		ON C.CategoryID = Ref.CategoryID
	WHERE C.ApplicationID = @ApplicationID AND 
		((C.ParentID IS NULL AND @ParentID IS NULL) OR C.ParentID = @ParentID)
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[QA_RemoveFAQCategories]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[QA_RemoveFAQCategories]
GO

CREATE PROCEDURE [dbo].[QA_RemoveFAQCategories]
	@ApplicationID		uniqueidentifier,
    @strCategoryIDs		varchar(max),
    @delimiter			char,
    @RemoveHierarchy	bit,
    @CurrentUserID		uniqueidentifier,
    @Now				datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @CategoryIDs GuidTableType
	
	INSERT INTO @CategoryIDs
	SELECT DISTINCT Ref.Value FROM GFN_StrToGuidTable(@strCategoryIDs, @delimiter) AS Ref
	
	IF ISNULL(@RemoveHierarchy, 0) = 0 BEGIN
		UPDATE C
			SET Deleted = 1,
				LastModifierUserID = @CurrentUserID,
				LastModificationDate = @Now
		FROM @CategoryIDs AS Ref
			INNER JOIN [dbo].[QA_FAQCategories] AS C
			ON C.CategoryID = Ref.Value
		WHERE C.ApplicationID = @ApplicationID AND C.[Deleted] = 0
			
		DECLARE @_Result int = @@ROWCOUNT
			
		UPDATE [dbo].[QA_FAQCategories]
			SET ParentID = NULL
		WHERE ApplicationID = @ApplicationID AND ParentID IN(SELECT * FROM @CategoryIDs)
		
		SELECT @_Result
	END
	ELSE BEGIN
		UPDATE C
			SET Deleted = 1,
				LastModifierUserID = @CurrentUserID,
				LastModificationDate = @Now
		FROM [dbo].[QA_FN_GetChildCategoriesHierarchy](@ApplicationID, @CategoryIDs) AS Ref
			INNER JOIN [dbo].[QA_FAQCategories] AS C
			ON C.CategoryID = Ref.CategoryID
		WHERE C.ApplicationID = @ApplicationID
			
		SELECT @@ROWCOUNT
	END
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[QA_GetChildFAQCategories]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[QA_GetChildFAQCategories]
GO

CREATE PROCEDURE [dbo].[QA_GetChildFAQCategories]
	@ApplicationID		uniqueidentifier,
    @ParentID			uniqueidentifier,
    @CurrentUserID		uniqueidentifier,
    @CheckAccess		bit,
    @DefaultPrivacy		varchar(50),
    @Now				datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @Categories Table (
		CategoryID uniqueidentifier primary key clustered, 
		Name nvarchar(200),
		SequenceNumber int,
		HasChild bit
	)
	
	INSERT INTO @Categories (CategoryID, Name, SequenceNumber, HasChild)
	SELECT	C.CategoryID, 
			C.Name, 
			C.SequenceNumber,
			(
				SELECT CAST(1 AS bit)
				WHERE EXISTS (
						SELECT TOP(1) *
						FROM [dbo].[QA_FAQCategories] AS P
						WHERE P.ApplicationID = @ApplicationID AND 
							P.ParentID = C.CategoryID AND P.Deleted = 0
					)
			) AS HasChild
	FROM [dbo].[QA_FAQCategories] AS C
	WHERE C.ApplicationID = @ApplicationID AND C.Deleted = 0 AND
		((C.ParentID IS NULL AND @ParentID IS NULL) OR (C.ParentID = @ParentID))
		
	IF @CheckAccess = 1 BEGIN
		DECLARE @CIDs KeyLessGuidTableType
		
		INSERT INTO @CIDs (Value)
		SELECT C.CategoryID
		FROM @Categories AS C
			
		DECLARE	@PermissionTypes StringPairTableType
		
		INSERT INTO @PermissionTypes (FirstValue, SecondValue)
		VALUES (N'View', @DefaultPrivacy)
		
		DELETE C
		FROM @Categories AS C
			LEFT JOIN [dbo].[PRVC_FN_CheckAccess](@ApplicationID, @CurrentUserID, 
				@CIDs, N'FAQCategory', @Now, @PermissionTypes) AS A
			ON A.ID = C.CategoryID
		WHERE A.ID IS NULL
	END
	
	SELECT	C.CategoryID,
			C.Name,
			C.HasChild
	FROM @Categories AS C
	ORDER BY C.SequenceNumber ASC, C.CategoryID ASC
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[QA_IsFAQCategory]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[QA_IsFAQCategory]
GO

CREATE PROCEDURE [dbo].[QA_IsFAQCategory]
	@ApplicationID	uniqueidentifier,
    @strIDs			varchar(max),
    @delimiter		char
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT C.CategoryID AS ID
	FROM [dbo].[GFN_StrToGuidTable](@strIDs, @delimiter) AS Ref
		INNER JOIN [dbo].[QA_FAQCategories] AS C
		ON C.ApplicationID = @ApplicationID AND C.CategoryID = Ref.Value
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[QA_AddFAQItems]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[QA_AddFAQItems]
GO

CREATE PROCEDURE [dbo].[QA_AddFAQItems]
	@ApplicationID	uniqueidentifier,
    @CategoryID		uniqueidentifier,
    @strQuestionIDs	varchar(max),
    @delimiter		char,
    @CurrentUserID	uniqueidentifier,
    @Now			datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @QuestionIDs TABLE (Seq int IDENTITY(1, 1), QuestionID uniqueidentifier)
	
	INSERT INTO @QuestionIDs (QuestionID)
	SELECT DISTINCT Ref.Value
	FROM [dbo].[GFN_StrToGuidTable](@strQuestionIDs, @delimiter) AS Ref
		LEFT JOIN [dbo].[QA_FAQItems] AS I
		ON I.ApplicationID = @ApplicationID AND 
			I.CategoryID = @CategoryID AND I.QuestionID = Ref.Value
	WHERE I.QuestionID IS NULL OR I.Deleted = 1
	
	DECLARE @SeqNo int = ISNULL((
		SELECT MAX(SequenceNumber) 
		FROM [dbo].[QA_FAQItems]
		WHERE ApplicationID = @ApplicationID AND CategoryID = @CategoryID
	), 0)
	
	UPDATE I
		SET Deleted = 0,
			SequenceNumber = IDs.Seq + @SeqNo,
			LastModifierUserID = @CurrentUserID,
			LastModificationDate = @Now
	FROM @QuestionIDs AS IDs
		INNER JOIN [dbo].[QA_FAQItems] AS I
		ON I.ApplicationID = @ApplicationID AND 
			I.CategoryID = @CategoryID AND I.QuestionID = IDs.QuestionID
			
	INSERT INTO [dbo].[QA_FAQItems] (
		ApplicationID,
		CategoryID,
		QuestionID,
		SequenceNumber,
		CreatorUserID,
		CreationDate,
		Deleted
	) 
	SELECT	@ApplicationID, 
			@CategoryID, 
			IDs.QuestionID, 
			IDs.Seq + @SeqNo, 
			@CurrentUserID, 
			@Now, 
			0
	FROM @QuestionIDs AS IDs
		LEFT JOIN [dbo].[QA_FAQItems] AS I
		ON I.ApplicationID = @ApplicationID AND 
			I.CategoryID = @CategoryID AND I.QuestionID = IDs.QuestionID
	WHERE I.QuestionID IS NULL
	
	SELECT 1
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[QA_AddQuestionToFAQCategories]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[QA_AddQuestionToFAQCategories]
GO

CREATE PROCEDURE [dbo].[QA_AddQuestionToFAQCategories]
	@ApplicationID	uniqueidentifier,
    @QuestionID		uniqueidentifier,
    @strCategoryIDs	varchar(max),
    @delimiter		char,
    @CurrentUserID	uniqueidentifier,
    @Now			datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @CategoryIDs TABLE (CategoryID uniqueidentifier, Seq int)
	
	;WITH C (CategoryID)
	AS
	(
		SELECT DISTINCT C.Value AS CategoryID
		FROM [dbo].[GFN_StrToGuidTable](@strCategoryIDs, @delimiter) AS C
			LEFT JOIN [dbo].[QA_FAQItems] AS I
			ON I.ApplicationID = @ApplicationID AND 
				I.CategoryID = C.Value AND I.QuestionID = @QuestionID
		WHERE I.CategoryID IS NULL OR I.Deleted = 1
	)
	INSERT INTO @CategoryIDs (CategoryID, Seq)
	SELECT C.CategoryID, ISNULL(MAX(I.SequenceNumber), 0) + 1 AS Seq
	FROM C
		LEFT JOIN [dbo].[QA_FAQItems] AS I
		ON I.ApplicationID = @ApplicationID AND I.CategoryID = C.CategoryID
	GROUP BY C.CategoryID
	
	UPDATE I
		SET Deleted = 0,
			SequenceNumber = IDs.Seq,
			LastModifierUserID = @CurrentUserID,
			LastModificationDate = @Now
	FROM @CategoryIDs AS IDs
		INNER JOIN [dbo].[QA_FAQItems] AS I
		ON I.ApplicationID = @ApplicationID AND 
			I.CategoryID = IDs.CategoryID AND I.QuestionID = @QuestionID
			
	INSERT INTO [dbo].[QA_FAQItems] (
		ApplicationID,
		CategoryID,
		QuestionID,
		SequenceNumber,
		CreatorUserID,
		CreationDate,
		Deleted
	) 
	SELECT	@ApplicationID, 
			IDs.CategoryID, 
			@QuestionID, 
			IDs.Seq, 
			@CurrentUserID, 
			@Now, 
			0
	FROM @CategoryIDs AS IDs
		LEFT JOIN [dbo].[QA_FAQItems] AS I
		ON I.ApplicationID = @ApplicationID AND 
			I.CategoryID = IDs.CategoryID AND I.QuestionID = @QuestionID
	WHERE I.CategoryID IS NULL
	
	SELECT 1
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[QA_RemoveFAQItem]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[QA_RemoveFAQItem]
GO

CREATE PROCEDURE [dbo].[QA_RemoveFAQItem]
	@ApplicationID	uniqueidentifier,
    @CategoryID		uniqueidentifier,
    @QuestionID		uniqueidentifier,
    @CurrentUserID	uniqueidentifier,
    @Now			datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[QA_FAQItems]
	SET Deleted = 1,
		LastModifierUserID = @CurrentUserID,
		LastModificationDate = @Now
	WHERE ApplicationID = @ApplicationID AND 
		CategoryID = @CategoryID AND QuestionID = @QuestionID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[QA_SetFAQItemsOrder]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[QA_SetFAQItemsOrder]
GO

CREATE PROCEDURE [dbo].[QA_SetFAQItemsOrder]
	@ApplicationID	uniqueidentifier,
	@CategoryID		uniqueidentifier,
	@strQuestionIDs	varchar(max),
	@delimiter		char
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @QuestionIDs TABLE (
		SequenceNo int identity(1, 1) primary key, 
		QuestionID uniqueidentifier
	)
	
	INSERT INTO @QuestionIDs (QuestionID)
	SELECT Ref.Value
	FROM [dbo].[GFN_StrToGuidTable](@strQuestionIDs, @delimiter) AS Ref
	
	INSERT INTO @QuestionIDs (QuestionID)
	SELECT I.QuestionID
	FROM @QuestionIDs AS Ref
		RIGHT JOIN [dbo].[QA_FAQItems] AS I
		ON I.ApplicationID = @ApplicationID AND I.QuestionID = Ref.QuestionID
	WHERE I.ApplicationID = @ApplicationID AND I.CategoryID = @CategoryID AND Ref.QuestionID IS NULL
	ORDER BY I.SequenceNumber
	
	UPDATE [dbo].[QA_FAQItems]
		SET SequenceNumber = Ref.SequenceNo
	FROM @QuestionIDs AS Ref
		INNER JOIN [dbo].[QA_FAQItems] AS I
		ON I.QuestionID = Ref.QuestionID
	WHERE I.ApplicationID = @ApplicationID AND I.CategoryID = @CategoryID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[QA_AddQuestion]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[QA_AddQuestion]
GO

CREATE PROCEDURE [dbo].[QA_AddQuestion]
	@ApplicationID		uniqueidentifier,
    @QuestionID 		uniqueidentifier,
    @Title				nvarchar(500),
    @Description		nvarchar(max),
    @Status				varchar(20),
    @PublicationDate	datetime,
    @strNodeIDs			varchar(max),
    @delimiter			char,
    @WorkFlowID			uniqueidentifier,
    @AdminID			uniqueidentifier,
    @CurrentUserID		uniqueidentifier,
    @Now   				datetime
WITH ENCRYPTION
AS
BEGIN TRANSACTION
	SET NOCOUNT ON

	SET @Title = [dbo].[GFN_VerifyString](@Title)
	SET @Description = [dbo].[GFN_VerifyString](@Description)

    INSERT INTO [dbo].[QA_Questions] (
		[ApplicationID],
        [QuestionID],
		[Title],
		[Description],
		[Status],
		[PublicationDate],
		[WorkFlowID],
		[SenderUserID],
		[SendDate],
		[Deleted]
    )
    VALUES (
		@ApplicationID,
        @QuestionID,
        @Title,
        @Description,
        @Status,
        @PublicationDate,
        @WorkFlowID,
        @CurrentUserID,
        @Now,
        0
    )
    
    /*     convert string ids to guid     */	
	DECLARE @NodeIDs GuidTableType
	
	INSERT INTO @NodeIDs
	SELECT DISTINCT Ref.Value FROM GFN_StrToGuidTable(@strNodeIDs, @delimiter) AS Ref
	/*     end of convert string ids to guid     */
    
    /*     insert related nodes     */
    DECLARE @_NodesCount int
    SET @_NodesCount = (SELECT COUNT(*) FROM @NodeIDs)
    
    INSERT INTO [dbo].[QA_RelatedNodes](
		ApplicationID,
		NodeID, 
		QuestionID, 
		CreatorUserID,
		CreationDate,
		Deleted
	)
    SELECT @ApplicationID, Ref.Value, @QuestionID, @CurrentUserID, @Now, 0
    FROM @NodeIDs AS Ref
    
    IF @_NodesCount > 0 AND @@ROWCOUNT <= 0 BEGIN
		SELECT -1
		ROLLBACK TRANSACTION
		RETURN
    END
    /*     end of insert related nodes     */
    
    
    SELECT (1 + @_NodesCount)
    
    -- Send new dashboards
    IF @AdminID IS NOT NULL BEGIN
		DECLARE @Dashboards DashboardTableType
		
		INSERT INTO @Dashboards(UserID, NodeID, RefItemID, [Type], SubType, Removable, SendDate)
		VALUES (@AdminID, @QuestionID, @QuestionID, N'Question', N'Admin', 0, @Now)
		
		DECLARE @_Result int = 0
		
		EXEC [dbo].[NTFN_P_SendDashboards] @ApplicationID, @Dashboards, @_Result output
		
		IF @_Result <= 0 BEGIN
			SELECT -1
			ROLLBACK TRANSACTION
			RETURN
		END
		ELSE BEGIN
			SELECT * 
			FROM @Dashboards
		END
	END
	-- end of send new dashboards
COMMIT TRANSACTION

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[QA_EditQuestionTitle]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[QA_EditQuestionTitle]
GO

CREATE PROCEDURE [dbo].[QA_EditQuestionTitle]
	@ApplicationID	uniqueidentifier,
    @QuestionID		uniqueidentifier,
	@Title			nvarchar(500),
	@CurrentUserID	uniqueidentifier,
	@Now			datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SET @Title = [dbo].[GFN_VerifyString](@Title)
	
	UPDATE [dbo].[QA_Questions]
		SET [Title] = @Title,
			LastModifierUserID = @CurrentUserID,
			LastModificationDate = @Now
	WHERE ApplicationID = @ApplicationID AND QuestionID = @QuestionID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[QA_EditQuestionDescription]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[QA_EditQuestionDescription]
GO

CREATE PROCEDURE [dbo].[QA_EditQuestionDescription]
	@ApplicationID	uniqueidentifier,
    @QuestionID		uniqueidentifier,
	@Description	nvarchar(max),
	@CurrentUserID	uniqueidentifier,
	@Now			datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SET @Description = [dbo].[GFN_VerifyString](@Description)
	
	UPDATE [dbo].[QA_Questions]
		SET [Description] = @Description,
			LastModifierUserID = @CurrentUserID,
			LastModificationDate = @Now
	WHERE ApplicationID = @ApplicationID AND QuestionID = @QuestionID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[QA_IsQuestion]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[QA_IsQuestion]
GO

CREATE PROCEDURE [dbo].[QA_IsQuestion]
	@ApplicationID	uniqueidentifier,
    @ID				uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT TOP(1) CAST(1 AS int)
	FROM [dbo].[QA_Questions]
	WHERE ApplicationID = @ApplicationID AND QuestionID = @ID
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[QA_IsAnswer]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[QA_IsAnswer]
GO

CREATE PROCEDURE [dbo].[QA_IsAnswer]
	@ApplicationID	uniqueidentifier,
    @ID				uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT TOP(1) CAST(1 AS int)
	FROM [dbo].[QA_Answers]
	WHERE ApplicationID = @ApplicationID AND AnswerID = @ID
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[QA_ConfirmQuestion]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[QA_ConfirmQuestion]
GO

CREATE PROCEDURE [dbo].[QA_ConfirmQuestion]
	@ApplicationID	uniqueidentifier,
    @QuestionID		uniqueidentifier,
	@CurrentUserID	uniqueidentifier,
	@Now			datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[QA_Questions]
		SET [Status] = N'GettingAnswers',
			LastModifierUserID = @CurrentUserID,
			LastModificationDate = @Now
	WHERE ApplicationID = @ApplicationID AND QuestionID = @QuestionID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[QA_SetTheBestAnswer]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[QA_SetTheBestAnswer]
GO

CREATE PROCEDURE [dbo].[QA_SetTheBestAnswer]
	@ApplicationID	uniqueidentifier,
    @QuestionID		uniqueidentifier,
    @AnswerID		uniqueidentifier,
    @Publish		bit,
	@CurrentUserID	uniqueidentifier,
	@Now			datetime
WITH ENCRYPTION
AS
BEGIN TRANSACTION
	SET NOCOUNT ON
	
	UPDATE [dbo].[QA_Questions]
		SET BestAnswerID = @AnswerID,
			PublicationDate = CASE WHEN @Publish = 1
				THEN ISNULL(PublicationDate, @Now) ELSE PublicationDate END,
			LastModifierUserID = @CurrentUserID,
			LastModificationDate = @Now
	WHERE @AnswerID IS NOT NULL AND ApplicationID = @ApplicationID AND QuestionID = @QuestionID
	
	IF @@ROWCOUNT <= 0 BEGIN
		SELECT -1
		ROLLBACK TRANSACTION
		RETURN
	END
	
	-- remove dashboards
	IF @Publish = 1 BEGIN
		DECLARE @_Result int = 0
    
		EXEC [dbo].[NTFN_P_ArithmeticDeleteDashboards] @ApplicationID, 
			NULL, @QuestionID, NULL, N'Question', NULL, 
			@_Result output
			
		IF @_Result <= 0 BEGIN
			SELECT -1
			ROLLBACK TRANSACTION
			RETURN
		END
	END
	-- end of remove dashboards
	
	SELECT 1
COMMIT TRANSACTION

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[QA_SetQuestionStatus]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[QA_SetQuestionStatus]
GO

CREATE PROCEDURE [dbo].[QA_SetQuestionStatus]
	@ApplicationID		uniqueidentifier,
    @QuestionID	 		uniqueidentifier,
    @Status				varchar(50),
    @Publish			bit,
    @CurrentUserID		uniqueidentifier,
    @Now				datetime
WITH ENCRYPTION
AS
BEGIN TRANSACTION
	SET NOCOUNT ON

    UPDATE [dbo].[QA_Questions]
		SET [Status] = @Status,
			PublicationDate = CASE WHEN @Publish = 1
				THEN ISNULL(PublicationDate, @Now) ELSE PublicationDate END,
			LastModifierUserID = ISNULL(@CurrentUserID, LastModifierUserID),
			LastModificationDate = @Now
	WHERE ApplicationID = @ApplicationID AND QuestionID = @QuestionID
	
	IF @@ROWCOUNT <= 0 BEGIN
		SELECT -1
		ROLLBACK TRANSACTION
		RETURN
	END
	
	-- remove dashboards
	IF @Publish = 1 BEGIN
		DECLARE @_Result int = 0
    
		EXEC [dbo].[NTFN_P_ArithmeticDeleteDashboards] @ApplicationID, 
			NULL, @QuestionID, NULL, N'Question', NULL, 
			@_Result output
			
		IF @_Result <= 0 BEGIN
			SELECT -1
			ROLLBACK TRANSACTION
			RETURN
		END
	END
	-- end of remove dashboards
	
	SELECT 1
COMMIT TRANSACTION

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[QA_RemoveQuestion]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[QA_RemoveQuestion]
GO

CREATE PROCEDURE [dbo].[QA_RemoveQuestion]
	@ApplicationID		uniqueidentifier,
    @QuestionID	 		uniqueidentifier,
    @CurrentUserID		uniqueidentifier,
    @Now				datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON

    UPDATE [dbo].[QA_Questions]
		SET [Deleted] = 1,
			LastModifierUserID = @CurrentUserID,
			LastModificationDate = @Now
	WHERE ApplicationID = @ApplicationID AND QuestionID = @QuestionID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[QA_P_GetQuestionsByIDs]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[QA_P_GetQuestionsByIDs]
GO

CREATE PROCEDURE [dbo].[QA_P_GetQuestionsByIDs]
	@ApplicationID		uniqueidentifier,
    @QuestionIDsTemp	KeyLessGuidTableType readonly,
    @CurrentUserID		uniqueidentifier
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @QuestionIDs KeyLessGuidTableType
	INSERT INTO @QuestionIDs (Value) SELECT Value FROM @QuestionIDsTemp
	
	SELECT	Q.QuestionID,
			Q.WorkFlowID,
			Q.Title,
			Q.[Description],
			Q.SendDate,
			Q.BestAnswerID,
			Q.SenderUserID,
			UN.UserName AS SenderUserName,
			UN.FirstName AS SenderFirstName,
			UN.LastName AS SenderLastName,
			Q.[Status],
			Q.PublicationDate,
			(
				SELECT COUNT(A.AnswerID)
				FROM [dbo].[QA_Answers] AS A
				WHERE A.ApplicationID = @ApplicationID AND 
					A.QuestionID = Q.QuestionID AND A.Deleted = 0
			) AS AnswersCount,
			(
				SELECT COUNT(L.UserID)
				FROM [dbo].[RV_Likes] AS L
				WHERE L.ApplicationID = @ApplicationID AND 
					L.LikedID = Q.QuestionID AND L.[Like] = 1
			) AS LikesCount,
			(
				SELECT COUNT(L.UserID)
				FROM [dbo].[RV_Likes] AS L
				WHERE L.ApplicationID = @ApplicationID AND 
					L.LikedID = Q.QuestionID AND L.[Like] = 0
			) AS DislikesCount,
			(
				SELECT TOP(1) L.[Like]
				FROM [dbo].[RV_Likes] AS L
				WHERE L.ApplicationID = @ApplicationID AND 
					L.LikedID = Q.QuestionID AND L.UserID = @CurrentUserID
			) AS LikeStatus,
			(
				SELECT TOP(1) CAST(1 AS bit)
				FROM [dbo].[RV_Followers] AS F
				WHERE F.ApplicationID = @ApplicationID AND 
					F.FollowedID = Q.QuestionID AND F.UserID = @CurrentUserID
			) AS FollowStatus
	FROM @QuestionIDs AS IDs
		INNER JOIN [dbo].[QA_Questions] AS Q
		ON Q.ApplicationID = @ApplicationID AND Q.QuestionID = IDs.Value
		INNER JOIN [dbo].[Users_Normal] AS UN
		ON UN.ApplicationID = @ApplicationID AND UN.UserID = Q.SenderUserID
	ORDER BY IDs.SequenceNumber ASC
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[QA_GetQuestionsByIDs]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[QA_GetQuestionsByIDs]
GO

CREATE PROCEDURE [dbo].[QA_GetQuestionsByIDs]
	@ApplicationID		uniqueidentifier,
    @strQuestionIDs		varchar(max),
    @delimiter			char,
    @CurrentUserID		uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @QuestionIDs KeyLessGuidTableType
	
	INSERT INTO @QuestionIDs (Value)
	SELECT Ref.Value
	FROM [dbo].[GFN_StrToGuidTable](@strQuestionIDs, @delimiter) AS Ref
	
	EXEC [dbo].[QA_P_GetQuestionsByIDs] @ApplicationID, @QuestionIDs, @CurrentUserID
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[QA_GetRelatedQuestions]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[QA_GetRelatedQuestions]
GO

CREATE PROCEDURE [dbo].[QA_GetRelatedQuestions]
	@ApplicationID		uniqueidentifier,
    @UserID		 		uniqueidentifier,
    @Groups				bit,
	@ExpertiseDomains	bit,
	@Favorites			bit,
	@Properties			bit,
	@FromFriends		bit,
	@Count				int,
	@LowerBoundary		bigint
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT TOP(ISNULL(@Count, 1000000))
		Questions.*,
		(Questions.RowNumber + Questions.RevRowNumber - 1) AS TotalCount,
		UN.UserName AS SenderUserName,
		UN.FirstName AS SenderFirstName,
		UN.LastName AS SenderLastName,
		(
			SELECT COUNT(A.AnswerID)
			FROM [dbo].[QA_Answers] AS A
			WHERE A.ApplicationID = @ApplicationID AND 
				A.QuestionID = Questions.QuestionID AND A.Deleted = 0
		) AS AnswersCount,
		(
			SELECT COUNT(L.UserID)
			FROM [dbo].[RV_Likes] AS L
			WHERE L.ApplicationID = @ApplicationID AND 
				L.LikedID = Questions.QuestionID AND L.[Like] = 1
		) AS LikesCount,
		(
			SELECT COUNT(L.UserID)
			FROM [dbo].[RV_Likes] AS L
			WHERE L.ApplicationID = @ApplicationID AND 
				L.LikedID = Questions.QuestionID AND L.[Like] = 0
		) AS DislikesCount
	FROM (
			SELECT	ROW_NUMBER() OVER (ORDER BY MAX(QS.SendDate) DESC, QS.QuestionID ASC) AS RowNumber,
					ROW_NUMBER() OVER (ORDER BY MAX(QS.SendDate) ASC, QS.QuestionID DESC) AS RevRowNumber,
					QS.QuestionID,
					MAX(QS.Title) AS Title,
					MAX(QS.SendDate) AS SendDate,
					CAST(MAX(CAST(QS.SenderUserID AS varchar(50))) AS uniqueidentifier) AS SenderUserID,
					CAST(MAX(QS.HasBestAnswer) AS bit) AS HasBestAnswer,
					MAX(QS.[Status]) AS [Status],
					COUNT(QS.RelatedNodeID) AS RelatedNodesCount,
					CAST(MAX(QS.IsGroup) AS bit) AS IsGroup,
					CAST(MAX(QS.IsExpertise) AS bit) AS IsExpertiseDomain,
					CAST(MAX(QS.IsFavorite) AS bit) AS IsFavorite,
					CAST(MAX(QS.IsProperty) AS bit) AS IsProperty,
					CAST(MAX(QS.FromFriend) AS bit) AS FromFriend
			FROM (
					SELECT	Q.QuestionID, 
							Q.Title,
							Q.SendDate,
							Q.SenderUserID,
							(CASE WHEN Q.BestAnswerID IS NULL THEN 0 ELSE 1 END) AS HasBestAnswer,
							Q.[Status],
							Nodes.NodeID AS RelatedNodeID,
							Nodes.IsGroup,
							Nodes.IsExpertise,
							Nodes.IsFavorite,
							Nodes.IsProperty,
							0 AS FromFriend
					FROM (
							SELECT	X.NodeID, 
									MAX(X.IsGroup) AS IsGroup, 
									MAX(X.IsExpertise) AS IsExpertise, 
									MAX(X.IsFavorite) AS IsFavorite, 
									MAX(X.IsProperty) AS IsProperty
							FROM (
									SELECT NodeID, 1 AS IsGroup, 0 AS IsExpertise, 0 AS IsFavorite, 0 AS IsProperty
									FROM [dbo].[CN_View_NodeMembers]
									WHERE @Groups = 1 AND ApplicationID = @ApplicationID AND UserID = @UserID AND
										ISNULL(IsPending, 0) = 0
										
									UNION ALL

									SELECT NodeID, 0 AS IsGroup, 1 AS IsExpertise, 0 AS IsFavorite, 0 AS IsProperty
									FROM [dbo].[CN_View_Experts] AS X
									WHERE @ExpertiseDomains = 1 AND ApplicationID = @ApplicationID AND UserID = @UserID

									UNION ALL

									SELECT NL.NodeID, 0 AS IsGroup, 0 AS IsExpertise, 1 AS IsFavorite, 0 AS IsProperty
									FROM [dbo].[CN_NodeLikes] AS NL
										INNER JOIN [dbo].[CN_Nodes] AS ND
										ON ND.ApplicationID = @ApplicationID AND ND.NodeID = NL.NodeID AND ND.Deleted = 0
									WHERE @Favorites = 1 AND NL.ApplicationID = @ApplicationID AND 
										NL.UserID = @UserID AND NL.Deleted = 0

									UNION ALL

									SELECT NC.NodeID, 0 AS IsGroup, 0 AS IsExpertise, 0 AS IsFavorite, 1 AS IsProperty
									FROM [dbo].[CN_NodeCreators] AS NC
										INNER JOIN [dbo].[CN_Nodes] AS ND
										ON ND.ApplicationID = @ApplicationID AND ND.NodeID = NC.NodeID AND ND.Deleted = 0
									WHERE @Properties = 1 AND NC.ApplicationID = @ApplicationID AND 
										NC.UserID = @UserID AND NC.Deleted = 0
								) AS X
							GROUP BY X.NodeID
						) AS Nodes
						INNER JOIN [dbo].[QA_RelatedNodes] AS ND
						ON ND.ApplicationID = @ApplicationID AND ND.NodeID = Nodes.NodeID
						INNER JOIN [dbo].[QA_Questions] AS Q
						ON Q.ApplicationID = @ApplicationID AND Q.QuestionID = ND.QuestionID AND 
							Q.PublicationDate IS NOT NULL AND Q.Deleted = 0
					WHERE ND.Deleted = 0

					UNION ALL

					SELECT	Q.QuestionID, 
							Q.Title,
							Q.SendDate, 
							Q.SenderUserID,
							(CASE WHEN Q.BestAnswerID IS NULL THEN 0 ELSE 1 END) AS HasBestAnswer,
							Q.[Status],
							NULL AS RelatedNodeID,
							0 AS IsGroup,
							0 AS IsExpertise,
							0 AS IsFavorite,
							0 AS IsProperty,
							1 AS FromFriend
					FROM [dbo].[QA_Questions] AS Q
						INNER JOIN [dbo].[USR_View_Friends] AS F
						ON F.ApplicationId = @ApplicationID AND F.UserID = @UserID AND 
							F.FriendID = Q.SenderUserID AND F.AreFriends = 1
					WHERE @FromFriends = 1 AND Q.PublicationDate IS NOT NULL AND Q.Deleted = 0
				) AS QS
			GROUP BY QS.QuestionID
		) AS Questions
		INNER JOIN [dbo].[Users_Normal] AS UN
		ON UN.ApplicationID = @ApplicationID AND UN.UserID = Questions.SenderUserID
	WHERE Questions.RowNumber >= ISNULL(@LowerBoundary, 0)
	ORDER BY Questions.RowNumber ASC
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[QA_MyFavoriteQuestions]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[QA_MyFavoriteQuestions]
GO

CREATE PROCEDURE [dbo].[QA_MyFavoriteQuestions]
	@ApplicationID	uniqueidentifier,
	@UserID			uniqueidentifier,
	@Count			int,
	@LowerBoundary	bigint
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT TOP(ISNULL(@Count, 1000000))
		Questions.*,
		(Questions.RowNumber + Questions.RevRowNumber - 1) AS TotalCount,
		UN.UserName AS SenderUserName,
		UN.FirstName AS SenderFirstName,
		UN.LastName AS SenderLastName,
		(
			SELECT COUNT(R.NodeID)
			FROM [dbo].[QA_RelatedNodes] AS R
			WHERE R.ApplicationID = @ApplicationID AND 
				R.QuestionID = Questions.QuestionID AND R.Deleted = 0
		) AS RelatedNodesCount,
		(
			SELECT COUNT(A.AnswerID)
			FROM [dbo].[QA_Answers] AS A
			WHERE A.ApplicationID = @ApplicationID AND 
				A.QuestionID = Questions.QuestionID AND A.Deleted = 0
		) AS AnswersCount,
		(
			SELECT COUNT(L.UserID)
			FROM [dbo].[RV_Likes] AS L
			WHERE L.ApplicationID = @ApplicationID AND 
				L.LikedID = Questions.QuestionID AND L.[Like] = 1
		) AS LikesCount,
		(
			SELECT COUNT(L.UserID)
			FROM [dbo].[RV_Likes] AS L
			WHERE L.ApplicationID = @ApplicationID AND 
				L.LikedID = Questions.QuestionID AND L.[Like] = 0
		) AS DislikesCount
	FROM (
			SELECT	ROW_NUMBER() OVER (ORDER BY Q.SendDate DESC, Q.QuestionID ASC) AS RowNumber,
					ROW_NUMBER() OVER (ORDER BY Q.SendDate ASC, Q.QuestionID DESC) AS RevRowNumber,
					Q.QuestionID, 
					Q.Title, 
					Q.SendDate, 
					Q.SenderUserID,
					CAST((CASE WHEN Q.BestAnswerID IS NULL THEN 0 ELSE 1 END) AS bit) AS HasBestAnswer,
					Q.[Status]
			FROM [dbo].[RV_Followers] AS F
				INNER JOIN [dbo].[QA_Questions] AS Q
				ON F.ApplicationID = @ApplicationID AND 
					Q.QuestionID = F.FollowedID AND Q.Deleted = 0
			WHERE F.ApplicationID = @ApplicationID AND F.UserID = @UserID -- AND L.[Like] = 1
		) AS Questions
		INNER JOIN [dbo].[Users_Normal] AS UN
		ON UN.ApplicationID = @ApplicationID AND UN.UserID = Questions.SenderUserID
	WHERE Questions.RowNumber >= ISNULL(@LowerBoundary, 0)
	ORDER BY Questions.RowNumber ASC
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[QA_MyAskedQuestions]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[QA_MyAskedQuestions]
GO

CREATE PROCEDURE [dbo].[QA_MyAskedQuestions]
	@ApplicationID	uniqueidentifier,
	@UserID			uniqueidentifier,
	@Count			int,
	@LowerBoundary	bigint
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT TOP(ISNULL(@Count, 1000000))
		Questions.*,
		(Questions.RowNumber + Questions.RevRowNumber - 1) AS TotalCount,
		UN.UserName AS SenderUserName,
		UN.FirstName AS SenderFirstName,
		UN.LastName AS SenderLastName,
		(
			SELECT COUNT(R.NodeID)
			FROM [dbo].[QA_RelatedNodes] AS R
			WHERE R.ApplicationID = @ApplicationID AND 
				R.QuestionID = Questions.QuestionID AND R.Deleted = 0
		) AS RelatedNodesCount,
		(
			SELECT COUNT(A.AnswerID)
			FROM [dbo].[QA_Answers] AS A
			WHERE A.ApplicationID = @ApplicationID AND 
				A.QuestionID = Questions.QuestionID AND A.Deleted = 0
		) AS AnswersCount,
		(
			SELECT COUNT(L.UserID)
			FROM [dbo].[RV_Likes] AS L
			WHERE L.ApplicationID = @ApplicationID AND 
				L.LikedID = Questions.QuestionID AND L.[Like] = 1
		) AS LikesCount,
		(
			SELECT COUNT(L.UserID)
			FROM [dbo].[RV_Likes] AS L
			WHERE L.ApplicationID = @ApplicationID AND 
				L.LikedID = Questions.QuestionID AND L.[Like] = 0
		) AS DislikesCount
	FROM (
			SELECT	ROW_NUMBER() OVER (ORDER BY Q.SendDate DESC, Q.QuestionID ASC) AS RowNumber,
					ROW_NUMBER() OVER (ORDER BY Q.SendDate ASC, Q.QuestionID DESC) AS RevRowNumber,
					Q.QuestionID, 
					Q.Title, 
					Q.SendDate, 
					Q.SenderUserID,
					CAST((CASE WHEN Q.BestAnswerID IS NULL THEN 0 ELSE 1 END) AS bit) AS HasBestAnswer,
					Q.[Status]
			FROM [dbo].[QA_Questions] AS Q
			WHERE Q.SenderUserID = @UserID AND Q.Deleted = 0
		) AS Questions
		INNER JOIN [dbo].[Users_Normal] AS UN
		ON UN.ApplicationID = @ApplicationID AND UN.UserID = Questions.SenderUserID
	WHERE Questions.RowNumber >= ISNULL(@LowerBoundary, 0)
	ORDER BY Questions.RowNumber ASC
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[QA_QuestionsAskedOfMe]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[QA_QuestionsAskedOfMe]
GO

CREATE PROCEDURE [dbo].[QA_QuestionsAskedOfMe]
	@ApplicationID	uniqueidentifier,
	@UserID			uniqueidentifier,
	@Count			int,
	@LowerBoundary	bigint
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT TOP(ISNULL(@Count, 1000000))
		Questions.*,
		(Questions.RowNumber + Questions.RevRowNumber - 1) AS TotalCount,
		UN.UserName AS SenderUserName,
		UN.FirstName AS SenderFirstName,
		UN.LastName AS SenderLastName,
		(
			SELECT COUNT(R.NodeID)
			FROM [dbo].[QA_RelatedNodes] AS R
			WHERE R.ApplicationID = @ApplicationID AND 
				R.QuestionID = Questions.QuestionID AND R.Deleted = 0
		) AS RelatedNodesCount,
		(
			SELECT COUNT(A.AnswerID)
			FROM [dbo].[QA_Answers] AS A
			WHERE A.ApplicationID = @ApplicationID AND 
				A.QuestionID = Questions.QuestionID AND A.Deleted = 0
		) AS AnswersCount,
		(
			SELECT COUNT(L.UserID)
			FROM [dbo].[RV_Likes] AS L
			WHERE L.ApplicationID = @ApplicationID AND 
				L.LikedID = Questions.QuestionID AND L.[Like] = 1
		) AS LikesCount,
		(
			SELECT COUNT(L.UserID)
			FROM [dbo].[RV_Likes] AS L
			WHERE L.ApplicationID = @ApplicationID AND 
				L.LikedID = Questions.QuestionID AND L.[Like] = 0
		) AS DislikesCount
	FROM (
			SELECT	ROW_NUMBER() OVER (ORDER BY Q.SendDate DESC, Q.QuestionID ASC) AS RowNumber,
					ROW_NUMBER() OVER (ORDER BY Q.SendDate ASC, Q.QuestionID DESC) AS RevRowNumber,
					Q.QuestionID, 
					Q.Title, 
					Q.SendDate, 
					Q.SenderUserID,
					CAST((CASE WHEN Q.BestAnswerID IS NULL THEN 0 ELSE 1 END) AS bit) AS HasBestAnswer,
					Q.[Status]
			FROM [dbo].[QA_RelatedUsers] AS U
				INNER JOIN [dbo].[QA_Questions] AS Q
				ON Q.ApplicationID = @ApplicationID AND 
					Q.QuestionID = U.QuestionID AND Q.Deleted = 0
			WHERE U.ApplicationID = @ApplicationID AND U.UserID = @UserID AND U.Deleted = 0
		) AS Questions
		INNER JOIN [dbo].[Users_Normal] AS UN
		ON UN.ApplicationID = @ApplicationID AND UN.UserID = Questions.SenderUserID
	WHERE Questions.RowNumber >= ISNULL(@LowerBoundary, 0)
	ORDER BY Questions.RowNumber ASC
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[QA_GetFAQItems]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[QA_GetFAQItems]
GO

CREATE PROCEDURE [dbo].[QA_GetFAQItems]
	@ApplicationID	uniqueidentifier,
	@CategoryID		uniqueidentifier,
	@Count			int,
	@LowerBoundary	bigint
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT TOP(ISNULL(@Count, 1000000))
		Questions.*,
		(Questions.RowNumber + Questions.RevRowNumber - 1) AS TotalCount,
		UN.UserName AS SenderUserName,
		UN.FirstName AS SenderFirstName,
		UN.LastName AS SenderLastName,
		(
			SELECT COUNT(R.NodeID)
			FROM [dbo].[QA_RelatedNodes] AS R
			WHERE R.ApplicationID = @ApplicationID AND 
				R.QuestionID = Questions.QuestionID AND R.Deleted = 0
		) AS RelatedNodesCount,
		(
			SELECT COUNT(A.AnswerID)
			FROM [dbo].[QA_Answers] AS A
			WHERE A.ApplicationID = @ApplicationID AND 
				A.QuestionID = Questions.QuestionID AND A.Deleted = 0
		) AS AnswersCount,
		(
			SELECT COUNT(L.UserID)
			FROM [dbo].[RV_Likes] AS L
			WHERE L.ApplicationID = @ApplicationID AND 
				L.LikedID = Questions.QuestionID AND L.[Like] = 1
		) AS LikesCount,
		(
			SELECT COUNT(L.UserID)
			FROM [dbo].[RV_Likes] AS L
			WHERE L.ApplicationID = @ApplicationID AND 
				L.LikedID = Questions.QuestionID AND L.[Like] = 0
		) AS DislikesCount
	FROM (
			SELECT	ROW_NUMBER() OVER (ORDER BY I.SequenceNumber ASC, Q.SendDate DESC, I.QuestionID ASC) AS RowNumber,
					ROW_NUMBER() OVER (ORDER BY I.SequenceNumber DESC, Q.SendDate ASC, I.QuestionID DESC) AS RevRowNumber,
					Q.QuestionID, 
					Q.Title, 
					Q.SendDate, 
					Q.SenderUserID,
					CAST((CASE WHEN Q.BestAnswerID IS NULL THEN 0 ELSE 1 END) AS bit) AS HasBestAnswer,
					Q.[Status]
			FROM [dbo].[QA_FAQItems] AS I
				INNER JOIN [dbo].[QA_Questions] AS Q
				ON Q.ApplicationID = @ApplicationID AND Q.QuestionID = I.QuestionID AND
					Q.PublicationDate IS NOT NULL AND Q.Deleted = 0
			WHERE I.ApplicationID = @ApplicationID AND I.CategoryID = @CategoryID AND I.Deleted = 0
		) AS Questions
		INNER JOIN [dbo].[Users_Normal] AS UN
		ON UN.ApplicationID = @ApplicationID AND UN.UserID = Questions.SenderUserID
	WHERE Questions.RowNumber >= ISNULL(@LowerBoundary, 0)
	ORDER BY Questions.RowNumber ASC
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[QA_GetQuestions]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[QA_GetQuestions]
GO

CREATE PROCEDURE [dbo].[QA_GetQuestions]
	@ApplicationID	uniqueidentifier,
	@SearchText		nvarchar(1000),
	@DateFrom		datetime,
	@DateTo			datetime,
	@Count			int,
	@LowerBoundary	bigint
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	IF @SearchText IS NULL OR @SearchText = N'' SET @SearchText = NULL
	
	IF @SearchText IS NULL BEGIN
		SELECT TOP(ISNULL(@Count, 1000000))
			Questions.*,
			(Questions.RowNumber + Questions.RevRowNumber - 1) AS TotalCount,
			UN.UserName AS SenderUserName,
			UN.FirstName AS SenderFirstName,
			UN.LastName AS SenderLastName,
			(
				SELECT COUNT(R.NodeID)
				FROM [dbo].[QA_RelatedNodes] AS R
				WHERE R.ApplicationID = @ApplicationID AND 
					R.QuestionID = Questions.QuestionID AND R.Deleted = 0
			) AS RelatedNodesCount,
			(
				SELECT COUNT(A.AnswerID)
				FROM [dbo].[QA_Answers] AS A
				WHERE A.ApplicationID = @ApplicationID AND 
					A.QuestionID = Questions.QuestionID AND A.Deleted = 0
			) AS AnswersCount,
			(
				SELECT COUNT(L.UserID)
				FROM [dbo].[RV_Likes] AS L
				WHERE L.ApplicationID = @ApplicationID AND 
					L.LikedID = Questions.QuestionID AND L.[Like] = 1
			) AS LikesCount,
			(
				SELECT COUNT(L.UserID)
				FROM [dbo].[RV_Likes] AS L
				WHERE L.ApplicationID = @ApplicationID AND 
					L.LikedID = Questions.QuestionID AND L.[Like] = 0
			) AS DislikesCount
		FROM (
				SELECT	ROW_NUMBER() OVER (ORDER BY Q.SendDate DESC, Q.QuestionID ASC) AS RowNumber,
						ROW_NUMBER() OVER (ORDER BY Q.SendDate ASC, Q.QuestionID DESC) AS RevRowNumber,
						Q.QuestionID, 
						Q.Title, 
						Q.SendDate, 
						Q.SenderUserID,
						CAST((CASE WHEN Q.BestAnswerID IS NULL THEN 0 ELSE 1 END) AS bit) AS HasBestAnswer,
						Q.[Status]
				FROM [dbo].[QA_Questions] AS Q
				WHERE Q.ApplicationID = @ApplicationID AND Q.Deleted = 0 AND
					Q.PublicationDate IS NOT NULL AND
					(@DateFrom IS NULL OR Q.SendDate >= @DateFrom) AND
					(@DateTo IS NULL OR Q.SendDate <= @DateTo)
			) AS Questions
			INNER JOIN [dbo].[Users_Normal] AS UN
			ON UN.ApplicationID = @ApplicationID AND UN.UserID = Questions.SenderUserID
		WHERE Questions.RowNumber >= ISNULL(@LowerBoundary, 0)
		ORDER BY Questions.RowNumber ASC
	END
	ELSE BEGIN
		SELECT TOP(ISNULL(@Count, 1000000))
			Questions.*,
			(Questions.RowNumber + Questions.RevRowNumber - 1) AS TotalCount,
			UN.UserName AS SenderUserName,
			UN.FirstName AS SenderFirstName,
			UN.LastName AS SenderLastName,
			(
				SELECT COUNT(R.NodeID)
				FROM [dbo].[QA_RelatedNodes] AS R
				WHERE R.ApplicationID = @ApplicationID AND 
					R.QuestionID = Questions.QuestionID AND R.Deleted = 0
			) AS RelatedNodesCount,
			(
				SELECT COUNT(A.AnswerID)
				FROM [dbo].[QA_Answers] AS A
				WHERE A.ApplicationID = @ApplicationID AND 
					A.QuestionID = Questions.QuestionID AND A.Deleted = 0
			) AS AnswersCount,
			(
				SELECT COUNT(L.UserID)
				FROM [dbo].[RV_Likes] AS L
				WHERE L.ApplicationID = @ApplicationID AND 
					L.LikedID = Questions.QuestionID AND L.[Like] = 1
			) AS LikesCount,
			(
				SELECT COUNT(L.UserID)
				FROM [dbo].[RV_Likes] AS L
				WHERE L.ApplicationID = @ApplicationID AND 
					L.LikedID = Questions.QuestionID AND L.[Like] = 0
			) AS DislikesCount
		FROM (
				SELECT	ROW_NUMBER() OVER (ORDER BY SRCH.[Rank] DESC, SRCH.[Key] ASC) AS RowNumber,
						ROW_NUMBER() OVER (ORDER BY SRCH.[Rank] ASC, SRCH.[Key] DESC) AS RevRowNumber,
						Q.QuestionID, 
						Q.Title, 
						Q.SendDate, 
						Q.SenderUserID,
						CAST((CASE WHEN Q.BestAnswerID IS NULL THEN 0 ELSE 1 END) AS bit) AS HasBestAnswer,
						Q.[Status]
				FROM CONTAINSTABLE([dbo].[QA_Questions], ([Title], [Description]), @SearchText) AS SRCH
					INNER JOIN [dbo].[QA_Questions] AS Q
					ON Q.ApplicationID = @ApplicationID AND Q.QuestionID = SRCH.[Key]
				WHERE Q.Deleted = 0 AND Q.PublicationDate IS NOT NULL AND
					(@DateFrom IS NULL OR Q.SendDate >= @DateFrom) AND
					(@DateTo IS NULL OR Q.SendDate <= @DateTo)
			) AS Questions
			INNER JOIN [dbo].[Users_Normal] AS UN
			ON UN.ApplicationID = @ApplicationID AND UN.UserID = Questions.SenderUserID
		WHERE Questions.RowNumber >= ISNULL(@LowerBoundary, 0)
		ORDER BY Questions.RowNumber ASC
	END
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[QA_FindRelatedQuestions]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[QA_FindRelatedQuestions]
GO

CREATE PROCEDURE [dbo].[QA_FindRelatedQuestions]
	@ApplicationID	uniqueidentifier,
	@QuestionID		uniqueidentifier,
	@Count			int,
	@LowerBoundary	bigint
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT TOP(ISNULL(@Count, 1000000))
		Questions.*,
		(Questions.RowNumber + Questions.RevRowNumber - 1) AS TotalCount,
		UN.UserName AS SenderUserName,
		UN.FirstName AS SenderFirstName,
		UN.LastName AS SenderLastName,
		(
			SELECT COUNT(R.NodeID)
			FROM [dbo].[QA_RelatedNodes] AS R
			WHERE R.ApplicationID = @ApplicationID AND 
				R.QuestionID = Questions.QuestionID AND R.Deleted = 0
		) AS RelatedNodesCount,
		(
			SELECT COUNT(A.AnswerID)
			FROM [dbo].[QA_Answers] AS A
			WHERE A.ApplicationID = @ApplicationID AND 
				A.QuestionID = Questions.QuestionID AND A.Deleted = 0
		) AS AnswersCount,
		(
			SELECT COUNT(L.UserID)
			FROM [dbo].[RV_Likes] AS L
			WHERE L.ApplicationID = @ApplicationID AND 
				L.LikedID = Questions.QuestionID AND L.[Like] = 1
		) AS LikesCount,
		(
			SELECT COUNT(L.UserID)
			FROM [dbo].[RV_Likes] AS L
			WHERE L.ApplicationID = @ApplicationID AND 
				L.LikedID = Questions.QuestionID AND L.[Like] = 0
		) AS DislikesCount
	FROM (
			SELECT	ROW_NUMBER() OVER (ORDER BY IDs.[Count] DESC, IDs.QuestionID ASC) AS RowNumber,
					ROW_NUMBER() OVER (ORDER BY IDs.[Count] ASC, IDs.QuestionID DESC) AS RevRowNumber,
					Q.QuestionID,
					Q.Title,
					Q.SendDate,
					Q.SenderUserID,
					CAST((CASE WHEN Q.BestAnswerID IS NULL THEN 0 ELSE 1 END) AS bit) AS HasBestAnswer,
					Q.[Status]
			FROM (
					SELECT R2.QuestionID, COUNT(R2.NodeID) AS [Count]
					FROM [dbo].[QA_RelatedNodes] AS R
						INNER JOIN [dbo].[QA_RelatedNodes] AS R2
						ON R2.ApplicationID = @ApplicationID AND 
							R2.NodeID = R.NodeID AND R2.Deleted = 0
					WHERE R.ApplicationID = @ApplicationID AND 
						R.QuestionID = @QuestionID AND R.Deleted = 0
					GROUP BY R2.QuestionID
				) AS IDs
				INNER JOIN [dbo].[QA_Questions] AS Q
				ON Q.ApplicationID = @ApplicationID AND Q.QuestionID = IDs.QuestionID AND 
					Q.PublicationDate IS NOT NULL AND Q.Deleted = 0
		) AS Questions
		INNER JOIN [dbo].[Users_Normal] AS UN
		ON UN.ApplicationID = @ApplicationID AND UN.UserID = Questions.SenderUserID
	WHERE Questions.RowNumber >= ISNULL(@LowerBoundary, 0)
	ORDER BY Questions.RowNumber ASC
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[QA_GetQuestionsRelatedToNode]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[QA_GetQuestionsRelatedToNode]
GO

CREATE PROCEDURE [dbo].[QA_GetQuestionsRelatedToNode]
	@ApplicationID	uniqueidentifier,
	@NodeID			uniqueidentifier,
	@SearchText		nvarchar(1000),
	@DateFrom		datetime,
	@DateTo			datetime,
	@Count			int,
	@LowerBoundary	bigint
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	IF @SearchText IS NULL OR @SearchText = N'' SET @SearchText = NULL
	
	IF @SearchText IS NULL BEGIN
		SELECT TOP(ISNULL(@Count, 1000000))
			Questions.*,
			(Questions.RowNumber + Questions.RevRowNumber - 1) AS TotalCount,
			UN.UserName AS SenderUserName,
			UN.FirstName AS SenderFirstName,
			UN.LastName AS SenderLastName,
			(
				SELECT COUNT(R.NodeID)
				FROM [dbo].[QA_RelatedNodes] AS R
				WHERE R.ApplicationID = @ApplicationID AND 
					R.QuestionID = Questions.QuestionID AND R.Deleted = 0
			) AS RelatedNodesCount,
			(
				SELECT COUNT(A.AnswerID)
				FROM [dbo].[QA_Answers] AS A
				WHERE A.ApplicationID = @ApplicationID AND 
					A.QuestionID = Questions.QuestionID AND A.Deleted = 0
			) AS AnswersCount,
			(
				SELECT COUNT(L.UserID)
				FROM [dbo].[RV_Likes] AS L
				WHERE L.ApplicationID = @ApplicationID AND 
					L.LikedID = Questions.QuestionID AND L.[Like] = 1
			) AS LikesCount,
			(
				SELECT COUNT(L.UserID)
				FROM [dbo].[RV_Likes] AS L
				WHERE L.ApplicationID = @ApplicationID AND 
					L.LikedID = Questions.QuestionID AND L.[Like] = 0
			) AS DislikesCount
		FROM (
				SELECT	ROW_NUMBER() OVER (ORDER BY Q.SendDate DESC, Q.QuestionID ASC) AS RowNumber,
						ROW_NUMBER() OVER (ORDER BY Q.SendDate ASC, Q.QuestionID DESC) AS RevRowNumber,
						Q.QuestionID, 
						Q.Title, 
						Q.SendDate, 
						Q.SenderUserID,
						CAST((CASE WHEN Q.BestAnswerID IS NULL THEN 0 ELSE 1 END) AS bit) AS HasBestAnswer,
						Q.[Status]
				FROM [dbo].[QA_RelatedNodes] AS R
					INNER JOIN [dbo].[QA_Questions] AS Q
					ON Q.ApplicationID = @ApplicationID AND 
						Q.QuestionID = R.QuestionID AND Q.Deleted = 0
				WHERE R.ApplicationID = @ApplicationID AND R.NodeID = @NodeID AND 
					R.Deleted = 0 AND Q.PublicationDate IS NOT NULL AND
					(@DateFrom IS NULL OR Q.SendDate >= @DateFrom) AND
					(@DateTo IS NULL OR Q.SendDate <= @DateTo)
			) AS Questions
			INNER JOIN [dbo].[Users_Normal] AS UN
			ON UN.ApplicationID = @ApplicationID AND UN.UserID = Questions.SenderUserID
		WHERE Questions.RowNumber >= ISNULL(@LowerBoundary, 0)
		ORDER BY Questions.RowNumber ASC
	END
	ELSE BEGIN
		SELECT TOP(ISNULL(@Count, 1000000))
			Questions.*,
			(Questions.RowNumber + Questions.RevRowNumber - 1) AS TotalCount,
			UN.UserName AS SenderUserName,
			UN.FirstName AS SenderFirstName,
			UN.LastName AS SenderLastName,
			(
				SELECT COUNT(R.NodeID)
				FROM [dbo].[QA_RelatedNodes] AS R
				WHERE R.ApplicationID = @ApplicationID AND 
					R.QuestionID = Questions.QuestionID AND R.Deleted = 0
			) AS RelatedNodesCount,
			(
				SELECT COUNT(A.AnswerID)
				FROM [dbo].[QA_Answers] AS A
				WHERE A.ApplicationID = @ApplicationID AND 
					A.QuestionID = Questions.QuestionID AND A.Deleted = 0
			) AS AnswersCount,
			(
				SELECT COUNT(L.UserID)
				FROM [dbo].[RV_Likes] AS L
				WHERE L.ApplicationID = @ApplicationID AND 
					L.LikedID = Questions.QuestionID AND L.[Like] = 1
			) AS LikesCount,
			(
				SELECT COUNT(L.UserID)
				FROM [dbo].[RV_Likes] AS L
				WHERE L.ApplicationID = @ApplicationID AND 
					L.LikedID = Questions.QuestionID AND L.[Like] = 0
			) AS DislikesCount
		FROM (
				SELECT	ROW_NUMBER() OVER (ORDER BY SRCH.[Rank] DESC, SRCH.[Key] ASC) AS RowNumber,
						ROW_NUMBER() OVER (ORDER BY SRCH.[Rank] ASC, SRCH.[Key] DESC) AS RevRowNumber,
						Q.QuestionID, 
						Q.Title, 
						Q.SendDate, 
						Q.SenderUserID,
						CAST((CASE WHEN Q.BestAnswerID IS NULL THEN 0 ELSE 1 END) AS bit) AS HasBestAnswer,
						Q.[Status]
				FROM CONTAINSTABLE([dbo].[QA_Questions], ([Title], [Description]), @SearchText) AS SRCH
					INNER JOIN [dbo].[QA_RelatedNodes] AS R
					INNER JOIN [dbo].[QA_Questions] AS Q
					ON Q.ApplicationID = @ApplicationID AND 
						Q.QuestionID = R.QuestionID AND Q.Deleted = 0
					ON R.ApplicationID = @ApplicationID AND 
						R.NodeID = @NodeID AND Q.QuestionID = SRCH.[Key]
				WHERE R.Deleted = 0 AND Q.PublicationDate IS NOT NULL AND
					(@DateFrom IS NULL OR Q.SendDate >= @DateFrom) AND
					(@DateTo IS NULL OR Q.SendDate <= @DateTo)
			) AS Questions
			INNER JOIN [dbo].[Users_Normal] AS UN
			ON UN.ApplicationID = @ApplicationID AND UN.UserID = Questions.SenderUserID
		WHERE Questions.RowNumber >= ISNULL(@LowerBoundary, 0)
		ORDER BY Questions.RowNumber ASC
	END
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[QA_GroupQuestionsByRelatedNodes]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[QA_GroupQuestionsByRelatedNodes]
GO

CREATE PROCEDURE [dbo].[QA_GroupQuestionsByRelatedNodes]
	@ApplicationID	uniqueidentifier,
	@CurrentUserID	uniqueidentifier,
	@QuestionID		uniqueidentifier,
	@SearchText		nvarchar(1000),
	@DefaultPrivacy	varchar(50),
	@CheckAccess	bit,
	@Now			datetime,
	@Count			int,
	@LowerBoundary	bigint
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @Nodes Table (NodeID uniqueidentifier primary key clustered, [Count] int)
	
	INSERT INTO @Nodes (NodeID, [Count])
	SELECT N.NodeID, COUNT(Q.QuestionID)
	FROM [dbo].[QA_RelatedNodes] AS N
		INNER JOIN [dbo].[QA_Questions] AS Q
		ON Q.ApplicationID = @ApplicationID AND Q.QuestionID = N.QuestionID AND 
			Q.PublicationDate IS NOT NULL AND Q.Deleted = 0
	WHERE N.ApplicationID = @ApplicationID AND N.Deleted = 0
	GROUP BY N.NodeID
	
	IF @QuestionID IS NOT NULL BEGIN
		DELETE @Nodes
		WHERE NodeID NOT IN (
				SELECT R.NodeID
				FROM [dbo].[QA_RelatedNodes] AS R
				WHERE R.ApplicationID = @ApplicationID AND 
						R.QuestionID = @QuestionID AND R.Deleted = 0
			)
	END
	
	IF @CheckAccess = 1 BEGIN
		DECLARE @NodeIDs KeyLessGuidTableType
	
		INSERT INTO @NodeIDs (Value)
		SELECT NodeID
		FROM @Nodes
		
		DECLARE	@PermissionTypes StringPairTableType
		
		INSERT INTO @PermissionTypes (FirstValue, SecondValue)
		VALUES (N'View', @DefaultPrivacy)
	
		DELETE N
		FROM @Nodes AS N
			LEFT JOIN [dbo].[PRVC_FN_CheckAccess](@ApplicationID, @CurrentUserID, 
				@NodeIDs, N'FAQCategory', @Now, @PermissionTypes) AS A
			ON A.ID = N.NodeID
		WHERE A.ID IS NULL
	END
	
	IF @SearchText IS NULL OR @SearchText = N'' SET @SearchText = NULL
	
	IF @SearchText IS NULL BEGIN
		SELECT TOP(ISNULL(@Count, 1000000))
			X.*,
			(X.RowNumber + x.RevRowNumber - 1) AS TotalCount,
			ND.NodeName,
			ND.TypeName AS NodeType,
			ND.Deleted
		FROM (
				SELECT	ROW_NUMBER() OVER (ORDER BY N.[Count] DESC, N.NodeID ASC) AS RowNumber,
						ROW_NUMBER() OVER (ORDER BY N.[Count] ASC, N.NodeID DESC) AS RevRowNumber,
						N.NodeID,
						N.[Count]
				FROM @Nodes AS N
			) AS X
			INNER JOIN [dbo].[CN_View_Nodes_Normal] AS ND
			ON ND.ApplicationID = @ApplicationID AND ND.NodeID = X.NodeID
		WHERE X.RowNumber >= ISNULL(@LowerBoundary, 0)
		ORDER BY X.RowNumber ASC
	END
	ELSE BEGIN
		SELECT TOP(ISNULL(@Count, 1000000))
			X.*,
			(X.RowNumber + x.RevRowNumber - 1) AS TotalCount,
			ND.NodeName,
			ND.TypeName AS NodeType,
			ND.Deleted
		FROM (
				SELECT	ROW_NUMBER() OVER (ORDER BY SRCH.[Rank] DESC, SRCH.[Key] DESC) AS RowNumber,
						ROW_NUMBER() OVER (ORDER BY SRCH.[Rank] ASC, SRCH.[Key] ASC) AS RevRowNumber,
						N.NodeID,
						N.[Count]
				FROM CONTAINSTABLE([dbo].[CN_Nodes], ([Name], [AdditionalID]), @SearchText) AS SRCH 
					INNER JOIN @Nodes AS N
					ON SRCH.[Key] = N.NodeID
			) AS X
			INNER JOIN [dbo].[CN_View_Nodes_Normal] AS ND
			ON ND.ApplicationID = @ApplicationID AND ND.NodeID = X.NodeID
		WHERE X.RowNumber >= ISNULL(@LowerBoundary, 0)
		ORDER BY X.RowNumber ASC
	END
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[QA_FindRelatedTags]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[QA_FindRelatedTags]
GO

CREATE PROCEDURE [dbo].[QA_FindRelatedTags]
	@ApplicationID	uniqueidentifier,
	@NodeID			uniqueidentifier,
	@Count			int,
	@LowerBoundary	bigint
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON

	SELECT TOP(ISNULL(@Count, 1000000))
		X.NodeID,
		X.QuestionsCount AS [Count],
		(X.RowNumber + x.RevRowNumber - 1) AS TotalCount,
		ND.NodeName,
		ND.TypeName AS NodeType,
		ND.Deleted
	FROM (
			SELECT	ROW_NUMBER() OVER (ORDER BY Tag.[Count] DESC, Tag.QuestionsCount DESC, Tag.NodeID ASC) AS RowNumber,
					ROW_NUMBER() OVER (ORDER BY Tag.[Count] ASC, Tag.QuestionsCount ASC, Tag.NodeID DESC) AS RevRowNumber,
					Tag.*		
			FROM (
					SELECT	IDs.NodeID,
							MAX(IDs.[Count]) AS [Count],
							COUNT(Q.QuestionID) AS QuestionsCount
					FROM (
							SELECT R2.NodeID, COUNT(R2.QuestionID) AS [Count]
							FROM [dbo].[QA_RelatedNodes] AS R
								INNER JOIN [dbo].[QA_RelatedNodes] AS R2
								ON R2.ApplicationID = @ApplicationID AND 
									R2.QuestionID = R.QuestionID AND R2.Deleted = 0
							WHERE R.ApplicationID = @ApplicationID AND 
								R.NodeID = @NodeID AND R.Deleted = 0
							GROUP BY R2.NodeID
						) AS IDs
						INNER JOIN [dbo].[QA_RelatedNodes] AS R
						ON R.ApplicationID = @ApplicationID AND 
							R.NodeID = IDs.NodeID AND R.Deleted = 0
						INNER JOIN [dbo].[QA_Questions] AS Q
						ON Q.ApplicationID = @ApplicationID AND Q.QuestionID = R.QuestionID AND 
							Q.PublicationDate IS NOT NULL AND Q.Deleted = 0
					GROUP BY IDs.NodeID
				) AS Tag
		) AS X
		INNER JOIN [dbo].[CN_View_Nodes_Normal] AS ND
		ON ND.ApplicationID = @ApplicationID AND ND.NodeID = X.NodeID
	WHERE X.RowNumber >= ISNULL(@LowerBoundary, 0)
	ORDER BY X.RowNumber ASC
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[QA_CheckNodes]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[QA_CheckNodes]
GO

CREATE PROCEDURE [dbo].[QA_CheckNodes]
	@ApplicationID	uniqueidentifier,
    @strNodeIDs		varchar(max),
    @delimiter		char
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @NodeIDs GuidTableType
	
	INSERT INTO @NodeIDs (Value)
	SELECT DISTINCT Ref.Value
	FROM [dbo].[GFN_StrToGuidTable](@strNodeIDs, @delimiter) AS Ref
	
	SELECT	X.NodeID,
			X.QuestionsCount AS [Count],
			CAST(0 AS bigint) AS TotalCount,
			ND.NodeName,
			ND.TypeName AS NodeType,
			ND.Deleted
	FROM (
			SELECT	IDs.Value AS NodeID,
					COUNT(Q.QuestionID) AS QuestionsCount
			FROM @NodeIDs AS IDs
				LEFT JOIN [dbo].[QA_RelatedNodes] AS R
				ON R.ApplicationID = @ApplicationID AND 
					R.NodeID = IDs.Value AND R.Deleted = 0
				LEFT JOIN [dbo].[QA_Questions] AS Q
				ON Q.ApplicationID = @ApplicationID AND Q.QuestionID = R.QuestionID AND 
					Q.PublicationDate IS NOT NULL AND Q.Deleted = 0
			GROUP BY IDs.Value
		) AS X
		INNER JOIN [dbo].[CN_View_Nodes_Normal] AS ND
		ON ND.ApplicationID = @ApplicationID AND ND.NodeID = X.NodeID
	ORDER BY X.QuestionsCount DESC, X.NodeID ASC
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[QA_SearchNodes]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[QA_SearchNodes]
GO

CREATE PROCEDURE [dbo].[QA_SearchNodes]
	@ApplicationID	uniqueidentifier,
    @SearchText		nvarchar(500),
    @ExactSearch	bit,
    @OrderByRank	bit,
    @Count			int,
    @LowerBoundary	bigint
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	IF ISNULL(@SearchText, N'') = N'' RETURN
	
	IF @ExactSearch = 1 BEGIN
		SELECT TOP(ISNULL(@Count, 1000000))
				X.NodeID,
				X.QuestionsCount AS [Count],
				(X.RowNumber + x.RevRowNumber - 1) AS TotalCount,
				X.NodeName,
				X.NodeType,
				X.Deleted
		FROM (
				SELECT	ROW_NUMBER() OVER (ORDER BY IDs.QuestionsCount DESC, IDs.NodeID ASC) AS RowNumber,
						ROW_NUMBER() OVER (ORDER BY IDs.QuestionsCount ASC, IDs.NodeID DESC) AS RevRowNumber,
						IDs.*
				FROM (
						SELECT	ND.NodeID,
								COUNT(Q.QuestionID) AS QuestionsCount,
								MAX(ND.NodeName) AS NodeName,
								MAX(ND.TypeName) AS NodeType,
								CAST(MAX(CAST(ND.Deleted AS int)) AS bit) AS Deleted
						FROM [dbo].[CN_View_Nodes_Normal] AS ND
							LEFT JOIN [dbo].[QA_RelatedNodes] AS R
							ON R.ApplicationID = @ApplicationID AND 
								R.NodeID = ND.NodeID AND R.Deleted = 0
							LEFT JOIN [dbo].[QA_Questions] AS Q
							ON Q.ApplicationID = @ApplicationID AND Q.QuestionID = R.QuestionID AND 
								Q.PublicationDate IS NOT NULL AND Q.Deleted = 0
						WHERE ND.ApplicationID = @ApplicationID AND ND.NodeName = @SearchText
						GROUP BY ND.NodeID
					) AS IDs
			) AS X
		WHERE X.RowNumber >= ISNULL(@LowerBoundary, 0)
		ORDER BY X.RowNumber ASC
	END
	ELSE BEGIN
		SELECT TOP(ISNULL(@Count, 1000000))
				X.NodeID,
				X.QuestionsCount AS [Count],
				(X.RowNumber + x.RevRowNumber - 1) AS TotalCount,
				ND.NodeName,
				ND.TypeName AS NodeType,
				ND.Deleted
		FROM (
				SELECT	ROW_NUMBER() OVER (ORDER BY (CASE WHEN @OrderByRank = 1 THEN IDs.[Rank] ELSE IDs.QuestionsCount END) DESC, IDs.NodeID ASC) AS RowNumber,
						ROW_NUMBER() OVER (ORDER BY (CASE WHEN @OrderByRank = 1 THEN IDs.[Rank] ELSE IDs.QuestionsCount END) ASC, IDs.NodeID DESC) AS RevRowNumber,
						IDs.*
				FROM (
						SELECT	SRCH.[Key] AS NodeID,
								COUNT(Q.QuestionID) AS QuestionsCount,
								MAX(SRCH.[Rank]) AS [Rank]
						FROM CONTAINSTABLE([dbo].[CN_Nodes], ([Name]), @SearchText) AS SRCH
							INNER JOIN [dbo].[CN_View_Nodes_Normal] AS ND
							ON ND.ApplicationID = @ApplicationID AND 
								ND.NodeID = SRCH.[Key] AND LEN(ND.NodeName) < 25
							LEFT JOIN [dbo].[QA_RelatedNodes] AS R
							ON R.ApplicationID = @ApplicationID AND R.NodeID = ND.NodeID AND R.Deleted = 0
							LEFT JOIN [dbo].[QA_Questions] AS Q
							ON Q.ApplicationID = @ApplicationID AND Q.QuestionID = R.QuestionID AND 
								Q.PublicationDate IS NOT NULL AND Q.Deleted = 0
						GROUP BY SRCH.[Key]
					) AS IDs
			) AS X
			INNER JOIN [dbo].[CN_View_Nodes_Normal] AS ND
			ON ND.ApplicationID = @ApplicationID AND ND.NodeID = X.NodeID
		WHERE X.RowNumber >= ISNULL(@LowerBoundary, 0)
		ORDER BY X.RowNumber ASC
	END
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[QA_SaveRelatedNodes]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[QA_SaveRelatedNodes]
GO

CREATE PROCEDURE [dbo].[QA_SaveRelatedNodes]
	@ApplicationID	uniqueidentifier,
    @QuestionID		uniqueidentifier,
    @strNodeIDs		varchar(max),
    @delimiter		char,
    @CurrentUserID	uniqueidentifier,
    @Now			datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @NodeIDs GuidTableType
	
	INSERT INTO @NodeIDs (Value)
	SELECT Ref.Value
	FROM [dbo].[GFN_StrToGuidTable](@strNodeIDs, @delimiter) AS Ref
	
	UPDATE R
		SET Deleted = (CASE WHEN N.Value IS NULL THEN 1 ELSE 0 END),
			LastModifierUserID = @CurrentUserID,
			LastModificationDate = @Now
	FROM @NodeIDs AS N
		RIGHT JOIN [dbo].[QA_RelatedNodes] AS R
		ON R.NodeID = N.Value
	WHERE R.ApplicationID = @ApplicationID AND R.QuestionID = @QuestionID
			
	INSERT INTO [dbo].[QA_RelatedNodes] (
		ApplicationID, 
		QuestionID, 
		NodeID,
		CreatorUserID,
		CreationDate,
		Deleted
	)
	SELECT @ApplicationID, @QuestionID, N.Value, @CurrentUserID, @Now, 0
	FROM @NodeIDs AS N
		LEFT JOIN [dbo].[QA_RelatedNodes] AS R
		ON R.ApplicationID = @ApplicationID AND 
			R.QuestionID = @QuestionID AND R.NodeID = N.Value
	WHERE R.NodeID IS NULL
	
	SELECT 1
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[QA_AddRelatedNodes]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[QA_AddRelatedNodes]
GO

CREATE PROCEDURE [dbo].[QA_AddRelatedNodes]
	@ApplicationID	uniqueidentifier,
    @QuestionID		uniqueidentifier,
    @strNodeIDs		varchar(max),
    @delimiter		char,
    @CurrentUserID	uniqueidentifier,
    @Now			datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @NodeIDs GuidTableType
	
	INSERT INTO @NodeIDs (Value)
	SELECT Ref.Value
	FROM [dbo].[GFN_StrToGuidTable](@strNodeIDs, @delimiter) AS Ref
	
	UPDATE R
		SET Deleted = 0,
			LastModifierUserID = @CurrentUserID,
			LastModificationDate = @Now
	FROM @NodeIDs AS N
		INNER JOIN [dbo].[QA_RelatedNodes] AS R
		ON R.ApplicationID = @ApplicationID AND 
			R.NodeID = N.Value AND R.QuestionID = @QuestionID
			
	INSERT INTO [dbo].[QA_RelatedNodes] (
		ApplicationID, 
		QuestionID, 
		NodeID,
		CreatorUserID,
		CreationDate,
		Deleted
	)
	SELECT @ApplicationID, @QuestionID, N.Value, @CurrentUserID, @Now, 0
	FROM @NodeIDs AS N
		LEFT JOIN [dbo].[QA_RelatedNodes] AS R
		ON R.ApplicationID = @ApplicationID AND 
			R.QuestionID = @QuestionID AND R.NodeID = N.Value
	WHERE R.NodeID IS NULL
	
	SELECT 1
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[QA_RemoveRelatedNodes]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[QA_RemoveRelatedNodes]
GO

CREATE PROCEDURE [dbo].[QA_RemoveRelatedNodes]
	@ApplicationID	uniqueidentifier,
    @QuestionID		uniqueidentifier,
    @strNodeIDs		varchar(max),
    @delimiter		char,
    @CurrentUserID	uniqueidentifier,
    @Now			datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @NodeIDs GuidTableType
	
	INSERT INTO @NodeIDs (Value)
	SELECT Ref.Value
	FROM [dbo].[GFN_StrToGuidTable](@strNodeIDs, @delimiter) AS Ref
	
	UPDATE R
		SET Deleted = 1,
			LastModifierUserID = @CurrentUserID,
			LastModificationDate = @Now
	FROM @NodeIDs AS N
		INNER JOIN [dbo].[QA_RelatedNodes] AS R
		ON R.ApplicationID = @ApplicationID AND 
			R.NodeID = N.Value AND R.QuestionID = @QuestionID
	
	SELECT 1
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[QA_IsQuestionOwner]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[QA_IsQuestionOwner]
GO

CREATE PROCEDURE [dbo].[QA_IsQuestionOwner]
	@ApplicationID				uniqueidentifier,
    @QuestionIDOrAnswerID		uniqueidentifier,
	@UserID						uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT TOP(1) @QuestionIDOrAnswerID = ISNULL(QuestionID, @QuestionIDOrAnswerID)
	FROM [dbo].[QA_Answers]
	WHERE ApplicationID = @ApplicationID AND AnswerID = @QuestionIDOrAnswerID
	
	SELECT
		CASE
			WHEN EXISTS(
				SELECT TOP(1) QuestionID
				FROM [dbo].[QA_Questions]
				WHERE ApplicationID = @ApplicationID AND 
					QuestionID = @QuestionIDOrAnswerID AND SenderUserID = @UserID
			) THEN 1
			ELSE 0
		END
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[QA_IsAnswerOwner]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[QA_IsAnswerOwner]
GO

CREATE PROCEDURE [dbo].[QA_IsAnswerOwner]
	@ApplicationID	uniqueidentifier,
    @AnswerID		uniqueidentifier,
	@UserID			uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT
		CASE
			WHEN EXISTS(
				SELECT TOP(1) QuestionID
				FROM [dbo].[QA_Answers]
				WHERE ApplicationID = @ApplicationID AND 
					AnswerID = @AnswerID AND SenderUserID = @UserID
			) THEN 1
			ELSE 0
		END
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[QA_IsCommentOwner]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[QA_IsCommentOwner]
GO

CREATE PROCEDURE [dbo].[QA_IsCommentOwner]
	@ApplicationID	uniqueidentifier,
    @CommentID		uniqueidentifier,
	@UserID			uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT
		CASE
			WHEN EXISTS(
				SELECT TOP(1) OwnerID
				FROM [dbo].[QA_Comments]
				WHERE ApplicationID = @ApplicationID AND 
					CommentID = @CommentID AND SenderUserID = @UserID
			) THEN 1
			ELSE 0
		END
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[QA_IsRelatedUser]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[QA_IsRelatedUser]
GO

CREATE PROCEDURE [dbo].[QA_IsRelatedUser]
	@ApplicationID	uniqueidentifier,
    @QuestionID		uniqueidentifier,
	@UserID			uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT
		CASE
			WHEN EXISTS(
				SELECT TOP(1) UserID
				FROM [dbo].[QA_RelatedUsers]
				WHERE ApplicationID = @ApplicationID AND 
					UserID = @UserID AND QuestionID = @QuestionID AND Deleted = 0
			) THEN 1
			ELSE 0
		END
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[QA_IsRelatedExpertOrMember]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[QA_IsRelatedExpertOrMember]
GO

CREATE PROCEDURE [dbo].[QA_IsRelatedExpertOrMember]
	@ApplicationID		uniqueidentifier,
	@QuestionID			uniqueidentifier,
	@UserID				uniqueidentifier,
	@Experts			bit,
	@Members			bit,
	@CheckCandidates	bit
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SET @Experts = ISNULL(@Experts, 0)
	SET @Members = ISNULL(@Members, 0)
	SET @CheckCandidates = ISNULL(@CheckCandidates, 0)

	DECLARE @Exists bit = 0

	IF @Exists = 0 AND @Experts = 1 AND @CheckCandidates = 1 BEGIN
		SELECT TOP(1) @Exists = 1
		FROM [dbo].[QA_Questions] AS Q
			INNER JOIN [dbo].[QA_RelatedNodes] AS RN
			ON Q.ApplicationID = @ApplicationID AND RN.QuestionID = Q.QuestionID
			INNER JOIN [dbo].[CN_Nodes] AS ND
			ON ND.ApplicationID = @ApplicationID AND ND.NodeID = RN.NodeID
			INNER JOIN [dbo].[QA_CandidateRelations] AS CR
			ON CR.ApplicationID = @ApplicationID AND 
				(CR.NodeID = ND.NodeID OR CR.NodeTypeID = ND.NodeTypeID) AND CR.Deleted = 0
			INNER JOIN [dbo].[CN_View_NodeMembers] AS NM
			ON NM.ApplicationID = @ApplicationID AND 
				NM.NodeID = RN.NodeID AND NM.UserID = @UserID
		WHERE RN.ApplicationID = @ApplicationID AND Q.QuestionID = @QuestionID
	END

	IF @Exists = 0 AND @Members = 1 AND @CheckCandidates = 1 BEGIN
		SELECT TOP(1) @Exists = 1
		FROM [dbo].[QA_Questions] AS Q
			INNER JOIN [dbo].[QA_RelatedNodes] AS RN
			ON Q.ApplicationID = @ApplicationID AND RN.QuestionID = Q.QuestionID
			INNER JOIN [dbo].[CN_Nodes] AS ND
			ON ND.ApplicationID = @ApplicationID AND ND.NodeID = RN.NodeID
			INNER JOIN [dbo].[QA_CandidateRelations] AS CR
			ON CR.ApplicationID = @ApplicationID AND 
				(CR.NodeID = ND.NodeID OR CR.NodeTypeID = ND.NodeTypeID) AND CR.Deleted = 0
			INNER JOIN [dbo].[CN_View_Experts] AS EX
			ON EX.ApplicationID = @ApplicationID AND 
				EX.NodeID = RN.NodeID AND EX.UserID = @UserID
		WHERE RN.ApplicationID = @ApplicationID AND Q.QuestionID = @QuestionID
	END

	IF @Exists = 0 AND @Experts = 1 AND @CheckCandidates = 0 BEGIN
		SELECT TOP(1) @Exists = 1
		FROM [dbo].[QA_RelatedNodes] AS RN
			INNER JOIN [dbo].[CN_View_Experts] AS EX
			ON EX.ApplicationID = @ApplicationID AND 
				EX.NodeID = RN.NodeID AND EX.UserID = @UserID
		WHERE RN.ApplicationID = @ApplicationID AND RN.QuestionID = QuestionID
	END

	IF @Exists = 0 AND @Members = 1 AND @CheckCandidates = 0 BEGIN
		SELECT TOP(1) @Exists = 1
		FROM [dbo].[QA_RelatedNodes] AS RN
			INNER JOIN [dbo].[CN_View_NodeMembers] AS NM
			ON NM.ApplicationID = @ApplicationID AND 
				NM.NodeID = RN.NodeID AND NM.UserID = @UserID
		WHERE RN.ApplicationID = @ApplicationID AND RN.QuestionID = QuestionID
	END

	SELECT @Exists
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[QA_SendAnswer]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[QA_SendAnswer]
GO

CREATE PROCEDURE [dbo].[QA_SendAnswer]
	@ApplicationID	uniqueidentifier,
	@AnswerID	 	uniqueidentifier,
    @QuestionID 	uniqueidentifier,
    @AnswerBody		nvarchar(max),
    @CurrentUserID	uniqueidentifier,
    @Now			datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON

	SET @AnswerBody = [dbo].[GFN_VerifyString](@AnswerBody)

    INSERT INTO [dbo].[QA_Answers] (
		[ApplicationID],
		[AnswerID],
        [QuestionID],
        [SenderUserID],
        [SendDate],
        [AnswerBody],
        [Deleted]
    )
    VALUES (
		@ApplicationID,
		@AnswerID,
        @QuestionID,
        @CurrentUserID,
        @Now,
        @AnswerBody,
        0
    )
    
    SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[QA_EditAnswer]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[QA_EditAnswer]
GO

CREATE PROCEDURE [dbo].[QA_EditAnswer]
	@ApplicationID	uniqueidentifier,
	@AnswerID	 	uniqueidentifier,
	@AnswerBody		nvarchar(max),
    @CurrentUserID	uniqueidentifier,
    @Now			datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON

	SET @AnswerBody = [dbo].[GFN_VerifyString](@AnswerBody)
	
	UPDATE [dbo].[QA_Answers]
		SET AnswerBody = @AnswerBody,
			LastModifierUserID = @CurrentUserID,
			LastModificationDate = @Now
	WHERE ApplicationID = @ApplicationID AND AnswerID = @AnswerID

    SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[QA_RemoveAnswer]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[QA_RemoveAnswer]
GO

CREATE PROCEDURE [dbo].[QA_RemoveAnswer]
	@ApplicationID	uniqueidentifier,
	@AnswerID	 	uniqueidentifier,
    @CurrentUserID	uniqueidentifier,
    @Now			datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON

	UPDATE [dbo].[QA_Answers]
		SET Deleted = 1,
			LastModifierUserID = @CurrentUserID,
			LastModificationDate = @Now
	WHERE ApplicationID = @ApplicationID AND AnswerID = @AnswerID

    SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[QA_P_GetAnswersByIDs]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[QA_P_GetAnswersByIDs]
GO

CREATE PROCEDURE [dbo].[QA_P_GetAnswersByIDs]
	@ApplicationID	uniqueidentifier,
	@AnswerIDsTemp 	KeyLessGuidTableType readonly,
	@CurrentUserID	uniqueidentifier
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @AnswerIDs KeyLessGuidTableType
	INSERT INTO @AnswerIDs (Value) SELECT Value FROM @AnswerIDsTemp

	SELECT	A.AnswerID,
			A.QuestionID,
			A.AnswerBody,
			A.SenderUserID,
			UN.UserName AS SenderUserName,
			UN.FirstName AS SenderFirstName,
			UN.LastName AS SenderLastName,
			A.SendDate,
			(
				SELECT COUNT(L.UserID)
				FROM [dbo].[RV_Likes] AS L
				WHERE L.ApplicationID = @ApplicationID AND 
					L.LikedID = A.AnswerID AND L.[Like] = 1
			) AS LikesCount,
			(
				SELECT COUNT(L.UserID)
				FROM [dbo].[RV_Likes] AS L
				WHERE L.ApplicationID = @ApplicationID AND 
					L.LikedID = A.AnswerID AND L.[Like] = 0
			) AS DislikesCount,
			(
				SELECT TOP(1) L.[Like]
				FROM [dbo].[RV_Likes] AS L
				WHERE L.ApplicationID = @ApplicationID AND 
					L.UserID = @CurrentUserID AND L.LikedID = A.AnswerID
			) AS LikeStatus
	FROM @AnswerIDs AS IDs
		INNER JOIN [dbo].[QA_Answers] AS A
		ON A.ApplicationID = @ApplicationID AND A.AnswerID = IDs.Value
		INNER JOIN [dbo].[Users_Normal] AS UN
		ON UN.ApplicationID = @ApplicationID AND UN.UserID = A.SenderUserID
	ORDER BY IDs.SequenceNumber ASC
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[QA_GetAnswersByIDs]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[QA_GetAnswersByIDs]
GO

CREATE PROCEDURE [dbo].[QA_GetAnswersByIDs]
	@ApplicationID	uniqueidentifier,
	@strAnswerIDs	varchar(max),
	@delimiter		char,
	@CurrentUserID	uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON

	DECLARE @AnswerIDs KeyLessGuidTableType
	
	INSERT INTO @AnswerIDs (Value)
	SELECT DISTINCT Ref.Value
	FROM [dbo].[GFN_StrToGuidTable](@strAnswerIDs, @delimiter) AS Ref
	
	EXEC [dbo].[QA_P_GetAnswersByIDs] @ApplicationID, @AnswerIDs, @CurrentUserID
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[QA_GetAnswers]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[QA_GetAnswers]
GO

CREATE PROCEDURE [dbo].[QA_GetAnswers]
	@ApplicationID	uniqueidentifier,
	@QuestionID	 	uniqueidentifier,
	@CurrentUserID	uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON

	DECLARE @AnswerIDs KeyLessGuidTableType
	
	INSERT INTO @AnswerIDs (Value)
	SELECT	A.AnswerID
	FROM [dbo].[QA_Answers] AS A
	WHERE A.ApplicationID = @ApplicationID AND 
		A.QuestionID = @QuestionID AND A.Deleted = 0
	ORDER BY A.SendDate ASC, A.AnswerID ASC
	
	EXEC [dbo].[QA_P_GetAnswersByIDs] @ApplicationID, @AnswerIDs, @CurrentUserID
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[QA_SendComment]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[QA_SendComment]
GO

CREATE PROCEDURE [dbo].[QA_SendComment]
	@ApplicationID		uniqueidentifier,
	@CommentID	 		uniqueidentifier,
    @OwnerID	 		uniqueidentifier,
    @ReplyToCommentID	uniqueidentifier,
    @BodyText			nvarchar(max),
    @CurrentUserID		uniqueidentifier,
    @Now				datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON

	SET @BodyText = [dbo].[GFN_VerifyString](@BodyText)

    INSERT INTO [dbo].[QA_Comments] (
		[ApplicationID],
		[CommentID],
        [OwnerID],
        [ReplyToCommentID],
        [BodyText],
        [SenderUserID],
        [SendDate],
        [Deleted]
    )
    VALUES (
		@ApplicationID,
		@CommentID,
        @OwnerID,
        @ReplyToCommentID,
        @BodyText,
        @CurrentUserID,
        @Now,
        0
    )
    
    SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[QA_EditComment]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[QA_EditComment]
GO

CREATE PROCEDURE [dbo].[QA_EditComment]
	@ApplicationID	uniqueidentifier,
	@CommentID	 	uniqueidentifier,
	@BodyText		nvarchar(max),
    @CurrentUserID	uniqueidentifier,
    @Now			datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON

	SET @BodyText = [dbo].[GFN_VerifyString](@BodyText)
	
	UPDATE [dbo].[QA_Comments]
		SET BodyText = @BodyText,
			LastModifierUserID = @CurrentUserID,
			LastModificationDate = @Now
	WHERE ApplicationID = @ApplicationID AND CommentID = @CommentID

    SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[QA_RemoveComment]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[QA_RemoveComment]
GO

CREATE PROCEDURE [dbo].[QA_RemoveComment]
	@ApplicationID	uniqueidentifier,
	@CommentID	 	uniqueidentifier,
    @CurrentUserID	uniqueidentifier,
    @Now			datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON

	UPDATE [dbo].[QA_Comments]
		SET Deleted = 1,
			LastModifierUserID = @CurrentUserID,
			LastModificationDate = @Now
	WHERE ApplicationID = @ApplicationID AND CommentID = @CommentID

    SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[QA_GetComments]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[QA_GetComments]
GO

CREATE PROCEDURE [dbo].[QA_GetComments]
	@ApplicationID	uniqueidentifier,
	@QuestionID	 	uniqueidentifier,
	@CurrentUserID	uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT *
	FROM (
			SELECT	C.CommentID,
					C.OwnerID,
					C.ReplyToCommentID,
					C.BodyText,
					C.SenderUserID,
					UN.UserName AS SenderUserName,
					UN.FirstName AS SenderFirstName,
					UN.LastName AS SenderLastName,
					C.SendDate,
					(
						SELECT COUNT(L.UserID)
						FROM [dbo].[RV_Likes] AS L
						WHERE L.ApplicationID = @ApplicationID AND 
							L.LikedID = C.CommentID AND L.[Like] = 1
					) AS LikesCount,
					(
						SELECT TOP(1) L.[Like]
						FROM [dbo].[RV_Likes] AS L
						WHERE L.ApplicationID = @ApplicationID AND 
							L.UserID = @CurrentUserID AND L.LikedID = C.CommentID
					) AS LikeStatus
			FROM [dbo].[QA_Comments] AS C
				INNER JOIN [dbo].[Users_Normal] AS UN
				ON UN.ApplicationID = @ApplicationID AND UN.UserID = C.SenderUserID
			WHERE C.ApplicationID = @ApplicationID AND C.OwnerID = @QuestionID AND C.Deleted = 0
			
			UNION ALL
			
			SELECT	C.CommentID,
					C.OwnerID,
					C.ReplyToCommentID,
					C.BodyText,
					C.SenderUserID,
					UN.UserName AS SenderUserName,
					UN.FirstName AS SenderFirstName,
					UN.LastName AS SenderLastName,
					C.SendDate,
					(
						SELECT COUNT(L.UserID)
						FROM [dbo].[RV_Likes] AS L
						WHERE L.ApplicationID = @ApplicationID AND 
							L.LikedID = C.CommentID AND L.[Like] = 1
					) AS LikesCount,
					(
						SELECT TOP(1) L.[Like]
						FROM [dbo].[RV_Likes] AS L
						WHERE L.ApplicationID = @ApplicationID AND 
							L.UserID = @CurrentUserID AND L.LikedID = C.CommentID
					) AS LikeStatus
			FROM [dbo].[QA_Answers] AS A
				INNER JOIN [dbo].[QA_Comments] AS C
				ON C.ApplicationID = @ApplicationID AND C.OwnerID = A.AnswerID AND C.Deleted = 0
				INNER JOIN [dbo].[Users_Normal] AS UN
				ON UN.ApplicationID = @ApplicationID AND UN.UserID = C.SenderUserID
			WHERE A.ApplicationID = @ApplicationID AND A.QuestionID = @QuestionID AND A.Deleted = 0
		) AS X
	ORDER BY X.SendDate ASC, X.CommentID ASC
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[QA_GetCommentOwnerID]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[QA_GetCommentOwnerID]
GO

CREATE PROCEDURE [dbo].[QA_GetCommentOwnerID]
	@ApplicationID	uniqueidentifier,
	@CommentID	 	uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT TOP(1) OwnerID AS ID
	FROM [dbo].[QA_Comments]
	WHERE ApplicationID = @ApplicationID AND CommentID = @CommentID
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[QA_AddKnowledgableUser]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[QA_AddKnowledgableUser]
GO

CREATE PROCEDURE [dbo].[QA_AddKnowledgableUser]
	@ApplicationID	uniqueidentifier,
	@QuestionID	 	uniqueidentifier,
	@UserID			uniqueidentifier,
	@CurrentUserID	uniqueidentifier,
	@Now			datetime
WITH ENCRYPTION
AS
BEGIN TRANSACTION
	SET NOCOUNT ON
	
	UPDATE [dbo].[QA_RelatedUsers]
		SET Deleted = 0,
			LastModifierUserID = @CurrentUserID,
			LastModificationDate = @Now
	WHERE ApplicationID = @ApplicationID AND 
		QuestionID = @QuestionID AND UserID = @UserID
		
	IF @@ROWCOUNT = 0 BEGIN
		INSERT INTO [dbo].[QA_RelatedUsers] (
			ApplicationID,
			QuestionID,
			UserID,
			SenderUserID,
			SendDate,
			Seen,
			Deleted
		)
		VALUES (
			@ApplicationID,
			@QuestionID,
			@UserID,
			@CurrentUserID,
			@Now,
			0,
			0
		)
	END
	
    -- Send new dashboards
    IF @UserID IS NOT NULL BEGIN
		DECLARE @_Result int = 0
    
		EXEC [dbo].[NTFN_P_ArithmeticDeleteDashboards] @ApplicationID, 
			@UserID, @QuestionID, NULL, N'Question', N'Knowledgable', 
			@_Result output
			
		IF @_Result <= 0 BEGIN
			SELECT -1
			ROLLBACK TRANSACTION
			RETURN
		END
    
		DECLARE @Dashboards DashboardTableType
		
		INSERT INTO @Dashboards(UserID, NodeID, RefItemID, [Type], SubType, Removable, SendDate)
		VALUES (@UserID, @QuestionID, @QuestionID, N'Question', N'Knowledgable', 0, @Now)
		
		EXEC [dbo].[NTFN_P_SendDashboards] @ApplicationID, @Dashboards, @_Result output
		
		IF @_Result <= 0 BEGIN
			SELECT -1
			ROLLBACK TRANSACTION
			RETURN
		END
		ELSE BEGIN
			SELECT * 
			FROM @Dashboards
		END
	END
	-- end of send new dashboards
COMMIT TRANSACTION

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[QA_RemoveKnowledgableUser]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[QA_RemoveKnowledgableUser]
GO

CREATE PROCEDURE [dbo].[QA_RemoveKnowledgableUser]
	@ApplicationID	uniqueidentifier,
	@QuestionID	 	uniqueidentifier,
	@UserID			uniqueidentifier,
	@CurrentUserID	uniqueidentifier,
	@Now			datetime
WITH ENCRYPTION
AS
BEGIN TRANSACTION
	SET NOCOUNT ON
	
	UPDATE [dbo].[QA_RelatedUsers]
		SET Deleted = 1,
			LastModifierUserID = @CurrentUserID,
			LastModificationDate = @Now
	WHERE ApplicationID = @ApplicationID AND 
		QuestionID = @QuestionID AND UserID = @UserID
	
    -- remove dashboards
    IF @UserID IS NOT NULL BEGIN
		DECLARE @_Result int = 0
    
		EXEC [dbo].[NTFN_P_ArithmeticDeleteDashboards] @ApplicationID, 
			@UserID, @QuestionID, NULL, N'Question', N'Knowledgable', 
			@_Result output
			
		IF @_Result <= 0 BEGIN
			SELECT -1
			ROLLBACK TRANSACTION
			RETURN
		END
		ELSE SELECT 1
	END
	-- end of remove dashboards
COMMIT TRANSACTION

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[QA_GetKnowledgableUserIDs]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[QA_GetKnowledgableUserIDs]
GO

CREATE PROCEDURE [dbo].[QA_GetKnowledgableUserIDs]
	@ApplicationID	uniqueidentifier,
	@QuestionID	 	uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT RU.UserID AS ID
	FROM [dbo].[QA_RelatedUsers] AS RU
		INNER JOIN [dbo].[Users_Normal] AS UN
		ON UN.ApplicationID = @ApplicationID AND 
			UN.UserID = RU.UserID AND UN.IsApproved = 1
	WHERE RU.ApplicationID = @ApplicationID AND 
		RU.QuestionID = @QuestionID AND RU.Deleted = 0
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[QA_GetRelatedExpertAndMemberIDs]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[QA_GetRelatedExpertAndMemberIDs]
GO

CREATE PROCEDURE [dbo].[QA_GetRelatedExpertAndMemberIDs]
	@ApplicationID	uniqueidentifier,
	@QuestionID	 	uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT DISTINCT X.ID
	FROM (
			SELECT NM.UserID AS ID
			FROM [dbo].[QA_RelatedNodes] AS RN
				INNER JOIN [dbo].[CN_View_NodeMembers] AS NM
				ON NM.ApplicationID = @ApplicationID AND 
					NM.NodeID = RN.NodeID AND NM.IsPending = 0
			WHERE RN.ApplicationID = @ApplicationID AND 
				RN.QuestionID = @QuestionID
			
			UNION ALL
			
			SELECT EX.UserID AS ID
			FROM [dbo].[QA_RelatedNodes] AS RN
				INNER JOIN [dbo].[CN_View_Experts] AS EX
				ON EX.ApplicationID = @ApplicationID AND EX.NodeID = RN.NodeID
			WHERE RN.ApplicationID = @ApplicationID AND 
				RN.QuestionID = @QuestionID
		) AS X
		INNER JOIN [dbo].[Users_Normal] AS UN
		ON UN.ApplicationID = @ApplicationID AND 
			UN.UserID = X.ID AND UN.IsApproved = 1
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[QA_FindKnowledgeableUserIDs]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[QA_FindKnowledgeableUserIDs]
GO

CREATE PROCEDURE [dbo].[QA_FindKnowledgeableUserIDs]
	@ApplicationID	uniqueidentifier,
	@QuestionID	 	uniqueidentifier,
	@Count			int,
	@LowerBoundary	bigint
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @SenderUserID uniqueidentifier = (
		SELECT TOP(1) SenderUserID
		FROM [dbo].[QA_Questions]
		WHERE ApplicationID = @ApplicationID AND QuestionID = @QuestionID
	)
	
	DECLARE @Users TABLE (
		UserID uniqueidentifier, 
		Score float, 
		TagScore float, 
		BestAnswerScore float, 
		LikeScore float
	)
		
	;WITH Questions (QuestionID, CommonTagsCount)
	AS
	(
		SELECT	R2.QuestionID, 
				COUNT(DISTINCT R2.NodeID)
		FROM [dbo].[QA_RelatedNodes] AS R
			INNER JOIN [dbo].[QA_RelatedNodes] AS R2
			ON R2.ApplicationID = @ApplicationID AND 
				R2.QuestionID <> @QuestionID AND R2.NodeID = R.NodeID AND R2.Deleted = 0
		WHERE R.ApplicationID = @ApplicationID AND 
			R.QuestionID = @QuestionID AND R.Deleted = 0
		GROUP BY R2.QuestionID
	)
	INSERT INTO @Users (UserID, Score, TagScore, BestAnswerScore, LikeScore)
	SELECT	Scores.UserID, 
			SUM(Scores.Score), 
			SUM(Scores.TagScore), 
			SUM(Scores.BestAnswerScore),
			SUM(Scores.LikesScore)
	FROM (
			SELECT	Found.QuestionID,
					Found.UserID,
					(
						(2 * (CAST(Found.CommonTagsCount AS float) / CAST(MaxTags.[Count] AS float))) + 
						(1.5 * CAST(Found.IsBestAnswerSender AS float)) +
						(CAST(Found.LikesCount AS float) / CAST((CASE WHEN ISNULL(MaxLikes.[Count], 0) = 0 THEN 1 ELSE MaxLikes.[COUNT] END) AS float))
					) AS Score,
					(CAST(Found.CommonTagsCount AS float) / CAST(MaxTags.[Count] AS float)) AS TagScore,
					CAST(Found.IsBestAnswerSender AS float) AS BestAnswerScore,
					(CAST(Found.LikesCount AS float) / CAST((CASE WHEN ISNULL(MaxLikes.[Count], 0) = 0 THEN 1 ELSE MaxLikes.[COUNT] END) AS float)) AS LikesScore
			FROM (
					SELECT	QU.QuestionID,
							QU.UserID,
							MAX(QU.CommonTagsCount) AS CommonTagsCount,
							MAX(QU.IsBestAnswerSender) AS IsBestAnswerSender,
							MAX(QU.LikesCount) AS LikesCount
					FROM (
						SELECT	A.QuestionID, 
								Questions.CommonTagsCount,
								A.SenderUserID AS UserID, 
								CAST(1 AS int) IsBestAnswerSender,
								0 AS LikesCount
						FROM Questions
							INNER JOIN [dbo].[QA_Questions] AS Q
							ON Q.ApplicationID = @ApplicationID AND 
								Q.QuestionID = Questions.QuestionID AND Q.BestAnswerID IS NOT NULL
							INNER JOIN [dbo].[QA_Answers] AS A
							ON A.ApplicationID = @ApplicationID AND A.AnswerID = Q.BestAnswerID
						
						UNION ALL
						
						SELECT	X.QuestionID, 
								MAX(X.CommonTagsCount) AS CommonTagsCount,
								X.SenderUserID AS UserID, 
								CAST(0 AS int) IsBestAnswerSender,
								MAX(X.LikesCount) AS LikesCount
						FROM (
								SELECT	A.QuestionID, 
										MAX(Questions.CommonTagsCount) AS CommonTagsCount,
										A.SenderUserID, 
										SUM(
											CASE 
												WHEN L.[Like] IS NULL THEN 0
												WHEN L.[Like] = 0 THEN -1
												ELSE 1
											END
										) AS LikesCount
								FROM Questions
									INNER JOIN [dbo].[QA_Answers] AS A
									ON A.ApplicationID = @ApplicationID AND 
										A.QuestionID = Questions.QuestionID AND A.Deleted = 0
									LEFT JOIN [dbo].[RV_Likes] AS L
									ON L.ApplicationID = @ApplicationID AND L.LikedID = A.AnswerID
								GROUP BY A.QuestionID, A.AnswerID, A.SenderUserID
							) AS X
						WHERE X.LikesCount >= 0
						GROUP BY X.QuestionID, X.SenderUserID
					) AS QU
					GROUP BY QU.QuestionID, QU.UserID
				) AS Found
				CROSS JOIN (
					SELECT MAX(CommonTagsCount) AS [Count]
					FROM Questions
				) AS MaxTags
				LEFT JOIN (
					SELECT	X.QuestionID, 
							MAX(X.LikesCount) AS [Count]
					FROM (
							SELECT	A.QuestionID, 
									SUM(
										CASE 
											WHEN L.[Like] IS NULL THEN 0
											WHEN L.[Like] = 0 THEN -1
											ELSE 1
										END
									) AS LikesCount
							FROM Questions
								INNER JOIN [dbo].[QA_Answers] AS A
								ON A.ApplicationID = @ApplicationID AND 
									A.QuestionID = Questions.QuestionID AND A.Deleted = 0
								LEFT JOIN [dbo].[RV_Likes] AS L
								ON L.ApplicationID = @ApplicationID AND L.LikedID = A.AnswerID
							GROUP BY A.QuestionID, A.AnswerID, A.SenderUserID
						) AS X
					WHERE X.LikesCount >= 0
					GROUP BY X.QuestionID
				) AS MaxLikes
				ON MaxLikes.QuestionID = Found.QuestionID
		) AS Scores
	GROUP BY Scores.UserID
	
	SELECT TOP(ISNULL(@Count, 1000000))
		(X.RowNumber + X.RevRowNumber - 1) AS TotalCount,
		X.UserID AS ID
	FROM (
			SELECT	ROW_NUMBER() OVER (ORDER BY U.Score DESC, U.UserID ASC) AS RowNumber,
					ROW_NUMBER() OVER (ORDER BY U.Score ASC, U.UserID DESC) AS RevRowNumber,
					U.*
			FROM @Users AS U
				INNER JOIN [dbo].[Users_Normal] AS UN
				ON UN.ApplicationID = @ApplicationID AND 
					UN.UserID = U.UserID AND UN.IsApproved = 1
			WHERE U.UserID <> @SenderUserID
		) AS X
	WHERE X.RowNumber >= ISNULL(@LowerBoundary, 0)
	ORDER BY X.RowNumber ASC
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[QA_GetQuestionAskerID]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[QA_GetQuestionAskerID]
GO

CREATE PROCEDURE [dbo].[QA_GetQuestionAskerID]
	@ApplicationID	uniqueidentifier,
    @QuestionID		uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT SenderUserID
	FROM [dbo].[QA_Questions]
	WHERE ApplicationID = @ApplicationID AND QuestionID = @QuestionID
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[QA_SearchQuestions]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[QA_SearchQuestions]
GO

CREATE PROCEDURE [dbo].[QA_SearchQuestions]
	@ApplicationID	uniqueidentifier,
    @SearchText		nvarchar(512),
    @UserID			uniqueidentifier,
    @Count			int,
    @MinID			uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SET @SearchText = [dbo].[GFN_VerifyString](@SearchText)
	
	DECLARE @TempIDs Table(sqno bigint IDENTITY(1, 1), QuestionID uniqueidentifier)
	DECLARE @QuestionIDs KeyLessGuidTableType
	
	DECLARE @_ST nvarchar(1000) = @SearchText
	IF @SearchText IS NULL OR @SearchText = N'' SET @_ST = NULL
	
	IF @_ST IS NULL BEGIN
		INSERT INTO @TempIDs
		SELECT QU.[QuestionID] 
		FROM [dbo].[QA_Questions] AS QU
		WHERE QU.ApplicationID = @ApplicationID AND 
			QU.PublicationDate IS NOT NULL AND QU.Deleted = 0
	END
	ELSE BEGIN
		INSERT INTO @TempIDs
		SELECT QU.[QuestionID] 
		FROM [dbo].[QA_Questions] AS QU
		WHERE QU.ApplicationID = @ApplicationID AND 
			QU.PublicationDate IS NOT NULL AND QU.Deleted = 0 AND
			CONTAINS((QU.[Title], QU.[Description]), @_ST)
	END
	
	DECLARE @Loc bigint = 0
	IF @MinID IS NOT NULL 
		SET @Loc = (SELECT TOP(1) Ref.sqno FROM @TempIDs AS Ref WHERE Ref.QuestionID = @MinID)
	IF @Loc IS NULL SET @Loc = 0
	
	INSERT INTO @QuestionIDs (Value)
	SELECT TOP(@Count) Ref.QuestionID FROM @TempIDs AS Ref WHERE Ref.sqno > @Loc
	
	EXEC [dbo].[QA_P_GetQuestionsByIDs] @ApplicationID, @QuestionIDs, @UserID
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[QA_GetQuestionsCount]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[QA_GetQuestionsCount]
GO

CREATE PROCEDURE [dbo].[QA_GetQuestionsCount]
	@ApplicationID			uniqueidentifier,
    @Published				bit,
    @CreationDateLowerLimit datetime,
    @CreationDateUpperLimit datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	IF @Published IS NULL SET @Published = 0
	
	SELECT COUNT(*) 
	FROM [dbo].[QA_Questions] AS Q
	WHERE Q.ApplicationID = @ApplicationID AND
		(@CreationDateLowerLimit IS NULL OR Q.[SendDate] >= @CreationDateLowerLimit) AND
		(@CreationDateUpperLimit IS NULL OR Q.[SendDate] <= @CreationDateUpperLimit) AND
		(@Published = 0 OR (@Published = 1 AND Q.PublicationDate IS NOT NULL)) AND 
		Q.[Deleted] = 0
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[QA_GetAnswerSenderIDs]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[QA_GetAnswerSenderIDs]
GO

CREATE PROCEDURE [dbo].[QA_GetAnswerSenderIDs]
	@ApplicationID	uniqueidentifier,
    @QuestionID		uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON

    SELECT SenderUserID AS ID
	FROM [dbo].[QA_Answers]
	WHERE ApplicationID = @ApplicationID AND 
		QuestionID = @QuestionID AND Deleted = 0
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[QA_GetExistingQuestionIDs]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[QA_GetExistingQuestionIDs]
GO

CREATE PROCEDURE [dbo].[QA_GetExistingQuestionIDs]
	@ApplicationID	uniqueidentifier,
	@strQuestionIDs	varchar(max),
	@delimiter		char
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT QuestionID AS ID
	FROM [dbo].[GFN_StrToGuidTable](@strQuestionIDs, @delimiter) AS IDs
		INNER JOIN [dbo].[QA_Questions] AS Q
		ON Q.QuestionID = IDs.Value
	WHERE Q.ApplicationID = @ApplicationID AND Q.Deleted = 0
END

GO

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[EVT_CreateEvent]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[EVT_CreateEvent]
GO

CREATE PROCEDURE [dbo].[EVT_CreateEvent]
	@ApplicationID	uniqueidentifier,
    @EventID 		uniqueidentifier,
    @EventType		nvarchar(256),
    @OwnerID		uniqueidentifier,
    @Title			nvarchar(500),
    @Description	nvarchar(2000),
    @BeginDate		datetime,
    @FinishDate		datetime,
    @CreatorUserID	uniqueidentifier,
    @CreationDate	datetime,
    @strNodeIDs		varchar(8000),
    @strUserIDs		varchar(8000),
    @delimiter		char
WITH ENCRYPTION
AS
BEGIN TRANSACTION
	SET NOCOUNT ON
	
	SET @Title = [dbo].[GFN_VerifyString](@Title)
	SET @Description = [dbo].[GFN_VerifyString](@Description)
	
	DECLARE @NodeIDs GuidTableType, @UserIDs GuidTableType
	
	INSERT INTO @NodeIDs
	SELECT DISTINCT Ref.Value FROM GFN_StrToGuidTable(@strNodeIDs, @delimiter) AS Ref
	
	INSERT INTO @UserIDs
	SELECT DISTINCT Ref.Value FROM GFN_StrToGuidTable(@strUserIDs, @delimiter) AS Ref
	WHERE Ref.Value <> @CreatorUserID
	
	DECLARE @_NodesCount int, @_UsersCount int
	SET @_NodesCount = (SELECT COUNT(*) FROM @NodeIDs)
	SET @_UsersCount = (SELECT COUNT(*) FROM @UserIDs)
	
	INSERT INTO [dbo].[EVT_Events](
		ApplicationID,
		EventID,
		EventType,
		OwnerID,
		Title,
		[Description],
		BeginDate,
		FinishDate,
		CreatorUserID,
		CreationDate,
		Deleted
	)
	VALUES(
		@ApplicationID,
		@EventID,
		@EventType,
		@OwnerID,
		@Title,
		@Description,
		@BeginDate,
		@FinishDate,
		@CreatorUserID,
		@CreationDate,
		0
	)
	
	IF @@ROWCOUNT <= 0 BEGIN
		SELECT -1
		ROLLBACK TRANSACTION
		RETURN
	END
	
	IF @CreatorUserID IS NOT NULL BEGIN
		INSERT INTO [dbo].[EVT_RelatedUsers](
			ApplicationID,
			EventID,
			UserID,
			[Status],
			Done,
			Deleted
		)
		VALUES(
			@ApplicationID,
			@EventID,
			@CreatorUserID,
			N'Accept',
			0,
			0
		)
		
		IF @@ROWCOUNT <= 0 BEGIN
			SELECT -1
			ROLLBACK TRANSACTION
			RETURN
		END
	END
	
	IF @_UsersCount > 0 BEGIN
		INSERT INTO [dbo].[EVT_RelatedUsers](
			ApplicationID,
			EventID,
			UserID,
			[Status],
			Done,
			Deleted
		)
		SELECT @ApplicationID, @EventID, Ref.Value, N'Pending', 0, 0
		FROM @UserIDs AS Ref
		
		IF @@ROWCOUNT <= 0 BEGIN
			SELECT -1
			ROLLBACK TRANSACTION
			RETURN
		END
	END
	
	IF @_NodesCount > 0 BEGIN
		INSERT INTO [dbo].[EVT_RelatedNodes](
			ApplicationID,
			EventID,
			NodeID,
			Deleted
		)
		SELECT @ApplicationID, @EventID, Ref.Value, 0
		FROM @NodeIDs AS Ref
		
		IF @@ROWCOUNT <= 0 BEGIN
			SELECT -1
			ROLLBACK TRANSACTION
			RETURN
		END
	END
	
	SELECT (1 + @_NodesCount + @_UsersCount)
COMMIT TRANSACTION

GO



IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[EVT_ArithmeticDeleteEvent]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[EVT_ArithmeticDeleteEvent]
GO

CREATE PROCEDURE [dbo].[EVT_ArithmeticDeleteEvent]
	@ApplicationID	uniqueidentifier,
	@EventID		uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[EVT_Events]
		SET [Deleted] = 1
	WHERE ApplicationID = @ApplicationID AND EventID = @EventID
	
	SELECT @@ROWCOUNT
END

GO



IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[EVT_P_GetEventsByIDs]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[EVT_P_GetEventsByIDs]
GO

CREATE PROCEDURE [dbo].[EVT_P_GetEventsByIDs]
	@ApplicationID	uniqueidentifier,
	@EventIDsTemp	GuidTableType readonly,
	@Full			bit
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @EventIDs GuidTableType
	INSERT INTO @EventIDs SELECT * FROM @EventIDsTemp
	
	IF @Full IS NULL OR @Full = 0 BEGIN
		SELECT E.[EventID] AS EventID,
			   E.[Title] AS Title
		FROM @EventIDs AS ExternalIDs
			INNER JOIN [dbo].[EVT_Events] AS E
			ON E.ApplicationID = @ApplicationID AND E.[EventID] = ExternalIDs.Value
	END
	ELSE BEGIN
		SELECT E.[EventID] AS EventID,
			   E.[EventType] AS EventType,
			   E.[Title] AS Title,
			   E.[Description] AS [Description],
			   E.[BeginDate] AS BeginDate,
			   E.[FinishDate] AS FinishDate,
			   E.[CreatorUserID] AS CreatorUserID
		FROM @EventIDs AS ExternalIDs
			INNER JOIN [dbo].[EVT_Events] AS E
			ON E.ApplicationID = @ApplicationID AND E.[EventID] = ExternalIDs.Value
	END
END

GO



IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[EVT_GetEventsByIDs]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[EVT_GetEventsByIDs]
GO

CREATE PROCEDURE [dbo].[EVT_GetEventsByIDs]
	@ApplicationID	uniqueidentifier,
	@strEventIDs	varchar(8000),
	@delimiter		char,
	@Full			bit
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @EventIDs GuidTableType
	INSERT INTO @EventIDs 
	SELECT DISTINCT Ref.Value FROM GFN_StrToGuidTable(@strEventIDs, @delimiter) AS Ref
	
	EXEC [dbo].[EVT_P_GetEventsByIDs] @ApplicationID, @EventIDs, @Full
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[EVT_GetUserFinishedEventsCount]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[EVT_GetUserFinishedEventsCount]
GO

CREATE PROCEDURE [dbo].[EVT_GetUserFinishedEventsCount]
	@ApplicationID	uniqueidentifier,
	@UserID			uniqueidentifier,
	@CurrentDate	datetime,
	@Done			bit
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT COUNT(EV.[EventID])
	FROM [dbo].[EVT_RelatedUsers] AS RU
		INNER JOIN [dbo].[EVT_Events] AS EV
		ON EV.ApplicationID = @ApplicationID AND EV.[EventID] = RU.[EventID]
	WHERE RU.ApplicationID = @ApplicationID AND 
		RU.[UserID] = @UserID AND EV.[FinishDate] <= @CurrentDate AND
		(@Done IS NULL OR RU.[Done] = @Done) AND EV.[Deleted] = 0 AND RU.[Deleted] = 0
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[EVT_GetUserFinishedEvents]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[EVT_GetUserFinishedEvents]
GO

CREATE PROCEDURE [dbo].[EVT_GetUserFinishedEvents]
	@ApplicationID	uniqueidentifier,
	@UserID			uniqueidentifier,
	@CurrentDate	datetime,
	@Done			bit
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @EventIDs GuidTableType
	
	INSERT INTO @EventIDs
	SELECT E.[EventID]
	FROM [dbo].[EVT_RelatedUsers] AS RU
		INNER JOIN [dbo].[EVT_Events] AS E
		ON E.ApplicationID = @ApplicationID AND
			RU.[EventID] = E.[EventID]
	WHERE RU.ApplicationID = @ApplicationID AND 
		RU.[UserID] = @UserID AND E.[FinishDate] <= @CurrentDate AND
		(@Done IS NULL OR RU.[Done] = @Done) AND E.[Deleted] = 0 AND RU.[Deleted] = 0
		
	EXEC [dbo].[EVT_P_GetEventsByIDs] @ApplicationID, @EventIDs, 0
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[EVT_GetRelatedUserIDs]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[EVT_GetRelatedUserIDs]
GO

CREATE PROCEDURE [dbo].[EVT_GetRelatedUserIDs]
	@ApplicationID	uniqueidentifier,
	@EventID		uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT RU.[UserID]
	FROM [dbo].[EVT_RelatedUsers] AS RU
	WHERE RU.ApplicationID = @ApplicationID AND 
		RU.[EventID] = @EventID AND RU.[Deleted] = 0
END

GO



IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[EVT_GetRelatedUsers]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[EVT_GetRelatedUsers]
GO

CREATE PROCEDURE [dbo].[EVT_GetRelatedUsers]
	@ApplicationID	uniqueidentifier,
	@EventID		uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT RU.[UserID] AS UserID,
		   RU.[EventID] AS EventID,
		   RU.[Status] AS Status,
		   RU.[Done] AS Done,
		   RU.[RealFinishDate] AS RealFinishDate,
		   UN.[UserName] AS UserName,
		   UN.[FirstName] AS FirstName,
		   UN.[LastName] AS LastName
	FROM [dbo].[EVT_RelatedUsers] AS RU
		INNER JOIN [dbo].[Users_Normal] AS UN 
		ON UN.ApplicationID = @ApplicationID AND UN.[UserID] = RU.[UserID]
	WHERE RU.ApplicationID = @ApplicationID AND
		RU.[EventID] = @EventID AND RU.[Deleted] = 0 AND UN.[IsApproved] = 1
END

GO



IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[EVT_ArithmeticDeleteRelatedUser]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[EVT_ArithmeticDeleteRelatedUser]
GO

CREATE PROCEDURE [dbo].[EVT_ArithmeticDeleteRelatedUser]
	@ApplicationID	uniqueidentifier,
	@EventID		uniqueidentifier,
	@UserID			uniqueidentifier
WITH ENCRYPTION
AS
BEGIN TRANSACTION
	SET NOCOUNT ON
	
	DECLARE @_IsOwn bit
	
	SET @_IsOwn = (
			SELECT CAST(1 AS bit) 
			FROM [dbo].[EVT_Events]
			WHERE ApplicationID = @ApplicationID AND 
				[EventID] = @EventID AND [CreatorUserID] = @UserID
		)
			
	IF @_IsOwn IS NULL SET @_IsOwn = 0
	
	UPDATE [dbo].[EVT_RelatedUsers]
		SET [Deleted] = 1
	WHERE ApplicationID = @ApplicationID AND EventID = @EventID AND UserID = @UserID
	
	IF @@ROWCOUNT <= 0 BEGIN
		SELECT -1
		ROLLBACK TRANSACTION
		RETURN
	END
	
	IF @_IsOwn = 1 BEGIN
		UPDATE [dbo].[EVT_Events]
			SET Deleted = 1
		WHERE ApplicationID = @ApplicationID AND [EventID] = @EventID
		
		IF @@ROWCOUNT <= 0 BEGIN
			SELECT -1
			ROLLBACK TRANSACTION
			RETURN
		END
		
		SELECT 2 /* 2: the event is deleted */
	END
	ELSE SELECT 1 /* 1: only the user has been deleted */
COMMIT TRANSACTION

GO



IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[EVT_ChangeUserStatus]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[EVT_ChangeUserStatus]
GO

CREATE PROCEDURE [dbo].[EVT_ChangeUserStatus]
	@ApplicationID	uniqueidentifier,
	@EventID		uniqueidentifier,
	@UserID			uniqueidentifier,
	@NewStatus		varchar(20)
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[EVT_RelatedUsers]
		SET Status = @NewStatus
	WHERE ApplicationID = @ApplicationID AND EventID = @EventID AND UserID = @UserID
	
	SELECT @@ROWCOUNT
END

GO



IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[EVT_GetRelatedNodeIDs]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[EVT_GetRelatedNodeIDs]
GO

CREATE PROCEDURE [dbo].[EVT_GetRelatedNodeIDs]
	@ApplicationID			uniqueidentifier,
	@EventID				uniqueidentifier,
	@NodeTypeAdditionalID	varchar(20)
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT ND.[NodeID] AS ID
	FROM [dbo].[EVT_RelatedNodes] AS RN
		INNER JOIN [dbo].[CN_View_Nodes_Normal] AS ND
		ON ND.ApplicationID = @ApplicationID AND ND.[NodeID] = RN.[NodeID]
	WHERE RN.ApplicationID = @ApplicationID AND RN.[EventID] = @EventID AND 
		(@NodeTypeAdditionalID IS NULL OR  ND.[TypeAdditionalID] = @NodeTypeAdditionalID) AND
		RN.[Deleted] = 0 AND ND.[Deleted] = 0
END

GO



IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[EVT_GetNodeRelatedEvents]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[EVT_GetNodeRelatedEvents]
GO

CREATE PROCEDURE [dbo].[EVT_GetNodeRelatedEvents]
	@ApplicationID	uniqueidentifier,
	@NodeID			uniqueidentifier,
	@CurrentDate	datetime,
	@NotFinished	bit
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @EventIDs GuidTableType
	
	INSERT INTO @EventIDs
	SELECT E.[EventID]
	FROM [dbo].[EVT_RelatedNodes] AS RN
		INNER JOIN [dbo].[EVT_Events] AS E
		ON E.ApplicationID = @ApplicationID AND E.[EventID] = RN.[EventID]
	WHERE RN.ApplicationID = @ApplicationID AND RN.[NodeID] = @NodeID AND 
		(@CurrentDate IS NULL OR E.[BeginDate] >= @CurrentDate) AND
		(@NotFinished IS NULL OR @NotFinished = 0 OR 
		E.[BeginDate] <= @CurrentDate) AND E.[Deleted] = 0 AND RN.[Deleted] = 0
		
	EXEC [dbo].[EVT_P_GetEventsByIDs] @ApplicationID, @EventIDs, 0
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[EVT_GetUserRelatedEvents]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[EVT_GetUserRelatedEvents]
GO

CREATE PROCEDURE [dbo].[EVT_GetUserRelatedEvents]
	@ApplicationID	uniqueidentifier,
	@UserID			uniqueidentifier,
	@CurrentDate	datetime,
	@NotFinished	bit,
	@Status			varchar(20),
	@NodeID			uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT EV.[EventID] AS EventID,
		   RU.UserID AS UserID,
		   EV.[EventType] AS EventType,
		   EV.[Title] AS Title,
		   EV.[Description] AS [Description],
		   EV.[BeginDate] AS BeginDate,
		   EV.[FinishDate] AS FinishDate,
		   EV.[CreatorUserID] AS CreatorUserID,
		   RU.[Status] AS [Status],
		   RU.Done AS Done,
		   RU.RealFinishDate AS RealFinishDate
	FROM [dbo].[EVT_RelatedUsers] AS RU 
		INNER JOIN [dbo].[EVT_Events] AS EV 
		ON EV.ApplicationID = @ApplicationID AND EV.[EventID] = RU.[EventID]
	WHERE RU.ApplicationID = @ApplicationID AND RU.[UserID] = @UserID AND 
		(@CurrentDate IS NULL OR EV.[BeginDate] >= @CurrentDate) AND
		(@NotFinished IS NULL OR @NotFinished = 0 OR EV.[BeginDate] <= @CurrentDate) AND
		(@Status IS NULL OR RU.[Status] = @Status) AND
		EV.[Deleted] = 0 AND RU.Deleted = 0 AND
		(@NodeID IS NULL OR (
			EXISTS(
					SELECT TOP(1) * 
					FROM [dbo].[EVT_RelatedNodes] AS RN2
						INNER JOIN [dbo].[EVT_Events] AS E2
						ON E2.EventID = RN2.[EventID]
					WHERE RN2.ApplicationID = @ApplicationID AND RN2.[NodeID] = @NodeID
				)
			)
		)
END

GO

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[SRCH_GetIndexQueueItems]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[SRCH_GetIndexQueueItems]
GO

CREATE PROCEDURE [dbo].[SRCH_GetIndexQueueItems]
	@ApplicationID	uniqueidentifier,
    @Count			int,
	@ItemType		varchar(20)
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	IF @Count IS NULL SET @Count = 10
	IF @ItemType IS NULL SET @ItemType = N'Node'

	IF @ItemType = N'Node' BEGIN
		SELECT TOP(@Count) 
			ND.NodeID AS ID,
			CASE
				WHEN ND.Deleted = 1 OR ISNULL(ND.Searchable, 1) = 0 OR ISNULL(S.NoContent, 0) = 1 
					THEN CAST(1 AS bit)
				ELSE CAST(0 AS bit)
			END AS Deleted,
			CASE
				WHEN ND.Deleted = 1 OR ISNULL(ND.Searchable, 1) = 0 OR ISNULL(S.NoContent, 0) = 1 THEN NULL
				ELSE ND.NodeTypeID
			END AS TypeID,
			CASE
				WHEN ND.Deleted = 1 OR ISNULL(ND.Searchable, 1) = 0 OR ISNULL(S.NoContent, 0) = 1 THEN NULL
				ELSE ND.TypeName
			END AS [Type],
			CASE
				WHEN ND.Deleted = 1 OR ISNULL(ND.Searchable, 1) = 0 OR ISNULL(S.NoContent, 0) = 1 THEN NULL
				ELSE ND.NodeAdditionalID
			END AS AdditionalID,
			CASE
				WHEN ND.Deleted = 1 OR ISNULL(ND.Searchable, 1) = 0 OR ISNULL(S.NoContent, 0) = 1 THEN NULL
				ELSE ND.NodeName
			END AS Title,
			CASE
				WHEN ND.Deleted = 1 OR ISNULL(ND.Searchable, 1) = 0 OR ISNULL(S.NoContent, 0) = 1 THEN NULL
				ELSE ND.[Description]
			END AS [Description],
			CASE
				WHEN ND.Deleted = 1 OR ISNULL(ND.Searchable, 1) = 0 OR ISNULL(S.NoContent, 0) = 1 THEN NULL
				ELSE REPLACE(ND.Tags, N'~', N' ')
			END AS Tags,
			CASE
				WHEN ND.Deleted = 1 OR ISNULL(ND.Searchable, 1) = 0 OR ISNULL(S.NoContent, 0) = 1 THEN NULL
				ELSE ISNULL([dbo].[WK_FN_GetWikiContent](@ApplicationID, ND.NodeID), N'') +  N' ' +
					ISNULL([dbo].[FG_FN_GetOwnerFormContents](@ApplicationID, ND.NodeID, 3), N'')
			END AS Content,
			CASE
				WHEN ND.Deleted = 1 OR ISNULL(ND.Searchable, 1) = 0 OR ISNULL(S.NoContent, 0) = 1 THEN NULL
				ELSE [dbo].[CN_FN_GetNodeFileContents](@ApplicationID, ND.NodeID)
			END AS FileContent
		FROM [dbo].[CN_View_Nodes_Normal] AS ND
			LEFT JOIN [dbo].[CN_Services] AS S
			ON S.ApplicationID = @ApplicationID AND S.NodeTypeID = ND.NodeTypeID AND S.Deleted = 0
		WHERE ND.ApplicationID = @ApplicationID
		ORDER BY ISNULL(ND.IndexLastUpdateDate, N'1977-01-01 00:00:00.000')
	END
	ELSE IF @ItemType = N'NodeType' BEGIN
		SELECT TOP(@Count) 
			NT.NodeTypeID AS ID,
			CASE
				WHEN NT.Deleted = 1 OR ISNULL(S.NoContent, 0) = 1 THEN CAST(1 AS bit)
				ELSE CAST(0 AS bit)
			END AS Deleted,
			CASE
				WHEN NT.Deleted = 1 OR ISNULL(S.NoContent, 0) = 1 THEN NULL
				ELSE NT.Name
			END AS Title,
			CASE
				WHEN NT.Deleted = 1 OR ISNULL(S.NoContent, 0) = 1 THEN NULL
				ELSE NT.[Description]
			END AS [Description]
		FROM [dbo].[CN_NodeTypes] AS NT
			LEFT JOIN [dbo].[CN_Services] AS S
			ON S.ApplicationID = @ApplicationID AND S.NodeTypeID = NT.NodeTypeID AND S.Deleted = 0
		WHERE NT.ApplicationID = @ApplicationID
		ORDER BY ISNULL(NT.IndexLastUpdateDate, N'1977-01-01 00:00:00.000')
	END
	ELSE IF @ItemType = N'Question' BEGIN
		SELECT TOP(@Count) 
			QA.QuestionID AS ID,
			QA.Deleted AS Deleted,
			CASE
				WHEN QA.Deleted = 1 THEN NULL
				ELSE QA.[Title]
			END AS Title,
			CASE
				WHEN QA.Deleted = 1 THEN NULL
				ELSE QA.[Description]
			END AS [Description],
			CASE
				WHEN QA.Deleted = 1 THEN NULL
				ELSE [dbo].[QA_FN_GetQuestionContent](@ApplicationID, QA.QuestionID)
			END AS Content
		FROM [dbo].[QA_Questions] AS QA
		WHERE QA.ApplicationID = @ApplicationID
		ORDER BY ISNULL(QA.IndexLastUpdateDate, N'1977-01-01 00:00:00.000')
	END
	ELSE IF @ItemType = N'File' BEGIN
		;WITH X (ID, OwnerID, [Type], Title, FileContent)
		AS
		(
			SELECT TOP(@Count) 
				FC.FileID AS ID,
				AF.OwnerID,
				AF.Extension AS [Type],
				AF.[FileName] AS Title,
				FC.Content AS [FileContent]
			FROM [dbo].[DCT_FileContents] AS FC
				INNER JOIN (
					SELECT DISTINCT OwnerID, FileNameGuid, [FileName], Extension
					FROM [dbo].[DCT_Files] AS AF
					WHERE AF.ApplicationID = @ApplicationID
				) AS AF
				ON AF.FileNameGuid = FC.FileID
			WHERE FC.ApplicationID = @ApplicationID AND 
				FC.NotExtractable = 0 AND FC.FileNotFound = 0
			ORDER BY ISNULL(FC.IndexLastUpdateDate, N'1977-01-01 00:00:00.000')
		)
		(
			SELECT	X.ID,
					CAST(B.Deleted AS bit) AS Deleted,
					CASE WHEN B.Deleted = 1 THEN NULL ELSE X.[Type] END AS [Type],
					CASE WHEN B.Deleted = 1 THEN NULL ELSE X.Title END AS Title,
					CASE WHEN B.Deleted = 1 THEN NULL ELSE X.FileContent END AS FileContent
			FROM X
				LEFT JOIN (
					SELECT A.ID, MAX(A.[Type]) AS [Type], MAX(A.Title) AS Title, 
						MAX(A.FileContent) AS FileContent, MIN(A.Deleted) AS Deleted
					FROM (
							SELECT X.ID, X.[Type], X.Title, X.FileContent, ND.Deleted
							FROM X
								INNER JOIN [dbo].[CN_Nodes] AS ND
								ON ND.ApplicationID = @ApplicationID AND ND.NodeID = X.OwnerID
								
							UNION ALL
							
							SELECT X.ID, X.[Type], X.Title, X.FileContent,
								(CASE WHEN E.Deleted = 1 OR I.Deleted = 1 OR ND.Deleted = 1 THEN 1 ELSE 0 END)
							FROM X
								INNER JOIN [dbo].[FG_InstanceElements] AS E
								ON E.ApplicationID = @ApplicationID AND E.ElementID = X.OwnerID
								INNER JOIN [dbo].[FG_FormInstances] AS I
								ON I.ApplicationID = @ApplicationID AND I.InstanceID = E.InstanceID
								INNER JOIN [dbo].[CN_Nodes] AS ND
								ON ND.ApplicationID = @ApplicationID AND ND.NodeID = I.OwnerID
						) A
					GROUP BY A.ID
				) AS B
				ON B.ID = X.ID
		)
	END
	ELSE IF @ItemType = N'User' BEGIN
		SELECT TOP(@Count) 
			UN.UserID AS ID,
			CASE
				WHEN UN.IsApproved = 1 THEN CAST(0 AS bit)
				ELSE CAST(1 AS bit)
			END AS [Deleted],
			UN.UserName AS AdditionalID,
			ISNULL(UN.FirstName, N'') + N' ' + ISNULL(UN.LastName, N'') AS Title
		FROM [dbo].[Users_Normal] AS UN
		WHERE UN.ApplicationID = @ApplicationID
		ORDER BY ISNULL(UN.IndexLastUpdateDate, N'1977-01-01 00:00:00.000')
	END
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[SRCH_SetIndexLastUpdateDate]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[SRCH_SetIndexLastUpdateDate]
GO

CREATE PROCEDURE [dbo].[SRCH_SetIndexLastUpdateDate]
	@ApplicationID	uniqueidentifier,
	@ItemType		varchar(20),
	@strIDs			varchar(max),
	@delimiter		char,
	@Date			datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @IDs GuidTableType
	INSERT INTO @IDs
	SELECT DISTINCT * FROM [dbo].[GFN_StrToGuidTable](@strIDs, @delimiter)
	
	IF @ItemType = N'Node' BEGIN
		UPDATE Ref
			SET IndexLastUpdateDate = @Date
		FROM @IDs AS IDs
			INNER JOIN [dbo].[CN_Nodes] AS Ref
			ON Ref.ApplicationID = @ApplicationID AND Ref.NodeID = IDs.Value
	END
	ELSE IF @ItemType = N'NodeType' BEGIN
		UPDATE Ref
			SET IndexLastUpdateDate = @Date
		FROM @IDs AS IDs
			INNER JOIN [dbo].[CN_NodeTypes] AS Ref
			ON Ref.ApplicationID = @ApplicationID AND Ref.NodeTypeID = IDs.Value
	END
	ELSE IF @ItemType = N'Question' BEGIN
		UPDATE Ref
			SET IndexLastUpdateDate = @Date
		FROM @IDs AS IDs
			INNER JOIN [dbo].[QA_Questions] AS Ref
			ON Ref.ApplicationID = @ApplicationID AND Ref.QuestionID = IDs.Value
	END
	ELSE IF @ItemType = N'File' BEGIN
		UPDATE Ref
			SET IndexLastUpdateDate = @Date
		FROM @IDs AS IDs
			INNER JOIN [dbo].[DCT_FileContents] AS Ref
			ON Ref.ApplicationID = @ApplicationID AND Ref.FileID = IDs.Value
	END
	ELSE IF @ItemType = N'User' BEGIN
		UPDATE Ref
			SET IndexLastUpdateDate = @Date
		FROM @IDs AS IDs
			INNER JOIN [dbo].[USR_Profile] AS Ref
			ON Ref.UserID = IDs.Value
	END
	
	SELECT @@ROWCOUNT
END

GO




SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WK_P_SendDashboards]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WK_P_SendDashboards]
GO

CREATE PROCEDURE [dbo].[WK_P_SendDashboards]
	@ApplicationID		uniqueidentifier,
	@RefItemID			uniqueidentifier,
	@NodeID				uniqueidentifier,
	@AdminUserIDsTemp	GuidTableType readonly,
	@SendDate			datetime,
	@_Result			int output
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @AdminUserIDs GuidTableType
	INSERT INTO @AdminUserIDs SELECT * FROM @AdminUserIDsTemp
	
	IF (SELECT COUNT(*) FROM @AdminUserIDs) = 0 BEGIN
		SET @_Result = 1
		RETURN
	END
	
	DECLARE @UIDs TABLE(UserID uniqueidentifier primary key clustered, [Exists] bit)
	
	INSERT INTO @UIDs (UserID, [Exists])
	SELECT A.Value, MAX(CASE WHEN D.ID IS NULL THEN 0 ELSE 1 END)
	FROM @AdminUserIDs AS A
		LEFT JOIN [dbo].[NTFN_Dashboards] AS D
		ON D.ApplicationID = @ApplicationID AND D.UserID = A.Value AND 
			D.NodeID = @NodeID AND D.[Type] = N'Wiki' AND D.Deleted = 0 AND D.Done = 0
	GROUP BY A.Value
		
	IF EXISTS(SELECT TOP(1) * FROM @UIDs WHERE [Exists] = 1) BEGIN
		UPDATE [dbo].[NTFN_Dashboards]
			SET Seen = 0
		FROM @UIDs AS UIDs
			INNER JOIN [dbo].[NTFN_Dashboards] AS D
			ON D.UserID = UIDs.UserID
		WHERE D.ApplicationID = @ApplicationID AND UIDS.[Exists] = 1 AND 
			D.NodeID = @NodeID AND D.[Type] = N'Wiki' AND D.Done = 0 AND D.Deleted = 0
			
		SET @_Result = @@ROWCOUNT
		IF @_Result <= 0 RETURN
	END
	
	IF EXISTS(SELECT TOP(1) * FROM @UIDs WHERE [Exists] = 0) BEGIN
		DECLARE @Dashboards DashboardTableType
		
		INSERT INTO @Dashboards(UserID, NodeID, RefItemID, [Type], Removable, SendDate)
		SELECT	UIDs.UserID, @NodeID, @RefItemID, N'Wiki', 1, @SendDate
		FROM @UIDs AS UIDs
		WHERE UIDs.[Exists] = 0
		
		EXEC [dbo].[NTFN_P_SendDashboards] @ApplicationID, @Dashboards, @_Result output
		
		IF @_Result <= 0 RETURN
		
		IF @_Result > 0 BEGIN
			SELECT * 
			FROM @Dashboards
		END
	END
	
	SET @_Result = 1
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WK_SetTitlesOrder]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WK_SetTitlesOrder]
GO

CREATE PROCEDURE [dbo].[WK_SetTitlesOrder]
	@ApplicationID	uniqueidentifier,
	@strTitleIDs	varchar(max),
	@delimiter		char
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @TitleIDs TABLE (SequenceNo int identity(1, 1) primary key, TitleID uniqueidentifier)
	
	INSERT INTO @TitleIDs (TitleID)
	SELECT Ref.Value
	FROM [dbo].[GFN_StrToGuidTable](@strTitleIDs, @delimiter) AS Ref
	
	DECLARE @OwnerID uniqueidentifier
	
	SELECT @OwnerID = OwnerID
	FROM [dbo].[WK_Titles]
	WHERE ApplicationID = @ApplicationID AND 
		TitleID = (SELECT TOP (1) Ref.TitleID FROM @TitleIDs AS Ref)
	
	IF @OwnerID IS NULL BEGIN
		SELECT -1
		RETURN
	END
	
	INSERT INTO @TitleIDs (TitleID)
	SELECT TT.TitleID
	FROM @TitleIDs AS Ref
		RIGHT JOIN [dbo].[WK_Titles] AS TT
		ON TT.TitleID = Ref.TitleID
	WHERE TT.ApplicationID = @ApplicationID AND TT.OwnerID = @OwnerID AND Ref.TitleID IS NULL
	ORDER BY TT.SequenceNo
	
	UPDATE [dbo].[WK_Titles]
		SET SequenceNo = Ref.SequenceNo
	FROM @TitleIDs AS Ref
		INNER JOIN [dbo].[WK_Titles] AS TT
		ON TT.TitleID = Ref.TitleID
	WHERE TT.ApplicationID = @ApplicationID AND TT.OwnerID = @OwnerID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WK_SetParagraphsOrder]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WK_SetParagraphsOrder]
GO

CREATE PROCEDURE [dbo].[WK_SetParagraphsOrder]
	@ApplicationID		uniqueidentifier,
	@strParagraphIDs	varchar(max),
	@delimiter			char
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @ParagraphIDs TABLE (SequenceNo int identity(1, 1) primary key, ParagraphID uniqueidentifier)
	
	INSERT INTO @ParagraphIDs (ParagraphID)
	SELECT Ref.Value
	FROM [dbo].[GFN_StrToGuidTable](@strParagraphIDs, @delimiter) AS Ref
	
	DECLARE @TitleID uniqueidentifier
	
	SELECT @TitleID = TitleID
	FROM [dbo].[WK_Paragraphs]
	WHERE ApplicationID = @ApplicationID AND 
		ParagraphID = (SELECT TOP (1) Ref.ParagraphID FROM @ParagraphIDs AS Ref)
	
	IF @TitleID IS NULL BEGIN
		SELECT -1
		RETURN
	END
	
	INSERT INTO @ParagraphIDs(ParagraphID)
	SELECT P.ParagraphID
	FROM @ParagraphIDs AS Ref
		RIGHT JOIN [dbo].[WK_Paragraphs] AS P
		ON P.ParagraphID = Ref.ParagraphID
	WHERE P.ApplicationID = @ApplicationID AND P.TitleID = @TitleID AND Ref.ParagraphID IS NULL
	ORDER BY P.SequenceNo
	
	UPDATE [dbo].[WK_Paragraphs]
		SET SequenceNo = Ref.SequenceNo
	FROM @ParagraphIDs AS Ref
		INNER JOIN [dbo].[WK_Paragraphs] AS P
		ON P.ParagraphID = Ref.ParagraphID
	WHERE P.ApplicationID = @ApplicationID AND P.TitleID = @TitleID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WK_P_AddTitle]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WK_P_AddTitle]
GO

CREATE PROCEDURE [dbo].[WK_P_AddTitle]
	@ApplicationID		uniqueidentifier,
    @TitleID	 		uniqueidentifier,
    @OwnerID			uniqueidentifier,
    @Title				nvarchar(500),
    @SequenceNo			int,
    @CreatorUserID		uniqueidentifier,
    @CreationDate		datetime,
    @OwnerType			varchar(20),
    @Accept				bit,
    @_Result			int output
WITH ENCRYPTION
AS
BEGIN TRANSACTION
	SET NOCOUNT ON
	
	SET @Title = [dbo].[GFN_VerifyString](LTRIM(RTRIM(@Title)))
	
	IF ISNULL(@Title, N'') = N'' BEGIN
		SET @_Result = -1
		ROLLBACK TRANSACTION
		RETURN
	END
	
	DECLARE @Status varchar(20)
	
	IF @Accept = 1 SET @Status = N'Accepted'
	ELSE SET @Status = N'CitationNeeded'
	
	-- Update All Sequence Numbers
	UPDATE TT
		SET SequenceNo = Ref.SequenceNo
	FROM (
			SELECT	T.TitleID,
					((ROW_NUMBER() OVER (ORDER BY T.Deleted ASC, T.SequenceNo ASC)) * 2) AS SequenceNo
			FROM [dbo].[WK_Titles] AS T
			WHERE T.ApplicationID = @ApplicationID AND T.OwnerID = @OwnerID
		) AS Ref
		INNER JOIN [dbo].[WK_Titles] AS TT
		ON TT.ApplicationID = @ApplicationID AND TT.TitleID = Ref.TitleID
		
	IF ISNULL(@SequenceNo, 0) <= 0 SET @SequenceNo = 1
	
	SET @SequenceNo = (@SequenceNo * 2) - 1
	-- end of Update All Sequence Numbers
	
	INSERT INTO [dbo].[WK_Titles](
		ApplicationID,
		TitleID,
		OwnerID,
		CreatorUserID,
		CreationDate,
		SequenceNo,
		Title,
		[Status],
		OwnerType,
		Deleted
	)
	VALUES(
		@ApplicationID,
		@TitleID,
		@OwnerID,
		@CreatorUserID,
		@CreationDate,
		@SequenceNo,
		@Title,
		@Status,
		@OwnerType,
		0
	)
	
	SET @_Result = 1
COMMIT TRANSACTION

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WK_AddTitle]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WK_AddTitle]
GO

CREATE PROCEDURE [dbo].[WK_AddTitle]
	@ApplicationID		uniqueidentifier,
    @TitleID	 		uniqueidentifier,
    @OwnerID			uniqueidentifier,
    @Title				nvarchar(500),
    @SequenceNo			int,
    @CreatorUserID		uniqueidentifier,
    @CreationDate		datetime,
    @OwnerType			varchar(20),
    @Accept				bit
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @_Result int = -1
	
	EXEC [dbo].[WK_P_AddTitle] @ApplicationID, @TitleID, @OwnerID, @Title, 
		@SequenceNo, @CreatorUserID, @CreationDate, @OwnerType, @Accept, @_Result output
	
	SELECT @_Result
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WK_ModifyTitle]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WK_ModifyTitle]
GO

CREATE PROCEDURE [dbo].[WK_ModifyTitle]
	@ApplicationID			uniqueidentifier,
    @TitleID 				uniqueidentifier,
    @Title					nvarchar(500),
    @LastModifierUserID		uniqueidentifier,
    @LastModificationDate	datetime,
    @Accept					bit
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SET @Title = [dbo].[GFN_VerifyString](LTRIM(RTRIM(@Title)))
	
	IF ISNULL(@Title, N'') = N'' BEGIN
		SELECT -1
		RETURN
	END
	
	DECLARE @Status varchar(20)
	
	IF @Accept = 1 SET @Status = N'Accepted'
	ELSE SET @Status = N'CitationNeeded'
	
	UPDATE [dbo].[WK_Titles]
		SET Title = @Title,
			LastModifierUserID = @LastModifierUserID,
			LastModificationDate = @LastModificationDate,
			[Status] = @Status
	WHERE ApplicationID = @ApplicationID AND TitleID = @TitleID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WK_ArithmeticDeleteTitle]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WK_ArithmeticDeleteTitle]
GO

CREATE PROCEDURE [dbo].[WK_ArithmeticDeleteTitle]
	@ApplicationID			uniqueidentifier,
	@TitleID				uniqueidentifier,
	@LastModifierUserID		uniqueidentifier,
	@LastModificationDate	datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[WK_Titles]
		SET [Deleted] = 1,
			LastModifierUserID = @LastModifierUserID,
			LastModificationDate = @LastModificationDate
	WHERE ApplicationID = @ApplicationID AND TitleID = @TitleID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WK_RecycleTitle]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WK_RecycleTitle]
GO

CREATE PROCEDURE [dbo].[WK_RecycleTitle]
	@ApplicationID			uniqueidentifier,
	@TitleID				uniqueidentifier,
	@LastModifierUserID		uniqueidentifier,
	@LastModificationDate	datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[WK_Titles]
		SET [Deleted] = 0,
			LastModifierUserID = @LastModifierUserID,
			LastModificationDate = @LastModificationDate
	WHERE ApplicationID = @ApplicationID AND TitleID = @TitleID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WK_P_AddParagraph]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WK_P_AddParagraph]
GO

CREATE PROCEDURE [dbo].[WK_P_AddParagraph]
	@ApplicationID		uniqueidentifier,
    @ParagraphID 		uniqueidentifier,
    @TitleID	 		uniqueidentifier,
    @Title				nvarchar(500),
    @BodyText			nvarchar(max),
    @SequenceNo			int,
    @CreatorUserID		uniqueidentifier,
    @CreationDate		datetime,
    @IsRichText			bit,
    @SendToAdmins		bit,
    @HasAdmin			bit,
    @_Result			int output
WITH ENCRYPTION
AS
BEGIN TRANSACTION
	SET NOCOUNT ON
	
	SET @Title = [dbo].[GFN_VerifyString](@Title)
	SET @BodyText = [dbo].[GFN_VerifyString](@BodyText)
	
	IF @HasAdmin IS NULL SET @HasAdmin = 0
	
	DECLARE @Status varchar(20)
	
	IF @SendToAdmins IS NULL OR @SendToAdmins = 0 SET @Status = N'Accepted'
	ELSE IF @HasAdmin = 0 SET @Status = N'CitationNeeded'
	ELSE SET @Status = N'Pending'
	
	-- Update All Sequence Numbers
	UPDATE P
		SET SequenceNo = Ref.SequenceNo
	FROM (
			SELECT	P.ParagraphID,
					((ROW_NUMBER() OVER (ORDER BY P.Deleted ASC, P.SequenceNo ASC)) * 2) AS SequenceNo
			FROM [dbo].[WK_Paragraphs] AS P
			WHERE P.ApplicationID = @ApplicationID AND P.TitleID = @TitleID
		) AS Ref
		INNER JOIN [dbo].[WK_Paragraphs] AS P
		ON P.ApplicationID = @ApplicationID AND P.ParagraphID = Ref.ParagraphID
		
	IF ISNULL(@SequenceNo, 0) <= 0 SET @SequenceNo = 1
	
	SET @SequenceNo = (@SequenceNo * 2) - 1
	-- end of Update All Sequence Numbers
	
	INSERT INTO [dbo].[WK_Paragraphs](
		ApplicationID,
		ParagraphID,
		TitleID,
		CreatorUserID,
		CreationDate,
		Title,
		BodyText,
		SequenceNo,
		IsRichText,
		[Status],
		Deleted
	)
	VALUES(
		@ApplicationID,
		@ParagraphID,
		@TitleID,
		@CreatorUserID,
		@CreationDate,
		@Title,
		@BodyText,
		@SequenceNo,
		@IsRichText,
		@Status,
		0
	)
	
	IF @@ROWCOUNT <= 0 BEGIN
		SET @_Result = -1
		RETURN
	END
	
	DECLARE @_ChangeID uniqueidentifier = NEWID()
	
	INSERT INTO [dbo].[WK_Changes](
		ApplicationID,
		ChangeID,
		ParagraphID,
		UserID,
		SendDate,
		Title,
		BodyText,
		Applied,
		[Status],
		Deleted
	)
	VALUES(
		@ApplicationID,
		@_ChangeID,
		@ParagraphID,
		@CreatorUserID,
		@CreationDate,
		@Title,
		@BodyText,
		(CASE WHEN @Status = N'CitationNeeded' OR @Status = N'Accepted' THEN 1 ELSE 0 END),
		(CASE WHEN @Status = N'CitationNeeded' OR @Status = N'Accepted' THEN N'Accepted' ELSE N'Pending' END),
		0
	)
	
	IF @@ROWCOUNT <= 0 BEGIN
		SET @_Result = -1
		RETURN
	END
	
	SET @_Result = 1
COMMIT TRANSACTION

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WK_AddParagraph]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WK_AddParagraph]
GO

CREATE PROCEDURE [dbo].[WK_AddParagraph]
	@ApplicationID		uniqueidentifier,
    @ParagraphID 		uniqueidentifier,
    @TitleID	 		uniqueidentifier,
    @Title				nvarchar(500),
    @BodyText			nvarchar(max),
    @SequenceNo			int,
    @CreatorUserID		uniqueidentifier,
    @CreationDate		datetime,
    @IsRichText			bit,
    @SendToAdmins		bit,
    @HasAdmin			bit,
    @AdminUserIDsTemp	GuidTableType readonly
WITH ENCRYPTION, RECOMPILE
AS
BEGIN TRANSACTION
	SET NOCOUNT ON
	
	DECLARE @AdminUserIDs GuidTableType
	INSERT INTO @AdminUserIDs SELECT * FROM @AdminUserIDsTemp
	
	DECLARE @_Result int = -1
	
	EXEC [dbo].[WK_P_AddParagraph] @ApplicationID, @ParagraphID, @TitleID, @Title, @BodyText,
		@SequenceNo, @CreatorUserID, @CreationDate, @IsRichText, @SendToAdmins, 
		@HasAdmin, @_Result output
	
	-- Send Dashboards
	DECLARE @UIDs GuidTableType
	
	INSERT INTO @UIDs
	SELECT Ref.Value
	FROM @AdminUserIDs AS Ref
	WHERE Ref.Value <> @CreatorUserID
	
	IF @SendToAdmins = 1 AND (SELECT COUNT(*) FROM @UIDs) > 0 BEGIN
		DECLARE @OwnerID uniqueidentifier = (
			SELECT TOP(1) OwnerID
			FROM [dbo].[WK_Titles]
			WHERE ApplicationID = @ApplicationID AND TitleID = @TitleID
		)
		
		EXEC [dbo].[WK_P_SendDashboards] @ApplicationID, @ParagraphID, @OwnerID, @UIDs, 
			@CreationDate, @_Result output
		
		IF @_Result <= 0 BEGIN
			SELECT -1
			ROLLBACK TRANSACTION 
			RETURN
		END
	END
	-- end of Send Dashboards
	
	SELECT 1
COMMIT TRANSACTION

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WK_ModifyParagraph]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WK_ModifyParagraph]
GO

CREATE PROCEDURE [dbo].[WK_ModifyParagraph]
	@ApplicationID			uniqueidentifier,
    @ParagraphID			uniqueidentifier,
    @ChangeID2Accept		uniqueidentifier,
    @Title					nvarchar(500),
    @BodyText				nvarchar(max),
    @LastModifierUserID		uniqueidentifier,
    @LastModificationDate	datetime,
    @CitationNeeded			bit,
    @Apply					bit,
    @Accept					bit,
    @HasAdmin				bit,
    @AdminUserIDsTemp		GuidTableType readonly
WITH ENCRYPTION, RECOMPILE
AS
BEGIN TRANSACTION
	SET NOCOUNT ON
	
	DECLARE @AdminUserIDs GuidTableType
	INSERT INTO @AdminUserIDs SELECT * FROM @AdminUserIDsTemp
	
	SET @Title = [dbo].[GFN_VerifyString](@Title)
	SET @BodyText = [dbo].[GFN_VerifyString](@BodyText)
	
	IF @HasAdmin IS NULL SET @HasAdmin = 0
	
	DECLARE @AcceptionDate datetime, @Applied bit, @ChangeStatus varchar(20)
	
	SET @AcceptionDate = NULL
	IF @Accept = 1 SET @AcceptionDate = @LastModificationDate
	
	SET @Applied = 0
	IF @Apply = 1 SET @Applied = 1
	
	SET @ChangeStatus = N'Pending'
	IF @Apply = 1 SET @ChangeStatus = N'Accepted'
	
	DECLARE @_ChangeID uniqueidentifier = (
		SELECT TOP(1) ChangeID 
		FROM [dbo].[WK_Changes]
		WHERE ApplicationID = @ApplicationID AND ParagraphID = @ParagraphID 
			AND UserID = @LastModifierUserID AND [Status] = N'Pending' AND Deleted = 0
	)
	
	IF @_ChangeID IS NOT NULL BEGIN	
		UPDATE [dbo].[WK_Changes]
			SET Title = @Title,
				BodyText = @BodyText,
				LastModificationDate = @LastModificationDate,
				[Status] = @ChangeStatus
		WHERE ApplicationID = @ApplicationID AND ChangeID = @_ChangeID
	END
	ELSE BEGIN
		SET @_ChangeID = NEWID()
	
		INSERT INTO [dbo].[WK_Changes](
			ApplicationID,
			ChangeID,
			ParagraphID,
			UserID,
			SendDate,
			Title,
			BodyText,
			Applied,
			ApplicationDate,
			[Status],
			AcceptionDate,
			Deleted
		)
		VALUES(
			@ApplicationID,
			@_ChangeID,
			@ParagraphID,
			@LastModifierUserID,
			@LastModificationDate,
			@Title,
			@BodyText,
			@Applied,
			@LastModificationDate,
			@ChangeStatus,
			@AcceptionDate,
			0
		)
	END
	
	IF @@ROWCOUNT <= 0 BEGIN
		SELECT -1
		ROLLBACK TRANSACTION
		RETURN
	END
	
	IF @Apply = 1 BEGIN
		DECLARE @_Result int
	
		IF @ChangeID2Accept IS NOT NULL BEGIN
			EXEC [dbo].[WK_P_AcceptChange] @ApplicationID, @ChangeID2Accept, 
				@LastModifierUserID, @LastModificationDate, @_Result output
				
			IF @_Result <= 0 BEGIN
				SELECT -1
				ROLLBACK TRANSACTION 
				RETURN
			END
		END
	
		DECLARE @SubjectStatus varchar(20)
		SET @SubjectStatus = N'Accepted'
		IF @CitationNeeded = 1 SET @SubjectStatus = N'CitationNeeded'
		
		UPDATE [dbo].[WK_Paragraphs]
			SET Title = @Title,
				BodyText = @BodyText,
				LastModifierUserID = @LastModifierUserID,
				LastModificationDate = @LastModificationDate,
				[Status] = @SubjectStatus
		WHERE ApplicationID = @ApplicationID AND ParagraphID = @ParagraphID
		
		IF @@ROWCOUNT <= 0 BEGIN
			SELECT -1
			ROLLBACK TRANSACTION
			RETURN
		END
	END
	
	-- Send Dashboards
	DECLARE @UIDs GuidTableType
	
	INSERT INTO @UIDs
	SELECT Ref.Value
	FROM @AdminUserIDs AS Ref
	WHERE Ref.Value <> @LastModifierUserID
	
	IF ISNULL(@Apply, 0) = 0 AND @HasAdmin = 1 AND (SELECT COUNT(*) FROM @UIDs) > 0 BEGIN
		DECLARE @OwnerID uniqueidentifier = (
			SELECT TOP(1) OwnerID
			FROM [dbo].[WK_Paragraphs] AS P
				INNER JOIN [dbo].[WK_Titles] AS T
				ON T.ApplicationID = @ApplicationID AND T.TitleID = P.TitleID
			WHERE P.ApplicationID = @ApplicationID AND P.ParagraphID = @ParagraphID
		)
		
		EXEC [dbo].[WK_P_SendDashboards] @ApplicationID, @ParagraphID, @OwnerID, @UIDs, 
			@LastModificationDate, @_Result output
		
		IF @_Result <= 0 BEGIN
			SET @_Result = -1
			ROLLBACK TRANSACTION 
			RETURN
		END
	END
	-- end of Send Dashboards
	
	SELECT 1
COMMIT TRANSACTION

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WK_ArithmeticDeleteParagraph]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WK_ArithmeticDeleteParagraph]
GO

CREATE PROCEDURE [dbo].[WK_ArithmeticDeleteParagraph]
	@ApplicationID			uniqueidentifier,
	@ParagraphID			uniqueidentifier,
	@LastModifierUserID		uniqueidentifier,
	@LastModificationDate	datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[WK_Paragraphs]
		SET [Deleted] = 1,
			LastModifierUserID = @LastModifierUserID,
			LastModificationDate = @LastModificationDate
	WHERE ApplicationID = @ApplicationID AND ParagraphID = @ParagraphID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WK_RecycleParagraph]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WK_RecycleParagraph]
GO

CREATE PROCEDURE [dbo].[WK_RecycleParagraph]
	@ApplicationID			uniqueidentifier,
	@ParagraphID			uniqueidentifier,
	@LastModifierUserID		uniqueidentifier,
	@LastModificationDate	datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[WK_Paragraphs]
		SET [Deleted] = 0,
			LastModifierUserID = @LastModifierUserID,
			LastModificationDate = @LastModificationDate
	WHERE ApplicationID = @ApplicationID AND ParagraphID = @ParagraphID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WK_P_AcceptChange]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WK_P_AcceptChange]
GO

CREATE PROCEDURE [dbo].[WK_P_AcceptChange]
	@ApplicationID		uniqueidentifier,
	@ChangeID			uniqueidentifier,
	@EvaluatorUserID	uniqueidentifier,
	@EvaluationDate		datetime,
	@_Result			int output
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[WK_Changes]
		SET [Status] = N'Accepted',
			[AcceptionDate] = @EvaluationDate,
			[EvaluatorUserID] = @EvaluatorUserID,
			[EvaluationDate] = @EvaluationDate
	WHERE ApplicationID = @ApplicationID AND ChangeID = @ChangeID
	
	SET @_Result = @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WK_AcceptChange]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WK_AcceptChange]
GO

CREATE PROCEDURE [dbo].[WK_AcceptChange]
	@ApplicationID		uniqueidentifier,
	@ChangeID			uniqueidentifier,
	@EvaluatorUserID	uniqueidentifier,
	@EvaluationDate		datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @_Result int
	
	EXEC [dbo].[WK_P_AcceptChange] @ApplicationID, @ChangeID, 
		@EvaluatorUserID, @EvaluationDate, @_Result output
	
	SELECT @_Result
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WK_RejectChange]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WK_RejectChange]
GO

CREATE PROCEDURE [dbo].[WK_RejectChange]
	@ApplicationID		uniqueidentifier,
	@ChangeID			uniqueidentifier,
	@EvaluatorUserID	uniqueidentifier,
	@EvaluationDate		datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[WK_Changes]
		SET [Status] = N'Rejected',
			[EvaluatorUserID] = @EvaluatorUserID,
			[EvaluationDate] = @EvaluationDate
	WHERE ApplicationID = @ApplicationID AND ChangeID = @ChangeID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WK_ArithmeticDeleteChange]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WK_ArithmeticDeleteChange]
GO

CREATE PROCEDURE [dbo].[WK_ArithmeticDeleteChange]
	@ApplicationID	uniqueidentifier,
	@ChangeID		uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[WK_Changes]
		SET [Deleted] = 1
	WHERE ApplicationID = @ApplicationID AND ChangeID = @ChangeID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WK_P_GetTitlesByIDs]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WK_P_GetTitlesByIDs]
GO

CREATE PROCEDURE [dbo].[WK_P_GetTitlesByIDs]
	@ApplicationID	uniqueidentifier,
	@TitleIDsTemp	GuidTableType readonly
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @TitleIDs GuidTableType
	INSERT INTO @TitleIDs SELECT * FROM @TitleIDsTemp
	
	SELECT TT.TitleID AS TitleID,
		   TT.OwnerID AS OwnerID,
		   TT.Title AS Title,
		   TT.SequenceNo AS SequenceNumber,
		   TT.CreatorUserID AS CreatorUserID,
		   TT.CreationDate AS CreationDate,
		   TT.LastModificationDate AS LastModificationDate,
		   TT.[Status] AS [Status]
	FROM @TitleIDs AS ExternalIDs
		INNER JOIN [dbo].[WK_Titles] AS TT
		ON TT.ApplicationID = @ApplicationID AND ExternalIDs.Value = TT.TitleID
	ORDER BY TT.SequenceNo
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WK_GetTitlesByIDs]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WK_GetTitlesByIDs]
GO

CREATE PROCEDURE [dbo].[WK_GetTitlesByIDs]
	@ApplicationID	uniqueidentifier,
	@strTitleIDs	varchar(max),
	@delimiter		char,
	@ViewerUserID	uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @TitleIDs GuidTableType
	INSERT INTO @TitleIDs
	SELECT DISTINCT Ref.Value FROM [dbo].[GFN_StrToGuidTable](@strTitleIDs, @delimiter) AS Ref
	
	EXEC [dbo].[WK_P_GetTitlesByIDs] @ApplicationID, @TitleIDs
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WK_GetTitles]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WK_GetTitles]
GO

CREATE PROCEDURE [dbo].[WK_GetTitles]
	@ApplicationID	uniqueidentifier,
	@OwnerID		uniqueidentifier,
	@IsAdmin		bit,
	@ViewerUserID	uniqueidentifier,
	@Deleted		bit
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	IF @IsAdmin IS NULL SET @IsAdmin = 0
	IF @Deleted IS NULL SET @Deleted = 0
	
	DECLARE @TitleIDs GuidTableType
	
	INSERT INTO @TitleIDs
	SELECT T.TitleID
	FROM [dbo].[WK_Titles] AS T
		LEFT JOIN [dbo].[WK_Paragraphs] AS P
		ON P.ApplicationID = @ApplicationID AND P.TitleID = T.TitleID AND (
			@IsAdmin = 1 OR P.[Status] = N'Accepted' OR P.[Status] = N'CitationNeeded' OR (
				P.[Status] = N'Pending' AND @ViewerUserID IS NOT NULL AND 
				P.CreatorUserID = @ViewerUserID
			)
		) AND P.Deleted = @Deleted
	WHERE T.ApplicationID = @ApplicationID AND T.OwnerID = @OwnerID AND (
			@IsAdmin = 1 OR T.[Status] = N'Accepted' OR (
				T.[Status] = N'CitationNeeded' AND @ViewerUserID IS NOT NULL AND 
				T.CreatorUserID = @ViewerUserID
			) OR P.ParagraphID IS NOT NULL
		) AND T.Deleted = @Deleted
	GROUP BY T.TitleID
	
	EXEC [dbo].[WK_P_GetTitlesByIDs] @ApplicationID, @TitleIDs
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WK_HasTitle]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WK_HasTitle]
GO

CREATE PROCEDURE [dbo].[WK_HasTitle]
	@ApplicationID		uniqueidentifier,
	@OwnerID			uniqueidentifier,
	@ViewerUserID		uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT TOP(1) 1
	FROM [dbo].[WK_Titles] AS T
	WHERE T.ApplicationID = @ApplicationID AND T.OwnerID = @OwnerID AND
		(@ViewerUserID IS NULL OR T.[Status] = N'Accepted' OR 
		T.[Status] = N'CitationNeeded' OR T.CreatorUserID = @ViewerUserID) AND T.Deleted = 0
	
	SELECT -1
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WK_P_GetParagraphsByIDs]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WK_P_GetParagraphsByIDs]
GO

CREATE PROCEDURE [dbo].[WK_P_GetParagraphsByIDs]
	@ApplicationID		uniqueidentifier,
	@ParagraphIDsTemp	GuidTableType readonly
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @ParagraphIDs GuidTableType
	INSERT INTO @ParagraphIDs SELECT * FROM @ParagraphIDsTemp
	
	SELECT PG.ParagraphID AS ParagraphID,
		   PG.TitleID AS TitleID,
		   PG.Title AS Title,
		   PG.BodyText AS BodyText,
		   PG.SequenceNo AS SequenceNumber,
		   PG.IsRichText AS IsRichText,
		   PG.CreatorUserID AS CreatorUserID,
		   PG.CreationDate AS CreationDate,
		   PG.LastModificationDate AS LastModificationDate,
		   PG.[Status] AS [Status]
	FROM @ParagraphIDs AS ExternalIDs
		INNER JOIN [dbo].[WK_Paragraphs] AS PG
		ON PG.ApplicationID = @ApplicationID AND PG.ParagraphID = ExternalIDs.Value
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WK_GetParagraphsByIDs]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WK_GetParagraphsByIDs]
GO

CREATE PROCEDURE [dbo].[WK_GetParagraphsByIDs]
	@ApplicationID		uniqueidentifier,
	@strParagraphIDs	varchar(max),
	@delimiter			char,
	@ViewerUserID		uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @ParagraphIDs GuidTableType
	INSERT INTO @ParagraphIDs
	SELECT DISTINCT Ref.Value 
	FROM [dbo].[GFN_StrToGuidTable](@strParagraphIDs, @delimiter) AS Ref
	
	EXEC [dbo].[WK_P_GetParagraphsByIDs] @ApplicationID, @ParagraphIDs
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WK_GetParagraphs]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WK_GetParagraphs]
GO

CREATE PROCEDURE [dbo].[WK_GetParagraphs]
	@ApplicationID		uniqueidentifier,
	@strTitleIDs		varchar(max),
	@delimiter			char,
	@IsAdmin			bit,
	@ViewerUserID		uniqueidentifier,
	@Deleted			bit
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	IF @IsAdmin IS NULL SET @IsAdmin = 0
	IF @Deleted IS NULL SET @Deleted = 0
	
	DECLARE @TitleIDs GuidTableType
	INSERT INTO @TitleIDs
	SELECT DISTINCT Ref.Value FROM [dbo].[GFN_StrToGuidTable](@strTitleIDs, @delimiter) AS Ref
	
	DECLARE @ParagraphIDs GuidTableType
	
	INSERT INTO @ParagraphIDs
	SELECT PG.ParagraphID
	FROM @TitleIDs AS ExternalIDs
		INNER JOIN [dbo].[WK_Paragraphs] AS PG
		ON PG.TitleID = ExternalIDs.Value
	WHERE PG.ApplicationID = @ApplicationID AND 
		(@IsAdmin = 1 OR PG.[Status] = N'Accepted' OR PG.[Status] = N'CitationNeeded' OR (
			PG.[Status] = N'Pending' AND @ViewerUserID IS NOT NULL AND 
			PG.CreatorUserID = @ViewerUserID
		)) AND PG.Deleted = @Deleted
		
	EXEC [dbo].[WK_P_GetParagraphsByIDs] @ApplicationID, @ParagraphIDs
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WK_HasParagraph]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WK_HasParagraph]
GO

CREATE PROCEDURE [dbo].[WK_HasParagraph]
	@ApplicationID		uniqueidentifier,
	@TitleOrOwnerID		uniqueidentifier,
	@ViewerUserID		uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	IF EXISTS(
		SELECT TOP (1) 1 
		FROM [dbo].[WK_Titles] 
		WHERE ApplicationID = @ApplicationID AND TitleID = @TitleOrOwnerID
	) BEGIN
		SELECT TOP(1) 1
		FROM [dbo].[WK_Paragraphs] AS P
		WHERE P.ApplicationID = @ApplicationID AND P.TitleID = @TitleOrOwnerID AND
			(@ViewerUserID IS NULL OR P.[Status] = N'Accepted' OR 
			P.[Status] = N'CitationNeeded' OR P.CreatorUserID = @ViewerUserID) AND P.Deleted = 0
	END
	ELSE BEGIN
		SELECT TOP(1) 1
		FROM [dbo].[WK_Titles] AS T
			INNER JOIN [dbo].[WK_Paragraphs] AS P
			ON P.ApplicationID = @ApplicationID AND P.TitleID = T.TitleID
		WHERE T.ApplicationID = @ApplicationID AND T.OwnerID = @TitleOrOwnerID AND
			(@ViewerUserID IS NULL OR P.[Status] = N'Accepted' OR 
			P.[Status] = N'CitationNeeded' OR P.CreatorUserID = @ViewerUserID) AND P.Deleted = 0
	END
	
	SELECT -1
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WK_P_GetChangesByIDs]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WK_P_GetChangesByIDs]
GO

CREATE PROCEDURE [dbo].[WK_P_GetChangesByIDs]
	@ApplicationID	uniqueidentifier,
	@ChangeIDsTemp	GuidTableType readonly
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @ChangeIDs GuidTableType
	INSERT INTO @ChangeIDs SELECT * FROM @ChangeIDsTemp
	
	SELECT C.[ChangeID] AS ChangeID,
		   C.[ParagraphID] AS ParagraphID,
		   C.[Title] AS Title,
		   C.[BodyText] AS BodyText,
		   C.[Status] AS [Status],
		   C.[Applied] AS Applied,
		   C.[SendDate] AS SendDate,
		   C.[UserID] AS SenderUserID,
		   UN.[UserName] AS SenderUserName,
		   UN.[FirstName] AS SenderFirstName,
		   UN.[LastName] AS SenderLastName
	FROM @ChangeIDs AS ExternalIDs
		INNER JOIN [dbo].[WK_Changes] AS C
		ON C.ApplicationID = @ApplicationID AND C.[ChangeID] = ExternalIDs.Value
		INNER JOIN [dbo].[Users_Normal] AS UN
		ON UN.ApplicationID = @ApplicationID AND UN.[UserID] = C.[UserID]
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WK_GetChangesByIDs]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WK_GetChangesByIDs]
GO

CREATE PROCEDURE [dbo].[WK_GetChangesByIDs]
	@ApplicationID	uniqueidentifier,
	@strChangeIDs	varchar(max),
	@delimiter		char
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @ChangeIDs GuidTableType
	INSERT INTO @ChangeIDs
	SELECT DISTINCT Ref.Value FROM GFN_StrToGuidTable(@strChangeIDs, @delimiter) AS Ref
	
	EXEC [dbo].[WK_P_GetChangesByIDs] @ApplicationID, @ChangeIDs
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WK_GetParagraphChanges]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WK_GetParagraphChanges]
GO

CREATE PROCEDURE [dbo].[WK_GetParagraphChanges]
	@ApplicationID		uniqueidentifier,
	@strParagraphIDs	varchar(max),
	@delimiter			char,
	@CreatorUserID		uniqueidentifier,
	@Status				varchar(20),
	@Applied			bit
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @ParagraphIDs GuidTableType
	INSERT INTO @ParagraphIDs
	SELECT DISTINCT Ref.Value 
	FROM [dbo].[GFN_StrToGuidTable](@strParagraphIDs, @delimiter) AS Ref
	
	DECLARE @ChangeIDs GuidTableType
	
	INSERT INTO @ChangeIDs
	SELECT DISTINCT CH.ChangeID
	FROM @ParagraphIDs AS ExternalIDs
		INNER JOIN [dbo].[WK_Changes] AS CH
		ON CH.ParagraphID = ExternalIDs.Value
	WHERE CH.ApplicationID = @ApplicationID AND 
		(@CreatorUserID IS NULL OR CH.UserID = @CreatorUserID) AND
		(@Status IS NULL OR CH.[Status] = @Status) AND
		(@Applied IS NULL OR CH.Applied = @Applied) AND CH.Deleted = 0
	
	EXEC [dbo].[WK_P_GetChangesByIDs] @ApplicationID, @ChangeIDs
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WK_GetLastPendingChange]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WK_GetLastPendingChange]
GO

CREATE PROCEDURE [dbo].[WK_GetLastPendingChange]
	@ApplicationID	uniqueidentifier,
	@ParagraphID	uniqueidentifier,
	@UserID			uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @ChangeIDs GuidTableType
	
	INSERT INTO @ChangeIDs
	SELECT ChangeID 
	FROM [dbo].[WK_Changes]
	WHERE ApplicationID = @ApplicationID AND ParagraphID = @ParagraphID AND 
		UserID = @UserID AND Deleted = 0 AND [Status] = N'Pending'
	
	EXEC [dbo].[WK_P_GetChangesByIDs] @ApplicationID, @ChangeIDs
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WK_GetParagraphRelatedUserIDs]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WK_GetParagraphRelatedUserIDs]
GO

CREATE PROCEDURE [dbo].[WK_GetParagraphRelatedUserIDs]
	@ApplicationID	uniqueidentifier,
	@ParagraphID	uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @UserIDs Table(id uniqueidentifier)
	
	DECLARE @CreatorID uniqueidentifier, @ModifierID uniqueidentifier
	
	SELECT @CreatorID = PH.CreatorUserID, @ModifierID = PH.LastModifierUserID
	FROM [dbo].[WK_Paragraphs] AS PH
	WHERE PH.ApplicationID = @ApplicationID AND PH.ParagraphID = @ParagraphID
	
	INSERT INTO @UserIDs (id) VALUES(@CreatorID)
	IF @ModifierID IS NOT NULL INSERT INTO @UserIDs (id) VALUES(@ModifierID)
	
	INSERT INTO @UserIDs
	SELECT DISTINCT CH.UserID AS ID
	FROM [dbo].[WK_Changes] AS CH
	WHERE CH.ApplicationID = @ApplicationID AND CH.ParagraphID = @ParagraphID AND 
		(CH.Applied = 1 OR CH.[Status] = N'Accepted')
		
	SELECT DISTINCT IDs.id AS ID
	FROM @UserIDs AS IDs
		INNER JOIN [dbo].[Users_Normal] AS USR
		ON IDs.id = USR.UserID
	WHERE USR.ApplicationID = @ApplicationID AND USR.IsApproved = 1
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WK_GetChangedWikiOwnerIDs]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WK_GetChangedWikiOwnerIDs]
GO

CREATE PROCEDURE [dbo].[WK_GetChangedWikiOwnerIDs]
	@ApplicationID	uniqueidentifier,
	@strOwnerIDs	varchar(max),
	@delimter		char
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @OwnerIDs GuidTableType
	INSERT INTO @OwnerIDs
	SELECT DISTINCT Ref.Value FROM [dbo].[GFN_StrToGuidTable](@strOwnerIDs, @delimter) AS Ref
	
	SELECT ExternalIDs.Value AS ID
	FROM @OwnerIDs AS ExternalIDs
	WHERE EXISTS(
			SELECT TOP(1) * 
			FROM [dbo].[WK_Titles] AS TT
				INNER JOIN [dbo].[WK_Paragraphs] AS PG
				ON PG.ApplicationID = @ApplicationID AND PG.TitleID = TT.TitleID
				INNER JOIN [dbo].[WK_Changes] AS CH
				ON CH.ApplicationID = @ApplicationID AND CH.ParagraphID = PG.ParagraphID
			WHERE TT.ApplicationID = @ApplicationID AND 
				TT.OwnerID = ExternalIDs.Value AND TT.Deleted = 0 AND 
				PG.Deleted = 0 AND CH.[Status] = N'Pending' AND CH.Deleted = 0
		)
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WK_P_CreateWiki]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WK_P_CreateWiki]
GO

CREATE PROCEDURE [dbo].[WK_P_CreateWiki]
	@ApplicationID	uniqueidentifier,
	@OwnerID		uniqueidentifier,
	@WikiTemp		StringPairTableType readonly,
	@HasAdmin		bit,
	@CreatorUserID	uniqueidentifier,
	@CreationDate	datetime,
	@_Result		int output
WITH ENCRYPTION, RECOMPILE
AS
BEGIN TRANSACTION
	SET NOCOUNT ON
	
	DECLARE @Wiki StringPairTableType
	INSERT INTO @Wiki SELECT * FROM @WikiTemp
	
	DECLARE @WikiTbl TABLE(SequenceNo int IDENTITY(1,1) PRIMARY KEY CLUSTERED,
		TitleID uniqueidentifier, Title nvarchar(500), 
		ParagraphID uniqueidentifier, Paragraph nvarchar(max))
	
	INSERT INTO @WikiTbl(
		TitleID,
		Title,
		ParagraphID,
		Paragraph
	)
	SELECT NEWID(), Ref.FirstValue, NEWID(), Ref.SecondValue
	FROM @Wiki AS Ref
	
	DECLARE @Count int = (SELECT COUNT(*) FROM @WikiTbl)
	DECLARE @Index int = 1
	
	WHILE @Index <= @Count BEGIN
		DECLARE @SequenceNo int, @TitleID uniqueidentifier, @Title nvarchar(500)
		
		SELECT @SequenceNo = Ref.SequenceNo, @TitleID = Ref.TitleID, @Title = Ref.Title
		FROM @WikiTbl AS Ref
		WHERE Ref.SequenceNo = @Index
			
		EXEC [dbo].[WK_P_AddTitle] @ApplicationID, @TitleID, @OwnerID, @Title, @SequenceNo, 
			@CreatorUserID, @CreationDate, 'Node', 1, @_Result output
			
		IF @_Result <= 0 BEGIN
			SET @_Result = -1
			ROLLBACK TRANSACTION
			RETURN
		END
		
		SET @Index = @Index + 1
	END
	
	SET @Index = 1
	
	WHILE @Index <= @Count BEGIN
		DECLARE @Att DocFileInfoTableType, @_TitleID uniqueidentifier, 
			@ParagraphID uniqueidentifier, @Paragraph nvarchar(max)
		
		SELECT @SequenceNo = Ref.SequenceNo, @_TitleID = Ref.TitleID,
			   @ParagraphID = Ref.ParagraphID, @Paragraph = Ref.Paragraph
		FROM @WikiTbl AS Ref
		WHERE Ref.SequenceNo = @Index
		
		IF @Paragraph IS NOT NULL AND @Paragraph <> N'' BEGIN
			EXEC [dbo].[WK_P_AddParagraph] @ApplicationID, @ParagraphID, @_TitleID, NULL, 
				@Paragraph, 1, @CreatorUserID, @CreationDate, 0, 0, @HasAdmin, @_Result output
				
			IF @_Result <= 0 BEGIN
				SET @_Result = -1
				ROLLBACK TRANSACTION
				RETURN
			END
		END
		
		SET @Index = @Index + 1
	END
COMMIT TRANSACTION

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WK_GetWikiOwner]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WK_GetWikiOwner]
GO

CREATE PROCEDURE [dbo].[WK_GetWikiOwner]
	@ApplicationID	uniqueidentifier,
	@ID				uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @OwnerID uniqueidentifier
	DECLARE @OwnerType varchar(20)
	
	SELECT @OwnerID = OwnerID, @OwnerType = OwnerType
	FROM [dbo].[WK_Titles]
	WHERE ApplicationID = @ApplicationID AND TitleID = @ID
	
	IF @OwnerID IS NULL BEGIN	
		SELECT @OwnerID = TT.OwnerID, @OwnerType = TT.OwnerType
		FROM [dbo].[WK_Titles] AS TT
			INNER JOIN [dbo].[WK_Paragraphs] AS P
			ON P.ApplicationID = @ApplicationID AND P.TitleID = TT.TitleID
		WHERE TT.ApplicationID = @ApplicationID AND P.ParagraphID = @ID
	END
	
	IF @OwnerID IS NULL BEGIN
		SELECT @OwnerID = TT.OwnerID, @OwnerType = TT.OwnerType
		FROM [dbo].[WK_Titles] AS TT
			INNER JOIN [dbo].[WK_Paragraphs] AS P
			ON P.ApplicationID = @ApplicationID AND P.TitleID = TT.TitleID
			INNER JOIN [dbo].[WK_Changes] AS CH
			ON CH.ApplicationID = @ApplicationID AND CH.ParagraphID = P.ParagraphID
		WHERE TT.ApplicationID = @ApplicationID AND CH.ChangeID = @ID
	END
	
	SELECT @OwnerID AS OwnerID, @OwnerType AS OwnerType
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WK_GetWikiContent]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WK_GetWikiContent]
GO

CREATE PROCEDURE [dbo].[WK_GetWikiContent]
	@ApplicationID	uniqueidentifier,
	@OwnerID		uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT [dbo].[WK_FN_GetWikiContent](@ApplicationID, @OwnerID)
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WK_GetTitlesCount]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WK_GetTitlesCount]
GO

CREATE PROCEDURE [dbo].[WK_GetTitlesCount]
	@ApplicationID	uniqueidentifier,
	@OwnerID		uniqueidentifier,
	@IsAdmin		bit,
	@CurrentUserID	uniqueidentifier,
	@Removed		bit
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT COUNT(TitleID)
	FROM [dbo].[WK_Titles] AS T
	WHERE T.ApplicationID = @ApplicationID AND 
		T.OwnerID = @OwnerID AND (@IsAdmin = 1 OR T.[Status] = N'Accepted' OR (
			T.[Status] = N'CitationNeeded' AND @CurrentUserID IS NOT NULL AND 
			T.CreatorUserID = @CurrentUserID
		)) AND (@Removed IS NULL OR T.Deleted = @Removed)
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WK_GetParagraphsCount]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WK_GetParagraphsCount]
GO

CREATE PROCEDURE [dbo].[WK_GetParagraphsCount]
	@ApplicationID	uniqueidentifier,
	@strTitleIDs	varchar(max),
	@delimiter		char,
	@IsAdmin		bit,
	@CurrentUserID	uniqueidentifier,
	@Removed		bit
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @TitleIDs GuidTableType
	
	INSERT INTO @TitleIDs (Value)
	SELECT Ref.Value
	FROM [dbo].[GFN_StrToGuidTable](@strTitleIDs, @delimiter) AS Ref
	
	SELECT T.Value AS ID, COUNT(P.ParagraphID) [Count]
	FROM @TitleIDs AS T
		LEFT JOIN [dbo].[WK_Paragraphs] AS P
		ON P.ApplicationID = @ApplicationID AND P.TitleID = T.Value
	WHERE (@IsAdmin = 1 OR P.[Status] = N'Accepted' OR P.[Status] = N'CitationNeeded' OR (
			P.[Status] = N'Pending' AND @CurrentUserID IS NOT NULL AND 
			P.CreatorUserID = @CurrentUserID
		)) AND (@Removed IS NULL OR P.Deleted = @Removed)
	GROUP BY T.Value
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WK_GetChangesCount]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WK_GetChangesCount]
GO

CREATE PROCEDURE [dbo].[WK_GetChangesCount]
	@ApplicationID		uniqueidentifier,
	@strParagraphIDs	varchar(max),
	@delimiter			char,
	@Applied			bit
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @ParagraphIDs GuidTableType
	
	INSERT INTO @ParagraphIDs(Value)
	SELECT Ref.Value
	FROM [dbo].[GFN_StrToGuidTable](@strParagraphIDs, @delimiter) AS Ref
	
	SELECT P.Value AS ID, COUNT(C.ChangeID) [Count]
	FROM @ParagraphIDs AS P
		LEFT JOIN [dbo].[WK_Changes] AS C
		ON C.ApplicationID = @ApplicationID AND C.ParagraphID = P.Value
	WHERE (C.[Status] = N'Accepted' OR C.[Status] = N'CitationNeeded') AND 
		(@Applied IS NULL OR C.Applied = @Applied) AND C.Deleted = 0
	GROUP BY P.Value
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WK_LastModificationDate]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WK_LastModificationDate]
GO

CREATE PROCEDURE [dbo].[WK_LastModificationDate]
	@ApplicationID		uniqueidentifier,
	@OwnerID			uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	-- Last Modification Date for both existing and deleted paragraphs & titles
	-- because delete is a sort of modification
	
	SELECT MAX(P.CreationDate)
	FROM [dbo].[WK_Titles] AS T
		INNER JOIN [dbo].[WK_Paragraphs] AS P
		ON P.ApplicationID = @ApplicationID AND P.TitleID = T.TitleID AND
			(P.[Status] = N'Accepted' OR P.[Status] = N'CitationNeeded')
	WHERE T.ApplicationID = @ApplicationID AND T.OwnerID = @OwnerID
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WK_WikiAuthors]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WK_WikiAuthors]
GO

CREATE PROCEDURE [dbo].[WK_WikiAuthors]
	@ApplicationID		uniqueidentifier,
	@OwnerID			uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT *
	FROM (
			SELECT C.UserID AS ID, COUNT(C.ChangeID) AS [Count]
			FROM [dbo].[WK_Titles] AS T
				INNER JOIN [dbo].[WK_Paragraphs] AS P
				ON P.ApplicationID = @ApplicationID AND P.TitleID = T.TitleID AND
					(P.[Status] = N'Accepted' OR P.[Status] = N'CitationNeeded')
				INNER JOIN [dbo].[WK_Changes] AS C
				ON C.ApplicationID = @ApplicationID AND 
					C.ParagraphID = P.ParagraphID AND C.Applied = 1 AND C.Deleted = 0
			WHERE T.ApplicationID = @ApplicationID AND T.OwnerID = @OwnerID AND T.Deleted = 0
			GROUP BY C.UserID
		) AS Ref
	ORDER BY Ref.[Count] DESC
END

GO

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[DE_UpdateNodes]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[DE_UpdateNodes]
GO

CREATE PROCEDURE [dbo].[DE_UpdateNodes]
	@ApplicationID			uniqueidentifier,
	@NodeTypeID				uniqueidentifier,
	@NodeTypeAdditionalID	varchar(50),
    @NodesTemp				ExchangeNodeTableType readonly,
    @CreatorUserID			uniqueidentifier,
    @CreationDate			datetime
WITH ENCRYPTION, RECOMPILE
AS
BEGIN TRANSACTION
	SET NOCOUNT ON
	
	DECLARE @Nodes ExchangeNodeTableType
	INSERT INTO @Nodes SELECT * FROM @NodesTemp
	
	IF @NodeTypeID IS NULL 
		SET @NodeTypeID = [dbo].[CN_FN_GetNodeTypeID](@ApplicationID, @NodeTypeAdditionalID)
	
	DECLARE @NotExisting ExchangeNodeTableType
	
	INSERT INTO @NotExisting
	SELECT * 
	FROM @Nodes AS ExternalNodes
	WHERE NOT((ExternalNodes.NodeID IS NULL OR ISNULL(ExternalNodes.NodeAdditionalID, N'') = N'') AND
		(ExternalNodes.Name IS NULL OR ExternalNodes.Name = N'')) AND
		NOT EXISTS(
			SELECT TOP(1) * 
			FROM [dbo].[CN_Nodes] AS ND
			WHERE ND.ApplicationID = @ApplicationID AND ND.NodeTypeID = @NodeTypeID AND 
				ExternalNodes.NodeAdditionalID IS NOT NULL AND ND.AdditionalID = ExternalNodes.NodeAdditionalID
		)
		
	DECLARE @_Count int
	SET @_Count = (SELECT COUNT(*) FROM @NotExisting)
	
	IF @_Count > 0 BEGIN
		INSERT INTO [dbo].[CN_Nodes](
			ApplicationID,
			NodeID,
			NodeTypeID,
			AdditionalID,
			Name,
			[Description],
			Tags,
			CreatorUserID,
			CreationDate,
			Deleted
		)
		SELECT @ApplicationID, ISNULL(NE.NodeID, NEWID()), @NodeTypeID, NE.NodeAdditionalID, 
			[dbo].[GFN_VerifyString](NE.Name), [dbo].[GFN_VerifyString](NE.Abstract), 
			[dbo].[GFN_VerifyString](NE.Tags), @CreatorUserID, @CreationDate, 0
		FROM @NotExisting AS NE
		
		IF @@ROWCOUNT <= 0 BEGIN
			SELECT -1
			ROLLBACK TRANSACTION
			RETURN
		END
	END
	
	IF EXISTS(
		SELECT TOP(1) * 
		FROM @Nodes 
		WHERE ISNULL(NodeAdditionalID, N'') <> N'' AND ISNULL(Name, N'') <> N''
	) BEGIN
		UPDATE ND
			SET Name = [dbo].[GFN_VerifyString](ExternalNodes.Name),
				Tags = ISNULL([dbo].[GFN_VerifyString](ExternalNodes.Tags), ND.Tags),
				[Description] = ISNULL([dbo].[GFN_VerifyString](ExternalNodes.Abstract), ND.[Description])
		FROM @Nodes AS ExternalNodes
			INNER JOIN [dbo].[CN_Nodes] AS ND
			ON ND.[AdditionalID] = ExternalNodes.NodeAdditionalID
		WHERE ND.ApplicationID = @ApplicationID AND 
			ISNULL(ExternalNodes.NodeAdditionalID, N'') <> N'' AND
			ND.[NodeTypeID] = @NodeTypeID AND ISNULL(ExternalNodes.Name, N'') <> N''
			
		IF @@ROWCOUNT <= 0 BEGIN
			SELECT -1
			ROLLBACK TRANSACTION
			RETURN
		END
	END
	
	-- Update Sequence Number
	UPDATE ND
		SET SequenceNumber = X.RowNum
	FROM (
			SELECT	ROW_NUMBER() OVER (ORDER BY (SELECT 1) ASC) AS RowNum,
					N.*
			FROM @Nodes AS N
		) AS X
		INNER JOIN [dbo].[CN_Nodes] AS ND
		ON ND.ApplicationID = @ApplicationID AND ND.NodeTypeID = @NodeTypeID AND
			ISNULL(ND.AdditionalID, N'') <> N'' AND ND.AdditionalID = X.NodeAdditionalID
	-- end of Update Sequence Number
	
	DECLARE @HaveParent ExchangeNodeTableType
	INSERT INTO @HaveParent(NodeAdditionalID, ParentAdditionalID)
	SELECT ND.NodeAdditionalID, ND.ParentAdditionalID
	FROM @Nodes AS ND
	WHERE ISNULL(ND.NodeAdditionalID, N'') <> N'' AND ISNULL(ND.ParentAdditionalID, N'') <> ''
	
	IF EXISTS(SELECT TOP(1) * FROM @HaveParent) BEGIN
		UPDATE ND
			SET ParentNodeID = OT.NodeID,
				LastModifierUserID = @CreatorUserID,
				LastModificationDate = @CreationDate
		FROM @HaveParent AS ExternalNodes
			INNER JOIN [dbo].[CN_Nodes] AS ND
			ON ND.[AdditionalID] = ExternalNodes.NodeAdditionalID
			INNER JOIN [dbo].[CN_Nodes] AS OT
			ON OT.AdditionalID = ExternalNodes.ParentAdditionalID
		WHERE ND.ApplicationID = @ApplicationID AND OT.ApplicationID = @ApplicationID AND
			ND.[NodeTypeID] = @NodeTypeID AND OT.NodeTypeID = @NodeTypeID
		
		IF @@ROWCOUNT <= 0 BEGIN
			SELECT -1
			ROLLBACK TRANSACTION
			RETURN
		END
	END
	
	DECLARE @HaveNotParent ExchangeNodeTableType
	INSERT INTO @HaveNotParent(NodeAdditionalID, ParentAdditionalID)
	SELECT ND.NodeAdditionalID, ND.ParentAdditionalID
	FROM @Nodes AS ND
	WHERE ISNULL(ND.NodeAdditionalID, N'') <> N'' AND ISNULL(ND.ParentAdditionalID, N'') = ''
	
	IF EXISTS(SELECT TOP(1) * FROM @HaveNotParent) BEGIN
		UPDATE ND
			SET ParentNodeID = NULL,
				LastModifierUserID = @CreatorUserID,
				LastModificationDate = @CreationDate
		FROM @HaveNotParent AS ExternalNodes
			INNER JOIN [dbo].[CN_Nodes] AS ND
			ON ND.[AdditionalID] = ExternalNodes.NodeAdditionalID
		WHERE ND.ApplicationID = @ApplicationID AND ND.[NodeTypeID] = @NodeTypeID
		
		IF @@ROWCOUNT <= 0 BEGIN
			SELECT -1
			ROLLBACK TRANSACTION
			RETURN
		END
	END
	
	SELECT 1
	
	SELECT N.NodeID AS ID
	FROM @NotExisting AS N
	WHERE N.NodeID IS NOT NULL
COMMIT TRANSACTION

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[DE_UpdateNodeIDs]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[DE_UpdateNodeIDs]
GO

CREATE PROCEDURE [dbo].[DE_UpdateNodeIDs]
	@ApplicationID	uniqueidentifier,
	@NodeTypeID		uniqueidentifier,
	@strNodeIDs		nvarchar(max),
	@innerDelimiter	char,
	@outerDelimiter	char,
    @CurrentUserID	uniqueidentifier,
    @Now			datetime
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @Values TABLE (NodeID uniqueidentifier, NewAdditionalID nvarchar(200))
	
	INSERT INTO @Values (NodeID, NewAdditionalID)
	SELECT DISTINCT ND.NodeID, Ref.SecondValue
	FROM [dbo].[GFN_StrToStringPairTable](@strNodeIDs, @innerDelimiter, @outerDelimiter) AS Ref
		INNER JOIN [dbo].[CN_Nodes] AS ND
		ON ND.ApplicationID = @ApplicationID AND 
			ND.NodeTypeID = @NodeTypeID AND ND.AdditionalID = Ref.FirstValue
	
	UPDATE ND
		SET AdditionalID = X.NewAdditionalID,
			LastModifierUserID = @CurrentUserID,
			LastModificationDate = @Now
	FROM (
			SELECT V.*
			FROM @Values AS V
				LEFT JOIN [dbo].[CN_Nodes] AS N
				ON N.ApplicationID = @ApplicationID AND N.NodeTypeID = @NodeTypeID AND
					N.AdditionalID = V.NewAdditionalID AND N.NodeID <> V.NodeID
			WHERE ISNULL(V.NewAdditionalID, N'') <> N'' AND N.NodeID IS NULL
		) AS X
		INNER JOIN [dbo].[CN_Nodes] AS ND
		ON ND.ApplicationId = @ApplicationID AND ND.NodeID = X.NodeID
		
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[DE_RemoveNodes]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[DE_RemoveNodes]
GO

CREATE PROCEDURE [dbo].[DE_RemoveNodes]
	@ApplicationID	uniqueidentifier,
	@strNodeIDs		nvarchar(max),
	@innerDelimiter	char,
	@outerDelimiter	char,
    @CurrentUserID	uniqueidentifier,
    @Now			datetime
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @NodeIDs GuidTableType
	
	INSERT INTO @NodeIDs(Value)
	SELECT DISTINCT ND.NodeID
	FROM [dbo].[GFN_StrToStringPairTable](@strNodeIDs, @innerDelimiter, @outerDelimiter) AS Ref
		INNER JOIN [dbo].[CN_View_Nodes_Normal] AS ND
		ON ND.ApplicationID = @ApplicationID AND 
			ND.TypeAdditionalID = Ref.FirstValue AND ND.NodeAdditionalID = Ref.SecondValue
	
	UPDATE ND
		SET Deleted = 1,
			LastModifierUserID = @CurrentUserID,
			LastModificationDate = @Now
	FROM @NodeIDs AS X
		INNER JOIN [dbo].[CN_Nodes] AS ND
		ON ND.ApplicationId = @ApplicationID AND ND.NodeID = X.Value
		
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[DE_UpdateUsers]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[DE_UpdateUsers]
GO

CREATE PROCEDURE [dbo].[DE_UpdateUsers]
	@ApplicationID	uniqueidentifier,
    @UsersTemp		ExchangeUserTableType readonly,
    @Now			datetime
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @Users ExchangeUserTableType
	INSERT INTO @Users SELECT * FROM @UsersTemp
	
	DECLARE @_Result int = 0
	
	DECLARE @TempUsers TABLE(ID int IDENTITY(1,1) PRIMARY KEY CLUSTERED, 
		UserID uniqueidentifier, NewUserName nvarchar(255),
		FirstName nvarchar(255), LastName nvarchar(255), EmploymentType varchar(50))
	
	INSERT INTO @TempUsers(
		UserID, NewUserName, FirstName, LastName, EmploymentType)
	SELECT USR.UserID, Ref.NewUserName, [dbo].[GFN_VerifyString](Ref.FirstName),
		[dbo].[GFN_VerifyString](Ref.LastName), Ref.EmploymentType
	FROM @Users AS Ref
		INNER JOIN [dbo].[aspnet_Users] AS USR
		ON USR.LoweredUserName = LOWER(Ref.UserName)
		INNER JOIN [dbo].[USR_UserApplications] AS App
		ON App.ApplicationID = @ApplicationID AND App.UserID = USR.UserID
	
	-- Create New Users
	DECLARE @NewUsers ExchangeUserTableType
	DECLARE @FirstPasswords GuidStringTableType
	
	INSERT INTO @NewUsers (UserID, UserName, FirstName, LastName, 
		[Password], PasswordSalt, EncryptedPassword)
	SELECT NEWID(), Ref.UserName, Ref.FirstName, Ref.LastName, 
		Ref.[Password], Ref.PasswordSalt, Ref.EncryptedPassword
	FROM @Users AS Ref
		LEFT JOIN [dbo].[Users_Normal] AS UN
		ON UN.ApplicationID = @ApplicationID AND LOWER(UN.UserName) = LOWER(Ref.UserName) AND
			ISNULL(Ref.NewUserName, N'') = N''
	WHERE ISNULL(Ref.[Password], N'') <> N'' AND ISNULL(Ref.PasswordSalt, N'') <> N'' AND
		ISNULL(Ref.EncryptedPassword, N'') <> N'' AND UN.UserID IS NULL
	
	INSERT INTO @FirstPasswords (FirstValue, SecondValue)
	SELECT U.UserID, U.EncryptedPassword
	FROM @NewUsers AS U
	
	DECLARE @_ErrorMessage nvarchar(255)
	
	EXEC [dbo].[USR_P_CreateUsers] @ApplicationID, @NewUsers, @Now, 
		@_Result output, @_ErrorMessage output
	
	EXEC [dbo].[USR_P_SavePasswordHistoryBulk] @FirstPasswords, 1, @Now, @_Result output
	-- end of Create New Users
	
	-- Reset passwords
	DECLARE @ChangePassUsers ExchangeUserTableType
	
	INSERT INTO @ChangePassUsers (UserID, [Password], PasswordSalt, EncryptedPassword)
	SELECT UN.UserID, Ref.[Password], Ref.PasswordSalt, Ref.EncryptedPassword
	FROM @Users AS Ref
		INNER JOIN [dbo].[Users_Normal] AS UN
		ON UN.ApplicationID = @ApplicationID AND LOWER(UN.UserName) = LOWER(Ref.UserName)
		LEFT JOIN @FirstPasswords AS F
		ON F.FirstValue = UN.UserID
	WHERE Ref.ResetPassword = 1 AND F.FirstValue IS NULL AND 
		ISNULL(Ref.[Password], N'') <> N'' AND ISNULL(Ref.PasswordSalt, N'') <> N''
	
	UPDATE M
		SET [Password] = C.[Password],
			PasswordSalt = C.PasswordSalt
	FROM @ChangePassUsers AS C
		INNER JOIN [dbo].[aspnet_Membership] AS M
		ON M.UserId = C.UserID
	
	DECLARE @ChangedPasswords GuidStringTableType
	
	INSERT INTO @ChangedPasswords(FirstValue, SecondValue)
	SELECT U.UserID, U.EncryptedPassword
	FROM @ChangePassUsers AS U
	
	EXEC [dbo].[USR_P_SavePasswordHistoryBulk] @ChangedPasswords , 1, @Now, @_Result output
	-- end of Reset passwords
	
	
	UPDATE P
		SET FirstName = Ref.FirstName
	FROM @TempUsers AS Ref
		INNER JOIN [dbo].[USR_Profile] AS P
		ON P.[UserID] = Ref.UserID
	WHERE ISNULL(Ref.FirstName, N'') <> N''
	
	UPDATE P
		SET LastName = Ref.LastName
	FROM @TempUsers AS Ref
		INNER JOIN [dbo].[USR_Profile] AS P
		ON P.[UserID] = Ref.UserID
	WHERE ISNULL(Ref.LastName, N'') <> N''
	
	UPDATE P
		SET EmploymentType = Ref.EmploymentType
	FROM @TempUsers AS Ref
		INNER JOIN [dbo].[USR_UserApplications] AS P
		ON P.ApplicationID = @ApplicationID AND P.[UserID] = Ref.UserID
	WHERE ISNULL(Ref.EmploymentType, N'') <> N''
	
	UPDATE USR
		SET UserName = X.NewUserName,
			LoweredUserName = LOWER(X.NewUserName)
	FROM (
			SELECT U.*
			FROM @TempUsers AS U
				LEFT JOIN [dbo].[Users_Normal] AS UN
				ON UN.ApplicationID = @ApplicationID AND 
					UN.LoweredUserName = LOWER(U.NewUserName) AND U.UserID <> UN.UserId
			WHERE ISNULL(U.NewUserName, N'') <> N'' AND UN.UserId IS NULL
		) AS X
		INNER JOIN [dbo].[aspnet_Users] AS USR
		ON USR.UserId = X.UserID
	
	SELECT 1
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[DE_UpdateMembers]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[DE_UpdateMembers]
GO

CREATE PROCEDURE [dbo].[DE_UpdateMembers]
	@ApplicationID	uniqueidentifier,
    @MembersTemp	ExchangeMemberTableType readonly,
    @Now			datetime
WITH ENCRYPTION, RECOMPILE
AS
BEGIN TRANSACTION
	SET NOCOUNT ON
	
	DECLARE @Members ExchangeMemberTableType
	INSERT INTO @Members SELECT * FROM @MembersTemp
	
	DECLARE @MBRS Table(
		NodeID uniqueidentifier,
		UserID uniqueidentifier,
		IsAdmin bit,
		UniqueAdmin bit
	)
	
	INSERT INTO @MBRS (NodeID, UserID, IsAdmin, UniqueAdmin)
	SELECT	ND.NodeID,
			UN.UserID,
			CAST(MAX(CAST(ISNULL(M.IsAdmin, 0) AS int)) AS bit),
			CAST(MAX(CAST(ISNULL(S.UniqueAdminMember, 0) AS int)) AS bit)
	FROM @Members AS M
		INNER JOIN [dbo].[CN_View_Nodes_Normal] AS ND
		ON ND.ApplicationID = @ApplicationID AND 
			(M.NodeID IS NULL AND ND.TypeAdditionalID = M.NodeTypeAdditionalID AND
			ND.NodeAdditionalID = M.NodeAdditionalID) OR
			(M.NodeID IS NOT NULL AND ND.NodeID = M.NodeID)
		LEFT JOIN [dbo].[CN_Services] AS S
		ON S.ApplicationID = @ApplicationID AND S.NodeTypeID = ND.NodeTypeID
		INNER JOIN [dbo].[Users_Normal] AS UN
		ON UN.ApplicationID = @ApplicationID AND LOWER(UN.UserName) = LOWER(M.UserName)
	GROUP BY ND.NodeID, UN.UserID
	
	DECLARE @_Result int
	
	-- Add members
	DECLARE @MIDs GuidPairTableType
	
	INSERT INTO @MIDs (FirstValue, SecondValue)
	SELECT NodeID, UserID FROM @MBRS
	
	EXEC [dbo].[CN_P_AddAcceptedMembers] @ApplicationID, @MIDs, @Now, @_Result output
	
	IF @_Result <= 0 BEGIN
		SELECT -1
		ROLLBACK TRANSACTION
		RETURN
	END
	--end of Add members
	
	--Update admins
	UPDATE NM
		SET IsAdmin = (
			CASE
				WHEN NIDs.UniqueAdmin = 0 THEN ISNULL(Ref.IsAdmin, NM.IsAdmin) 
				WHEN Ref.NodeID IS NULL
					THEN (CASE WHEN NIDs.AdminsCount = 0 THEN NM.IsAdmin ELSE 0 END)
				ELSE (CASE WHEN NIDs.AdminsCount <= 1 THEN Ref.IsAdmin ELSE 0 END)
			END
		)
	FROM (
			SELECT	X.NodeID, 
					CAST(MAX(CAST(X.UniqueAdmin AS int)) AS bit) AS UniqueAdmin, 
					SUM(CAST(X.IsAdmin AS int)) AS AdminsCount
			FROM @MBRS AS X
			GROUP BY X.NodeID
		) AS NIDs
		INNER JOIN [dbo].[CN_NodeMembers] AS NM
		ON NM.ApplicationID = @ApplicationID AND NM.NodeID = NIDs.NodeID AND NM.Deleted = 0
		LEFT JOIN @MBRS AS Ref
		ON Ref.NodeID = NM.NodeID AND Ref.UserID = NM.UserID
	--end of Update admins
	
	SELECT 1
COMMIT TRANSACTION

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[DE_UpdateExperts]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[DE_UpdateExperts]
GO

CREATE PROCEDURE [dbo].[DE_UpdateExperts]
	@ApplicationID	uniqueidentifier,
    @ExpertsTemp	ExchangeMemberTableType readonly,
    @Now			datetime
WITH ENCRYPTION, RECOMPILE
AS
BEGIN TRANSACTION
	SET NOCOUNT ON
	
	DECLARE @Experts ExchangeMemberTableType
	INSERT INTO @Experts SELECT * FROM @ExpertsTemp
	
	DECLARE @XPRTS Table(
		NodeID uniqueidentifier,
		UserID uniqueidentifier,
		[Exists] bit,
		AdditionalID varchar(50)
	)
	
	INSERT INTO @XPRTS (NodeID, UserID, AdditionalID)
	SELECT	ND.NodeID,
			UN.UserID,
			X.NodeAdditionalID
	FROM @Experts AS X
		INNER JOIN [dbo].[CN_View_Nodes_Normal] AS ND
		ON ND.ApplicationID = @ApplicationID AND 
			(X.NodeID IS NULL AND ND.TypeAdditionalID = X.NodeTypeAdditionalID AND
			ND.NodeAdditionalID = X.NodeAdditionalID) OR
			(X.NodeID IS NOT NULL AND ND.NodeID = X.NodeID)
		INNER JOIN [dbo].[Users_Normal] AS UN
		ON UN.ApplicationID = @ApplicationID AND LOWER(UN.UserName) = LOWER(X.UserName)
		
	UPDATE X
		SET [Exists] = 1
	FROM @XPRTS AS X
		INNER JOIN [dbo].[CN_Experts] AS EX
		ON EX.ApplicationID = @ApplicationID AND 
			EX.NodeID = X.NodeID AND EX.UserID = X.UserID
		
	DECLARE @Count int, @ExistingCount int
	
	SELECT	@Count = COUNT(X.NodeID),
			@ExistingCount = SUM(CAST((CASE WHEN X.[Exists] = 1 THEN 1 ELSE 0 END) AS int))
	FROM @XPRTS AS X
	
	IF @ExistingCount > 0 BEGIN
		UPDATE EX
			SET Approved = 1
		FROM @XPRTS AS X
			INNER JOIN [dbo].[CN_Experts] AS EX
			ON EX.NodeID = X.NodeID AND EX.UserID = X.UserID
		WHERE EX.ApplicationID = @ApplicationID AND X.[Exists] = 1
		
		IF @@ROWCOUNT <= 0 BEGIN
			SELECT -1
			ROLLBACK TRANSACTION
			RETURN
		END
	END
	
	IF (@Count - @ExistingCount) > 0 BEGIN
		INSERT INTO [dbo].[CN_Experts](
			ApplicationID,
			NodeID,
			UserID,
			Approved,
			ReferralsCount,
			ConfirmsPercentage,
			SocialApproved,
			UniqueID
		)
		SELECT	@ApplicationID,
				X.NodeID,
				X.UserID,
				1,
				0,
				0,
				0,
				NEWID()
		FROM @XPRTS AS X
		WHERE ISNULL(X.[Exists], 0) = 0
		
		IF @@ROWCOUNT <= 0 BEGIN
			SELECT -1
			ROLLBACK TRANSACTION
			RETURN
		END
	END
	
	SELECT 1
COMMIT TRANSACTION

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[DE_UpdateRelations]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[DE_UpdateRelations]
GO

CREATE PROCEDURE [dbo].[DE_UpdateRelations]
	@ApplicationID	uniqueidentifier,
	@CurrentUserID	uniqueidentifier,
    @RelationsTemp	ExchangeRelationTableType readonly,
    @Now			datetime
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @Relations ExchangeRelationTableType
	INSERT INTO @Relations SELECT * FROM @RelationsTemp
	
	DECLARE @RelationTypeID uniqueidentifier = 
		[dbo].[CN_FN_GetRelatedRelationTypeID](@ApplicationID)
	
	UPDATE NR
		SET LastModifierUserID = @CurrentUserID,
			LastModificationDate = @Now,
			Deleted = 0
	FROM (
			SELECT DISTINCT *
			FROM (
				SELECT	SourceTypeAdditionalID,
						SourceAdditionalID,
						DestinationTypeAdditionalID,
						DestinationAdditionalID
				FROM @Relations AS R
				
				UNION ALL
				
				SELECT	DestinationTypeAdditionalID,
						DestinationAdditionalID,
						SourceTypeAdditionalID,
						SourceAdditionalID
				FROM @Relations AS R
				WHERE R.Bidirectional = 1
			) AS X
		) AS R
		INNER JOIN [dbo].[CN_NodeTypes] AS SNT
		ON SNT.ApplicationID = @ApplicationID AND SNT.AdditionalID = R.SourceTypeAdditionalID
		INNER JOIN [dbo].[CN_Nodes] AS SND
		ON SND.ApplicationID = @ApplicationID AND SND.NodeTypeID = SNT.NodeTypeID AND
			SND.AdditionalID = R.SourceAdditionalID
		INNER JOIN [dbo].[CN_NodeTypes] AS DNT
		ON DNT.ApplicationID = @ApplicationID AND 
			DNT.AdditionalID = R.DestinationTypeAdditionalID
		INNER JOIN [dbo].[CN_Nodes] AS DND
		ON DND.ApplicationID = @ApplicationID AND DND.NodeTypeID = DNT.NodeTypeID AND
			DND.AdditionalID = R.DestinationAdditionalID
		INNER JOIN [dbo].[CN_NodeRelations] AS NR
		ON NR.ApplicationID = @ApplicationID AND NR.SourceNodeID = SND.NodeID AND
			NR.DestinationNodeID = DND.NodeID AND NR.PropertyID = @RelationTypeID
	
	DECLARE @CNT int = @@ROWCOUNT
	
	INSERT INTO [dbo].[CN_NodeRelations] (
		ApplicationID,
		SourceNodeID,
		DestinationNodeID,
		PropertyID,
		CreatorUserID,
		CreationDate,
		Deleted,
		UniqueID
	)
	SELECT	@ApplicationID, 
			SND.NodeID, 
			DND.NodeID, 
			@RelationTypeID, 
			@CurrentUserID, 
			@Now, 
			0, 
			NEWID()
	FROM (
			SELECT DISTINCT *
			FROM (
				SELECT	SourceTypeAdditionalID,
						SourceAdditionalID,
						DestinationTypeAdditionalID,
						DestinationAdditionalID
				FROM @Relations AS R
				
				UNION ALL
				
				SELECT	DestinationTypeAdditionalID,
						DestinationAdditionalID,
						SourceTypeAdditionalID,
						SourceAdditionalID
				FROM @Relations AS R
				WHERE R.Bidirectional = 1
			) AS X
		) AS R
		INNER JOIN [dbo].[CN_NodeTypes] AS SNT
		ON SNT.ApplicationID = @ApplicationID AND SNT.AdditionalID = R.SourceTypeAdditionalID
		INNER JOIN [dbo].[CN_Nodes] AS SND
		ON SND.ApplicationID = @ApplicationID AND SND.NodeTypeID = SNT.NodeTypeID AND
			SND.AdditionalID = R.SourceAdditionalID
		INNER JOIN [dbo].[CN_NodeTypes] AS DNT
		ON DNT.ApplicationID = @ApplicationID AND 
			DNT.AdditionalID = R.DestinationTypeAdditionalID
		INNER JOIN [dbo].[CN_Nodes] AS DND
		ON DND.ApplicationID = @ApplicationID AND DND.NodeTypeID = DNT.NodeTypeID AND
			DND.AdditionalID = R.DestinationAdditionalID
		LEFT JOIN [dbo].[CN_NodeRelations] AS NR
		ON NR.ApplicationID = @ApplicationID AND NR.SourceNodeID = SND.NodeID AND
			NR.DestinationNodeID = DND.NodeID AND NR.PropertyID = @RelationTypeID
	WHERE NR.SourceNodeID IS NULL
	
	SELECT @@ROWCOUNT + @CNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[DE_UpdateAuthors]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[DE_UpdateAuthors]
GO

CREATE PROCEDURE [dbo].[DE_UpdateAuthors]
	@ApplicationID	uniqueidentifier,
	@CurrentUserID	uniqueidentifier,
    @AuthorsTemp	ExchangeAuthorTableType readonly,
    @Now			datetime
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @Authors ExchangeAuthorTableType
	INSERT INTO @Authors SELECT * FROM @AuthorsTemp
	
	DECLARE @Shares TABLE (NodeID uniqueidentifier, UserID uniqueidentifier, Percentage int)
	
	INSERT INTO @Shares (NodeID, UserID, Percentage)
	SELECT ND.NodeID, UN.UserID, MAX(A.Percentage)
	FROM @Authors AS A
		INNER JOIN [dbo].[CN_View_Nodes_Normal] AS ND
		ON ND.ApplicationID = @ApplicationID AND ND.TypeAdditionalID = A.NodeTypeAdditionalID AND
			ND.NodeAdditionalID = A.NodeAdditionalID
		INNER JOIN [dbo].[Users_Normal] AS UN
		ON UN.ApplicationID = @ApplicationID AND 
			UN.UserName IS NOT NULL AND LOWER(UN.UserName) = LOWER(A.UserName)
	WHERE ISNULL(A.NodeTypeAdditionalID, N'') <> N'' AND ISNULL(A.NodeAdditionalID, N'') <> N'' AND 
		A.Percentage IS NOT NULL AND A.Percentage > 0 AND A.Percentage <= 100
	GROUP BY ND.NodeID, UN.UserID
	
	DELETE X
	FROM @Shares AS X
		INNER JOIN (
			SELECT S.NodeID, SUM(S.Percentage) AS Summation
			FROM @Shares AS S
			GROUP BY S.NodeID
		) AS Ref
		ON Ref.NodeID = X.NodeID
	WHERE Ref.Summation <> 100
	
	UPDATE NC
		SET Deleted = 1,
			LastModifierUserID = @CurrentUserID,
			LastModificationDate = @Now
	FROM (SELECT DISTINCT NodeID FROM @Shares) AS S
		INNER JOIN [dbo].[CN_NodeCreators] AS NC
		ON NC.ApplicationID = @ApplicationID AND NC.NodeID = S.NodeID
		
	UPDATE NC
		SET Deleted = 0,
			CollaborationShare = CAST(S.Percentage AS float),
			LastModifierUserID = @CurrentUserID,
			LastModificationDate = @Now
	FROM @Shares AS S
		INNER JOIN [dbo].[CN_NodeCreators] AS NC
		ON NC.ApplicationID = @ApplicationID AND NC.NodeID = S.NodeID AND NC.UserID = S.UserID
	
	DECLARE @CNT int = @@ROWCOUNT
	
	INSERT INTO [dbo].[CN_NodeCreators] (ApplicationID, NodeID, UserID, CollaborationShare,
		CreatorUserID, CreationDate, Deleted, UniqueID)
	SELECT	@ApplicationID, S.NodeID, S.UserID, CAST(S.Percentage AS float), 
			@CurrentUserID, @Now, 0, NEWID()
	FROM @Shares AS S
		LEFT JOIN [dbo].[CN_NodeCreators] AS NC
		ON NC.ApplicationID = @ApplicationID AND NC.NodeID = S.NodeID AND NC.UserID = S.UserID
	WHERE NC.NodeID IS NULL
	
	SELECT @@ROWCOUNT + @CNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[DE_UpdateUserConfidentialities]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[DE_UpdateUserConfidentialities]
GO

CREATE PROCEDURE [dbo].[DE_UpdateUserConfidentialities]
	@ApplicationID	uniqueidentifier,
	@CurrentUserID	uniqueidentifier,
    @strInput		varchar(max),
    @innerDelimiter	char,
    @outerDelimiter char,
    @Now			datetime
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @Values TABLE (UserID uniqueidentifier, ConfidentialityID uniqueidentifier)
	
	INSERT INTO @Values (UserID, ConfidentialityID)
	SELECT DISTINCT UN.UserID, L.ID
	FROM [dbo].[GFN_StrToFloatStringTable](@strInput, @innerDelimiter, @outerDelimiter) AS Ref
		INNER JOIN [dbo].[Users_Normal] AS UN
		ON UN.ApplicationID = @ApplicationID AND LOWER(UN.UserName) = LOWER(Ref.SecondValue)
		INNER JOIN [dbo].[PRVC_ConfidentialityLevels] AS L
		ON L.ApplicationID = @ApplicationID AND L.LevelID = CAST(Ref.FirstValue AS int)
		
	UPDATE S
		SET ConfidentialityID = V.ConfidentialityID,
			LastModifierUserID = @CurrentUserID,
			LastModificationDate = @Now
	FROM @Values AS V
		INNER JOIN [dbo].[PRVC_Settings] AS S
		ON S.ApplicationID = @ApplicationID AND S.ObjectID = V.UserID
	
	DECLARE @CNT int = @@ROWCOUNT
	
	INSERT INTO [dbo].[PRVC_Settings](
		ApplicationID,
		ObjectID,
		ConfidentialityID,
		CreatorUserID,
		CreationDate
	)
	SELECT @ApplicationID, V.UserID, V.ConfidentialityID, @CurrentUserID, @Now
	FROM @Values AS V
		LEFT JOIN [dbo].[PRVC_Settings] AS S
		ON S.ApplicationID = @ApplicationID AND S.ObjectID = V.UserID
	WHERE S.ObjectID IS NULL
	
	SELECT @@ROWCOUNT + @CNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[DE_UpdatePermissions]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[DE_UpdatePermissions]
GO

CREATE PROCEDURE [dbo].[DE_UpdatePermissions]
	@ApplicationID	uniqueidentifier,
	@CurrentUserID	uniqueidentifier,
    @ItemsTemp		ExchangePermissionTableType readonly,
    @Now			datetime
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @Items ExchangePermissionTableType
	INSERT INTO @Items SELECT * FROM @ItemsTemp
	
	DECLARE @Values TABLE (
		ObjectID uniqueidentifier, 
		RoleID uniqueidentifier, 
		PermissionType nvarchar(50), 
		Allow bit,
		DropAll bit
	)
	
	
	INSERT INTO @Values (ObjectID, RoleID, PermissionType, Allow, DropAll)
	SELECT DISTINCT ND.NodeID, ISNULL(UN.UserID, GRP.NodeID), I.PermissionType, I.Allow, I.DropAll
	FROM @Items AS I
		INNER JOIN [dbo].[CN_View_Nodes_Normal] AS ND
		ON ND.ApplicationID = @ApplicationID AND ND.TypeAdditionalID = I.NodeTypeAdditionalID AND
			ND.NodeAdditionalID = I.NodeAdditionalID
		LEFT JOIN [dbo].[CN_View_Nodes_Normal] AS GRP
		ON GRP.ApplicationID = @ApplicationID AND GRP.TypeAdditionalID = I.GroupTypeAdditionalID AND
			GRP.NodeAdditionalID = I.GroupAdditionalID
		LEFT JOIN [dbo].[Users_Normal] AS UN
		ON UN.ApplicationID = @ApplicationID AND LOWER(UN.UserName) = LOWER(I.UserName)
	WHERE ((GRP.NodeID IS NOT NULL OR UN.UserID IS NOT NULL) AND I.PermissionType IS NOT NULL) OR I.DropAll = 1
	
	
	-- Part 1: Drop All
	UPDATE A
		SET Deleted = 1,
			LastModifierUserID = @CurrentUserID,
			LastModificationDate = @Now
	FROM [dbo].[PRVC_Audience] AS A
		INNER JOIN (
			SELECT DISTINCT V.ObjectID
			FROM @Values AS V
			WHERE V.DropAll = 1
		) AS Ref
		ON Ref.ObjectID = A.ObjectID
	WHERE A.ApplicationID = @ApplicationID
	-- end of Part 1: Drop All
	
	DECLARE @CNT int = @@ROWCOUNT
	
	-- Part 2: Update Existing Items
	UPDATE A
		SET Allow = ISNULL(V.Allow, 0),
			ExpirationDate = NULL,
			Deleted = 0,
			LastModifierUserID = @CurrentUserID,
			LastModificationDate = @Now
	FROM @Values AS V
		INNER JOIN [dbo].[PRVC_Audience] AS A
		ON A.ApplicationID = @ApplicationID AND A.ObjectID = V.ObjectID AND 
			A.RoleID = V.RoleID AND A.PermissionType = V.PermissionType
	-- end of Part 2: Update Existing Items
	
	SET @CNT = @@ROWCOUNT + @CNT
	
	-- Part 3: Add New Items
	INSERT INTO [dbo].[PRVC_Audience](
		ApplicationID,
		ObjectID,
		RoleID,
		PermissionType,
		Allow,
		CreatorUserID,
		CreationDate,
		Deleted
	)
	SELECT @ApplicationID, V.ObjectID, V.RoleID, V.PermissionType, ISNULL(V.Allow, 0), @CurrentUserID, @Now, 0	
	FROM @Values AS V
		LEFT JOIN [dbo].[PRVC_Audience] AS A
		ON A.ApplicationID = @ApplicationID AND A.ObjectID = V.ObjectID AND 
			A.RoleID = V.RoleID AND A.PermissionType = V.PermissionType
	WHERE V.ObjectID IS NOT NULL AND V.RoleID IS NOT NULL AND 
		V.PermissionType IS NOT NULL AND A.ObjectID IS NULL
	-- end of Part 3: Add New Items
	
	SELECT @@ROWCOUNT + @CNT
END

GO

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[PRVC_InitializeConfidentialityLevels]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[PRVC_InitializeConfidentialityLevels]
GO

CREATE PROCEDURE [dbo].[PRVC_InitializeConfidentialityLevels]
	@ApplicationID		uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @UserID uniqueidentifier = (
		SELECT TOP(1) UserID 
		FROM [dbo].[Users_Normal]
		WHERE ApplicationId = @ApplicationID AND LoweredUserName = N'admin'
	)
	
	IF @UserID IS NULL BEGIN
		SELECT TOP(1) @UserID = A.CreatorUserID
		FROM [dbo].[aspnet_Applications] AS A
		WHERE A.ApplicationId = @ApplicationID
	END
	
	IF @UserID IS NULL RETURN 1
	
	DECLARE @Now datetime = GETDATE()
	
	DECLARE @TBL Table(LevelID int, Title nvarchar(100))
	
	INSERT INTO @TBL (LevelID, Title)
	VALUES	(1,	N'  '),
			(2,	N''),
			(3,	N' '),
			(4,	N''),
			(5,	N'  ')
	
	IF NOT EXISTS(
		SELECT TOP(1) *
		FROM [dbo].[PRVC_ConfidentialityLevels] AS L
		WHERE L.ApplicationID = @ApplicationID
	) BEGIN
		INSERT INTO [dbo].[PRVC_ConfidentialityLevels] (ApplicationID, ID, LevelID, Title, 
			CreatorUserID, CreationDate, Deleted)
		SELECT @ApplicationID, NEWID(), T.LevelID, T.Title, @UserID, @Now, 0
		FROM @TBL AS T
	END
    
    RETURN 1
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[PRVC_RefineAccessRoles]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[PRVC_RefineAccessRoles]
GO

CREATE PROCEDURE [dbo].[PRVC_RefineAccessRoles]
	@ApplicationID		uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
    DECLARE @TBL Table(ID int identity(1,1) primary key clustered, 
	OldValue varchar(1000), NewValue varchar(1000), Title nvarchar(1000), UQID uniqueidentifier)

	INSERT INTO @TBL (OldValue, NewValue, Title)
	VALUES	('AssignUsersAsExpert','', N''),
			('AssignUsersToDepartments','', N''),
			('AssignUsersToProcesses','', N''),
			('AssignUsersToProjects','', N''),
			('CopCreation','', N''),
			('DefaultContentRegistration','', N''),
			('DepartmentsManipulation','', N''),
			('KDsManagement','', N''),
			('ManageDepartmentGroups','', N''),
			('OrganizationalProperties','', N''),
			('ProcessesManagement','', N''),
			('ProjectsManagement','', N''),
			('Navigation','', N''),
			('VisualKMap','', N''),
			('AssignUsersToClassifications','ManageConfidentialityLevels', N'  '),
			('ContentsManagement','ContentsManagement', N' '),
			('DepsAndUsersImport','DataImport', N'    XML'),
			('ManagementSystem','ManagementSystem', N' '),
			('ManageOntology','ManageOntology', N' '),
			('Reports','Reports', N''),
			('UserGroupsManagement','UserGroupsManagement', N' '),
			('UsersManagement','UsersManagement', N''),
			('ManageWorkflow','ManageWorkflow', N'  '),
			('ManageForms','ManageForms', N' '),
			('ManagePolls','ManagePolls', N' '),
			('KnowledgeAdmin','KnowledgeAdmin', N'  '),
			('SMSEMailNotifier','SMSEMailNotifier', N'    '),
			('','ManageQA', N'  '),
			('','RemoteServers', N'  ')
			
	UPDATE AR
		SET AR.Name = T.NewValue
	FROM @TBL AS T
		INNER JOIN [dbo].[USR_AccessRoles] AS AR
		ON AR.ApplicationID = @ApplicationID AND LOWER(AR.Name) = LOWER(T.OldValue)
		
	DELETE UAR
	FROM [dbo].[USR_UserGroupPermissions] AS UAR
		INNER JOIN [dbo].[USR_AccessRoles] AS AR
		ON AR.ApplicationID = @ApplicationID AND AR.RoleID = UAR.RoleID
	WHERE UAR.ApplicationID = @ApplicationID AND 
		AR.Name NOT IN (SELECT NewValue FROM @TBL AS T WHERE T.NewValue <> '')
	
	DELETE AR
	FROM [dbo].[USR_AccessRoles] AS AR
	WHERE AR.ApplicationID = @ApplicationID AND 
		AR.Name NOT IN (SELECT NewValue FROM @TBL AS T WHERE T.NewValue <> '')

	DELETE @TBL
	WHERE NewValue = ''

	INSERT INTO [dbo].[USR_AccessRoles] (ApplicationID, RoleID, Name, Title)
	SELECT @ApplicationID, NEWID(), T.NewValue, N''
	FROM @TBL AS T
	WHERE T.NewValue <> '' AND
		LOWER(T.NewValue) NOT IN (
			SELECT LOWER(Name) 
			FROM [dbo].[USR_AccessRoles]
			WHERE ApplicationID = @ApplicationID
		)

	UPDATE AR
		SET Title = REPLACE(REPLACE(T.Title, N'', N''), N'', N'')
	FROM @TBL AS T
		INNER JOIN [dbo].[USR_AccessRoles] AS AR
		ON LOWER(AR.Name) = LOWER(T.NewValue)
	WHERE AR.ApplicationID = @ApplicationID
		
	UPDATE T
		SET UQID = AR.RoleID
	FROM @TBL AS T
		INNER JOIN [dbo].[USR_AccessRoles] AS AR
		ON LOWER(AR.Name) = LOWER(T.NewValue)
	WHERE AR.ApplicationID = @ApplicationID
	
	DELETE UGP
	FROM [dbo].[USR_UserGroupPermissions] AS UGP
		INNER JOIN (
			SELECT	ROW_NUMBER() OVER 
						(PARTITION BY UAR.GroupID, T.UQID ORDER BY UAR.RoleID ASC) AS RowNumber,
					UAR.GroupID, 
					UAR.RoleID, 
					T.UQID
			FROM @TBL AS T
				INNER JOIN [dbo].[USR_UserGroupPermissions] AS UAR
				INNER JOIN [dbo].[USR_AccessRoles] AS AR
				ON AR.ApplicationID = @ApplicationID AND AR.RoleID = UAR.RoleID
				ON UAR.ApplicationID = @ApplicationID AND LOWER(AR.Name) = LOWER(T.NewValue)
		) AS R
		ON R.GroupID = UGP.GroupID AND R.RoleID = UGP.RoleID
	WHERE R.RowNumber > 1
	
	UPDATE UAR
		SET RoleID = T.UQID
	FROM @TBL AS T
		INNER JOIN [dbo].[USR_UserGroupPermissions] AS UAR
		INNER JOIN [dbo].[USR_AccessRoles] AS AR
		ON AR.ApplicationID = @ApplicationID AND AR.RoleID = UAR.RoleID
		ON UAR.ApplicationID = @ApplicationID AND LOWER(AR.Name) = LOWER(T.NewValue)

	DELETE [dbo].[USR_AccessRoles]
	WHERE ApplicationID = @ApplicationID AND 
		RoleID NOT IN (SELECT UQID FROM @TBL)
    
    RETURN 1
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[PRVC_P_AddAudience]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[PRVC_P_AddAudience]
GO

CREATE PROCEDURE [dbo].[PRVC_P_AddAudience]
	@ApplicationID		uniqueidentifier,
	@ObjectID			uniqueidentifier,
	@RoleID				uniqueidentifier,
	@PermissionType		varchar(50),
	@Allow				bit,
	@ExpirationDate		datetime,
	@CreatorUserID		uniqueidentifier,
	@CreationDate		datetime,
	@_Result			int output
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	IF EXISTS(
		SELECT TOP(1) * 
		FROM [dbo].[PRVC_Audience]
		WHERE ApplicationID = @ApplicationID AND RoleID = @RoleID AND ObjectID = @ObjectID
	) BEGIN
		UPDATE [dbo].[PRVC_Audience]
			SET Allow = @Allow,
				ExpirationDate = @ExpirationDate,
				LastModifierUserID = @CreatorUserID,
				LastModificationDate = @CreationDate,
				Deleted = 0
		WHERE ApplicationID = @ApplicationID AND ObjectID = @ObjectID AND 
			RoleID = @RoleID AND PermissionType = @PermissionType
	END
	ELSE BEGIN
		INSERT INTO [dbo].[PRVC_Audience](
			ApplicationID,
			ObjectID,
			RoleID,
			PermissionType,
			Allow,
			ExpirationDate,
			CreatorUserID,
			CreationDate,
			Deleted
		)
		VALUES(
			@ApplicationID,
			@ObjectID, 
			@RoleID, 
			@PermissionType,
			@Allow, 
			@ExpirationDate, 
			@CreatorUserID, 
			@CreationDate, 
			0
		)
	END
	
	SET @_Result = @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[PRVC_SetAudience]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[PRVC_SetAudience]
GO

CREATE PROCEDURE [dbo].[PRVC_SetAudience]
	@ApplicationID			uniqueidentifier,
	@ObjectIDsTemp			GuidTableType readonly,
	@DefaultPermissionsTemp	GuidStringPairTableType readonly,
	@AudienceTemp			PrivacyAudienceTableType readonly,
	@SettingsTemp			GuidPairBitTableType readonly,
	@CurrentUserID		uniqueidentifier,
	@Now				datetime
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @ObjectIDs GuidTableType
	INSERT INTO @ObjectIDs SELECT * FROM @ObjectIDsTemp
	
	DECLARE @DefaultPermissions GuidStringPairTableType
	INSERT INTO @DefaultPermissions SELECT * FROM @DefaultPermissionsTemp
	
	DECLARE @Audience PrivacyAudienceTableType
	INSERT INTO @Audience SELECT * FROM @AudienceTemp
	
	DECLARE @Settings GuidPairBitTableType
	INSERT INTO @Settings SELECT * FROM @SettingsTemp
	
	-- Update Settings
	DELETE S
	FROM @ObjectIDs AS IDs
		INNER JOIN [dbo].[PRVC_Settings] AS S
		ON S.ObjectID = IDs.Value
		LEFT JOIN @Settings AS T
		ON T.FirstValue = IDs.Value
	WHERE T.FirstValue IS NULL
	
	UPDATE S
		SET CalculateHierarchy = ISNULL(T.BitValue, 0),
			ConfidentialityID = T.SecondValue,
			LastModifierUserID = @CurrentUserID,
			LastModificationDate = @Now
	FROM [dbo].[PRVC_Settings] AS S
		INNER JOIN @Settings AS T
		ON T.FirstValue = S.ObjectID
	
	INSERT INTO [dbo].[PRVC_Settings] (ApplicationID, ObjectID, 
		CalculateHierarchy, ConfidentialityID, CreatorUserID, CreationDate)
	SELECT @ApplicationID, T.FirstValue, ISNULL(T.BitValue, 0), T.SecondValue, @CurrentUserID, @Now
	FROM @Settings AS T
		LEFT JOIN [dbo].[PRVC_Settings] AS S
		ON S.ObjectID = T.FirstValue
	WHERE S.ObjectID IS NULL
	-- end of Update Settings
	
	
	-- Update Default Permissions
	DELETE P
	FROM @ObjectIDs AS IDs
		INNER JOIN [dbo].[PRVC_DefaultPermissions] AS P
		ON P.ObjectID = IDs.Value
		LEFT JOIN @DefaultPermissions AS D
		ON D.GuidValue = IDs.Value AND D.FirstValue = P.PermissionType
	WHERE D.GuidValue IS NULL
	
	UPDATE P
		SET DefaultValue = D.SecondValue,
			LastModifierUserID = @CurrentUserID,
			LastModificationDate = @Now
	FROM [dbo].[PRVC_DefaultPermissions] AS P
		INNER JOIN @DefaultPermissions AS D
		ON D.GuidValue = P.ObjectID AND D.FirstValue = P.PermissionType
	
	INSERT INTO [dbo].[PRVC_DefaultPermissions] (ApplicationID, ObjectID, 
		PermissionType, DefaultValue, CreatorUserID, CreationDate)
	SELECT @ApplicationID, D.GuidValue, D.FirstValue, D.SecondValue, @CurrentUserID, @Now
	FROM @DefaultPermissions AS D
		LEFT JOIN [dbo].[PRVC_DefaultPermissions] AS P
		ON P.ObjectID = D.GuidValue AND P.PermissionType = D.FirstValue
	WHERE P.ObjectID IS NULL
	-- end of Update Default Permissions
	
	
	-- Update Audience
	UPDATE A
		SET Deleted = 1,
			LastModifierUserID = @CurrentUserID,
			LastModificationDate = @Now
	FROM @ObjectIDs AS IDs
		INNER JOIN [dbo].[PRVC_Audience] AS A
		ON A.ObjectID = IDs.Value
		LEFT JOIN @Audience AS D
		ON D.ObjectID = A.ObjectID AND D.RoleID = A.RoleID AND D.PermissionType = A.PermissionType
	WHERE D.ObjectID IS NULL
	
	UPDATE A
		SET Allow = ISNULL(D.Allow, 0),
			PermissionType = D.PermissionType,
			ExpirationDate = D.ExpirationDate,
			Deleted = 0,
			LastModifierUserID = @CurrentUserID,
			LastModificationDate = @Now
	FROM [dbo].[PRVC_Audience] AS A
		INNER JOIN @Audience AS D
		ON D.ObjectID = A.ObjectID AND D.RoleID = A.RoleID AND D.PermissionType = A.PermissionType
	
	INSERT INTO [dbo].[PRVC_Audience] (ApplicationID, ObjectID, 
		RoleID, Allow, PermissionType, ExpirationDate, CreatorUserID, CreationDate, Deleted)
	SELECT @ApplicationID, D.ObjectID, D.RoleID, ISNULL(D.Allow, 0), 
		D.PermissionType, D.ExpirationDate, @CurrentUserID, @Now, 0
	FROM @Audience AS D
		LEFT JOIN [dbo].[PRVC_Audience] AS A
		ON A.ObjectID = D.ObjectID AND A.RoleID = D.RoleID AND D.PermissionType = A.PermissionType
	WHERE A.ObjectID IS NULL
	-- end of Update Audience
	
	SELECT 1
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[PRVC_CheckAccess]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[PRVC_CheckAccess]
GO

CREATE PROCEDURE [dbo].[PRVC_CheckAccess]
	@ApplicationID		uniqueidentifier,
	@UserID				uniqueidentifier,
	@ObjectType			varchar(50),
    @ObjectIDsTemp		GuidTableType readonly,
    @PermissionsTemp	StringPairTableType readonly,
    @Now				datetime
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @ObjectIDs GuidTableType
	INSERT INTO @ObjectIDs SELECT DISTINCT * FROM @ObjectIDsTemp
	
    DECLARE @Permissions StringPairTableType
    INSERT INTO @Permissions SELECT * FROM @PermissionsTemp
	
	DECLARE @IDs KeyLessGuidTableType
	
	INSERT INTO @IDs (Value)
	SELECT O.Value
	FROM @ObjectIDs AS O
	
	SELECT Ref.ID, Ref.[Type]
	FROM [dbo].[PRVC_FN_CheckAccess](@ApplicationID, @UserID, 
		@IDs, @ObjectType, @Now, @Permissions) AS Ref
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[PRVC_GetAudienceRoleIDs]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[PRVC_GetAudienceRoleIDs]
GO

CREATE PROCEDURE [dbo].[PRVC_GetAudienceRoleIDs]
	@ApplicationID	uniqueidentifier,
	@ObjectID		uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT Ref.RoleID AS ID
	FROM [dbo].[PRVC_Audience] AS Ref
	WHERE Ref.ApplicationID = @ApplicationID AND Ref.ObjectID = @ObjectID AND Ref.Deleted = 0
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[PRVC_GetAudience]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[PRVC_GetAudience]
GO

CREATE PROCEDURE [dbo].[PRVC_GetAudience]
	@ApplicationID	uniqueidentifier,
	@strObjectIDs	varchar(max),
	@delimiter		char
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @ObjectIDs GuidTableType
	
	INSERT INTO @ObjectIDs (Value)
	SELECT DISTINCT Ref.Value
	FROM [dbo].[GFN_StrToGuidTable](@strObjectIDs, @delimiter) AS Ref
	
	DECLARE @Audience Table(ObjectID uniqueidentifier, RoleID uniqueidentifier, 
		PermissionType varchar(50), Allow bit, ExpirationDate datetime)
	
	INSERT INTO @Audience (ObjectID, RoleID, PermissionType, Allow, ExpirationDate)
	SELECT Ref.ObjectID, Ref.RoleID, Ref.PermissionType, Ref.Allow, Ref.ExpirationDate
	FROM @ObjectIDs AS IDs
		INNER JOIN [dbo].[PRVC_Audience] AS Ref
		ON Ref.ApplicationID = @ApplicationID AND Ref.ObjectID = IDs.Value AND Ref.Deleted = 0

	SELECT	ExternalIDs.*,
			RTRIM(LTRIM((ISNULL(UN.FirstName, N'') + N' ' + ISNULL(UN.LastName, N'')))) AS Name,
			N'User' AS [Type],
			NULL AS NodeType,
			UN.UserName AS AdditionalID
	FROM @Audience AS ExternalIDs
		INNER JOIN [dbo].[Users_Normal] AS UN
		ON UN.UserID = ExternalIDs.RoleID
	WHERE UN.ApplicationID = @ApplicationID AND UN.IsApproved = 1
	
	UNION ALL
	
	SELECT	ExternalIDs.*,
			ND.NodeName AS Name,
			N'Node' AS [Type],
			ND.TypeName AS NodeType,
			ND.NodeAdditionalID AS AdditionalID
	FROM @Audience AS ExternalIDs
		INNER JOIN [dbo].[CN_View_Nodes_Normal] AS ND
		ON ND.NodeID = ExternalIDs.RoleID
	WHERE ND.ApplicationID = @ApplicationID AND ND.Deleted = 0
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[PRVC_GetDefaultPermissions]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[PRVC_GetDefaultPermissions]
GO

CREATE PROCEDURE [dbo].[PRVC_GetDefaultPermissions]
	@ApplicationID	uniqueidentifier,
	@strObjectIDs	varchar(max),
	@delimiter		char
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @ObjectIDs GuidTableType
	
	INSERT INTO @ObjectIDs (Value)
	SELECT DISTINCT Ref.Value
	FROM [dbo].[GFN_StrToGuidTable](@strObjectIDs, @delimiter) AS Ref
	
	SELECT P.ObjectID AS ID, P.PermissionType AS [Type], P.DefaultValue
	FROM @ObjectIDs AS IDs
		INNER JOIN [dbo].[PRVC_DefaultPermissions] AS P
		ON P.ApplicationID = @ApplicationID AND P.ObjectID = IDs.Value
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[PRVC_GetSettings]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[PRVC_GetSettings]
GO

CREATE PROCEDURE [dbo].[PRVC_GetSettings]
	@ApplicationID	uniqueidentifier,
	@strObjectIDs	varchar(max),
	@delimiter		char
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @ObjectIDs GuidTableType
	
	INSERT INTO @ObjectIDs (Value)
	SELECT DISTINCT Ref.Value
	FROM [dbo].[GFN_StrToGuidTable](@strObjectIDs, @delimiter) AS Ref
	
	SELECT IDs.Value AS ObjectID, S.CalculateHierarchy, S.ConfidentialityID, CL.LevelID, CL.[Title] AS [Level]
	FROM @ObjectIDs AS IDs
		LEFT JOIN [dbo].[PRVC_Settings] AS S
		ON S.ApplicationID = @ApplicationID AND S.ObjectID = IDs.Value
		LEFT JOIN [dbo].[PRVC_ConfidentialityLevels] AS CL
		ON CL.ApplicationID = @ApplicationID AND CL.ID = S.ConfidentialityID AND CL.Deleted = 0
END

GO


-- Confidentiality

IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[PRVC_AddConfidentialityLevel]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[PRVC_AddConfidentialityLevel]
GO

CREATE PROCEDURE [dbo].[PRVC_AddConfidentialityLevel]
	@ApplicationID	uniqueidentifier,
	@ID				uniqueidentifier,
	@LevelID		int,
	@Title			nvarchar(256),
	@CurrentUserID	uniqueidentifier,
	@Now			datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SET @Title = [dbo].[GFN_VerifyString](@Title)
	
	IF EXISTS(
		SELECT TOP(1) 1 
		FROM [dbo].[PRVC_ConfidentialityLevels] 
		WHERE ApplicationID = @ApplicationID AND LevelID = @LevelID AND Deleted = 0
	) BEGIN
		SELECT -1, N'LevelCodeAlreadyExists'
		RETURN
	END
	
	INSERT INTO [dbo].[PRVC_ConfidentialityLevels](
		ApplicationID,
		ID,
		LevelID,
		Title,
		CreatorUserID,
		CreationDate,
		Deleted
	)
	VALUES(
		@ApplicationID,
		@ID,
		@LevelID,
		@Title,
		@CurrentUserID,
		@Now,
		0
	)
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[PRVC_ModifyConfidentialityLevel]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[PRVC_ModifyConfidentialityLevel]
GO

CREATE PROCEDURE [dbo].[PRVC_ModifyConfidentialityLevel]
	@ApplicationID	uniqueidentifier,
	@ID				uniqueidentifier,
	@NewLevelID		int,
	@NewTitle		nvarchar(256),
	@CurrentUserID	uniqueidentifier,
	@Now			datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SET @NewTitle = [dbo].[GFN_VerifyString](@NewTitle)
	
	IF EXISTS(
		SELECT TOP(1) 1 
		FROM [dbo].[PRVC_ConfidentialityLevels] 
		WHERE ApplicationID = @ApplicationID AND 
			ID <> @ID AND LevelID = @NewLevelID AND Deleted = 0
	) BEGIN
		SELECT -1, N'LevelCodeAlreadyExists'
		RETURN
	END
	
	UPDATE [dbo].[PRVC_ConfidentialityLevels]
		SET LevelID = @NewLevelID,
			Title = @NewTitle,
			LastModifierUserID = @CurrentUserID,
			LastModificationDate = @Now
	WHERE ApplicationID = @ApplicationID AND ID = @ID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[PRVC_RemoveConfidentialityLevel]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[PRVC_RemoveConfidentialityLevel]
GO

CREATE PROCEDURE [dbo].[PRVC_RemoveConfidentialityLevel]
	@ApplicationID	uniqueidentifier,
	@ID				uniqueidentifier,
	@CurrentUserID	uniqueidentifier,
	@Now			datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[PRVC_ConfidentialityLevels]
		SET Deleted = 1,
			LastModifierUserID = @CurrentUserID,
			LastModificationDate = @Now
	WHERE ApplicationID = @ApplicationID AND ID = @ID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[PRVC_GetConfidentialityLevels]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[PRVC_GetConfidentialityLevels]
GO

CREATE PROCEDURE [dbo].[PRVC_GetConfidentialityLevels]
	@ApplicationID	uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT CONF.ID AS ID,
		   CONF.[LevelID] AS LevelID,
		   CONF.[Title] AS Title
	FROM [dbo].[PRVC_ConfidentialityLevels] AS CONF
	WHERE CONF.ApplicationID = @ApplicationID AND CONF.Deleted = 0
	ORDER BY CONF.LevelID ASC
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[PRVC_SetConfidentialityLevel]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[PRVC_SetConfidentialityLevel]
GO

CREATE PROCEDURE [dbo].[PRVC_SetConfidentialityLevel]
	@ApplicationID			uniqueidentifier,
	@ItemID					uniqueidentifier,
	@LevelID				uniqueidentifier,
	@LastModifierUserID		uniqueidentifier,
	@LastModificationDate	datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	IF EXISTS(
		SELECT TOP(1) * 
		FROM [dbo].[PRVC_Settings] 
		WHERE ApplicationID = @ApplicationID AND ObjectID = @ItemID
	) BEGIN
		UPDATE [dbo].[PRVC_Settings]
			SET ConfidentialityID = @LevelID,
				LastModifierUserID = @LastModifierUserID,
				LastModificationDate = @LastModificationDate
		WHERE ApplicationID = @ApplicationID AND ObjectID = @ItemID
	END
	ELSE BEGIN
		INSERT INTO [dbo].[PRVC_Settings](
			ApplicationID,
			ObjectID,
			ConfidentialityID,
			CreatorUserID,
			CreationDate
		)
		VALUES(
			@ApplicationID,
			@ItemID,
			@LevelID,
			@LastModifierUserID,
			@LastModificationDate
		)
	END
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[PRVC_UnsetConfidentialityLevel]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[PRVC_UnsetConfidentialityLevel]
GO

CREATE PROCEDURE [dbo].[PRVC_UnsetConfidentialityLevel]
	@ApplicationID			uniqueidentifier,
	@ItemID					uniqueidentifier,
	@LastModifierUserID		uniqueidentifier,
	@LastModificationDate	datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[PRVC_Settings]
		SET LastModifierUserID = @LastModifierUserID,
			LastModificationDate = @LastModificationDate,
			ConfidentialityID = null
	WHERE ApplicationID = @ApplicationID AND ObjectID = @ItemID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[PRVC_GetConfidentialityLevelUserIDs]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[PRVC_GetConfidentialityLevelUserIDs]
GO

CREATE PROCEDURE [dbo].[PRVC_GetConfidentialityLevelUserIDs]
	@ApplicationID			uniqueidentifier,
	@ConfidentialityID		uniqueidentifier,
	@SearchText				nvarchar(500),
	@Count					int,
	@LowerBoundary			bigint
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	IF ISNULL(@Count, 0) <= 0 SET @Count = 1000000
	
	IF ISNULL(@SearchText, N'') = N'' BEGIN
		SELECT TOP(@Count)
			Ref.UserID,
			(Ref.RowNumber + Ref.RevRowNumber - 1) AS TotalCount
		FROM (
				SELECT	ROW_NUMBER() OVER (ORDER BY USR.UserID DESC) AS RowNumber,
						ROW_NUMBER() OVER (ORDER BY USR.UserID ASC) AS RevRowNumber,
						USR.UserID
				FROM [dbo].[PRVC_View_Confidentialities] AS C
					INNER JOIN [dbo].[Users_Normal] AS USR
					ON USR.ApplicationID = @ApplicationID AND USR.UserID = C.ObjectID
				WHERE C.ApplicationID = @ApplicationID AND C.ConfidentialityID = @ConfidentialityID
			) AS Ref
		WHERE Ref.RowNumber >= ISNULL(@LowerBoundary, 0)
		ORDER BY Ref.RowNumber ASC
	END
	ELSE BEGIN
		SELECT TOP(@Count)
			Ref.UserID,
			(Ref.RowNumber + Ref.RevRowNumber - 1) AS TotalCount
		FROM (
				SELECT	ROW_NUMBER() OVER (ORDER BY SRCH.[RANK] DESC, USR.UserID DESC) AS RowNumber,
						ROW_NUMBER() OVER (ORDER BY SRCH.[RANK] ASC, USR.UserID ASC) AS RevRowNumber,
						USR.UserID
				FROM CONTAINSTABLE([dbo].[USR_View_Users], (FirstName, LastName, UserName), @SearchText) AS SRCH 
					INNER JOIN [dbo].[PRVC_View_Confidentialities] AS C
					INNER JOIN [dbo].[Users_Normal] AS USR
					ON USR.ApplicationID = @ApplicationID AND USR.UserID = C.ObjectID
					ON USR.UserID = SRCH.[Key]
				WHERE C.ApplicationID = @ApplicationID AND C.ConfidentialityID = @ConfidentialityID
			) AS Ref
		WHERE Ref.RowNumber >= ISNULL(@LowerBoundary, 0)
		ORDER BY Ref.RowNumber ASC	
	END
END

GO

-- end of Confidentiality

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[FG_P_CreateForm]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[FG_P_CreateForm]
GO

CREATE PROCEDURE [dbo].[FG_P_CreateForm]
	@ApplicationID		uniqueidentifier,
    @FormID				uniqueidentifier,
    @TemplateFormID		uniqueidentifier,
	@Title				nvarchar(255),
	@CreatorUserID		uniqueidentifier,
	@CreationDate		datetime,
	@_Result			int output
WITH ENCRYPTION
AS
BEGIN TRANSACTION
	SET NOCOUNT ON
	
	DECLARE @_RetVal int
	SET @_RetVal = 0
	
	SET @Title = [dbo].[GFN_VerifyString](@Title)
	
	IF EXISTS (
		SELECT TOP(1) * 
		FROM [dbo].[FG_ExtendedForms]
		WHERE ApplicationID = @ApplicationID AND Title = @Title AND Deleted = 1
	) BEGIN
			UPDATE [dbo].[FG_ExtendedForms]
			SET TemplateFormID = @TemplateFormID,
				LastModifierUserID = @CreatorUserID,
				LastModificationDate = @CreationDate,
				Deleted = 0
			WHERE ApplicationID = @ApplicationID AND Title = @Title AND Deleted = 1
			
		SET @_RetVal = @@ROWCOUNT
	END
	ELSE IF EXISTS (
		SELECT TOP(1) * 
		FROM [dbo].[FG_ExtendedForms]
		WHERE ApplicationID = @ApplicationID AND Title = @Title AND Deleted = 0
	) BEGIN
			SET @_RetVal = -1
	END	
	ELSE BEGIN
		INSERT INTO [dbo].[FG_ExtendedForms](
			ApplicationID,
			FormID,
			TemplateFormID,
			Title,
			CreatorUserID,
			CreationDate,
			Deleted
		)
		VALUES(
			@ApplicationID,
			@FormID,
			@TemplateFormID,
			@Title,
			@CreatorUserID,
			@CreationDate,
			0
		)
		SET @_RetVal = @@ROWCOUNT
	END
	
	IF (@@ROWCOUNT <= 0 AND @_RetVal = 0) BEGIN
		SET @_Result = @_RetVal
		ROLLBACK TRANSACTION
		RETURN
	END
	
	SET @_Result = @_RetVal
	
COMMIT TRANSACTION

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[FG_CreateForm]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[FG_CreateForm]
GO

CREATE PROCEDURE [dbo].[FG_CreateForm]
	@ApplicationID		uniqueidentifier,
    @FormID				uniqueidentifier,
    @TemplateFormID		uniqueidentifier,
	@Title				nvarchar(255),
	@CreatorUserID		uniqueidentifier,
	@CreationDate		datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @_Result int
	
	EXEC [dbo].[FG_P_CreateForm] @ApplicationID, @FormID, @TemplateFormID,
		@Title, @CreatorUserID, @CreationDate, @_Result output
		
	SELECT @_Result
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[FG_SetFormTitle]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[FG_SetFormTitle]
GO

CREATE PROCEDURE [dbo].[FG_SetFormTitle]
	@ApplicationID			uniqueidentifier,
    @FormID					uniqueidentifier,
    @Title					nvarchar(255),
	@LastModifierUserID		uniqueidentifier,
	@LastModificationDate	datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	IF EXISTS (
		SELECT TOP(1) * 
		FROM [dbo].[FG_ExtendedForms]
		WHERE ApplicationID = @ApplicationID AND Title = @Title AND FormID <> @FormID AND Deleted = 0
	) BEGIN
		SELECT -1
		RETURN
	END
	
	UPDATE [dbo].[FG_ExtendedForms]
		SET Title = [dbo].[GFN_VerifyString](@Title),
			LastModifierUserID = @LastModifierUserID,
			LastModificationDate = @LastModificationDate
	WHERE ApplicationID = @ApplicationID AND FormID = @FormID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[FG_SetFormName]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[FG_SetFormName]
GO

CREATE PROCEDURE [dbo].[FG_SetFormName]
	@ApplicationID	uniqueidentifier,
    @FormID			uniqueidentifier,
    @Name			varchar(100),
	@CurrentUserID	uniqueidentifier,
	@Now			datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	IF ISNULL(@Name, N'') <> N'' AND EXISTS(
		SELECT TOP(1) *
		FROM [dbo].[FG_ExtendedForms] AS F
		WHERE F.ApplicationID = @ApplicationID AND F.Deleted = 0 AND 
			LOWER(F.Name) = LOWER(@Name) AND F.FormID <> @FormID
	) BEGIN
		SELECT -1, N'NameAlreadyExists'
		RETURN
	END
	
	UPDATE [dbo].[FG_ExtendedForms]
		SET Name = @Name,
			LastModifierUserID = @CurrentUserID,
			LastModificationDate = @Now
	WHERE ApplicationID = @ApplicationID AND FormID = @FormID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[FG_SetFormDescription]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[FG_SetFormDescription]
GO

CREATE PROCEDURE [dbo].[FG_SetFormDescription]
	@ApplicationID			uniqueidentifier,
    @FormID					uniqueidentifier,
    @Description			nvarchar(2000),
	@LastModifierUserID		uniqueidentifier,
	@LastModificationDate	datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[FG_ExtendedForms]
		SET [Description] = @Description,
			LastModifierUserID = @LastModifierUserID,
			LastModificationDate = @LastModificationDate
	WHERE ApplicationID = @ApplicationID AND FormID = @FormID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[FG_ArithmeticDeleteForm]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[FG_ArithmeticDeleteForm]
GO

CREATE PROCEDURE [dbo].[FG_ArithmeticDeleteForm]
	@ApplicationID			uniqueidentifier,
    @FormID					uniqueidentifier,
	@LastModifierUserID		uniqueidentifier,
	@LastModificationDate	datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[FG_ExtendedForms]
		SET LastModifierUserID = @LastModifierUserID,
			LastModificationDate = @LastModificationDate,
			Deleted = 1
	WHERE ApplicationID = @ApplicationID AND FormID = @FormID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[FG_RecycleForm]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[FG_RecycleForm]
GO

CREATE PROCEDURE [dbo].[FG_RecycleForm]
	@ApplicationID			uniqueidentifier,
    @FormID					uniqueidentifier,
	@LastModifierUserID		uniqueidentifier,
	@LastModificationDate	datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[FG_ExtendedForms]
		SET LastModifierUserID = @LastModifierUserID,
			LastModificationDate = @LastModificationDate,
			Deleted = 0
	WHERE ApplicationID = @ApplicationID AND FormID = @FormID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[FG_P_GetFormsByIDs]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[FG_P_GetFormsByIDs]
GO

CREATE PROCEDURE [dbo].[FG_P_GetFormsByIDs]
	@ApplicationID	uniqueidentifier,
    @FormIDsTemp	GuidTableType readonly
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @FormIDs GuidTableType
	INSERT INTO @FormIDs SELECT * FROM @FormIDsTemp
	
	SELECT EF.FormID,
		   EF.Title,
		   EF.Name,
		   EF.[Description]
	FROM @FormIDs AS ExternalIDs
		INNER JOIN [dbo].[FG_ExtendedForms] AS EF
		ON EF.ApplicationID = @ApplicationID AND EF.FormID = ExternalIDs.Value
	ORDER BY EF.CreationDate DESC
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[FG_GetFormsByIDs]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[FG_GetFormsByIDs]
GO

CREATE PROCEDURE [dbo].[FG_GetFormsByIDs]
	@ApplicationID	uniqueidentifier,
    @FormIDsTemp	GuidTableType readonly
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @FormIDs GuidTableType

	INSERT INTO @FormIDs ([Value])
	SELECT T.[Value]
	FROM @FormIDsTemp AS T

	EXEC [dbo].[FG_P_GetFormsByIDs] @ApplicationID, @FormIDs
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[FG_GetForms]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[FG_GetForms]
GO

CREATE PROCEDURE [dbo].[FG_GetForms]
	@ApplicationID	uniqueidentifier,
	@FormName		varchar(255),
	@SearchText		nvarchar(1000),
	@Count			int,
	@LowerBoundary	int,
	@HasName		bit,
	@Archive		bit
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SET @Archive = ISNULL(@Archive, 0)
	
	DECLARE @FormIDs GuidTableType

	IF @FormName = '' SET @FormName = NULL
	
	IF ISNULL(@SearchText, N'') = N'' BEGIN
		INSERT INTO @FormIDs (Value)
		SELECT TOP(ISNULL(@Count, 1000000)) X.FormID
		FROM (
				SELECT	ROW_NUMBER() OVER (ORDER BY F.FormID ASC) AS RowNumber,
						F.FormID 
				FROM [dbo].[FG_ExtendedForms] AS F
				WHERE F.ApplicationID = @ApplicationID AND F.Deleted = @Archive AND
					(@FormName IS NULL OR LOWER(ISNULL(F.[Name], '')) = LOWER(@FormName)) AND
					(@HasName IS NULL OR (@HasName = 0 AND ISNULL(F.[Name], N'') = N'') OR 
						(@HasName = 1 AND ISNULL(F.[Name], N'') <> N''))
			) AS X
		WHERE X.RowNumber >= ISNULL(@LowerBoundary, 0)
		ORDER BY X.RowNumber ASC
	END
	ELSE BEGIN
		INSERT INTO @FormIDs (Value)
		SELECT TOP(ISNULL(@Count, 1000000)) X.FormID
		FROM (
				SELECT	ROW_NUMBER() OVER (ORDER BY SRCH.[Rank] DESC, F.FormID ASC) AS RowNumber,
						F.FormID 
				FROM CONTAINSTABLE([dbo].[FG_ExtendedForms], (Title), @SearchText) AS SRCH
					INNER JOIN [dbo].[FG_ExtendedForms] AS F
					ON F.ApplicationID = @ApplicationID AND F.FormID = SRCH.[Key] AND
						F.Deleted = @Archive AND
						(@FormName IS NULL OR LOWER(ISNULL(F.[Name], '')) = LOWER(@FormName)) AND
						(@HasName IS NULL OR (@HasName = 0 AND ISNULL(F.[Name], N'') = N'') OR 
							(@HasName = 1 AND ISNULL(F.[Name], N'') <> N''))
			) AS X
		WHERE X.RowNumber >= ISNULL(@LowerBoundary, 0)
		ORDER BY X.RowNumber ASC
	END
	
	EXEC [dbo].[FG_P_GetFormsByIDs] @ApplicationID, @FormIDs
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[FG_AddFormElement]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[FG_AddFormElement]
GO

CREATE PROCEDURE [dbo].[FG_AddFormElement]
	@ApplicationID		uniqueidentifier,
	@ElementID			uniqueidentifier,
	@TemplateElementID	uniqueidentifier,
	@FormID				uniqueidentifier,
	@Title				nvarchar(2000),
	@Name				varchar(100),
	@Help				nvarchar(2000),
	@SequenceNumber		int,
	@Type				varchar(20),
	@Info				nvarchar(max),
	@CreatorUserID		uniqueidentifier,
	@CreationDate		datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	IF ISNULL(@Name, N'') <> N'' AND EXISTS(
		SELECT TOP(1) *
		FROM [dbo].[FG_ExtendedFormElements] AS F
		WHERE F.ApplicationID = @ApplicationID AND F.FormID = @FormID AND 
			F.Deleted = 0 AND LOWER(F.Name) = LOWER(@Name)
	) BEGIN
		SELECT -1, N'NameAlreadyExists'
		RETURN
	END
	
	INSERT INTO [dbo].[FG_ExtendedFormElements](
		ApplicationID,
		ElementID,
		TemplateElementID,
		FormID,
		Title,
		Name,
		Help,
		SequenceNumber,
		[Type],
		Info,
		CreatorUserID,
		CreationDate,
		Deleted
	)
	VALUES(
		@ApplicationID,
		@ElementID,
		@TemplateElementID,
		@FormID,
		[dbo].[GFN_VerifyString](@Title),
		@Name,
		[dbo].[GFN_VerifyString](@Help),
		@SequenceNumber,
		@Type,
		@Info,
		@CreatorUserID,
		@CreationDate,
		0
	)
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[FG_ModifyFormElement]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[FG_ModifyFormElement]
GO

CREATE PROCEDURE [dbo].[FG_ModifyFormElement]
	@ApplicationID			uniqueidentifier,
	@ElementID				uniqueidentifier,
	@Title					nvarchar(2000),
	@Name					varchar(100),
	@Help					nvarchar(2000),
	@Info					nvarchar(max),
	@Weight					float,
	@LastModifierUserID		uniqueidentifier,
	@LastModificationDate	datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @FormID uniqueidentifier = (
		SELECT TOP(1) FormID
		FROM [dbo].[FG_ExtendedFormElements] AS E
		WHERE E.ApplicationID = @ApplicationID AND E.ElementID = @ElementID
	)
	
	IF ISNULL(@Name, N'') <> N'' AND EXISTS(
		SELECT TOP(1) *
		FROM [dbo].[FG_ExtendedFormElements] AS F
		WHERE F.ApplicationID = @ApplicationID AND F.FormID = @FormID AND F.Deleted = 0 AND 
			LOWER(F.Name) = LOWER(@Name) AND F.ElementID <> @ElementID
	) BEGIN
		SELECT -1, N'NameAlreadyExists'
		RETURN
	END
	
	UPDATE [dbo].[FG_ExtendedFormElements]
		SET Title = [dbo].[GFN_VerifyString](@Title),
			Name = @Name,
			Help = [dbo].[GFN_VerifyString](@Help),
			Info = @Info,
			[Weight] = @Weight,
			LastModifierUserID = @LastModifierUserID,
			LastModificationDate = @LastModificationDate
	WHERE ApplicationID = @ApplicationID AND ElementID = @ElementID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[FG_SetElementsOrder]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[FG_SetElementsOrder]
GO

CREATE PROCEDURE [dbo].[FG_SetElementsOrder]
	@ApplicationID	uniqueidentifier,
	@strElementIDs	varchar(max),
	@delimiter		char
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @ElementIDs TABLE (SequenceNo int identity(1, 1) primary key, ElementID uniqueidentifier)
	
	INSERT INTO @ElementIDs (ElementID)
	SELECT Ref.Value
	FROM [dbo].[GFN_StrToGuidTable](@strElementIDs, @delimiter) AS Ref
	
	DECLARE @FormID uniqueidentifier
	
	SELECT @FormID = FormID
	FROM [dbo].[FG_ExtendedFormElements]
	WHERE ApplicationID = @ApplicationID AND 
		ElementID = (SELECT TOP (1) Ref.ElementID FROM @ElementIDs AS Ref)
	
	IF @FormID IS NULL BEGIN
		SELECT -1
		RETURN
	END
	
	INSERT INTO @ElementIDs (ElementID)
	SELECT E.ElementID
	FROM @ElementIDs AS Ref
		RIGHT JOIN [dbo].[FG_ExtendedFormElements] AS E
		ON E.ElementID = Ref.ElementID
	WHERE E.ApplicationID = @ApplicationID AND E.FormID = @FormID AND Ref.ElementID IS NULL
	ORDER BY E.SequenceNumber
	
	UPDATE [dbo].[FG_ExtendedFormElements]
		SET SequenceNumber = Ref.SequenceNo
	FROM @ElementIDs AS Ref
		INNER JOIN [dbo].[FG_ExtendedFormElements] AS E
		ON E.ElementID = Ref.ElementID
	WHERE E.ApplicationID = @ApplicationID AND E.FormID = @FormID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[FG_SetFormElementNecessity]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[FG_SetFormElementNecessity]
GO

CREATE PROCEDURE [dbo].[FG_SetFormElementNecessity]
	@ApplicationID	uniqueidentifier,
	@ElementID		uniqueidentifier,
	@Necessity		bit
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[FG_ExtendedFormElements]
		SET Necessary = @Necessity
	WHERE ApplicationID = @ApplicationID AND ElementID = @ElementID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[FG_SetFormElementUniqueness]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[FG_SetFormElementUniqueness]
GO

CREATE PROCEDURE [dbo].[FG_SetFormElementUniqueness]
	@ApplicationID	uniqueidentifier,
	@ElementID		uniqueidentifier,
	@Value			bit
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[FG_ExtendedFormElements]
		SET UniqueValue = @Value
	WHERE ApplicationID = @ApplicationID AND ElementID = @ElementID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[FG_ArithmeticDeleteFormElement]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[FG_ArithmeticDeleteFormElement]
GO

CREATE PROCEDURE [dbo].[FG_ArithmeticDeleteFormElement]
	@ApplicationID			uniqueidentifier,
	@ElementID				uniqueidentifier,
	@LastModifierUserID		uniqueidentifier,
	@LastModificationDate	datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[FG_ExtendedFormElements]
		SET LastModifierUserID = @LastModifierUserID,
			LastModificationDate = @LastModificationDate,
			Deleted = 1
	WHERE ApplicationID = @ApplicationID AND ElementID = @ElementID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[FG_SaveFormElements]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[FG_SaveFormElements]
GO

CREATE PROCEDURE [dbo].[FG_SaveFormElements]
	@ApplicationID	uniqueidentifier,
	@FormID			uniqueidentifier,
	@Title			nvarchar(255),
	@Name			varchar(100),
	@Description	nvarchar(2000),
	@ElementsTemp	FormElementTableType readonly,
	@CurrentUserID	uniqueidentifier,
	@Now			datetime
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @Elements FormElementTableType
	INSERT INTO @Elements SELECT * FROM @ElementsTemp
	
	-- Update Form
	SET @Title = [dbo].[GFN_VerifyString](LTRIM(RTRIM(ISNULL(@Title, N''))))
	SET @Name = LTRIM(RTRIM(ISNULL(@Name, '')))
	SET @Description = [dbo].[GFN_VerifyString](LTRIM(RTRIM(ISNULL(@Description, N''))))
	
	UPDATE [dbo].[FG_ExtendedForms]
		SET Title = CASE WHEN @Title = N'' THEN Title ELSE @Title END,
			Name = CASE WHEN @Name = N'' THEN Name ELSE @Name END,
			[Description] = CASE WHEN @Description = N'' THEN [Description] ELSE @Description END
	WHERE ApplicationID = @ApplicationID AND FormID = @FormID
	-- end of Update Form
	
	
	-- Update Existing Data
	UPDATE X
		SET	Title = CASE WHEN E.ElementID IS NULL THEN X.Title ELSE E.Title END,
			Info = CASE WHEN E.ElementID IS NULL THEN X.Info ELSE E.Info END,
			SequenceNumber = CASE WHEN E.ElementID IS NULL THEN X.SequenceNumber ELSE E.SequenceNubmer END,
			LastModifierUserID = CASE WHEN E.ElementID IS NULL THEN X.LastModifierUserID ELSE @CurrentUserID END,
			LastModificationDate = CASE WHEN E.ElementID IS NULL THEN X.LastModificationDate ELSE @Now END,
			Deleted = CASE WHEN E.ElementID IS NULL THEN 1 ELSE 0 END,
			Necessary = CASE WHEN E.ElementID IS NULL THEN X.Necessary ELSE E.Necessary END,
			[Weight] = CASE WHEN E.ElementID IS NULL THEN X.[Weight] ELSE E.[Weight] END,
			Name = CASE WHEN E.ElementID IS NULL THEN X.Name ELSE E.Name END,
			UniqueValue = CASE WHEN E.ElementID IS NULL THEN X.UniqueValue ELSE E.UniqueValue END,
			Help = CASE WHEN E.ElementID IS NULL THEN X.Help ELSE E.Help END
	FROM [dbo].[FG_ExtendedFormElements] AS X
		LEFT JOIN @Elements AS E
		ON E.ElementID = X.ElementID
	WHERE X.ApplicationID = @ApplicationID AND X.FormID = @FormID
	-- end of Update Existing Data
	
	-- Insert New Data
	INSERT INTO [dbo].[FG_ExtendedFormElements] (
		ApplicationID,
		ElementID,
		TemplateElementID,
		FormID,
		Title,
		[Type],
		Info,
		SequenceNumber,
		CreatorUserID,
		CreationDate,
		Deleted,
		Necessary,
		[Weight],
		Name,
		UniqueValue,
		Help
	)
	SELECT	@ApplicationID,
			E.ElementID,
			E.TemplateElementID,
			@FormID,
			E.Title,
			E.[Type],
			E.Info,
			E.SequenceNubmer,
			@CurrentUserID,
			@Now,
			0,
			E.Necessary,
			E.[Weight],
			E.Name,
			E.UniqueValue,
			E.Help
	FROM @Elements AS E
		LEFT JOIN [dbo].[FG_ExtendedFormElements] AS X
		ON X.ApplicationID = @ApplicationID AND X.ElementID = E.ElementID
	WHERE X.ElementID IS NULL
	-- end of Insert New Data
	
	SELECT 1
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[FG_P_GetFormElements]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[FG_P_GetFormElements]
GO

CREATE PROCEDURE [dbo].[FG_P_GetFormElements]
	@ApplicationID	uniqueidentifier,
	@ElementIDsTemp	GuidTableType readonly
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @ElementIDs GuidTableType
	INSERT INTO @ElementIDs SELECT * FROM @ElementIDsTemp
	
	SELECT FE.ElementID,
		   FE.FormID,
		   FE.Title,
		   FE.Name,
		   FE.Help,
		   ISNULL(FE.Necessary, CAST(0 AS bit)) AS Necessary,
		   ISNULL(FE.UniqueValue, CAST(0 AS bit)) AS UniqueValue,
		   FE.SequenceNumber,
		   FE.[Type],
		   FE.Info,
		   FE.[Weight]
	FROM @ElementIDs AS Ref
		INNER JOIN [dbo].[FG_ExtendedFormElements] AS FE
		ON FE.ApplicationID = @ApplicationID AND FE.ElementID = Ref.Value
	ORDER BY FE.SequenceNumber ASC
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[FG_GetFormElementsByIDs]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[FG_GetFormElementsByIDs]
GO

CREATE PROCEDURE [dbo].[FG_GetFormElementsByIDs]
	@ApplicationID	uniqueidentifier,
	@strElementIDs	varchar(max),
	@delimiter		char
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @ElementIDs GuidTableType
	
	INSERT INTO @ElementIDs
	SELECT Ref.Value
	FROM [dbo].[GFN_StrToGuidTable](@strElementIDs, @delimiter) AS Ref
	
	EXEC [dbo].[FG_P_GetFormElements] @ApplicationID, @ElementIDs
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[FG_GetFormElements]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[FG_GetFormElements]
GO

CREATE PROCEDURE [dbo].[FG_GetFormElements]	
	@ApplicationID	uniqueidentifier,
	@FormID			uniqueidentifier,
	@OwnerID		uniqueidentifier,
	@Type			varchar(50)
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	IF @FormID IS NULL AND @OwnerID IS NOT NULL BEGIN
		SELECT TOP(1) @FormID = FormID
		FROM [dbo].[FG_FormOwners] 
		WHERE ApplicationID = @ApplicationID AND 
			OwnerID = @OwnerID AND Deleted = 0
	END
	
	DECLARE @ElementIDs GuidTableType
	
	INSERT INTO @ElementIDs
	SELECT ElementID
	FROM [dbo].[FG_ExtendedFormElements]
	WHERE ApplicationID = @ApplicationID AND FormID = @FormID AND 
		(@Type IS NULL OR [Type] = @Type) AND Deleted = 0
	
	EXEC [dbo].[FG_P_GetFormElements] @ApplicationID, @ElementIDs
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[FG_GetFormElementIDs]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[FG_GetFormElementIDs]
GO

CREATE PROCEDURE [dbo].[FG_GetFormElementIDs]	
	@ApplicationID		uniqueidentifier,
	@FormID				uniqueidentifier,
	@strElementNames	nvarchar(max),
	@delimiter			char
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @Names StringTableType
	
	INSERT INTO @Names (Value)
	SELECT DISTINCT LOWER(Ref.Value)
	FROM [dbo].[GFN_StrToStringTable](@strElementNames, @delimiter) AS Ref
	WHERE ISNULL(Ref.Value, N'') <> N''
	
	SELECT E.Name, E.ElementID
	FROM @Names AS N
		INNER JOIN [dbo].[FG_ExtendedFormElements] AS E
		ON E.ApplicationID = @ApplicationID AND E.FormID = @FormID AND 
			LOWER(ISNULL(E.Name, N'')) = N.Value
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[FG_IsFormElement]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[FG_IsFormElement]
GO

CREATE PROCEDURE [dbo].[FG_IsFormElement]
	@ApplicationID	uniqueidentifier,
	@strIDs			varchar(max),
	@delimiter		char
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT Ref.Value AS ID
	FROM [dbo].[GFN_StrToGuidTable](@strIDs, @delimiter) AS Ref
		INNER JOIN [dbo].[FG_ExtendedFormElements] AS E
		ON E.ApplicationID = @ApplicationID AND E.ElementID = Ref.Value
		
	UNION
	
	SELECT Ref.Value AS ID
	FROM [dbo].[GFN_StrToGuidTable](@strIDs, @delimiter) AS Ref
		INNER JOIN [dbo].[FG_InstanceElements] AS E
		ON E.ApplicationID = @ApplicationID AND E.ElementID = Ref.Value
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[FG_P_CreateFormInstance]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[FG_P_CreateFormInstance]
GO

CREATE PROCEDURE [dbo].[FG_P_CreateFormInstance]
	@ApplicationID	uniqueidentifier,
	@InstancesTemp	FormInstanceTableType readonly,
	@CreatorUserID	uniqueidentifier,
	@CreationDate	datetime,
	@_Result		int output
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @Instances FormInstanceTableType
	INSERT INTO @Instances SELECT * FROM @InstancesTemp
	
	INSERT INTO [dbo].[FG_FormInstances](
		ApplicationID,
		InstanceID,
		FormID,
		OwnerID,
		DirectorID,
		[Admin],
		Filled,
		IsTemporary,
		CreatorUserID,
		CreationDate,
		Deleted
	)
	SELECT	@ApplicationID, 
			I.InstanceID, 
			I.FormID, 
			I.OwnerID, 
			I.DirectorID, 
			ISNULL(I.[Admin], 0), 
			0,
			I.IsTemporary,
			@CreatorUserID, 
			@CreationDate, 
			0
	FROM @Instances AS I
	
	SET @_Result = @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[FG_CreateFormInstance]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[FG_CreateFormInstance]
GO

CREATE PROCEDURE [dbo].[FG_CreateFormInstance]
	@ApplicationID	uniqueidentifier,
	@InstancesTemp	FormInstanceTableType readonly,
	@CreatorUserID	uniqueidentifier,
	@CreationDate	datetime
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @Instances FormInstanceTableType
	INSERT INTO @Instances SELECT * FROM @InstancesTemp
	
	DECLARE @_Result int
	
	EXEC [dbo].[FG_P_CreateFormInstance] @ApplicationID, @Instances, @CreatorUserID, @CreationDate, @_Result output
		
	SELECT @_Result
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[FG_P_CopyFormInstances]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[FG_P_CopyFormInstances]
GO

CREATE PROCEDURE [dbo].[FG_P_CopyFormInstances]
	@ApplicationID	uniqueidentifier,
	@OldOwnerID		uniqueidentifier,
	@NewOwnerID		uniqueidentifier,
	@NewFormID		uniqueidentifier,
	@CreatorUserID	uniqueidentifier,
	@CreationDate	datetime,
	@_Result		int output
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	IF EXISTS(
		SELECT TOP(1) * 
		FROM [dbo].[FG_FormInstances]
		WHERE ApplicationID = @ApplicationID AND OwnerID = @OldOwnerID AND Deleted = 0
	) BEGIN
		INSERT INTO [dbo].[FG_FormInstances](
			ApplicationID,
			InstanceID,
			FormID,
			OwnerID,
			DirectorID,
			Filled,
			CreatorUserID,
			CreationDate,
			Deleted
		)
		SELECT	@ApplicationID,
				NEWID(),
				ISNULL(@NewFormID, FormID),
				@NewOwnerID,
				DirectorID,
				0,
				@CreatorUserID,
				@CreationDate,
				0
		FROM [dbo].[FG_FormInstances]
		WHERE ApplicationID = @ApplicationID AND OwnerID = @OldOwnerID AND Deleted = 0
		
		SET @_Result = @@ROWCOUNT	
	END
	ELSE
		SET @_Result = 1
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[FG_P_RemoveFormInstances]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[FG_P_RemoveFormInstances]
GO

CREATE PROCEDURE [dbo].[FG_P_RemoveFormInstances]
	@ApplicationID		uniqueidentifier,
	@InstanceIDsTemp	GuidTableType readonly,
	@CurrentUserID		uniqueidentifier,
	@Now				datetime,
	@_Result			int output
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @InstanceIDs GuidTableType
	INSERT INTO @InstanceIDs SELECT * FROM @InstanceIDsTemp
	
	UPDATE FI
		SET Deleted = 1,
			LastModifierUserID = @CurrentUserID,
			LastModificationDate = @Now
	FROM @InstanceIDs AS ExternalIDs
		INNER JOIN [dbo].[FG_FormInstances] AS FI
		ON FI.[InstanceID] = ExternalIDs.Value
	WHERE FI.ApplicationID = @ApplicationID AND FI.[Deleted] = 0
	
	SET @_Result = @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[FG_RemoveFormInstances]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[FG_RemoveFormInstances]
GO

CREATE PROCEDURE [dbo].[FG_RemoveFormInstances]
	@ApplicationID	uniqueidentifier,
	@strInstanceIDs	varchar(max),
	@delimiter		char,
	@CurrentUserID	uniqueidentifier,
	@Now			datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @InstanceIDs GuidTableType
	INSERT INTO @InstanceIDs
	SELECT DISTINCT Ref.Value FROM [dbo].[GFN_StrToGuidTable](@strInstanceIDs, @delimiter) AS Ref
	
	DECLARE @_Result int = 0
	
	EXEC [dbo].[FG_P_RemoveFormInstances] @ApplicationID, @InstanceIDs, @CurrentUserID, @Now, @_Result output 
	
	SELECT @_Result
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[FG_RemoveOwnerFormInstances]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[FG_RemoveOwnerFormInstances]
GO

CREATE PROCEDURE [dbo].[FG_RemoveOwnerFormInstances]
	@ApplicationID	uniqueidentifier,
	@OwnerID		uniqueidentifier,
	@FormID			uniqueidentifier,
	@CurrentUserID	uniqueidentifier,
	@Now			datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @InstanceIDs GuidTableType
	
	INSERT INTO @InstanceIDs (Value)
	SELECT I.InstanceID
	FROM [dbo].[FG_FormInstances] AS I
	WHERE I.ApplicationID = @ApplicationID AND I.FormID = @FormID AND 
		I.OwnerID = @OwnerID AND I.Deleted = 0
	
	DECLARE @_Result int = 0
	
	EXEC [dbo].[FG_P_RemoveFormInstances] @ApplicationID, @InstanceIDs, @CurrentUserID, @Now, @_Result output 
	
	SELECT @_Result
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[FG_P_GetFormInstancesByIDs]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[FG_P_GetFormInstancesByIDs]
GO

CREATE PROCEDURE [dbo].[FG_P_GetFormInstancesByIDs]
	@ApplicationID		uniqueidentifier,
	@InstanceIDsTemp	GuidTableType readonly
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @InstanceIDs GuidTableType
	INSERT INTO @InstanceIDs SELECT * FROM @InstanceIDsTemp
	
	SELECT FI.InstanceID AS InstanceID,
		   FI.FormID AS FormID,
		   FI.OwnerID AS OwnerID,
		   FI.DirectorID AS DirectorID,
		   FI.Filled AS Filled,
		   FI.FillingDate AS FillingDate,
		   EF.Title AS FormTitle,
		   EF.[Description] AS [Description],
		   FI.CreatorUserID AS CreatorUserID,
		   UN.UserName AS CreatorUserName,
		   UN.FirstName AS CreatorFirstName,
		   UN.LastName AS CreatorLastName
	FROM @InstanceIDs AS ExternalIDs
		INNER JOIN [dbo].[FG_FormInstances] AS FI
		ON FI.ApplicationID = @ApplicationID AND FI.InstanceID = ExternalIDs.Value
		INNER JOIN [dbo].[FG_ExtendedForms] AS EF
		ON EF.ApplicationID = @ApplicationID AND EF.FormID = FI.FormID
		LEFT JOIN [dbo].[Users_Normal] AS UN
		ON UN.ApplicationID = @ApplicationID AND UN.UserID = FI.CreatorUserID
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[FG_P_GetOwnerFormInstances]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[FG_P_GetOwnerFormInstances]
GO

CREATE PROCEDURE [dbo].[FG_P_GetOwnerFormInstances]
	@ApplicationID	uniqueidentifier,
	@OwnerIDsTemp	GuidTableType readonly,
	@FormID			uniqueidentifier,
	@IsTemporary	bit,
	@CreatorUserID	uniqueidentifier
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @OwnerIDs GuidTableType
	INSERT INTO @OwnerIDs SELECT * FROM @OwnerIDsTemp
	
	DECLARE @InstanceIDs GuidTableType
	
	INSERT INTO @InstanceIDs
	SELECT X.InstanceID
	FROM [dbo].[FG_FN_GetOwnerFormInstanceIDs](@ApplicationID, @OwnerIDs, @FormID, @IsTemporary, @CreatorUserID) AS X
	
	EXEC [dbo].[FG_P_GetFormInstancesByIDs] @ApplicationID, @InstanceIDs
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[FG_GetOwnerFormInstances]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[FG_GetOwnerFormInstances]
GO

CREATE PROCEDURE [dbo].[FG_GetOwnerFormInstances]
	@ApplicationID	uniqueidentifier,
	@strOwnerIDs	varchar(max),
	@delimiter		char,
	@FormID			uniqueidentifier,
	@IsTemporary	bit,
	@CreatorUserID	uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @OwnerIDs GuidTableType
	INSERT INTO @OwnerIDs
	SELECT DISTINCT Ref.Value FROM [dbo].[GFN_StrToGuidTable](@strOwnerIDs, @delimiter) AS Ref
	
	EXEC [dbo].[FG_P_GetOwnerFormInstances] @ApplicationID, @OwnerIDs, @FormID, @IsTemporary, @CreatorUserID
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[FG_GetFormInstanceOwnerID]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[FG_GetFormInstanceOwnerID]
GO

CREATE PROCEDURE [dbo].[FG_GetFormInstanceOwnerID]
	@ApplicationID			uniqueidentifier,
	@InstanceIDOrElementID	uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @OwnerID uniqueidentifier
	
	SELECT TOP(1) @OwnerID = FI.OwnerID
	FROM [dbo].[FG_FormInstances] AS FI
	WHERE FI.ApplicationID = @ApplicationID AND 
		FI.InstanceID = @InstanceIDOrElementID
	
	IF @OwnerID IS NULL BEGIN
		SELECT TOP(1) @OwnerID = FI.OwnerID
		FROM [dbo].[FG_InstanceElements] AS IE
			INNER JOIN [dbo].[FG_FormInstances] AS FI
			ON FI.ApplicationID = @ApplicationID AND FI.InstanceID = IE.InstanceID
		WHERE IE.ApplicationID = @ApplicationID AND 
			IE.ElementID = @InstanceIDOrElementID
	END
	
	SELECT @OwnerID
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[FG_GetFormInstanceHierarchyOwnerID]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[FG_GetFormInstanceHierarchyOwnerID]
GO

CREATE PROCEDURE [dbo].[FG_GetFormInstanceHierarchyOwnerID]
	@ApplicationID	uniqueidentifier,
	@InstanceID		uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	;WITH hierarchy (OwnerID, [Level])
	AS
	(
		SELECT I.OwnerID, 0 AS [Level]
		FROM [dbo].[FG_FormInstances] AS I
		WHERE I.ApplicationID = @ApplicationID AND I.InstanceID = @InstanceID
		
		UNION ALL
		
		SELECT I.OwnerID, [Level] + 1
		FROM hierarchy AS HR
			INNER JOIN [dbo].[FG_InstanceElements] AS E
			ON E.ApplicationID = @ApplicationID AND E.ElementID = HR.OwnerID
			INNER JOIN [dbo].[FG_FormInstances] AS I
			ON I.ApplicationID = @ApplicationID AND I.InstanceID = E.InstanceID
		WHERE HR.OwnerID IS NOT NULL AND I.OwnerID <> HR.OwnerID
	)

	SELECT TOP(1) HR.OwnerID AS ID
	FROM hierarchy AS HR
		INNER JOIN (
			SELECT TOP(1) MAX([Level]) AS [Level]
			FROM hierarchy
		) AS A
		ON A.[Level] = HR.[Level]
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[FG_ValidateNewName]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[FG_ValidateNewName]
GO

CREATE PROCEDURE [dbo].[FG_ValidateNewName]
	@ApplicationID	uniqueidentifier,
	@ObjectID		uniqueidentifier,
	@FormID			uniqueidentifier,
	@Name			varchar(100)
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT [dbo].[FG_FN_ValidateNewName](@ApplicationID, @ObjectID, @FormID, @Name) AS Value
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[FG_MeetsUniqueConstraint]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[FG_MeetsUniqueConstraint]
GO

CREATE PROCEDURE [dbo].[FG_MeetsUniqueConstraint]
	@ApplicationID	uniqueidentifier,
	@InstanceID		uniqueidentifier,
	@ElementID		uniqueidentifier,
	@TextValue		nvarchar(max),
	@FloatValue		float
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @RefElementID uniqueidentifier = (
		SELECT TOP(1) E.RefElementID
		FROM [dbo].[FG_InstanceElements] AS E
		WHERE E.ApplicationID = @ApplicationID AND E.ElementID = @ElementID
	)
	
	DECLARE @Elements FormElementTableType
	
	INSERT INTO @Elements (ElementID, InstanceID, RefElementID, TextValue, FloatValue, SequenceNubmer, [Type])
	SELECT @ElementID, @InstanceID, @RefElementID, @TextValue, @FloatValue, 0, N''
	
	SELECT TOP(1) 1
	WHERE @InstanceID IS NOT NULL AND ((ISNULL(@TextValue, N'') = N'' AND @FloatValue IS NULL) OR NOT EXISTS (
			SELECT TOP(1) X.ElementID
			FROM [dbo].[FG_FN_CheckUniqueConstraint](@ApplicationID, @Elements) AS X
		))
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[FG_SaveFormInstanceElements]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[FG_SaveFormInstanceElements]
GO

CREATE PROCEDURE [dbo].[FG_SaveFormInstanceElements]
	@ApplicationID			uniqueidentifier,
	@ElementsTemp			FormElementTableType readonly,
	@GuidItemsTemp			GuidPairTableType readonly,
	@ElementsToClearTemp	GuidTableType readonly,
	@FilesTemp				DocFileInfoTableType readonly,
	@CreatorUserID			uniqueidentifier,
	@CreationDate			datetime
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @Elements FormElementTableType
	INSERT INTO @Elements SELECT * FROM @ElementsTemp
	
	DECLARE @GuidItems GuidPairTableType
	INSERT INTO @GuidItems SELECT * FROM @GuidItemsTemp
	
	DECLARE @ElementsToClear GuidTableType
	INSERT INTO @ElementsToClear SELECT * FROM @ElementsToClearTemp
	
	DECLARE @Files DocFileInfoTableType
	INSERT INTO @Files SELECT * FROM @FilesTemp
	
	IF EXISTS(
		SELECT TOP(1) *
		FROM [dbo].[FG_FN_CheckUniqueConstraint](@ApplicationID, @Elements) AS Ref
	) BEGIN
		SELECT -1, N'UniqueConstriantHasNotBeenMet'
		RETURN
	END
	
	-- Find Main ElementIDs
	DECLARE @MainElementIDs TABLE (ElementID uniqueidentifier, MainElementID uniqueidentifier)
	
	INSERT INTO @MainElementIDs (ElementID, MainElementID)
	SELECT DISTINCT Ref.ElementID, IE1.ElementID
	FROM @Elements AS Ref
		LEFT JOIN [dbo].[FG_InstanceElements] AS IE
		ON IE.ApplicationID = @ApplicationID AND IE.[ElementID] = Ref.ElementID
		INNER JOIN [dbo].[FG_InstanceElements] AS IE1
		ON IE1.ApplicationID = @ApplicationID AND
			Ref.RefElementID IS NOT NULL AND Ref.InstanceID IS NOT NULL AND
			IE1.RefElementID = Ref.RefElementID AND IE1.InstanceID = Ref.InstanceID
	WHERE IE.ElementID IS NULL
	
	/*
	UPDATE E
		SET ElementID = M.MainElementID
	FROM @Elements AS E
		INNER JOIN @MainElementIDs AS M
		ON M.ElementID = E.ElementID
	*/
		
	UPDATE E
		SET FirstValue = M.MainElementID
	FROM @GuidItems AS E
		INNER JOIN @MainElementIDs AS M
		ON M.ElementID = E.FirstValue
	-- end of Find Main ElementIDs
	
	
	-- Save Changes
	INSERT INTO [dbo].[FG_Changes] (ApplicationID, ElementID, TextValue, 
		FloatValue, BitValue, DateValue, CreatorUserID, CreationDate, Deleted)
	SELECT @ApplicationID, ISNULL(E.ElementID, X.ElementID), [dbo].[GFN_VerifyString](X.TextValue), 
		X.FloatValue, X.BitValue, X.DateValue, @CreatorUserID, @CreationDate, 0
	FROM (
			SELECT	C.Value AS ElementID, 
					I.RefElementID AS RefElementID,
					I.InstanceID,
					CAST(NULL AS varchar(max)) AS TextValue,
					CAST(NULL AS float) AS FloatValue,
					CAST(NULL AS bit) AS BitValue,
					CAST(NULL AS datetime) AS DateValue
			FROM @ElementsToClear AS C
				LEFT JOIN @Elements AS E
				ON E.ElementID = C.Value
				INNER JOIN [dbo].[FG_InstanceElements] AS I
				ON I.ApplicationID = @ApplicationID AND I.ElementID = C.Value
			WHERE E.ElementID IS NULL
			
			UNION ALL
			
			SELECT E.ElementID, E.RefElementID, E.InstanceID,
				E.TextValue, E.FloatValue, E.BitValue, E.DateValue
			FROM @Elements AS E
		) AS X
		LEFT JOIN [dbo].[FG_InstanceElements] AS E -- First part checks ElementID. We split them for performance reasons
		ON E.ApplicationID = @ApplicationID AND E.ElementID = X.ElementID
		LEFT JOIN [dbo].[FG_InstanceElements] AS E1 -- Second part checks InstanceID and RefElementID
		ON E1.ApplicationID = @ApplicationID AND
			X.RefElementID IS NOT NULL AND X.InstanceID IS NOT NULL AND 
			E1.RefElementID = X.RefElementID AND E1.InstanceID = X.InstanceID
	WHERE (ISNULL(E.ElementID, E1.ElementID) IS NULL AND 
			NOT (X.TextValue IS NULL AND X.FloatValue IS NULL AND
				X.BitValue IS NULL AND X.DateValue IS NULL
			)
		) OR 
		(X.TextValue IS NULL AND ISNULL(E.TextValue, E1.TextValue) IS NOT NULL) OR
		(X.TextValue IS NOT NULL AND ISNULL(E.TextValue, E1.TextValue) IS NULL) OR
		(X.TextValue IS NOT NULL AND ISNULL(E.TextValue, E1.TextValue) IS NOT NULL AND 
			X.TextValue <> ISNULL(E.TextValue, E1.TextValue)) OR
		(X.FloatValue IS NULL AND ISNULL(E.FloatValue, E1.FloatValue) IS NOT NULL) OR
		(X.FloatValue IS NOT NULL AND ISNULL(E.FloatValue, E1.FloatValue) IS NULL) OR
		(X.FloatValue IS NOT NULL AND ISNULL(E.FloatValue, E1.FloatValue) IS NOT NULL AND 
			X.FloatValue <> ISNULL(E.FloatValue, E1.FloatValue)) OR
		(X.BitValue IS NULL AND ISNULL(E.BitValue, E1.BitValue) IS NOT NULL) OR
		(X.BitValue IS NOT NULL AND ISNULL(E.BitValue, E1.BitValue) IS NULL) OR
		(X.BitValue IS NOT NULL AND ISNULL(E.BitValue, E1.BitValue) IS NOT NULL AND 
			X.BitValue <> ISNULL(E.BitValue, E1.BitValue)) OR
		(X.DateValue IS NULL AND ISNULL(E.DateValue, E1.DateValue) IS NOT NULL) OR
		(X.DateValue IS NOT NULL AND ISNULL(E.DateValue, E1.DateValue) IS NULL) OR
		(X.DateValue IS NOT NULL AND ISNULL(E.DateValue, E1.DateValue) IS NOT NULL AND 
			X.DateValue <> ISNULL(E.DateValue, E1.DateValue))
	-- end of Save Changes

	-- Update Existing Data
	-- A: Update based on ElementID. We split them for performance reasons
	UPDATE IE
		SET TextValue = [dbo].[GFN_VerifyString](Ref.TextValue),
			FloatValue = Ref.FloatValue,
			BitValue = Ref.BitValue,
			DateValue = Ref.DateValue,
			LastModifierUserID = @CreatorUserID,
			LastModificationDate = @CreationDate,
			Deleted = 0
	FROM @Elements AS Ref
		INNER JOIN [dbo].[FG_InstanceElements] AS IE
		ON IE.ApplicationID = @ApplicationID AND IE.[ElementID] = Ref.ElementID
	
	-- B: Update based on RefElementID and InstanceID
	UPDATE IE
		SET TextValue = [dbo].[GFN_VerifyString](Ref.TextValue),
			FloatValue = Ref.FloatValue,
			BitValue = Ref.BitValue,
			DateValue = Ref.DateValue,
			LastModifierUserID = @CreatorUserID,
			LastModificationDate = @CreationDate,
			Deleted = 0
	FROM @Elements AS Ref
		INNER JOIN [dbo].[FG_InstanceElements] AS IE
		ON IE.ApplicationID = @ApplicationID AND
			IE.RefElementID = Ref.RefElementID AND IE.InstanceID = Ref.InstanceID
	-- end of Update Existing Data
	
	DECLARE @Count int = @@ROWCOUNT
	
	-- Clear Empty Elements
	UPDATE IE
		SET TextValue = NULL,
			FloatValue = NULL,
			BitValue = NULL,
			DateValue = NULL,
			LastModifierUserID = @CreatorUserID,
			LastModificationDate = @CreationDate,
			Deleted = 0
	FROM @ElementsToClear AS Ref
		INNER JOIN [dbo].[FG_InstanceElements] AS IE
		ON IE.ApplicationID = @ApplicationID AND IE.[ElementID] = Ref.Value
		
	SET @Count = @@ROWCOUNT + @Count
	
	DECLARE @FileOwnerIDs GuidTableType
	DECLARE @_Result int = 0
	
	INSERT INTO @FileOwnerIDs (Value)
	SELECT DISTINCT OwnerIDs.Value
	FROM (
			SELECT C.Value
			FROM @ElementsToClear AS C
			
			UNION ALL 
			
			SELECT F.OwnerID
			FROM @Files AS F
		) AS OwnerIDs
		
	EXEC [dbo].[DCT_P_RemoveOwnersFiles] @ApplicationID, @FileOwnerIDs, @_Result output
	-- end of Clear Empty Elements
	
	INSERT INTO [dbo].[FG_InstanceElements](
		ApplicationID,
		ElementID,
		InstanceID,
		RefElementID,
		Title,
		SequenceNumber,
		[Type],
		Info,
		TextValue,
		FloatValue,
		BitValue,
		DateValue,
		CreatorUserID,
		CreationDate,
		Deleted
	)
	SELECT @ApplicationID,
		   Ref.ElementID,
		   Ref.InstanceID,
		   Ref.RefElementID,
		   EFE.Title,
		   ISNULL(EFE.SequenceNumber, Ref.SequenceNubmer),
		   EFE.[Type],
		   EFE.Info,
		   [dbo].[GFN_VerifyString](Ref.TextValue),
		   Ref.FloatValue,
		   Ref.BitValue,
		   Ref.DateValue,
		   @CreatorUserID,
		   @CreationDate,
		   0
	FROM @Elements AS Ref
		INNER JOIN [dbo].[FG_ExtendedFormElements] AS EFE
		ON EFE.ApplicationID = @ApplicationID AND EFE.ElementID = Ref.RefElementID
		LEFT JOIN [dbo].[FG_InstanceElements] AS IE
		ON IE.ApplicationID = @ApplicationID AND IE.[ElementID] = Ref.ElementID
		LEFT JOIN [dbo].[FG_InstanceElements] AS IE1
		ON IE1.ApplicationID = @ApplicationID AND
			IE1.RefElementID = Ref.RefElementID AND IE1.InstanceID = Ref.InstanceID
	WHERE ISNULL(IE.ElementID, IE1.ElementID) IS NULL
	
	SET @Count = @@ROWCOUNT + @Count + 1
	
	EXEC [dbo].[DCT_P_AddFiles] @ApplicationID, NULL, NULL, @Files, @CreatorUserID, @CreationDate, @_Result output
	
	-- Set Selected Guids
	UPDATE S
		SET Deleted = 1,
			LastModifierUserID = @CreatorUserID,
			LastModificationDate = @CreationDate
	FROM (
			SELECT DISTINCT A.ElementID
			FROM @Elements AS A
			
			UNION
			
			SELECT DISTINCT C.Value
			FROM @ElementsToClear AS C
		) AS E
		INNER JOIN [dbo].[FG_SelectedItems] AS S
		ON S.ApplicationID = @ApplicationID AND S.ElementID = E.ElementID
	
	UPDATE S
		SET Deleted = 0,
			LastModifierUserID = @CreatorUserID,
			LastModificationDate = @CreationDate
	FROM @GuidItems AS G
		INNER JOIN [dbo].[FG_SelectedItems] AS S
		ON S.ApplicationID = @ApplicationID AND 
			S.ElementID = G.FirstValue AND S.SelectedID = G.SecondValue
	
	INSERT INTO [dbo].[FG_SelectedItems] (ApplicationID, ElementID, 
		SelectedID, LastModifierUserID, LastModificationDate, Deleted)
	SELECT @ApplicationID, G.FirstValue, G.SecondValue, @CreatorUserID, @CreationDate, 0
	FROM @GuidItems AS G
		INNER JOIN [dbo].[FG_InstanceElements] AS E
		ON E.ApplicationID = @ApplicationID AND E.ElementID = G.FirstValue
		LEFT JOIN [dbo].[FG_SelectedItems] AS S
		ON S.ApplicationID = @ApplicationID AND 
			S.ElementID = G.FirstValue AND S.SelectedID = G.SecondValue
	WHERE S.ElementID IS NULL
	-- end of Set Selected Guids
	
	SELECT @Count
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[FG_GetFormInstances]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[FG_GetFormInstances]
GO

CREATE PROCEDURE [dbo].[FG_GetFormInstances]
	@ApplicationID		uniqueidentifier,
	@strInstanceIDs		varchar(max),
	@delimiter			char
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @InstanceIDs GuidTableType
	INSERT INTO @InstanceIDs
	SELECT DISTINCT Ref.Value FROM [dbo].[GFN_StrToGuidTable](@strInstanceIDs, @delimiter) AS Ref
	
	EXEC [dbo].[FG_P_GetFormInstancesByIDs] @ApplicationID, @InstanceIDs
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[FG_GetFormInstanceElements]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[FG_GetFormInstanceElements]
GO

CREATE PROCEDURE [dbo].[FG_GetFormInstanceElements]
	@ApplicationID	uniqueidentifier,
	@strInstanceIDs	varchar(max),
	@Filled			bit,
	@strElementIDs	varchar(max),
	@delimiter		char
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @InstanceIDs GuidTableType
	
	INSERT INTO @InstanceIDs (Value)
	SELECT DISTINCT Ref.Value
	FROM [dbo].[GFN_StrToGuidTable](@strInstanceIDs, @delimiter) AS Ref
	
	DECLARE @ElementIDs GuidTableType
	INSERT INTO @ElementIDs
	SELECT Ref.Value FROM [dbo].[GFN_StrToGuidTable](@strElementIDs, @delimiter) AS Ref
	
	DECLARE @ELCount int = (SELECT COUNT(*) FROM @ElementIDs)
	
	SELECT	IE.ElementID,
			IE.InstanceID,
			IE.RefElementID,
			ISNULL(EFE.Title, IE.Title) AS Title,
			EFE.Name,
			EFE.Help,
			EFE.SequenceNumber,
			EFE.[Type],
			ISNULL(EFE.Info, IE.Info) AS Info,
			EFE.[Weight],
			IE.TextValue,
			IE.FloatValue,
			IE.BitValue,
			IE.DateValue,
			CAST(1 AS bit) AS Filled,
			ISNULL(EFE.Necessary, 0) AS Necessary,
			EFE.UniqueValue,
			CAST((
				SELECT COUNT(C.ID)
				FROM [dbo].[FG_Changes] AS C
				WHERE C.ApplicationID = @ApplicationID AND C.ElementID = IE.ElementID AND Deleted = 0
			) AS int) AS EditionsCount,
			UN.UserID AS CreatorUserID,
			UN.UserName AS CreatorUserName,
			UN.FirstName AS CreatorFirstName,
			UN.LastName AS CreatorLastName
	FROM @InstanceIDs AS INS
		INNER JOIN [dbo].[FG_InstanceElements] AS IE
		ON IE.ApplicationID = @ApplicationID AND IE.InstanceID = INS.Value
		LEFT JOIN [dbo].[FG_ExtendedFormElements] AS EFE
		ON EFE.ApplicationID = @ApplicationID AND EFE.ElementID = IE.RefElementID
		LEFT JOIN [dbo].[Users_Normal] AS UN
		ON UN.ApplicationID = @ApplicationID AND UN.UserID = IE.CreatorUserID
	WHERE (@Filled IS NULL OR @Filled = 1) AND IE.Deleted = 0 AND
		(@ELCount = 0 OR IE.ElementID IN (SELECT Ref.Value FROM @ElementIDs AS Ref))
	
	UNION ALL
	
	SELECT	EFE.ElementID,
			FI.InstanceID,
			NULL AS RefElementID,
			EFE.Title,
			EFE.Name,
			EFE.Help,
			EFE.SequenceNumber,
			EFE.[Type],
			EFE.Info,
			EFE.[Weight],
			NULL AS TextValue,
			NULL AS FloatValue,
			NULL AS BitValue,
			NULL AS DateValue,
			CAST(0 AS bit) AS Filled,
			ISNULL(EFE.Necessary, 0) AS Necessary,
			EFE.UniqueValue,
			CAST(0 AS int) AS EditionsCount,
			NULL AS CreatorUserID,
			NULL AS CreatorUserName,
			NULL AS CreatorFirstName,
			NULL AS CreatorLastName
	FROM @InstanceIDs AS INS
		INNER JOIN [dbo].[FG_FormInstances] AS FI
		ON FI.ApplicationID = @ApplicationID AND FI.InstanceID = INS.Value
		INNER JOIN [FG_ExtendedFormElements] AS EFE
		ON EFE.ApplicationID = @ApplicationID AND EFE.FormID = FI.FormID
		LEFT JOIN [dbo].[FG_InstanceElements] AS IE
		ON IE.ApplicationID = @ApplicationID AND IE.InstanceID = FI.InstanceID AND 
			IE.RefElementID = EFE.ElementID AND IE.Deleted = 0
	WHERE IE.ElementID IS NULL AND (@Filled IS NULL OR @Filled = 0) AND EFE.Deleted = 0 AND
		(@ELCount = 0 OR EFE.ElementID IN (SELECT Ref.Value FROM @ElementIDs AS Ref))
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[FG_GetSelectedGuids]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[FG_GetSelectedGuids]
GO

CREATE PROCEDURE [dbo].[FG_GetSelectedGuids]
	@ApplicationID	uniqueidentifier,
	@strElementIDs	varchar(max),
	@delimiter		char
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @ElementIDs GuidTableType
	INSERT INTO @ElementIDs
	SELECT Ref.Value FROM [dbo].[GFN_StrToGuidTable](@strElementIDs, @delimiter) AS Ref

	SELECT	S.ElementID,
			S.SelectedID AS ID,
			CASE
				WHEN ND.NodeID IS NOT NULL THEN ND.Name
				ELSE LTRIM(RTRIM(ISNULL(UN.FirstName, N'') + N' ' + ISNULL(UN.LastName, N'')))
			END AS Name
	FROM @ElementIDs AS IDs
		INNER JOIN [dbo].[FG_SelectedItems] AS S
		ON S.ApplicationID = @ApplicationID AND S.ElementID = IDs.Value AND S.Deleted = 0
		LEFT JOIN [dbo].[CN_Nodes] AS ND
		ON ND.ApplicationID = @ApplicationID AND ND.NodeID = S.SelectedID AND ND.Deleted = 0
		LEFT JOIN [dbo].[Users_Normal] AS UN
		ON UN.ApplicationID = @ApplicationID AND UN.UserID = S.SelectedID
	WHERE ND.NodeID IS NOT NULL OR UN.UserID IS NOT NULL
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[FG_GetElementChanges]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[FG_GetElementChanges]
GO

CREATE PROCEDURE [dbo].[FG_GetElementChanges]
	@ApplicationID	uniqueidentifier,
	@ElementID		uniqueidentifier,
	@Count			int,
	@LowerBoundary	int
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT TOP(ISNULL(@Count, 10000)) *
	FROM (
			SELECT	ROW_NUMBER() OVER (ORDER BY C.ID DESC) AS RowNumber,
					C.ID,
					C.ElementID,
					EFE.Info,
					C.TextValue,
					C.BitValue,
					C.FloatValue,
					C.DateValue,
					C.CreationDate,
					C.CreatorUserID,
					UN.UserName AS CreatorUserName,
					UN.FirstName AS CreatorFirstName,
					UN.LastName AS CreatorLastName
			FROM [dbo].[FG_Changes] AS C
				LEFT JOIN [dbo].[Users_Normal] AS UN
				ON UN.ApplicationID = @ApplicationID AND UN.UserID = C.CreatorUserID
				INNER JOIN [dbo].[FG_InstanceElements] AS E
				ON E.ApplicationID = @ApplicationID AND E.ElementID = C.ElementID
				INNER JOIN [dbo].[FG_ExtendedFormElements] AS EFE
				ON EFE.ApplicationID = @ApplicationID AND EFE.ElementID = E.RefElementID
			WHERE C.ApplicationID = @ApplicationID AND C.ElementID = @ElementID AND C.Deleted = 0
		) AS X
	WHERE X.RowNumber >= ISNULL(@LowerBoundary, 0)
	ORDER BY X.RowNumber ASC
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[FG_P_SetFormInstanceAsFilled]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[FG_P_SetFormInstanceAsFilled]
GO

CREATE PROCEDURE [dbo].[FG_P_SetFormInstanceAsFilled]
	@ApplicationID		uniqueidentifier,
	@InstanceID			uniqueidentifier,
	@FillingDate		datetime,
	@LastModifierUserID	uniqueidentifier,
	@_Result			int output
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[FG_FormInstances]
		SET Filled = 1,
			FillingDate = @FillingDate,
			LastModifierUserID = @LastModifierUserID,
			LastModificationDate = @FillingDate
	WHERE ApplicationID = @ApplicationID AND InstanceID = @InstanceID AND Filled = 0
	
	SET @_Result = @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[FG_SetFormInstanceAsFilled]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[FG_SetFormInstanceAsFilled]
GO

CREATE PROCEDURE [dbo].[FG_SetFormInstanceAsFilled]
	@ApplicationID		uniqueidentifier,
	@InstanceID			uniqueidentifier,
	@FillingDate		datetime,
	@LastModifierUserID	uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @_Result int
	
	EXEC [dbo].[FG_P_SetFormInstanceAsFilled] @ApplicationID, @InstanceID, 
		@FillingDate, @LastModifierUserID, @_Result output
	
	SELECT @_Result
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[FG_P_SetFormInstanceAsNotFilled]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[FG_P_SetFormInstanceAsNotFilled]
GO

CREATE PROCEDURE [dbo].[FG_P_SetFormInstanceAsNotFilled]
	@ApplicationID		uniqueidentifier,
	@InstanceID			uniqueidentifier,
	@LastModifierUserID	uniqueidentifier,
	@_Result			int output
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[FG_FormInstances]
		SET Filled = 0,
			LastModifierUserID = @LastModifierUserID
	WHERE ApplicationID = @ApplicationID AND InstanceID = @InstanceID AND Filled = 1 
	
	SET @_Result = @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[FG_SetFormInstanceAsNotFilled]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[FG_SetFormInstanceAsNotFilled]
GO

CREATE PROCEDURE [dbo].[FG_SetFormInstanceAsNotFilled]
	@ApplicationID		uniqueidentifier,
	@InstanceID			uniqueidentifier,
	@LastModifierUserID	uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @_Result int
	
	EXEC [dbo].[FG_P_SetFormInstanceAsNotFilled] @ApplicationID, 
		@InstanceID, @LastModifierUserID, @_Result output
	
	SELECT @_Result
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[FG_IsDirector]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[FG_IsDirector]
GO

CREATE PROCEDURE [dbo].[FG_IsDirector]
	@ApplicationID	uniqueidentifier,
	@InstanceID		uniqueidentifier,
	@UserID			uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	IF NOT EXISTS(
		SELECT TOP(1) * 
		FROM [dbo].[FG_FormInstances] 
		WHERE ApplicationID = @ApplicationID AND InstanceID = @InstanceID
	) BEGIN
		SET @InstanceID = (
			SELECT TOP(1) InstanceID 
			FROM [dbo].[FG_InstanceElements] 
			WHERE ApplicationID = @ApplicationID AND ElementID = @InstanceID
		)
	END
	
	DECLARE @DirectorID uniqueidentifier, @IsAdmin bit
	
	SELECT @DirectorID = DirectorID, @IsAdmin = [Admin]
	FROM [dbo].[FG_FormInstances]
	WHERE ApplicationID = @ApplicationID AND InstanceID = @InstanceID
	
	IF @IsAdmin = 0 SET @IsAdmin = NULL
	
	IF @DirectorID IS NOT NULL AND @DirectorID = @UserID BEGIN
		SELECT CAST(1 as bit)
		RETURN
	END
	
	DECLARE @NodeIDs GuidTableType
	INSERT INTO @NodeIDs
	EXEC [dbo].[CN_P_GetMemberNodeIDs] @ApplicationID, @UserID, NULL, N'Accepted', @IsAdmin
	
	IF @DirectorID IS NOT NULL AND @DirectorID IN(SELECT * FROM @NodeIDs)
		SELECT CAST(1 as bit)
	ELSE
		SELECT CAST(0 as bit)
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[FG_P_SetFormOwner]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[FG_P_SetFormOwner]
GO

CREATE PROCEDURE [dbo].[FG_P_SetFormOwner]
	@ApplicationID	uniqueidentifier,
	@OwnerID		uniqueidentifier,
	@FormID			uniqueidentifier,
	@CreatorUserID	uniqueidentifier,
	@CreationDate	datetime,
	@_Result		int output
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	IF EXISTS(
		SELECT TOP(1) * 
		FROM [dbo].[FG_FormOwners]
		WHERE ApplicationID = @ApplicationID AND OwnerID = @OwnerID
	) BEGIN
		UPDATE [dbo].[FG_FormOwners]
			SET FormID = @FormID,
				Deleted = 0,
				LastModifierUserID = @CreatorUserID,
				LastModificationDate = @CreationDate
		WHERE ApplicationID = @ApplicationID AND OwnerID = @OwnerID
	END
	ELSE BEGIN
		INSERT INTO [dbo].[FG_FormOwners](
			ApplicationID,
			OwnerID,
			FormID,
			CreatorUserID,
			CreationDate,
			Deleted
		)
		VALUES(
			@ApplicationID,
			@OwnerID,
			@FormID,
			@CreatorUserID,
			@CreationDate,
			0
		)
	END
	
	SET @_Result = @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[FG_SetFormOwner]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[FG_SetFormOwner]
GO

CREATE PROCEDURE [dbo].[FG_SetFormOwner]
	@ApplicationID	uniqueidentifier,
	@OwnerID		uniqueidentifier,
	@FormID			uniqueidentifier,
	@CreatorUserID	uniqueidentifier,
	@CreationDate	datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @_Result int
	
	EXEC [dbo].[FG_P_SetFormOwner] @ApplicationID, @OwnerID, 
		@FormID, @CreatorUserID, @CreationDate, @_Result output
	
	SELECT @_Result
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[FG_ArithmeticDeleteFormOwner]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[FG_ArithmeticDeleteFormOwner]
GO

CREATE PROCEDURE [dbo].[FG_ArithmeticDeleteFormOwner]
	@ApplicationID			uniqueidentifier,
	@OwnerID				uniqueidentifier,
	@FormID					uniqueidentifier,
	@LastModifierUserID		uniqueidentifier,
	@LastModificationDate	datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[FG_FormOwners]
		SET Deleted = 1,
			LastModifierUserID = @LastModifierUserID,
			LastModificationDate = @LastModificationDate
	WHERE ApplicationID = @ApplicationID AND OwnerID = @OwnerID AND FormID = @FormID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[FG_GetOwnerForm]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[FG_GetOwnerForm]
GO

CREATE PROCEDURE [dbo].[FG_GetOwnerForm]
	@ApplicationID	uniqueidentifier,
	@OwnerID		uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON

	DECLARE @FormIDs GuidTableType
	
	INSERT INTO @FormIDs
	SELECT FormID
	FROM [dbo].[FG_FormOwners]
	WHERE ApplicationID = @ApplicationID AND OwnerID = @OwnerID AND Deleted = 0
	
	EXEC [dbo].[FG_P_GetFormsByIDs] @ApplicationID, @FormIDs
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[FG_InitializeOwnerFormInstance]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[FG_InitializeOwnerFormInstance]
GO

CREATE PROCEDURE [dbo].[FG_InitializeOwnerFormInstance]
	@ApplicationID	uniqueidentifier,
	@OwnerID		uniqueidentifier,
	@FormID			uniqueidentifier,
	@CreatorUserID	uniqueidentifier,
	@CreationDate	datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	IF @FormID IS NULL BEGIN
		SET @FormID = (
			SELECT TOP(1) FormID 
			FROM [dbo].[FG_FormOwners]
			WHERE ApplicationID = @ApplicationID AND OwnerID = @OwnerID AND Deleted = 0
		)
	END
	
	IF @FormID IS NULL BEGIN
		SELECT @FormID = FormID 
		FROM [dbo].[FG_FormOwners] AS FO
			INNER JOIN [dbo].[CN_Nodes] AS ND
			ON ND.ApplicationID = @ApplicationID AND ND.NodeTypeID = FO.OwnerID
		WHERE FO.ApplicationID = @ApplicationID AND ND.NodeID = @OwnerID AND FO.Deleted = 0
	END
	
	IF @FormID IS NULL OR @OwnerID IS NULL SELECT NULL
	ELSE BEGIN
		DECLARE @InstanceID uniqueidentifier = (
			SELECT TOP(1) InstanceID
			FROM [dbo].[FG_FormInstances]
			WHERE ApplicationID = @ApplicationID AND 
				FormID = @FormID AND OwnerID = @OwnerID AND Deleted = 0
		)
			
		IF @InstanceID IS NOT NULL SELECT @InstanceID
		ELSE BEGIN
			SET @InstanceID = NEWID()
			
			DECLARE @_Result int
			
			DECLARE @Instances FormInstanceTableType
			
			INSERT INTO @Instances (InstanceID, FormID, OwnerID, DirectorID, [Admin])
			VALUES (@InstanceID, @FormID, @OwnerID, NULL, NULL)
			
			EXEC [dbo].[FG_P_CreateFormInstance] @ApplicationID, @Instances, @CreatorUserID, @CreationDate, @_Result output
				
			IF @_Result > 0 SELECT @InstanceID
		END
	END
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[FG_SetElementLimits]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[FG_SetElementLimits]
GO

CREATE PROCEDURE [dbo].[FG_SetElementLimits]
	@ApplicationID		uniqueidentifier,
	@OwnerID			uniqueidentifier,
	@strElementIDs		varchar(max),
	@delimiter			char,
    @CreatorUserID		uniqueidentifier,
    @CreationDate		datetime
WITH ENCRYPTION
AS
BEGIN TRANSACTION
	SET NOCOUNT ON
	
	DECLARE @ElementIDs GuidTableType
	
	INSERT INTO @ElementIDs
	SELECT Ref.Value FROM [dbo].[GFN_StrToGuidTable](@strElementIDs, @delimiter) AS Ref
	
	DECLARE @ExistingIDs GuidTableType, @NotExistingIDs GuidTableType
	DECLARE @Count int
	
	INSERT INTO @ExistingIDs
	SELECT Ref.Value
	FROM @ElementIDs AS Ref
		INNER JOIN [dbo].[FG_ElementLimits] AS EL
		ON EL.ElementID = Ref.Value
	WHERE EL.ApplicationID = @ApplicationID AND EL.OwnerID = @OwnerID
	
	SET @Count = (SELECT COUNT(*) FROM @ExistingIDs)
	
	UPDATE [dbo].[FG_ElementLimits]
		SET LastModifierUserID = @CreatorUserID,
			LastModificationDate = @CreationDate,
			Deleted = 1
	WHERE ApplicationID = @ApplicationID AND OwnerID = @OwnerID
	
	IF @Count > 0 BEGIN
		UPDATE EL
			SET LastModifierUserID = @CreatorUserID,
				LastModificationDate = @CreationDate,
				Deleted = 0
		FROM @ExistingIDs AS E
			INNER JOIN [dbo].[FG_ElementLimits] AS EL
			ON EL.ElementID = E.Value
		WHERE EL.ApplicationID = @ApplicationID AND EL.OwnerID = @OwnerID
		
		IF @@ROWCOUNT <= 0 BEGIN
			ROLLBACK TRANSACTION
			RETURN
		END
	END
	
	INSERT INTO @NotExistingIDs
	SELECT E.Value
	FROM @ElementIDs AS E
	WHERE E.Value NOT IN(SELECT Ref.Value FROM @ExistingIDs AS Ref)
	
	SET @Count = (SELECT COUNT(*) FROM @NotExistingIDs)
	
	IF @Count > 0 BEGIN
		INSERT INTO [dbo].[FG_ElementLimits](
			ApplicationID,
			OwnerID,
			ElementID,
			Necessary,
			CreatorUserID,
			CreationDate,
			Deleted
		)
		SELECT @ApplicationID, @OwnerID, NE.Value, 
			ISNULL(EFE.Necessary, 0), @CreatorUserID, @CreationDate, 0
		FROM @NotExistingIDs AS NE
			INNER JOIN [dbo].[FG_ExtendedFormElements] AS EFE
			ON EFE.ApplicationID = @ApplicationID AND EFE.ElementID = NE.Value
	
		IF @@ROWCOUNT <= 0 BEGIN
			ROLLBACK TRANSACTION
			RETURN
		END
	END
	
	SELECT 1
COMMIT TRANSACTION

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[FG_GetElementLimits]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[FG_GetElementLimits]
GO

CREATE PROCEDURE [dbo].[FG_GetElementLimits]
	@ApplicationID	uniqueidentifier,
	@OwnerID		uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @FormID uniqueidentifier = (
		SELECT TOP(1) FormID 
		FROM [dbo].[FG_FormOwners]
		WHERE ApplicationID = @ApplicationID AND OwnerID = @OwnerID AND Deleted = 0
	)
		
	IF @FormID IS NULL BEGIN
		SELECT @FormID = FormID, @OwnerID = ND.NodeTypeID
		FROM [dbo].[FG_FormOwners] AS FO
			INNER JOIN [dbo].[CN_Nodes] AS ND
			ON ND.ApplicationID = @ApplicationID AND ND.NodeTypeID = FO.OwnerID
		WHERE FO.ApplicationID = @ApplicationID AND ND.NodeID = @OwnerID AND FO.Deleted = 0
	END
	
	IF @FormID IS NOT NULL BEGIN
		SELECT EL.ElementID,
			   EFE.Title,
			   EL.Necessary,
			   EFE.[Type],
			   EFE.Info
		FROM [dbo].[FG_ElementLimits] AS EL
			INNER JOIN [dbo].[FG_ExtendedFormElements] AS EFE
			ON EFE.ApplicationID = @ApplicationID AND 
				EFE.ElementID = EL.ElementID AND EFE.Deleted = 0
		WHERE EL.ApplicationID = @ApplicationID AND 
			EL.OwnerID = @OwnerID AND EFE.FormID = @FormID AND EL.Deleted = 0
		ORDER BY EFE.SequenceNumber
	END
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[FG_SetElementLimitNecessity]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[FG_SetElementLimitNecessity]
GO

CREATE PROCEDURE [dbo].[FG_SetElementLimitNecessity]
	@ApplicationID			uniqueidentifier,
	@OwnerID				uniqueidentifier,
	@ElementID				uniqueidentifier,
	@Necessary				bit,
	@LastModifierUserID		uniqueidentifier,
	@LastModificationDate	datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[FG_ElementLimits]
		SET Necessary = ISNULL(@Necessary, CAST(0 AS bit)),
			LastModifierUserID = @LastModifierUserID,
			LastModificationDate = @LastModificationDate
	WHERE ApplicationID = @ApplicationID AND OwnerID = @OwnerID AND ElementID = @ElementID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[FG_ArithmeticDeleteElementLimit]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[FG_ArithmeticDeleteElementLimit]
GO

CREATE PROCEDURE [dbo].[FG_ArithmeticDeleteElementLimit]
	@ApplicationID			uniqueidentifier,
	@OwnerID				uniqueidentifier,
	@ElementID				uniqueidentifier,
	@LastModifierUserID		uniqueidentifier,
	@LastModificationDate	datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[FG_ElementLimits]
		SET Deleted = 1,
			LastModifierUserID = @LastModifierUserID,
			LastModificationDate = @LastModificationDate
	WHERE ApplicationID = @ApplicationID AND OwnerID = @OwnerID AND ElementID = @ElementID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[FG_GetCommonFormInstanceIDs]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[FG_GetCommonFormInstanceIDs]
GO

CREATE PROCEDURE [dbo].[FG_GetCommonFormInstanceIDs]
	@ApplicationID	uniqueidentifier,
	@OwnerID		uniqueidentifier,
	@FilledOwnerID	uniqueidentifier,
	@HasLimit		bit
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT FI.InstanceID AS ID
	FROM [dbo].[FG_FormInstances] AS FI
		INNER JOIN (
			SELECT Ref.FormID
			FROM (
					SELECT FO.FormID, COUNT(EL.ElementID) AS CNT
					FROM [dbo].[FG_FormOwners] AS FO
						LEFT JOIN [dbo].[FG_ElementLimits] AS EL
						INNER JOIN [dbo].[FG_ExtendedFormElements] AS EFE
						ON EFE.ApplicationID = @ApplicationID AND EFE.ElementID = EL.ElementID
						ON EL.ApplicationID = @ApplicationID AND 
							EL.OwnerID = FO.OwnerID AND EFE.FormID = FO.FormID AND EL.Deleted = 0
					WHERE FO.ApplicationID = @ApplicationID AND 
						FO.OwnerID = @OwnerID AND FO.Deleted = 0
					GROUP BY FO.FormID
				) AS Ref
			WHERE @HasLimit IS NULL OR @HasLimit = 0 OR Ref.CNT > 0
		) AS FID
		ON FI.FormID = FID.FormID
	WHERE FI.ApplicationID = @ApplicationID AND FI.OwnerID = @FilledOwnerID
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[FG_P_GetFormRecords]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[FG_P_GetFormRecords]
GO

CREATE PROCEDURE [dbo].[FG_P_GetFormRecords]
	@ApplicationID		uniqueidentifier,
	@FormID				uniqueidentifier,
	@ElementIDsTemp		GuidTableType readonly,
	@InstanceIDsTemp	GuidTableType readonly,
	@OwnerIDsTemp		GuidTableType readonly,
	@FiltersTemp		FormFilterTableType readonly,
	@LowerBoundary		int,
	@Count				int,
	@SortByElementID	uniqueidentifier,
	@DESC				bit
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @ElementIDs GuidTableType
	INSERT INTO @ElementIDs SELECT * FROM @ElementIDsTemp
	
	DECLARE @InstanceIDs GuidTableType
	INSERT INTO @InstanceIDs SELECT * FROM @InstanceIDsTemp
	
	DECLARE @OwnerIDs GuidTableType
	INSERT INTO @OwnerIDs SELECT * FROM @OwnerIDsTemp
	
	DECLARE @Filters FormFilterTableType
	INSERT INTO @Filters SELECT * FROM @FiltersTemp
	
	-- Preparing
	
	CREATE TABLE #Owners (Value uniqueidentifier primary key clustered)
	
	INSERT INTO #Owners (Value) SELECT O.Value FROM @OwnerIDs AS O
	
	DECLARE @HasOwner bit = CASE WHEN (SELECT TOP(1) * FROM @OwnerIDs) IS NOT NULL THEN 1 ELSE 0 END

	
	DECLARE @_ElemIDs KeyLessGuidTableType
	
	INSERT INTO @_ElemIDs (Value)
	SELECT EFE.ElementID
	FROM @ElementIDs AS E
		INNER JOIN [dbo].[FG_ExtendedFormElements] AS EFE
		ON EFE.ApplicationID = @ApplicationID AND EFE.ElementID = E.Value
	WHERE EFE.FormID = @FormID
	ORDER BY EFE.SequenceNumber
	
	IF (SELECT TOP(1) * FROM @ElementIDs) IS NULL BEGIN
		INSERT INTO @_ElemIDs (Value)
		SELECT ElementID 
		FROM [dbo].[FG_ExtendedFormElements]
		WHERE ApplicationID = @ApplicationID AND FormID = @FormID AND Deleted = 0
		ORDER BY SequenceNumber ASC
	END
	
	IF @SortByElementID IS NULL SET @SortByElementID = (SELECT TOP(1) Value FROM @_ElemIDs)
	
	IF @Count IS NULL SET @Count = 10000
	IF ISNULL(@LowerBoundary, 0) < 1 SET @LowerBoundary = 1
	DECLARE @UpperBoundary int = @LowerBoundary + @Count - 1
	
	CREATE TABLE #InstanceIDs (InstanceID uniqueidentifier primary key clustered,
		OwnerID uniqueidentifier, RowNum bigint)
		
	DECLARE @InstancesCount bigint = 0
	
	DECLARE @_STR_SBEID varchar(100), @_STR_FORMID varchar(100),
		@_STR_LB varchar(100), @_STR_UB varchar(100)
	SELECT @_STR_SBEID = CAST(@SortByElementID as varchar(100)),
		@_STR_FORMID = CAST(@FormID as varchar(100))
	
	IF EXISTS(SELECT TOP(1) * FROM @InstanceIDs) BEGIN
		INSERT INTO #InstanceIDs (InstanceID, OwnerID, RowNum)
		SELECT	I.Value, 
				FI.OwnerID, 
				ROW_NUMBER() OVER(ORDER BY I.Value ASC) AS RowNum
		FROM @InstanceIDs AS I
			LEFT JOIN [dbo].[FG_FormInstances] AS FI
			ON FI.ApplicationID = @ApplicationID AND FI.InstanceID = I.Value
	
		SET @InstancesCount = (SELECT COUNT(*) FROM #InstanceIDs)
	END
	ELSE BEGIN	
		DECLARE @_Proc varchar(max)
		
		SET @_Proc = 'INSERT INTO #InstanceIDs SELECT InstanceID, OwnerID, RowNum FROM ' + 
			'(SELECT ROW_NUMBER() OVER(ORDER BY R.RowNum) AS RowNum, R.InstanceID, R.OwnerID ' +
			'FROM (' +
			'SELECT ROW_NUMBER() OVER(PARTITION BY FI.InstanceID ORDER BY FI.InstanceID) AS P, ' + 
			'ROW_NUMBER() OVER(ORDER BY ' +
			(CASE WHEN @SortByElementID IS NULL THEN 'FI.InstanceID ' ELSE 'IE.ElementID ' END) +
			(CASE WHEN @DESC = 1 THEN 'DESC ' ELSE '' END) +
			') RowNum, FI.InstanceID, FI.OwnerID FROM ' +
			(CASE WHEN @HasOwner = 1 THEN '#Owners AS OW INNER JOIN ' ELSE '' END) +
			'[dbo].[FG_FormInstances] AS FI ' +
			(CASE WHEN @HasOwner = 1 THEN 'ON FI.ApplicationID = ''' + 
				CAST(@ApplicationID as varchar(50)) + ''' AND FI.OwnerID = OW.Value ' ELSE '' END) +
			(
				CASE 
					WHEN @SortByElementID IS NOT NULL
						THEN 'LEFT JOIN [dbo].[FG_InstanceElements] AS IE ' +
							'ON IE.ApplicationID = ''' + CAST(@ApplicationID as varchar(50)) + 
								''' AND IE.InstanceID = FI.InstanceID AND ' +
							'IE.RefElementID = N''' + @_STR_SBEID + ''' AND IE.Deleted = 0 '
					ELSE '' 
				END
			) +
			'WHERE FI.FormID = N''' + @_STR_FORMID + ''' AND FI.Deleted = 0 ' +
			')  AS R WHERE R.P = 1 ' +
			') AS Ref'
		
		EXEC (@_Proc)
		
		SET @InstancesCount = @@ROWCOUNT
	END
	
	IF @InstancesCount > 0 AND EXISTS(SELECT TOP(1) * FROM @Filters) BEGIN
		DECLARE @CurInstanceIDs GuidTableType
		
		INSERT INTO @CurInstanceIDs (Value)
		SELECT I.InstanceID
		FROM #InstanceIDs AS I
	
		DELETE I
		FROM #InstanceIDs AS I
			LEFT JOIN [dbo].[FG_FN_FilterInstances](
				@ApplicationID, NULL, @CurInstanceIDs, @Filters, ',', 1
			) AS Ret
			ON Ret.InstanceID = I.InstanceID
		WHERE Ret.InstanceID IS NULL
	END
	
	UPDATE I
		SET RowNum = CASE WHEN X.InstanceID IS NULL THEN 0 ELSE X.RowNum END
	FROM #InstanceIDs AS I
		LEFT JOIN (
			SELECT	D.InstanceID,
					D.OwnerID,
					ROW_NUMBER() OVER (ORDER BY D.RowNum ASC) AS RowNum
			FROM (
					SELECT	I.InstanceID,
							I.OwnerID,
							ROW_NUMBER() OVER (ORDER BY I.RowNum ASC) AS RowNum
					FROM #InstanceIDs AS I
				) AS D
			WHERE D.RowNum BETWEEN @LowerBoundary AND @UpperBoundary
		) AS X
		ON X.InstanceID = I.InstanceID
	
	DELETE #InstanceIDs
	WHERE RowNum = 0
	
	SET @InstancesCount = (SELECT COUNT(*) FROM #InstanceIDs)
	
	-- End of Preparing
	
	
	CREATE TABLE #Result
	(
		InstanceID		uniqueidentifier,
		OwnerID			uniqueidentifier,
		RefElementID	uniqueidentifier,
		CreationDate	datetime,
		BodyText		nvarchar(max),
		RowNum			bigint
	)

	INSERT INTO #Result(InstanceID, OwnerID, RefElementID, CreationDate, BodyText, RowNum)
	SELECT	FI.InstanceID, 
			INSTIDS.OwnerID,
			ELIDS.Value, 
			FI.CreationDate,
			[dbo].[FG_FN_ToString](@ApplicationID, IE.ElementID, IE.[Type], 
				IE.TextValue, IE.FloatValue, IE.BitValue, IE.DateValue),
			INSTIDS.RowNum
	FROM #InstanceIDs AS INSTIDS
		LEFT JOIN [dbo].[FG_FormInstances] AS FI
		ON FI.ApplicationID = @ApplicationID AND FI.InstanceID = INSTIDS.InstanceID
		LEFT JOIN @_ElemIDs AS ELIDS
		LEFT JOIN [dbo].[FG_InstanceElements] AS IE
		ON IE.ApplicationID = @ApplicationID AND IE.RefElementID = ELIDS.Value
		ON IE.InstanceID = FI.InstanceID
		

	DECLARE @lst varchar(max)
	SELECT @lst = ISNULL(@lst + ', ', '') + '[' + CAST(q.Value AS varchar(max)) + ']'
	FROM (SELECT Ref.Value FROM @_ElemIDs AS Ref) AS q
	
	SET @_Proc = 'SELECT * FROM ('
	
	DECLARE @BatchSize bigint = 1000
	DECLARE @Lower bigint = 0
	
	WHILE @InstancesCount >= 0 BEGIN
		IF @Lower > 0 SET @_Proc = @_Proc + ' UNION ALL '
		
		SET @_Proc = @_Proc + 'SELECT InstanceID, OwnerID, CreationDate, '+ @lst +  
			'FROM (SELECT InstanceID, OwnerID, RefElementID, CreationDate, BodyText
			FROM #Result ' + 
			'WHERE RowNum > ' + CAST(@Lower AS varchar(20)) + ' AND ' + 
				'RowNum <= ' + CAST(@Lower + @BatchSize AS varchar(20)) + ') P
			PIVOT (MAX(BodyText) FOR RefElementID IN('+ @lst + ' )) AS pvt '
			
		SET @InstancesCount = @InstancesCount - @BatchSize
		SET @Lower = @Lower + @BatchSize
	END
	
	SET @_Proc = @_Proc + ') AS TableName'
	IF @SortByElementID IS NOT NULL AND @_STR_SBEID IS NOT NULL BEGIN
		SET @_Proc = @_Proc + ' ORDER BY [' + @_STR_SBEID + ']'
		IF @DESC = 1 SET @_Proc = @_Proc + ' DESC'
	END
	
	EXEC(@_Proc)
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[FG_GetFormRecords]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[FG_GetFormRecords]
GO

CREATE PROCEDURE [dbo].[FG_GetFormRecords]
	@ApplicationID		uniqueidentifier,
	@FormID				uniqueidentifier,
	@ElementIDsTemp		GuidTableType readonly,
	@InstanceIDsTemp	GuidTableType readonly,
	@OwnerIDsTemp		GuidTableType readonly,
	@FiltersTemp		FormFilterTableType readonly,
	@LowerBoundary		int,
	@Count				int,
	@SortByElementID	uniqueidentifier,
	@DESC				bit
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @ElementIDs GuidTableType
	INSERT INTO @ElementIDs SELECT * FROM @ElementIDsTemp
	
	DECLARE @InstanceIDs GuidTableType
	INSERT INTO @InstanceIDs SELECT * FROM @InstanceIDsTemp
	
	DECLARE @OwnerIDs GuidTableType
	INSERT INTO @OwnerIDs SELECT * FROM @OwnerIDsTemp
	
	DECLARE @Filters FormFilterTableType
	INSERT INTO @Filters SELECT * FROM @FiltersTemp
	
	EXEC [dbo].[FG_P_GetFormRecords] @ApplicationID, @FormID, @ElementIDs, @InstanceIDs, 
		@OwnerIDs, @Filters, @LowerBoundary, @Count, @SortByElementID, @DESC
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[FG_GetFormStatistics]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[FG_GetFormStatistics]
GO

CREATE PROCEDURE [dbo].[FG_GetFormStatistics]
	@ApplicationID	uniqueidentifier,
	@OwnerID		uniqueidentifier,
	@InstanceID		uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT	SUM(X.[Weight]) AS [WeightSum],
			SUM(X.[Avg]) AS [Sum],
			SUM(X.[WeightedAvg]) AS [WeightedSum],
			AVG(X.[Avg]) AS [Avg],
			CASE 
				WHEN SUM(X.[Weight]) = 0 THEN AVG(X.[Avg]) 
				ELSE SUM(X.[WeightedAvg]) / SUM(X.[Weight]) 
			END AS [WeightedAvg],
			MIN(X.[Avg]) AS [Min],
			MAX(X.[Avg]) AS [Max],
			VAR(X.[Avg]) AS [Var],
			STDEV(X.[AVG]) AS [StDev]
	FROM (
			SELECT	EFE.ElementID,
					ISNULL(MAX(EFE.[Weight]), 0) AS [Weight],
					MIN(IE.FloatValue) AS [Min],
					MAX(IE.FloatValue) AS [Max],
					AVG(IE.FloatValue) AS [Avg],
					(AVG(IE.FloatValue) * ISNULL(MAX(EFE.[Weight]), 0)) AS [WeightedAvg],
					ISNULL(VAR(IE.FloatValue), 0) AS [Var],
					ISNULL(STDEV(IE.FloatValue), 0) AS [StDev]
			FROM [dbo].[FG_FormInstances] AS FI
				INNER JOIN [dbo].[FG_InstanceElements] AS IE
				ON IE.ApplicationID = @ApplicationID AND IE.InstanceID = FI.InstanceID AND 
					IE.FloatValue IS NOT NULL AND IE.Deleted = 0
				INNER JOIN [dbo].[FG_ExtendedFormElements] AS EFE
				ON EFE.ApplicationID = @ApplicationID AND 
					EFE.ElementID = IE.RefElementID AND EFE.Deleted = 0
			WHERE FI.ApplicationID = @ApplicationID AND FI.Deleted = 0 AND
				(@OwnerID IS NOT NULL OR @InstanceID IS NOT NULL) AND
				(@OwnerID IS NULL OR FI.OwnerID = @OwnerID) AND
				(@InstanceID IS NULL OR FI.InstanceID = @InstanceID)
			GROUP BY EFE.ElementID
		) AS X
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[FG_ConvertFormToTable]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[FG_ConvertFormToTable]
GO

CREATE PROCEDURE [dbo].[FG_ConvertFormToTable]
	@ApplicationID	uniqueidentifier,
	@FormID			uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @TableName varchar(200)
	DECLARE @ElementIDs TABLE (Seq int IDENTITY(1, 1) primary key clustered, Value uniqueidentifier, Name varchar(200) )

	SELECT TOP(1) @TableName = 'FG_FRM_' + F.Name
	FROM [dbo].[FG_ExtendedForms] AS F
	WHERE F.ApplicationID = @ApplicationID AND F.FormID = @FormID AND 
		ISNULL(F.Name, N'') <> N'' AND F.Deleted = 0
	
	IF ISNULL(@TableName, N'') = N'' BEGIN
		SELECT -1
		RETURN
	END

	INSERT INTO @ElementIDs(Value, Name)
	SELECT EFE.ElementID, N'Col_' + EFE.Name
	FROM [dbo].[FG_ExtendedFormElements] AS EFE
	WHERE EFE.ApplicationID = @ApplicationID AND EFE.FormID = @FormID AND 
		ISNULL(EFE.Name, N'') <> N'' AND EFE.Deleted = 0
	ORDER BY EFE.SequenceNumber
	
	IF (SELECT COUNT(*) FROM @ElementIDs) = 0 BEGIN
		SELECT -1
		RETURN
	END

	CREATE TABLE #InstanceIDs (
		InstanceID uniqueidentifier primary key clustered, 
		OwnerID uniqueidentifier,
		CreatorID uniqueidentifier,
		CreationDate datetime,
		RowNum bigint
	)
		
	DECLARE @InstancesCount bigint = 0

	DECLARE @_Proc varchar(max)
		
	INSERT INTO #InstanceIDs (RowNum, InstanceID, OwnerID, CreatorID, CreationDate)
	SELECT	ROW_NUMBER() OVER(ORDER BY FI.CreationDate ASC, FI.InstanceID ASC) RowNum, 
			FI.InstanceID,
			FI.OwnerID,
			FI.CreatorUserID,
			Fi.CreationDate
	FROM [dbo].[FG_FormInstances] AS FI 
		LEFT JOIN [dbo].[CN_Nodes] AS ND
		ON ND.ApplicationID = @ApplicationID AND ND.NodeID = FI.OwnerID
	WHERE FI.ApplicationID = @ApplicationID AND FI.FormID = @FormID AND FI.Deleted = 0 AND 
		(ND.NodeID IS NULL OR ISNULL(ND.Deleted, 0) = 0)

	UPDATE I
		SET RowNum = CASE WHEN X.InstanceID IS NULL THEN 0 ELSE X.RowNum END
	FROM #InstanceIDs AS I
		LEFT JOIN (
			SELECT	D.InstanceID,
					ROW_NUMBER() OVER (ORDER BY D.RowNum ASC) AS RowNum
			FROM (
					SELECT	I.InstanceID,
							ROW_NUMBER() OVER (ORDER BY I.RowNum ASC) AS RowNum
					FROM #InstanceIDs AS I
				) AS D
		) AS X
		ON X.InstanceID = I.InstanceID

	DELETE #InstanceIDs
	WHERE RowNum = 0

	SET @InstancesCount = (SELECT COUNT(*) FROM #InstanceIDs)

	-- End of Preparing


	CREATE TABLE #Result (InstanceID uniqueidentifier, Name varchar(200), Value nvarchar(max), RowNum bigint)

	INSERT INTO #Result(InstanceID, Name, Value, RowNum)
	SELECT	FI.InstanceID, 
			ELIDS.Name, 
			[dbo].[FG_FN_ToString](@ApplicationID, IE.ElementID, IE.[Type], 
				IE.TextValue, IE.FloatValue, IE.BitValue, IE.DateValue),
			INSTIDS.RowNum
	FROM #InstanceIDs AS INSTIDS
		LEFT JOIN [dbo].[FG_FormInstances] AS FI
		ON FI.ApplicationID = @ApplicationID AND FI.InstanceID = INSTIDS.InstanceID
		LEFT JOIN @ElementIDs AS ELIDS
		LEFT JOIN [dbo].[FG_InstanceElements] AS IE
		ON IE.ApplicationID = @ApplicationID AND IE.RefElementID = ELIDS.Value
		ON IE.InstanceID = FI.InstanceID

	INSERT INTO #Result(InstanceID, Name, Value, RowNum)
	SELECT	FI.InstanceID, 
			ELIDS.Name + '_id', 
			CAST(IE.ElementID AS nvarchar(max)),
			INSTIDS.RowNum
	FROM #InstanceIDs AS INSTIDS
		LEFT JOIN [dbo].[FG_FormInstances] AS FI
		ON FI.ApplicationID = @ApplicationID AND FI.InstanceID = INSTIDS.InstanceID
		LEFT JOIN @ElementIDs AS ELIDS
		LEFT JOIN [dbo].[FG_InstanceElements] AS IE
		ON IE.ApplicationID = @ApplicationID AND IE.RefElementID = ELIDS.Value
		ON IE.InstanceID = FI.InstanceID

	INSERT INTO #Result(InstanceID, Name, Value, RowNum)
	SELECT	FI.InstanceID, 
			ELIDS.Name + '_text', 
			CAST(IE.TextValue AS nvarchar(max)),
			INSTIDS.RowNum
	FROM #InstanceIDs AS INSTIDS
		LEFT JOIN [dbo].[FG_FormInstances] AS FI
		ON FI.ApplicationID = @ApplicationID AND FI.InstanceID = INSTIDS.InstanceID
		LEFT JOIN @ElementIDs AS ELIDS
		LEFT JOIN [dbo].[FG_InstanceElements] AS IE
		ON IE.ApplicationID = @ApplicationID AND IE.RefElementID = ELIDS.Value
		ON IE.InstanceID = FI.InstanceID

	INSERT INTO #Result(InstanceID, Name, Value, RowNum)	
	SELECT	FI.InstanceID, 
			ELIDS.Name + '_float', 
			CAST(IE.FloatValue AS nvarchar(max)),
			INSTIDS.RowNum
	FROM #InstanceIDs AS INSTIDS
		LEFT JOIN [dbo].[FG_FormInstances] AS FI
		ON FI.ApplicationID = @ApplicationID AND FI.InstanceID = INSTIDS.InstanceID
		LEFT JOIN @ElementIDs AS ELIDS
		LEFT JOIN [dbo].[FG_InstanceElements] AS IE
		ON IE.ApplicationID = @ApplicationID AND IE.RefElementID = ELIDS.Value
		ON IE.InstanceID = FI.InstanceID
			
	INSERT INTO #Result(InstanceID, Name, Value, RowNum)
	SELECT	FI.InstanceID, 
			ELIDS.Name + '_bit', 
			CAST(IE.BitValue AS nvarchar(max)),
			INSTIDS.RowNum
	FROM #InstanceIDs AS INSTIDS
		LEFT JOIN [dbo].[FG_FormInstances] AS FI
		ON FI.ApplicationID = @ApplicationID AND FI.InstanceID = INSTIDS.InstanceID
		LEFT JOIN @ElementIDs AS ELIDS
		LEFT JOIN [dbo].[FG_InstanceElements] AS IE
		ON IE.ApplicationID = @ApplicationID AND IE.RefElementID = ELIDS.Value
		ON IE.InstanceID = FI.InstanceID
		
	INSERT INTO #Result(InstanceID, Name, Value, RowNum)
	SELECT	FI.InstanceID, 
			ELIDS.Name + '_date', 
			CAST(IE.DateValue AS nvarchar(max)),
			INSTIDS.RowNum
	FROM #InstanceIDs AS INSTIDS
		LEFT JOIN [dbo].[FG_FormInstances] AS FI
		ON FI.ApplicationID = @ApplicationID AND FI.InstanceID = INSTIDS.InstanceID
		LEFT JOIN @ElementIDs AS ELIDS
		LEFT JOIN [dbo].[FG_InstanceElements] AS IE
		ON IE.ApplicationID = @ApplicationID AND IE.RefElementID = ELIDS.Value
		ON IE.InstanceID = FI.InstanceID

	DECLARE @lst varchar(max), @selectLst varchar(max)

	SELECT @lst = ISNULL(@lst + ', ', '') + '[' + q.Name + ']' + ',[' + q.Name + '_id]' + + ',[' + q.Name + '_text]' +
		',[' + q.Name + '_float]' + ',[' + q.Name + '_bit]' + ',[' + q.Name + '_date]'
	FROM (SELECT Ref.Name FROM @ElementIDs AS Ref) AS q

	SELECT @selectLst = ISNULL(@selectLst + ', ', '') + 
		'pvt.[' + q.Name + ']' + 
		',cast(pvt.[' + q.Name + '_id] as uniqueidentifier) as [' + q.Name + '_id]' + 
		',pvt.[' + q.Name + '_text]' +
		',cast(pvt.[' + q.Name + '_float] as float) as [' + q.Name + '_float]' + 
		',cast(pvt.[' + q.Name + '_bit] as bit) as [' + q.Name + '_bit]' + 
		',cast(pvt.[' + q.Name + '_date] as datetime) as [' + q.Name + '_date]'
	FROM (SELECT Ref.Name FROM @ElementIDs AS Ref) AS q

	IF (EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES 
		WHERE TABLE_SCHEMA = 'dbo' AND  TABLE_NAME = @TableName))
	BEGIN
		EXEC ('DROP TABLE dbo.' + @TableName)
	END

	SET @_Proc = 'SELECT * into dbo.' + @TableName + ' FROM ('

	DECLARE @BatchSize bigint = 1000
	DECLARE @Lower bigint = 0

	WHILE @InstancesCount >= 0 BEGIN
		IF @Lower > 0 SET @_Proc = @_Proc + ' UNION ALL '
		
		SET @_Proc = @_Proc + 
			'SELECT pvt.InstanceID, I.OwnerID, I.CreationDate, UN.UserID, UN.UserName, UN.FirstName, UN.LastName, '+ @selectLst +  
			'FROM (SELECT InstanceID, Name, Value
			FROM #Result ' + 
			'WHERE RowNum > ' + CAST(@Lower AS varchar(20)) + ' AND ' + 
				'RowNum <= ' + CAST(@Lower + @BatchSize AS varchar(20)) + ') P
			PIVOT (MAX(Value) FOR Name IN('+ @lst + ' )) AS pvt ' +
			'INNER JOIN #InstanceIDs AS I ' +
			'ON I.InstanceID = pvt.InstanceID ' +
			'LEFT JOIN [dbo].[USR_View_Users] AS UN ' +
			'ON UN.UserID = I.CreatorID'
			
		SET @InstancesCount = @InstancesCount - @BatchSize
		SET @Lower = @Lower + @BatchSize
	END

	SET @_Proc = @_Proc + ') AS TableName'


	EXEC (@_Proc)
	
	SELECT 1
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[FG_GetTemplateStatus]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[FG_GetTemplateStatus]
GO

CREATE PROCEDURE [dbo].[FG_GetTemplateStatus]
	@ApplicationID		uniqueidentifier,
	@RefApplicationID	uniqueidentifier,
	@strTemplateIDs		varchar(max),
	@delimiter			char
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @TemplateIDs GuidTableType

	INSERT INTO @TemplateIDs ([Value])
	SELECT DISTINCT Ref.[Value]
	FROM [dbo].[GFN_StrToGuidTable](@strTemplateIDs, @delimiter) AS Ref
	
	SELECT	CAST(MAX(CAST(RNT.NodeTypeID AS varchar(50))) AS uniqueidentifier) AS TemplateID,
			MAX(RNT.[Name]) AS TemplateName,
			CAST(MAX(CAST(NT.NodeTypeID AS varchar(50))) AS uniqueidentifier) AS ActivatedID,
			MAX(NT.[Name]) AS ActivatedName,
			MAX(NT.CreationDate) AS ActivationDate,
			CAST(MAX(CAST(USR.UserID AS varchar(50))) AS uniqueidentifier) AS ActivatorUserID,
			MAX(USR.UserName) AS ActivatorUserName,
			MAX(USR.FirstName) AS ActivatorFirstName,
			MAX(USR.LastName) AS ActivatorLastName,
			COUNT(DISTINCT CASE WHEN Elems.RefDeleted = 0 THEN Elems.RefElementID ELSE NULL END) AS TemplateElementsCount,
			COUNT(DISTINCT CASE WHEN Elems.Deleted = 0 THEN Elems.ElementID ELSE NULL END) AS ElementsCount,
			COUNT(DISTINCT
				CASE
					WHEN Elems.RefElementID IS NOT NULL AND Elems.RefDeleted = 0 AND Elems.ElementID IS NULL THEN Elems.RefElementID
					ELSE NULL
				END
			) AS NewTemplateElementsCount,
			COUNT(DISTINCT
				CASE
					WHEN Elems.RefElementID IS NOT NULL AND Elems.ElementID IS NOT NULL AND 
						Elems.RefDeleted = 1 AND Elems.Deleted = 0 THEN Elems.RefElementID
					ELSE NULL
				END
			) AS RemovedTemplateElementsCount,
			COUNT(DISTINCT
				CASE
					WHEN Elems.RefElementID IS NULL AND Elems.ElementID IS NOT NULL AND Elems.Deleted = 0 THEN Elems.ElementID
					ELSE NULL
				END
			) AS NewCustomElementsCount
	FROM @TemplateIDs AS T 
		INNER JOIN [dbo].[FG_ExtendedForms] AS RF
		ON RF.ApplicationID = @RefApplicationID AND RF.FormID = T.[Value]
		INNER JOIN [dbo].[FG_ExtendedForms] AS F
		ON F.ApplicationID = @ApplicationID AND F.TemplateFormID = RF.FormID
		INNER JOIN [dbo].[FG_FormOwners] AS RO
		ON RO.ApplicationID = @RefApplicationID AND RO.FormID = RF.FormID AND RO.Deleted = 0
		INNER JOIN [dbo].[CN_NodeTypes] AS RNT
		ON RNT.ApplicationID = @RefApplicationID AND RNT.NodeTypeID = RO.OwnerID AND RNT.Deleted = 0
		INNER JOIN [dbo].[FG_FormOwners] AS O
		ON O.ApplicationID = @ApplicationID AND O.FormID = F.FormID AND O.Deleted = 0
		INNER JOIN [dbo].[CN_NodeTypes] AS NT
		ON NT.ApplicationID = @ApplicationID AND NT.NodeTypeID = O.OwnerID AND NT.Deleted = 0
		INNER JOIN [dbo].[USR_View_Users] AS USR
		ON USR.UserID = NT.CreatorUserID
		INNER JOIN (
			SELECT	RE.ApplicationID AS RefAppID, 
					RE.FormID AS RefFormID,
					RE.ElementID AS RefElementID,
					ISNULL(RE.Deleted, 0) AS RefDeleted,
					E.ApplicationID AS AppID,
					E.FormID AS FormID,
					E.ElementID AS ElementID,
					ISNULL(E.Deleted, 0) AS Deleted
			FROM [dbo].[FG_ExtendedFormElements] AS RE
				FULL OUTER JOIN [dbo].[FG_ExtendedFormElements] AS E
				ON E.TemplateElementID = RE.ElementID
			WHERE (RE.ApplicationID IS NULL OR RE.ApplicationID = @RefApplicationID) AND
				(E.ApplicationID IS NULL OR E.ApplicationID = @ApplicationID)
		) AS Elems
		ON (Elems.RefFormID = RF.FormID AND (Elems.FormID IS NULL OR Elems.FormID = F.FormID)) OR 
			(Elems.FormID = F.FormID AND (Elems.RefFormID IS NULL OR Elems.RefFormID = RF.FormID))
	GROUP BY RF.FormID, F.FormID
END

GO


-- Polls

IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[FG_P_GetPollsByIDs]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[FG_P_GetPollsByIDs]
GO

CREATE PROCEDURE [dbo].[FG_P_GetPollsByIDs]
	@ApplicationID	uniqueidentifier,
	@PollIDsTemp	KeyLessGuidTableType readonly
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @PollIDs KeyLessGuidTableType
	INSERT INTO @PollIDs (Value) SELECT Value FROM @PollIDsTemp
	
	SELECT	P.PollID, 
			P.IsCopyOfPollID,
			P.OwnerID,
			P.[Name], 
			P2.[Name] AS RefName,
			P.[Description], 
			P2.[Description] AS RefDescription, 
			P.BeginDate, 
			P.FinishDate,
			CASE
				WHEN P.OwnerID IS NULL THEN P.ShowSummary
				ELSE ISNULL(P2.ShowSummary, P.ShowSummary)
			END AS ShowSummary,
			CASE
				WHEN P.OwnerID IS NULL THEN P.HideContributors
				ELSE ISNULL(P2.HideContributors, P.HideContributors)
			END AS HideContributors,
			P.Deleted AS Archived
	FROM @PollIDs AS IDs
		INNER JOIN [dbo].[FG_Polls] AS P
		ON P.ApplicationID = @ApplicationID AND P.PollID = IDs.Value
		LEFT JOIN [dbo].[FG_Polls] AS P2
		ON P2.ApplicationID = @ApplicationID AND P2.PollID = P.IsCopyOfPollID
	ORDER BY IDs.SequenceNumber ASC
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[FG_GetPollsByIDs]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[FG_GetPollsByIDs]
GO

CREATE PROCEDURE [dbo].[FG_GetPollsByIDs]
	@ApplicationID	uniqueidentifier,
	@strPollIDs		varchar(max),
	@delimiter		char
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @PollIDs KeyLessGuidTableType
	
	INSERT INTO @PollIDs (Value)
	SELECT Ref.Value
	FROM [dbo].[GFN_StrToGuidTable](@strPollIDs, @delimiter) AS Ref
	
	EXEC [dbo].[FG_P_GetPollsByIDs] @ApplicationID, @PollIDs
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[FG_GetPolls]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[FG_GetPolls]
GO

CREATE PROCEDURE [dbo].[FG_GetPolls]
	@ApplicationID	uniqueidentifier,
	@IsCopyOfPollID	uniqueidentifier,
	@OwnerID		uniqueidentifier,
	@Archive		bit,
	@SearchText		nvarchar(500),
	@Count			int,
	@LowerBoundary	bigint
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @TempIDs KeyLessGuidTableType
	
	SET @Archive = ISNULL(@Archive, 0)
	SET @Count = ISNULL(@Count, 20)
	
	IF ISNULL(@SearchText, N'') = N'' BEGIN
		INSERT INTO @TempIDs (Value)
		SELECT N.PollID
		FROM (
				SELECT	ROW_NUMBER() OVER (ORDER BY P.CreationDate DESC, P.PollID DESC) AS RowNumber,
						ROW_NUMBER() OVER (ORDER BY P.CreationDate ASC, P.PollID ASC) AS RevRowNumber,
						P.PollID
				FROM [dbo].[FG_Polls] AS P
				WHERE P.ApplicationID = @ApplicationID AND 
					(@Archive IS NULL OR P.Deleted = @Archive) AND
					((@IsCopyOfPollID IS NULL AND P.IsCopyOfPollID IS NULL) OR 
					(@IsCopyOfPollID IS NOT NULL AND P.IsCopyOfPollID = @IsCopyOfPollID)) AND
					((@OwnerID IS NULL AND P.OwnerID IS NULL) OR 
					(@OwnerID IS NOT NULL AND P.OwnerID = @OwnerID))
			) AS N
		ORDER BY N.RowNumber ASC
	END
	ELSE BEGIN
		INSERT INTO @TempIDs (Value)
		SELECT N.PollID
		FROM (
				SELECT	ROW_NUMBER() OVER (ORDER BY SRCH.[Rank] DESC, SRCH.[Key] DESC) AS RowNumber,
						ROW_NUMBER() OVER (ORDER BY SRCH.[Rank] ASC, SRCH.[Key] ASC) AS RevRowNumber,
						P.PollID
				FROM CONTAINSTABLE([dbo].[FG_Polls], ([Name]), @SearchText) AS SRCH
					INNER JOIN [dbo].[FG_Polls] AS P
					ON SRCH.[Key] = P.PollID
				WHERE P.ApplicationID = @ApplicationID AND 
					(@Archive IS NULL OR P.Deleted = @Archive) AND
					((@IsCopyOfPollID IS NULL AND P.IsCopyOfPollID IS NULL) OR 
					(@IsCopyOfPollID IS NOT NULL AND P.IsCopyOfPollID = @IsCopyOfPollID)) AND
					((@OwnerID IS NULL AND P.OwnerID IS NULL) OR 
					(@OwnerID IS NOT NULL AND P.OwnerID = @OwnerID))
			) AS N
		ORDER BY N.RowNumber ASC
	END
	
	DECLARE @PollIDs KeyLessGuidTableType
	
	INSERT INTO @PollIDs (Value)
	SELECT TOP(@Count) IDs.Value
	FROM @TempIDs AS IDs
	WHERE IDs.SequenceNumber >= ISNULL(@LowerBoundary, 0)
	ORDER BY IDs.SequenceNumber ASC
	
	EXEC [dbo].[FG_P_GetPollsByIDs] @ApplicationID, @PollIDs
	
	SELECT TOP(1) COUNT(T.Value) AS TotalCount 
	FROM @TempIDs AS T
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[FG_GetPollsByFormID]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[FG_GetPollsByFormID]
GO

CREATE PROCEDURE [dbo].[FG_GetPollsByFormID]
	@ApplicationID	uniqueidentifier,
	@FormID			uniqueidentifier,
	@Archive		bit
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @PollIDs KeyLessGuidTableType
	
	INSERT INTO @PollIDs ([Value])
	SELECT DISTINCT P.PollID
	FROM [dbo].[FG_Polls] AS P
		INNER JOIN [dbo].[FG_FormOwners] AS O
		ON O.ApplicationID = @ApplicationID AND O.FormID = @FormID AND O.OwnerID = P.PollID
	WHERE P.ApplicationID = @ApplicationID AND (@Archive IS NULL OR P.Deleted = @Archive)
	
	EXEC [dbo].[FG_P_GetPollsByIDs] @ApplicationID, @PollIDs
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[FG_P_AddPoll]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[FG_P_AddPoll]
GO

CREATE PROCEDURE [dbo].[FG_P_AddPoll]
	@ApplicationID	uniqueidentifier,
	@PollID			uniqueidentifier,
	@CopyFromPollID	uniqueidentifier,
	@OwnerID		uniqueidentifier,
	@Name			nvarchar(255),
	@CurrentUserID	uniqueidentifier,
	@Now			datetime,
	@_Result		int output
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	IF @PollID = @CopyFromPollID BEGIN
		SET @_Result = -1
		RETURN
	END
	
	SET @Name = [dbo].[GFN_VerifyString](@Name)
	
	INSERT INTO [dbo].[FG_Polls] (
		ApplicationID,
		PollID,
		IsCopyOfPollID,
		OwnerID,
		Name,
		ShowSummary,
		HideContributors,
		CreatorUserID,
		CreationDate,
		Deleted
	)
	SELECT	@ApplicationID, 
			@PollID, 
			@CopyFromPollID, 
			@OwnerID,
			@Name, 
			ISNULL(P.ShowSummary, 1),
			ISNULL(P.HideContributors, 0),
			@CurrentUserID, 
			@Now,
			0
	FROM (SELECT @CopyFromPollID AS ID) AS Ref
		LEFT JOIN [dbo].[FG_Polls] AS P
		ON P.ApplicationID = @ApplicationID AND P.PollID = Ref.ID
	
	SET @_Result = @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[FG_AddPoll]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[FG_AddPoll]
GO

CREATE PROCEDURE [dbo].[FG_AddPoll]
	@ApplicationID	uniqueidentifier,
	@PollID			uniqueidentifier,
	@CopyFromPollID	uniqueidentifier,
	@OwnerID		uniqueidentifier,
	@Name			nvarchar(255),
	@CurrentUserID	uniqueidentifier,
	@Now			datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @_Result int = 0
	
	EXEC [dbo].[FG_P_AddPoll] @ApplicationID, @PollID, @CopyFromPollID, 
		@OwnerID, @Name, @CurrentUserID, @Now, @_Result output
	
	SELECT @_Result
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[FG_GetPollInstance]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[FG_GetPollInstance]
GO

CREATE PROCEDURE [dbo].[FG_GetPollInstance]
	@ApplicationID	uniqueidentifier,
	@PollID			uniqueidentifier,
	@CopyFromPollID	uniqueidentifier,
	@OwnerID		uniqueidentifier,
	@CurrentUserID	uniqueidentifier,
	@Now			datetime
WITH ENCRYPTION
AS
BEGIN TRANSACTION
	SET NOCOUNT ON
	
	DECLARE @_Result int = 0
	
	IF NOT EXISTS (
		SELECT TOP(1) 1
		FROM [dbo].[FG_Polls]
		WHERE PollID = @PollID
	) BEGIN
		EXEC [dbo].[FG_P_AddPoll] @ApplicationID, @PollID, @CopyFromPollID, 
			@OwnerID, NULL, @CurrentUserID, @Now, @_Result output
		
		IF @_Result <= 0 BEGIN
			SELECT NULL
			ROLLBACK TRANSACTION
			RETURN
		END
	END
	
	DECLARE @FormID uniqueidentifier = (
		SELECT TOP(1) FO.FormID
		FROM [dbo].[FG_Polls] AS P
			INNER JOIN [dbo].[FG_FormOwners] AS FO
			ON FO.ApplicationID = @ApplicationID AND 
				FO.OwnerID = P.PollID AND FO.Deleted = 0
		WHERE P.ApplicationID = @ApplicationID AND P.PollID = @CopyFromPollID
	)
	
	IF @FormID IS NULL BEGIN
		SELECT NULL
		ROLLBACK TRANSACTION
		RETURN
	END
	
	DECLARE @InstanceID uniqueidentifier = (
		SELECT TOP(1) FI.InstanceID
		FROM [dbo].[FG_FormInstances] AS FI
		WHERE FI.ApplicationID = @ApplicationID AND FI.OwnerID = @PollID AND
			FI.DirectorID = @CurrentUserID AND FI.Deleted = 0
		ORDER BY FI.CreationDate DESC
	)
	
	IF @InstanceID IS NULL BEGIN
		SET @InstanceID = NEWID()
	
		SET @_Result = 0
		
		DECLARE @Instances FormInstanceTableType
			
		INSERT INTO @Instances (InstanceID, FormID, OwnerID, DirectorID, [Admin])
		VALUES (@InstanceID, @FormID, @PollID, @CurrentUserID, 0)
		
		EXEC [dbo].[FG_P_CreateFormInstance] @ApplicationID, @Instances, @CurrentUserID, @Now, @_Result output
			
		IF @_Result <= 0 BEGIN
			SELECT NULL
			ROLLBACK TRANSACTION
			RETURN
		END
	END
	
	SELECT @InstanceID
COMMIT TRANSACTION

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[FG_GetOwnerPollIDs]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[FG_GetOwnerPollIDs]
GO

CREATE PROCEDURE [dbo].[FG_GetOwnerPollIDs]
	@ApplicationID	uniqueidentifier,
	@IsCopyOfPollID	uniqueidentifier,
	@OwnerID		uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT PollID AS ID
	FROM [dbo].[FG_Polls]
	WHERE ApplicationID = @ApplicationID AND IsCopyOfPollID = @IsCopyOfPollID AND 
		OwnerID = @OwnerID AND Deleted = 0
	ORDER BY CreationDate DESC
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[FG_RenamePoll]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[FG_RenamePoll]
GO

CREATE PROCEDURE [dbo].[FG_RenamePoll]
	@ApplicationID	uniqueidentifier,
	@PollID			uniqueidentifier,
	@Name			nvarchar(255),
	@CurrentUserID	uniqueidentifier,
	@Now			datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SET @Name = [dbo].[GFN_VerifyString](@Name)
	
	UPDATE [dbo].[FG_Polls]
		SET Name = @Name,
			LastModifierUserID = @CurrentUserID,
			LastModificationDate = @Now
	WHERE ApplicationID = @ApplicationID AND PollID = @PollID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[FG_SetPollDescription]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[FG_SetPollDescription]
GO

CREATE PROCEDURE [dbo].[FG_SetPollDescription]
	@ApplicationID	uniqueidentifier,
	@PollID			uniqueidentifier,
	@Description	nvarchar(2000),
	@CurrentUserID	uniqueidentifier,
	@Now			datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SET @Description = [dbo].[GFN_VerifyString](@Description)
	
	UPDATE [dbo].[FG_Polls]
		SET [Description] = @Description,
			LastModifierUserID = @CurrentUserID,
			LastModificationDate = @Now
	WHERE ApplicationID = @ApplicationID AND PollID = @PollID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[FG_SetPollBeginDate]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[FG_SetPollBeginDate]
GO

CREATE PROCEDURE [dbo].[FG_SetPollBeginDate]
	@ApplicationID	uniqueidentifier,
	@PollID			uniqueidentifier,
	@BeginDate		datetime,
	@CurrentUserID	uniqueidentifier,
	@Now			datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[FG_Polls]
		SET BeginDate = @BeginDate,
			LastModifierUserID = @CurrentUserID,
			LastModificationDate = @Now
	WHERE ApplicationID = @ApplicationID AND PollID = @PollID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[FG_SetPollFinishDate]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[FG_SetPollFinishDate]
GO

CREATE PROCEDURE [dbo].[FG_SetPollFinishDate]
	@ApplicationID	uniqueidentifier,
	@PollID			uniqueidentifier,
	@FinishDate		datetime,
	@CurrentUserID	uniqueidentifier,
	@Now			datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[FG_Polls]
		SET FinishDate = @FinishDate,
			LastModifierUserID = @CurrentUserID,
			LastModificationDate = @Now
	WHERE ApplicationID = @ApplicationID AND PollID = @PollID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[FG_SetPollShowSummary]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[FG_SetPollShowSummary]
GO

CREATE PROCEDURE [dbo].[FG_SetPollShowSummary]
	@ApplicationID	uniqueidentifier,
	@PollID			uniqueidentifier,
	@ShowSummary	bit,
	@CurrentUserID	uniqueidentifier,
	@Now			datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[FG_Polls]
		SET ShowSummary = ISNULL(@ShowSummary, 0),
			LastModifierUserID = @CurrentUserID,
			LastModificationDate = @Now
	WHERE ApplicationID = @ApplicationID AND PollID = @PollID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[FG_SetPollHideContributors]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[FG_SetPollHideContributors]
GO

CREATE PROCEDURE [dbo].[FG_SetPollHideContributors]
	@ApplicationID		uniqueidentifier,
	@PollID				uniqueidentifier,
	@HideContributors	bit,
	@CurrentUserID		uniqueidentifier,
	@Now				datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[FG_Polls]
		SET HideContributors = ISNULL(@HideContributors, 0),
			LastModifierUserID = @CurrentUserID,
			LastModificationDate = @Now
	WHERE ApplicationID = @ApplicationID AND PollID = @PollID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[FG_RemovePoll]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[FG_RemovePoll]
GO

CREATE PROCEDURE [dbo].[FG_RemovePoll]
	@ApplicationID	uniqueidentifier,
	@PollID			uniqueidentifier,
	@CurrentUserID	uniqueidentifier,
	@Now			datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[FG_Polls]
		SET Deleted = 1,
			LastModifierUserID = @CurrentUserID,
			LastModificationDate = @Now
	WHERE ApplicationID = @ApplicationID AND PollID = @PollID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[FG_RecyclePoll]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[FG_RecyclePoll]
GO

CREATE PROCEDURE [dbo].[FG_RecyclePoll]
	@ApplicationID	uniqueidentifier,
	@PollID			uniqueidentifier,
	@CurrentUserID	uniqueidentifier,
	@Now			datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[FG_Polls]
		SET Deleted = 0,
			LastModifierUserID = @CurrentUserID,
			LastModificationDate = @Now
	WHERE ApplicationID = @ApplicationID AND PollID = @PollID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[FG_GetPollStatus]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[FG_GetPollStatus]
GO

CREATE PROCEDURE [dbo].[FG_GetPollStatus]
	@ApplicationID	uniqueidentifier,
	@PollID			uniqueidentifier,
	@IsCopyOfPollID	uniqueidentifier,
	@CurrentUserID	uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @Description nvarchar(2000)
	DECLARE @BeginDate datetime
	DECLARE @FinishDate datetime
	DECLARE @InstanceID uniqueidentifier
	DECLARE @ElementsCount int
	DECLARE @FilledElementsCount int
	DECLARE @AllFilledFormsCount int

	IF @PollID IS NULL BEGIN
		SELECT TOP(1) 
			@Description = P.[Description]
		FROM [dbo].[FG_Polls] AS P
		WHERE P.ApplicationID = @ApplicationID AND P.PollID = @IsCopyOfPollID
	END
	ELSE BEGIN
		SELECT TOP(1) 
			@Description = ISNULL(P.[Description], Ref.[Description]), 
			@BeginDate = P.BeginDate,
			@FinishDate = P.FinishDate,
			@InstanceID = FI.InstanceID
		FROM [dbo].[FG_Polls] AS P
			INNER JOIN [dbo].[FG_Polls] AS Ref
			ON Ref.ApplicationID = @ApplicationID AND Ref.PollID = P.IsCopyOfPollID
			INNER JOIN [dbo].[FG_FormOwners] AS FO
			ON FO.ApplicationID = @ApplicationID AND FO.OwnerID = Ref.PollID AND FO.Deleted = 0
			LEFT JOIN [dbo].[FG_FormInstances] AS FI
			ON FI.ApplicationID = @ApplicationID AND FI.FormID = FO.FormID AND 
				FI.OwnerID = @PollID AND FI.DirectorID = @CurrentUserID
		WHERE P.ApplicationID = @ApplicationID AND P.PollID = @PollID
		ORDER BY FI.CreationDate DESC
	END

	DECLARE @LimitedElements GuidTableType
	
	INSERT INTO @LimitedElements (Value)
	SELECT Ref.ElementID
	FROM [dbo].[FG_FN_GetLimitedElements](@ApplicationID, @IsCopyOfPollID) AS Ref
	
	SELECT TOP(1)	
		@ElementsCount = COUNT(DISTINCT L.Value),
		@FilledElementsCount = COUNT(DISTINCT IE.ElementID)
	FROM @LimitedElements AS L
		INNER JOIN [dbo].[FG_ExtendedFormElements] AS EFE
		ON EFE.ApplicationID = @ApplicationID AND EFE.ElementID = L.Value AND
			[dbo].[FG_FN_IsFillable](EFE.[Type]) = 1
		LEFT JOIN [dbo].[FG_InstanceElements] AS IE
		ON IE.ApplicationID = @ApplicationID AND IE.InstanceID = @InstanceID AND 
			IE.RefElementID = L.Value AND IE.Deleted = 0 AND
			ISNULL([dbo].[FG_FN_ToString](@ApplicationID, IE.ElementID, 
				IE.[Type], IE.TextValue, IE.FloatValue, IE.BitValue, IE.DateValue), N'') <> N''

	SELECT @AllFilledFormsCount = COUNT(DISTINCT FI.DirectorID)
	FROM [dbo].[FG_FormInstances] AS FI
		INNER JOIN [dbo].[FG_InstanceElements] AS IE
		ON IE.ApplicationID = @ApplicationID AND 
			IE.InstanceID = FI.InstanceID AND IE.Deleted = 0 AND
			ISNULL([dbo].[FG_FN_ToString](@ApplicationID, IE.ElementID, IE.[Type], 
				IE.TextValue, IE.FloatValue, IE.BitValue, IE.DateValue), N'') <> N''
		INNER JOIN @LimitedElements AS L
		ON L.Value = IE.RefElementID
	WHERE FI.ApplicationID = @ApplicationID AND FI.OwnerID = @PollID AND FI.Deleted = 0
			
	SELECT	@Description AS [Description],
			@BeginDate AS BeginDate,
			@FinishDate AS FinishDate,
			@InstanceID AS InstanceID,
			@ElementsCount AS ElementsCount, 
			@FilledElementsCount AS FilledElementsCount,
			@AllFilledFormsCount AS AllFilledFormsCount
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[FG_GetPollElementsInstanceCount]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[FG_GetPollElementsInstanceCount]
GO

CREATE PROCEDURE [dbo].[FG_GetPollElementsInstanceCount]
	@ApplicationID	uniqueidentifier,
	@PollID			uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @IsCopyOfPollID uniqueidentifier = (
		SELECT TOP(1) IsCopyOfPollID
		FROM [dbo].[FG_Polls]
		WHERE PollID = @PollID
	)

	IF @IsCopyOfPollID IS NULL RETURN

	SELECT IE.RefElementID AS ID, COUNT(DISTINCT FI.DirectorID) AS [Count]
	FROM [dbo].[FG_FormInstances] AS FI
		INNER JOIN [dbo].[FG_InstanceElements] AS IE
		ON IE.ApplicationID = @ApplicationID AND 
			IE.InstanceID = FI.InstanceID AND IE.Deleted = 0 AND
			ISNULL([dbo].[FG_FN_ToString](@ApplicationID, IE.ElementID, IE.[Type], 
				IE.TextValue, IE.FloatValue, IE.BitValue, IE.DateValue), N'') <> N''
		INNER JOIN (
			SELECT Ref.ElementID
			FROM [dbo].[FG_FN_GetLimitedElements](@ApplicationID, @IsCopyOfPollID) as ref
		) AS E
		ON E.ElementID = IE.RefElementID
	WHERE FI.ApplicationID = @ApplicationID AND 
		FI.OwnerID = @PollID AND FI.Deleted = 0
	GROUP BY IE.RefElementID
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[FG_GetPollAbstractText]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[FG_GetPollAbstractText]
GO

CREATE PROCEDURE [dbo].[FG_GetPollAbstractText]
	@ApplicationID	uniqueidentifier,
	@PollID			uniqueidentifier,
	@strElementIDs	varchar(max),
	@delimiter		char,
	@Count			int,
	@LowerBoundary	int
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @ElementIDs GuidTableType
	
	INSERT INTO @ElementIDs (Value)
	SELECT Ref.Value
	FROM [dbo].[GFN_StrToGuidTable](@strElementIDs, @delimiter) AS Ref
	
	DECLARE @Temp Table(ElementID uniqueidentifier, Value nvarchar(max), Number float,
		Seq int IDENTITY(1,1) primary key clustered)
	DECLARE @TBL Table(ElementID uniqueidentifier, Value nvarchar(max), Number float)

	INSERT INTO @Temp (ElementID, Value, Number)
	SELECT IDs.Value, IE.TextValue, IE.FloatValue
	FROM [dbo].[FG_FormInstances] AS FI
		INNER JOIN [dbo].[FG_InstanceElements] AS IE
		ON IE.ApplicationID = @ApplicationID AND 
			IE.InstanceID = FI.InstanceID AND IE.Deleted = 0 AND
			LTRIM(RTRIM(ISNULL(IE.TextValue, N''))) <> N''
		INNER JOIN @ElementIDs AS IDs
		ON IDs.Value = IE.RefElementID
	WHERE FI.ApplicationID = @ApplicationID AND FI.OwnerID = @PollID AND FI.Deleted = 0

	DECLARE @Cur int = (SELECT MAX(Seq) FROM @Temp)

	WHILE @Cur > 0 BEGIN
		DECLARE @EID uniqueidentifier
		DECLARE @Val nvarchar(max)
		DECLARE @Num float
		
		SELECT TOP(1) @EID = T.ElementID, @Val = T.Value, @Num = T.Number
		FROM @Temp AS T
		WHERE T.Seq = @Cur

		INSERT INTO @TBL (ElementID, Value, Number)
		SELECT @EID, Ref.Value, @Num
		FROM [dbo].[GFN_StrToStringTable](@Val, N'~') AS Ref
		
		SET @Cur = @Cur - 1
	END

	SELECT TOP(ISNULL(@Count, 5))
		CAST((V.RowNumber + V.RevRowNumber - 1) AS int) AS TotalValuesCount,
		V.ElementID,
		V.Value,
		V.[Count]
	FROM (
			SELECT	ROW_NUMBER() OVER(PARTITION BY X.ElementID ORDER BY X.[Count] DESC, X.Value DESC) AS RowNumber,
					ROW_NUMBER() OVER(PARTITION BY X.ElementID ORDER BY X.[Count] ASC, X.Value ASC) AS RevRowNumber,
					X.*
			FROM (
					SELECT T.ElementID, T.Value, COUNT(T.ElementID) AS [Count]
					FROM @TBL AS T
					GROUP BY T.ElementID, T.Value
				) AS X
		) AS V
	WHERE V.RowNumber >= ISNULL(@LowerBoundary, 0)
	ORDER BY V.RowNumber ASC
	
	SELECT	T.ElementID, 
			MIN(T.Number) AS [Min], 
			MAX(T.Number) AS [Max], 
			AVG(T.Number) AS [Avg], 
			ISNULL(VAR(T.Number), 0) AS [Var], 
			ISNULL(STDEV(T.Number), 0) AS [StDev]
	FROM @TBL AS T
	WHERE T.Number IS NOT NULL
	GROUP BY T.ElementID
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[FG_GetPollAbstractGuid]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[FG_GetPollAbstractGuid]
GO

CREATE PROCEDURE [dbo].[FG_GetPollAbstractGuid]
	@ApplicationID	uniqueidentifier,
	@PollID			uniqueidentifier,
	@strElementIDs	varchar(max),
	@delimiter		char,
	@Count			int,
	@LowerBoundary	int
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @ElementIDs GuidTableType
	
	INSERT INTO @ElementIDs (Value)
	SELECT Ref.Value
	FROM [dbo].[GFN_StrToGuidTable](@strElementIDs, @delimiter) AS Ref
	
	DECLARE @TBL Table(ElementID uniqueidentifier, Value uniqueidentifier)

	INSERT INTO @TBL (ElementID, Value)
	SELECT IDs.Value, S.SelectedID
	FROM [dbo].[FG_FormInstances] AS FI
		INNER JOIN [dbo].[FG_InstanceElements] AS IE
		ON IE.ApplicationID = @ApplicationID AND 
			IE.InstanceID = FI.InstanceID AND IE.Deleted = 0
		INNER JOIN @ElementIDs AS IDs
		ON IDs.Value = IE.RefElementID
		INNER JOIN [dbo].[FG_SelectedItems] AS S
		ON S.ApplicationID = @ApplicationID AND S.ElementID = IE.ElementID AND S.Deleted = 0
	WHERE FI.ApplicationID = @ApplicationID AND FI.OwnerID = @PollID AND FI.Deleted = 0

	SELECT TOP(ISNULL(@Count, 5))
		CAST((V.RowNumber + V.RevRowNumber - 1) AS int) AS TotalValuesCount,
		V.ElementID,
		V.Value,
		V.[Count]
	FROM (
			SELECT	ROW_NUMBER() OVER(PARTITION BY X.ElementID ORDER BY X.[Count] DESC, X.Value DESC) AS RowNumber,
					ROW_NUMBER() OVER(PARTITION BY X.ElementID ORDER BY X.[Count] ASC, X.Value ASC) AS RevRowNumber,
					X.*
			FROM (
					SELECT T.ElementID, T.Value, COUNT(T.ElementID) AS [Count]
					FROM @TBL AS T
					GROUP BY T.ElementID, T.Value
				) AS X
		) AS V
	WHERE V.RowNumber >= ISNULL(@LowerBoundary, 0)
	ORDER BY V.RowNumber ASC
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[FG_GetPollAbstractBool]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[FG_GetPollAbstractBool]
GO

CREATE PROCEDURE [dbo].[FG_GetPollAbstractBool]
	@ApplicationID	uniqueidentifier,
	@PollID			uniqueidentifier,
	@strElementIDs	varchar(max),
	@delimiter		char
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @ElementIDs GuidTableType
	
	INSERT INTO @ElementIDs (Value)
	SELECT Ref.Value
	FROM [dbo].[GFN_StrToGuidTable](@strElementIDs, @delimiter) AS Ref
	
	DECLARE @TBL Table(ElementID uniqueidentifier, Value bit)

	INSERT INTO @TBL (ElementID, Value)
	SELECT IDs.Value, IE.BitValue
	FROM [dbo].[FG_FormInstances] AS FI
		INNER JOIN [dbo].[FG_InstanceElements] AS IE
		ON IE.ApplicationID = @ApplicationID AND 
			IE.InstanceID = FI.InstanceID AND IE.Deleted = 0 AND IE.BitValue IS NOT NULL
		INNER JOIN @ElementIDs AS IDs
		ON IDs.Value = IE.RefElementID
	WHERE FI.ApplicationID = @ApplicationID AND FI.OwnerID = @PollID AND FI.Deleted = 0

	SELECT T.ElementID, T.Value, COUNT(T.ElementID) AS [Count], NULL AS TotalValuesCount
	FROM @TBL AS T
	GROUP BY T.ElementID, T.Value
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[FG_GetPollAbstractNumber]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[FG_GetPollAbstractNumber]
GO

CREATE PROCEDURE [dbo].[FG_GetPollAbstractNumber]
	@ApplicationID	uniqueidentifier,
	@PollID			uniqueidentifier,
	@strElementIDs	varchar(max),
	@delimiter		char,
	@Count			int,
	@LowerBoundary	int
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @ElementIDs GuidTableType
	
	INSERT INTO @ElementIDs (Value)
	SELECT Ref.Value
	FROM [dbo].[GFN_StrToGuidTable](@strElementIDs, @delimiter) AS Ref
	
	DECLARE @TBL Table(ElementID uniqueidentifier, Value float)

	INSERT INTO @TBL (ElementID, Value)
	SELECT IDs.Value, IE.FloatValue
	FROM [dbo].[FG_FormInstances] AS FI
		INNER JOIN [dbo].[FG_InstanceElements] AS IE
		ON IE.ApplicationID = @ApplicationID AND 
			IE.InstanceID = FI.InstanceID AND IE.Deleted = 0 AND IE.FloatValue IS NOT NULL
		INNER JOIN @ElementIDs AS IDs
		ON IDs.Value = IE.RefElementID
	WHERE FI.ApplicationID = @ApplicationID AND FI.OwnerID = @PollID AND FI.Deleted = 0

	SELECT TOP(ISNULL(@Count, 5))
		CAST((V.RowNumber + V.RevRowNumber - 1) AS int) AS TotalValuesCount,
		V.ElementID,
		CAST(V.Value AS float) AS Value,
		V.[Count]
	FROM (
			SELECT	ROW_NUMBER() OVER(PARTITION BY X.ElementID ORDER BY X.[Count] DESC, X.Value DESC) AS RowNumber,
					ROW_NUMBER() OVER(PARTITION BY X.ElementID ORDER BY X.[Count] ASC, X.Value ASC) AS RevRowNumber,
					X.*
			FROM (
					SELECT T.ElementID, T.Value, COUNT(T.ElementID) AS [Count]
					FROM @TBL AS T
					GROUP BY T.ElementID, T.Value
				) AS X
		) AS V
	WHERE V.RowNumber >= ISNULL(@LowerBoundary, 0)
	ORDER BY V.RowNumber ASC
	
	SELECT	T.ElementID, 
			MIN(T.Value) AS [Min], 
			MAX(T.Value) AS [Max], 
			AVG(T.Value) AS [Avg], 
			ISNULL(VAR(T.Value), 0) AS [Var], 
			ISNULL(STDEV(T.Value), 0) AS [StDev]
	FROM @TBL AS T
	GROUP BY T.ElementID
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[FG_GetPollElementInstances]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[FG_GetPollElementInstances]
GO

CREATE PROCEDURE [dbo].[FG_GetPollElementInstances]
	@ApplicationID	uniqueidentifier,
	@PollID			uniqueidentifier,
	@ElementID		uniqueidentifier,
	@Count			int,
	@LowerBoundary	int
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT TOP(ISNULL(@Count, 20)) *
	FROM (
			SELECT	ROW_NUMBER() OVER(ORDER BY ISNULL(IE.LastModificationDate, IE.CreationDate) DESC, 
						IE.ElementID DESC) AS RowNumber,
					UN.UserID,
					UN.UserName,
					UN.FirstName,
					UN.LastName,
					IE.ElementID,
					IE.RefElementID,
					IE.[Type],
					ISNULL(IE.TextValue, N'') AS TextValue,
					IE.FloatValue,
					IE.BitValue,
					IE.DateValue,
					IE.CreationDate,
					IE.LastModificationDate
			FROM [dbo].[FG_FormInstances] AS FI
				INNER JOIN [dbo].[FG_InstanceElements] AS IE
				ON IE.ApplicationID = @ApplicationID AND IE.InstanceID = FI.InstanceID AND
					IE.RefElementID = @ElementID AND IE.Deleted = 0 AND
					ISNULL([dbo].[FG_FN_ToString](@ApplicationID, IE.ElementID, IE.[Type], 
						IE.TextValue, IE.FloatValue, IE.BitValue, IE.DateValue), N'') <> N''
				INNER JOIN [dbo].[Users_Normal] AS UN
				ON UN.ApplicationID = @ApplicationID AND UN.UserID = FI.DirectorID
			WHERE FI.ApplicationID = @ApplicationID AND FI.OwnerID = @PollID AND 
				FI.DirectorID IS NOT NULL AND FI.Deleted = 0
		) AS X
	WHERE X.RowNumber >= ISNULL(@LowerBoundary, 0)
	ORDER BY X.RowNumber ASC
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[FG_GetCurrentPollsCount]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[FG_GetCurrentPollsCount]
GO

CREATE PROCEDURE [dbo].[FG_GetCurrentPollsCount]
	@ApplicationID	uniqueidentifier,
	@CurrentUserID	uniqueidentifier,
	@Now			datetime,
	@DefaultPrivacy	varchar(50)
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON

	DECLARE @PollIDs KeyLessGuidTableType

	INSERT INTO @PollIDs (Value)
	SELECT P.PollID
	FROM [dbo].[FG_Polls] AS P
	WHERE P.ApplicationID = @ApplicationID AND 
		P.IsCopyOfPollID IS NOT NULL AND P.OwnerID IS NULL AND P.Deleted = 0 AND 
		(P.BeginDate IS NOT NULL OR P.FinishDate IS NOT NULL) AND
		(P.BeginDate IS NULL OR P.BeginDate <= @Now) AND
		(P.FinishDate IS NULL OR P.FinishDate >= @Now)
		
	DECLARE	@PermissionTypes StringPairTableType
	
	INSERT INTO @PermissionTypes (FirstValue, SecondValue)
	VALUES (N'View', @DefaultPrivacy)

	SELECT	CAST(COUNT(X.PollID) AS int) AS [Count],
			CAST(SUM(X.Done) AS int) AS DoneCount
	FROM (
			SELECT	P.PollID,
					MAX(CAST((CASE WHEN FI.InstanceID IS NULL THEN 0 ELSE 1 END) AS int)) AS Done
			FROM [dbo].[PRVC_FN_CheckAccess](@ApplicationID, @CurrentUserID, 
				@PollIDs, N'Poll', @Now, @PermissionTypes) AS IDs
				INNER JOIN [dbo].[FG_Polls] AS P
				ON P.ApplicationID = @ApplicationID AND P.PollID = IDs.ID
				LEFT JOIN [dbo].[FG_FormInstances] AS FI
				ON FI.ApplicationID = @ApplicationID AND FI.OwnerID = IDs.ID AND
					FI.DirectorID = @CurrentUserID AND FI.Deleted = 0
			GROUP BY P.PollID
		) AS X
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[FG_GetCurrentPolls]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[FG_GetCurrentPolls]
GO

CREATE PROCEDURE [dbo].[FG_GetCurrentPolls]
	@ApplicationID	uniqueidentifier,
	@CurrentUserID	uniqueidentifier,
	@Now			datetime,
	@DefaultPrivacy	varchar(50),
	@Count			int,
	@LowerBoundary	int
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON

	DECLARE @PollIDs KeyLessGuidTableType

	INSERT INTO @PollIDs (Value)
	SELECT P.PollID
	FROM [dbo].[FG_Polls] AS P
	WHERE P.ApplicationID = @ApplicationID AND
		P.IsCopyOfPollID IS NOT NULL AND P.OwnerID IS NULL AND P.Deleted = 0 AND 
		(P.BeginDate IS NOT NULL OR P.FinishDate IS NOT NULL) AND
		(P.BeginDate IS NULL OR P.BeginDate <= @Now) AND
		(P.FinishDate IS NULL OR P.FinishDate >= @Now)
	
	DECLARE	@PermissionTypes StringPairTableType
	
	INSERT INTO @PermissionTypes (FirstValue, SecondValue)
	VALUES (N'View', @DefaultPrivacy)

	SELECT TOP(ISNULL(@Count, 20)) X.ID, X.Done AS Value, X.RowNumber + X.RevRowNumber - 1 AS TotalCount
	FROM (
			SELECT	ROW_NUMBER() OVER(ORDER BY MAX(P.BeginDate) DESC, MAX(P.FinishDate) ASC) AS RowNumber,
					ROW_NUMBER() OVER(ORDER BY MAX(P.BeginDate) ASC, MAX(P.FinishDate) DESC) AS RevRowNumber,
					IDs.ID, 
					CAST((CASE WHEN COUNT(FI.InstanceID) > 0 THEN 1 ELSE 0 END) AS bit) AS Done
			FROM [dbo].[PRVC_FN_CheckAccess](@ApplicationID, @CurrentUserID, 
				@PollIDs, N'Poll', @Now, @PermissionTypes) AS IDs
				INNER JOIN [dbo].[FG_Polls] AS P
				ON P.ApplicationID = @ApplicationID AND P.PollID = IDs.ID
				LEFT JOIN [dbo].[FG_FormInstances] AS FI
				ON FI.ApplicationID = @ApplicationID AND FI.OwnerID = IDs.ID AND
					FI.DirectorID = @CurrentUserID AND FI.Deleted = 0
			GROUP BY IDs.ID
		) AS X
	WHERE X.RowNumber >= ISNULL(@LowerBoundary, 0)
	ORDER BY X.RowNumber ASC
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[FG_IsPoll]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[FG_IsPoll]
GO

CREATE PROCEDURE [dbo].[FG_IsPoll]
	@ApplicationID	uniqueidentifier,
	@strIDs			varchar(max),
	@delimiter		char
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT Ref.Value AS ID
	FROM [dbo].[GFN_StrToGuidTable](@strIDs, @delimiter) AS Ref
		INNER JOIN [dbo].[FG_Polls] AS P
		ON P.ApplicationID = @ApplicationID AND P.PollID = Ref.Value
END

GO


-- end of Polls

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[RV_GetSystemVersion]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[RV_GetSystemVersion]
GO

CREATE PROCEDURE [dbo].[RV_GetSystemVersion]
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT TOP(1) [Version]
	FROM [dbo].[AppSetting]
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[RV_SetApplications]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[RV_SetApplications]
GO

CREATE PROCEDURE [dbo].[RV_SetApplications]
	@ApplicationsTemp	GuidStringTableType readonly
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @Applications GuidStringTableType
	INSERT INTO @Applications SELECT * FROM @ApplicationsTemp
	
	DECLARE @Count int = 0
	
	UPDATE APP
		SET ApplicationName = A.SecondValue,
			LoweredApplicationName = LOWER(A.SecondValue)
	FROM @Applications AS A
		INNER JOIN [dbo].[aspnet_Applications] AS APP
		ON APP.ApplicationId = A.FirstValue
		
	SET @Count = @@ROWCOUNT
		
	INSERT INTO [dbo].[aspnet_Applications](
		ApplicationId,
		ApplicationName,
		LoweredApplicationName
	)
	SELECT A.FirstValue, A.SecondValue, LOWER(A.SecondValue)
	FROM @Applications AS A
		LEFT JOIN [dbo].[aspnet_Applications] AS APP
		ON APP.ApplicationId = A.FirstValue
	WHERE APP.ApplicationId IS NULL
	
	SELECT @@ROWCOUNT + @Count
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[RV_GetApplicationsByIDs]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[RV_GetApplicationsByIDs]
GO

CREATE PROCEDURE [dbo].[RV_GetApplicationsByIDs]
	@strApplicationIDs	varchar(max),
	@delimiter			char
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @ApplicationIDs GuidTableType

	INSERT INTO @ApplicationIDs ([Value]) 
	SELECT DISTINCT Ref.[Value] 
	FROM [dbo].[GFN_StrToGuidTable](@strApplicationIDs, @delimiter) AS Ref
	
	DECLARE @TotalCount int  = ISNULL((SELECT TOP(1) COUNT(*) FROM @ApplicationIDs), 0)
	
	SELECT 
		@TotalCount AS TotalCount,
		A.ApplicationID,
		A.ApplicationName,
		A.Title,
		A.[Description],
		A.CreatorUserID,
		A.ExpertiseFieldID,
		A.ExpertiseFieldName
	FROM @ApplicationIDs AS IDs
		INNER JOIN [dbo].[aspnet_Applications] AS A
		ON A.ApplicationId = IDs.[Value]
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[RV_GetApplications]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[RV_GetApplications]
GO

CREATE PROCEDURE [dbo].[RV_GetApplications]
	@Count			int,
	@LowerBoundary	int
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT TOP(ISNULL(@Count, 100))
		X.RowNumber + X.RevRowNumber - 1 AS TotalCount,
		X.ApplicationID,
		X.ApplicationName,
		X.Title,
		X.[Description],
		X.CreatorUserID,
		X.ExpertiseFieldID,
		X.ExpertiseFieldName
	FROM (
			SELECT	ROW_NUMBER() OVER (ORDER BY ApplicationID DESC) AS RowNumber,
					ROW_NUMBER() OVER (ORDER BY ApplicationID ASC) AS RevRowNumber,
					ApplicationId AS ApplicationID,
					ApplicationName,
					Title,
					[Description],
					CreatorUserID,
					ExpertiseFieldID,
					ExpertiseFieldName
			FROM [dbo].[aspnet_Applications]
		) AS X
	WHERE X.RowNumber >= ISNULL(@LowerBoundary, 0)
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[RV_GetUserApplications]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[RV_GetUserApplications]
GO

CREATE PROCEDURE [dbo].[RV_GetUserApplications]
	@UserID		uniqueidentifier,
	@IsCreator	bit,
	@Archive	bit
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	SET @IsCreator = ISNULL(@IsCreator, 0)
	
	SELECT	0 AS TotalCount,
			App.ApplicationId AS ApplicationID,
			App.ApplicationName,
			App.Title,
			App.[Description],
			CreatorUserID,
			App.ExpertiseFieldID,
			App.ExpertiseFieldName
	FROM [dbo].[USR_UserApplications] AS USR
		INNER JOIN [dbo].[aspnet_Applications] AS App
		ON App.ApplicationId = USR.ApplicationID AND 
			(@IsCreator = 0 OR App.CreatorUserID = @UserID) AND
			(@Archive IS NULL OR ISNULL(App.Deleted, 0) = @Archive)
	WHERE USR.UserID = @UserID
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[RV_AddOrModifyApplication]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[RV_AddOrModifyApplication]
GO

CREATE PROCEDURE [dbo].[RV_AddOrModifyApplication]
	@ApplicationID	uniqueidentifier,
	@Name			nvarchar(255),
	@Title			nvarchar(255),
	@Description	nvarchar(255),
	@CurrentUserID	uniqueidentifier,
	@Now			datetime
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	IF EXISTS(
		SELECT TOP(1) 1
		FROM [dbo].[aspnet_Applications] AS A
		WHERE A.ApplicationId = @ApplicationID
	) BEGIN
		UPDATE [dbo].[aspnet_Applications]
			SET Title = [dbo].[GFN_VerifyString](ISNULL(@Title, N'')),
				[Description] = [dbo].[GFN_VerifyString](ISNULL(@Description, N''))
		WHERE ApplicationId = @ApplicationID	
	END
	ELSE BEGIN
		INSERT INTO [dbo].[aspnet_Applications](
			ApplicationId,
			ApplicationName,
			LoweredApplicationName,
			Title,
			[Description],
			CreatorUserID,
			CreationDate
		)
		VALUES (
			@ApplicationID,
			[dbo].[GFN_VerifyString](ISNULL(@Name, N'')),
			[dbo].[GFN_VerifyString](ISNULL(@Name, N'')),
			[dbo].[GFN_VerifyString](ISNULL(@Title, N'')),
			[dbo].[GFN_VerifyString](ISNULL(@Description, N'')),
			@CurrentUserID,
			@Now
		)
		
		IF @CurrentUserID IS NOT NULL AND @ApplicationID IS NOT NULL BEGIN
			INSERT INTO [dbo].[USR_UserApplications] (ApplicationID, UserID, CreationDate)
			VALUES (@ApplicationID, @CurrentUserID, @Now)
		END
	END
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[RV_SetApplicationSize]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[RV_SetApplicationSize]
GO

CREATE PROCEDURE [dbo].[RV_SetApplicationSize]
	@ApplicationID	uniqueidentifier,
	@Size			varchar(100)
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON

	UPDATE [dbo].[aspnet_Applications]
		SET Size = @Size
	WHERE ApplicationId = @ApplicationID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[RV_SetApplicationFieldOfExpertise]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[RV_SetApplicationFieldOfExpertise]
GO

CREATE PROCEDURE [dbo].[RV_SetApplicationFieldOfExpertise]
	@ApplicationID	uniqueidentifier,
	@FieldID		uniqueidentifier,
	@FieldName		nvarchar(255)
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON

	UPDATE [dbo].[aspnet_Applications]
		SET ExpertiseFieldID = @FieldID,
			ExpertiseFieldName = [dbo].[GFN_VerifyString](@FieldName)
	WHERE ApplicationId = @ApplicationID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[RV_RemoveApplication]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[RV_RemoveApplication]
GO

CREATE PROCEDURE [dbo].[RV_RemoveApplication]
	@ApplicationID	uniqueidentifier
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON

	UPDATE [dbo].[aspnet_Applications]
		SET Deleted = 1
	WHERE ApplicationId = @ApplicationID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[RV_RecycleApplication]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[RV_RecycleApplication]
GO

CREATE PROCEDURE [dbo].[RV_RecycleApplication]
	@ApplicationID	uniqueidentifier
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON

	UPDATE [dbo].[aspnet_Applications]
		SET Deleted = 0
	WHERE ApplicationId = @ApplicationID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[RV_AddUserToApplication]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[RV_AddUserToApplication]
GO

CREATE PROCEDURE [dbo].[RV_AddUserToApplication]
	@ApplicationID	uniqueidentifier,
	@UserID			uniqueidentifier,
	@Now			datetime
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	IF @ApplicationID IS NOT NULL AND @UserID IS NOT NULL AND NOT EXISTS(
		SELECT TOP(1) *
		FROM [dbo].[USR_UserApplications]
		WHERE ApplicationID = @ApplicationID AND UserID = @UserID
	) BEGIN
		INSERT INTO [dbo].[USR_UserApplications] (ApplicationID, UserID, CreationDate)
		VALUES (@ApplicationID, @UserID, @Now)
	END
	
	SELECT CASE WHEN @ApplicationID IS NULL OR @UserID IS NULL THEN 0 ELSE 1 END
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[RV_RemoveUserFromApplication]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[RV_RemoveUserFromApplication]
GO

CREATE PROCEDURE [dbo].[RV_RemoveUserFromApplication]
	@ApplicationID	uniqueidentifier,
	@UserID			uniqueidentifier
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DELETE [dbo].[USR_UserApplications]
	WHERE ApplicationID = @ApplicationID AND UserID = @UserID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[RV_SetVariable]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[RV_SetVariable]
GO

CREATE PROCEDURE [dbo].[RV_SetVariable]
	@ApplicationID	uniqueidentifier,
	@Name			VARCHAR(100),
	@Value			NVARCHAR(MAX),
	@CurrentUserID	UNIQUEIDENTIFIER,
	@Now			DATETIME
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SET @Name = LOWER(@Name)
	
	IF EXISTS(
		SELECT TOP(1) 1 
		FROM [dbo].[RV_Variables] 
		WHERE (@ApplicationID IS NULL OR ApplicationID = @ApplicationID) AND Name = @Name
	) BEGIN
		UPDATE [dbo].[RV_Variables]
			SET Value = @Value,
				LastModifierUserID = @CurrentUserID,
				LastModificationDate = @Now
		WHERE (@ApplicationID IS NULL OR ApplicationID = @ApplicationID) AND Name = @Name
	END
	ELSE BEGIN
		INSERT INTO [dbo].[RV_Variables](
			ApplicationID,
			Name,
			Value,
			LastModifierUserID,
			LastModificationDate
		)
		VALUES(
			@ApplicationID,
			@Name,
			@Value,
			@CurrentUserID,
			@Now
		)
	END
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[RV_GetVariable]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[RV_GetVariable]
GO

CREATE PROCEDURE [dbo].[RV_GetVariable]
	@ApplicationID	uniqueidentifier,
	@Name			varchar(100)
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SET @Name = LOWER(@Name)
	
	SELECT TOP(1) Value
	FROM [dbo].[RV_Variables]
	WHERE (@ApplicationID IS NULL OR ApplicationID = @ApplicationID) AND Name = @Name
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[RV_SetOwnerVariable]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[RV_SetOwnerVariable]
GO

CREATE PROCEDURE [dbo].[RV_SetOwnerVariable]
	@ApplicationID	uniqueidentifier,
	@ID				bigint,
	@OwnerID		uniqueidentifier,
	@Name			VARCHAR(100),
	@Value			NVARCHAR(MAX),
	@CurrentUserID	UNIQUEIDENTIFIER,
	@Now			DATETIME
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	IF @Name IS NOT NULL SET @Name = LOWER(@Name)
	
	IF @ID IS NOT NULL BEGIN
		UPDATE [dbo].[RV_VariablesWithOwner]
			SET Name = LOWER(CASE WHEN ISNULL(@Name, N'') = N'' THEN Name ELSE @Name END),
				Value = @Value,
				LastModifierUserID = @CurrentUserID,
				LastModificationDate = @Now
		WHERE ApplicationID = @ApplicationID AND ID = @ID
		
		IF @@ROWCOUNT > 0 SELECT @ID
		ELSE SELECT NULL
	END
	ELSE BEGIN
		INSERT INTO [dbo].[RV_VariablesWithOwner] (
			ApplicationID,
			OwnerID,
			Name,
			Value,
			CreatorUserID,
			CreationDate,
			Deleted
		)
		VALUES (
			@ApplicationID,
			@OwnerID,
			LOWER(@Name),
			@Value,
			@CurrentUserID,
			@Now,
			0
		)
		
		SELECT @@IDENTITY
	END
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[RV_GetOwnerVariables]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[RV_GetOwnerVariables]
GO

CREATE PROCEDURE [dbo].[RV_GetOwnerVariables]
	@ApplicationID	uniqueidentifier,
	@ID				bigint,
	@OwnerID		uniqueidentifier,
	@Name			varchar(100),
	@CreatorUserID	uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SET @Name = LOWER(@Name)
	
	SELECT	ID,
			OwnerID,
			Name,
			Value,
			CreatorUserID,
			CreationDate
	FROM [dbo].[RV_VariablesWithOwner]
	WHERE ApplicationID = @ApplicationID AND (@ID IS NULL OR ID = @ID) AND 
		(@OwnerID IS NULL OR OwnerID = @OwnerID) AND (@Name IS NULL OR Name = @Name) AND 
		(@CreatorUserID IS NULL OR CreatorUserID = @CreatorUserID) AND Deleted = 0
	ORDER BY ID ASC
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[RV_RemoveOwnerVariable]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[RV_RemoveOwnerVariable]
GO

CREATE PROCEDURE [dbo].[RV_RemoveOwnerVariable]
	@ApplicationID	uniqueidentifier,
	@ID				bigint,
	@CurrentUserID	uniqueidentifier,
	@Now			datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[RV_VariablesWithOwner]
		SET Deleted = 1,
			LastModifierUserID = @CurrentUserID,
			LastModificationDate = @Now
	WHERE ApplicationID = @ApplicationID AND ID = @ID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[RV_AddEmailsToQueue]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[RV_AddEmailsToQueue]
GO

CREATE PROCEDURE [dbo].[RV_AddEmailsToQueue]
	@ApplicationID			uniqueidentifier,
	@EmailQueueItemsTemp	EmailQueueItemTableType readonly
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @EmailQueueItems EmailQueueItemTableType
	INSERT INTO @EmailQueueItems SELECT * FROM @EmailQueueItemsTemp
	
	UPDATE Q
		SET Title = E.Title,
			EmailBody = E.EmailBody
	FROM @EmailQueueItems AS E
		INNER JOIN [dbo].[RV_EmailQueue] AS Q
		ON Q.ApplicationID = @ApplicationID AND Q.SenderUserID = E.SenderUserID AND 
			Q.[Action] = E.[Action] AND Q.Email = LOWER(E.Email)
	
	DECLARE @Result int = @@ROWCOUNT
	
	INSERT INTO [dbo].[RV_EmailQueue](
		ApplicationID,
		SenderUserID,
		[Action],
		Email,
		Title,
		EmailBody
	)
	SELECT @ApplicationID, E.SenderUserID, E.[Action], LOWER(E.Email), E.Title, E.EmailBody
	FROM @EmailQueueItems AS E
		LEFT JOIN [dbo].[RV_EmailQueue] AS Q
		ON Q.ApplicationID = @ApplicationID AND 
			Q.SenderUserID = E.SenderUserID AND Q.[Action] = E.[Action] AND Q.Email = E.Email
	WHERE Q.ID IS NULL
	
	SELECT @@ROWCOUNT + @Result
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[RV_GetEmailQueueItems]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[RV_GetEmailQueueItems]
GO

CREATE PROCEDURE [dbo].[RV_GetEmailQueueItems]
	@ApplicationID	uniqueidentifier,
	@Count			int
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT TOP(ISNULL(@Count, 100))
			E.ID,
			E.SenderUserID,
			E.[Action],
			E.Email,
			E.Title,
			E.EmailBody
	FROM [dbo].[RV_EmailQueue] AS E
	WHERE ApplicationID = @ApplicationID
	ORDER BY E.ID ASC
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[RV_ArchiveEmailQueueItems]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[RV_ArchiveEmailQueueItems]
GO

CREATE PROCEDURE [dbo].[RV_ArchiveEmailQueueItems]
	@ApplicationID	uniqueidentifier,
	@ItemIDsTemp	BigIntTableType readonly,
	@Now			datetime
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @ItemIDs BigIntTableType
	INSERT INTO @ItemIDs SELECT * FROM @ItemIDsTemp
	
	INSERT INTO [dbo].[RV_SentEmails](
		ApplicationID,
		SenderUserID,
		SendDate,
		[Action],
		Email,
		Title,
		EmailBody
	)
	SELECT @ApplicationID, E.SenderUserID, @Now, E.[Action], E.Email, E.Title, E.EmailBody
	FROM @ItemIDs AS IDs
		INNER JOIN [dbo].[RV_EmailQueue] AS E
		ON E.ApplicationID = @ApplicationID AND E.ID = IDs.Value
		
		
	DELETE E
	FROM @ItemIDs AS IDs
		INNER JOIN [dbo].[RV_EmailQueue] AS E
		ON E.ApplicationID = @ApplicationID AND E.ID = IDs.Value
		
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[RV_P_SetDeletedStates]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[RV_P_SetDeletedStates]
GO

CREATE PROCEDURE [dbo].[RV_P_SetDeletedStates]
	@ApplicationID	uniqueidentifier,
	@ObjectsTemp	GuidBitTableType readonly,
	@ObjectType		varchar(50),
	@Now			datetime,
	@_Result		int output
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @Objects GuidBitTableType
	INSERT INTO @Objects SELECT * FROM @ObjectsTemp
	
	IF @Now IS NULL SET @Now = GETDATE()
	
	DELETE D
	FROM @Objects AS O
		INNER JOIN [dbo].[RV_DeletedStates] AS D
		ON D.ApplicationID = @ApplicationID AND D.ObjectID = O.FirstValue
		
	INSERT INTO [dbo].[RV_DeletedStates](ApplicationID, ObjectID, ObjectType, Deleted, [Date])
	SELECT @ApplicationID, O.FirstValue, @ObjectType, O.SecondValue, @Now
	FROM @Objects AS O
		
	SET @_Result = @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[RV_GetDeletedStates]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[RV_GetDeletedStates]
GO

CREATE PROCEDURE [dbo].[RV_GetDeletedStates]
	@ApplicationID	uniqueidentifier,
	@Count			int,
	@StartFrom		bigint
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	IF ISNULL(@Count, 0) < 1 SET @Count = 1000
	
	SELECT TOP(@Count)
		D.ID,
		D.ObjectID,
		D.ObjectType,
		D.[Date],
		D.Deleted,
		CASE
			WHEN ObjectType = N'NodeRelation' THEN CAST(1 as bit)
			WHEN ObjectType = N'Friend' AND FR.AreFriends = 1 THEN CAST(1 as bit)
			ELSE CAST(0 as bit)
		END AS Bidirectional,
		CASE
			WHEN ObjectType = N'Friend' AND FR.AreFriends = 0 THEN CAST(1 as bit)
			WHEN ObjectType = N'NodeMember' THEN CAST(1 as bit)
			WHEN ObjectType = N'Expert' THEN CAST(1 as bit)
			WHEN ObjectType = N'NodeLike' THEN CAST(1 as bit)
			WHEN ObjectType = N'ItemVisit' THEN CAST(1 as bit)
			WHEN ObjectType = N'NodeCreator' THEN CAST(1 as bit)
			WHEN ObjectType = N'TaggedItem' THEN CAST(1 as bit)
			WHEN ObjectType = N'WikiChange' THEN CAST(1 as bit)
			ELSE CAST(0 as bit)
		END AS HasReverse,
		CASE
			WHEN ObjectType = N'NodeCreator' THEN NC.NodeID
			WHEN ObjectType = N'NodeRelation' THEN NR.SourceNodeID
			WHEN ObjectType = N'NodeMember' THEN NM.NodeID
			WHEN ObjectType = N'Expert' THEN EX.NodeID
			WHEN ObjectType = N'NodeLike' THEN NL.NodeID
			WHEN ObjectType = N'ItemVisit' THEN IV.ItemID
			WHEN ObjectType = N'Friend' THEN FR.SenderUserID
			WHEN ObjectType = N'WikiChange' THEN WT.OwnerID
			WHEN ObjectType = N'TaggedItem' AND TI.ContextType = N'WikiChange' THEN TGWT.OwnerID
			WHEN ObjectType = N'TaggedItem' AND TI.ContextType = N'Post' THEN TGPS.OwnerID
			WHEN ObjectType = N'TaggedItem' AND TI.ContextType = N'Comment' THEN TGPS2.OwnerID
			ELSE NULL
		END AS RelSourceID,
		CASE
			WHEN ObjectType = N'NodeCreator' THEN NC.UserID
			WHEN ObjectType = N'NodeRelation' THEN NR.DestinationNodeID
			WHEN ObjectType = N'NodeMember' THEN NM.UserID
			WHEN ObjectType = N'Expert' THEN EX.UserID
			WHEN ObjectType = N'NodeLike' THEN NL.UserID
			WHEN ObjectType = N'ItemVisit' THEN IV.UserID
			WHEN ObjectType = N'Friend' THEN FR.ReceiverUserID
			WHEN ObjectType = N'WikiChange' THEN WC.UserID
			WHEN ObjectType = N'TaggedItem' THEN TI.TaggedID
			ELSE NULL
		END AS RelDestinationID,
		CASE
			WHEN ObjectType = N'NodeCreator' THEN N'Node'
			WHEN ObjectType = N'NodeRelation' THEN N'Node'
			WHEN ObjectType = N'NodeMember' THEN N'Node'
			WHEN ObjectType = N'Expert' THEN N'Node'
			WHEN ObjectType = N'NodeLike' THEN N'Node'
			WHEN ObjectType = N'ItemVisit' AND IV.ItemType = N'User' THEN N'User'
			WHEN ObjectType = N'ItemVisit' THEN N'Node'
			WHEN ObjectType = N'Friend' THEN N'User'
			WHEN ObjectType = N'WikiChange' THEN N'Node'
			WHEN ObjectType = N'TaggedItem' AND TI.ContextType = N'WikiChange' THEN N'Node'
			WHEN ObjectType = N'TaggedItem' AND TGUN.UserID IS NOT NULL THEN N'User'
			WHEN ObjectType = N'TaggedItem' THEN N'Node'
			ELSE NULL
		END AS RelSourceType,
		CASE
			WHEN ObjectType = N'NodeCreator' THEN N'User'
			WHEN ObjectType = N'NodeRelation' THEN N'User'
			WHEN ObjectType = N'NodeMember' THEN N'User'
			WHEN ObjectType = N'Expert' THEN N'User'
			WHEN ObjectType = N'NodeLike' THEN N'User'
			WHEN ObjectType = N'ItemVisit' THEN N'User'
			WHEN ObjectType = N'Friend' THEN N'User'
			WHEN ObjectType = N'WikiChange' THEN N'User'
			WHEN ObjectType = N'TaggedItem' THEN TI.TaggedType
			ELSE NULL
		END AS RelDestinationType,
		CASE
			WHEN ObjectType = N'TaggedItem' THEN TI.CreatorUserID
			ELSE NULL
		END AS RelCreatorID
	FROM [dbo].[RV_DeletedStates] AS D
		LEFT JOIN [dbo].[CN_NodeCreators] AS NC
		ON NC.ApplicationID = @ApplicationID AND NC.UniqueID = D.ObjectID
		LEFT JOIN [dbo].[CN_NodeRelations] AS NR
		ON NR.ApplicationID = @ApplicationID AND NR.UniqueID = D.ObjectID
		LEFT JOIN [dbo].[CN_NodeMembers] AS NM
		ON NM.ApplicationID = @ApplicationID AND NM.UniqueID = D.ObjectID
		LEFT JOIN [dbo].[CN_Experts] AS EX
		ON EX.ApplicationID = @ApplicationID AND EX.UniqueID = D.ObjectID
		LEFT JOIN [dbo].[CN_NodeLikes] AS NL
		ON NL.ApplicationID = @ApplicationID AND NL.UniqueID = D.ObjectID
		LEFT JOIN [dbo].[USR_ItemVisits] AS IV
		ON IV.ApplicationID = @ApplicationID AND IV.UniqueID = D.ObjectID
		LEFT JOIN [dbo].[USR_Friends] AS FR
		ON FR.ApplicationID = @ApplicationID AND FR.UniqueID = D.ObjectID
		LEFT JOIN [dbo].[WK_Changes] AS WC
		ON WC.ApplicationID = @ApplicationID AND WC.ChangeID = D.ObjectID
		LEFT JOIN [dbo].[WK_Paragraphs] AS WP
		ON WP.ApplicationID = @ApplicationID AND WP.ParagraphID = WC.ParagraphID
		LEFT JOIN [dbo].[WK_Titles] AS WT
		ON WT.ApplicationID = @ApplicationID AND WT.TitleID = WP.TitleID
		LEFT JOIN [dbo].[RV_TaggedItems] AS TI
		ON TI.ApplicationID = @ApplicationID AND TI.UniqueID = D.ObjectID
		LEFT JOIN [dbo].[WK_Paragraphs] AS TGWP
		ON TGWP.ApplicationID = @ApplicationID AND TGWP.ParagraphID = TI.ContextID
		LEFT JOIN [dbo].[WK_Titles] AS TGWT
		ON TGWT.ApplicationID = @ApplicationID AND TGWT.TitleID = TGWP.TitleID
		LEFT JOIN [dbo].[SH_PostShares] AS TGPS
		ON TGPS.ApplicationID = @ApplicationID AND TGPS.ShareID = TI.ContextID
		LEFT JOIN [dbo].[SH_Comments] AS TGPC
		ON TGPC.ApplicationID = @ApplicationID AND TGPC.CommentID = TI.ContextID
		LEFT JOIN [dbo].[SH_PostShares] AS TGPS2
		ON TGPS2.ApplicationID = @ApplicationID AND TGPS2.ShareID = TGPC.ShareID
		LEFT JOIN [dbo].[Users_Normal] AS TGUN
		ON TGUN.ApplicationID = @ApplicationID AND
			TGUN.UserID = TGPS.OwnerID OR TGUN.UserID = TGPS2.OwnerID
	WHERE D.ApplicationID = @ApplicationID AND D.ID >= ISNULL(@StartFrom, 0)
	ORDER BY D.ID ASC
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[RV_GetGuids]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[RV_GetGuids]
GO

CREATE PROCEDURE [dbo].[RV_GetGuids]
	@ApplicationID		uniqueidentifier,
	@IDsTemp			StringTableType readonly,
	@Type				varchar(100),
	@Exist				bit,
	@CreateIfNotExist	bit
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @IDs StringTableType
	INSERT INTO @IDs SELECT * FROM @IDsTemp
	
	DECLARE @TBL TABLE (ID varchar(100), [Exists] bit, [Guid] uniqueidentifier)
	
	INSERT INTO @TBL (ID, [Exists], [Guid])
	SELECT I.Value, (CASE WHEN G.ID IS NULL THEN 0 ELSE 1 END), ISNULL(G.[Guid], NEWID())
	FROM @IDs AS I
		LEFT JOIN [dbo].[RV_ID2Guid] AS G
		ON G.ApplicationID = @ApplicationID AND G.ID = I.Value AND G.[Type] = @Type
		
	IF @CreateIfNotExist = 1 BEGIN
		INSERT INTO [dbo].[RV_ID2Guid](ApplicationID, ID, [Type], [Guid])
		SELECT @ApplicationID, I.ID, @Type, I.[Guid] 
		FROM @TBL AS I
		WHERE I.[Exists] = 0
	END
	
	SELECT I.ID, I.[Guid]
	FROM @TBL AS I
	WHERE @Exist IS NULL OR I.[Exists] = @Exist
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[RV_SaveTaggedItems]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[RV_SaveTaggedItems]
GO

CREATE PROCEDURE [dbo].[RV_SaveTaggedItems]
	@ApplicationID		uniqueidentifier,
	@TaggedItemsTemp	TaggedItemTableType readonly,
	@RemoveOldTags		bit,
	@CurrentUserID		uniqueidentifier
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @TaggedItems TaggedItemTableType
	INSERT INTO @TaggedItems SELECT * FROM @TaggedItemsTemp
	
	IF @RemoveOldTags = 1 BEGIN
		DELETE TI
		FROM (
				SELECT DISTINCT I.ContextID
				FROM @TaggedItems AS I
			) AS Con
			INNER JOIN [dbo].[RV_TaggedItems] AS TI
			ON TI.ApplicationID = @ApplicationID AND TI.ContextID = Con.ContextID
			LEFT JOIN @TaggedItems AS T
			ON T.ContextID = TI.ContextID AND T.TaggedID = TI.TaggedID
		WHERE T.ContextID IS NULL
	END
	
	INSERT INTO [dbo].[RV_TaggedItems](
		ApplicationID,
		ContextID,
		TaggedID,
		CreatorUserID,
		ContextType,
		TaggedType,
		UniqueID
	)
	SELECT @ApplicationID, TI.ContextID, TI.TaggedID, 
		@CurrentUserID, TI.ContextType, TI.TaggedType, NEWID()
	FROM (
			SELECT DISTINCT * 
			FROM @TaggedItems
		) AS TI
		LEFT JOIN [dbo].[RV_TaggedItems] AS T
		ON T.ApplicationID = @ApplicationID AND T.ContextID = TI.ContextID AND 
			T.TaggedID = TI.TaggedID AND T.CreatorUserID = @CurrentUserID
	WHERE TI.TaggedID IS NOT NULL AND T.ContextID IS NULL
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[RV_GetTaggedItems]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[RV_GetTaggedItems]
GO

CREATE PROCEDURE [dbo].[RV_GetTaggedItems]
	@ApplicationID		uniqueidentifier,
	@ContextID			uniqueidentifier,
	@TaggedTypesTemp	StringTableType readonly
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @TaggedTypes StringTableType
	INSERT INTO @TaggedTypes SELECT * FROM @TaggedTypesTemp
	
	DECLARE @TaggedTypesCount int = (SELECT COUNT(*) FROM @TaggedTypes)
	
	SELECT	TI.TaggedID AS ID,
			TI.TaggedType AS [Type]
	FROM [dbo].[RV_TaggedItems] AS TI
	WHERE TI.ApplicationID = @ApplicationID AND TI.ContextID = @ContextID AND
		(@TaggedTypesCount = 0 OR TI.TaggedType IN (SELECT Value FROM @TaggedTypes))
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[RV_AddSystemAdmin]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[RV_AddSystemAdmin]
GO

CREATE PROCEDURE [dbo].[RV_AddSystemAdmin]
	@ApplicationID		uniqueidentifier,
	@UserID				uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @AdminRoleID uniqueidentifier = (
		SELECT TOP(1) RoleID
		FROM [dbo].[aspnet_Roles]
		WHERE ApplicationID = @ApplicationID AND LoweredRoleName = N'admins'
	)

	IF @AdminRoleID IS NULL BEGIN
		SET @AdminRoleID = NEWID()
	
		INSERT INTO [dbo].[aspnet_Roles] (
			ApplicationID,
			RoleID,
			RoleName,
			LoweredRoleName
		)
		VALUES (
			@ApplicationID,
			@AdminRoleID,
			N'Admins',
			N'admins'
		)
	END
	
	IF EXISTS(
		SELECT TOP(1) 1
		FROM [dbo].[aspnet_UsersInRoles]
		WHERE UserId = @UserID AND RoleId = @AdminRoleID
	) BEGIN
		SELECT 1
	END
	ELSE BEGIN
		INSERT INTO [dbo].[aspnet_UsersInRoles] (UserID, RoleID)
		VALUES (@UserID, @AdminRoleID)
		
		SELECT @@ROWCOUNT
	END
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[RV_IsSystemAdmin]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[RV_IsSystemAdmin]
GO

CREATE PROCEDURE [dbo].[RV_IsSystemAdmin]
	@ApplicationID		uniqueidentifier,
	@UserID				uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT [dbo].[GFN_IsSystemAdmin](@ApplicationID, @UserID)
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[RV_GetFileExtension]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[RV_GetFileExtension]
GO

CREATE PROCEDURE [dbo].[RV_GetFileExtension]
	@ApplicationID		uniqueidentifier,
	@FileID				uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT TOP(1) F.Extension AS Value
	FROM [dbo].[DCT_Files] AS F
	WHERE F.ApplicationID = @ApplicationID AND 
		(F.ID = @FileID OR F.FileNameGuid = @FileID)
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[RV_LikeDislikeUnlike]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[RV_LikeDislikeUnlike]
GO

CREATE PROCEDURE [dbo].[RV_LikeDislikeUnlike]
	@ApplicationID		uniqueidentifier,
	@UserID				uniqueidentifier,
	@LikedID			uniqueidentifier,
	@Like				bit,
	@Now				datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	IF @Like IS NULL BEGIN
		DELETE [dbo].[RV_Likes]
		WHERE ApplicationID = @ApplicationID AND UserID = @UserID AND LikedID = @LikedID
	END
	ELSE BEGIN
		UPDATE [dbo].[RV_Likes]
			SET [Like] = @Like,
				ActionDate = ISNULL(ActionDate, @Now)
		WHERE ApplicationID = @ApplicationID AND 
			UserID = @UserID AND LikedID = @LikedID
			
		IF @@ROWCOUNT = 0 BEGIN
			INSERT INTO [dbo].[RV_Likes] (
				ApplicationID,
				UserID,
				LikedID,
				[Like],
				ActionDate
			)
			VALUES (
				@ApplicationID,
				@UserID,
				@LikedID,
				@Like,
				@Now
			)
		END
	END
	
	SELECT 1
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[RV_GetFanIDs]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[RV_GetFanIDs]
GO

CREATE PROCEDURE [dbo].[RV_GetFanIDs]
	@ApplicationID		uniqueidentifier,
	@LikedID			uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT L.UserID AS ID
	FROM [dbo].[RV_Likes] AS L
	WHERE L.ApplicationID =  @ApplicationID AND L.LikedID = @LikedID
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[RV_FollowUnfollow]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[RV_FollowUnfollow]
GO

CREATE PROCEDURE [dbo].[RV_FollowUnfollow]
	@ApplicationID		uniqueidentifier,
	@UserID				uniqueidentifier,
	@FollowedID			uniqueidentifier,
	@Follow				bit,
	@Now				datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	IF ISNULL(@Follow, 0) = 0 BEGIN
		DELETE [dbo].[RV_Followers]
		WHERE ApplicationID = @ApplicationID AND FollowedID = @FollowedID AND UserID = @UserID
	END
	ELSE BEGIN
		UPDATE [dbo].[RV_Followers]
			SET ActionDate = ISNULL(ActionDate, @Now)
		WHERE ApplicationID = @ApplicationID AND 
			FollowedID = @FollowedID AND UserID = @UserID
			
		IF @@ROWCOUNT = 0 BEGIN
			INSERT INTO [dbo].[RV_Followers] (
				ApplicationID,
				UserID,
				FollowedID,
				ActionDate
			)
			VALUES (
				@ApplicationID,
				@UserID,
				@FollowedID,
				@Now
			)
		END
	END
	
	SELECT 1
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[RV_SetSystemSettings]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[RV_SetSystemSettings]
GO

CREATE PROCEDURE [dbo].[RV_SetSystemSettings]
	@ApplicationID	uniqueidentifier,
	@ItemsTemp		StringPairTableType readonly,
	@CurrentUserID	uniqueidentifier,
	@Now			datetime
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @Items StringPairTableType
	INSERT INTO @Items SELECT * FROM @ItemsTemp
	
	UPDATE S
		SET Value = I.SecondValue,
			LastModifierUserID = @CurrentUserID,
			LastModificationDate = @Now
	FROM @Items AS I
		INNER JOIN [dbo].[RV_SystemSettings] AS S
		ON S.ApplicationID = @ApplicationID AND S.Name = I.FirstValue
		
	INSERT INTO [dbo].[RV_SystemSettings] (ApplicationID, Name, Value, 
		LastModifierUserID, LastModificationDate)
	SELECT @ApplicationID, I.FirstValue, [dbo].[GFN_VerifyString](I.SecondValue), @CurrentUserID, @Now
	FROM @Items AS I
		LEFT JOIN [dbo].[RV_SystemSettings] AS S
		ON S.ApplicationID = @ApplicationID AND S.Name = I.FirstValue
	WHERE S.ID IS NULL
	
	SELECT 1
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[RV_GetSystemSettings]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[RV_GetSystemSettings]
GO

CREATE PROCEDURE [dbo].[RV_GetSystemSettings]
	@ApplicationID	uniqueidentifier,
	@strItemNames	varchar(2000),
	@delimiter		char
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @Names StringTableType
	
	INSERT INTO @Names (Value)
	SELECT DISTINCT Ref.Value
	FROM [dbo].[GFN_StrToStringTable](@strItemNames, @delimiter) AS Ref
	
	DECLARE @Count int = (SELECT COUNT(*) FROM @Names)
	
	SELECT S.[Name], S.[Value]
	FROM [dbo].[RV_SystemSettings] AS S
	WHERE S.ApplicationID = @ApplicationID AND 
		(@Count = 0 OR S.Name IN (SELECT N.Value FROM @Names AS N))
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[RV_GetLastContentCreators]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[RV_GetLastContentCreators]
GO

CREATE PROCEDURE [dbo].[RV_GetLastContentCreators]
	@ApplicationID		uniqueidentifier,
	@Count				int
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	;WITH Users
	AS
	(
		SELECT	X.UserID, 
				MAX(X.[Date]) AS [Date],
				N'Post' AS [Type]
		FROM (
				SELECT TOP(20) PS.SenderUserID AS UserID, PS.SendDate AS [Date]
				FROM [dbo].[SH_PostShares] AS PS
				WHERE PS.ApplicationID = @ApplicationID AND PS.Deleted = 0
				ORDER BY PS.SendDate DESC
			) AS X
		GROUP BY X.UserID

		UNION ALL

		SELECT	X.UserID, 
				MAX(X.[Date]) AS [Date],
				N'Question' AS [Type]
		FROM (
				SELECT TOP(20) Q.SenderUserID AS UserID, Q.SendDate AS [Date]
				FROM [dbo].[QA_Questions] AS Q
				WHERE Q.ApplicationID = @ApplicationID AND 
					Q.PublicationDate IS NOT NULL AND Q.Deleted = 0
				ORDER BY Q.SendDate DESC
			) AS X
		GROUP BY X.UserID

		UNION ALL

		SELECT	X.UserID, 
				MAX(X.[Date]) AS [Date],
				N'Node' AS [Type]
		FROM (
				SELECT TOP(20) ND.CreatorUserID AS UserID, ND.CreationDate AS [Date]
				FROM [dbo].[CN_Nodes] AS ND
				WHERE ND.ApplicationID = @ApplicationID AND ND.Deleted = 0
				ORDER BY ND.CreationDate DESC
			) AS X
		GROUP BY X.UserID

		UNION ALL

		SELECT	X.UserID, 
				MAX(X.[Date]) AS [Date],
				N'Wiki' AS [Type]
		FROM (
				SELECT TOP(20) C.UserID AS UserID, C.SendDate  AS [Date]
				FROM [dbo].[WK_Changes] AS C
				WHERE C.ApplicationID = @ApplicationID AND C.Applied = 1
				ORDER BY C.SendDate DESC
			) AS X
		GROUP BY X.UserID
	)
	SELECT TOP(ISNULL(@Count, 10))
		X.UserID,
		UN.UserName,
		UN.FirstName,
		UN.LastName,
		X.[Date],
		X.[Types]
	FROM (
			SELECT	Users.UserID, 
					MAX(Users.[Date]) AS [Date],
					STUFF((
						SELECT ',' + [Type]
						FROM Users AS x
						WHERE UserID = Users.UserID
						FOR XML PATH(''),TYPE).value('(./text())[1]','VARCHAR(MAX)')
					  ,1,1,'') AS [Types]
			FROM Users
			GROUP BY Users.UserID
		) AS X
		INNER JOIN [dbo].[Users_Normal] AS UN
		ON UN.ApplicationID = @ApplicationID AND UN.UserID = X.UserID
	ORDER BY X.[Date] DESC
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[RV_RaaiVanStatistics]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[RV_RaaiVanStatistics]
GO

CREATE PROCEDURE [dbo].[RV_RaaiVanStatistics]
	@ApplicationID	uniqueidentifier,
	@DateFrom		datetime,
	@DateTo			datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT 
		(
			SELECT COUNT(NodeID)
			FROM [dbo].[CN_View_Nodes_Normal]
			WHERE ApplicationID = @ApplicationID AND Deleted = 0 AND
				(@DateFrom IS NULL OR CreationDate >= @DateFrom) AND
				(@DateTo IS NULL OR CreationDate <= @DateTo)
		) AS NodesCount,
		(
			SELECT COUNT(QuestionID)
			FROM [dbo].[QA_Questions]
			WHERE ApplicationID = @ApplicationID AND PublicationDate IS NOT NULL AND Deleted = 0 AND
				(@DateFrom IS NULL OR SendDate >= @DateFrom) AND
				(@DateTo IS NULL OR SendDate <= @DateTo)
		) AS QuestionsCount,
		(
			SELECT COUNT(A.AnswerID)
			FROM [dbo].[QA_Answers] AS A
				INNER JOIN [dbo].[QA_Questions] AS Q
				ON Q.ApplicationID = @ApplicationID AND Q.QuestionID = A.QuestionID AND 
					Q.PublicationDate IS NOT NULL AND Q.Deleted = 0
			WHERE A.ApplicationID = @ApplicationID AND A.Deleted = 0 AND
				(@DateFrom IS NULL OR A.SendDate >= @DateFrom) AND
				(@DateTo IS NULL OR A.SendDate <= @DateTo)
		) AS AnswersCount,
		(
			SELECT COUNT(C.ChangeID)
			FROM [dbo].[WK_Changes] AS C
			WHERE C.ApplicationID = @ApplicationID AND C.Applied = 1 AND C.Deleted = 0 AND
				(@DateFrom IS NULL OR C.SendDate >= @DateFrom) AND
				(@DateTo IS NULL OR C.SendDate <= @DateTo)
		) AS WikiChangesCount,
		(
			SELECT COUNT(PS.ShareID)
			FROM [dbo].[SH_PostShares] AS PS
			WHERE PS.ApplicationID = @ApplicationID AND PS.[Deleted] = 0 AND
				(@DateFrom IS NULL OR PS.SendDate >= @DateFrom) AND
				(@DateTo IS NULL OR PS.SendDate <= @DateTo)
		) AS PostsCount,
		(
			SELECT COUNT(C.CommentID)
			FROM [dbo].[SH_Comments] AS C
			WHERE C.ApplicationID = @ApplicationID AND C.[Deleted] = 0 AND
				(@DateFrom IS NULL OR C.SendDate >= @DateFrom) AND
				(@DateTo IS NULL OR C.SendDate <= @DateTo)
		) AS CommentsCount,
		(
			SELECT COUNT(DISTINCT LG.UserID)
			FROM [dbo].[LG_Logs] AS LG
			WHERE LG.ApplicationID = @ApplicationID AND LG.[Action] = N'Login' AND
				(@DateFrom IS NULL OR LG.[Date] >= @DateFrom) AND
				(@DateTo IS NULL OR LG.[Date] <= @DateTo)
		) AS ActiveUsersCount,
		(
			SELECT COUNT(ItemID) 
			FROM [dbo].[CN_Nodes] AS ND
				INNER JOIN [dbo].[USR_ItemVisits] AS IV
				ON IV.ApplicationID = @ApplicationID AND IV.[ItemID] = ND.NodeID
			WHERE ND.ApplicationID = @ApplicationID AND ND.NodeID = IV.ItemID AND ND.Deleted = 0 AND
				(@DateFrom IS NULL OR IV.VisitDate >= @DateFrom) AND
				(@DateTo IS NULL OR IV.VisitDate <= @DateTo)
		) AS NodePageVisitsCount,
		(
			SELECT COUNT(LogID)
			FROM [dbo].[LG_Logs] AS LG
			WHERE LG.ApplicationID = @ApplicationID AND LG.[Action] = N'Search' AND
				(@DateFrom IS NULL OR LG.[Date] >= @DateFrom) AND
				(@DateTo IS NULL OR LG.[Date] <= @DateTo)
		) AS SearchesCount
END

GO



IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[RV_SchemaInfo]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[RV_SchemaInfo]
GO

CREATE PROCEDURE [dbo].[RV_SchemaInfo]
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON

	SELECT	TBL.TABLE_NAME AS [Table], 
			CLM.COLUMN_NAME AS [Column], 
			CAST(CASE WHEN PRM.COLUMN_NAME IS NULL THEN 0 ELSE 1 END AS bit) AS IsPrimaryKey,
			CAST(COLUMNPROPERTY(object_id(TBL.TABLE_NAME), CLM.COLUMN_NAME, 'IsIdentity') AS bit) AS IsIdentity,
			CAST(CASE WHEN CLM.IS_NULLABLE = 'YES' THEN 1 ELSE 0 END AS bit) AS IsNullable, 
			UPPER(CLM.DATA_TYPE) AS DataType, 
			CLM.CHARACTER_MAXIMUM_LENGTH AS [MaxLength],
			CLM.ORDINAL_POSITION AS [Order],
			CLM.COLUMN_DEFAULT AS DefaultValue
	FROM INFORMATION_SCHEMA.TABLES AS TBL
		INNER JOIN INFORMATION_SCHEMA.COLUMNS AS CLM
		ON CLM.TABLE_NAME = TBL.TABLE_NAME
		LEFT JOIN (
			SELECT CCU.TABLE_NAME, CCU.COLUMN_NAME
			FROM INFORMATION_SCHEMA.TABLE_CONSTRAINTS AS CNT
				INNER JOIN INFORMATION_SCHEMA.CONSTRAINT_COLUMN_USAGE AS CCU
				ON CCU.CONSTRAINT_NAME = CNT.CONSTRAINT_NAME
			WHERE CNT.CONSTRAINT_TYPE = N'PRIMARY KEY'
		) AS PRM
		ON PRM.TABLE_NAME = TBL.TABLE_NAME AND PRM.COLUMN_NAME = CLM.COLUMN_NAME
	WHERE TBL.TABLE_TYPE = N'BASE TABLE'
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[RV_ForeignKeys]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[RV_ForeignKeys]
GO

CREATE PROCEDURE [dbo].[RV_ForeignKeys]
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON

	SELECT	OBJ.[name] AS [Name],
			FromTable.[name] AS [Table],
			FromColumn.[name] AS [Column],
			ToTable.[name] AS RefTable,
			ToColumn.[name] AS RefColumn
	FROM sys.foreign_key_columns AS FKC
		INNER JOIN sys.objects AS OBJ
		ON OBJ.object_id = FKC.constraint_object_id
		INNER JOIN sys.tables AS FromTable
		ON FromTable.object_id = FKC.parent_object_id
		INNER JOIN sys.columns AS FromColumn
		ON FromColumn.column_id = FKC.parent_column_id AND FromColumn.object_id = FromTable.object_id
		INNER JOIN sys.tables AS ToTable
		ON ToTable.object_id = FKC.referenced_object_id
		INNER JOIN sys.columns AS ToColumn
		ON ToColumn.column_id = FKC.referenced_column_id AND ToColumn.object_id = ToTable.object_id
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[RV_Indexes]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[RV_Indexes]
GO

CREATE PROCEDURE [dbo].[RV_Indexes]
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON

	SELECT	Ind.[name] AS [Name], 
			OBJECT_NAME(Ind.[object_id]) AS [Table],
			COL_NAME(Col.object_id, Col.column_id) AS [Column],
			CAST(Col.key_ordinal AS int) AS [Order],
			Col.is_descending_key AS IsDescending,
			is_unique AS IsUnique,
			is_unique_constraint AS IsUniqueConstraint,
			Col.is_included_column AS IsIncludedColumn,
			[type_desc] AS IndexType
	FROM sys.indexes AS Ind
		INNER JOIN sys.index_columns AS Col
		ON Col.object_id = Ind.object_id AND Col.index_id = Ind.index_id
	WHERE OBJECT_SCHEMA_NAME(ind.[object_id]) = 'dbo' AND ind.is_primary_key = 0 AND 
		Ind.[type_desc] <> 'HEAP' AND OBJECTPROPERTY(Ind.[object_id], 'IsTable') = 1
	ORDER BY OBJECT_NAME(Ind.[object_id])
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[RV_UserDefinedTableTypes]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[RV_UserDefinedTableTypes]
GO

CREATE PROCEDURE [dbo].[RV_UserDefinedTableTypes]
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON

	SELECT	TP.[name] AS [Name],
			COL.[name] AS [Column],
			CAST(COL.column_id AS int) AS [Order],
			ST.[name] AS [DataType],
			CAST(COL.Is_Nullable AS bit) AS IsNullable,
			CAST(COL.is_identity AS bit) AS IsIdentity,
			CAST(COL.max_length AS int) AS [MaxLength]
	FROM sys.table_types AS TP
		INNER JOIN sys.columns AS COL
		ON TP.type_table_object_id = COL.object_id
		INNER JOIN sys.systypes AS ST  
		ON ST.xtype = COL.system_type_id
	where TP.is_user_defined = 1 AND ST.[name] <> 'sysname'
	ORDER BY TP.[name], COL.column_id
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[RV_FullTextIndexes]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[RV_FullTextIndexes]
GO

CREATE PROCEDURE [dbo].[RV_FullTextIndexes]
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON

	SELECT	OBJECT_NAME(Ind.object_id) AS [Table], 
			C.[name] AS [Column],
			T.[name] AS DataType,
			CAST(C.max_length AS int) AS [MaxLength],
			CAST(C.is_identity AS bit) AS IsIdentity
	FROM sys.fulltext_indexes AS Ind
		INNER JOIN sys.fulltext_index_columns AS Col
		ON Col.object_id = Ind.object_id
		INNER JOIN sys.columns AS C
		ON C.object_id = Col.object_id AND C.column_id = Col.column_id
		INNER JOIN sys.types AS T
		ON C.system_type_id = T.system_type_id
END

GO


SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[NTFN_SendNotification]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[NTFN_SendNotification]
GO

CREATE PROCEDURE [dbo].[NTFN_SendNotification]
	@ApplicationID	uniqueidentifier,
    @UsersTemp		GuidStringTableType readonly,
    @SubjectID 		uniqueidentifier,
    @RefItemID 		uniqueidentifier,
    @SubjectType	varchar(20),
    @SubjectName	nvarchar(2000),
    @Action			varchar(20),
    @SenderUserID 	uniqueidentifier,
    @SendDate		datetime,
    @Description	nvarchar(2000),
    @Info			nvarchar(2000)
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @Users GuidStringTableType
	INSERT INTO @Users SELECT * FROM @UsersTemp
	
	DECLARE @VU GuidStringTableType
	INSERT INTO @VU(FirstValue, SecondValue)
	SELECT Ref.FirstValue, Ref.SecondValue
	FROM @Users AS Ref
		INNER JOIN [dbo].[Users_Normal] AS UN
		ON UN.ApplicationID = @ApplicationID AND UN.UserID = Ref.FirstValue

	INSERT INTO [dbo].[NTFN_Notifications](
		ApplicationID,
		UserID,
		SubjectID,
		RefItemID,
		SubjectType,
		SubjectName,
		[Action],
		SenderUserID,
		SendDate,
		[Description],
		Info,
		UserStatus,
		Seen,
		Deleted
	)
	SELECT @ApplicationID, Ref.FirstValue, @SubjectID, @RefItemID, @SubjectType, 
		@SubjectName, @Action, @SenderUserID, @SendDate, @Description, 
		@Info, Ref.SecondValue, 0, 0
	FROM @VU AS Ref
	WHERE Ref.FirstValue <> @SenderUserID AND 
		NOT EXISTS(
			SELECT TOP(1) * 
			FROM [dbo].[NTFN_Notifications]
			WHERE ApplicationID = @ApplicationID AND UserID = Ref.FirstValue AND 
				SubjectID = @SubjectID AND RefItemID = @RefItemID AND 
				[Action] = @Action AND SenderUserID = @SenderUserID AND Deleted = 0
		)
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[NTFN_SetNotificationsAsSeen]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[NTFN_SetNotificationsAsSeen]
GO

CREATE PROCEDURE [dbo].[NTFN_SetNotificationsAsSeen]
	@ApplicationID	uniqueidentifier,
	@UserID			uniqueidentifier,
    @strIDs			varchar(max),
    @delimiter		char,
    @ViewDate		datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @IDs BigIntTableType
	INSERT INTO @IDs
	SELECT DISTINCT Ref.Value 
	FROM [dbo].[GFN_StrToBigIntTable](@strIDs, @delimiter) AS Ref
	
	UPDATE N
		SET Seen = 1,
			ViewDate = @ViewDate
	FROM @IDs AS Ref
		INNER JOIN [dbo].[NTFN_Notifications] AS N
		ON N.[ID] = Ref.Value
	WHERE N.ApplicationID = @ApplicationID AND N.UserID = @UserID AND N.Seen = 0
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[NTFN_SetUserNotificationsAsSeen]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[NTFN_SetUserNotificationsAsSeen]
GO

CREATE PROCEDURE [dbo].[NTFN_SetUserNotificationsAsSeen]
	@ApplicationID	uniqueidentifier,
    @UserID			uniqueidentifier,
    @ViewDate		datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON

	UPDATE [dbo].[NTFN_Notifications]
		SET Seen = 1,
			ViewDate = @ViewDate
	WHERE ApplicationID = @ApplicationID AND UserID = @UserID AND Seen = 0
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[NTFN_ArithmeticDeleteNotification]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[NTFN_ArithmeticDeleteNotification]
GO

CREATE PROCEDURE [dbo].[NTFN_ArithmeticDeleteNotification]
	@ApplicationID	uniqueidentifier,
    @ID				bigint,
    @UserID			uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON

	UPDATE [dbo].[NTFN_Notifications]
		SET Deleted = 1
	WHERE ApplicationID = @ApplicationID AND ID = @ID AND UserID = @UserID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[NTFN_ArithmeticDeleteNotifications]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[NTFN_ArithmeticDeleteNotifications]
GO

CREATE PROCEDURE [dbo].[NTFN_ArithmeticDeleteNotifications]
	@ApplicationID	uniqueidentifier,
    @strSubjectIDs	varchar(max),
    @strRefItemIDs	varchar(max),
    @SenderUserID	uniqueidentifier,
    @strActions		varchar(max),
    @delimiter		char
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON

	DECLARE @SubjectIDs GuidTableType, @RefItemIDs GuidTableType
	
	INSERT INTO @SubjectIDs
	SELECT Ref.Value FROM [dbo].[GFN_StrToGuidTable](@strSubjectIDs, @delimiter) AS Ref
	
	INSERT INTO @RefItemIDs
	SELECT Ref.Value FROM [dbo].[GFN_StrToGuidTable](@strRefItemIDs, @delimiter) AS Ref
	
	DECLARE @Actions StringTableType
	INSERT INTO @Actions
	SELECT Ref.Value FROM [dbo].[GFN_StrToStringTable](@strActions, @delimiter) AS Ref
	
	DECLARE @ActionsCount int = (SELECT COUNT(*) FROM @Actions),
		@SubjectIDsCount int = (SELECT COUNT(*) FROM @SubjectIDs),
		@RefItemIDsCount int = (SELECT COUNT(*) FROM @RefItemIDs)
	
	IF @SubjectIDsCount > 0 AND @RefItemIDsCount > 0 BEGIN
		UPDATE N
			SET Deleted = 1
		FROM @SubjectIDs AS S
			INNER JOIN [dbo].[NTFN_Notifications] AS N
			ON N.[SubjectID] = S.Value
			INNER JOIN @RefItemIDs AS R
			ON R.Value = N.[RefItemID]
		WHERE N.ApplicationID = @ApplicationID AND
			(@SenderUserID IS NULL OR SenderUserID = @SenderUserID) AND
			(@ActionsCount = 0 OR [Action] IN(SELECT * FROM @Actions))
	END
	ELSE IF @SubjectIDsCount > 0 BEGIN
		UPDATE N
			SET Deleted = 1
		FROM @SubjectIDs AS S
			INNER JOIN [dbo].[NTFN_Notifications] AS N
			ON N.[SubjectID] = S.Value
		WHERE N.ApplicationID = @ApplicationID AND 
			(@SenderUserID IS NULL OR SenderUserID = @SenderUserID) AND
			(@ActionsCount = 0 OR [Action] IN(SELECT * FROM @Actions))
	END
	ELSE IF @RefItemIDsCount > 0 BEGIN
	select @SenderUserID
		UPDATE N
			SET Deleted = 1
		FROM @RefItemIDs AS R
			INNER JOIN [dbo].[NTFN_Notifications] AS N
			ON N.[RefItemID] = R.Value
		WHERE N.ApplicationID = @ApplicationID AND 
			(@SenderUserID IS NULL OR N.SenderUserID = @SenderUserID) AND
			(@ActionsCount = 0 OR N.[Action] IN(SELECT * FROM @Actions))
	END
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[NTFN_GetUserNotificationsCount]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[NTFN_GetUserNotificationsCount]
GO

CREATE PROCEDURE [dbo].[NTFN_GetUserNotificationsCount]
	@ApplicationID	uniqueidentifier,
    @UserID			uniqueidentifier,
    @Seen			bit
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON

	SELECT COUNT(ID)
	FROM [dbo].[NTFN_Notifications]
	WHERE ApplicationID = @ApplicationID AND 
		UserID = @UserID AND (@Seen IS NULL OR Seen = @Seen) AND Deleted = 0
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[NTFN_P_GetNotificationsByIDs]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[NTFN_P_GetNotificationsByIDs]
GO

CREATE PROCEDURE [dbo].[NTFN_P_GetNotificationsByIDs]
	@ApplicationID	uniqueidentifier,
    @IDsTemp		BigIntTableType readonly
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @IDs BigIntTableType
	INSERT INTO @IDs SELECT * FROM @IDsTemp

	SELECT NTFN.ID AS NotificationID,
		   NTFN.UserID AS UserID,
		   NTFN.SubjectID AS SubjectID,
		   NTFN.RefItemID AS RefItemID,
		   NTFN.SubjectName AS SubjectName,
		   NTFN.SubjectType AS SubjectType,
		   NTFN.SenderUserID AS SenderUserID,
		   UN.UserName AS SenderUserName,
		   UN.FirstName AS SenderFirstName,
		   UN.LastName AS SenderLastName,
		   NTFN.SendDate AS SendDate,
		   NTFN.[Action] AS [Action],
		   NTFN.[Description] AS [Description],
		   NTFN.Info AS Info,
		   NTFN.UserStatus AS UserStatus,
		   NTFN.Seen AS Seen,
		   NTFN.ViewDate AS ViewDate
	FROM @IDs AS Ref
		INNER JOIN [dbo].[NTFN_Notifications] AS NTFN
		ON NTFN.ApplicationID = @ApplicationID AND NTFN.ID = Ref.Value
		LEFT JOIN [dbo].[Users_Normal] AS UN
		ON UN.ApplicationID = @ApplicationID AND UN.UserID = NTFN.UserID
	ORDER BY NTFN.Seen ASC, NTFN.ID DESC
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[NTFN_GetUserNotifications]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[NTFN_GetUserNotifications]
GO

CREATE PROCEDURE [dbo].[NTFN_GetUserNotifications]
	@ApplicationID	uniqueidentifier,
    @UserID			uniqueidentifier,
    @Seen			bit,
    @LastNotSeenID	bigint,
    @LastSeenID		bigint,
    @LastViewDate	datetime,
    @LowerDateLimit datetime,
    @UpperDateLimit datetime,
    @Count			int
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON

	DECLARE @IDs BigIntTableType
	
	INSERT INTO @IDs
	SELECT TOP(ISNULL(@Count, 20)) ID
	FROM [dbo].[NTFN_Notifications]
	WHERE ApplicationID = @ApplicationID AND UserID = @UserID AND
		(@LowerDateLimit IS NULL OR SendDate > @LowerDateLimit) AND
		(@UpperDateLimit IS NULL OR SendDate < @UpperDateLimit) AND
		(
			(
				(ViewDate IS NULL OR @LastViewDate IS NULL) AND 
				(@LastNotSeenID IS NULL OR ID < @LastNotSeenID)
			) OR
			(
				(ViewDate < @LastViewDate) AND 
				(@LastSeenID IS NULL OR ID < @LastSeenID)
			)
		) AND
		(@Seen IS NULL OR Seen = @Seen) AND Deleted = 0
	ORDER BY Seen ASC, ID DESC
	
	EXEC [dbo].[NTFN_P_GetNotificationsByIDs] @ApplicationID, @IDs
END

GO


-- Dashboard Procedures

IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[NTFN_P_SendDashboards]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[NTFN_P_SendDashboards]
GO

CREATE PROCEDURE [dbo].[NTFN_P_SendDashboards]
	@ApplicationID	uniqueidentifier,
    @DashboardsTemp	DashboardTableType readonly,
    @_Result		int output
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @Dashboards DashboardTableType
	INSERT INTO @Dashboards SELECT * FROM @DashboardsTemp
	
	INSERT INTO [dbo].[NTFN_Dashboards](
		ApplicationID,
		UserID,
		NodeID,
		RefItemID,
		[Type],
		SubType,
		Info,
		Removable,
		SenderUserID,
		SendDate,
		ExpirationDate,
		Seen,
		ViewDate,
		Done,
		ActionDate,
		Deleted
	)
	SELECT DISTINCT
		@ApplicationID,
		Ref.UserID,
		Ref.NodeID,
		ISNULL(Ref.RefItemID, Ref.NodeID),
		Ref.[Type],
		Ref.SubType,
		ref.Info,
		ISNULL(Ref.Removable, 0),
		Ref.SenderUserID,
		Ref.SendDate,
		Ref.ExpirationDate,
		ISNULL(Ref.Seen, 0),
		Ref.ViewDate,
		ISNULL(Ref.Done, 0),
		Ref.ActionDate,
		0
	FROM @Dashboards AS Ref
		LEFT JOIN [dbo].[NTFN_Dashboards] AS D
		ON D.ApplicationID = @ApplicationID AND 
			D.UserID = Ref.UserID AND D.NodeID = Ref.NodeID AND 
			D.RefItemID = Ref.RefItemID AND D.[Type] = Ref.[Type] AND 
			((D.SubType IS NULL AND Ref.SubType IS NULL) OR D.SubType = Ref.SubType) AND
			Ref.Removable = D.Removable AND D.Done = 0 AND D.Deleted = 0
	WHERE D.ID IS NULL
	
	SET @_Result = 1
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[NTFN_SetDashboardsAsSeen]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[NTFN_SetDashboardsAsSeen]
GO

CREATE PROCEDURE [dbo].[NTFN_SetDashboardsAsSeen]
	@ApplicationID		uniqueidentifier,
	@UserID				uniqueidentifier,
    @strDashboardIDs	varchar(max),
    @delimiter			char,
    @Now				datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @DashboardIDs BigIntTableType
	
	INSERT INTO @DashboardIDs
	SELECT Ref.Value
	FROM [dbo].[GFN_StrToBigIntTable](@strDashboardIDs, @delimiter) AS Ref
	
	UPDATE D
		SET Seen = 1,
			ViewDate = @Now
	FROM @DashboardIDs AS Ref
		INNER JOIN [dbo].[NTFN_Dashboards] AS D
		ON D.ID = Ref.Value
	WHERE D.ApplicationID = @ApplicationID AND D.UserID = @UserID
		
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[NTFN_P_SetDashboardsAsNotSeen]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[NTFN_P_SetDashboardsAsNotSeen]
GO

CREATE PROCEDURE [dbo].[NTFN_P_SetDashboardsAsNotSeen]
	@ApplicationID	uniqueidentifier,
    @UserID			uniqueidentifier,
    @NodeID			uniqueidentifier,
    @RefItemID		uniqueidentifier,
    @Type			varchar(20),
    @SubType		varchar(20),
    @_Result		int output
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	IF EXISTS(
		SELECT TOP(1) * 
		FROM [dbo].[NTFN_Dashboards]
		WHERE ApplicationID = @ApplicationID AND
			(@UserID IS NULL OR UserID = @UserID) AND
			(@NodeID IS NULL OR NodeID = @NodeID) AND 
			(@RefItemID IS NULL OR RefItemID = @RefItemID) AND 
			(@Type IS NULL OR [Type] = @Type) AND
			(@SubType IS NULL OR SubType = @SubType) AND Done = 0 AND Deleted = 0
		) BEGIN
		UPDATE [dbo].[NTFN_Dashboards]
			SET Seen = 0
		WHERE ApplicationID = @ApplicationID AND 
			(@UserID IS NULL OR UserID = @UserID) AND
			(@NodeID IS NULL OR NodeID = @NodeID) AND 
			(@RefItemID IS NULL OR RefItemID = @RefItemID) AND 
			(@Type IS NULL OR [Type] = @Type) AND
			(@SubType IS NULL OR SubType = @SubType) AND Done = 0 AND Deleted = 0
			
		SET @_Result = @@ROWCOUNT
	END
	ELSE BEGIN
		SET @_Result = 1
	END
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[NTFN_P_SetDashboardsAsDone]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[NTFN_P_SetDashboardsAsDone]
GO

CREATE PROCEDURE [dbo].[NTFN_P_SetDashboardsAsDone]
	@ApplicationID	uniqueidentifier,
    @UserID			uniqueidentifier,
    @NodeID			uniqueidentifier,
    @RefItemID		uniqueidentifier,
    @Type			varchar(20),
    @SubType		varchar(20),
    @Now			datetime,
    @_Result		int output
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	IF EXISTS(
		SELECT TOP(1) * 
		FROM [dbo].[NTFN_Dashboards]
		WHERE ApplicationID = @ApplicationID AND 
			(@UserID IS NULL OR UserID = @UserID) AND
			(@NodeID IS NULL OR NodeID = @NodeID) AND 
			(@RefItemID IS NULL OR RefItemID = @RefItemID) AND 
			(@Type IS NULL OR [Type] = @Type) AND
			(@SubType IS NULL OR SubType = @SubType) AND Done = 0 AND Deleted = 0
		) BEGIN
		
		UPDATE [dbo].[NTFN_Dashboards]
			SET Done = 1,
				ActionDate = @Now
		WHERE ApplicationID = @ApplicationID AND 
			(@UserID IS NULL OR UserID = @UserID) AND
			(@NodeID IS NULL OR NodeID = @NodeID) AND 
			(@RefItemID IS NULL OR RefItemID = @RefItemID) AND 
			(@Type IS NULL OR [Type] = @Type) AND
			(@SubType IS NULL OR SubType = @SubType) AND Done = 0 AND Deleted = 0
			
		SET @_Result = @@ROWCOUNT
	END
	ELSE BEGIN
		SET @_Result = 1
	END
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[NTFN_P_ArithmeticDeleteDashboards]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[NTFN_P_ArithmeticDeleteDashboards]
GO

CREATE PROCEDURE [dbo].[NTFN_P_ArithmeticDeleteDashboards]
	@ApplicationID	uniqueidentifier,
    @UserID			uniqueidentifier,
    @NodeID			uniqueidentifier,
    @RefItemID		uniqueidentifier,
    @Type			varchar(20),
    @SubType		varchar(20),
    @_Result		int output
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	IF EXISTS(
		SELECT TOP(1) * 
		FROM [dbo].[NTFN_Dashboards]
		WHERE ApplicationID = @ApplicationID AND
			(@UserID IS NULL OR UserID = @UserID) AND
			(@NodeID IS NULL OR NodeID = @NodeID) AND 
			(@RefItemID IS NULL OR RefItemID = @RefItemID) AND 
			(@Type IS NULL OR [Type] = @Type) AND 
			(@SubType IS NULL OR SubType = @SubType) AND Done = 0 AND Deleted = 0
		) BEGIN
		
		UPDATE [dbo].[NTFN_Dashboards]
			SET Deleted = 1
		WHERE ApplicationID = @ApplicationID AND 
			(@UserID IS NULL OR UserID = @UserID) AND
			(@NodeID IS NULL OR NodeID = @NodeID) AND 
			(@RefItemID IS NULL OR RefItemID = @RefItemID) AND 
			(@SubType IS NULL OR SubType = @SubType) AND Done = 0 AND Deleted = 0
			
		SET @_Result = @@ROWCOUNT
	END
	ELSE BEGIN
		SET @_Result = 1
	END
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[NTFN_ArithmeticDeleteDashboards]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[NTFN_ArithmeticDeleteDashboards]
GO

CREATE PROCEDURE [dbo].[NTFN_ArithmeticDeleteDashboards]
	@ApplicationID		uniqueidentifier,
	@UserID				uniqueidentifier,
    @strDashboardIDs	varchar(max),
    @delimiter			char
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @DashboardIDs BigIntTableType
	
	INSERT INTO @DashboardIDs
	SELECT Ref.Value
	FROM [dbo].[GFN_StrToBigIntTable](@strDashboardIDs, @delimiter) AS Ref
	
	UPDATE D
		SET Deleted = 1
	FROM @DashboardIDs AS Ref
		INNER JOIN [dbo].[NTFN_Dashboards] AS D
		ON D.ID = Ref.Value
	WHERE D.ApplicationID = @ApplicationID AND D.UserID = @UserID
		
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[NTFN_GetDashboardsCount]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[NTFN_GetDashboardsCount]
GO

CREATE PROCEDURE [dbo].[NTFN_GetDashboardsCount]
	@ApplicationID		uniqueidentifier,
	@UserID				uniqueidentifier,
	@NodeTypeID			uniqueidentifier,
	@NodeID				uniqueidentifier,
	@NodeAdditionalID	varchar(50),
	@Type				varchar(50)
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	IF @NodeID IS NOT NULL SET @NodeTypeID = NULL
	IF @NodeID IS NOT NULL OR @NodeAdditionalID = N'' SET @NodeAdditionalID = NULL

	DECLARE @Results TABLE (SeenOrder int, ID bigint, UserID uniqueidentifier, 
		NodeID uniqueidentifier, NodeAdditionalID varchar(50), NodeName nvarchar(255), 
		NodeTypeID uniqueidentifier, NodeType nvarchar(255), [Type] varchar(50), SubType nvarchar(500), 
		WFState nvarchar(1000), Removable bit, SenderUserID uniqueidentifier, SendDate datetime, 
		ExpirationDate datetime, Seen bit, ViewDate datetime, Done bit, ActionDate datetime, 
		InWorkFlow bit, DoneAndInWorkFlow int, DoneAndNotInWorkFlow int,
		PRIMARY KEY CLUSTERED(nodeid, [type], id))


	INSERT INTO @Results (SeenOrder, ID, UserID, NodeID, NodeAdditionalID, NodeName, 
		NodeTypeID, NodeType, [Type], SubType, WFState, Removable, SenderUserID, SendDate, 
		ExpirationDate, Seen, ViewDate, Done, ActionDate)
	SELECT
		CASE WHEN D.Seen = 0 THEN 0 ELSE 1 END AS SeenOrder,
		D.ID, 
		D.UserID, 
		D.NodeID, 
		ND.NodeAdditionalID, 
		ISNULL(ND.NodeName, Q.Title) AS NodeName,
		ND.NodeTypeID,
		ND.TypeName AS NodeType, 
		D.[Type], 
		D.SubType, 
		ND.WFState, 
		D.Removable,
		D.SenderUserID, 
		D.SendDate, 
		D.ExpirationDate,
		D.Seen, 
		D.ViewDate, 
		D.Done, 
		D.ActionDate
	FROM [dbo].[NTFN_Dashboards] AS D
		LEFT JOIN [dbo].[CN_View_Nodes_Normal] AS ND
		ON ND.ApplicationID = @ApplicationID AND 
			ND.NodeID = D.NodeID AND ND.Deleted = 0
		LEFT JOIN [dbo].[QA_Questions] AS Q
		ON Q.ApplicationID = @ApplicationID AND 
			Q.QuestionID = D.NodeID AND Q.Deleted = 0
	WHERE D.ApplicationID = @ApplicationID AND D.Deleted = 0 AND
		(ND.NodeID IS NOT NULL OR Q.QuestionID IS NOT NULL) AND
		(@UserID IS NULL OR D.UserID = @UserID) AND 
		(@NodeID IS NULL OR D.NodeID = @NodeID) AND
		(@NodeTypeID IS NULL OR ND.NodeTypeID = @NodeTypeID) AND
		(@NodeAdditionalID IS NULL OR ND.NodeAdditionalID = @NodeAdditionalID) AND
		(@Type IS NULL OR D.[Type] = @Type)
			
			
	-- Remove Invalid WorkFlow Items
	IF ISNULL(@Type, N'') = N'' OR @Type = N'WorkFlow' BEGIN
		DELETE R
		FROM @Results AS R
			LEFT JOIN [dbo].[WF_WorkFlowOwners] AS WO
			ON WO.ApplicationID = @ApplicationID AND WO.NodeTypeID = R.NodeTypeID AND WO.Deleted = 0
			LEFT JOIN [dbo].[CN_Services] AS S
			ON S.ApplicationID = @ApplicationID AND S.NodeTypeID = R.NodeTypeID
		WHERE R.NodeTypeID IS NOT NULL AND R.[Type] = N'WorkFlow' AND 
			(WO.WorkFlowID IS NULL OR S.IsKnowledge = 1)
	END
	-- end of Remove Invalid WorkFlow Items


	-- Remove Invalid Knowledge Items
	IF ISNULL(@Type, N'') = N'' OR @Type = N'Knowledge' BEGIN
		DELETE R
		FROM @Results AS R
			LEFT JOIN [dbo].[CN_Services] AS S
			ON S.ApplicationID = @ApplicationID AND S.NodeTypeID = R.NodeTypeID
		WHERE R.NodeTypeID IS NOT NULL AND R.[Type] = N'Knowledge' AND ISNULL(S.IsKnowledge, 0) = 0
	END
	-- end of Remove Invalid Knowledge Items


	-- Remove Invalid Wiki Items
	IF ISNULL(@Type, N'') = N'' OR @Type = N'Wiki' BEGIN
		DELETE R
		FROM @Results AS R
			LEFT JOIN [dbo].[CN_Extensions] AS S
			ON S.ApplicationID = @ApplicationID AND S.OwnerID = R.NodeTypeID AND 
				S.Extension = N'Wiki' AND S.Deleted = 0
		WHERE R.NodeTypeID IS NOT NULL AND R.[Type] = N'Wiki' AND S.OwnerID IS NULL
	END
	-- end of Remove Invalid Wiki Items


	UPDATE R
		SET InWorkFlow = 1
	FROM @Results AS R
		INNER JOIN (
			SELECT R.NodeID, R.[Type]
			FROM @Results AS R
				INNER JOIN [dbo].[NTFN_Dashboards] AS D
				ON D.ApplicationID = @ApplicationID AND R.NodeID IS NOT NULL AND R.[Type] IN (N'WorkFlow', N'Knowledge') AND
					D.NodeID = R.NodeID AND D.[Type] = R.[Type] AND D.Done = 0 AND D.Deleted = 0 AND ISNULL(D.Removable, 0) = 0
			GROUP BY R.NodeID, R.[Type]
		) AS X
		ON X.NodeID = R.NodeID AND X.[Type] = R.[Type]


	UPDATE X
		SET DoneAndInWorkFlow = A.DoneAndInWorkFlow,
			DoneAndNotInWorkFlow = A.DoneAndNotInWorkFlow
	FROM @Results AS X
		INNER JOIN (
			SELECT U.UserID, U.[Type], U.NodeTypeID,
				COUNT(DISTINCT (CASE WHEN U.DoneAndInWorkFlow = 1 THEN U.NodeID ELSE NULL END)) AS DoneAndInWorkFlow,
				COUNT(DISTINCT (CASE WHEN U.DoneAndNotInWorkFlow = 1 THEN U.NodeID ELSE NULL END)) AS DoneAndNotInWorkFlow
			FROM (
					SELECT R.UserID, R.[Type], R.NodeID, R.NodeTypeID, 
						CASE 
							WHEN MAX(CAST(ISNULL(R.Done, 0) AS int)) = 1 AND
								ISNULL(MAX(CAST(R.InWorkFlow AS int)), 0) > 0 THEN 1
							ELSE 0
						END AS DoneAndInWorkFlow,
						CASE 
							WHEN MAX(CAST(ISNULL(R.Done, 0) AS int)) = 1 AND
								ISNULL(MAX(CAST(R.InWorkFlow AS int)), 0) = 0 THEN 1
							ELSE 0
						END AS DoneAndNotInWorkFlow
					FROM @Results AS R
					GROUP BY R.UserID, R.[Type], R.NodeID, R.NodeTypeID
				) AS U
			GROUP BY U.UserID, U.[Type], U.NodeTypeID
		) AS A
		ON A.UserID = X.UserID AND A.[Type] = X.[Type] AND 
			((A.NodeTypeID IS NULL AND X.NodeTypeID IS NULL) OR (A.NodeTypeID = X.NodeTypeID))

	UPDATE @Results
		SET SubType = WFState
	WHERE [Type] = N'WorkFlow' 

	SELECT	R.[Type], 
			R.SubType, 
			R.NodeTypeID, 
			MAX(R.NodeType) AS NodeType,
			ISNULL(MAX(CASE WHEN ISNULL(R.Done, 0) = 0 THEN R.SendDate ELSE NULL END),
				MAX(CASE WHEN R.Done = 1 THEN R.SendDate ELSE NULL END)) AS DateOfEffect, --  
			COUNT(CASE WHEN ISNULL(R.Done, 0) = 0 AND ISNULL(R.Seen, 0) = 0 THEN R.NodeID ELSE NULL END) AS NotSeen, --     
			COUNT(CASE WHEN ISNULL(R.Done, 0) = 0 THEN R.NodeID ELSE NULL END) AS ToBeDone, --  
			COUNT(CASE WHEN R.Done = 1 THEN R.NodeID ELSE NULL END) AS Done, --     
			MAX(R.DoneAndInWorkFlow) AS DoneAndInWorkFlow, --       
			MAX(R.DoneAndNotInWorkFlow) AS DoneAndNotInWorkFlow --      
	FROM @Results AS R
	GROUP BY R.UserID, R.[Type], R.SubType, R.NodeTypeID
	ORDER BY DateOfEffect DESC
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[NTFN_P_GetDashboardsCount]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[NTFN_P_GetDashboardsCount]
GO

CREATE PROCEDURE [dbo].[NTFN_P_GetDashboardsCount]
	@ApplicationID	uniqueidentifier,
    @UserID			uniqueidentifier,
    @NodeID			uniqueidentifier,
    @RefItemID		uniqueidentifier,
    @Type			varchar(20),
    @SubType		varchar(20),
    @_Result		int output
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SET @_Result = ISNULL(
		(
			SELECT COUNT(ID)
			FROM [dbo].[NTFN_Dashboards]
			WHERE ApplicationID = @ApplicationID AND
				(@UserID IS NULL OR UserID = @UserID) AND
				(@NodeID IS NULL OR NodeID = @NodeID) AND 
				(@RefItemID IS NULL OR RefItemID = @RefItemID) AND 
				(@Type IS NULL OR [Type] = @Type) AND
				(@SubType IS NULL OR SubType = @SubType) AND Done = 0 AND Deleted = 0
		), 0
	)
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[NTFN_GetDashboards]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[NTFN_GetDashboards]
GO

CREATE PROCEDURE [dbo].[NTFN_GetDashboards]
	@ApplicationID		uniqueidentifier,
	@UserID				uniqueidentifier,
	@NodeTypeID			uniqueidentifier,
	@NodeID				uniqueidentifier,
	@NodeAdditionalID	varchar(50),
	@Type				varchar(50),
	@SubType			nvarchar(500),
	@DoneState			bit,
	@DateFrom			datetime,
	@DateTo				datetime,
	@SearchText			nvarchar(500),
	@GetDistinctItems	bit,
	@InWorkFlowState	bit,
	@LowerBoundary		int,
	@Count				int
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	IF @NodeID IS NOT NULL SET @NodeTypeID = NULL
	IF @NodeID IS NOT NULL OR @NodeAdditionalID = N'' SET @NodeAdditionalID = NULL

	DECLARE @Results TABLE (SeenOrder int, ID bigint, UserID uniqueidentifier, 
		NodeID uniqueidentifier, NodeAdditionalID varchar(50), NodeName nvarchar(255), 
		NodeTypeID uniqueidentifier, NodeType nvarchar(255), [Type] varchar(50), 
		SubType nvarchar(500), WFState nvarchar(1000),
		Info nvarchar(1000), Removable bit, SenderUserID uniqueidentifier, SendDate datetime, 
		ExpirationDate datetime, Seen bit, ViewDate datetime, Done bit, ActionDate datetime, 
		InWorkFlow bit, DoneAndInWorkFlow int, DoneAndNotInWorkFlow int)


	INSERT INTO @Results (SeenOrder, ID, UserID, NodeID, NodeAdditionalID, NodeName, 
		NodeTypeID, NodeType, [Type], SubType, WFState, Info, Removable, SenderUserID, SendDate, 
		ExpirationDate, Seen, ViewDate, Done, ActionDate)
	SELECT
		CASE WHEN D.Seen = 0 THEN 0 ELSE 1 END AS SeenOrder,
		D.ID, 
		D.UserID, 
		D.NodeID, 
		ND.NodeAdditionalID, 
		ISNULL(ND.NodeName, Q.Title) AS NodeName,
		ND.NodeTypeID,
		ND.TypeName AS NodeType, 
		D.[Type], 
		D.SubType, 
		ND.WFState,
		D.Info, 
		D.Removable,
		D.SenderUserID, 
		D.SendDate, 
		D.ExpirationDate,
		D.Seen, 
		D.ViewDate, 
		D.Done, 
		D.ActionDate
	FROM [dbo].[NTFN_Dashboards] AS D
		LEFT JOIN [dbo].[CN_View_Nodes_Normal] AS ND
		ON ND.ApplicationID = @ApplicationID AND 
			ND.NodeID = D.NodeID AND ND.Deleted = 0
		LEFT JOIN [dbo].[QA_Questions] AS Q
		ON Q.ApplicationID = @ApplicationID AND 
			Q.QuestionID = D.NodeID AND Q.Deleted = 0
	WHERE D.ApplicationID = @ApplicationID AND D.Deleted = 0 AND
		(ND.NodeID IS NOT NULL OR Q.QuestionID IS NOT NULL) AND
		(@UserID IS NULL OR D.UserID = @UserID) AND 
		(@NodeID IS NULL OR D.NodeID = @NodeID) AND
		(@NodeTypeID IS NULL OR ND.NodeTypeID = @NodeTypeID) AND
		(@NodeAdditionalID IS NULL OR ND.NodeAdditionalID = @NodeAdditionalID) AND
		(@Type IS NULL OR D.[Type] = @Type)
			
			
	-- Remove Invalid WorkFlow Items
	IF ISNULL(@Type, N'') = N'' OR @Type = N'WorkFlow' BEGIN
		DELETE R
		FROM @Results AS R
			LEFT JOIN [dbo].[WF_WorkFlowOwners] AS WO
			ON WO.ApplicationID = @ApplicationID AND WO.NodeTypeID = R.NodeTypeID AND WO.Deleted = 0
			LEFT JOIN [dbo].[CN_Services] AS S
			ON S.ApplicationID = @ApplicationID AND S.NodeTypeID = R.NodeTypeID
		WHERE R.NodeTypeID IS NOT NULL AND R.[Type] = N'WorkFlow' AND 
			(WO.WorkFlowID IS NULL OR S.IsKnowledge = 1)
	END
	-- end of Remove Invalid WorkFlow Items


	-- Remove Invalid Knowledge Items
	IF ISNULL(@Type, N'') = N'' OR @Type = N'Knowledge' BEGIN
		DELETE R
		FROM @Results AS R
			LEFT JOIN [dbo].[CN_Services] AS S
			ON S.ApplicationID = @ApplicationID AND S.NodeTypeID = R.NodeTypeID
		WHERE R.NodeTypeID IS NOT NULL AND R.[Type] = N'Knowledge' AND ISNULL(S.IsKnowledge, 0) = 0
	END
	-- end of Remove Invalid Knowledge Items


	-- Remove Invalid Wiki Items
	IF ISNULL(@Type, N'') = N'' OR @Type = N'Wiki' BEGIN
		DELETE R
		FROM @Results AS R
			LEFT JOIN [dbo].[CN_Extensions] AS S
			ON S.ApplicationID = @ApplicationID AND S.OwnerID = R.NodeTypeID AND 
				S.Extension = N'Wiki' AND S.Deleted = 0
		WHERE R.NodeTypeID IS NOT NULL AND R.[Type] = N'Wiki' AND S.OwnerID IS NULL
	END
	-- end of Remove Invalid Wiki Items
	
	
	IF ISNULL(@SearchText, N'') <> N'' BEGIN
		IF @Type = N'Wiki' OR @Type = N'WorkFlow' OR @Type = N'Knowledge' OR @Type = N'MembershipRequest' BEGIN
			DELETE R
			FROM @Results AS R
				LEFT JOIN CONTAINSTABLE([dbo].[CN_Nodes], ([Name]), @SearchText) AS SRCH
				ON SRCH.[Key] = R.NodeID
			WHERE SRCH.[Key] IS NULL
		END
		ELSE IF @Type = N'Question' BEGIN
			DELETE R
			FROM @Results AS R
				LEFT JOIN CONTAINSTABLE([dbo].[QA_Questions], ([Title]), @SearchText) AS SRCH
				ON SRCH.[Key] = R.NodeID
			WHERE SRCH.[Key] IS NULL
		END
	END
	

	IF ISNULL(@GetDistinctItems, 0) = 1 BEGIN
		IF @InWorkFlowState IS NOT NULL BEGIN
			UPDATE R
				SET InWorkFlow = 1
			FROM @Results AS R
				INNER JOIN [dbo].[NTFN_Dashboards] AS D
				ON D.ApplicationID = @ApplicationID AND 
					D.NodeID = R.NodeID AND D.[Type] = R.[Type] AND D.Done = 0 AND D.Deleted = 0 AND ISNULL(D.Removable, 0) = 0
			WHERE R.NodeID IS NOT NULL AND R.[Type] IN (N'WorkFlow', N'Knowledge')
		END
		
		SELECT TOP(ISNULL(@Count, 50))
			X.NodeID AS ID,
			(X.RowNumber + X.RevRowNumber - 1) AS TotalCount
		FROM (
				SELECT	ROW_NUMBER() OVER (ORDER BY Ref.SendDate DESC, Ref.NodeID DESC) AS RowNumber,
						ROW_NUMBER() OVER (ORDER BY Ref.SendDate ASC, Ref.NodeID ASC) AS RevRowNumber,
						Ref.NodeID
				FROM (
						SELECT	R.NodeID, 
								MAX(R.SendDate) AS SendDate, 
								MAX(CAST(R.InWorkFlow AS int)) AS InWorkFlow
						FROM @Results AS R
						WHERE R.NodeID IS NOT NULL AND R.Done = 1
						GROUP BY R.NodeID
					) AS Ref
				WHERE @InWorkFlowState IS NULL OR
					(@InWorkFlowState = 0 AND ISNULL(Ref.InWorkFlow, 0) = 0) OR
					(@InWorkFlowState = 1 AND ISNULL(Ref.InWorkFlow, 0) = 1)
			) AS X
		WHERE X.RowNumber >= ISNULL(@LowerBoundary, 0)
		ORDER BY X.RowNumber ASC
	END -- end of 'IF @InWorkFlowState IS NOT NULL BEGIN'
	ELSE BEGIN
		SELECT TOP(ISNULL(@Count, 50)) 
			(X.RowNumber + X.RevRowNumber - 1) AS TotalCount,
			X.*
		FROM (
				SELECT	ROW_NUMBER() OVER (ORDER BY R.SeenOrder ASC, R.SendDate DESC, R.ID DESC) AS RowNumber,
						ROW_NUMBER() OVER (ORDER BY R.SeenOrder DESC, R.SendDate ASC, R.ID ASC) AS RevRowNumber,
						R.*
				FROM @Results AS R
				WHERE (@DoneState IS NULL OR ISNULL(R.Done, 0) = @DoneState) AND
					(@DateFrom IS NULL OR R.SendDate >= @DateFrom) AND
					(@DateTo IS NULL OR R.SendDate < @DateTo) AND
					(@SubType IS NULL OR R.SubType = @SubType OR R.WFState = @SubType)
			) AS X
		WHERE X.RowNumber >= ISNULL(@LowerBoundary, 0)
		ORDER BY X.RowNumber ASC
	END
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[NTFN_P_DashboardExists]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[NTFN_P_DashboardExists]
GO

CREATE PROCEDURE [dbo].[NTFN_P_DashboardExists]
	@ApplicationID		uniqueidentifier,
    @UserID				uniqueidentifier,
	@NodeID				uniqueidentifier,
	@DashboardType		varchar(20),
	@SubType			varchar(20),
	@Seen				bit,
	@Done				bit,
	@LowerDateLimit		datetime,
	@UpperDateLimit		datetime,
	@_Result			int output
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SET @_Result = -1
	
	SELECT @_Result = 1
	WHERE EXISTS (
		SELECT TOP(1) ID
		FROM [dbo].[NTFN_Dashboards]
		WHERE ApplicationID = @ApplicationID AND 
			(@UserID IS NULL OR UserID = @UserID) AND
			(@NodeID IS NULL OR NodeID = @NodeID) AND
			(@DashboardType IS NULL OR [Type] = @DashboardType) AND
			(@SubType IS NULL OR SubType = @SubType) AND
			(@Seen IS NULL OR Seen = @Seen) AND
			(@Done IS NULL OR Done = @Done) AND
			(@LowerDateLimit IS NULL OR SendDate >= @LowerDateLimit) AND
			(@UpperDateLimit IS NULL OR SendDate <= @UpperDateLimit) AND Deleted = 0
	)
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[NTFN_DashboardExists]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[NTFN_DashboardExists]
GO

CREATE PROCEDURE [dbo].[NTFN_DashboardExists]
	@ApplicationID		uniqueidentifier,
    @UserID				uniqueidentifier,
	@NodeID				uniqueidentifier,
	@DashboardType		varchar(20),
	@SubType			varchar(20),
	@Seen				bit,
	@Done				bit,
	@LowerDateLimit		datetime,
	@UpperDateLimit		datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @_Result int
	
	EXEC [dbo].[NTFN_P_DashboardExists] @ApplicationID, @UserID, @NodeID, @DashboardType, 
		@SubType, @Seen, @Done, @LowerDateLimit, @UpperDateLimit, @_Result output
		
	SELECT @_Result
END

GO

-- end of Dashboard Procedures


-- Message Template Procedures

IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[NTFN_SetMessageTemplate]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[NTFN_SetMessageTemplate]
GO

CREATE PROCEDURE [dbo].[NTFN_SetMessageTemplate]
	@ApplicationID		uniqueidentifier,
	@TemplateID			uniqueidentifier,
	@OwnerID			uniqueidentifier,
	@BodyText			nvarchar(4000),
	@AudienceType		varchar(20),
	@AudienceRefOwnerID	uniqueidentifier,
	@AudienceNodeID		uniqueidentifier,
	@AudienceNodeAdmin	bit,
	@CreatorUserID		uniqueidentifier,
	@CreationDate		datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	IF EXISTS(
		SELECT TOP(1) * 
		FROM [dbo].[NTFN_MessageTemplates] 
		WHERE ApplicationID = @ApplicationID AND TemplateID = @TemplateID
	) BEGIN
		UPDATE [dbo].[NTFN_MessageTemplates]
			SET	BodyText = [dbo].[GFN_VerifyString](@BodyText),
				AudienceType = @AudienceType,
				AudienceRefOwnerID = @AudienceRefOwnerID,
				AudienceNodeID = @AudienceNodeID,
				AudienceNodeAdmin = ISNULL(@AudienceNodeAdmin, 0),
				LastModifierUserID = @CreatorUserID,
				LastModificationDate = @CreationDate
		WHERE ApplicationID = @ApplicationID AND TemplateID = @TemplateID
	END
	ELSE BEGIN
		INSERT INTO [dbo].[NTFN_MessageTemplates](
			ApplicationID,
			TemplateID,
			OwnerID,
			BodyText,
			AudienceType,
			AudienceRefOwnerID,
			AudienceNodeID,
			AudienceNodeAdmin,
			CreatorUserID,
			CreationDate,
			Deleted
		)
		VALUES(
			@ApplicationID,
			@TemplateID,
			@OwnerID,
			[dbo].[GFN_VerifyString](@BodyText),
			@AudienceType,
			@AudienceRefOwnerID,
			@AudienceNodeID,
			ISNULL(@AudienceNodeAdmin, 0),
			@CreatorUserID,
			@CreationDate,
			0
		)
	END
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[NTFN_ArithmeticDeleteMessageTemplate]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[NTFN_ArithmeticDeleteMessageTemplate]
GO

CREATE PROCEDURE [dbo].[NTFN_ArithmeticDeleteMessageTemplate]
	@ApplicationID			uniqueidentifier,
	@TemplateID				uniqueidentifier,
	@LastModifierUserID		uniqueidentifier,
	@LastModificationDate	datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[NTFN_MessageTemplates]
		SET	Deleted = 1,
			LastModifierUserID = @LastModifierUserID,
			LastModificationDate = @LastModificationDate
	WHERE ApplicationID = @ApplicationID AND TemplateID = @TemplateID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[NTFN_P_GetOwnerMessageTemplates]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[NTFN_P_GetOwnerMessageTemplates]
GO

CREATE PROCEDURE [dbo].[NTFN_P_GetOwnerMessageTemplates]
	@ApplicationID	uniqueidentifier,
	@OwnerIDsTemp	GuidTableType readonly
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @OwnerIDs GuidTableType
	INSERT INTO @OwnerIDs SELECT * FROM @OwnerIDsTemp
	
	SELECT MT.TemplateID,
		   MT.OwnerID,
		   MT.BodyText,
		   MT.AudienceType,
		   MT.AudienceRefOwnerID,
		   MT.AudienceNodeID,
		   ND.NodeName AS AudienceNodeName,
		   ND.NodeTypeID AS AudienceNodeTypeID,
		   ND.TypeName AS AudienceNodeType,
		   MT.AudienceNodeAdmin
	FROM @OwnerIDs AS Ref
		INNER JOIN [dbo].[NTFN_MessageTemplates] AS MT
		ON MT.OwnerID = Ref.Value
		LEFT JOIN [dbo].[CN_View_Nodes_Normal] AS ND
		ON ND.ApplicationID = @ApplicationID AND ND.NodeID = MT.AudienceNodeID
	WHERE MT.ApplicationID = @ApplicationID AND MT.Deleted = 0
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[NTFN_GetOwnerMessageTemplates]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[NTFN_GetOwnerMessageTemplates]
GO

CREATE PROCEDURE [dbo].[NTFN_GetOwnerMessageTemplates]
	@ApplicationID	uniqueidentifier,
	@strOwnerIDs	varchar(max),
	@delimiter		char
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @OwnerIDs GuidTableType
	INSERT INTO @OwnerIDs
	SELECT Ref.Value FROM [dbo].[GFN_StrToGuidTable](@strOwnerIDs, @delimiter) AS Ref
	
	EXEC [dbo].[NTFN_P_GetOwnerMessageTemplates] @ApplicationID, @OwnerIDs
END

GO

-- end of Message Template Procedures


-- Notification Messages (EMail & SMS)

IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID(N'NTFN_GetNotificationMessagesInfo') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1 )
DROP PROCEDURE [dbo].[NTFN_GetNotificationMessagesInfo]
GO

CREATE PROCEDURE [dbo].[NTFN_GetNotificationMessagesInfo]
	@ApplicationID		uniqueidentifier,
	@RefAppID			uniqueidentifier,
	@UserStatusPairTemp GuidStringTableType readOnly,
    @SubjectType		VARCHAR(50),
	@Action				VARCHAR(50)
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @UserStatusPair GuidStringTableType
	INSERT INTO @UserStatusPair SELECT * FROM @UserStatusPairTemp

	SELECT	UST.FirstValue AS UserID, 
			MT.Media,
			MT.[Lang],
			MT.[Subject],
			MT.[Text]
	FROM @UserStatusPair AS UST
		INNER JOIN [dbo].[NTFN_UserMessagingActivation] AS SO
		ON SO.ApplicationID = @ApplicationID AND SO.UserID = UST.FirstValue
		RIGHT JOIN [dbo].[NTFN_NotificationMessageTemplates] AS MT
		ON MT.ApplicationID = ISNULL(@RefAppID, @ApplicationID) AND MT.UserStatus = UST.SecondValue AND 
			MT.[Action] = SO.[Action] AND MT.SubjectType = SO.SubjectType AND 
			MT.Media = SO.Media AND MT.[Lang] = SO.[Lang]
	WHERE MT.ApplicationID = ISNULL(@RefAppID, @ApplicationID) AND 
		MT.[Action] = @Action AND MT.SubjectType = @SubjectType AND 
		MT.[Enable] = 1 AND ISNULL(SO.[Enable], 1) = 1 
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID(N'[dbo].[NTFN_SetUserMessagingActivation]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1 )
DROP PROCEDURE [dbo].[NTFN_SetUserMessagingActivation]
GO

CREATE PROCEDURE [dbo].[NTFN_SetUserMessagingActivation]
	@ApplicationID			uniqueidentifier,
	@OptionID				UNIQUEIDENTIFIER,
	@UserID					UNIQUEIDENTIFIER,
	@LastModifierUserId		UNIQUEIDENTIFIER,
	@LastModificationDate	DATETIME,
	@SubjectType			VARCHAR(50),
	@UserStatus				VARCHAR(50),
	@Action					VARCHAR(50),
	@Media					VARCHAR(50),
	@Lang					VARCHAR(50),
	@Enable					BIT
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON

	IF(EXISTS(
		SELECT * 
		FROM [dbo].[NTFN_UserMessagingActivation]
		WHERE ApplicationID = @ApplicationID AND OptionID = @OptionID
	))BEGIN
		UPDATE [dbo].[NTFN_UserMessagingActivation]
			SET LastModifierUserId = @LastModifierUserId,
				LastModificationDate = @LastModificationDate,
				[Enable] = @Enable
		WHERE ApplicationID = @ApplicationID AND OptionID = @OptionID
	END
	ELSE BEGIN
		INSERT INTO [dbo].[NTFN_UserMessagingActivation](
			ApplicationID,
			OptionID,
			UserID,
			SubjectType,
			UserStatus,
			[Action],
			Media,
			[Lang],
			[Enable]
		)
		VALUES(
			@ApplicationID,
			@OptionID,
			@UserID,
			@SubjectType,
			@UserStatus,
			@Action,
			@Media,
			@Lang,
			@Enable
		)
	END
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[NTFN_GetNotificationMessageTemplatesInfo]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[NTFN_GetNotificationMessageTemplatesInfo]
GO

CREATE PROCEDURE [dbo].[NTFN_GetNotificationMessageTemplatesInfo]
	@ApplicationID	uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT	[TemplateID],
			[SubjectType],
			[Action],
			[Media],
			UserStatus,
			[Lang],
			[Subject],
			[Text],
			[Enable]
	FROM [dbo].[NTFN_NotificationMessageTemplates]
	WHERE ApplicationID = @ApplicationID
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[NTFN_GetUserMessagingActivation]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[NTFN_GetUserMessagingActivation]
GO

CREATE PROCEDURE [dbo].[NTFN_GetUserMessagingActivation]
	@ApplicationID	uniqueidentifier,
	@RefAppID		uniqueidentifier,
	@UserID			uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT
		UMA.OptionID,
		CASE
			WHEN UMA.[SubjectType] IS NULL THEN NMT.[SubjectType]
			ELSE UMA.[SubjectType]
		END AS SubjectType,
		UMA.UserID,
		CASE
			WHEN UMA.[UserStatus] IS NULL THEN NMT.[UserStatus]
			ELSE UMA.[UserStatus]
		END AS UserStatus,
		CASE
			WHEN UMA.[Action] IS NULL THEN NMT.[Action]
			ELSE UMA.[Action]
		END AS [Action],
		CASE
			WHEN UMA.[Media] IS NULL THEN NMT.[Media]
			ELSE UMA.[Media]
		END AS Media,
		CASE
			WHEN UMA.[Lang] IS NULL THEN NMT.[Lang]
			ELSE UMA.[Lang]
		END AS [Lang],
		UMA.[Enable],
		NMT.[Enable] AS AdminEnable
	FROM [dbo].[NTFN_UserMessagingActivation] AS UMA
		FULL OUTER JOIN [dbo].[NTFN_NotificationMessageTemplates] AS NMT
		ON UMA.ApplicationID = @ApplicationID AND NMT.ApplicationID = ISNULL(@RefAppID, @ApplicationID) AND 
			UMA.UserID = @UserID AND NMT.[Action] = UMA.[Action] AND 
			NMT.[Lang] = UMA.[Lang] AND NMT.Media = UMA.Media AND 
			NMT.SubjectType = UMA.SubjectType AND NMT.UserStatus = UMA.UserStatus
	WHERE UMA.ApplicationID = @ApplicationID AND 
		NMT.ApplicationID = ISNULL(@RefAppID, @ApplicationID) AND 
		UMA.UserID IS NULL OR UMA.UserID = @UserID
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[NTFN_SetAdminMessagingActivation]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[NTFN_SetAdminMessagingActivation]
GO

CREATE PROCEDURE [dbo].[NTFN_SetAdminMessagingActivation]
	@ApplicationID			uniqueidentifier,
	@TemplateID				UNIQUEIDENTIFIER,
	@LastModifierUserID		UNIQUEIDENTIFIER,
	@LastModificationDate	DATETIME,
	@SubjectType			VARCHAR(50),
	@Action					VARCHAR(50),
	@Media					VARCHAR(50),
	@UserStatus				VARCHAR(50),
	@Lang					VARCHAR(50),
	@Enable					BIT
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON

	IF(EXISTS(
		SELECT * 
		FROM [dbo].[NTFN_NotificationMessageTemplates]
		WHERE ApplicationID = @ApplicationID AND TemplateID = @TemplateID
	))BEGIN
		UPDATE [dbo].[NTFN_NotificationMessageTemplates]
			SET LastModifierUserId = @LastModifierUserId,
				LastModificationDate = @LastModificationDate,
				[Enable] = @Enable
		WHERE ApplicationID = @ApplicationID AND TemplateID = @TemplateID
	END
	ELSE BEGIN
		INSERT INTO [dbo].[NTFN_NotificationMessageTemplates](
			ApplicationID,
			TemplateID,
			SubjectType,
			[Action],
			Media,
			UserStatus,
			[Lang],
			[Enable]
		)
		VALUES(
			@ApplicationID,
			@TemplateID,
			@SubjectType,
			@Action,
			@Media,
			@UserStatus,
			@Lang,
			1
		)
	END
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[NTFN_SetNotificationMessageTemplateText]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[NTFN_SetNotificationMessageTemplateText]
GO

CREATE PROCEDURE [dbo].[NTFN_SetNotificationMessageTemplateText]
	@ApplicationID			uniqueidentifier,
	@TemplateID				UNIQUEIDENTIFIER,
	@LastModifierUserID		UNIQUEIDENTIFIER,
	@LastModificationDate	DATETIME,
	@Subject				NVARCHAR (512),
	@Text					NVARCHAR (max)
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON

	UPDATE [dbo].[NTFN_NotificationMessageTemplates]
		SET LastModifierUserId = @LastModifierUserID,
			LastModificationDate = @LastModificationDate,
			[Subject] = @Subject,
			[Text] = @Text
	WHERE ApplicationID = @ApplicationID AND TemplateID = @TemplateID
	
	SELECT @@ROWCOUNT
END
GO

-- end of Notification Messages (EMail & SMS)

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_P_InitializeService]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_P_InitializeService]
GO

CREATE PROCEDURE [dbo].[CN_P_InitializeService]
	@ApplicationID	uniqueidentifier,
	@NodeTypeID		uniqueidentifier,
	@_Result		int output
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	IF EXISTS(
		SELECT TOP(1) * 
		FROM [dbo].[CN_Services] 
		WHERE ApplicationID = @ApplicationID AND NodeTypeID = @NodeTypeID
	) BEGIN
		UPDATE [dbo].[CN_Services]
			SET Deleted = 0
		WHERE ApplicationID = @ApplicationID AND NodeTypeID = @NodeTypeID
	END
	ELSE BEGIN
		DECLARE @SeqNo int = 
			ISNULL((
				SELECT MAX(SequenceNumber) 
				FROM [dbo].[CN_Services]
				WHERE ApplicationID = @ApplicationID
			), 0) + 1
		
		INSERT INTO [dbo].[CN_Services](
			ApplicationID,
			NodeTypeID,
			EnableContribution,
			EditableForAdmin,
			SequenceNumber,
			EditableForCreator,
			EditableForOwners,
			EditableForExperts,
			EditableForMembers,
			EditSuggestion,
			Deleted
		)
		VALUES(
			@ApplicationID,
			@NodeTypeID,
			0,
			1,
			@SeqNo,
			1,
			1,
			1,
			0,
			1,
			0
		)
	END
	
	SET @_Result = @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_InitializeService]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_InitializeService]
GO

CREATE PROCEDURE [dbo].[CN_InitializeService]
	@ApplicationID	uniqueidentifier,
	@NodeTypeID		uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @_Result int = 0
	
	EXEC [dbo].[CN_P_InitializeService] @ApplicationID, @NodeTypeID, @_Result output
	
	SELECT @_Result
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_P_GetServicesByIDs]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_P_GetServicesByIDs]
GO

CREATE PROCEDURE [dbo].[CN_P_GetServicesByIDs]
	@ApplicationID		uniqueidentifier,
	@NodeTypeIDsTemp	KeyLessGuidTableType readonly
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @NodeTypeIDs KeyLessGuidTableType
	INSERT INTO @NodeTypeIDs (Value) SELECT Value FROM @NodeTypeIDsTemp
	
	SELECT S.NodeTypeID,
		   NT.Name AS NodeType,
		   S.ServiceTitle,
		   S.ServiceDescription,
		   S.AdminType,
		   S.AdminNodeID,
		   S.MaxAcceptableAdminLevel,
		   S.LimitAttachedFilesTo,
		   S.MaxAttachedFileSize,
		   S.MaxAttachedFilesCount,
		   S.EnableContribution,
		   S.NoContent,
		   S.IsDocument,
		   S.EnablePreviousVersionSelect,
		   S.IsKnowledge,
		   S.IsTree,
		   S.UniqueMembership,
		   S.UniqueAdminMember,
		   S.DisableAbstractAndKeywords,
		   S.DisableFileUpload,
		   S.DisableRelatedNodesSelect,
		   S.EditableForAdmin,
		   S.EditableForCreator,
		   S.EditableForOwners,
		   S.EditableForExperts,
		   S.EditableForMembers,
		   ISNULL(S.EditSuggestion, 1) AS EditSuggestion
	FROM @NodeTypeIDs AS Ref
		INNER JOIN [dbo].[CN_Services] AS S
		ON S.ApplicationID = @ApplicationID AND S.NodeTypeID = Ref.Value
		INNER JOIN [dbo].[CN_NodeTypes] AS NT
		ON NT.ApplicationID = @ApplicationID AND NT.NodeTypeID = S.NodeTypeID
	ORDER BY Ref.SequenceNumber ASC
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_GetServicesByIDs]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_GetServicesByIDs]
GO

CREATE PROCEDURE [dbo].[CN_GetServicesByIDs]
	@ApplicationID	uniqueidentifier,
	@strNodeTypeIDs	varchar(max),
	@delimiter		char
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @NodeTypeIDs KeyLessGuidTableType
	
	INSERT INTO @NodeTypeIDs (Value)
	SELECT Ref.Value
	FROM [dbo].[GFN_StrToGuidTable](@strNodeTypeIDs, @delimiter) AS Ref
	
	EXEC [dbo].[CN_P_GetServicesByIDs] @ApplicationID, @NodeTypeIDs
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_GetServices]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_GetServices]
GO

CREATE PROCEDURE [dbo].[CN_GetServices]
	@ApplicationID	uniqueidentifier,
	@NodeTypeID		uniqueidentifier,
	@CurrentUserID	uniqueidentifier,
	@IsDocument		bit,
	@IsKnowledge	bit,
	@CheckPrivacy	bit,
	@Now			datetime,
	@DefaultPrivacy varchar(20)
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	IF @NodeTypeID IS NOT NULL BEGIN
		SET @NodeTypeID = ISNULL(
			(
				SELECT TOP(1) NodeTypeID 
				FROM [dbo].[CN_Nodes] 
				WHERE ApplicationID = @ApplicationID AND NodeID = @NodeTypeID
			),
			@NodeTypeID
		)
	END
	
	DECLARE @tempIDs KeyLessGuidTableType
	
	INSERT INTO @tempIDs (Value)
	SELECT S.NodeTypeID
	FROM [dbo].[CN_Services] AS S
		INNER JOIN [dbo].[CN_NodeTypes] AS NT
		ON NT.ApplicationID = @ApplicationID AND 
			NT.NodeTypeID = S.NodeTypeID AND ISNULL(NT.Deleted, 0) = 0
	WHERE S.ApplicationID = @ApplicationID AND
		(@NodeTypeID IS NULL OR S.NodeTypeID = @NodeTypeID) AND
		(@IsDocument IS NULL OR S.IsDocument = @IsDocument) AND
		(@IsKnowledge IS NULL OR S.IsKnowledge = @IsKnowledge) AND
		(@NodeTypeID IS NOT NULL OR (S.ServiceTitle IS NOT NULL AND S.ServiceTitle <> N'')) AND 
		S.Deleted = 0
	ORDER BY NT.SequenceNumber ASC, NT.CreationDate DESC
	
	DECLARE @IDs KeyLessGuidTableType
	
	IF @NodeTypeID IS NULL AND @CheckPrivacy = 1 BEGIN
		DECLARE	@PermissionTypes StringPairTableType
		
		INSERT INTO @PermissionTypes (FirstValue, SecondValue)
		VALUES (N'Create', @DefaultPrivacy)

		INSERT INTO @IDs (Value)
		SELECT Ref.ID
		FROM [dbo].[PRVC_FN_CheckAccess](@ApplicationID, @CurrentUserID, 
			@tempIDs, N'NodeType', @Now, @PermissionTypes) AS Ref
			INNER JOIN @tempIDs AS T
			ON T.Value = Ref.ID
		ORDER BY T.SequenceNumber ASC
	END
	ELSE BEGIN
		INSERT INTO @IDs (Value)
		SELECT Ref.Value
		FROM @tempIDs AS Ref
		WHERE (@NodeTypeID IS NULL OR Ref.Value = @NodeTypeID)
		ORDER BY Ref.SequenceNumber ASC
	END
	
	EXEC [dbo].[CN_P_GetServicesByIDs] @ApplicationID, @IDs
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_SetServiceTitle]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_SetServiceTitle]
GO

CREATE PROCEDURE [dbo].[CN_SetServiceTitle]
	@ApplicationID	uniqueidentifier,
	@NodeTypeID		uniqueidentifier,
	@Title			nvarchar(512)
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[CN_Services]
		SET ServiceTitle = [dbo].[GFN_VerifyString](@Title)
	WHERE ApplicationID = @ApplicationID AND NodeTypeID = @NodeTypeID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_SetServiceDescription]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_SetServiceDescription]
GO

CREATE PROCEDURE [dbo].[CN_SetServiceDescription]
	@ApplicationID	uniqueidentifier,
	@NodeTypeID		uniqueidentifier,
	@Description	nvarchar(4000)
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[CN_Services]
		SET ServiceDescription = [dbo].[GFN_VerifyString](@Description)
	WHERE ApplicationID = @ApplicationID AND NodeTypeID = @NodeTypeID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_SetServiceSuccessMessage]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_SetServiceSuccessMessage]
GO

CREATE PROCEDURE [dbo].[CN_SetServiceSuccessMessage]
	@ApplicationID	uniqueidentifier,
	@NodeTypeID		uniqueidentifier,
	@Message		nvarchar(4000)
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[CN_Services]
		SET [SuccessMessage] = @Message
	WHERE ApplicationID = @ApplicationID AND NodeTypeID = @NodeTypeID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_GetServiceSuccessMessage]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_GetServiceSuccessMessage]
GO

CREATE PROCEDURE [dbo].[CN_GetServiceSuccessMessage]
	@ApplicationID	uniqueidentifier,
	@NodeTypeID		uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT SuccessMessage
	FROM [dbo].[CN_Services]
	WHERE ApplicationID = @ApplicationID AND NodeTypeID = @NodeTypeID
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_SetServiceAdminType]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_SetServiceAdminType]
GO

CREATE PROCEDURE [dbo].[CN_SetServiceAdminType]
	@ApplicationID			uniqueidentifier,
	@NodeTypeID				uniqueidentifier,
	@AdminType				varchar(20),
	@AdminNodeID			uniqueidentifier,
	@strLimitNodeTypeIDs	varchar(max),
	@delimiter				char,
	@CreatorUserID			uniqueidentifier,
	@CreationDate			datetime
WITH ENCRYPTION
AS
BEGIN TRANSACTION
	SET NOCOUNT ON
	
	UPDATE [dbo].[CN_Services]
		SET AdminType = @AdminType,
			AdminNodeID = ISNULL(@AdminNodeID, AdminNodeID)
	WHERE ApplicationID = @ApplicationID AND NodeTypeID = @NodeTypeID
	
	IF @@ROWCOUNT <= 0 BEGIN
		SELECT -1
		ROLLBACK TRANSACTION
		RETURN
	END
	
	UPDATE [dbo].[CN_AdminTypeLimits]
		SET Deleted = 1
	WHERE ApplicationID = @ApplicationID AND NodeTypeID = @NodeTypeID
	
	DECLARE @NodeTypeIDs GuidTableType
	
	INSERT INTO @NodeTypeIDs
	SELECT Ref.Value FROM [dbo].[GFN_StrToGuidTable](@strLimitNodeTypeIDs, @delimiter) AS Ref
	
	DECLARE @ExistingIDs GuidTableType
	
	INSERT INTO @ExistingIDs
	SELECT Ref.Value
	FROM @NodeTypeIDs AS Ref
		INNER JOIN [dbo].[CN_AdminTypeLimits] AS ATL
		ON ATL.LimitNodeTypeID = Ref.Value
	WHERE ATL.ApplicationID = @ApplicationID AND ATL.NodeTypeID = @NodeTypeID
	
	DECLARE @ExisintgCount int = (SELECT COUNT(*) FROM @ExistingIDs)
	
	IF @ExisintgCount > 0 BEGIN
		UPDATE ATL
			SET LastModifierUserID = @CreatorUserID,
				LastModificationDate = @CreationDate,
				Deleted = 0
		FROM @ExistingIDs AS Ref
			INNER JOIN [dbo].[CN_AdminTypeLimits] AS ATL
			ON ATL.LimitNodeTypeID = Ref.Value
		WHERE ATL.ApplicationID = @ApplicationID AND ATL.NodeTypeID = @NodeTypeID
		
		IF @@ROWCOUNT <= 0 BEGIN
			SELECT -1
			ROLLBACK TRANSACTION
			RETURN
		END
	END
	
	IF (SELECT COUNT(*) FROM @NodeTypeIDs) > @ExisintgCount BEGIN
		INSERT INTO [dbo].[CN_AdminTypeLimits](
			ApplicationID,
			NodeTypeID,
			LimitNodeTypeID,
			CreatorUserID,
			CreationDate,
			Deleted
		)
		SELECT @ApplicationID, @NodeTypeID, Ref.Value, @CreatorUserID, @CreationDate, 0
		FROM @NodeTypeIDs AS Ref
		WHERE Ref.Value NOT IN(SELECT E.Value FROM @ExistingIDs AS E)
		
		IF @@ROWCOUNT <= 0 BEGIN
			SELECT -1
			ROLLBACK TRANSACTION
			RETURN
		END
	END
	
	SELECT 1
COMMIT TRANSACTION

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_GetAdminAreaLimits]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_GetAdminAreaLimits]
GO

CREATE PROCEDURE [dbo].[CN_GetAdminAreaLimits]
	@ApplicationID		uniqueidentifier,
    @NodeIDOrTypeID		uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @NodeTypeIDs KeyLessGuidTableType
	
	DECLARE @NodeTypeID uniqueidentifier = (
		SELECT NodeTypeID 
		FROM [dbo].[CN_Nodes]
		WHERE ApplicationID = @ApplicationID AND NodeID = @NodeIDOrTypeID
	)
	
	IF @NodeTypeID IS NULL SET @NodeTypeID = @NodeIDOrTypeID
	
	INSERT INTO @NodeTypeIDs (Value)
	SELECT LimitNodeTypeID
	FROM [dbo].[CN_AdminTypeLimits]
	WHERE ApplicationID = @ApplicationID AND NodeTypeID = @NodeTypeID AND Deleted = 0
	
	EXEC [dbo].[CN_P_GetNodeTypesByIDs] @ApplicationID, @NodeTypeIDs
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_SetMaxAcceptableAdminLevel]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_SetMaxAcceptableAdminLevel]
GO

CREATE PROCEDURE [dbo].[CN_SetMaxAcceptableAdminLevel]
	@ApplicationID				uniqueidentifier,
	@NodeTypeID					uniqueidentifier,
	@MaxAcceptableAdminLevel	int
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[CN_Services]
		SET MaxAcceptableAdminLevel = @MaxAcceptableAdminLevel
	WHERE ApplicationID = @ApplicationID AND NodeTypeID = @NodeTypeID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_SetContributionLimits]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_SetContributionLimits]
GO

CREATE PROCEDURE [dbo].[CN_SetContributionLimits]
	@ApplicationID			uniqueidentifier,
	@NodeTypeID				uniqueidentifier,
	@strLimitNodeTypeIDs	varchar(max),
	@delimiter				char,
	@CreatorUserID			uniqueidentifier,
	@CreationDate			datetime
WITH ENCRYPTION
AS
BEGIN TRANSACTION
	SET NOCOUNT ON
	
	UPDATE [dbo].[CN_ContributionLimits]
		SET Deleted = 1
	WHERE ApplicationID = @ApplicationID AND NodeTypeID = @NodeTypeID
	
	DECLARE @NodeTypeIDs GuidTableType
	
	INSERT INTO @NodeTypeIDs
	SELECT DISTINCT Ref.Value 
	FROM [dbo].[GFN_StrToGuidTable](@strLimitNodeTypeIDs, @delimiter) AS Ref
	
	DECLARE @ExistingIDs GuidTableType
	
	INSERT INTO @ExistingIDs
	SELECT Ref.Value
	FROM @NodeTypeIDs AS Ref
		INNER JOIN [dbo].[CN_ContributionLimits] AS CL
		ON CL.LimitNodeTypeID = Ref.Value
	WHERE CL.ApplicationID = @ApplicationID AND CL.NodeTypeID = @NodeTypeID
	
	DECLARE @ExisintgCount int = (SELECT COUNT(*) FROM @ExistingIDs)
	
	IF @ExisintgCount > 0 BEGIN
		UPDATE CL
			SET LastModifierUserID = @CreatorUserID,
				LastModificationDate = @CreationDate,
				Deleted = 0
		FROM @ExistingIDs AS Ref
			INNER JOIN [dbo].[CN_ContributionLimits] AS CL
			ON CL.LimitNodeTypeID = Ref.Value
		WHERE CL.ApplicationID = @ApplicationID AND CL.NodeTypeID = @NodeTypeID
		
		IF @@ROWCOUNT <= 0 BEGIN
			SELECT -1
			ROLLBACK TRANSACTION
			RETURN
		END
	END
	
	IF (SELECT COUNT(*) FROM @NodeTypeIDs) > @ExisintgCount BEGIN
		INSERT INTO [dbo].[CN_ContributionLimits](
			ApplicationID,
			NodeTypeID,
			LimitNodeTypeID,
			CreatorUserID,
			CreationDate,
			Deleted
		)
		SELECT @ApplicationID, @NodeTypeID, Ref.Value, @CreatorUserID, @CreationDate, 0
		FROM @NodeTypeIDs AS Ref
		WHERE Ref.Value NOT IN(SELECT E.Value FROM @ExistingIDs AS E)
		
		IF @@ROWCOUNT <= 0 BEGIN
			SELECT -1
			ROLLBACK TRANSACTION
			RETURN
		END
	END
	
	SELECT 1
COMMIT TRANSACTION

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_GetContributionLimits]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_GetContributionLimits]
GO

CREATE PROCEDURE [dbo].[CN_GetContributionLimits]
	@ApplicationID		uniqueidentifier,
    @NodeIDOrTypeID		uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @NodeTypeIDs KeyLessGuidTableType
	
	DECLARE @NodeTypeID uniqueidentifier = (
		SELECT NodeTypeID 
		FROM [dbo].[CN_Nodes]
		WHERE ApplicationID = @ApplicationID AND NodeID = @NodeIDOrTypeID
	)
	
	IF @NodeTypeID IS NULL SET @NodeTypeID = @NodeIDOrTypeID
	
	INSERT INTO @NodeTypeIDs (Value)
	SELECT LimitNodeTypeID
	FROM [dbo].[CN_ContributionLimits]
	WHERE ApplicationID = @ApplicationID AND NodeTypeID = @NodeTypeID AND Deleted = 0
	
	EXEC [dbo].[CN_P_GetNodeTypesByIDs] @ApplicationID, @NodeTypeIDs
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_EnableContribution]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_EnableContribution]
GO

CREATE PROCEDURE [dbo].[CN_EnableContribution]
	@ApplicationID	uniqueidentifier,
	@NodeTypeID		uniqueidentifier,
	@Enable			bit
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[CN_Services]
		SET EnableContribution = @Enable
	WHERE ApplicationID = @ApplicationID AND NodeTypeID = @NodeTypeID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_NoContentService]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_NoContentService]
GO

CREATE PROCEDURE [dbo].[CN_NoContentService]
	@ApplicationID			uniqueidentifier,
	@NodeTypeIDOrNodeID		uniqueidentifier,
	@NoContent				bit
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SET @NodeTypeIDOrNodeID = ISNULL(
		(
			SELECT TOP(1) NodeTypeID 
			FROM [dbo].[CN_Nodes] 
			WHERE ApplicationID = @ApplicationID AND NodeID = @NodeTypeIDOrNodeID
		), @NodeTypeIDOrNodeID
	)
	
	IF @NoContent IS NULL BEGIN
		SELECT TOP(1) NoContent
		FROM [dbo].[CN_Services]
		WHERE ApplicationID = @ApplicationID AND NodeTypeID = @NodeTypeIDOrNodeID
	END
	ELSE BEGIN
		UPDATE [dbo].[CN_Services]
			SET NoContent = @NoContent
		WHERE ApplicationID = @ApplicationID AND NodeTypeID = @NodeTypeIDOrNodeID
		
		SELECT @@ROWCOUNT
	END
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_IsKnowledge]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_IsKnowledge]
GO

CREATE PROCEDURE [dbo].[CN_IsKnowledge]
	@ApplicationID			uniqueidentifier,
	@NodeTypeIDOrNodeID		uniqueidentifier,
	@IsKnowledge			bit
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SET @NodeTypeIDOrNodeID = ISNULL(
		(
			SELECT TOP(1) NodeTypeID 
			FROM [dbo].[CN_Nodes] 
			WHERE ApplicationID = @ApplicationID AND NodeID = @NodeTypeIDOrNodeID
		), @NodeTypeIDOrNodeID
	)
	
	IF @IsKnowledge IS NULL BEGIN
		SELECT TOP(1) IsKnowledge
		FROM [dbo].[CN_Services]
		WHERE ApplicationID = @ApplicationID AND NodeTypeID = @NodeTypeIDOrNodeID
	END
	ELSE BEGIN
		UPDATE [dbo].[CN_Services]
			SET IsKnowledge = @IsKnowledge
		WHERE ApplicationID = @ApplicationID AND NodeTypeID = @NodeTypeIDOrNodeID
		
		SELECT @@ROWCOUNT
	END
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_IsDocument]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_IsDocument]
GO

CREATE PROCEDURE [dbo].[CN_IsDocument]
	@ApplicationID			uniqueidentifier,
	@NodeTypeIDOrNodeID		uniqueidentifier,
	@IsDocument				bit
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SET @NodeTypeIDOrNodeID = ISNULL(
		(
			SELECT TOP(1) NodeTypeID 
			FROM [dbo].[CN_Nodes] 
			WHERE ApplicationID = @ApplicationID AND NodeID = @NodeTypeIDOrNodeID
		), @NodeTypeIDOrNodeID
	)
	
	IF @IsDocument IS NULL BEGIN
		SELECT TOP(1) IsDocument
		FROM [dbo].[CN_Services]
		WHERE ApplicationID = @ApplicationID AND NodeTypeID = @NodeTypeIDOrNodeID
	END
	ELSE BEGIN
		UPDATE [dbo].[CN_Services]
			SET IsDocument = @IsDocument
		WHERE ApplicationID = @ApplicationID AND NodeTypeID = @NodeTypeIDOrNodeID
		
		SELECT @@ROWCOUNT
	END
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_EnablePreviousVersionSelect]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_EnablePreviousVersionSelect]
GO

CREATE PROCEDURE [dbo].[CN_EnablePreviousVersionSelect]
	@ApplicationID			uniqueidentifier,
	@NodeTypeIDOrNodeID		uniqueidentifier,
	@Value					bit
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SET @NodeTypeIDOrNodeID = ISNULL(
		(
			SELECT TOP(1) NodeTypeID 
			FROM [dbo].[CN_Nodes] 
			WHERE ApplicationID = @ApplicationID AND NodeID = @NodeTypeIDOrNodeID
		), @NodeTypeIDOrNodeID
	)
	
	IF @Value IS NULL BEGIN
		SELECT TOP(1) EnablePreviousVersionSelect
		FROM [dbo].[CN_Services]
		WHERE ApplicationID = @ApplicationID AND NodeTypeID = @NodeTypeIDOrNodeID
	END
	ELSE BEGIN
		UPDATE [dbo].[CN_Services]
			SET EnablePreviousVersionSelect = @Value
		WHERE ApplicationID = @ApplicationID AND NodeTypeID = @NodeTypeIDOrNodeID
		
		SELECT @@ROWCOUNT
	END
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_IsTree]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_IsTree]
GO

CREATE PROCEDURE [dbo].[CN_IsTree]
	@ApplicationID			uniqueidentifier,
	@strNodeTypeOrNodeIDs	varchar(max),
	@delimiter				char,
	@IsTree					bit
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @NodeTypeIDs TABLE (FirstValue uniqueidentifier not null primary key clustered,
		SecondValue uniqueidentifier)
	
	INSERT INTO @NodeTypeIDs (FirstValue, SecondValue)
	SELECT DISTINCT ISNULL(ND.NodeTypeID, IDs.Value), ND.NodeID
	FROM [dbo].[GFN_StrToGuidTable](@strNodeTypeOrNodeIDs, @delimiter) AS IDs
		LEFT JOIN [dbo].[CN_Nodes] AS ND
		ON ND.ApplicationID = @ApplicationID AND ND.NodeID = IDs.Value
	
	IF @IsTree IS NULL BEGIN
		SELECT ISNULL(NT.SecondValue, NT.FirstValue) AS ID
		FROM @NodeTypeIDs AS NT
			INNER JOIN [dbo].[CN_Services] AS S
			ON S.NodeTypeID = NT.FirstValue
		WHERE S.ApplicationID = @ApplicationID AND S.IsTree = 1
	END
	ELSE BEGIN
		UPDATE S
			SET IsTree = @IsTree
		FROM @NodeTypeIDs AS NT
			INNER JOIN [dbo].[CN_Services] AS S
			ON S.NodeTypeID = NT.FirstValue
		WHERE S.ApplicationID = @ApplicationID AND NT.SecondValue IS NULL
		
		SELECT @@ROWCOUNT
	END
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_HasUniqueMembership]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_HasUniqueMembership]
GO

CREATE PROCEDURE [dbo].[CN_HasUniqueMembership]
	@ApplicationID			uniqueidentifier,
	@strNodeTypeOrNodeIDs	varchar(max),
	@delimiter				char,
	@Value					bit
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @NodeTypeIDs TABLE (FirstValue uniqueidentifier not null primary key clustered,
		SecondValue uniqueidentifier)
	
	INSERT INTO @NodeTypeIDs (FirstValue, SecondValue)
	SELECT DISTINCT ISNULL(ND.NodeTypeID, IDs.Value), ND.NodeID
	FROM [dbo].[GFN_StrToGuidTable](@strNodeTypeOrNodeIDs, @delimiter) AS IDs
		LEFT JOIN [dbo].[CN_Nodes] AS ND
		ON ND.ApplicationID = @ApplicationID AND ND.NodeID = IDs.Value
	
	IF @Value IS NULL BEGIN
		SELECT ISNULL(NT.SecondValue, NT.FirstValue) AS ID
		FROM @NodeTypeIDs AS NT
			INNER JOIN [dbo].[CN_Services] AS S
			ON S.NodeTypeID = NT.FirstValue
		WHERE S.ApplicationID = @ApplicationID AND S.UniqueMembership = 1
	END
	ELSE BEGIN
		UPDATE S
			SET UniqueMembership = @Value
		FROM @NodeTypeIDs AS NT
			INNER JOIN [dbo].[CN_Services] AS S
			ON S.NodeTypeID = NT.FirstValue
		WHERE S.ApplicationID = @ApplicationID AND NT.SecondValue IS NULL
		
		SELECT @@ROWCOUNT
	END
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_HasUniqueAdminMember]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_HasUniqueAdminMember]
GO

CREATE PROCEDURE [dbo].[CN_HasUniqueAdminMember]
	@ApplicationID			uniqueidentifier,
	@strNodeTypeOrNodeIDs	varchar(max),
	@delimiter				char,
	@Value					bit
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @NodeTypeIDs TABLE (FirstValue uniqueidentifier not null primary key clustered,
		SecondValue uniqueidentifier)
	
	INSERT INTO @NodeTypeIDs (FirstValue, SecondValue)
	SELECT DISTINCT ISNULL(ND.NodeTypeID, IDs.Value), ND.NodeID
	FROM [dbo].[GFN_StrToGuidTable](@strNodeTypeOrNodeIDs, @delimiter) AS IDs
		LEFT JOIN [dbo].[CN_Nodes] AS ND
		ON ND.ApplicationID = @ApplicationID AND ND.NodeID = IDs.Value
	
	IF @Value IS NULL BEGIN
		SELECT ISNULL(NT.SecondValue, NT.FirstValue) AS ID
		FROM @NodeTypeIDs AS NT
			INNER JOIN [dbo].[CN_Services] AS S
			ON S.NodeTypeID = NT.FirstValue
		WHERE S.ApplicationID = @ApplicationID AND S.UniqueAdminMember = 1
	END
	ELSE BEGIN
		UPDATE S
			SET UniqueAdminMember = @Value
		FROM @NodeTypeIDs AS NT
			INNER JOIN [dbo].[CN_Services] AS S
			ON S.NodeTypeID = NT.FirstValue
		WHERE S.ApplicationID = @ApplicationID AND NT.SecondValue IS NULL
		
		SELECT @@ROWCOUNT
	END
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_AbstractAndKeywordsDisabled]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_AbstractAndKeywordsDisabled]
GO

CREATE PROCEDURE [dbo].[CN_AbstractAndKeywordsDisabled]
	@ApplicationID			uniqueidentifier,
	@strNodeTypeOrNodeIDs	varchar(max),
	@delimiter				char,
	@Value					bit
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @NodeTypeIDs TABLE (FirstValue uniqueidentifier not null primary key clustered,
		SecondValue uniqueidentifier)
	
	INSERT INTO @NodeTypeIDs (FirstValue, SecondValue)
	SELECT DISTINCT ISNULL(ND.NodeTypeID, IDs.Value), ND.NodeID
	FROM [dbo].[GFN_StrToGuidTable](@strNodeTypeOrNodeIDs, @delimiter) AS IDs
		LEFT JOIN [dbo].[CN_Nodes] AS ND
		ON ND.ApplicationID = @ApplicationID AND ND.NodeID = IDs.Value
	
	IF @Value IS NULL BEGIN
		SELECT ISNULL(NT.SecondValue, NT.FirstValue) AS ID
		FROM @NodeTypeIDs AS NT
			INNER JOIN [dbo].[CN_Services] AS S
			ON S.NodeTypeID = NT.FirstValue
		WHERE S.ApplicationID = @ApplicationID AND S.DisableAbstractAndKeywords = 1
	END
	ELSE BEGIN
		UPDATE S
			SET DisableAbstractAndKeywords = @Value
		FROM @NodeTypeIDs AS NT
			INNER JOIN [dbo].[CN_Services] AS S
			ON S.NodeTypeID = NT.FirstValue
		WHERE S.ApplicationID = @ApplicationID AND NT.SecondValue IS NULL
		
		SELECT @@ROWCOUNT
	END
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_FileUploadDisabled]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_FileUploadDisabled]
GO

CREATE PROCEDURE [dbo].[CN_FileUploadDisabled]
	@ApplicationID			uniqueidentifier,
	@strNodeTypeOrNodeIDs	varchar(max),
	@delimiter				char,
	@Value					bit
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @NodeTypeIDs TABLE (FirstValue uniqueidentifier not null primary key clustered,
		SecondValue uniqueidentifier)
	
	INSERT INTO @NodeTypeIDs (FirstValue, SecondValue)
	SELECT DISTINCT ISNULL(ND.NodeTypeID, IDs.Value), ND.NodeID
	FROM [dbo].[GFN_StrToGuidTable](@strNodeTypeOrNodeIDs, @delimiter) AS IDs
		LEFT JOIN [dbo].[CN_Nodes] AS ND
		ON ND.ApplicationID = @ApplicationID AND ND.NodeID = IDs.Value
	
	IF @Value IS NULL BEGIN
		SELECT ISNULL(NT.SecondValue, NT.FirstValue) AS ID
		FROM @NodeTypeIDs AS NT
			INNER JOIN [dbo].[CN_Services] AS S
			ON S.NodeTypeID = NT.FirstValue
		WHERE S.ApplicationID = @ApplicationID AND S.DisableFileUpload = 1
	END
	ELSE BEGIN
		UPDATE S
			SET DisableFileUpload = @Value
		FROM @NodeTypeIDs AS NT
			INNER JOIN [dbo].[CN_Services] AS S
			ON S.NodeTypeID = NT.FirstValue
		WHERE S.ApplicationID = @ApplicationID AND NT.SecondValue IS NULL
		
		SELECT @@ROWCOUNT
	END
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_RelatedNodesSelectDisabled]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_RelatedNodesSelectDisabled]
GO

CREATE PROCEDURE [dbo].[CN_RelatedNodesSelectDisabled]
	@ApplicationID			uniqueidentifier,
	@strNodeTypeOrNodeIDs	varchar(max),
	@delimiter				char,
	@Value					bit
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @NodeTypeIDs TABLE (FirstValue uniqueidentifier not null primary key clustered,
		SecondValue uniqueidentifier)
	
	INSERT INTO @NodeTypeIDs (FirstValue, SecondValue)
	SELECT DISTINCT ISNULL(ND.NodeTypeID, IDs.Value), ND.NodeID
	FROM [dbo].[GFN_StrToGuidTable](@strNodeTypeOrNodeIDs, @delimiter) AS IDs
		LEFT JOIN [dbo].[CN_Nodes] AS ND
		ON ND.ApplicationID = @ApplicationID AND ND.NodeID = IDs.Value
	
	IF @Value IS NULL BEGIN
		SELECT ISNULL(NT.SecondValue, NT.FirstValue) AS ID
		FROM @NodeTypeIDs AS NT
			INNER JOIN [dbo].[CN_Services] AS S
			ON S.NodeTypeID = NT.FirstValue
		WHERE S.ApplicationID = @ApplicationID AND S.DisableRelatedNodesSelect = 1
	END
	ELSE BEGIN
		UPDATE S
			SET DisableRelatedNodesSelect = @Value
		FROM @NodeTypeIDs AS NT
			INNER JOIN [dbo].[CN_Services] AS S
			ON S.NodeTypeID = NT.FirstValue
		WHERE S.ApplicationID = @ApplicationID AND NT.SecondValue IS NULL
		
		SELECT @@ROWCOUNT
	END
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_EditableForAdmin]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_EditableForAdmin]
GO

CREATE PROCEDURE [dbo].[CN_EditableForAdmin]
	@ApplicationID	uniqueidentifier,
	@NodeTypeID		uniqueidentifier,
	@Editable		bit
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[CN_Services]
		SET EditableForAdmin = @Editable
	WHERE ApplicationID = @ApplicationID AND NodeTypeID = @NodeTypeID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_EditableForCreator]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_EditableForCreator]
GO

CREATE PROCEDURE [dbo].[CN_EditableForCreator]
	@ApplicationID	uniqueidentifier,
	@NodeTypeID		uniqueidentifier,
	@Editable		bit
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[CN_Services]
		SET EditableForCreator = @Editable
	WHERE ApplicationID = @ApplicationID AND NodeTypeID = @NodeTypeID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_EditableForOwners]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_EditableForOwners]
GO

CREATE PROCEDURE [dbo].[CN_EditableForOwners]
	@ApplicationID	uniqueidentifier,
	@NodeTypeID		uniqueidentifier,
	@Editable		bit
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[CN_Services]
		SET EditableForOwners = @Editable
	WHERE ApplicationID = @ApplicationID AND NodeTypeID = @NodeTypeID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_EditableForExperts]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_EditableForExperts]
GO

CREATE PROCEDURE [dbo].[CN_EditableForExperts]
	@ApplicationID	uniqueidentifier,
	@NodeTypeID		uniqueidentifier,
	@Editable		bit
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[CN_Services]
		SET EditableForExperts = @Editable
	WHERE ApplicationID = @ApplicationID AND NodeTypeID = @NodeTypeID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_EditableForMembers]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_EditableForMembers]
GO

CREATE PROCEDURE [dbo].[CN_EditableForMembers]
	@ApplicationID	uniqueidentifier,
	@NodeTypeID		uniqueidentifier,
	@Editable		bit
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[CN_Services]
		SET EditableForMembers = @Editable
	WHERE ApplicationID = @ApplicationID AND NodeTypeID = @NodeTypeID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_EditSuggestion]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_EditSuggestion]
GO

CREATE PROCEDURE [dbo].[CN_EditSuggestion]
	@ApplicationID	uniqueidentifier,
	@NodeTypeID		uniqueidentifier,
	@Enable			bit
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[CN_Services]
		SET EditSuggestion = @Enable
	WHERE ApplicationID = @ApplicationID AND NodeTypeID = @NodeTypeID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_AddFreeUser]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_AddFreeUser]
GO

CREATE PROCEDURE [dbo].[CN_AddFreeUser]
	@ApplicationID		uniqueidentifier,
	@NodeTypeID			uniqueidentifier,
	@UserID				uniqueidentifier,
	@CreatorUserID		uniqueidentifier,
	@CreationDate		datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	IF EXISTS(
		SELECT TOP(1) * 
		FROM [dbo].[CN_FreeUsers]
		WHERE ApplicationID = @ApplicationID AND NodeTypeID = @NodeTypeID AND UserID = @UserID
	) BEGIN	
		UPDATE [dbo].[CN_FreeUsers]
			SET LastModifierUserID = @CreatorUserID,
				LastModificationDate = @CreationDate,
				Deleted = 0
		WHERE ApplicationID = @ApplicationID AND NodeTypeID = @NodeTypeID AND UserID = @UserID
	END
	ELSE BEGIN
		INSERT INTO [dbo].[CN_FreeUsers](
			ApplicationID,
			NodeTypeID,
			UserID,
			CreatorUserID,
			CreationDate,
			Deleted
		)
		VALUES(
			@ApplicationID,
			@NodeTypeID,
			@UserID,
			@CreatorUserID,
			@CreationDate,
			0
		)
	END
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_ArithmeticDeleteFreeUser]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_ArithmeticDeleteFreeUser]
GO

CREATE PROCEDURE [dbo].[CN_ArithmeticDeleteFreeUser]
	@ApplicationID			uniqueidentifier,
	@NodeTypeID				uniqueidentifier,
	@UserID					uniqueidentifier,
	@LastModifierUserID		uniqueidentifier,
	@LastModificationDate	datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[CN_FreeUsers]
		SET LastModifierUserID = @LastModifierUserID,
			LastModificationDate = @LastModificationDate,
			Deleted = 1
	WHERE ApplicationID = @ApplicationID AND NodeTypeID = @NodeTypeID AND UserID = @UserID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_GetFreeUserIDs]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_GetFreeUserIDs]
GO

CREATE PROCEDURE [dbo].[CN_GetFreeUserIDs]
	@ApplicationID	uniqueidentifier,
	@NodeTypeID		uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT UserID AS ID
	FROM [dbo].[CN_FreeUsers]
	WHERE ApplicationID = @ApplicationID AND NodeTypeID = @NodeTypeID AND Deleted = 0
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_IsFreeUser]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_IsFreeUser]
GO

CREATE PROCEDURE [dbo].[CN_IsFreeUser]
	@ApplicationID			uniqueidentifier,
	@NodeTypeIDOrNodeID		uniqueidentifier,
	@UserID					uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	IF NOT EXISTS(
		SELECT TOP(1) NodeTypeID 
		FROM [dbo].[CN_NodeTypes] 
		WHERE ApplicationID = @ApplicationID AND NodeTypeID = @NodeTypeIDOrNodeID
	) BEGIN
		SELECT TOP(1) @NodeTypeIDOrNodeID = NodeTypeID
		FROM [dbo].[CN_Nodes]
		WHERE ApplicationID = @ApplicationID AND NodeID = @NodeTypeIDOrNodeID
	END
	
	SELECT 
		CASE 
			WHEN EXISTS(
				SELECT TOP(1) UserID
				FROM [dbo].[CN_FreeUsers]
				WHERE ApplicationID = @ApplicationID AND 
					NodeTypeID = @NodeTypeIDOrNodeID AND UserID = @UserID AND Deleted = 0
			) THEN 1
			ELSE 0
		END
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_AddServiceAdmin]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_AddServiceAdmin]
GO

CREATE PROCEDURE [dbo].[CN_AddServiceAdmin]
	@ApplicationID		uniqueidentifier,
	@NodeTypeID			uniqueidentifier,
	@UserID				uniqueidentifier,
	@CreatorUserID		uniqueidentifier,
	@CreationDate		datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	IF EXISTS(
		SELECT TOP(1) * 
		FROM [dbo].[CN_ServiceAdmins]
		WHERE ApplicationID = @ApplicationID AND NodeTypeID = @NodeTypeID AND UserID = @UserID
	) BEGIN
		
		UPDATE [dbo].[CN_ServiceAdmins]
			SET LastModifierUserID = @CreatorUserID,
				LastModificationDate = @CreationDate,
				Deleted = 0
		WHERE ApplicationID = @ApplicationID AND NodeTypeID = @NodeTypeID AND UserID = @UserID
	END
	ELSE BEGIN
		INSERT INTO [dbo].[CN_ServiceAdmins](
			ApplicationID,
			NodeTypeID,
			UserID,
			CreatorUserID,
			CreationDate,
			Deleted
		)
		VALUES(
			@ApplicationID,
			@NodeTypeID,
			@UserID,
			@CreatorUserID,
			@CreationDate,
			0
		)
	END
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_ArithmeticDeleteServiceAdmin]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_ArithmeticDeleteServiceAdmin]
GO

CREATE PROCEDURE [dbo].[CN_ArithmeticDeleteServiceAdmin]
	@ApplicationID			uniqueidentifier,
	@NodeTypeID				uniqueidentifier,
	@UserID					uniqueidentifier,
	@LastModifierUserID		uniqueidentifier,
	@LastModificationDate	datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[CN_ServiceAdmins]
		SET LastModifierUserID = @LastModifierUserID,
			LastModificationDate = @LastModificationDate,
			Deleted = 1
	WHERE ApplicationID = @ApplicationID AND NodeTypeID = @NodeTypeID AND UserID = @UserID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_GetServiceAdminIDs]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_GetServiceAdminIDs]
GO

CREATE PROCEDURE [dbo].[CN_GetServiceAdminIDs]
	@ApplicationID	uniqueidentifier,
	@NodeTypeID		uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT UserID AS ID
	FROM [dbo].[CN_ServiceAdmins]
	WHERE ApplicationID = @ApplicationID AND 
		(@NodeTypeID IS NULL OR NodeTypeID = @NodeTypeID) AND Deleted = 0
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_IsServiceAdmin]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_IsServiceAdmin]
GO

CREATE PROCEDURE [dbo].[CN_IsServiceAdmin]
	@ApplicationID	uniqueidentifier,
	@strIDs			varchar(max),
	@delimiter		char,
	@UserID			uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @IDs GuidTableType
	
	INSERT INTO @IDs (Value)
	SELECT Ref.Value
	FROM [dbo].[GFN_StrToGuidTable](@strIDs, @delimiter) AS Ref
	
	SELECT I.Value AS ID
	FROM @IDs AS I
		LEFT JOIN [dbo].[CN_Nodes] AS ND
		ON ND.ApplicationID = @ApplicationID AND ND.NodeID = I.Value
		INNER JOIN [dbo].[CN_ServiceAdmins] AS SA
		ON SA.ApplicationID = @ApplicationID AND 
			SA.NodeTypeID = ISNULL(ND.NodeTypeID, I.Value) AND 
			SA.UserID = @UserID AND SA.Deleted = 0
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_RegisterNewNode]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_RegisterNewNode]
GO

CREATE PROCEDURE [dbo].[CN_RegisterNewNode]
	@ApplicationID		uniqueidentifier,
	@NodeID				uniqueidentifier,
    @NodeTypeID			uniqueidentifier,
    @AdditionalID_Main	nvarchar(300),
    @AdditionalID		nvarchar(50),
    @ParentNodeID		uniqueidentifier,
    @DocumentTreeNodeID	uniqueidentifier,
    @PreviousVersionID	uniqueidentifier,
	@Name				nvarchar(255),
	@Description		nvarchar(max),
	@Tags				nvarchar(max),
	@CreatorUserID		uniqueidentifier,
	@CreationDate		datetime,
	@ContributorsTemp	GuidFloatTableType readonly,
	@OwnerID			uniqueidentifier,
	@WorkFlowID			uniqueidentifier,
	@AdminAreaID		uniqueidentifier,
	@FormInstanceID		uniqueidentifier,
	@WFDirectorNodeID	uniqueidentifier,
	@WFDirectorUserID	uniqueidentifier
WITH ENCRYPTION, RECOMPILE
AS
BEGIN TRANSACTION
	SET NOCOUNT ON
	
	DECLARE @Contributors GuidFloatTableType
	INSERT INTO @Contributors SELECT * FROM @ContributorsTemp
	
	DECLARE @Searchable bit = CASE WHEN @WorkFlowID IS NULL THEN 1 ELSE 0 END
	
	-- Set searchability 
	SELECT TOP(1) @Searchable = (
		CASE
			WHEN ISNULL(S.IsKnowledge, 0) = 0 OR 
				KT.SearchableAfter = N'Registration' THEN CAST(1 AS bit)
			ELSE CAST(0 AS bit)
		END
	)
	FROM [dbo].[CN_Services] AS S
		LEFT JOIN [dbo].[KW_KnowledgeTypes] AS KT
		ON KT.ApplicationID = @ApplicationID AND KT.KnowledgeTypeID = S.NodeTypeID
	WHERE S.ApplicationID = @ApplicationID AND 
		S.NodeTypeID = @NodeTypeID AND S.IsKnowledge = 1

	DECLARE @_Message varchar(1000)
	DECLARE @_Result int = -1
	
	EXEC [dbo].[CN_P_AddNode] @ApplicationID, @NodeID, @AdditionalID, @NodeTypeID, NULL, 
		@DocumentTreeNodeID, @PreviousVersionID, @Name, @Description, @Tags, @Searchable, 
		@CreatorUserID, @CreationDate, @ParentNodeID, @OwnerID, NULL,
		@_Result output, @_Message output
	
	IF @_Result <= 0 BEGIN
		SELECT @_Result, ISNULL(@_Message, N'NodeCreationFailed')
		ROLLBACK TRANSACTION
		RETURN
	END
	
	UPDATE [dbo].[CN_Nodes]
		SET AdditionalID_Main = @AdditionalID_Main,
			AreaID = @AdminAreaID
	WHERE ApplicationID = @ApplicationID AND NodeID = @NodeID
	
	-- Hide Previous Version
	IF (@Searchable = 1 AND @PreviousVersionID IS NOT NULL) BEGIN
		UPDATE [dbo].[CN_Nodes]
			SET Searchable = 0
		WHERE ApplicationID = @ApplicationID AND NodeID = @PreviousVersionID AND Deleted = 0
	END
	-- end of Hide Previous Version
	
	IF @FormInstanceID IS NOT NULL BEGIN
		UPDATE [dbo].[FG_FormInstances]
			SET OwnerID = @NodeID,
				IsTemporary = 0
		WHERE ApplicationID = @ApplicationID AND InstanceID = @FormInstanceID
	END
	
	SET @_Message = NULL
	
	EXEC [dbo].[CN_P_SetNodeCreators] @ApplicationID, @NodeID, @Contributors, 
		N'Accepted', @CreatorUserID, @CreationDate, @_Result output 
	
	IF @_Result <= 0 BEGIN
		SELECT -1, N'ErrorInAddingNodeCreators'
		ROLLBACK TRANSACTION
		RETURN
	END
	
	IF @DocumentTreeNodeID IS NOT NULL BEGIN
		DECLARE @DocIDs GuidTableType
		
		INSERT INTO @DocIDs (Value) VALUES (@NodeID)
		
		EXEC [dbo].[DCT_P_AddTreeNodeContents] @ApplicationID, @DocumentTreeNodeID, 
			@DocIDs, NULL, @CreatorUserID, @CreationDate, @_Result output
			
		IF @_Result <= 0 BEGIN
			SELECT -1, N'ErrorInAddingTreeNodeContents'
			ROLLBACK TRANSACTION
			RETURN
		END
	END
	
	DECLARE @FormID uniqueidentifier = (
		SELECT TOP(1) FW.FormID
		FROM [dbo].[FG_FormOwners] AS FW
		WHERE FW.ApplicationID = @ApplicationID AND 
			FW.OwnerID = @NodeTypeID AND FW.Deleted = 0 AND @FormInstanceID IS NULL
	)
	
	IF @FormID IS NOT NULL BEGIN
		IF EXISTS(
			SELECT TOP(1) * 
			FROM [dbo].[CN_Extensions] 
			WHERE ApplicationID = @ApplicationID AND 
				OwnerID = @NodeTypeID AND Extension = N'Form' AND Deleted = 0
		) BEGIN	
			DECLARE @InstanceID uniqueidentifier = NEWID()
			
			DECLARE @Instances FormInstanceTableType
			
			INSERT INTO @Instances (InstanceID, FormID, OwnerID, DirectorID, [Admin])
			VALUES (@InstanceID, @FormID, @NodeID, NULL, NULL)
		
			EXEC [dbo].[FG_P_CreateFormInstance] @ApplicationID, @Instances, @CreatorUserID, @CreationDate, @_Result output	
				
			IF @_Result <= 0 BEGIN
				SELECT -1, N'FormInstanceInitializationFailed'
				ROLLBACK TRANSACTION
				RETURN
			END
		END
		ELSE BEGIN
			DECLARE @FormElements StringPairTableType
			
			INSERT INTO @FormElements (FirstValue, SecondValue)
			SELECT Title, N''
			FROM [dbo].[FG_ExtendedFormElements]
			WHERE ApplicationID = @ApplicationID AND FormID = @FormID AND Deleted = 0
			ORDER BY SequenceNumber
			
			EXEC [dbo].[WK_P_CreateWiki] @ApplicationID, @NodeID, @FormElements, 1, 
				@CreatorUserID, @CreationDate, @_Result output 
				
			IF @_Result <= 0 BEGIN
				SELECT -1, N'WikiInitializationFailed'
				ROLLBACK TRANSACTION
				RETURN
			END
		END
	END
	
	IF @WorkFlowID IS NOT NULL BEGIN
		EXEC [dbo].[WF_P_StartNewWorkFlow] @ApplicationID, @NodeID, @WorkFlowID, @WFDirectorNodeID, 
			@WFDirectorUserID, @CreatorUserID, @CreationDate, @_Result output, @_Message output
		
		IF @_Result <= 0 BEGIN
			SELECT -1, ISNULL(@_Message, N'WorkFlowInitializationFailed')
			ROLLBACK TRANSACTION
			RETURN
		END
	END

	SELECT 1
COMMIT TRANSACTION

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_SetAdminArea]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_SetAdminArea]
GO

CREATE PROCEDURE [dbo].[CN_SetAdminArea]
	@ApplicationID	uniqueidentifier,
    @NodeID			uniqueidentifier,
    @AreaID			uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[CN_Nodes]
		SET AreaID = @AreaID
	WHERE ApplicationID = @ApplicationID AND NodeID = @NodeID
	
	SELECT @@ROWCOUNT
END

GO

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WF_P_SendDashboards]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WF_P_SendDashboards]
GO

CREATE PROCEDURE [dbo].[WF_P_SendDashboards]
	@ApplicationID		uniqueidentifier,
	@HistoryID			uniqueidentifier,
	@NodeID				uniqueidentifier,
	@WorkFlowID			uniqueidentifier,
	@StateID			uniqueidentifier,
	@DirectorUserID		uniqueidentifier,
	@DirectorNodeID		uniqueidentifier,
	@DataNeedInstanceID	uniqueidentifier,
	@SendDate			datetime,
	@_Result			int output
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @OnlySendDataNeed bit = 0
	IF @DataNeedInstanceID IS NOT NULL BEGIN
		SET @OnlySendDataNeed = 1
		
		IF @HistoryID IS NULL SET @HistoryID = (
			SELECT TOP(1) HistoryID
			FROM [dbo].[WF_StateDataNeedInstances]
			WHERE ApplicationID = @ApplicationID AND InstanceID = @DataNeedInstanceID
		)
		
		IF @WorkFlowID IS NULL OR @StateID IS NULL OR @NodeID IS NULL BEGIN
			SELECT @WorkFlowID = WorkFlowID, @StateID = StateID, @NodeID = OwnerID
			FROM [dbo].[WF_History]
			WHERE ApplicationID = @ApplicationID AND HistoryID = @HistoryID
		END
	END
	
	DECLARE @Dashboards DashboardTableType
	
	DECLARE @WorkFlowName nvarchar(1000) = (
		SELECT TOP(1) Name 
		FROM [dbo].[WF_WorkFlows] 
		WHERE ApplicationID = @ApplicationID AND WorkFlowID = @WorkFlowID
	)
	
	DECLARE @StateTitle nvarchar(1000) = (
		SELECT TOP(1) Title 
		FROM [dbo].[WF_States] 
		WHERE ApplicationID = @ApplicationID AND StateID = @StateID
	)
	
	INSERT INTO @Dashboards(UserID, NodeID, RefItemID, [Type], Info, Removable, SendDate)
	SELECT	NM.UserID, 
			@NodeID, 
			SDNI.InstanceID, 
			N'WorkFlow',
			[dbo].[WF_FN_GetDashboardInfo](@WorkFlowName, @StateTitle, SDNI.InstanceID),
			0,
			@SendDate
	FROM [dbo].[WF_StateDataNeedInstances] AS SDNI
		INNER JOIN [dbo].[CN_View_NodeMembers] AS NM
		ON NM.ApplicationID = @ApplicationID AND NM.NodeID = SDNI.NodeID AND NM.IsPending = 0
	WHERE SDNI.ApplicationID = @ApplicationID AND (
			(@OnlySendDataNeed = 1 AND SDNI.InstanceID = @DataNeedInstanceID) OR
			(@OnlySendDataNeed = 0 AND SDNI.HistoryID = @HistoryID)
		) AND
		(SDNI.[Admin] = 0 OR SDNI.[Admin] = NM.IsAdmin) AND SDNI.Deleted = 0
	
	IF @OnlySendDataNeed = 0 BEGIN
		DECLARE @Info nvarchar(max) = 
			[dbo].[WF_FN_GetDashboardInfo](@WorkFlowName, @StateTitle, @DataNeedInstanceID)
	
		IF @DirectorUserID IS NOT NULL BEGIN
			INSERT INTO @Dashboards(UserID, NodeID, RefItemID, [Type], Info, Removable, SendDate)
			VALUES (@DirectorUserID, @NodeID, @HistoryID, N'WorkFlow', @Info, 0, @SendDate)
		END
	
		IF @DirectorNodeID IS NOT NULL BEGIN
			DECLARE @IsDirectorNodeAdmin bit = (
				SELECT TOP(1) [Admin]
				FROM [dbo].[WF_WorkFlowStates]
				WHERE ApplicationID = @ApplicationID AND 
					WorkFlowID = @WorkFlowID AND StateID = @StateID AND Deleted = 0
			)
		
			INSERT INTO @Dashboards(UserID, NodeID, RefItemID, [Type], Info, Removable, SendDate)
			SELECT	NM.UserID, @NodeID, @HistoryID, N'WorkFlow', @Info, 
				CASE
					WHEN ISNULL(@IsDirectorNodeAdmin, 0) = 0 OR NM.IsAdmin = 1 THEN CAST(0 AS bit)
					ELSE CAST(1 AS bit)
				END,
				@SendDate
			FROM [dbo].[CN_View_NodeMembers] AS NM
			WHERE ApplicationID = @ApplicationID AND NodeID = @DirectorNodeID AND 
				NM.IsPending = 0 AND
				NOT EXISTS(
					SELECT TOP(1) * 
					FROM @Dashboards AS Ref 
					WHERE Ref.UserID = NM.UserID
				)
		END
		
		EXEC [dbo].[NTFN_P_ArithmeticDeleteDashboards] @ApplicationID, 
			NULL, @NodeID, NULL, N'WorkFlow', NULL, @_Result output
		
		IF @_Result <= 0 RETURN
	END  -- end of 'IF @OnlySendDataNeed = 1 BEGIN'
	
	IF (SELECT COUNT(*) FROM @Dashboards) = 0 BEGIN
		SET @_Result = -1
		RETURN
	END
	
	EXEC [dbo].[NTFN_P_SendDashboards] @ApplicationID, @Dashboards, @_Result output
	
	IF @_Result <= 0 RETURN
	
	IF @_Result > 0 BEGIN
		SELECT * 
		FROM @Dashboards
	END
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WF_CreateState]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WF_CreateState]
GO

CREATE PROCEDURE [dbo].[WF_CreateState]
	@ApplicationID		uniqueidentifier,
	@StateID			uniqueidentifier,
	@Title				nvarchar(255),
	@CreatorUserID		uniqueidentifier,
	@CreationDate		datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @_RetVal int
	SET @_RetVal = 0
	
	SET @Title = [dbo].[GFN_VerifyString](@Title)
	
	INSERT INTO [dbo].[WF_States](
		ApplicationID,
		StateID,
		Title,
		CreatorUserID,
		CreationDate,
		Deleted
	)
	VALUES(
		@ApplicationID,
		@StateID,
		@Title,
		@CreatorUserID,
		@CreationDate,
		0
	)
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WF_ModifyState]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WF_ModifyState]
GO

CREATE PROCEDURE [dbo].[WF_ModifyState]
	@ApplicationID			uniqueidentifier,
	@StateID				uniqueidentifier,
	@Title					nvarchar(255),
	@LastModifierUserID		uniqueidentifier,
	@LastModificationDate	datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SET @Title = [dbo].[GFN_VerifyString](@Title)
	
	UPDATE [dbo].[WF_States]
		SET Title = @Title,
			LastModifierUserID = @LastModifierUserID,
			LastModificationDate = @LastModificationDate
	WHERE ApplicationID = @ApplicationID AND StateID = @StateID
		
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WF_ArithmeticDeleteState]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WF_ArithmeticDeleteState]
GO

CREATE PROCEDURE [dbo].[WF_ArithmeticDeleteState]
	@ApplicationID			uniqueidentifier,
	@StateID				uniqueidentifier,
	@LastModifierUserID		uniqueidentifier,
	@LastModificationDate	datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[WF_States]
		SET LastModifierUserID = @LastModifierUserID,
			LastModificationDate = @LastModificationDate,
			Deleted = 1
	WHERE ApplicationID = @ApplicationID AND StateID = @StateID
		
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WF_P_GetStatesByIDs]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WF_P_GetStatesByIDs]
GO

CREATE PROCEDURE [dbo].[WF_P_GetStatesByIDs]
	@ApplicationID	uniqueidentifier,
	@StateIDsTemp	GuidTableType readonly
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @StateIDs GuidTableType
	INSERT INTO @StateIDs SELECT * FROM @StateIDsTemp
	
	SELECT ST.StateID AS StateID,
		   ST.Title AS Title
	FROM @StateIDs AS ExternalIDs
		INNER JOIN [dbo].[WF_States] AS ST
		ON ST.ApplicationID = @ApplicationID AND ST.StateID = ExternalIDs.Value
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WF_GetStatesByIDs]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WF_GetStatesByIDs]
GO

CREATE PROCEDURE [dbo].[WF_GetStatesByIDs]
	@ApplicationID	uniqueidentifier,
	@strStateIDs	varchar(max),
	@delimiter		char
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @StateIDs GuidTableType
	INSERT @StateIDs
	SELECT DISTINCT Ref.Value FROM [dbo].[GFN_StrToGuidTable](@strStateIDs, @delimiter) AS Ref
	
	EXEC [dbo].[WF_P_GetStatesByIDs] @ApplicationID, @StateIDs
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WF_GetStates]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WF_GetStates]
GO

CREATE PROCEDURE [dbo].[WF_GetStates]
	@ApplicationID	uniqueidentifier,
	@WorkFlowID		uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @StateIDs GuidTableType
	
	IF @WorkFlowID IS NULL BEGIN
		INSERT INTO @StateIDs
		SELECT StateID
		FROM [dbo].[WF_States]
		WHERE ApplicationID = @ApplicationID AND Deleted = 0
	END
	ELSE BEGIN
		INSERT INTO @StateIDs
		SELECT StateID
		FROM [dbo].[WF_WorkFlowStates]
		WHERE ApplicationID = @ApplicationID AND WorkFlowID = @WorkFlowID AND Deleted = 0
	END
	
	EXEC [dbo].[WF_P_GetStatesByIDs] @ApplicationID, @StateIDs
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WF_CreateWorkFlow]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WF_CreateWorkFlow]
GO

CREATE PROCEDURE [dbo].[WF_CreateWorkFlow]
	@ApplicationID		uniqueidentifier,
    @WorkFlowID			uniqueidentifier,
	@Name				nvarchar(255),
	@Description		nvarchar(2000),
	@CreatorUserID		uniqueidentifier,
	@CreationDate		datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @_RetVal int
	SET @_RetVal = 0
	
	SET @Name = [dbo].[GFN_VerifyString](@Name)
	SET @Description = [dbo].[GFN_VerifyString](@Description)
	
	IF EXISTS (
		SELECT TOP(1) * 
		FROM [dbo].[WF_WorkFlows]
		WHERE ApplicationID = @ApplicationID AND Name = @Name AND Deleted = 1
	) BEGIN
		UPDATE [dbo].[WF_WorkFlows]
			SET LastModifierUserID = @CreatorUserID,
				LastModificationDate = @CreationDate,
				Deleted = 0
		WHERE ApplicationID = @ApplicationID AND Name = @Name AND Deleted = 1
			
		SET @_RetVal = @@ROWCOUNT
	END
	
	IF EXISTS (
		SELECT TOP(1) * 
		FROM [dbo].[WF_WorkFlows]
		WHERE ApplicationID = @ApplicationID AND Name = @Name AND Deleted = 0
	) BEGIN
		SET @_RetVal = -1
	END
	ELSE BEGIN
		INSERT INTO [dbo].[WF_WorkFlows](
			ApplicationID,
			WorkFlowID,
			Name,
			[Description],
			CreatorUserID,
			CreationDate,
			Deleted
		)
		VALUES(
			@ApplicationID,
			@WorkFlowID,
			@Name,
			@Description,
			@CreatorUserID,
			@CreationDate,
			0
		)
		
		SET @_RetVal = @@ROWCOUNT
	END
	
	SELECT @_RetVal
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WF_ModifyWorkFlow]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WF_ModifyWorkFlow]
GO

CREATE PROCEDURE [dbo].[WF_ModifyWorkFlow]
	@ApplicationID			uniqueidentifier,
	@WorkFlowID				uniqueidentifier,
	@Name					nvarchar(255),
	@Description			nvarchar(2000),
	@LastModifierUserID		uniqueidentifier,
	@LastModificationDate	datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SET @Name = [dbo].[GFN_VerifyString](@Name)
	SET @Description = [dbo].[GFN_VerifyString](@Description)
	
	UPDATE [dbo].[WF_WorkFlows]
		SET Name = @Name,
			[Description] = @Description,
			LastModifierUserID = @LastModifierUserID,
			LastModificationDate = @LastModificationDate
	WHERE ApplicationID = @ApplicationID AND WorkFlowID = @WorkFlowID
		
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WF_ArithmeticDeleteWorkFlow]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WF_ArithmeticDeleteWorkFlow]
GO

CREATE PROCEDURE [dbo].[WF_ArithmeticDeleteWorkFlow]
	@ApplicationID			uniqueidentifier,
	@WorkFlowID				uniqueidentifier,
	@LastModifierUserID		uniqueidentifier,
	@LastModificationDate	datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[WF_WorkFlows]
		SET LastModifierUserID = @LastModifierUserID,
			LastModificationDate = @LastModificationDate,
			Deleted = 1
	WHERE ApplicationID = @ApplicationID AND WorkFlowID = @WorkFlowID
		
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WF_P_GetWorkFlowsByIDs]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WF_P_GetWorkFlowsByIDs]
GO

CREATE PROCEDURE [dbo].[WF_P_GetWorkFlowsByIDs]
	@ApplicationID		uniqueidentifier,
	@WorkFlowIDsTemp	GuidTableType readonly
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @WorkFlowIDs GuidTableType
	INSERT INTO @WorkFlowIDs SELECT * FROM @WorkFlowIDsTemp
	
	SELECT WF.WorkFlowID AS WorkFlowID,
		   WF.Name AS Name,
		   WF.[Description] AS [Description]
	FROM @WorkFlowIDs AS ExternalIDs
		INNER JOIN [dbo].[WF_WorkFlows] AS WF
		ON WF.ApplicationID = @ApplicationID AND WF.WorkFlowID = ExternalIDs.Value
	ORDER BY WF.CreationDate DESC
END

GO

IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WF_GetWorkFlowsByIDs]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WF_GetWorkFlowsByIDs]
GO

CREATE PROCEDURE [dbo].[WF_GetWorkFlowsByIDs]
	@ApplicationID		uniqueidentifier,
	@strWorkFlowIDs		varchar(max),
	@delimiter			char
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @WorkFlowIDs GuidTableType
	INSERT @WorkFlowIDs
	SELECT Ref.Value FROM [dbo].[GFN_StrToGuidTable](@strWorkFlowIDs, @delimiter) AS Ref
	
	EXEC [dbo].[WF_P_GetWorkFlowsByIDs] @ApplicationID, @WorkFlowIDs
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WF_GetWorkFlows]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WF_GetWorkFlows]
GO

CREATE PROCEDURE [dbo].[WF_GetWorkFlows]
	@ApplicationID	uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @WorkFlowIDs GuidTableType
	
	INSERT INTO @WorkFlowIDs
	SELECT WorkFlowID
	FROM [dbo].[WF_WorkFlows]
	WHERE ApplicationID = @ApplicationID AND Deleted = 0
	
	EXEC [dbo].[WF_P_GetWorkFlowsByIDs] @ApplicationID, @WorkFlowIDs
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WF_AddWorkFlowState]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WF_AddWorkFlowState]
GO

CREATE PROCEDURE [dbo].[WF_AddWorkFlowState]
	@ApplicationID	uniqueidentifier,
	@ID				uniqueidentifier,
	@WorkFlowID		uniqueidentifier,
	@StateID		uniqueidentifier,
	@CreatorUserID	uniqueidentifier,
	@CreationDate	datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	IF EXISTS(
		SELECT TOP(1) * 
		FROM [dbo].[WF_WorkFlowStates]
		WHERE ApplicationID = @ApplicationID AND 
			WorkFlowID = @WorkFlowID AND StateID = @StateID
	) BEGIN
		UPDATE [dbo].[WF_WorkFlowStates]
			SET Deleted = 0,
				LastModifierUserID = @CreatorUserID,
				LastModificationDate = @CreationDate
		WHERE ApplicationID = @ApplicationID AND 
			WorkFlowID = @WorkFlowID AND StateID = @StateID AND Deleted = 1
	END
	ELSE BEGIN
		INSERT INTO [dbo].[WF_WorkFlowStates](
			ApplicationID,
			ID,
			WorkFlowID,
			StateID,
			ResponseType,
			[Admin],
			DescriptionNeeded,
			HideOwnerName,
			FreeDataNeedRequests,
			EditPermission,
			CreatorUserID,
			CreationDate,
			Deleted
		)
		VALUES(
			@ApplicationID,
			@ID,
			@WorkFlowID,
			@StateID,
			NULL,
			0,
			1,
			0,
			0,
			0,
			@CreatorUserID,
			@CreationDate,
			0
		)
	END
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WF_ArithmeticDeleteWorkFlowState]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WF_ArithmeticDeleteWorkFlowState]
GO

CREATE PROCEDURE [dbo].[WF_ArithmeticDeleteWorkFlowState]
	@ApplicationID			uniqueidentifier,
	@WorkFlowID				uniqueidentifier,
	@StateID				uniqueidentifier,
	@LastModifierUserID		uniqueidentifier,
	@LastModificationDate	datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[WF_WorkFlowStates]
		SET Deleted = 1,
			LastModifierUserID = @LastModifierUserID,
			LastModificationDate = @LastModificationDate
	WHERE ApplicationID = @ApplicationID AND 
		WorkFlowID = @WorkFlowID AND StateID = @StateID AND Deleted = 0
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WF_SetWorkFlowStateDescription]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WF_SetWorkFlowStateDescription]
GO

CREATE PROCEDURE [dbo].[WF_SetWorkFlowStateDescription]
	@ApplicationID			uniqueidentifier,
	@WorkFlowID				uniqueidentifier,
	@StateID				uniqueidentifier,
	@Description			nvarchar(2000),
	@LastModifierUserID		uniqueidentifier,
	@LastModificationDate	datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SET @Description = [dbo].[GFN_VerifyString](@Description)
	
	UPDATE [dbo].[WF_WorkFlowStates]
		SET [Description] = @Description,
			LastModifierUserID = @LastModifierUserID,
			LastModificationDate = @LastModificationDate
	WHERE ApplicationID = @ApplicationID AND WorkFlowID = @WorkFlowID AND StateID = @StateID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WF_SetWorkFlowStateTag]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WF_SetWorkFlowStateTag]
GO

CREATE PROCEDURE [dbo].[WF_SetWorkFlowStateTag]
	@ApplicationID	uniqueidentifier,
	@WorkFlowID		uniqueidentifier,
	@StateID		uniqueidentifier,
	@Tag			nvarchar(450),
	@CreatorUserID	uniqueidentifier,
	@CreationDate	datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @TagID uniqueidentifier
	
	DECLARE @Tags StringTableType
	INSERT INTO @Tags (Value) VALUES(@Tag)
	
	EXEC [dbo].[CN_P_AddTags] @ApplicationID, 
		@Tags, @CreatorUserID, @CreationDate, @TagID output
	
	UPDATE [dbo].[WF_WorkFlowStates]
		SET TagID = @TagID
	WHERE ApplicationID = @ApplicationID AND WorkFlowID = @WorkFlowID AND StateID = @StateID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WF_RemoveWorkFlowStateTag]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WF_RemoveWorkFlowStateTag]
GO

CREATE PROCEDURE [dbo].[WF_RemoveWorkFlowStateTag]
	@ApplicationID	uniqueidentifier,
	@WorkFlowID		uniqueidentifier,
	@StateID		uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[WF_WorkFlowStates]
		SET TagID = NULL
	WHERE ApplicationID = @ApplicationID AND WorkFlowID = @WorkFlowID AND StateID = @StateID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WF_GetWorkFlowTags]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WF_GetWorkFlowTags]
GO

CREATE PROCEDURE [dbo].[WF_GetWorkFlowTags]
	@ApplicationID	uniqueidentifier,
	@WorkFlowID		uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT WFS.TagID, TG.Tag
	FROM [dbo].[WF_WorkFlowStates] AS WFS
		INNER JOIN [dbo].[CN_Tags] AS TG
		ON TG.ApplicationID = @ApplicationID AND TG.TagID = WFS.TagID
	WHERE WFS.ApplicationID = @ApplicationID AND 
		WFS.WorkFlowID = @WorkFlowID AND WFS.Deleted = 0
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WF_SaveWorkFlowActions]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WF_SaveWorkFlowActions]
GO

CREATE PROCEDURE [dbo].[WF_SaveWorkFlowActions]
	@ApplicationID	uniqueidentifier,
	@ConnectionID	uniqueidentifier,
	@ActionsTemp	StringTableType readonly,
	@CurrentUserID	uniqueidentifier,
	@Now			datetime
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @Actions StringTableType
	INSERT INTO @Actions SELECT * FROM @ActionsTemp 

	INSERT INTO [dbo].[WF_WorkFlowActions] (ApplicationID, ConnectionID, [Action], CreatorUserID, CreationDate, Deleted)
	SELECT @ApplicationID, @ConnectionID, C.[Value], @CurrentUserID, @Now, 0
	FROM @Actions AS C
		LEFT JOIN [dbo].[WF_WorkFlowActions] AS AC
		ON AC.ApplicationID = @ApplicationID AND AC.ConnectionID = @ConnectionID AND LOWER(AC.[Action]) = LOWER(C.[Value])
	WHERE AC.ConnectionID IS NULL

	;WITH [Data] AS (
		SELECT	ROW_NUMBER() OVER (ORDER BY (SELECT 1) ASC) AS Seq,
				A.[Value] AS [Action]
		FROM @Actions AS A
	)
	UPDATE AC
	SET Deleted = CASE WHEN C.[Action] IS NULL THEN 1 ELSE 0 END,
		SequenceNumber = ISNULL(C.Seq, AC.SequenceNumber),
		LastModifierUserID = @CurrentUserID,
		LastModificationDate = @Now
	FROM [dbo].[WF_WorkFlowActions] AS AC
		LEFT JOIN [Data] AS C
		ON LOWER(C.[Action]) = LOWER(AC.[Action])
	WHERE AC.ApplicationID = @ApplicationID AND AC.ConnectionID = @ConnectionID
	
	SELECT 1
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WF_GetWorkFlowActions]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WF_GetWorkFlowActions]
GO

CREATE PROCEDURE [dbo].[WF_GetWorkFlowActions]
	@ApplicationID	uniqueidentifier,
	@WorkFlowID		uniqueidentifier,
	@ConnectionID	uniqueidentifier
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	IF @ConnectionID IS NOT NULL BEGIN
		SELECT	AC.ConnectionID,
				AC.[Action]
		FROM [dbo].[WF_WorkFlowActions] AS AC
		WHERE AC.ApplicationID = @ApplicationID AND AC.ConnectionID = @ConnectionID AND AC.Deleted = 0
		ORDER BY AC.SequenceNumber ASC, AC.CreationDate ASC
	END
	ELSE IF @WorkFlowID IS NOT NULL BEGIN
		SELECT	AC.ConnectionID,
				AC.[Action]
		FROM [dbo].[WF_StateConnections] AS S
			INNER JOIN [dbo].[WF_WorkFlowActions] AS AC
			ON AC.ApplicationID = @ApplicationID AND AC.ConnectionID = S.ID AND AC.Deleted = 0
		WHERE S.ApplicationID = @ApplicationID AND S.WorkFlowID = @WorkFlowID AND S.Deleted = 0
		ORDER BY AC.SequenceNumber ASC, AC.CreationDate ASC
	END
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WF_GetNextStateActions]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WF_GetNextStateActions]
GO

CREATE PROCEDURE [dbo].[WF_GetNextStateActions]
	@ApplicationID	uniqueidentifier,
	@HistoryID		uniqueidentifier,
	@NextStateID	uniqueidentifier
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON

	SELECT	AC.ConnectionID,
			AC.[Action]
	FROM [dbo].[WF_History] AS H
		INNER JOIN [dbo].[WF_StateConnections] AS S
		ON S.ApplicationID = @ApplicationID AND 
			S.WorkFlowID = H.WorkFlowID AND S.OutStateID = @NextStateID AND S.InStateID = H.StateID
		INNER JOIN [dbo].[WF_WorkFlowActions] AS AC
		ON AC.ApplicationID = @ApplicationID AND AC.ConnectionID = S.ID AND AC.Deleted = 0
	WHERE H.ApplicationID = @ApplicationID AND H.HistoryID = @HistoryID
	ORDER BY AC.SequenceNumber ASC, AC.CreationDate ASC
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WF_SetStateDirector]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WF_SetStateDirector]
GO

CREATE PROCEDURE [dbo].[WF_SetStateDirector]
	@ApplicationID			uniqueidentifier,
	@WorkFlowID				uniqueidentifier,
	@StateID				uniqueidentifier,
	@ResponseType			varchar(20),
	@RefStateID				uniqueidentifier,
	@NodeID					uniqueidentifier,
	@Admin					bit,
	@UserID					uniqueidentifier,
	@LastModifierUserID		uniqueidentifier,
	@LastModificationDate	datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[WF_WorkFlowStates]
		SET ResponseType = @ResponseType,
			RefStateID = @RefStateID,
			NodeID = @NodeID,
			[Admin] = @Admin,
			UserID = @UserID,
			LastModifierUserID = @LastModifierUserID,
			LastModificationDate = @LastModificationDate
	WHERE ApplicationID = @ApplicationID AND WorkFlowID = @WorkFlowID AND StateID = @StateID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WF_SetStatePoll]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WF_SetStatePoll]
GO

CREATE PROCEDURE [dbo].[WF_SetStatePoll]
	@ApplicationID	uniqueidentifier,
	@WorkFlowID		uniqueidentifier,
	@StateID		uniqueidentifier,
	@PollID			uniqueidentifier,
	@CurrentUserID	uniqueidentifier,
	@Now			datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[WF_WorkFlowStates]
		SET PollID = @PollID,
			LastModifierUserID = @CurrentUserID,
			LastModificationDate = @Now
	WHERE ApplicationID = @ApplicationID AND WorkFlowID = @WorkFlowID AND StateID = @StateID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WF_SetStateDataNeedsType]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WF_SetStateDataNeedsType]
GO

CREATE PROCEDURE [dbo].[WF_SetStateDataNeedsType]
	@ApplicationID			uniqueidentifier,
	@WorkFlowID				uniqueidentifier,
	@StateID				uniqueidentifier,
	@DataNeedsType			varchar(20),
	@RefStateID				uniqueidentifier,
	@LastModifierUserID		uniqueidentifier,
	@LastModificationDate	datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	IF @RefStateID IS NULL BEGIN
		UPDATE [dbo].[WF_WorkFlowStates]
			SET DataNeedsType = @DataNeedsType,
				LastModifierUserID = @LastModifierUserID,
				LastModificationDate = @LastModificationDate
		WHERE ApplicationID = @ApplicationID AND WorkFlowID = @WorkFlowID AND StateID = @StateID
	END
	ELSE BEGIN
		UPDATE [dbo].[WF_WorkFlowStates]
			SET DataNeedsType = @DataNeedsType,
				RefDataNeedsStateID = @RefStateID,
				LastModifierUserID = @LastModifierUserID,
				LastModificationDate = @LastModificationDate
		WHERE ApplicationID = @ApplicationID AND WorkFlowID = @WorkFlowID AND StateID = @StateID
	END
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WF_SetStateDataNeedsDescription]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WF_SetStateDataNeedsDescription]
GO

CREATE PROCEDURE [dbo].[WF_SetStateDataNeedsDescription]
	@ApplicationID			uniqueidentifier,
	@WorkFlowID				uniqueidentifier,
	@StateID				uniqueidentifier,
	@Description			nvarchar(2000),
	@LastModifierUserID		uniqueidentifier,
	@LastModificationDate	datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SET @Description = [dbo].[GFN_VerifyString](@Description)
	
	UPDATE [dbo].[WF_WorkFlowStates]
		SET DataNeedsDescription = @Description,
			LastModifierUserID = @LastModifierUserID,
			LastModificationDate = @LastModificationDate
	WHERE ApplicationID = @ApplicationID AND WorkFlowID = @WorkFlowID AND StateID = @StateID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WF_SetStateDescriptionNeeded]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WF_SetStateDescriptionNeeded]
GO

CREATE PROCEDURE [dbo].[WF_SetStateDescriptionNeeded]
	@ApplicationID			uniqueidentifier,
	@WorkFlowID				uniqueidentifier,
	@StateID				uniqueidentifier,
	@DescriptionNeeded		bit,
	@LastModifierUserID		uniqueidentifier,
	@LastModificationDate	datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[WF_WorkFlowStates]
		SET DescriptionNeeded = @DescriptionNeeded,
			LastModifierUserID = @LastModifierUserID,
			LastModificationDate = @LastModificationDate
	WHERE ApplicationID = @ApplicationID AND WorkFlowID = @WorkFlowID AND StateID = @StateID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WF_SetStateHideOwnerName]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WF_SetStateHideOwnerName]
GO

CREATE PROCEDURE [dbo].[WF_SetStateHideOwnerName]
	@ApplicationID			uniqueidentifier,
	@WorkFlowID				uniqueidentifier,
	@StateID				uniqueidentifier,
	@HideOwnerName			bit,
	@LastModifierUserID		uniqueidentifier,
	@LastModificationDate	datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[WF_WorkFlowStates]
		SET HideOwnerName = @HideOwnerName,
			LastModifierUserID = @LastModifierUserID,
			LastModificationDate = @LastModificationDate
	WHERE ApplicationID = @ApplicationID AND WorkFlowID = @WorkFlowID AND StateID = @StateID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WF_SetStateEditPermission]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WF_SetStateEditPermission]
GO

CREATE PROCEDURE [dbo].[WF_SetStateEditPermission]
	@ApplicationID			uniqueidentifier,
	@WorkFlowID				uniqueidentifier,
	@StateID				uniqueidentifier,
	@EditPermission			bit,
	@LastModifierUserID		uniqueidentifier,
	@LastModificationDate	datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[WF_WorkFlowStates]
		SET EditPermission = @EditPermission,
			LastModifierUserID = @LastModifierUserID,
			LastModificationDate = @LastModificationDate
	WHERE ApplicationID = @ApplicationID AND WorkFlowID = @WorkFlowID AND StateID = @StateID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WF_SetFreeDataNeedRequests]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WF_SetFreeDataNeedRequests]
GO

CREATE PROCEDURE [dbo].[WF_SetFreeDataNeedRequests]
	@ApplicationID			uniqueidentifier,
	@WorkFlowID				uniqueidentifier,
	@StateID				uniqueidentifier,
	@FreeDataNeedRequests	bit,
	@LastModifierUserID		uniqueidentifier,
	@LastModificationDate	datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[WF_WorkFlowStates]
		SET FreeDataNeedRequests = @FreeDataNeedRequests,
			LastModifierUserID = @LastModifierUserID,
			LastModificationDate = @LastModificationDate
	WHERE ApplicationID = @ApplicationID AND WorkFlowID = @WorkFlowID AND StateID = @StateID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WF_SetStateDataNeed]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WF_SetStateDataNeed]
GO

CREATE PROCEDURE [dbo].[WF_SetStateDataNeed]
	@ApplicationID	uniqueidentifier,
	@ID				uniqueidentifier,
	@WorkFlowID		uniqueidentifier,
	@StateID		uniqueidentifier,
	@NodeTypeID		uniqueidentifier,
	@PreNodeTypeID	uniqueidentifier,
	@FormID			uniqueidentifier,
	@Description	nvarchar(2000),
	@MultipleSelect bit,
	@Admin			bit,
	@Necessary		bit,
	@CreatorUserID	uniqueidentifier,
	@CreationDate	datetime
WITH ENCRYPTION
AS
BEGIN TRANSACTION
	SET NOCOUNT ON
	
	SET @Description = [dbo].[GFN_VerifyString](@Description)
	
	IF @PreNodeTypeID IS NOT NULL AND @PreNodeTypeID <> @NodeTypeID BEGIN
		UPDATE [dbo].[WF_StateDataNeeds]
			SET LastModifierUserID = @CreatorUserID,
				LastModificationDate = @CreationDate,
				Deleted = 1
		WHERE ApplicationID = @ApplicationID AND 
			WorkFlowID = @WorkFlowID AND StateID = @StateID AND NodeTypeID = @PreNodeTypeID
	END
	
	IF EXISTS(
		SELECT TOP(1) * 
		FROM [dbo].[WF_StateDataNeeds]
		WHERE ApplicationID = @ApplicationID AND WorkFlowID = @WorkFlowID AND 
			StateID = @StateID AND NodeTypeID = @NodeTypeID
	) BEGIN
		UPDATE [dbo].[WF_StateDataNeeds]
			SET [Description] = @Description,
				MultipleSelect = @MultipleSelect,
				[Admin] = @Admin,
				Necessary = @Necessary,
				LastModifierUserID = @CreatorUserID,
				LastModificationDate = @CreationDate,
				Deleted = 0
		WHERE ApplicationID = @ApplicationID AND WorkFlowID = @WorkFlowID AND 
			StateID = @StateID AND NodeTypeID = @NodeTypeID
	END
	ELSE BEGIN
		INSERT INTO [dbo].[WF_StateDataNeeds](
			ApplicationID,
			ID,
			WorkFlowID,
			StateID,
			NodeTypeID,
			[Description],
			MultipleSelect,
			[Admin],
			Necessary,
			CreatorUserID,
			CreationDate,
			Deleted
		)
		VALUES(
			@ApplicationID,
			@ID,
			@WorkFlowID,
			@StateID,
			@NodeTypeID,
			@Description,
			@MultipleSelect,
			@Admin,
			@Necessary,
			@CreatorUserID,
			@CreationDate,
			0
		)
	END
	
	DECLARE @_Result int = @@ROWCOUNT
	
	IF @_Result <= 0 BEGIN
		SELECT -1
		ROLLBACK TRANSACTION
		RETURN
	END
	
	IF @FormID IS NOT NULL BEGIN
		EXEC [dbo].[FG_P_SetFormOwner] @ApplicationID, @ID, @FormID, 
			@CreatorUserID, @CreationDate, @_Result output
		
		IF @_Result <= 0 BEGIN
			SELECT -1
			ROLLBACK TRANSACTION
			RETURN
		END
	END
	
	SELECT @_Result
COMMIT TRANSACTION

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WF_ArithmeticDeleteStateDataNeed]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WF_ArithmeticDeleteStateDataNeed]
GO

CREATE PROCEDURE [dbo].[WF_ArithmeticDeleteStateDataNeed]
	@ApplicationID			uniqueidentifier,
	@WorkFlowID				uniqueidentifier,
	@StateID				uniqueidentifier,
	@NodeTypeID				uniqueidentifier,
	@LastModifierUserID		uniqueidentifier,
	@LastModificationDate	datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[WF_StateDataNeeds]
		SET Deleted = 1,
			LastModifierUserID = @LastModifierUserID,
			LastModificationDate = @LastModificationDate
	WHERE ApplicationID = @ApplicationID AND 
		WorkFlowID = @WorkFlowID AND StateID = @StateID AND 
		NodeTypeID = @NodeTypeID AND Deleted = 0
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WF_SetRejectionSettings]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WF_SetRejectionSettings]
GO

CREATE PROCEDURE [dbo].[WF_SetRejectionSettings]
	@ApplicationID			uniqueidentifier,
	@WorkFlowID				uniqueidentifier,
	@StateID				uniqueidentifier,
	@MaxAllowedRejections	int,
	@RejectionTitle			nvarchar(255),
	@RejectionRefStateID	uniqueidentifier,
	@LastModifierUserID		uniqueidentifier,
	@LastModificationDate	datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[WF_WorkFlowStates]
		SET MaxAllowedRejections = @MaxAllowedRejections,
			RejectionTitle = @RejectionTitle,
			RejectionRefStateID = @RejectionRefStateID,
			LastModifierUserID = @LastModifierUserID,
			LastModificationDate = @LastModificationDate
	WHERE ApplicationID = @ApplicationID AND 
		WorkFlowID = @WorkFlowID AND StateID = @StateID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WF_SetMaxAllowedRejections]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WF_SetMaxAllowedRejections]
GO

CREATE PROCEDURE [dbo].[WF_SetMaxAllowedRejections]
	@ApplicationID			uniqueidentifier,
	@WorkFlowID				uniqueidentifier,
	@StateID				uniqueidentifier,
	@MaxAllowedRejections	int,
	@LastModifierUserID		uniqueidentifier,
	@LastModificationDate	datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[WF_WorkFlowStates]
		SET MaxAllowedRejections = @MaxAllowedRejections,
			LastModifierUserID = @LastModifierUserID,
			LastModificationDate = @LastModificationDate
	WHERE ApplicationID = @ApplicationID AND 
		WorkFlowID = @WorkFlowID AND StateID = @StateID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WF_GetRejectionsCount]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WF_GetRejectionsCount]
GO

CREATE PROCEDURE [dbo].[WF_GetRejectionsCount]
	@ApplicationID	uniqueidentifier,
	@OwnerID		uniqueidentifier,
	@WorkFlowID		uniqueidentifier,
	@StateID		uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT COUNT(HistoryID)
	FROM [dbo].[WF_History]
	WHERE ApplicationID = @ApplicationID AND OwnerID = @OwnerID AND 
		WorkFlowID = @WorkFlowID AND StateID = @StateID AND Rejected = 1 AND Deleted = 0
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WF_AddStateConnection]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WF_AddStateConnection]
GO

CREATE PROCEDURE [dbo].[WF_AddStateConnection]
	@ApplicationID	uniqueidentifier,
	@WorkFlowID		uniqueidentifier,
	@InStateID		uniqueidentifier,
	@OutStateID		uniqueidentifier,
	@CreatorUserID	uniqueidentifier,
	@CreationDate	datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @SequenceNumber int = (
		SELECT ISNULL(MAX(SequenceNumber), 0) 
		FROM [dbo].[WF_StateConnections]
		WHERE ApplicationID = @ApplicationID AND 
			WorkFlowID = @WorkFlowID AND InStateID = @InStateID
	) + 1
	
	DECLARE @ID uniqueidentifier = (
		SELECT TOP(1) ID
		FROM [dbo].[WF_StateConnections]
		WHERE ApplicationID = @ApplicationID AND WorkFlowID = @WorkFlowID AND 
			InStateID = @InStateID AND OutStateID = @OutStateID AND Deleted = 1
	)
	
	IF @ID IS NOT NULL BEGIN
		UPDATE [dbo].[WF_StateConnections]
			SET Deleted = 0,
				LastModifierUserID = @CreatorUserID,
				LastModificationDate = @CreationDate
		WHERE ApplicationID = @ApplicationID AND ID = @ID
	END
	ELSE BEGIN
		SET @ID = NEWID()
	
		INSERT INTO [dbo].[WF_StateConnections](
			ApplicationID,
			ID,
			WorkFlowID,
			InStateID,
			OutStateID,
			SequenceNumber,
			Label,
			AttachmentRequired,
			NodeRequired,
			CreatorUserID,
			CreationDate,
			Deleted
		)
		VALUES(
			@ApplicationID,
			@ID,
			@WorkFlowID,
			@InStateID,
			@OutStateID,
			@SequenceNumber,
			N'',
			0,
			0,
			@CreatorUserID,
			@CreationDate,
			0
		)
	END
	
	SELECT @ID
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WF_SortStateConnections]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WF_SortStateConnections]
GO

CREATE PROCEDURE [dbo].[WF_SortStateConnections]
	@ApplicationID	uniqueidentifier,
	@strIDs			varchar(max),
	@delimiter		char
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @IDs TABLE (SequenceNo int identity(1, 1) primary key, ID uniqueidentifier)
	
	INSERT INTO @IDs (ID)
	SELECT Ref.Value
	FROM [dbo].[GFN_StrToGuidTable](@strIDs, @delimiter) AS Ref
	
	DECLARE @WorkFlowID uniqueidentifier, @StateID uniqueidentifier
	
	SELECT @WorkFlowID = WorkFlowID, @StateID = InStateID
	FROM [dbo].[WF_StateConnections]
	WHERE ApplicationID = @ApplicationID AND ID = (SELECT TOP (1) Ref.ID FROM @IDs AS Ref)
	
	IF @WorkFlowID IS NULL OR @StateID IS NULL BEGIN
		SELECT -1
		RETURN
	END
	
	INSERT INTO @IDs (ID)
	SELECT SC.ID
	FROM @IDs AS Ref
		RIGHT JOIN [dbo].[WF_StateConnections] AS SC
		ON SC.ID = Ref.ID
	WHERE SC.ApplicationID = @ApplicationID AND 
		SC.WorkFlowID = @WorkFlowID AND SC.InStateID = @StateID AND Ref.ID IS NULL
	ORDER BY SC.SequenceNumber
	
	UPDATE [dbo].[WF_StateConnections]
		SET SequenceNumber = Ref.SequenceNo
	FROM @IDs AS Ref
		INNER JOIN [dbo].[WF_StateConnections] AS SC
		ON SC.ID = Ref.ID
	WHERE SC.ApplicationID = @ApplicationID AND SC.WorkFlowID = @WorkFlowID AND SC.InStateID = @StateID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WF_MoveStateConnection]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WF_MoveStateConnection]
GO

CREATE PROCEDURE [dbo].[WF_MoveStateConnection]
	@ApplicationID	uniqueidentifier,
	@WorkFlowID		uniqueidentifier,
	@InStateID		uniqueidentifier,
	@OutStateID		uniqueidentifier,
	@MoveDown		bit
WITH ENCRYPTION
AS
BEGIN TRANSACTION
	SET NOCOUNT ON
	
	DECLARE @SequenceNo int = (
		SELECT TOP(1) SequenceNumber
		FROM [dbo].[WF_StateConnections]
		WHERE ApplicationID = @ApplicationID AND WorkFlowID = @WorkFlowID AND 
			InStateID = @InStateID AND OutStateID = @OutStateID
	)
		
	DECLARE @OtherOutStateID uniqueidentifier
	DECLARE @OtherSequenceNumber int
	
	IF @MoveDown = 1 BEGIN
		SELECT TOP(1) @OtherOutStateID = OutStateID, @OtherSequenceNumber = SequenceNumber
		FROM [dbo].[WF_StateConnections]
		WHERE ApplicationID = @ApplicationID AND WorkFlowID = @WorkFlowID AND 
			InStateID = @InStateID AND SequenceNumber > @SequenceNo
		ORDER BY SequenceNumber
	END
	ELSE BEGIN
		SELECT TOP(1) @OtherOutStateID = OutStateID, @OtherSequenceNumber = SequenceNumber
		FROM [dbo].[WF_StateConnections]
		WHERE ApplicationID = @ApplicationID AND WorkFlowID = @WorkFlowID AND 
			InStateID = @InStateID AND SequenceNumber < @SequenceNo
		ORDER BY SequenceNumber DESC
	END
	
	IF @OtherOutStateID IS NULL BEGIN
		SELECT -1
		ROLLBACK TRANSACTION
		RETURN
	END
	
	UPDATE [dbo].[WF_StateConnections]
		SET SequenceNumber = @OtherSequenceNumber
	WHERE ApplicationID = @ApplicationID AND WorkFlowID = @WorkFlowID AND 
		InStateID = @InStateID AND OutStateID = @OutStateID
	
	IF @@ROWCOUNT <= 0 BEGIN
		SELECT -1
		ROLLBACK TRANSACTION
		RETURN
	END
	
	UPDATE [dbo].[WF_StateConnections]
		SET SequenceNumber = @SequenceNo
	WHERE ApplicationID = @ApplicationID AND WorkFlowID = @WorkFlowID AND 
		InStateID = @InStateID AND OutStateID = @OtherOutStateID
	
	IF @@ROWCOUNT <= 0 BEGIN
		SELECT -1
		ROLLBACK TRANSACTION
		RETURN
	END
	
	SELECT 1
COMMIT TRANSACTION

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WF_ArithmeticDeleteStateConnection]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WF_ArithmeticDeleteStateConnection]
GO

CREATE PROCEDURE [dbo].[WF_ArithmeticDeleteStateConnection]
	@ApplicationID			uniqueidentifier,
	@WorkFlowID				uniqueidentifier,
	@InStateID				uniqueidentifier,
	@OutStateID				uniqueidentifier,
	@LastModifierUserID		uniqueidentifier,
	@LastModificationDate	datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[WF_StateConnections]
		SET Deleted = 1,
			LastModifierUserID = @LastModifierUserID,
			LastModificationDate = @LastModificationDate
	WHERE ApplicationID = @ApplicationID AND WorkFlowID = @WorkFlowID AND 
		InStateID = @InStateID AND OutStateID = @OutStateID AND Deleted = 0
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WF_SetStateConnectionLabel]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WF_SetStateConnectionLabel]
GO

CREATE PROCEDURE [dbo].[WF_SetStateConnectionLabel]
	@ApplicationID			uniqueidentifier,
	@WorkFlowID				uniqueidentifier,
	@InStateID				uniqueidentifier,
	@OutStateID				uniqueidentifier,
	@Label					nvarchar(255),
	@LastModifierUserID		uniqueidentifier,
	@LastModificationDate	datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SET @Label = [dbo].[GFN_VerifyString](@Label)
	
	UPDATE [dbo].[WF_StateConnections]
		SET Label = @Label,
			LastModifierUserID = @LastModifierUserID,
			LastModificationDate = @LastModificationDate
	WHERE ApplicationID = @ApplicationID AND WorkFlowID = @WorkFlowID AND 
		InStateID = @InStateID AND OutStateID = @OutStateID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WF_SetStateConnectionAttachmentStatus]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WF_SetStateConnectionAttachmentStatus]
GO

CREATE PROCEDURE [dbo].[WF_SetStateConnectionAttachmentStatus]
	@ApplicationID			uniqueidentifier,
	@WorkFlowID				uniqueidentifier,
	@InStateID				uniqueidentifier,
	@OutStateID				uniqueidentifier,
	@AttachmentRequired		bit,
	@AttachmentTitle		nvarchar(255),
	@LastModifierUserID		uniqueidentifier,
	@LastModificationDate	datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SET @AttachmentTitle = [dbo].[GFN_VerifyString](@AttachmentTitle)
	
	IF @AttachmentRequired IS NULL SET @AttachmentRequired = 0
	
	UPDATE [dbo].[WF_StateConnections]
		SET AttachmentRequired = @AttachmentRequired,
			AttachmentTitle = @AttachmentTitle,
			LastModifierUserID = @LastModifierUserID,
			LastModificationDate = @LastModificationDate
	WHERE ApplicationID = @ApplicationID AND WorkFlowID = @WorkFlowID AND 
		InStateID = @InStateID AND OutStateID = @OutStateID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WF_SetStateConnectionDirector]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WF_SetStateConnectionDirector]
GO

CREATE PROCEDURE [dbo].[WF_SetStateConnectionDirector]
	@ApplicationID			uniqueidentifier,
	@WorkFlowID				uniqueidentifier,
	@InStateID				uniqueidentifier,
	@OutStateID				uniqueidentifier,
	@NodeRequired			bit,
	@NodeTypeID				uniqueidentifier,
	@NodeTypeDescription	nvarchar(2000),
	@LastModifierUserID		uniqueidentifier,
	@LastModificationDate	datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	IF @NodeRequired IS NULL SET @NodeRequired = 0
	
	UPDATE [dbo].[WF_StateConnections]
		SET NodeRequired = @NodeRequired,
			NodeTypeID = @NodeTypeID,
			NodeTypeDescription = @NodeTypeDescription,
			LastModifierUserID = @LastModifierUserID,
			LastModificationDate = @LastModificationDate
	WHERE ApplicationID = @ApplicationID AND WorkFlowID = @WorkFlowID AND 
		InStateID = @InStateID AND OutStateID = @OutStateID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WF_SetStateConnectionForm]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WF_SetStateConnectionForm]
GO

CREATE PROCEDURE [dbo].[WF_SetStateConnectionForm]
	@ApplicationID	uniqueidentifier,
	@WorkFlowID		uniqueidentifier,
	@InStateID		uniqueidentifier,
	@OutStateID		uniqueidentifier,
	@FormID			uniqueidentifier,
	@Description	nvarchar(4000),
	@Necessary		bit,
	@CreatorUserID	uniqueidentifier,
	@CreationDate	datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SET @Description = [dbo].[GFN_VerifyString](@Description)
	
	IF @Necessary IS NULL SET @Necessary = 0
	
	IF EXISTS(
		SELECT TOP(1) * 
		FROM [dbo].[WF_StateConnectionForms]
		WHERE ApplicationID = @ApplicationID AND WorkFlowID = @WorkFlowID AND 
			InStateID = @InStateID AND OutStateID = @OutStateID AND FormID = @FormID
	) BEGIN
		UPDATE [dbo].[WF_StateConnectionForms]
			SET [Description] = @Description,
				Necessary = @Necessary,
				LastModifierUserID = @CreatorUserID,
				LastModificationDate = @CreationDate,
				Deleted = 0
		WHERE ApplicationID = @ApplicationID AND WorkFlowID = @WorkFlowID AND 
			InStateID = @InStateID AND OutStateID = @OutStateID AND FormID = @FormID
	END
	ELSE BEGIN
		INSERT INTO [dbo].[WF_StateConnectionForms](
			ApplicationID,
			WorkFlowID,
			InStateID,
			OutStateID,
			FormID,
			[Description],
			Necessary,
			CreatorUserID,
			CreationDate,
			Deleted
		)
		VALUES(
			@ApplicationID,
			@WorkFlowID,
			@InStateID,
			@OutStateID,
			@FormID,
			@Description,
			@Necessary,
			@CreatorUserID,
			@CreationDate,
			0
		)
	END
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WF_ArithmeticDeleteStateConnectionForm]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WF_ArithmeticDeleteStateConnectionForm]
GO

CREATE PROCEDURE [dbo].[WF_ArithmeticDeleteStateConnectionForm]
	@ApplicationID			uniqueidentifier,
	@WorkFlowID				uniqueidentifier,
	@InStateID				uniqueidentifier,
	@OutStateID				uniqueidentifier,
	@FormID					uniqueidentifier,
	@LastModifierUserID		uniqueidentifier,
	@LastModificationDate	datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[WF_StateConnectionForms]
		SET LastModifierUserID = @LastModifierUserID,
			LastModificationDate = @LastModificationDate,
			Deleted = 1
	WHERE ApplicationID = @ApplicationID AND WorkFlowID = @WorkFlowID AND 
		InStateID = @InStateID AND OutStateID = @OutStateID AND FormID = @FormID AND Deleted = 0
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WF_AddAutoMessage]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WF_AddAutoMessage]
GO

CREATE PROCEDURE [dbo].[WF_AddAutoMessage]
	@ApplicationID	uniqueidentifier,
	@AutoMessageID	uniqueidentifier,
	@OwnerID		uniqueidentifier,
	@BodyText		nvarchar(4000),
	@AudienceType	varchar(20),
	@RefStateID		uniqueidentifier,
	@NodeID			uniqueidentifier,
	@Admin			bit,
	@CreatorUserID	uniqueidentifier,
	@CreationDate	datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SET @BodyText = [dbo].[GFN_VerifyString](@BodyText)
	
	IF @Admin IS NULL SET @Admin = 0
	
	INSERT INTO [dbo].[WF_AutoMessages](
		ApplicationID,
		AutoMessageID,
		OwnerID,
		BodyText,
		AudienceType,
		RefStateID,
		NodeID,
		[Admin],
		CreatorUserID,
		CreationDate,
		Deleted
	)
	VALUES(
		@ApplicationID,
		@AutoMessageID,
		@OwnerID,
		@BodyText,
		@AudienceType,
		@RefStateID,
		@NodeID,
		@Admin,
		@CreatorUserID,
		@CreationDate,
		0
	)
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WF_ModifyAutoMessage]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WF_ModifyAutoMessage]
GO

CREATE PROCEDURE [dbo].[WF_ModifyAutoMessage]
	@ApplicationID			uniqueidentifier,
	@AutoMessageID			uniqueidentifier,
	@BodyText				nvarchar(4000),
	@AudienceType			varchar(20),
	@RefStateID				uniqueidentifier,
	@NodeID					uniqueidentifier,
	@Admin					bit,
	@LastModifierUserID		uniqueidentifier,
	@LastModificationDate	datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SET @BodyText = [dbo].[GFN_VerifyString](@BodyText)
	
	IF @Admin IS NULL SET @Admin = 0
	
	UPDATE [dbo].[WF_AutoMessages]
		SET	BodyText = @BodyText,
			AudienceType = @AudienceType,
			RefStateID = @RefStateID,
			NodeID = @NodeID,
			[Admin] = @Admin,
			LastModifierUserID = @LastModifierUserID,
			LastModificationDate = @LastModificationDate
	WHERE ApplicationID = @ApplicationID AND AutoMessageID = @AutoMessageID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WF_ArithmeticDeleteAutoMessage]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WF_ArithmeticDeleteAutoMessage]
GO

CREATE PROCEDURE [dbo].[WF_ArithmeticDeleteAutoMessage]
	@ApplicationID			uniqueidentifier,
	@AutoMessageID			uniqueidentifier,
	@LastModifierUserID		uniqueidentifier,
	@LastModificationDate	datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[WF_AutoMessages]
		SET	Deleted = 1,
			LastModifierUserID = @LastModifierUserID,
			LastModificationDate = @LastModificationDate
	WHERE ApplicationID = @ApplicationID AND AutoMessageID = @AutoMessageID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WF_P_GetOwnerAutoMessages]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WF_P_GetOwnerAutoMessages]
GO

CREATE PROCEDURE [dbo].[WF_P_GetOwnerAutoMessages]
	@ApplicationID	uniqueidentifier,
	@OwnerIDsTemp	GuidTableType readonly
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @OwnerIDs GuidTableType
	INSERT INTO @OwnerIDs SELECT * FROM @OwnerIDsTemp
	
	SELECT AM.AutoMessageID AS AutoMessageID,
		   AM.OwnerID AS OwnerID,
		   AM.BodyText AS BodyText,
		   AM.AudienceType AS AudienceType,
		   AM.RefStateID AS RefStateID,
		   ST.Title AS RefStateTitle,
		   AM.NodeID AS NodeID,
		   ND.NodeName AS NodeName,
		   ND.NodeTypeID AS NodeTypeID,
		   ND.TypeName AS NodeType,
		   AM.[Admin] AS [Admin]
	FROM @OwnerIDs AS Ref
		INNER JOIN [dbo].[WF_AutoMessages] AS AM
		ON AM.OwnerID = Ref.Value
		LEFT JOIN [dbo].[WF_States] AS ST
		ON ST.ApplicationID = @ApplicationID AND ST.StateID = AM.RefStateID
		LEFT JOIN [dbo].[CN_View_Nodes_Normal] AS ND
		ON ND.ApplicationID = @ApplicationID AND ND.NodeID = AM.NodeID
	WHERE AM.ApplicationID = @ApplicationID AND AM.Deleted = 0
	ORDER BY AM.CreationDate ASC
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WF_GetOwnerAutoMessages]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WF_GetOwnerAutoMessages]
GO

CREATE PROCEDURE [dbo].[WF_GetOwnerAutoMessages]
	@ApplicationID	uniqueidentifier,
	@strOwnerIDs	varchar(max),
	@delimiter		char
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @OwnerIDs GuidTableType
	INSERT INTO @OwnerIDs
	SELECT Ref.Value FROM [dbo].[GFN_StrToGuidTable](@strOwnerIDs, @delimiter) AS Ref
	
	EXEC [dbo].[WF_P_GetOwnerAutoMessages] @ApplicationID, @OwnerIDs
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WF_GetWorkFlowAutoMessages]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WF_GetWorkFlowAutoMessages]
GO

CREATE PROCEDURE [dbo].[WF_GetWorkFlowAutoMessages]
	@ApplicationID	uniqueidentifier,
	@WorkFlowID		uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @OwnerIDs GuidTableType
	
	INSERT INTO @OwnerIDs
	SELECT ID
	FROM [dbo].[WF_StateConnections]
	WHERE ApplicationID = @ApplicationID AND WorkFlowID = @WorkFlowID AND Deleted = 0
	
	EXEC [dbo].[WF_P_GetOwnerAutoMessages] @ApplicationID, @OwnerIDs
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WF_GetConnectionAutoMessages]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WF_GetConnectionAutoMessages]
GO

CREATE PROCEDURE [dbo].[WF_GetConnectionAutoMessages]
	@ApplicationID	uniqueidentifier,
	@WorkFlowID		uniqueidentifier,
	@InStateID		uniqueidentifier,
	@OutStateID		uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @OwnerIDs GuidTableType
	
	INSERT INTO @OwnerIDs
	SELECT ID
	FROM [dbo].[WF_StateConnections]
	WHERE ApplicationID = @ApplicationID AND WorkFlowID = @WorkFlowID AND 
		InStateID = @InStateID AND OutStateID = @OutStateID
	
	EXEC [dbo].[WF_P_GetOwnerAutoMessages] @ApplicationID, @OwnerIDs
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WF_P_GetWorkFlowStates]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WF_P_GetWorkFlowStates]
GO

CREATE PROCEDURE [dbo].[WF_P_GetWorkFlowStates]
	@ApplicationID	uniqueidentifier,
	@WorkFlowID		uniqueidentifier,
	@StateIDsTemp	GuidTableType readonly
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @StateIDs GuidTableType
	INSERT INTO @StateIDs SELECT * FROM @StateIDsTemp
	
	SELECT WFS.ID,
		   WFS.StateID,
		   WFS.WorkFlowID,
		   WFS.[Description],
		   TG.Tag,
		   WFS.DataNeedsType,
		   WFS.RefDataNeedsStateID,
		   WFS.DataNeedsDescription,
		   WFS.DescriptionNeeded,
		   WFS.HideOwnerName,
		   WFS.EditPermission,
		   WFS.ResponseType,
		   WFS.RefStateID,
		   WFS.NodeID,
		   ND.NodeName,
		   ND.NodeTypeID,
		   ND.TypeName AS NodeType,
		   WFS.[Admin],
		   WFS.UserID,
		   UN.UserName,
		   UN.FirstName,
		   UN.LastName,
		   WFS.FreeDataNeedRequests,
		   WFS.MaxAllowedRejections,
		   WFS.RejectionTitle,
		   WFS.RejectionRefStateID,
		   RS.Title AS RejectionRefStateTitle,
		   PL.PollID,
		   PL.[Name] AS PollName
	FROM @StateIDs AS ExternalIDs
		INNER JOIN [dbo].[WF_WorkFlowStates] AS WFS
		ON WFS.StateID = ExternalIDs.Value
		LEFT JOIN [dbo].[CN_View_Nodes_Normal] AS ND
		ON ND.ApplicationID = @ApplicationID AND ND.NodeID = WFS.NodeID AND ND.Deleted = 0
		LEFT JOIN [dbo].[CN_Tags] AS TG
		ON TG.ApplicationID = @ApplicationID AND TG.TagID = WFS.TagID
		LEFT JOIN [dbo].[WF_States] AS RS
		ON RS.ApplicationID = @ApplicationID AND RS.StateID = WFS.RejectionRefStateID
		LEFT JOIN [dbo].[FG_Polls] AS PL
		ON PL.ApplicationID = @ApplicationID AND PL.PollID = WFS.PollID
		LEFT JOIN [dbo].[Users_Normal] AS UN
		ON UN.ApplicationID = @ApplicationID AND UN.UserID = WFS.UserID
	WHERE WFS.ApplicationID = @ApplicationID AND WFS.WorkFlowID = @WorkFlowID
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WF_GetWorkFlowStates]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WF_GetWorkFlowStates]
GO

CREATE PROCEDURE [dbo].[WF_GetWorkFlowStates]
	@ApplicationID	uniqueidentifier,
	@WorkFlowID		uniqueidentifier,
	@strStateIDs	varchar(max),
	@delimiter		char
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @All bit = NULL, @StateIDs GuidTableType
	
	IF @strStateIDs IS NULL BEGIN
		INSERT INTO @StateIDs
		SELECT StateID
		FROM [dbo].[WF_WorkFlowStates]
		WHERE ApplicationID = @ApplicationID AND WorkFlowID = @WorkFlowID AND Deleted = 0
	END
	ELSE BEGIN
		INSERT INTO @StateIDs
		SELECT DISTINCT Ref.Value 
		FROM [dbo].[GFN_StrToGuidTable](@strStateIDs, @delimiter) AS Ref
	END
	
	EXEC [dbo].[WF_P_GetWorkFlowStates] @ApplicationID, @WorkFlowID, @StateIDs
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WF_GetFirstWorkFlowState]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WF_GetFirstWorkFlowState]
GO

CREATE PROCEDURE [dbo].[WF_GetFirstWorkFlowState]
	@ApplicationID	uniqueidentifier,
	@WorkFlowID		uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @StateIDs GuidTableType
	
	INSERT INTO @StateIDs
	SELECT WFS.StateID
	FROM [dbo].[WF_WorkFlowStates] AS WFS
	WHERE WFS.ApplicationID = @ApplicationID AND WFS.WorkFlowID = @WorkFlowID AND WFS.Deleted = 0 AND
		NOT EXISTS(
			SELECT TOP(1) * 
			FROM [dbo].[WF_StateConnections] AS SC
				INNER JOIN [dbo].[WF_WorkFlowStates] AS Ref
				ON Ref.ApplicationID = @ApplicationID AND Ref.StateID = SC.InStateID
			WHERE SC.ApplicationID = @ApplicationID AND SC.WorkFlowID = @WorkFlowID AND 
				SC.OutStateID = WFS.StateID AND SC.Deleted = 0 AND Ref.Deleted = 0
		)
		
	IF (SELECT COUNT(*) FROM @StateIDs) = 1
		EXEC [dbo].[WF_P_GetWorkFlowStates] @ApplicationID, @WorkFlowID, @StateIDs
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WF_P_GetStateDataNeedsByIDs]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WF_P_GetStateDataNeedsByIDs]
GO

CREATE PROCEDURE [dbo].[WF_P_GetStateDataNeedsByIDs]
	@ApplicationID	uniqueidentifier,
	@IDsTemp		GuidTripleTableType readonly --First:WorkFlowID, Second:StateID, Third:NodeTypeID
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @IDs GuidTripleTableType
	INSERT INTO @IDs SELECT * FROM @IDsTemp
	
	SELECT SDN.ID AS ID,
		   SDN.StateID AS StateID,
		   SDN.WorkFlowID AS WorkFlowID,
		   SDN.NodeTypeID AS NodeTypeID,
		   EF.FormID AS FormID,
		   EF.Title AS FormTitle,
		   SDN.[Description] AS [Description],
		   NT.Name AS NodeType,
		   SDN.MultipleSelect AS MultiSelect,
		   SDN.[Admin] AS [Admin],
		   SDN.Necessary AS Necessary
	FROM @IDs AS ExternalIDs
		INNER JOIN [dbo].[WF_StateDataNeeds] AS SDN
		ON SDN.ApplicationID = @ApplicationID AND 
			ExternalIDs.FirstValue = SDN.WorkFlowID AND
			ExternalIDs.SecondValue = SDN.StateID AND 
			ExternalIDs.ThirdValue = SDN.NodeTypeID
		LEFT JOIN [dbo].[CN_NodeTypes] AS NT
		ON NT.ApplicationID = @ApplicationID AND NT.NodeTypeID = SDN.NodeTypeID
		LEFT JOIN [dbo].[FG_FormOwners] AS FO
		INNER JOIN [dbo].[FG_ExtendedForms] EF
		ON EF.ApplicationID = @ApplicationID AND EF.FormID = FO.FormID
		ON FO.ApplicationID = @ApplicationID AND FO.OwnerID = SDN.ID AND FO.Deleted = 0
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WF_P_GetStateDataNeeds]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WF_P_GetStateDataNeeds]
GO

CREATE PROCEDURE [dbo].[WF_P_GetStateDataNeeds]
	@ApplicationID	uniqueidentifier,
	@WorkFlowID		uniqueidentifier,
	@StateIDsTemp	GuidTableType readonly
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @StateIDs GuidTableType
	INSERT INTO @StateIDs SELECT * FROM @StateIDsTemp
	
	DECLARE @IDs GuidTripleTableType
	
	INSERT INTO @IDs
	SELECT @WorkFlowID, SDN.StateID, SDN.NodeTypeID
	FROM @StateIDs AS ExternalIDs
		INNER JOIN [dbo].[WF_StateDataNeeds] AS SDN
		ON SDN.StateID = ExternalIDs.Value
	WHERE SDN.ApplicationID = @ApplicationID AND 
		SDN.WorkFlowID = @WorkFlowID AND SDN.Deleted = 0
	
	EXEC [dbo].[WF_P_GetStateDataNeedsByIDs] @ApplicationID, @IDs
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WF_GetStateDataNeeds]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WF_GetStateDataNeeds]
GO

CREATE PROCEDURE [dbo].[WF_GetStateDataNeeds]
	@ApplicationID	uniqueidentifier,
	@WorkFlowID		uniqueidentifier,
	@strStateIDs	varchar(max),
	@delimiter		char
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @All bit = NULL, @StateIDs GuidTableType
	
	IF @strStateIDs IS NULL 
		INSERT INTO @StateIDs
		SELECT StateID
		FROM [dbo].[WF_WorkFlowStates]
		WHERE ApplicationID = @ApplicationID AND WorkFlowID = @WorkFlowID AND Deleted = 0
	ELSE BEGIN
		INSERT INTO @StateIDs
		SELECT DISTINCT Ref.Value 
		FROM [dbo].[GFN_StrToGuidTable](@strStateIDs, @delimiter) AS Ref
	END
	
	EXEC [dbo].[WF_P_GetStateDataNeeds] @ApplicationID, @WorkFlowID, @StateIDs
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WF_GetStateDataNeed]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WF_GetStateDataNeed]
GO

CREATE PROCEDURE [dbo].[WF_GetStateDataNeed]
	@ApplicationID	uniqueidentifier,
	@WorkFlowID		uniqueidentifier,
	@StateID		uniqueidentifier,
	@NodeTypeID		uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @IDs GuidTripleTableType
	INSERT INTO @IDs(FirstValue, SecondValue, ThirdValue)
	VALUES(@WorkFlowID, @StateID, @NodeTypeID)
	
	EXEC [dbo].[WF_P_GetStateDataNeedsByIDs] @ApplicationID, @IDs
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WF_GetCurrentStateDataNeeds]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WF_GetCurrentStateDataNeeds]
GO

CREATE PROCEDURE [dbo].[WF_GetCurrentStateDataNeeds]
	@ApplicationID	uniqueidentifier,
	@WorkFlowID		uniqueidentifier,
	@StateID		uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @StateIDs GuidTableType, @DataNeedsType varchar(20), 
		@RefDataNeedsStateID uniqueidentifier
	
	SELECT @DataNeedsType = DataNeedsType, @RefDataNeedsStateID = RefDataNeedsStateID
	FROM [dbo].[WF_WorkFlowStates]
	WHERE ApplicationID = @ApplicationID AND WorkFlowID = @WorkFlowID AND StateID = @StateID
	
	IF @DataNeedsType = 'RefState'
		INSERT INTO @StateIDs(Value) VALUES(@RefDataNeedsStateID)
	ELSE
		INSERT INTO @StateIDs(Value) VALUES(@StateID)
	
	EXEC [dbo].[WF_P_GetStateDataNeeds] @ApplicationID, @WorkFlowID, @StateIDs
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WF_CreateStateDataNeedInstance]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WF_CreateStateDataNeedInstance]
GO

CREATE PROCEDURE [dbo].[WF_CreateStateDataNeedInstance]
	@ApplicationID	uniqueidentifier,
	@InstanceID		uniqueidentifier,
	@HistoryID		uniqueidentifier,
	@NodeID			uniqueidentifier,
	@Admin			bit,
	@FormID			uniqueidentifier,
	@CreatorUserID	uniqueidentifier,
	@CreationDate	datetime
WITH ENCRYPTION
AS
BEGIN TRANSACTION
	SET NOCOUNT ON
	
	INSERT INTO [dbo].[WF_StateDataNeedInstances](
		ApplicationID,
		InstanceID,
		HistoryID,
		NodeID,
		[Admin],
		Filled,
		AttachmentID,
		CreatorUserID,
		CreationDate,
		Deleted
	)
	VALUES(
		@ApplicationID,
		@InstanceID,
		@HistoryID,
		@NodeID,
		@Admin,
		0,
		NEWID(),
		@CreatorUserID,
		@CreationDate,
		0
	)
	
	IF @@ROWCOUNT <= 0 BEGIN
		SELECT 0
		ROLLBACK TRANSACTION
		RETURN
	END
	
	IF @FormID IS NOT NULL BEGIN
		DECLARE @FormInstanceID uniqueidentifier = NEWID(), @_Result int
		
		DECLARE @FormInstances FormInstanceTableType
			
		INSERT INTO @FormInstances (InstanceID, FormID, OwnerID, DirectorID, [Admin])
		VALUES (@FormInstanceID, @FormID, @InstanceID, @NodeID, @Admin)
		
		EXEC [dbo].[FG_P_CreateFormInstance] @ApplicationID, @FormInstances, @CreatorUserID, @CreationDate, @_Result output
			
		IF @_Result <= 0 BEGIN
			SELECT 0
			ROLLBACK TRANSACTION
			RETURN
		END
	END
	
	-- Send Dashboards
	EXEC [dbo].[WF_P_SendDashboards] @ApplicationID, @HistoryID, NULL, NULL, NULL, 
		NULL, NULL, @InstanceID, @CreationDate, @_Result output
	
	IF @_Result <= 0 BEGIN
		SELECT -1, N'CannotDetermineDirector'
		ROLLBACK TRANSACTION 
		RETURN
	END
	-- end of Send Dashboards
	
	SELECT 1
COMMIT TRANSACTION

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WF_SetStateDataNeedInstanceAsFilled]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WF_SetStateDataNeedInstanceAsFilled]
GO

CREATE PROCEDURE [dbo].[WF_SetStateDataNeedInstanceAsFilled]
	@ApplicationID			uniqueidentifier,
	@InstanceID				uniqueidentifier,
	@LastModifierUserID		uniqueidentifier,
	@LastModificationDate	datetime
WITH ENCRYPTION
AS
BEGIN TRANSACTION
	SET NOCOUNT ON
	
	UPDATE [dbo].[WF_StateDataNeedInstances]
		SET Filled = 1,
			FillingDate = @LastModificationDate,
			LastModifierUserID = @LastModifierUserID,
			LastModificationDate = @LastModificationDate
	WHERE ApplicationID = @ApplicationID AND InstanceID = @InstanceID AND Filled = 0
	
	IF @@ROWCOUNT <= 0 BEGIN
		SELECT -1
		ROLLBACK TRANSACTION
		RETURN
	END
	
	DECLARE @FormInstanceID uniqueidentifier = (
		SELECT TOP(1) FI.InstanceID
		FROM [dbo].[WF_StateDataNeedInstances] AS DN
			INNER JOIN [dbo].[FG_FormInstances] AS FI
			ON FI.ApplicationID = @ApplicationID AND FI.OwnerID = DN.InstanceID
		WHERE DN.ApplicationID = @ApplicationID AND 
			DN.InstanceID = @InstanceID AND FI.Filled = 0 AND FI.Deleted = 0
	)
	
	DECLARE @_Result int = 0
	
	IF @FormInstanceID IS NOT NULL BEGIN	
		EXEC [dbo].[FG_P_SetFormInstanceAsFilled] @ApplicationID, @FormInstanceID, 
			@LastModificationDate, @LastModifierUserID, @_Result output
		
		IF @_Result <= 0 BEGIN
			SELECT -1
			ROLLBACK TRANSACTION
			RETURN
		END
	END
	
	EXEC [dbo].[NTFN_P_SetDashboardsAsDone] @ApplicationID, NULL, NULL, @InstanceID, 
		N'WorkFlow', NULL, @LastModificationDate, @_Result output
	
	IF @_Result <= 0 BEGIN
		SELECT -1
		ROLLBACK TRANSACTION
		RETURN
	END
	
	SELECT 1
COMMIT TRANSACTION

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WF_SetStateDataNeedInstanceAsNotFilled]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WF_SetStateDataNeedInstanceAsNotFilled]
GO

CREATE PROCEDURE [dbo].[WF_SetStateDataNeedInstanceAsNotFilled]
	@ApplicationID			uniqueidentifier,
	@InstanceID				uniqueidentifier,
	@LastModifierUserID		uniqueidentifier,
	@LastModificationDate	datetime
WITH ENCRYPTION
AS
BEGIN TRANSACTION
	SET NOCOUNT ON
	
	UPDATE [dbo].[WF_StateDataNeedInstances]
		SET Filled = 0,
			LastModifierUserID = @LastModifierUserID,
			LastModificationDate = @LastModificationDate
	WHERE ApplicationID = @ApplicationID AND InstanceID = @InstanceID AND Filled = 1
	
	IF @@ROWCOUNT <= 0 BEGIN
		SELECT -1
		ROLLBACK TRANSACTION
		RETURN
	END
	
	DECLARE @FormInstanceID uniqueidentifier = (
		SELECT TOP(1) FI.InstanceID
		FROM [dbo].[WF_StateDataNeedInstances] AS DN
			INNER JOIN [dbo].[FG_FormInstances] AS FI
			ON FI.ApplicationID = @ApplicationID AND FI.OwnerID = DN.InstanceID
		WHERE DN.ApplicationID = @ApplicationID AND
			DN.InstanceID = @InstanceID AND FI.Filled = 1 AND FI.Deleted = 0
	)
		
	DECLARE @_Result int
		
	IF @FormInstanceID IS NOT NULL BEGIN
		EXEC [dbo].[FG_P_SetFormInstanceAsNotFilled] @ApplicationID, 
			@FormInstanceID, @LastModifierUserID, @_Result output
		
		IF @_Result <= 0 BEGIN
			SELECT -1
			ROLLBACK TRANSACTION
			RETURN
		END
	END
	
	EXEC [dbo].[WF_P_SendDashboards] @ApplicationID, NULL, NULL, NULL, NULL, NULL, NULL, 
		@InstanceID, @LastModificationDate, @_Result output
	
	IF @_Result <= 0 BEGIN
		SELECT -1, N'CannotDetermineDirector'
		ROLLBACK TRANSACTION
		RETURN
	END
	
	SELECT 1
COMMIT TRANSACTION

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WF_ArithmeticDeleteStateDataNeedInstance]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WF_ArithmeticDeleteStateDataNeedInstance]
GO

CREATE PROCEDURE [dbo].[WF_ArithmeticDeleteStateDataNeedInstance]
	@ApplicationID			uniqueidentifier,
	@InstanceID				uniqueidentifier,
	@LastModifierUserID		uniqueidentifier,
	@LastModificationDate	datetime
WITH ENCRYPTION
AS
BEGIN TRANSACTION
	SET NOCOUNT ON
	
	UPDATE [dbo].[WF_StateDataNeedInstances]
		SET Deleted = 1,
			LastModifierUserID = @LastModifierUserID,
			LastModificationDate = @LastModificationDate
	WHERE ApplicationID = @ApplicationID AND InstanceID = @InstanceID AND Deleted = 0
	
	IF @@ROWCOUNT <= 0 BEGIN
		SELECT -1
		ROLLBACK TRANSACTION
		RETURN
	END
	
	DECLARE @_Result int = 0
	
	EXEC [dbo].[NTFN_P_ArithmeticDeleteDashboards] @ApplicationID, 
		NULL, NULL, @InstanceID, N'WorkFlow', NULL, @_Result output
	
	IF @_Result <= 0 BEGIN
		SELECT -1
		ROLLBACK TRANSACTION
		RETURN
	END
	
	SELECT 1
COMMIT TRANSACTION

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WF_P_GetStateDataNeedInstances]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WF_P_GetStateDataNeedInstances]
GO

CREATE PROCEDURE [dbo].[WF_P_GetStateDataNeedInstances]
	@ApplicationID		uniqueidentifier,
	@InstanceIDsTemp	GuidTableType readonly
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @InstanceIDs GuidTableType
	INSERT INTO @InstanceIDs SELECT * FROM @InstanceIDsTemp
	
	SELECT SDNI.InstanceID AS InstanceID,
		   SDNI.HistoryID AS HistoryID,
		   SDNI.NodeID AS NodeID,
		   ND.NodeName AS NodeName,
		   ND.NodeTypeID AS NodeTypeID,
		   SDNI.Filled AS Filled,
		   SDNI.FillingDate AS FillingDate,
		   SDNI.AttachmentID AS AttachmentID
	FROM @InstanceIDs AS ExternalIDs
		INNER JOIN [dbo].[WF_StateDataNeedInstances] AS SDNI
		ON SDNI.InstanceID = ExternalIDs.Value
		LEFT JOIN [dbo].[CN_View_Nodes_Normal] AS ND
		ON ND.ApplicationID = @ApplicationID AND ND.NodeID = SDNI.NodeID
	WHERE SDNI.ApplicationID = @ApplicationID AND SDNI.Deleted = 0
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WF_GetStateDataNeedInstance]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WF_GetStateDataNeedInstance]
GO

CREATE PROCEDURE [dbo].[WF_GetStateDataNeedInstance]
	@ApplicationID	uniqueidentifier,
	@InstanceID		uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @InstanceIDs GuidTableType
	
	INSERT INTO @InstanceIDs(Value)
	VALUES(@InstanceID)
	
	EXEC [dbo].[WF_P_GetStateDataNeedInstances] @ApplicationID, @InstanceIDs
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WF_GetStateDataNeedInstances]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WF_GetStateDataNeedInstances]
GO

CREATE PROCEDURE [dbo].[WF_GetStateDataNeedInstances]
	@ApplicationID	uniqueidentifier,
	@strHistoryIDs	varchar(max),
	@delimiter		char
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @HistoryIDs GuidTableType, @InstanceIDs GuidTableType
	
	INSERT INTO @HistoryIDs
	SELECT DISTINCT Ref.Value FROM [dbo].[GFN_StrToGuidTable](@strHistoryIDs, @delimiter) AS Ref
	
	INSERT INTO @InstanceIDs
	SELECT SDNI.InstanceID
	FROM @HistoryIDs AS ExternalIDs
		INNER JOIN [dbo].[WF_StateDataNeedInstances] AS SDNI
		ON SDNI.HistoryID = ExternalIDs.Value
	WHERE SDNI.ApplicationID = @ApplicationID AND SDNI.Deleted = 0
	
	EXEC [dbo].[WF_P_GetStateDataNeedInstances] @ApplicationID, @InstanceIDs
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WF_P_GetWorkFlowConnections]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WF_P_GetWorkFlowConnections]
GO

CREATE PROCEDURE [dbo].[WF_P_GetWorkFlowConnections]
	@ApplicationID	uniqueidentifier,
	@WorkFlowID		uniqueidentifier,
	@InStateIDsTemp	GuidTableType readonly
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @InStateIDs GuidTableType
	INSERT INTO @InStateIDs SELECT * FROM @InStateIDsTemp
	
	SELECT SC.ID AS ID,
		   SC.WorkFlowID AS WorkFlowID,
		   SC.InStateID AS InStateID,
		   SC.OutStateID AS OutStateID,
		   SC.SequenceNumber AS SequenceNumber,
		   SC.Label AS ConnectionLabel,
		   SC.AttachmentRequired AS AttachmentRequired,
		   SC.AttachmentTitle AS AttachmentTitle,
		   SC.NodeRequired AS NodeRequired,
		   SC.NodeTypeID AS NodeTypeID,
		   NT.Name AS NodeType,
		   SC.NodeTypeDescription AS NodeTypeDescription
	FROM @InStateIDs AS ExternalIDs
		INNER JOIN [dbo].[WF_StateConnections] AS SC
		ON SC.ApplicationID = @ApplicationID AND SC.WorkFlowID = @WorkFlowID AND
			SC.InStateID = ExternalIDs.Value AND SC.Deleted  = 0
		INNER JOIN [dbo].[WF_States] AS S
		ON S.ApplicationID = @ApplicationID AND S.StateID = SC.OutStateID AND S.Deleted  = 0
		LEFT JOIN [dbo].[CN_NodeTypes] AS NT
		ON NT.ApplicationID = @ApplicationID AND NT.NodeTypeID = SC.NodeTypeID
	ORDER BY ISNULL(SC.SequenceNumber, 1000000) ASC, SC.CreationDate ASC
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WF_GetWorkFlowConnections]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WF_GetWorkFlowConnections]
GO

CREATE PROCEDURE [dbo].[WF_GetWorkFlowConnections]
	@ApplicationID	uniqueidentifier,
	@WorkFlowID		uniqueidentifier,
	@strInStateIDs	varchar(max),
	@delimiter		char
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @All bit = NULL, @InStateIDs GuidTableType
	
	IF @strInStateIDs IS NULL
		INSERT INTO @InStateIDs
		SELECT StateID
		FROM [dbo].[WF_WorkFlowStates]
		WHERE ApplicationID = @ApplicationID AND WorkFlowID = @WorkFlowID AND Deleted = 0
	ELSE BEGIN
		INSERT INTO @InStateIDs
		SELECT DISTINCT Ref.Value 
		FROM [dbo].[GFN_StrToGuidTable](@strInStateIDs, @delimiter) AS Ref
	END
	
	EXEC [dbo].[WF_P_GetWorkFlowConnections] @ApplicationID, @WorkFlowID, @InStateIDs
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WF_P_GetWorkFlowConnectionForms]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WF_P_GetWorkFlowConnectionForms]
GO

CREATE PROCEDURE [dbo].[WF_P_GetWorkFlowConnectionForms]
	@ApplicationID	uniqueidentifier,
	@WorkFlowID		uniqueidentifier,
	@InStateIDsTemp	GuidTableType readonly
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @InStateIDs GuidTableType
	INSERT INTO @InStateIDs SELECT * FROM @InStateIDsTemp
	
	SELECT SCF.WorkFlowID AS WorkFlowID,
		   SCF.InStateID AS InStateID,
		   SCF.OutStateID AS OutStateID,
		   SCF.FormID AS FormID,
		   EF.Title AS FormTitle,
		   SCF.[Description] AS [Description],
		   SCF.Necessary AS Necessary
	FROM @InStateIDs AS ExternalIDs
		INNER JOIN [dbo].[WF_StateConnectionForms] AS SCF
		ON SCF.InStateID = ExternalIDs.Value
		LEFT JOIN [dbo].[FG_ExtendedForms] AS EF
		ON EF.ApplicationID = @ApplicationID AND EF.FormID = SCF.FormID
	WHERE SCF.ApplicationID = @ApplicationID AND WorkFlowID = @WorkFlowID AND SCF.Deleted = 0
END

GO

	
IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WF_GetWorkFlowConnectionForms]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WF_GetWorkFlowConnectionForms]
GO

CREATE PROCEDURE [dbo].[WF_GetWorkFlowConnectionForms]
	@ApplicationID	uniqueidentifier,
	@WorkFlowID		uniqueidentifier,
	@strInStateIDs	varchar(max),
	@delimiter		char
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @InStateIDs GuidTableType
	
	IF @strInStateIDs IS NULL BEGIN
		INSERT INTO @InStateIDs
		SELECT StateID
		FROM [dbo].[WF_WorkFlowStates]
		WHERE ApplicationID = @ApplicationID AND WorkFlowID = @WorkFlowID AND Deleted = 0
	END
	ELSE BEGIN
		INSERT INTO @InStateIDs
		SELECT DISTINCT Ref.Value
		FROM [dbo].[GFN_StrToGuidTable](@strInStateIDs, @delimiter) AS Ref
	END
	
	EXEC [dbo].[WF_P_GetWorkFlowConnectionForms] @ApplicationID, @WorkFlowID, @InStateIDs
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WF_P_GetHistoryByIDs]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WF_P_GetHistoryByIDs]
GO

CREATE PROCEDURE [dbo].[WF_P_GetHistoryByIDs]
	@ApplicationID	uniqueidentifier,
	@HistoryIDsTemp	GuidTableType readonly
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @HistoryIDs GuidTableType
	INSERT INTO @HistoryIDs SELECT * FROM @HistoryIDsTemp
	
	SELECT H.HistoryID AS HistoryID,
		   H.PreviousHistoryID AS PreviousHistoryID,
		   H.OwnerID AS OwnerID,
		   H.WorkFlowID AS WorkFlowID,
		   H.DirectorNodeID,
		   H.DirectorUserID,
		   N.NodeName AS DirectorNodeName,
		   N.TypeName AS DirectorNodeType,
		   H.StateID AS StateID,
		   S.Title AS StateTitle,
		   H.SelectedOutStateID AS SelectedOutStateID,
		   H.[Description] AS [Description],
		   H.ActorUserID AS SenderUserID,
		   U.UserName AS SenderUserName,
		   U.FirstName AS SenderFirstName,
		   U.LastName AS SenderLastName,
		   H.SendDate AS SendDate,
		   (
				SELECT TOP(1) PollID
				FROM [dbo].[FG_Polls] AS P
				WHERE P.ApplicationID = @ApplicationID AND 
					P.OwnerID = H.HistoryID AND P.Deleted = 0
				ORDER BY P.CreationDate DESC
		   ) AS PollID,
		   (
				SELECT TOP(1) Ref.Name
				FROM [dbo].[FG_Polls] AS P
					INNER JOIN [dbo].[FG_Polls] AS Ref
					ON Ref.ApplicationID = @ApplicationID AND Ref.PollID = P.IsCopyOfPollID
				WHERE P.ApplicationID = @ApplicationID AND 
					P.OwnerID = H.HistoryID AND P.Deleted = 0
				ORDER BY P.CreationDate DESC
		   ) AS PollName
	FROM @HistoryIDs AS ExternalIDs
		INNER JOIN [dbo].[WF_History] AS H
		ON H.ApplicationID = @ApplicationID AND H.HistoryID = ExternalIDs.Value
		INNER JOIN [dbo].[WF_States] AS S
		ON S.ApplicationID = @ApplicationID AND S.StateID = H.StateID
		LEFT JOIN [dbo].[CN_View_Nodes_Normal] AS N
		ON N.ApplicationID = @ApplicationID AND N.NodeID = H.DirectorNodeID
		LEFT JOIN [dbo].[Users_Normal] AS U
		ON U.ApplicationID = @ApplicationID AND U.UserID = H.ActorUserID
	ORDER BY H.ID DESC
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WF_GetHistoryByIDs]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WF_GetHistoryByIDs]
GO

CREATE PROCEDURE [dbo].[WF_GetHistoryByIDs]
	@ApplicationID	uniqueidentifier,
	@strHistoryIDs	varchar(max),
	@delimiter		char
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @HistoryIDs GuidTableType
	INSERT INTO @HistoryIDs 
	SELECT DISTINCT Ref.Value FROM [dbo].[GFN_StrToGuidTable](@strHistoryIDs, @delimiter) AS Ref
	
	EXEC [dbo].[WF_P_GetHistoryByIDs] @ApplicationID, @HistoryIDs
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WF_GetHistory]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WF_GetHistory]
GO

CREATE PROCEDURE [dbo].[WF_GetHistory]
	@ApplicationID	uniqueidentifier,
	@OwnerID		uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @HistoryIDs GuidTableType
	
	INSERT INTO @HistoryIDs	
	SELECT HistoryID
	FROM [dbo].[WF_History]
	WHERE ApplicationID = @ApplicationID AND OwnerID = @OwnerID AND Deleted = 0
	
	EXEC [dbo].[WF_P_GetHistoryByIDs] @ApplicationID, @HistoryIDs
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WF_GetLastHistory]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WF_GetLastHistory]
GO

CREATE PROCEDURE [dbo].[WF_GetLastHistory]
	@ApplicationID	uniqueidentifier,
	@OwnerID		uniqueidentifier,
	@StateID		uniqueidentifier,
	@Done			bit
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @HistoryIDs GuidTableType
	
	INSERT INTO @HistoryIDs	
	SELECT TOP(1) HistoryID
	FROM [dbo].[WF_History]
	WHERE ApplicationID = @ApplicationID AND OwnerID = @OwnerID AND 
		(@StateID IS NULL OR StateID = @StateID) AND Deleted = 0 AND
		(ISNULL(@Done, 0) = 0 OR ActorUserID IS NOT NULL)
	ORDER BY ID DESC
	
	EXEC [dbo].[WF_P_GetHistoryByIDs] @ApplicationID, @HistoryIDs
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WF_GetLastSelectedStateID]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WF_GetLastSelectedStateID]
GO

CREATE PROCEDURE [dbo].[WF_GetLastSelectedStateID]
	@ApplicationID	uniqueidentifier,
	@OwnerID		uniqueidentifier,
	@InStateID		uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	IF @InStateID IS NULL BEGIN
		SELECT TOP(1) StateID AS ID
		FROM [dbo].[WF_History]
		WHERE ApplicationID = @ApplicationID AND OwnerID = @OwnerID AND Deleted = 0
		ORDER BY ID DESC
	END
	ELSE BEGIN
		DECLARE @SendDate datetime
		
		SET @SendDate = (
			SELECT TOP(1) SendDate 
			FROM [dbo].[WF_History]
			WHERE ApplicationID = @ApplicationID AND OwnerID = @OwnerID AND 
				StateID = @InStateID AND Deleted = 0
			ORDER BY ID DESC
		)
		
		IF @SendDate IS NOT NULL BEGIN
			SELECT TOP(1) StateID AS ID
			FROM [dbo].[WF_History]
			WHERE ApplicationID = @ApplicationID AND OwnerID = @OwnerID AND 
				SendDate > @SendDate AND Deleted = 0
			ORDER BY ID DESC
		END
	END
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WF_GetHistoryOwnerID]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WF_GetHistoryOwnerID]
GO

CREATE PROCEDURE [dbo].[WF_GetHistoryOwnerID]
	@ApplicationID	uniqueidentifier,
	@HistoryID		uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT OwnerID AS ID
	FROM [dbo].[WF_History]
	WHERE ApplicationID = @ApplicationID AND HistoryID = @HistoryID 
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WF_CreateHistoryFormInstance]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WF_CreateHistoryFormInstance]
GO

CREATE PROCEDURE [dbo].[WF_CreateHistoryFormInstance]	
	@ApplicationID	uniqueidentifier,
	@HistoryID		uniqueidentifier,
	@OutStateID		uniqueidentifier,
	@FormID			uniqueidentifier,
	@CreatorUserID	uniqueidentifier,
	@CreationDate	datetime
WITH ENCRYPTION
AS
BEGIN TRANSACTION
	SET NOCOUNT ON
	
	DECLARE @FormOwnerID uniqueidentifier = NULL, @FormDirectorID uniqueidentifier,
		@FormInstanceID uniqueidentifier = NEWID(), @Admin bit,
		@WorkFlowID uniqueidentifier, @StateID uniqueidentifier
	
	SELECT @FormDirectorID = ISNULL(DirectorNodeID, DirectorUserID), 
		@WorkFlowID = WorkFlowID, @StateID = StateID
	FROM [dbo].[WF_History] 
	WHERE ApplicationID = @ApplicationID AND HistoryID = @HistoryID
	
	SET @Admin = (
		SELECT TOP(1) [Admin] 
		FROM [dbo].[WF_WorkFlowStates]
		WHERE ApplicationID = @ApplicationID AND 
			WorkFlowID = @WorkFlowID AND StateID = @StateID
	)
	
	IF EXISTS(
		SELECT TOP(1) * 
		FROM [dbo].[WF_HistoryFormInstances]
		WHERE ApplicationID = @ApplicationID AND 
			HistoryID = @HistoryID AND OutStateID = @OutStateID
	) BEGIN
		UPDATE [dbo].[WF_HistoryFormInstances]
			SET Deleted = 0,
				LastModifierUserID = @CreatorUserID,
				LastModificationDate = @CreationDate
		WHERE ApplicationID = @ApplicationID AND 
			HistoryID = @HistoryID AND OutStateID = @OutStateID
	END
	ELSE BEGIN
		SET @FormOwnerID = NEWID()
		
		INSERT INTO [dbo].[WF_HistoryFormInstances](
			ApplicationID,
			HistoryID,
			OutStateID,
			FormsID,
			CreatorUserID,
			CreationDate,
			Deleted
		)
		VALUES(
			@ApplicationID,
			@HistoryID,
			@OutStateID,
			@FormOwnerID,
			@CreatorUserID,
			@CreationDate,
			0
		)
	END
	
	IF @@ROWCOUNT <= 0 BEGIN
		SELECT NULL AS ID
		ROLLBACK TRANSACTION
		RETURN
	END
	
	IF @FormOwnerID IS NULL BEGIN
		SET @FormOwnerID = (
			SELECT FormsID 
			FROM [dbo].[WF_HistoryFormInstances]
			WHERE ApplicationID = @ApplicationID AND 
				HistoryID = @HistoryID AND OutStateID = @OutStateID
		)
	END
	
	DECLARE @_Result int
	
	DECLARE @FormInstances FormInstanceTableType
			
	INSERT INTO @FormInstances (InstanceID, FormID, OwnerID, DirectorID, [Admin])
	VALUES (@FormInstanceID, @FormID, @FormOwnerID, @FormDirectorID, @Admin)
	
	EXEC [dbo].[FG_P_CreateFormInstance] @ApplicationID, @FormInstances, @CreatorUserID, @CreationDate, @_Result output
		
	IF @_Result <= 0 BEGIN
		SELECT NULL AS ID
		ROLLBACK TRANSACTION
		RETURN
	END
	
	SELECT @FormInstanceID AS ID
COMMIT TRANSACTION

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WF_GetHistoryFormInstances]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WF_GetHistoryFormInstances]
GO

CREATE PROCEDURE [dbo].[WF_GetHistoryFormInstances]
	@ApplicationID	uniqueidentifier,
	@strHistoryIDs	varchar(max),
	@delimiter		char,
	@Selected		bit
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	IF @Selected = 0 SET @Selected = NULL
	
	DECLARE @HistoryIDs GuidTableType
	INSERT INTO @HistoryIDs 
	SELECT DISTINCT Ref.Value FROM [dbo].[GFN_StrToGuidTable](@strHistoryIDs, @delimiter) AS Ref
	
	SELECT HFI.HistoryID AS HistoryID,
		   HFI.OutStateID AS OutStateID,
		   HFI.FormsID AS FormsID
	FROM @HistoryIDs AS ExternalIDs
		INNER JOIN [dbo].[WF_History] AS HS
		ON HS.ApplicationID = @ApplicationID AND HS.HistoryID = ExternalIDs.Value
		INNER JOIN [dbo].[WF_HistoryFormInstances] AS HFI
		ON HFI.ApplicationID = @ApplicationID AND HFI.HistoryID = HS.HistoryID
	WHERE (@Selected IS NULL OR 
		(HS.SelectedOutStateID IS NOT NULL AND HS.SelectedOutStateID = HFI.OutStateID)) AND
		HS.Deleted = 0 AND HFI.Deleted = 0
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WF_SendToNextState]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WF_SendToNextState]
GO

CREATE PROCEDURE [dbo].[WF_SendToNextState]
	@ApplicationID		uniqueidentifier,
    @PrevHistoryID		uniqueidentifier,
    @StateID			uniqueidentifier,
    @DirectorNodeID		uniqueidentifier,
    @DirectorUserID		uniqueidentifier,
    @Description		nvarchar(2000),
    @Reject				bit,
    @SenderUserID		uniqueidentifier,
    @SendDate			datetime,
	@AttachedFilesTemp	DocFileInfoTableType ReadOnly
WITH ENCRYPTION, RECOMPILE
AS
BEGIN TRANSACTION
	SET NOCOUNT ON
	
	DECLARE @AttachedFiles DocFileInfoTableType
	INSERT INTO @AttachedFiles SELECT * FROM @AttachedFilesTemp
	
	SET @Description = [dbo].[GFN_VerifyString](@Description)
	
	IF @Reject IS NULL SET @Reject = 0
	
	DECLARE @HistoryID uniqueidentifier, @OwnerID uniqueidentifier,
		@WorkFlowID uniqueidentifier, @PrevStateID uniqueidentifier
	
	SELECT @HistoryID = NEWID(), @OwnerID = OwnerID, 
		@WorkFlowID = WorkFlowID, @PrevStateID = StateID
	FROM [dbo].[WF_History]
	WHERE ApplicationID = @ApplicationID AND HistoryID = @PrevHistoryID
	
	IF @Reject = 0 BEGIN
		IF @DirectorNodeID IS NULL AND @DirectorUserID IS NULL BEGIN
			SELECT -5, N'NoDirectorIsSet'
			ROLLBACK TRANSACTION
			RETURN
		END
	END
	ELSE BEGIN
		DECLARE @MaxAllowedRejections int, @RejectionRefStateID uniqueidentifier
		
		SELECT @MaxAllowedRejections = MaxAllowedRejections, 
			   @RejectionRefStateID = RejectionRefStateID
		FROM [dbo].[WF_WorkFlowStates]
		WHERE ApplicationID = @ApplicationID AND WorkFlowID = @WorkFlowID AND StateID = @PrevStateID
		
		IF @MaxAllowedRejections IS NULL OR @MaxAllowedRejections <= 0 BEGIN
			SELECT -11, N'RejectionIsNotAllowed'
			ROLLBACK TRANSACTION
			RETURN
		END
		ELSE IF (
			SELECT COUNT(*) 
			FROM [dbo].[WF_History] 
			WHERE ApplicationID = @ApplicationID AND OwnerID = @OwnerID AND 
				WorkFlowID = @WorkFlowID AND StateID = @PrevHistoryID AND Rejected = 1 AND Deleted = 0
		) >= @MaxAllowedRejections BEGIN
			SELECT -12, N'MaxAllowedRejectionsExceeded'
			ROLLBACK TRANSACTION
			RETURN	
		END
		
		SELECT TOP(1) @DirectorNodeID = DirectorNodeID, @DirectorUserID = DirectorUserID,
			@StateID = StateID
		FROM [dbo].[WF_History]
		WHERE ApplicationID = @ApplicationID AND 
			OwnerID = @OwnerID AND WorkFlowID = @WorkFlowID AND 
			(@RejectionRefStateID IS NULL OR StateID = @RejectionRefStateID) AND
			HistoryID <> @PrevHistoryID AND Deleted = 0
		ORDER BY ID DESC
	END
	
	UPDATE [dbo].[WF_History]
		SET Rejected = @Reject,
			SelectedOutStateID = @StateID,
			[Description] = @Description,
			ActorUserID = @SenderUserID
	WHERE ApplicationID = @ApplicationID AND HistoryID = @PrevHistoryID
	
	IF @@ROWCOUNT <= 0 BEGIN
		SELECT -6, N'HistoryUpdateFailed'
		ROLLBACK TRANSACTION
		RETURN
	END
	
	INSERT INTO [dbo].[WF_History](
		ApplicationID,
		HistoryID,
		PreviousHistoryID,
		OwnerID,
		WorkFlowID,
		StateID,
		DirectorNodeID,
		DirectorUserID,
		Rejected,
		Terminated,
		SenderUserID,
		SendDate,
		Deleted
	)
	VALUES(
		@ApplicationID,
		@HistoryID,
		@PrevHistoryID,
		@OwnerID, 
		@WorkFlowID, 
		@StateID, 
		@DirectorNodeID, 
		@DirectorUserID, 
		0,
		0,
		@SenderUserID, 
		@SendDate, 
		0
	)
	
	IF @@ROWCOUNT <= 0 BEGIN
		SELECT -7, N'HistoryUpdateFailed'
		ROLLBACK TRANSACTION
		RETURN
	END
	
	DECLARE @DataNeedsType varchar(20), @RefDataNeedsStateID uniqueidentifier,
		@FormID uniqueidentifier
		
	SELECT @DataNeedsType = WFS.DataNeedsType, 
		   @RefDataNeedsStateID = WFS.RefDataNeedsStateID,
		   @FormID = FO.FormID
	FROM [dbo].[WF_WorkFlowStates] AS WFS
		LEFT JOIN [dbo].[FG_FormOwners] AS FO
		ON FO.ApplicationID = @ApplicationID AND FO.OwnerID = WFS.ID
	WHERE WFS.ApplicationID = @ApplicationID AND 
		WFS.WorkFlowID = @WorkFlowID AND WFS.StateID = @StateID
	
	DECLARE @_Result int
	
	IF @DataNeedsType = 'RefState' BEGIN
		IF EXISTS(
			SELECT TOP(1) * 
			FROM [dbo].[WF_StateDataNeedInstances]
			WHERE ApplicationID = @ApplicationID AND HistoryID = @PrevHistoryID AND Deleted = 0
		) BEGIN
			DECLARE @_NewNeeds Table(InstanceID uniqueidentifier, 
				NodeID uniqueidentifier, [Admin] bit)
		
			INSERT INTO [dbo].[WF_StateDataNeedInstances](
				ApplicationID,
				InstanceID,
				HistoryID,
				NodeID,
				[Admin],
				Filled,
				CreatorUserID,
				CreationDate,
				Deleted
			)
			SELECT @ApplicationID, NEWID(), @HistoryID, NodeID, 
				[Admin], 0, @SenderUserID, @SendDate, 0
			FROM [dbo].[WF_StateDataNeedInstances]
			WHERE ApplicationID = @ApplicationID AND HistoryID = @PrevHistoryID AND Deleted = 0
			
			IF @@ROWCOUNT <= 0 BEGIN
				SELECT -8, N'HistoryDateNeedsCreationFailed'
				ROLLBACK TRANSACTION
				RETURN
			END
		END
		
		EXEC [dbo].[FG_P_CopyFormInstances] @ApplicationID, @PrevHistoryID, 
			@HistoryID, @FormID, @SenderUserID, @SendDate, @_Result output
		
		IF @_Result <= 0 BEGIN
			SELECT -9, N'HistoryFormInstancesCopyFailed'
			ROLLBACK TRANSACTION
			RETURN	
		END
	END
	
	IF EXISTS(SELECT TOP(1) * FROM @AttachedFiles) BEGIN
		EXEC [dbo].[DCT_P_AddFiles] @ApplicationID, 
			@PrevHistoryID, N'WorkFlow', @AttachedFiles, @SenderUserID, @SendDate, @_Result output
		
		IF @_Result <= 0 BEGIN
			SELECT -10, N'FileAttachmentFailed'
			ROLLBACK TRANSACTION 
			RETURN
		END
	END
	
	-- Update WFState in CN_Nodes Table
	DECLARE @StateTitle nvarchar(1000) = (
		SELECT S.Title
		FROM [dbo].[WF_States] AS S
		WHERE S.ApplicationID = @ApplicationID AND S.StateID = @StateID
	)
	
	DECLARE @HideContributors bit = (
		SELECT TOP(1) ISNULL(S.HideOwnerName, 0)
		FROM [dbo].[WF_WorkFlowStates] AS S
		WHERE S.ApplicationID = @ApplicationID AND 
			S.WorkFlowID = @WorkFlowID AND S.StateID = @StateID
	)
	
	EXEC [dbo].[CN_P_ModifyNodeWFState] @ApplicationID, @OwnerID, 
		@StateTitle, @HideContributors, @SenderUserID, @SendDate, @_Result output
		
	IF @_Result <= 0 BEGIN
		SELECT -11, N'StatusUpdateFailed'
		ROLLBACK TRANSACTION 
		RETURN
	END
	-- end of Update WFState in CN_Nodes Table
	
	-- Send Dashboards
	EXEC [dbo].[NTFN_P_SetDashboardsAsDone] @ApplicationID, @SenderUserID, @OwnerID, 
		@PrevHistoryID, N'WorkFlow', NULL, @SendDate, @_Result output 
	
	IF @_Result <= 0 BEGIN
		SELECT -1, N'UpdatingDashboardsFailed'
		ROLLBACK TRANSACTION 
		RETURN
	END
	
	EXEC [dbo].[WF_P_SendDashboards] @ApplicationID, @HistoryID, @OwnerID, @WorkFlowID, 
		@StateID, @DirectorUserID, @DirectorNodeID, NULL, @SendDate, @_Result output
	
	IF @_Result <= 0 BEGIN
		SELECT -1, N'CannotDetermineDirector'
		ROLLBACK TRANSACTION 
		RETURN
	END
	-- end of Send Dashboards
	
	SELECT 1
COMMIT TRANSACTION

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WF_TerminateWorkFlow]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WF_TerminateWorkFlow]
GO

CREATE PROCEDURE [dbo].[WF_TerminateWorkFlow]
	@ApplicationID		uniqueidentifier,
    @PrevHistoryID		uniqueidentifier,
    @Description		nvarchar(2000),
    @SenderUserID		uniqueidentifier,
    @SendDate			datetime
WITH ENCRYPTION
AS
BEGIN TRANSACTION
	SET NOCOUNT ON
	
	SET @Description = [dbo].[GFN_VerifyString](@Description)
	
	DECLARE @OwnerID uniqueidentifier, @WorkFlowID uniqueidentifier
	
	SELECT @OwnerID = OwnerID, @WorkFlowID = WorkFlowID
	FROM [dbo].[WF_History]
	WHERE ApplicationID = @ApplicationID AND HistoryID = @PrevHistoryID
	
	UPDATE [dbo].[WF_History]
		SET Terminated = 1,
			[Description] = @Description,
			ActorUserID = @SenderUserID
	WHERE ApplicationID = @ApplicationID AND HistoryID = @PrevHistoryID
	
	IF @@ROWCOUNT <= 0 BEGIN
		SELECT -6
		ROLLBACK TRANSACTION
		RETURN
	END
	
	-- Send Dashboards
	DECLARE @_Result int
	
	EXEC [dbo].[NTFN_P_SetDashboardsAsDone] @ApplicationID, @SenderUserID, @OwnerID, 
		@PrevHistoryID, N'WorkFlow', NULL, @SendDate, @_Result output 
	
	IF @_Result <= 0 BEGIN
		SELECT -1, N'RemovingDashboardsFailed'
		ROLLBACK TRANSACTION 
		RETURN
	END
	
	EXEC [dbo].[NTFN_P_ArithmeticDeleteDashboards] @ApplicationID, 
		NULL, @OwnerID, NULL, N'WorkFlow', NULL, @_Result output 
	
	IF @_Result <= 0 BEGIN
		SELECT -1, N'RemovingDashboardsFailed'
		ROLLBACK TRANSACTION 
		RETURN
	END
	-- end of Send Dashboards
	
	SELECT 1
COMMIT TRANSACTION

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WF_GetViewerStatus]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WF_GetViewerStatus]
GO

CREATE PROCEDURE [dbo].[WF_GetViewerStatus]
	@ApplicationID	uniqueidentifier,
	@UserID			uniqueidentifier,
	@OwnerID		uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @HasWorkFlow bit = 0
	SELECT @HasWorkFlow = 1 
	WHERE EXISTS(
		SELECT TOP(1) * 
		FROM [dbo].[WF_History] 
		WHERE ApplicationID = @ApplicationID AND [OwnerID] = @OwnerID AND Deleted = 0
	)
		
	IF @HasWorkFlow = 0 BEGIN
		SELECT N'NotInWorkFlow'
		RETURN
	END
	
	DECLARE @IsOwner bit
	EXEC [dbo].[CN_P_IsNodeCreator] @ApplicationID, @OwnerID, @UserID, @IsOwner output
	
	IF @IsOwner IS NULL SET @IsOwner = 0
	
	DECLARE @WorkFlowID uniqueidentifier, @StateID uniqueidentifier,
		@DirectorNodeID uniqueidentifier, @DirectorUserID uniqueidentifier
	
	SELECT TOP(1) @WorkFlowID = WorkFlowID, @StateID = StateID,
		@DirectorNodeID = DirectorNodeID, @DirectorUserID = DirectorUserID
	FROM [dbo].[WF_History]
	WHERE ApplicationID = @ApplicationID AND OwnerID = @OwnerID AND Deleted = 0
	ORDER BY ID DESC
	
	IF @UserID = @DirectorUserID 
		SELECT N'Director'
	ELSE BEGIN
		DECLARE @IsAdminFromWorkFlow bit, @IsNodeMember bit, @IsAdmin bit = 0
		
		EXEC [dbo].[CN_P_IsNodeMember] @ApplicationID, 
			@DirectorNodeID, @UserID, @IsAdmin, 'Accepted', @IsNodeMember output
		
		IF @IsNodeMember = 1 BEGIN
			SET @IsAdminFromWorkFlow = (
				SELECT [Admin] 
				FROM [dbo].[WF_WorkFlowStates]
				WHERE ApplicationID = @ApplicationID AND 
					WorkFlowID = @WorkFlowID AND StateID = @StateID
			)
			
			IF @IsAdminFromWorkFlow IS NULL SET @IsAdminFromWorkFlow = 0
			
			IF @IsAdminFromWorkFlow = 1 BEGIN
				EXEC [dbo].[CN_P_IsNodeAdmin] @ApplicationID, 
					@DirectorNodeID, @UserID, @IsAdmin output
			END
		END
		ELSE BEGIN
			IF @IsOwner = 1 SELECT N'Owner'
			ELSE SELECT N'None'
			
			RETURN
		END
		
		IF (@IsAdminFromWorkFlow = 0 OR @IsAdmin = 1) SELECT N'Director'
		ELSE SELECT N'DirectorNodeMember'
	END	
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WF_GetNextStateParams]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WF_GetNextStateParams]
GO

CREATE PROCEDURE [dbo].[WF_GetNextStateParams]
	@ApplicationID	uniqueidentifier,
	@NodeID			uniqueidentifier,
    @WorkFlowID		uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @StartStateID uniqueidentifier
	DECLARE @ResponseType varchar(20)
	DECLARE @DirectorNodeID uniqueidentifier
	DECLARE @DirectorUserID uniqueidentifier
	
	DECLARE @_StartStateIDs GuidTableType
	INSERT INTO @_StartStateIDs
	SELECT WFS.StateID
	FROM [dbo].[WF_WorkFlowStates] AS WFS
	WHERE WFS.ApplicationID = @ApplicationID AND 
		WFS.WorkFlowID = @WorkFlowID AND WFS.Deleted = 0 AND
		NOT EXISTS(
			SELECT TOP(1) * 
			FROM [dbo].[WF_StateConnections] AS SC
				INNER JOIN [dbo].[WF_WorkFlowStates] AS Ref
				ON Ref.ApplicationID = @ApplicationID AND Ref.StateID = SC.InStateID
			WHERE SC.ApplicationID = @ApplicationID AND SC.WorkFlowID = @WorkFlowID AND 
				SC.OutStateID = WFS.StateID AND SC.Deleted = 0 AND Ref.Deleted = 0
		)
		
	SET @StartStateID = (SELECT TOP(1) Ref.Value FROM @_StartStateIDs AS Ref)
		
	SELECT @ResponseType = ResponseType, @DirectorNodeID = NodeID
	FROM [dbo].[WF_WorkFlowStates]
	WHERE ApplicationID = @ApplicationID AND 
		WorkFlowID = @WorkFlowID AND StateID = @StartStateID AND Deleted = 0
	
	IF @ResponseType = 'SendToOwner' BEGIN
		SET @DirectorNodeID = NULL
		
		SET @DirectorUserID = (
			SELECT TOP(1) CreatorUserID 
			FROM [dbo].[CN_Nodes] 
			WHERE ApplicationID = @ApplicationID AND NodeID = @NodeID
		)
	END
	ELSE IF @ResponseType = 'RefState'
		SET @DirectorNodeID = NULL
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WF_P_StartNewWorkFlow]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WF_P_StartNewWorkFlow]
GO

CREATE PROCEDURE [dbo].[WF_P_StartNewWorkFlow]
	@ApplicationID	uniqueidentifier,
	@NodeID			uniqueidentifier,
    @WorkFlowID		uniqueidentifier,
    @DirectorNodeID	uniqueidentifier,
	@DirectorUserID	uniqueidentifier,
	@CreatorUserID	uniqueidentifier,
	@CreationDate	datetime,
	@_Result		int output,
	@_Message		varchar(500) output
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @Terminated bit = NULL
	DECLARE @PreviousHistoryID uniqueidentifier = NULL
	
	SELECT TOP(1) @Terminated = Terminated, @PreviousHistoryID = HistoryID
	FROM [dbo].[WF_History] 
	WHERE ApplicationID = @ApplicationID AND OwnerID = @NodeID AND Deleted = 0
	ORDER BY ID DESC
	
	IF @Terminated = 0 BEGIN -- If result is null or equals 1, workflow doesn't exist or has been terminated
		SET @_Result = -1
		SET @_Message = N'TheNodeIsAlreadyInWorkFlow'
		RETURN
	END
	
	DECLARE @StartStateID uniqueidentifier
	DECLARE @ResponseType varchar(20)
	
	DECLARE @_StartStateIDs GuidTableType
	
	INSERT INTO @_StartStateIDs
	SELECT WFS.StateID
	FROM [dbo].[WF_WorkFlowStates] AS WFS
	WHERE WFS.ApplicationID = @ApplicationID AND WFS.WorkFlowID = @WorkFlowID AND WFS.Deleted = 0 AND
		NOT EXISTS(
			SELECT TOP(1) * 
			FROM [dbo].[WF_StateConnections] AS SC
				INNER JOIN [dbo].[WF_WorkFlowStates] AS Ref
				ON Ref.ApplicationID = @ApplicationID AND Ref.StateID = SC.InStateID
			WHERE SC.ApplicationID = @ApplicationID AND SC.WorkFlowID = @WorkFlowID AND 
				SC.OutStateID = WFS.StateID AND SC.Deleted = 0 AND Ref.Deleted = 0
		)
		
	IF (SELECT COUNT(*) FROM @_StartStateIDs) <> 1 BEGIN
		SET @_Result = -1
		SET @_Message = N'WorkFlowStateNotFound'
		RETURN
	END
	ELSE
		SET @StartStateID = (SELECT TOP(1) Ref.Value FROM @_StartStateIDs AS Ref)
	
	DECLARE @HistoryID uniqueidentifier = NEWID()
	
	INSERT INTO [dbo].[WF_History](
		ApplicationID,
		HistoryID,
		OwnerID,
		WorkFlowID,
		StateID,
		PreviousHistoryID,
		DirectorNodeID,
		DirectorUserID,
		Rejected,
		Terminated,
		SenderUserID,
		SendDate,
		Deleted
	)
	VALUES(
		@ApplicationID,
		@HistoryID,
		@NodeID,
		@WorkFlowID,
		@StartStateID,
		@PreviousHistoryID,
		@DirectorNodeID,
		@DirectorUserID,
		0,
		0,
		@CreatorUserID,
		@CreationDate,
		0
	)
	
	IF @@ROWCOUNT <= 0 BEGIN
		SET @_Result = -1
		SET @_Message = NULL
		RETURN
	END
	
	-- Update WFState in CN_Nodes Table
	DECLARE @StateTitle nvarchar(1000) = (
		SELECT Title 
		FROM [dbo].[WF_States] 
		WHERE ApplicationID = @ApplicationID AND StateID = @StartStateID
	)
	
	DECLARE @HideContributors bit = (
		SELECT TOP(1) ISNULL(S.HideOwnerName, 0)
		FROM [dbo].[WF_WorkFlowStates] AS S
		WHERE S.ApplicationID = @ApplicationID AND 
			S.WorkFlowID = @WorkFlowID AND S.StateID = @StartStateID
	)
	
	EXEC [dbo].[CN_P_ModifyNodeWFState] @ApplicationID, @NodeID, 
		@StateTitle, @HideContributors, @CreatorUserID, @CreationDate, @_Result output
		
	IF @_Result <= 0 BEGIN
		SET @_Result = -11
		SET @_Message = N'StatusUpdateFailed'
		RETURN
	END
	-- end of Update WFState in CN_Nodes Table
	
	-- Send Dashboards
	EXEC [dbo].[WF_P_SendDashboards] @ApplicationID, @HistoryID, @NodeID, @WorkFlowID, 
		@StartStateID, @DirectorUserID, @DirectorNodeID, NULL, @CreationDate, @_Result output
	
	IF @_Result <= 0 BEGIN
		SET @_Result = -1
		SET @_Message = N'CannotDetermineDirector'
		RETURN
	END
	-- end of Send Dashboards
	
	SET @_Result = 1
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WF_RestartWorkFlow]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WF_RestartWorkFlow]
GO

CREATE PROCEDURE [dbo].[WF_RestartWorkFlow]
	@ApplicationID	uniqueidentifier,
	@OwnerID		uniqueidentifier,
	@DirectorNodeID	uniqueidentifier,
	@DirectorUserID	uniqueidentifier,
	@CreatorUserID	uniqueidentifier,
	@CreationDate	datetime
WITH ENCRYPTION
AS
BEGIN TRANSACTION
	SET NOCOUNT ON
	
	DECLARE @_Result int
	DECLARE @_Message varchar(500) = NULL
	
	DECLARE @WorkFlowID uniqueidentifier
	
	SELECT TOP(1) @WorkFlowID = WorkFlowID
	FROM [dbo].[WF_History] 
	WHERE ApplicationID = @ApplicationID AND OwnerID = @OwnerID
	ORDER BY ID DESC
	
	IF @WorkFlowID IS NULL BEGIN
		SELECT -1, N'WorkFlowNotFound'
	END
	ELSE BEGIN
		EXEC [dbo].[WF_P_StartNewWorkFlow] @ApplicationID, @OwnerID, @WorkFlowID, @DirectorNodeID,
			@DirectorUserID, @CreatorUserID, @CreationDate, @_Result output, @_Message output
	
		IF @_Result > 0 SELECT @_Result
		ELSE BEGIN 
			SELECT @_Result, @_Message
			ROLLBACK TRANSACTION
			RETURN
		END
	END
COMMIT TRANSACTION

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WF_HasWorkFlow]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WF_HasWorkFlow]
GO

CREATE PROCEDURE [dbo].[WF_HasWorkFlow]
	@ApplicationID	uniqueidentifier,
	@OwnerID		uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT 1 
	WHERE EXISTS(
		SELECT TOP(1) * 
		FROM [dbo].[WF_History] 
		WHERE ApplicationID = @ApplicationID AND [OwnerID] = @OwnerID AND Deleted = 0
	)
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WF_IsTerminated]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WF_IsTerminated]
GO

CREATE PROCEDURE [dbo].[WF_IsTerminated]
	@ApplicationID	uniqueidentifier,
	@OwnerID		uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT TOP(1) Terminated
	FROM [dbo].[WF_History]
	WHERE ApplicationID = @ApplicationID AND OwnerID = @OwnerID AND Deleted = 0
	ORDER BY ID DESC
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WF_GetServiceAbstract]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WF_GetServiceAbstract]
GO

CREATE PROCEDURE [dbo].[WF_GetServiceAbstract]
	@ApplicationID	uniqueidentifier,
	@WorkFlowID		uniqueidentifier,
	@NodeTypeID		uniqueidentifier,
	@UserID			uniqueidentifier,
	@NullTagLabel	nvarchar(256)
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON

	SET @NullTagLabel = [dbo].[GFN_VerifyString](@NullTagLabel)

	SELECT ISNULL(TG.Tag, @NullTagLabel) AS Tag, Counts.CNT AS [Count]
	FROM
		(
			SELECT Owners.TagID, COUNT(OwnerID) AS CNT 
			FROM
				(
					SELECT A.OwnerID, WS.TagID
					FROM [dbo].[WF_History] AS A
						INNER JOIN (
							SELECT OwnerID, MAX(ID) AS ID
							FROM [dbo].[WF_History]
							WHERE ApplicationID = @ApplicationID AND Deleted = 0
							GROUP BY OwnerID
						) AS B
						ON B.ID = A.ID AND B.OwnerID = A.OwnerID
						INNER JOIN [dbo].[CN_Nodes] AS ND
						ON ND.ApplicationID = @ApplicationID AND ND.NodeID = A.OwnerID
						INNER JOIN [dbo].[WF_WorkFlowStates] AS WS
						ON WS.ApplicationID = @ApplicationID AND WS.StateID = A.StateID
					WHERE A.ApplicationID = @ApplicationID AND
						(@WorkFlowID IS NULL OR 
							(A.WorkFlowID = @WorkFlowID AND WS.WorkFlowID = @WorkFlowID)
						) AND ND.NodeTypeID = @NodeTypeID AND ND.Deleted = 0 AND
						(@UserID IS NULL OR	
							EXISTS(
								SELECT TOP(1) * 
								FROM [dbo].[CN_NodeCreators]
								WHERE ApplicationID = @ApplicationID AND 
									NodeID = A.OwnerID AND UserID = @UserID AND Deleted = 0
							)
						)
				) AS Owners
			GROUP BY Owners.TagID
		) AS Counts
		LEFT JOIN [dbo].[CN_Tags] AS TG
		ON TG.ApplicationID = @ApplicationID AND TG.TagID = Counts.TagID
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WF_GetServiceUserIDs]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WF_GetServiceUserIDs]
GO

CREATE PROCEDURE [dbo].[WF_GetServiceUserIDs]
	@ApplicationID	uniqueidentifier,
	@WorkFlowID		uniqueidentifier,
	@NodeTypeID		uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT DISTINCT NC.UserID AS ID
	FROM
		(
			SELECT DISTINCT OwnerID
			FROM [dbo].[WF_History]
			WHERE ApplicationID = @ApplicationID AND 
				(@WorkFlowID IS NULL OR WorkFlowID = @WorkFlowID) AND Deleted = 0
		) AS NDS
		INNER JOIN [dbo].[CN_View_Nodes_Normal] AS ND
		ON ND.ApplicationID = @ApplicationID AND ND.NodeID = NDS.OwnerID
		INNER JOIN [dbo].[CN_NodeCreators] AS NC
		ON NC.ApplicationID = @ApplicationID AND NC.NodeID = NDS.OwnerID
	WHERE (@NodeTypeID IS NULL OR ND.NodeTypeID = @NodeTypeID) AND 
		ND.Deleted = 0 AND NC.Deleted = 0
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WF_GetWorkFlowItemsCount]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WF_GetWorkFlowItemsCount]
GO

CREATE PROCEDURE [dbo].[WF_GetWorkFlowItemsCount]
	@ApplicationID	uniqueidentifier,
	@WorkFlowID		uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT CAST(COUNT(DISTINCT H.OwnerID) AS int)
	FROM [dbo].[WF_History] AS H
		INNER JOIN [dbo].[CN_Nodes] AS ND
		ON ND.ApplicationID = @ApplicationID AND ND.NodeID = H.OwnerID AND ND.Deleted = 0
	WHERE H.ApplicationID = @ApplicationID AND H.WorkFlowID = @WorkFlowID AND H.Deleted = 0
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WF_GetWorkFlowStateItemsCount]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WF_GetWorkFlowStateItemsCount]
GO

CREATE PROCEDURE [dbo].[WF_GetWorkFlowStateItemsCount]
	@ApplicationID	uniqueidentifier,
	@WorkFlowID		uniqueidentifier,
	@StateID		uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT CAST(COUNT(DISTINCT H.OwnerID) AS int)
	FROM [dbo].[WF_History] AS H
		INNER JOIN (
			SELECT A.OwnerID, MAX(A.ID) AS ID
			FROM [dbo].[WF_History] AS A
			WHERE A.ApplicationID = @ApplicationID AND A.WorkFlowID = @WorkFlowID AND A.Deleted = 0
			GROUP BY A.OwnerID
		) AS X
		ON X.ID = H.ID
		INNER JOIN [dbo].[CN_Nodes] AS ND
		ON ND.ApplicationID = @ApplicationID AND ND.NodeID = H.OwnerID AND ND.Deleted = 0
	WHERE H.ApplicationID = @ApplicationID AND H.StateID = @StateID
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WF_GetUserWorkFlowItemsCount]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WF_GetUserWorkFlowItemsCount]
GO

CREATE PROCEDURE [dbo].[WF_GetUserWorkFlowItemsCount]
	@ApplicationID			uniqueidentifier,
	@UserID					uniqueidentifier,
	@LowerCreationDateLimit	datetime,
	@UpperCreationDateLimit	datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT Counts.NodeTypeID AS NodeTypeID,
		   NT.Name AS NodeType, 
		   Counts.CNT AS [Count]
	FROM (
			SELECT ND.NodeTypeID, COUNT(NC.NodeID) AS CNT
			FROM [dbo].[CN_NodeCreators] AS NC
				INNER JOIN [dbo].[CN_View_Nodes_Normal] AS ND
				ON ND.ApplicationID = @ApplicationID AND ND.NodeID = NC.NodeID
				INNER JOIN [dbo].[CN_Services] AS SR
				ON SR.ApplicationID = @ApplicationID AND SR.NodeTypeID = ND.NodeTypeID
			WHERE NC.ApplicationID = @ApplicationID AND NC.UserID = @UserID AND 
				EXISTS(
					SELECT TOP(1) * 
					FROM [dbo].[WF_History]
					WHERE ApplicationID = @ApplicationID AND OwnerID = ND.NodeID AND Deleted = 0
				) AND NC.Deleted = 0 AND ND.Deleted = 0 AND
				(@LowerCreationDateLimit IS NULL OR ND.CreationDate >= @LowerCreationDateLimit) AND
				(@UpperCreationDateLimit IS NULL OR ND.CreationDate <= @UpperCreationDateLimit)
			GROUP BY ND.NodeTypeID
		) AS Counts
		INNER JOIN [dbo].[CN_NodeTypes] AS NT
		ON NT.ApplicationID = @ApplicationID AND NT.NodeTypeID = Counts.NodeTypeID
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WF_AddOwnerWorkFlow]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WF_AddOwnerWorkFlow]
GO

CREATE PROCEDURE [dbo].[WF_AddOwnerWorkFlow]
	@ApplicationID	uniqueidentifier,
	@NodeTypeID		uniqueidentifier,
	@WorkFlowID		uniqueidentifier,
	@CreatorUserID	uniqueidentifier,
	@CreationDate	datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	IF EXISTS(
		SELECT TOP(1) * 
		FROM [dbo].[WF_WorkFlowOwners]
		WHERE ApplicationID = @ApplicationID AND
			NodeTypeID = @NodeTypeID AND WorkFlowID = @WorkFlowID
	) BEGIN
		UPDATE [dbo].[WF_WorkFlowOwners]
			SET Deleted = 0,
				LastModifierUserID = @CreatorUserID,
				LastModificationDate = @CreationDate
		WHERE ApplicationID = @ApplicationID AND 
			NodeTypeID = @NodeTypeID AND WorkFlowID = @WorkFlowID
	END
	ELSE BEGIN
		INSERT INTO [dbo].[WF_WorkFlowOwners](
			ApplicationID,
			ID,
			NodeTypeID,
			WorkFlowID,
			CreatorUserID,
			CreationDate,
			Deleted
		)
		VALUES(
			@ApplicationID,
			NEWID(),
			@NodeTypeID,
			@WorkFlowID,
			@CreatorUserID,
			@CreationDate,
			0
		)
	END
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WF_ArithmeticDeleteOwnerWorkFlow]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WF_ArithmeticDeleteOwnerWorkFlow]
GO

CREATE PROCEDURE [dbo].[WF_ArithmeticDeleteOwnerWorkFlow]
	@ApplicationID			uniqueidentifier,
	@NodeTypeID				uniqueidentifier,
	@WorkFlowID				uniqueidentifier,
	@LastModifierUserID		uniqueidentifier,
	@LastModificationDate	datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	UPDATE [dbo].[WF_WorkFlowOwners]
		SET Deleted = 1,
			LastModifierUserID = @LastModifierUserID,
			LastModificationDate = @LastModificationDate
	WHERE ApplicationID = @ApplicationID AND 
		NodeTypeID = @NodeTypeID AND WorkFlowID = @WorkFlowID
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WF_GetOwnerWorkFlows]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WF_GetOwnerWorkFlows]
GO

CREATE PROCEDURE [dbo].[WF_GetOwnerWorkFlows]
	@ApplicationID	uniqueidentifier,
	@NodeTypeID		uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON

	DECLARE @WorkFlowIDs GuidTableType
	
	INSERT INTO @WorkFlowIDs
	SELECT WorkFlowID
	FROM [dbo].[WF_WorkFlowOwners]
	WHERE ApplicationID = @ApplicationID AND NodeTypeID = @NodeTypeID AND Deleted = 0
	
	EXEC [dbo].[WF_P_GetWorkFlowsByIDs] @ApplicationID, @WorkFlowIDs
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WF_GetOwnerWorkFlowPrimaryKey]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WF_GetOwnerWorkFlowPrimaryKey]
GO

CREATE PROCEDURE [dbo].[WF_GetOwnerWorkFlowPrimaryKey]
	@ApplicationID	uniqueidentifier,
	@NodeTypeID		uniqueidentifier,
	@WorkFlowID		uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON

	SELECT ID
	FROM [dbo].[WF_WorkFlowOwners]
	WHERE ApplicationID = @ApplicationID AND 
		NodeTypeID = @NodeTypeID AND WorkFlowID = @WorkFlowID
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WF_GetWorkFlowOwnerIDs]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WF_GetWorkFlowOwnerIDs]
GO

CREATE PROCEDURE [dbo].[WF_GetWorkFlowOwnerIDs]
	@ApplicationID	uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT DISTINCT NodeTypeID AS ID
	FROM [dbo].[WF_WorkFlowOwners]
	WHERE ApplicationID = @ApplicationID AND Deleted = 0
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WF_GetFormInstanceWorkFlowOwnerID]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WF_GetFormInstanceWorkFlowOwnerID]
GO

CREATE PROCEDURE [dbo].[WF_GetFormInstanceWorkFlowOwnerID]
	@ApplicationID		uniqueidentifier,
	@FormInstanceID		uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT TOP(1) H.OwnerID
	FROM [dbo].[FG_FormInstances] AS FI
		INNER JOIN [dbo].[WF_HistoryFormInstances] AS HFI
		ON HFI.ApplicationID = @ApplicationID AND HFI.FormsID = FI.OwnerID
		INNER JOIN [dbo].[WF_History] AS H
		ON H.ApplicationID = @ApplicationID AND H.HistoryID = HFI.HistoryID
	WHERE FI.ApplicationID = @ApplicationID AND FI.InstanceID = @FormInstanceID
END

GO

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[LG_SaveLog]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[LG_SaveLog]
GO

CREATE PROCEDURE [dbo].[LG_SaveLog]
	@ApplicationID		uniqueidentifier,
	@UserID				uniqueidentifier,
	@HostAddress		varchar(100),
	@HostName			nvarchar(255),
	@Action				varchar(100),
	@Level				varchar(20),
	@NotAuthorized		bit,
	@strSubjectIDs		varchar(max),
	@delimiter			char,
	@SecondSubjectID	uniqueidentifier,
	@ThirdSubjectID		uniqueidentifier,
	@FourthSubjectID	uniqueidentifier,
	@Date				datetime,
	@Info				nvarchar(max),
	@ModuleIdentifier	varchar(20)
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @SubjectIDs GuidTableType
	INSERT INTO @SubjectIDs
	SELECT Ref.Value FROM [dbo].[GFN_StrToGuidTable](@strSubjectIDs, @delimiter) AS Ref

	INSERT INTO [dbo].[LG_Logs](
		ApplicationID,
		UserID,
		HostAddress,
		HostName,
		[Action],
		[Level],
		NotAuthorized,
		SubjectID,
		SecondSubjectID,
		ThirdSubjectID,
		FourthSubjectID,
		[Date],
		Info,
		ModuleIdentifier
	)
	SELECT @ApplicationID, ISNULL(@UserID, [dbo].[GFN_GuidEmpty]()), @HostAddress, @HostName, @Action, @Level, @NotAuthorized, Ref.Value, 
		@SecondSubjectID, @ThirdSubjectID, @FourthSubjectID, @Date, @Info, @ModuleIdentifier
	FROM @SubjectIDs AS Ref
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[LG_P_GetLogs]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[LG_P_GetLogs]
GO

CREATE PROCEDURE [dbo].[LG_P_GetLogs]
	@ApplicationID	uniqueidentifier,
    @UserIDsTemp	GuidTableType readonly,
    @ActionsTemp	StringTableType readonly,
    @BeginDate		datetime,
    @FinishDate		datetime,
    @LastID			bigint,
    @Count			int
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @UserIDs GuidTableType
	INSERT INTO @UserIDs SELECT * FROM @UserIDsTemp
	
    DECLARE @Actions StringTableType
    INSERT INTO @Actions SELECT * FROM @ActionsTemp
	
	DECLARE @ActionsCount int = (SELECT COUNT(*) FROM @Actions)
	DECLARE @UsersCount int = (SELECT COUNT(*) FROM @UserIDs)
	SET @Count = ISNULL(@Count, 100)
	
	IF @UsersCount = 0 BEGIN
		SELECT TOP(@Count) 
			LG.LogID,
			LG.UserID,
			UN.UserName,
			UN.FirstName,
			UN.LastName,
			LG.HostAddress,
			LG.HostName,
			LG.[Action],
			LG.[Date],
			LG.Info,
			LG.ModuleIdentifier
		FROM [dbo].[LG_Logs] AS LG
			LEFT JOIN [dbo].[USR_View_Users] AS UN
			ON UN.UserID = LG.UserID
		WHERE (@ApplicationID IS NULL OR LG.ApplicationID = @ApplicationID) AND
			(@LastID IS NULL OR LogID > @LastID) AND
			(@FinishDate IS NULL OR LG.[Date] < @FinishDate) AND
			(@BeginDate IS NULL OR LG.[Date] > @BeginDate) AND
			(@ActionsCount = 0 OR LG.[Action] IN (SELECT * FROM @Actions))
		ORDER BY LG.LogID DESC
	END
	ELSE BEGIN
		SELECT TOP(@Count)
			LG.LogID,
			LG.UserID,
			UN.UserName,
			UN.FirstName,
			UN.LastName,
			LG.HostAddress,
			LG.HostName,
			LG.[Action],
			LG.[Date],
			LG.Info,
			LG.ModuleIdentifier
		FROM @UserIDs AS USR
			INNER JOIN [dbo].[LG_Logs] AS LG
			ON (@ApplicationID IS NULL OR LG.ApplicationID = @ApplicationID) AND
				LG.UserID = USR.Value
			LEFT JOIN [dbo].[USR_View_Users] AS UN
			ON UN.UserID = LG.UserID
		WHERE (@LastID IS NULL OR LogID > @LastID) AND
			(@FinishDate IS NULL OR LG.[Date] < @FinishDate) AND
			(@BeginDate IS NULL OR LG.[Date] > @BeginDate) AND
			(@ActionsCount = 0 OR LG.[Action] IN (SELECT * FROM @Actions))
		ORDER BY LG.LogID DESC
	END
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[LG_GetLogs]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[LG_GetLogs]
GO

CREATE PROCEDURE [dbo].[LG_GetLogs]
	@ApplicationID	uniqueidentifier,
    @strUserIDs 	varchar(max),
    @strActions		varchar(max),
    @delimiter		char,
    @BeginDate		datetime,
    @FinishDate		datetime,
    @LastID			bigint,
    @Count			int
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @UserIDs GuidTableType
	INSERT INTO @UserIDs
	SELECT Ref.Value FROM [dbo].[GFN_StrToGuidTable](@strUserIDs, @delimiter) AS Ref
	
	DECLARE @Actions StringTableType
	INSERT INTO @Actions
	SELECT Ref.Value FROM [dbo].[GFN_StrToStringTable](@strActions, @delimiter) AS Ref
	
	EXEC [dbo].[LG_P_GetLogs] @ApplicationID, @UserIDs, 
		@Actions, @BeginDate, @FinishDate, @LastID, @Count
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[LG_SaveErrorLog]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[LG_SaveErrorLog]
GO

CREATE PROCEDURE [dbo].[LG_SaveErrorLog]
	@ApplicationID		uniqueidentifier,
	@UserID				uniqueidentifier,
	@Subject			varchar(1000),
	@Description		nvarchar(2000),
	@Date				datetime,
	@ModuleIdentifier	varchar(20),
	@Level				varchar(20)
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON

	INSERT INTO [dbo].[LG_ErrorLogs](
		ApplicationID,
		UserID,
		[Subject],
		[Description],
		[Date],
		ModuleIdentifier,
		[Level]
	)
	VALUES (
		@ApplicationID,
		@UserID, 
		@Subject, 
		@Description, 
		@Date, 
		@ModuleIdentifier,
		@Level
	)
	
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[LG_SaveRawLog]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[LG_SaveRawLog]
GO

CREATE PROCEDURE [dbo].[LG_SaveRawLog]
	@ApplicationID		uniqueidentifier,
	@UserID				uniqueidentifier,
	@Date				datetime,
	@Info				nvarchar(max)
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON

	INSERT INTO [dbo].[LG_RawLogs] (
		ApplicationID,
		UserID,
		[Date],
		Info
	)
	VALUES (
		@ApplicationID,
		@UserID, 
		@Date, 
		@Info
	)
	
	SELECT @@ROWCOUNT
END

GO

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[MSG_GetThreads]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[MSG_GetThreads]
GO

CREATE PROCEDURE [dbo].[MSG_GetThreads]
	@ApplicationID	uniqueidentifier,
    @UserID			UNIQUEIDENTIFIER,
    @Count			INT,
    @LastID			INT
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT TOP(ISNULL(@Count, 10))
		D.ThreadID, 
		UN.UserName, 
		UN.FirstName, 
		UN.LastName,
		CAST((CASE WHEN UN.UserID IS NULL THEN 1 ELSE 0 END) AS bit) AS IsGroup,
		D.MessagesCount,
		D.SentCount,
		D.NotSeenCount,
		D.RowNumber
	FROM (
			SELECT ROW_NUMBER() OVER (ORDER BY Ref.MaxID DESC) AS RowNumber, Ref.*
			FROM (
					SELECT MD.ThreadID, MAX(MD.ID) AS MaxID,
						COUNT(MD.ID) AS MessagesCount, 
						SUM(CAST(MD.IsSender AS int)) AS SentCount,
						SUM(
							CAST((CASE WHEN MD.IsSender = 0 AND MD.Seen = 0 THEN 1 ELSE 0 END) AS int)
						) AS NotSeenCount
					FROM [dbo].[MSG_MessageDetails] AS MD
					WHERE MD.ApplicationID = @ApplicationID AND 
						MD.UserID = @UserID AND MD.Deleted = 0
					GROUP BY MD.ThreadID
				) AS Ref
		) AS D
		LEFT JOIN [dbo].[Users_Normal] AS UN
		ON UN.ApplicationID = @ApplicationID AND UN.UserID = D.ThreadID
	WHERE (@LastID IS NULL OR D.RowNumber > @LastID)
	ORDER BY D.RowNumber ASC
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[MSG_GetThreadInfo]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[MSG_GetThreadInfo]
GO

CREATE PROCEDURE [dbo].[MSG_GetThreadInfo]
	@ApplicationID	uniqueidentifier,
    @UserID			UNIQUEIDENTIFIER,
    @ThreadID		UNIQUEIDENTIFIER
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT	COUNT(MD.ID) AS MessagesCount, 
			SUM(CAST(MD.IsSender AS int)) AS SentCount,
			SUM(
				CAST((CASE WHEN MD.IsSender = 0 AND MD.Seen = 0 THEN 1 ELSE 0 END) AS int)
			) AS NotSeenCount
	FROM [dbo].[MSG_MessageDetails] AS MD
	WHERE MD.ApplicationID = @ApplicationID AND 
		MD.UserID = @UserID AND MD.ThreadID = @ThreadID AND MD.Deleted = 0
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[MSG_GetMessages]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[MSG_GetMessages]
GO

CREATE PROCEDURE [dbo].[MSG_GetMessages]
	@ApplicationID	uniqueidentifier,
    @UserID			UNIQUEIDENTIFIER,
    @ThreadID		UNIQUEIDENTIFIER,
    @Sent			BIT,
    @Count			INT,
    @MinID			BIGINT
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	--@Sent IS NULL --> Sent and Received Messages
	--@Sent IS NOT NULL --> @Sent = 1 --> Sent Messages
	--                  --> @Sent = 0 --> Received Messages
	
	SELECT 
		M.MessageID,
		M.Title,
		M.MessageText,
		M.SendDate,
		M.SenderUserID,
		M.ForwardedFrom,
		D.ID,
		D.IsGroup,
		D.IsSender,
		D.Seen,
		D.ThreadID,
		UN.UserName,
		UN.FirstName,
		UN.LastName,
		M.HasAttachment
	FROM (
			SELECT TOP(ISNULL(@Count, 20)) *
			FROM [dbo].[MSG_MessageDetails] AS MD
			WHERE MD.ApplicationID = @ApplicationID AND
				(@MinID IS NULL OR  MD.ID < @MinID) AND 
				MD.UserID = @UserID AND
				(MD.ThreadID IS NULL OR ThreadID = @ThreadID) AND 
				(@Sent IS NULL OR IsSender = @Sent) AND 
				MD.Deleted = 0
			ORDER BY MD.ID DESC
		)AS D
		INNER JOIN [dbo].[MSG_Messages] AS M
		ON M.ApplicationID = @ApplicationID AND M.MessageID = D.MessageID
		INNER JOIN [dbo].[Users_Normal] AS UN
		ON UN.ApplicationID = @ApplicationID AND UN.UserID = M.SenderUserID
	ORDER BY D.ID ASC
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[MSG_HasMessage]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[MSG_HasMessage]
GO

CREATE PROCEDURE [dbo].[MSG_HasMessage]
	@ApplicationID	uniqueidentifier,
	@ID				BIGINT,
    @UserID			UNIQUEIDENTIFIER,
    @ThreadID		UNIQUEIDENTIFIER,
    @MessageID		UNIQUEIDENTIFIER
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT
		CASE
			WHEN EXISTS(
				SELECT TOP(1) ID
				FROM [dbo].[MSG_MessageDetails]
				WHERE ApplicationID = @ApplicationID AND (@ID IS NULL OR ID = @ID) AND
					UserID = @UserID AND 
					(@ThreadID IS NULL OR ThreadID = @ThreadID) AND
					(@MessageID IS NULL OR MessageID = @MessageID)
			) THEN 1
			ELSE 0
		END
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[MSG_SendNewMessage]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[MSG_SendNewMessage]
GO

CREATE PROCEDURE [dbo].[MSG_SendNewMessage]
	@ApplicationID		uniqueidentifier,
    @UserID				UNIQUEIDENTIFIER,
    @ThreadID			UNIQUEIDENTIFIER,
    @MessageID			UNIQUEIDENTIFIER,
    @ForwardedFrom		UNIQUEIDENTIFIER,
    @Title				NVARCHAR(500),
    @MessageText		NVARCHAR(MAX),
    @IsGroup			BIT,
    @Now				DATETIME,
    @ReceiversTemp		GuidTableType readonly,
    @AttachedFilesTemp	DocFileInfoTableType readonly
WITH ENCRYPTION, RECOMPILE
AS
BEGIN TRANSACTION
	SET NOCOUNT ON
	
	DECLARE @Receivers GuidTableType
	INSERT INTO @Receivers SELECT * FROM @ReceiversTemp
    
    DECLARE @AttachedFiles DocFileInfoTableType
    INSERT INTO @AttachedFiles SELECT * FROM @AttachedFilesTemp
	
	IF @IsGroup IS NULL SET @IsGroup = 0
	
	IF @ThreadID IS NOT NULL BEGIN
		SET @IsGroup = ISNULL(
			(
				SELECT TOP(1) MD.IsGroup
				FROM [dbo].[MSG_MessageDetails] AS MD
				WHERE MD.ApplicationID = @ApplicationID AND MD.ThreadID = @ThreadID
			), @IsGroup
		)
	END
	
	DECLARE @ReceiverUserIDs GuidTableType
	
	INSERT INTO @ReceiverUserIDs SELECT * FROM @Receivers
	
	DECLARE @Count int = (SELECT COUNT(*) FROM @ReceiverUserIDs)
	
	IF @Count = 1 SET @IsGroup = 0
	
	IF(@Count > 1) DELETE FROM @ReceiverUserIDs WHERE Value = @UserID --Farzane Added
	
	IF (@ThreadID IS NULL AND @IsGroup = 0) AND @Count = 0 BEGIN
		SELECT -1
		RETURN
	END
	
	IF @ThreadID IS NOT NULL AND @Count = 0 AND 
		EXISTS(
			SELECT TOP(1) UserID 
			FROM [dbo].[Users_Normal] 
			WHERE ApplicationID = @ApplicationID AND UserID = @ThreadID
	) BEGIN
		INSERT INTO @ReceiverUserIDs (Value)
		VALUES (@ThreadID)
		
		SET @Count = 1
	END
	
	IF @IsGroup = 1 BEGIN
		IF @Count = 1 SET @ThreadID = (SELECT TOP(1) Ref.Value FROM @ReceiverUserIDs AS Ref)
		ELSE IF (@ThreadID IS NULL AND @Count > 0) SET @ThreadID = NEWID()
	END
	
	IF @Count = 0 BEGIN
		INSERT INTO @ReceiverUserIDs
		SELECT DISTINCT MD.UserID 
		FROM [dbo].[MSG_MessageDetails] AS MD
		WHERE MD.ApplicationID = @ApplicationID AND MD.ThreadID = @ThreadID
		EXCEPT (SELECT @UserID)
		
		SET @Count = (SELECT COUNT(*) FROM @ReceiverUserIDs)
	END
	
	DECLARE @AttachmentsCount int = (SELECT COUNT(*) FROM @AttachedFiles)
	
	INSERT INTO [dbo].[MSG_Messages](
		ApplicationID,
		MessageID,
		Title,
		MessageText,
		SenderUserID,
		SendDate,
		ForwardedFrom,
		HasAttachment
	)
	VALUES(
		@ApplicationID,
		@MessageID,
		@Title,
		@MessageText,
		@UserID,
		@Now,
		@ForwardedFrom,
		CASE WHEN @AttachmentsCount > 0 THEN 1 ELSE 0 END
	)
	
	IF @@ROWCOUNT <= 0 BEGIN
		SELECT -1
		ROLLBACK TRANSACTION
		RETURN
	END
	
	DECLARE @_Result int
	
	IF @AttachmentsCount > 0 BEGIN
		EXEC [dbo].[DCT_P_AddFiles] @ApplicationID, @MessageID, 
			N'Message', @AttachedFiles, @UserID, @Now, @_Result output
		
		IF @_Result <= 0 BEGIN
			SELECT -1
			ROLLBACK TRANSACTION
			RETURN
		END
	END
	
	IF @ForwardedFrom IS NOT NULL BEGIN
		EXEC [dbo].[DCT_P_CopyAttachments] @ApplicationID, @ForwardedFrom, 
			@MessageID, N'Message', @UserID, @Now, @_Result output
		
		IF @_Result > 0 BEGIN
			UPDATE [dbo].[MSG_Messages]
				SET HasAttachment = 1
			WHERE ApplicationID = @ApplicationID AND MessageID = @MessageID
		END 
	END
	
	INSERT INTO [dbo].[MSG_MessageDetails](
		ApplicationID,
		UserID,
		ThreadID,
		MessageID,
		Seen,
		IsSender,
		IsGroup,
		Deleted
	)
	(
		SELECT	TOP(CASE WHEN @IsGroup = 1 THEN 1 ELSE 1000000000 END)
				@ApplicationID,
				@UserID,
				CASE WHEN @IsGroup = 0 THEN R.Value ELSE @ThreadID END,
				@MessageID,
				1,
				1,
				@IsGroup,
				0
		FROM @ReceiverUserIDs AS R
		
		UNION ALL
		
		SELECT	@ApplicationID,
				R.Value,
				CASE WHEN @IsGroup = 0 THEN @UserID ELSE @ThreadID END,
				@MessageID,
				0,
				0,
				@IsGroup,
				0
		FROM @ReceiverUserIDs AS R
	)
	
	IF @@ROWCOUNT <= 0 BEGIN
		SELECT -1
		ROLLBACK TRANSACTION
		RETURN
	END
	
	SELECT @@IDENTITY - @Count
COMMIT TRANSACTION

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[MSG_BulkSendMessage]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[MSG_BulkSendMessage]
GO

CREATE PROCEDURE [dbo].[MSG_BulkSendMessage]
	@ApplicationID	uniqueidentifier,
    @MessagesTemp	MessageTableType readonly,
    @ReceiversTemp	GuidPairTableType readonly,
    @Now			DATETIME
WITH ENCRYPTION, RECOMPILE
AS
BEGIN TRANSACTION
	SET NOCOUNT ON
	
	DECLARE @Messages MessageTableType
	INSERT INTO @Messages SELECT * FROM @MessagesTemp
    
    DECLARE @Receivers GuidPairTableType
    INSERT INTO @Receivers SELECT * FROM @ReceiversTemp
	
	INSERT INTO [dbo].[MSG_Messages](
		ApplicationID,
		MessageID,
		Title,
		MessageText,
		SenderUserID,
		SendDate,
		HasAttachment
	)
	SELECT	@ApplicationID,
			M.MessageID,
			M.Title,
			M.MessageText,
			M.SenderUserID,
			@Now,
			0
	FROM @Messages AS M
	WHERE M.MessageID IN (SELECT DISTINCT R.FirstValue FROM @Receivers AS R)
	
	IF @@ROWCOUNT <= 0 BEGIN
		SELECT -1
		ROLLBACK TRANSACTION
		RETURN
	END
	
	INSERT INTO [dbo].[MSG_MessageDetails](
		ApplicationID,
		UserID,
		ThreadID,
		MessageID,
		Seen,
		IsSender,
		IsGroup,
		Deleted
	)
	SELECT *
	FROM (
			SELECT	@ApplicationID AS ApplicationID,
					M.SenderUserID,
					R.SecondValue,
					M.MessageID,
					1 AS Seen,
					1 AS IsSender,
					0 AS IsGroup,
					0 AS Deleted
			FROM @Messages AS M
				INNER JOIN @Receivers AS R
				ON R.FirstValue = M.MessageID
			
			UNION ALL
			
			SELECT	@ApplicationID,
					R.SecondValue,
					M.SenderUserID,
					M.MessageID,
					0,
					0,
					0,
					0
			FROM @Messages AS M
				INNER JOIN @Receivers AS R
				ON R.FirstValue = M.MessageID
		) AS Ref
	ORDER BY Ref.IsSender DESC
	
	IF @@ROWCOUNT <= 0 BEGIN
		SELECT -1
		ROLLBACK TRANSACTION
		RETURN
	END
	
	SELECT @@IDENTITY
COMMIT TRANSACTION

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[MSG_GetThreadUsers]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[MSG_GetThreadUsers]
GO

CREATE PROCEDURE [dbo].[MSG_GetThreadUsers]
	@ApplicationID	uniqueidentifier,
	@UserID			UNIQUEIDENTIFIER,
    @strThreadIDs	VARCHAR(MAX),
    @delimiter		CHAR,
	@Count			INT,
	@LastID			INT
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON

	DECLARE @ThreadIDs GuidTableType

	INSERT INTO @ThreadIDs
	SELECT Ref.Value FROM [dbo].[GFN_StrToGuidTable](@strThreadIDs, @delimiter) AS Ref
	
	DECLARE @MessageIDs GuidPairTableType

	;WITH X AS (
		SELECT MD.ThreadID, MIN(MD.ID) AS MinID
		FROM @ThreadIDs AS T
			INNER JOIN [dbo].[MSG_MessageDetails] AS MD
			ON MD.ApplicationID = @ApplicationID AND MD.ThreadID = T.Value
		GROUP BY MD.ThreadID
	)
	INSERT INTO @MessageIDs(FirstValue, SecondValue)
	SELECT MD.ThreadID, MD.MessageID
	FROM X
		INNER JOIN [dbo].[MSG_MessageDetails] AS MD
		ON MD.ApplicationID = @ApplicationID AND MD.ID = X.MinID

	;WITH Y AS (
		SELECT *
		FROM (
				SELECT  ROW_NUMBER() OVER (PARTITION BY MD.ThreadID ORDER BY MD.ID DESC) AS RowNumber, 
						ROW_NUMBER() OVER (PARTITION BY MD.ThreadID ORDER BY MD.ID ASC) AS RevRowNumber,
						MD.ThreadID, MD.UserID
				FROM @MessageIDs AS M
					INNER JOIN [dbo].[MSG_MessageDetails] AS MD
					ON MD.ThreadID = M.FirstValue AND MD.MessageID = M.SecondValue
				WHERE MD.ApplicationID = @ApplicationID AND MD.UserID NOT IN (SELECT @UserID)
			) AS Ref
		WHERE Ref.RowNumber > ISNULL(@LastID, 0) AND Ref.RowNumber <= (ISNULL(@LastID, 0) + ISNULL(@Count, 3))
	)
	SELECT	Y.ThreadID, 
			Y.UserID, 
			UN.UserName, 
			UN.FirstName, 
			UN.LastName,
			Y.RevRowNumber
	FROM Y
		INNER JOIN [dbo].[Users_Normal] AS UN
		ON UN.ApplicationID = @ApplicationID AND UN.UserID = Y.UserID
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[MSG_RemoveMessages]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[MSG_RemoveMessages]
GO

CREATE PROCEDURE [dbo].[MSG_RemoveMessages]
	@ApplicationID	uniqueidentifier,
    @UserID			UNIQUEIDENTIFIER,
    @ThreadID		UNIQUEIDENTIFIER,
    @ID				BIGINT
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON

	UPDATE [dbo].[MSG_MessageDetails]
		SET Deleted = 1
	WHERE ApplicationID = @ApplicationID AND (@ID IS NOT NULL AND ID = @ID) OR  
		(@ID IS NULL AND UserID = @UserID AND ThreadID = @ThreadID)
		
		
	SELECT @@ROWCOUNT
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[MSG_SetMessagesAsSeen]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[MSG_SetMessagesAsSeen]
GO

CREATE PROCEDURE [dbo].[MSG_SetMessagesAsSeen]
	@ApplicationID	uniqueidentifier,
    @UserID			uniqueidentifier,
    @ThreadID		uniqueidentifier,
    @Now			datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON

	IF @UserID IS NOT NULL AND @ThreadID IS NOT NULL BEGIN
		UPDATE MD
			SET Seen = 1,
				ViewDate = ISNULL(ViewDate, @Now)
		FROM [dbo].[MSG_MessageDetails] AS MD
		WHERE MD.ApplicationID = @ApplicationID AND
			MD.UserID = @UserID AND MD.ThreadID = @ThreadID AND ViewDate IS NULL
		
		SELECT 1
	END
	ELSE SELECT 0
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[MSG_GetNotSeenMessagesCount]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[MSG_GetNotSeenMessagesCount]
GO

CREATE PROCEDURE [dbo].[MSG_GetNotSeenMessagesCount]
	@ApplicationID	uniqueidentifier,
    @UserID			uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON

	SELECT COUNT(MD.ID)
	FROM [dbo].[MSG_MessageDetails] AS MD
	WHERE MD.ApplicationID = @ApplicationID AND
		MD.UserID = @UserID AND MD.IsSender = 0 AND MD.Seen = 0 AND MD.Deleted = 0
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[MSG_GetMessageReceivers]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[MSG_GetMessageReceivers]
GO

CREATE PROCEDURE [dbo].[MSG_GetMessageReceivers]
	@ApplicationID	uniqueidentifier,
    @strMessageIDs	NVARCHAR(MAX),
    @delimiter		CHAR,
	@Count			INT,
	@LastID			INT
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON

	DECLARE @MessageIDs GuidTableType

	INSERT INTO @MessageIDs
	SELECT Ref.Value FROM [dbo].[GFN_StrToGuidTable](@strMessageIDs, @delimiter) AS Ref
	
	;WITH Y AS (
		SELECT *
		FROM (
				SELECT  ROW_NUMBER() OVER (PARTITION BY MD.MessageID ORDER BY MD.ID DESC) AS RowNumber, 
						ROW_NUMBER() OVER (PARTITION BY MD.MessageID ORDER BY MD.ID ASC) AS RevRowNumber,
						MD.MessageID, MD.UserID
				FROM @MessageIDs AS R
					INNER JOIN [dbo].[MSG_MessageDetails] AS MD
					ON MD.MessageID = R.Value
				WHERE MD.ApplicationID = @ApplicationID AND MD.IsSender = 0
			) AS Ref
		WHERE Ref.RowNumber > ISNULL(@LastID, 0) AND Ref.RowNumber <= (ISNULL(@LastID, 0) + ISNULL(@Count, 3))
	)
	SELECT	Y.MessageID, 
			Y.UserID, 
			UN.UserName, 
			UN.FirstName, 
			UN.LastName,
			Y.RevRowNumber
	FROM Y
		INNER JOIN [dbo].[Users_Normal] AS UN
		ON UN.ApplicationID = @ApplicationID AND UN.UserID = Y.UserID
END

Go


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[MSG_GetForwardedMessages]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[MSG_GetForwardedMessages]
GO

CREATE PROCEDURE [dbo].[MSG_GetForwardedMessages]
	@ApplicationID	uniqueidentifier,
	@MessageID		UNIQUEIDENTIFIER
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @hierarchyMessages AS TABLE (
		MessageID UNIQUEIDENTIFIER,
		IsGroup BIT,
		ForwardedFrom UNIQUEIDENTIFIER,
		[Level] INT
	)
	
	;WITH hierarchy (MessageID, ForwardedFrom, [Level])
	AS
	(
		SELECT m.MessageID AS MessageID, ForwardedFrom, 0 AS [Level]
		FROM [dbo].[MSG_Messages] as m
		WHERE m.ApplicationID = @ApplicationID AND MessageID = @MessageID
		
		UNION ALL
		
		SELECT m.MessageID AS MessageID, m.ForwardedFrom , [Level] + 1
		FROM [dbo].[MSG_Messages] AS m
			INNER JOIN hierarchy AS HR
			ON m.MessageID = HR.ForwardedFrom
		WHERE m.ApplicationID = @ApplicationID AND m.MessageID <> HR.MessageID
	)
	INSERT INTO @hierarchyMessages(
		MessageID, 
		IsGroup, 
		ForwardedFrom, 
		[Level]
	)
	SELECT 
		Ref.MessageID AS MessageID, 
		MD.IsGroup, 
		Ref.ForwardedFrom,
		Ref.[Level]
	FROM (
			SELECT hm.MessageID, hm.ForwardedFrom, hm.[Level] , MAX(MD.ID) AS ID
			FROM hierarchy AS hm
				INNER JOIN [dbo].[MSG_MessageDetails] AS MD
				ON MD.ApplicationID = @ApplicationID AND MD.MessageID = hm.MessageID
			GROUP BY hm.MessageID, hm.ForwardedFrom, hm.[Level]
		) AS Ref
		INNER JOIN [dbo].[MSG_MessageDetails] AS MD
		ON MD.ApplicationID = @ApplicationID AND MD.ID = Ref.ID
	
	SELECT 
		M.MessageID,
		M.MessageText,
		M.Title,
		M.SendDate,
		M.HasAttachment,
		H.ForwardedFrom,
		H.[Level],
		H.IsGroup,
		M.SenderUserID,
		UN.UserName AS SenderUserName,
		UN.FirstName AS SenderFirstName,
		UN.LastName AS SenderLastName
	FROM @hierarchyMessages AS H
		INNER JOIN [dbo].[MSG_Messages] AS M
		ON M.ApplicationID = @ApplicationID AND M.MessageID = H.MessageID
		INNER JOIN [dbo].[Users_Normal] AS UN
		ON UN.ApplicationID = @ApplicationID AND UN.UserID = M.SenderUserID
	ORDER BY H.[Level] ASC
END

GO



SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[RV_OveralReport]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[RV_OveralReport]
GO

CREATE PROCEDURE [dbo].[RV_OveralReport]
	@ApplicationID	uniqueidentifier,
	@CurrentUserID	uniqueidentifier,
	@BeginDate		datetime,
	@FinishDate		datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON

	SELECT N' ' AS ItemName, COUNT(Ref.UserID) AS [Count]
	FROM [dbo].[Users_Normal] AS Ref
	WHERE Ref.ApplicationID = @ApplicationID AND 
		(@BeginDate IS NULL OR Ref.CreationDate >= @BeginDate) AND
		(@FinishDate IS NULL OR Ref.CreationDate <= @FinishDate) AND Ref.IsApproved = 1
			
	UNION ALL
	
	SELECT N'     ' AS ItemName, COUNT(Ref.UserID) AS [Count]
	FROM [dbo].[Users_Normal] AS Ref
	WHERE Ref.ApplicationID = @ApplicationID AND
		Ref.FirstName IS NOT NULL AND Ref.FirstName <> N'' AND
		Ref.LastName IS NOT NULL AND Ref.LastName <> N'' AND
		(@BeginDate IS NULL OR Ref.CreationDate >= @BeginDate) AND
		(@FinishDate IS NULL OR Ref.CreationDate <= @FinishDate) AND Ref.IsApproved = 1
			
	UNION ALL
	
	SELECT N'  ' + ' (' + N'15 ' + N')' AS ItemName, COUNT(Ref.UserID) AS [Count]
	FROM [dbo].[Users_Normal] AS Ref
	WHERE Ref.ApplicationID = @ApplicationID AND
		Ref.LastActivityDate >= DATEADD(DAY, -15, GETDATE()) AND Ref.IsApproved = 1
			
	UNION ALL
	
	SELECT N'  ' + ' (' + N'30 ' + N')' AS ItemName, COUNT(Ref.UserID) AS [Count]
	FROM [dbo].[Users_Normal] AS Ref
	WHERE Ref.ApplicationID = @ApplicationID AND
		Ref.LastActivityDate >= DATEADD(DAY, -30, GETDATE()) AND Ref.IsApproved = 1

	UNION ALL

	SELECT N'  ', COUNT(QuestionID)
	FROM [dbo].[QA_Questions]
	WHERE ApplicationID = @ApplicationID AND Deleted = 0 AND
		(@BeginDate IS NULL OR SendDate >= @BeginDate) AND
		(@FinishDate IS NULL OR SendDate <= @FinishDate)
		
	UNION ALL

	SELECT N'     ', COUNT(QuestionID)
	FROM [dbo].[QA_Questions]
	WHERE ApplicationID = @ApplicationID AND [Status] = N'Accepted' AND 
		PublicationDate IS NOT NULL AND Deleted = 0 AND 
		(@BeginDate IS NULL OR SendDate >= @BeginDate) AND
		(@FinishDate IS NULL OR SendDate <= @FinishDate)
		
	UNION ALL

	SELECT N'    ' + ' (' + N'  ' + N')', COUNT(EX.UserID) 
	FROM [dbo].[CN_Experts] AS EX
		INNER JOIN [dbo].[Users_Normal] AS UN
		ON UN.ApplicationID = @ApplicationID AND UN.[UserID] = EX.[UserID]
		INNER JOIN [dbo].[CN_View_Nodes_Normal] AS ND
		ON ND.ApplicationID = @ApplicationID AND ND.[NodeID] = EX.[NodeID]
	WHERE EX.ApplicationID = @ApplicationID AND 
		(EX.Approved = 1 OR EX.SocialApproved = 1) AND
		UN.IsApproved = 1 AND ND.Deleted = 0
		
		
	UNION ALL

	SELECT N'  ' + N' (' + N'  ' + N')', COUNT(CNT)
	FROM (
			SELECT COUNT(UN.UserID) AS CNT
			FROM [dbo].[CN_Experts] AS EX
				INNER JOIN [dbo].[Users_Normal] AS UN
				ON UN.ApplicationID = @ApplicationID AND UN.[UserID] = EX.[UserID]
				INNER JOIN [dbo].[CN_View_Nodes_Normal] AS ND
				ON ND.ApplicationID = @ApplicationID AND ND.[NodeID] = EX.[NodeID]
			WHERE EX.ApplicationID = @ApplicationID AND 
				(EX.Approved = 1 OR EX.SocialApproved = 1) AND
				UN.IsApproved = 1 AND ND.[Deleted] = 0
			GROUP BY UN.[UserID]
		) AS Ref
	
	UNION ALL

	SELECT N'    ', COUNT(SL.ShareID)
	FROM [dbo].[SH_ShareLikes] AS SL
	WHERE SL.ApplicationID = @ApplicationID AND SL.[Like] = 1 AND
		(@BeginDate IS NULL OR SL.[Date] >= @BeginDate) AND
		(@FinishDate IS NULL OR SL.[Date] <= @FinishDate)
		
	UNION ALL

	SELECT N'    ', COUNT(SL.CommentID)
	FROM [dbo].[SH_CommentLikes] AS SL
	WHERE SL.ApplicationID = @ApplicationID AND SL.[Like] = 1 AND
		(@BeginDate IS NULL OR SL.[Date] >= @BeginDate) AND
		(@FinishDate IS NULL OR SL.[Date] <= @FinishDate)
		
	UNION ALL

	SELECT N'   ', COUNT(NL.NodeID)
	FROM [dbo].[CN_NodeLikes] AS NL
	WHERE NL.ApplicationID = @ApplicationID AND NL.[Deleted] = 0 AND
		(@BeginDate IS NULL OR NL.[LikeDate] >= @BeginDate) AND
		(@FinishDate IS NULL OR NL.[LikeDate] <= @FinishDate)
			
	UNION ALL

	SELECT N'  ', COUNT(PS.ShareID)
	FROM [dbo].[SH_PostShares] AS PS
	WHERE PS.ApplicationID = @ApplicationID AND PS.[Deleted] = 0 AND
		(@BeginDate IS NULL OR PS.[SendDate] >= @BeginDate) AND
		(@FinishDate IS NULL OR PS.[SendDate] <= @FinishDate)
	
	UNION ALL

	SELECT N'  ', COUNT(C.CommentID)
	FROM [dbo].[SH_Comments] AS C
	WHERE C.ApplicationID = @ApplicationID AND C.[Deleted] = 0 AND
		(@BeginDate IS NULL OR C.[SendDate] >= @BeginDate) AND
		(@FinishDate IS NULL OR C.[SendDate] <= @FinishDate)
		
	UNION ALL

	SELECT N'  ', COUNT(KnowledgeID)
	FROM [dbo].[KW_View_Knowledges]
	WHERE ApplicationID = @ApplicationID AND Deleted = 0 AND
		(@BeginDate IS NULL OR CreationDate >= @BeginDate) AND
		(@FinishDate IS NULL OR CreationDate <= @FinishDate)

	UNION ALL

	SELECT N'    ', COUNT(KnowledgeID)
	FROM [dbo].[KW_View_Knowledges]
	WHERE ApplicationID = @ApplicationID AND 
		[Status] = N'Accepted' AND Deleted = 0 AND
		(@BeginDate IS NULL OR ISNULL(PublicationDate, CreationDate) >= @BeginDate) AND
		(@FinishDate IS NULL OR ISNULL(PublicationDate, CreationDate) <= @FinishDate)
			
	UNION ALL
	
	SELECT X.ItemName, X.[Count]
	FROM (
			SELECT TOP(1000000) A.ItemName, A.[Count]
			FROM (
					SELECT	(N' ' + NT.Name + (CASE WHEN Ref.[Type] = N'Count' THEN N'' ELSE N' -  ' END)) AS ItemName, 
							ISNULL(Ref.[Count], 0) AS [Count],
							ISNULL(Ref.TotalCount, 0) AS TotalCount
					FROM (
							SELECT	NodeTypeID, 
									COUNT(NodeID) AS [Count], 
									COUNT(NodeID) AS TotalCount, 
									N'Count' AS [Type]
							FROM [dbo].[CN_View_Nodes_Normal]
							WHERE ApplicationID = @ApplicationID AND Deleted = 0 AND
								(@BeginDate IS NULL OR CreationDate >= @BeginDate) AND
								(@FinishDate IS NULL OR CreationDate <= @FinishDate)
							GROUP BY NodeTypeID
							
							UNION ALL
							
							SELECT	NodeTypeID, 
									SUM(CAST((CASE WHEN ISNULL(Searchable, 1) = 1 THEN 1 ELSE 0 END) AS int)) AS [Count],
									COUNT(NodeID) AS TotalCount,
									N'Published' AS [Type]
							FROM [dbo].[CN_View_Nodes_Normal]
							WHERE ApplicationID = @ApplicationID AND Deleted = 0 AND
								(@BeginDate IS NULL OR CreationDate >= @BeginDate) AND
								(@FinishDate IS NULL OR CreationDate <= @FinishDate)
							GROUP BY NodeTypeID
						) AS Ref
						RIGHT JOIN [dbo].[CN_NodeTypes] AS NT
						ON NT.ApplicationID = @ApplicationID AND NT.NodeTypeID = Ref.NodeTypeID
					WHERE NT.ApplicationID = @ApplicationID AND NT.Deleted = 0
				) AS A
			ORDER BY A.TotalCount DESC, A.ItemName ASC
		) AS X
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[RV_LogsReport]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[RV_LogsReport]
GO

CREATE PROCEDURE [dbo].[RV_LogsReport]
	@ApplicationID		uniqueidentifier,
	@CurrentUserID		uniqueidentifier,
	@UserID				uniqueidentifier,
	@ActionsTemp		StringTableType readonly,
	@IPAddressesTemp	StringTableType readonly,
	@Level				varchar(20),
	@NotAuthorized		bit,
	@Anonymous			bit,
	@BeginDate			datetime,
	@FinishDate			datetime,
	@Count				int,
	@LowerBoundary		bigint
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @Actions StringTableType
	INSERT INTO @Actions SELECT * FROM @ActionsTemp
	
	DECLARE @ActionExists bit = CASE WHEN EXISTS(SELECT TOP(1) * FROM @Actions) THEN 1 ELSE 0 END
	
	DECLARE @IPAddresses StringTableType
	INSERT INTO @IPAddresses SELECT * FROM @IPAddressesTemp
	
	DECLARE @IPExists bit = CASE WHEN EXISTS(SELECT TOP(1) * FROM @IPAddresses) THEN 1 ELSE 0 END
	
	IF @NotAuthorized IS NULL SET @NotAuthorized = 0
	IF @Level = N'' SET @Level = NULL
	
	DECLARE @Empty uniqueidentifier = N'00000000-0000-0000-0000-000000000000'
	
	SET @Anonymous = ISNULL(@Anonymous, 0)
	IF @Anonymous = 1 SET @UserID = NULL
	
	SELECT TOP(ISNULL(@Count, 2000))
		(Ref.RowNumber_Hide + Ref.RevRowNumber_Hide - 1) AS TotalCount_Hide,
		Ref.*
	FROM (
			SELECT	ROW_NUMBER() OVER (ORDER BY LG.LogID DESC) AS RowNumber_Hide,
					ROW_NUMBER() OVER (ORDER BY LG.LogID ASC) AS RevRowNumber_Hide,
					LG.LogID AS LogID_Hide,
					UN.UserID AS UserID_Hide,
					RTRIM(LTRIM(ISNULL(UN.FirstName, N'') + N' ' + 
						ISNULL(UN.LastName, N''))) AS FullName,
					LG.[Action] AS Action_Dic,
					LG.[Level] AS Level_Dic,
					CASE 
						WHEN ISNULL(LG.NotAuthorized, 0) = 0 THEN N'' 
						ELSE N'' 
					END AS NotAuthorized,
					LG.[Date],
					LG.HostAddress,
					LG.HostName,
					CASE 
						WHEN LG.SubjectID = @Empty THEN NULL 
						ELSE LG.SubjectID
					END AS SubjectID,
					DelFirst.ObjectType AS FirstType_Hide,
					LG.SecondSubjectID,
					DelSecond.ObjectType AS SecondType_Hide,
					LG.ThirdSubjectID,
					DelThird.ObjectType AS ThirdType_Hide,
					LG.FourthSubjectID,
					DelFourth.ObjectType AS FourthType_Hide,
					LG.Info AS Info_HideC
			FROM [dbo].[LG_Logs] AS LG
				LEFT JOIN [dbo].[Users_Normal] AS UN
				ON UN.ApplicationID = @ApplicationID AND UN.UserID = LG.UserID
				LEFT JOIN [dbo].[RV_DeletedStates] AS DelFirst
				ON DelFirst.ApplicationID = @ApplicationID AND
					DelFirst.ObjectID = LG.SubjectID
				LEFT JOIN [dbo].[RV_DeletedStates] AS DelSecond
				ON DelSecond.ApplicationID = @ApplicationID AND
					DelSecond.ObjectID = LG.SecondSubjectID
				LEFT JOIN [dbo].[RV_DeletedStates] AS DelThird
				ON DelThird.ApplicationID = @ApplicationID AND
					DelThird.ObjectID = LG.ThirdSubjectID
				LEFT JOIN [dbo].[RV_DeletedStates] AS DelFourth
				ON DelFourth.ApplicationID = @ApplicationID AND
					DelFourth.ObjectID = LG.FourthSubjectID
			WHERE LG.ApplicationID = @ApplicationID AND 
				(@UserID IS NULL OR LG.UserID = @UserID) AND
				(@Anonymous = 0 OR LG.UserID = @Empty) AND
				(@ActionExists = 0 OR LG.[Action] IN (SELECT * FROM @Actions)) AND
				(@IPExists = 0 OR LG.HostAddress IN (SELECT * FROM @IPAddresses)) AND
				(@Level IS NULL OR LG.[Level] = @Level) AND
				(@BeginDate IS NULL OR LG.[Date] >= @BeginDate) AND
				(@FinishDate IS NULL OR LG.[Date] <= @FinishDate) AND
				(@NotAuthorized = 0 OR LG.NotAuthorized = 1)
		) AS Ref
	WHERE Ref.RowNumber_Hide >= ISNULL(@LowerBoundary, 0)
	ORDER BY Ref.RowNumber_Hide ASC
	
	SELECT ('{' +
			'"FullName": {"Action": "Link", "Type": "User",' +
				'"Requires": {"UID": "UserID_Hide"}' +
			'},' +
			'"Action_Dic": {"Action": "JSON", "Shows": "Info_HideC"},' +
			'"SubjectID": {"Action": "Link", "Type": "[[FirstType_Hide]]",' +
				'"Requires": {"ID": "SubjectID"}' +
			'},' +
			'"SecondSubjectID": {"Action": "Link", "Type": "[[SecondType_Hide]]",' +
				'"Requires": {"ID": "SecondSubjectID"}' +
			'},' +
			'"ThirdSubjectID": {"Action": "Link", "Type": "[[ThirdType_Hide]]",' +
				'"Requires": {"ID": "ThirdSubjectID"}' +
			'},' +
			'"FourthSubjectID": {"Action": "Link", "Type": "[[FourthType_Hide]]",' +
				'"Requires": {"ID": "FourthSubjectID"}' +
			'}' +
		   '}') AS Actions
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[RV_ErrorLogsReport]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[RV_ErrorLogsReport]
GO

CREATE PROCEDURE [dbo].[RV_ErrorLogsReport]
	@ApplicationID	uniqueidentifier,
	@CurrentUserID	uniqueidentifier,
	@Level			varchar(20),
	@BeginDate		datetime,
	@FinishDate		datetime,
	@Count			int,
	@LowerBoundary	bigint
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	IF @Level = N'' SET @Level = NULL
	
	SELECT TOP(ISNULL(@Count, 2000))
		(Ref.RowNumber_Hide + Ref.RevRowNumber_Hide - 1) AS TotalCount_Hide,
		Ref.*
	FROM (
			SELECT	ROW_NUMBER() OVER (ORDER BY LG.LogID DESC) AS RowNumber_Hide,
					ROW_NUMBER() OVER (ORDER BY LG.LogID ASC) AS RevRowNumber_Hide,
					LG.LogID AS LogID_Hide,
					LG.[Subject],
					LG.[Level] AS Level_Dic,
					LG.[Description] AS Description_HideC,
					LG.[Date]
			FROM [dbo].[LG_ErrorLogs] AS LG
			WHERE LG.ApplicationID = @ApplicationID AND 
				(@Level IS NULL OR LG.[Level] = @Level) AND
				(@BeginDate IS NULL OR LG.[Date] >= @BeginDate) AND
				(@FinishDate IS NULL OR LG.[Date] <= @FinishDate)
		) AS Ref
	WHERE Ref.RowNumber_Hide >= ISNULL(@LowerBoundary, 0)
	ORDER BY Ref.RowNumber_Hide ASC
	
	SELECT ('{' +
			'"Subject": {"Action": "Show", "Shows": "Description_HideC"}' +
		   '}') AS Actions
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[RV_ApplicationsPerformanceReport]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[RV_ApplicationsPerformanceReport]
GO

CREATE PROCEDURE [dbo].[RV_ApplicationsPerformanceReport]
	@ApplicationID			uniqueidentifier,
	@CurrentUserID			uniqueidentifier,
	@strTeamIDs varchar(max),
	@delimiter	char,
	@DateFrom	datetime,
	@DateMiddle datetime,
	@DateTo		datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @TeamIDs GuidTableType

	INSERT INTO @TeamIDs ([Value])
	SELECT Ref.[Value] 
	FROM [dbo].[GFN_StrToGuidTable](@strTeamIDs, @delimiter) AS Ref

	DECLARE @TeamsCount int = (SELECT COUNT(*) FROM @TeamIDs)
	DECLARE @NodeIDs GuidTableType
	DECLARE @Archive bit = 0

	;WITH Applications
	AS
	(
		SELECT	App.ApplicationId AS ApplicationID, 
				App.Title,
				(
					SELECT COUNT(*)
					FROM [dbo].[USR_UserApplications] AS U
					WHERE U.ApplicationID = App.ApplicationId
				) AS MembersCount,
				(
					SELECT COUNT(*)
					FROM [dbo].[CN_NodeTypes] AS NT
						LEFT JOIN [dbo].[CN_Services] AS S
						ON S.ApplicationID = App.ApplicationId AND S.NodeTypeID = NT.NodeTypeID
					WHERE NT.ApplicationID = App.ApplicationId AND NT.Deleted = 0 AND ISNULL(S.ServiceTitle, N'') <> N''
				) AS TemplatesCount
		FROM [dbo].[aspnet_Applications] AS App
		WHERE ((@TeamsCount = 0 AND ISNULL(App.Deleted, 0) = 0) OR App.ApplicationId IN (SELECT T.[Value] FROM @TeamIDs AS T))
	),
	Nodes
	AS
	(
		SELECT	App.ApplicationID,
				ND.NodeTypeID,
				ND.NodeID,
				ND.TypeName AS NodeType, 
				ND.NodeName, 
				ND.NodeAdditionalID AS AdditionalID, 
				ND.CreationDate,
				(CASE 
					WHEN ND.CreationDate >= @DateFrom AND ND.CreationDate < DATEADD(DAY, 1, @DateMiddle) THEN 1 
					WHEN ND.CreationDate >= DATEADD(DAY, 1, @DateMiddle) AND ND.CreationDate < DATEADD(DAY, 1, @DateTo) THEN 2
					ELSE 0
				END) AS [Period],
				ISNULL(Email.EmailAddress, USR.UserName) AS CreatorUserName,
				LTRIM(RTRIM(ISNULL(USR.FirstName, N'') + N' ' + ISNULL(USR.LastName, N''))) AS CreatorFullName
		FROM Applications AS App
			INNER JOIN [dbo].[CN_View_Nodes_Normal] AS ND
			ON ND.ApplicationID = App.ApplicationID AND 
				(@Archive IS NULL OR ND.Deleted = @Archive)
			INNER JOIN [dbo].[USR_View_Users] AS USR
			ON USR.UserID = ND.CreatorUserID
			LEFT JOIN [dbo].[USR_EmailAddresses] AS Email
			ON Email.EmailID = USR.MainEmailID
	),
	Files
	AS
	(
		SELECT	ND.ApplicationID, 
				Files.FileID,
				Files.[FileName],
				Files.Extension,
				Files.Size,
				Files.OwnerType,
				Files.CreationDate,
				Files.CreatorUserID,
				Files.Deleted AS FileArchived,
				(CASE 
					WHEN Files.CreationDate >= @DateFrom AND Files.CreationDate < DATEADD(DAY, 1, @DateMiddle) THEN 1 
					WHEN Files.CreationDate >= DATEADD(DAY, 1, @DateMiddle) AND Files.CreationDate < DATEADD(DAY, 1, @DateTo) THEN 2
					ELSE 0
				END) AS [Period]
		FROM Nodes AS ND
			INNER JOIN [dbo].[DCT_FN_ListDeepAttachments](@TeamIDs, @NodeIDs, @Archive) AS Files
			ON Files.ApplicationID = ND.ApplicationID AND Files.NodeID = ND.NodeID
	),
	Visits
	AS
	(
		SELECT X.ApplicationID, X.[Period], COUNT(X.UniqueID) AS VisitsCount, COUNT(DISTINCT X.NodeID) AS VisitedNodesCount
		FROM (
				SELECT	ND.ApplicationID,
						V.UniqueID,
						ND.NodeID, 
						V.VisitDate, 
						(CASE 
							WHEN V.VisitDate >= @DateFrom AND V.VisitDate < DATEADD(DAY, 1, @DateMiddle) THEN 1 
							WHEN V.VisitDate >= DATEADD(DAY, 1, @DateMiddle) AND V.VisitDate < DATEADD(DAY, 1, @DateTo) THEN 2
							ELSE 0
						END) AS [Period]
				FROM Nodes AS ND
					INNER JOIN [dbo].[USR_ItemVisits] AS V
					ON V.ApplicationID = ND.ApplicationID AND V.ItemID = ND.NodeID
			) AS X
		GROUP BY X.ApplicationID, X.[Period]
	),
	Logs
	AS
	(
		SELECT X.ApplicationID, X.[Action], X.[Period], COUNT(X.LogID) AS [Count]
		FROM (
				SELECT	App.ApplicationID,
						LG.LogID, 
						LG.[Date], 
						LG.[Action],
						(CASE 
							WHEN LG.[Date] >= @DateFrom AND LG.[Date] < DATEADD(DAY, 1, @DateMiddle) THEN 1 
							WHEN LG.[Date] >= DATEADD(DAY, 1, @DateMiddle) AND LG.[Date] < DATEADD(DAY, 1, @DateTo) THEN 2
							ELSE 0
						END) AS [Period]
				FROM Applications AS App
					INNER JOIN [dbo].[LG_Logs] AS LG
					ON LG.ApplicationID = App.ApplicationID AND LG.[Action] IN ('Login', 'Search')
			) AS X
		GROUP BY X.ApplicationID, X.[Action], X.[Period]
	),
	AggregatedNodes
	AS
	(
		SELECT	App.ApplicationID,
				ISNULL(COUNT(N.NodeID), 0) AS CreatedNodesCount,
				ISNULL(COUNT(CASE WHEN N.[Period] = 1 THEN N.NodeID ELSE NULL END), 0) AS CreatedNodesCount_1,
				ISNULL(COUNT(CASE WHEN N.[Period] = 2 THEN N.NodeID ELSE NULL END), 0) AS CreatedNodesCount_2,
				ISNULL(COUNT(DISTINCT N.NodeTypeID), 0) AS UsedTemplatesCount,
				ISNULL(COUNT(DISTINCT CASE WHEN N.[Period] = 1 THEN N.NodeTypeID ELSE NULL END), 0) AS UsedTemplatesCount_1,
				ISNULL(COUNT(DISTINCT CASE WHEN N.[Period] = 2 THEN N.NodeTypeID ELSE NULL END), 0) AS UsedTemplatesCount_2
		FROM Applications AS App
			INNER JOIN Nodes AS N
			ON N.ApplicationID = App.ApplicationID
		GROUP BY App.ApplicationID
	),
	AggregatedLogin
	AS 
	(
		SELECT	App.ApplicationID,
				ISNULL(SUM(L.[Count]), 0) AS LoginCount,
				ISNULL(SUM(CASE WHEN L.[Period] = 1 THEN L.[Count] ELSE 0 END), 0) AS LoginCount_1,
				ISNULL(SUM(CASE WHEN L.[Period] = 2 THEN L.[Count] ELSE 0 END), 0) AS LoginCount_2
		FROM Applications AS App
			INNER JOIN Logs AS L
			ON L.ApplicationID = App.ApplicationID AND L.[Action] = N'Login'
		GROUP BY App.ApplicationID
	),
	AggregatedSearch
	AS 
	(
		SELECT	App.ApplicationID,
				ISNULL(SUM(L.[Count]), 0) AS SearchCount,
				ISNULL(SUM(CASE WHEN L.[Period] = 1 THEN L.[Count] ELSE 0 END), 0) AS SearchCount_1,
				ISNULL(SUM(CASE WHEN L.[Period] = 2 THEN L.[Count] ELSE 0 END), 0) AS SearchCount_2
		FROM Applications AS App
			INNER JOIN Logs AS L
			ON L.ApplicationID = App.ApplicationID AND L.[Action] = N'Search'
		GROUP BY App.ApplicationID
	),
	AggregatedFiles
	AS
	(
		SELECT	App.ApplicationID,
				ISNULL(COUNT(F.FileID), 0) AS Attachments,
				ISNULL(COUNT(CASE WHEN F.[Period] = 1 THEN F.FileID ELSE NULL END), 0) AS Attachments_1,
				ISNULL(COUNT(CASE WHEN F.[Period] = 2 THEN F.FileID ELSE NULL END), 0) AS Attachments_2,
				ROUND(CAST(SUM(ISNULL(F.Size, 0)) AS float) / 1024 / 1024, 2) AS AttachmentSizeMB,
				ROUND(CAST(SUM(ISNULL(CASE WHEN F.[Period] = 1 THEN F.Size ELSE 0 END, 0)) AS float) / 1024 / 1024, 2) AS AttachmentSizeMB_1,
				ROUND(CAST(SUM(ISNULL(CASE WHEN F.[Period] = 2 THEN F.Size ELSE 0 END, 0)) AS float) / 1024 / 1024, 2) AS AttachmentSizeMB_2
		FROM Applications AS App
			INNER JOIN Files AS F
			ON F.ApplicationID = App.ApplicationID
		GROUP BY App.ApplicationID
	),
	Aggregated
	AS
	(
		SELECT	App.Title,
				App.MembersCount,
				App.TemplatesCount AS TotalTemplatesCount,
				ISNULL(ND.CreatedNodesCount, 0) AS CreatedNodesCount,
				ISNULL(ND.CreatedNodesCount_1, 0) AS CreatedNodesCount_1,
				ISNULL(ND.CreatedNodesCount_2, 0) AS CreatedNodesCount_2,
				ISNULL(ND.UsedTemplatesCount, 0) AS UsedTemplatesCount,
				ISNULL(ND.UsedTemplatesCount_1, 0) AS UsedTemplatesCount_1,
				ISNULL(ND.UsedTemplatesCount_2, 0) AS UsedTemplatesCount_2,
				ISNULL(LG.LoginCount, 0) AS LoginCount,
				ISNULL(LG.LoginCount_1, 0) AS LoginCount_1,
				ISNULL(LG.LoginCount_2, 0) AS LoginCount_2,
				ISNULL(SH.SearchCount, 0) AS SearchCount,
				ISNULL(SH.SearchCount_1, 0) AS SearchCount_1,
				ISNULL(SH.SearchCount_2, 0) AS SearchCount_2,
				ISNULL(F.Attachments, 0) AS Attachments,
				ISNULL(F.Attachments_1, 0) AS Attachments_1,
				ISNULL(F.Attachments_2, 0) AS Attachments_2,
				ISNULL(F.AttachmentSizeMB, 0) AS AttachmentSizeMB,
				ISNULL(F.AttachmentSizeMB_1, 0) AS AttachmentSizeMB_1,
				ISNULL(F.AttachmentSizeMB_2, 0) AS AttachmentSizeMB_2
		FROM Applications AS App
			LEFT JOIN AggregatedNodes AS ND
			ON ND.ApplicationID = App.ApplicationID
			LEFT JOIN AggregatedLogin AS LG
			ON LG.ApplicationID = App.ApplicationID
			LEFT JOIN AggregatedSearch AS SH
			ON SH.ApplicationID = App.ApplicationID
			LEFT JOIN AggregatedFiles AS F
			ON F.ApplicationID = App.ApplicationID
	)
	SELECT	A.Title AS TeamName,
			A.MembersCount,
			A.TotalTEmplatesCount,
			A.CreatedNodesCount,
			A.CreatedNodesCount_1,
			A.CreatedNodesCount_2,
			CAST(ROUND((CASE 
				WHEN A.CreatedNodesCount_1 = 0 THEN 0 
				ELSE ((CAST(A.CreatedNodesCount_2 AS float) / CAST(A.CreatedNodesCount_1 AS float)) - 1) * 100
			END), 0) AS varchar(10)) + '%' AS CreatedNodesChange,
			A.UsedTemplatesCount,
			A.UsedTemplatesCount_1,
			A.UsedTemplatesCount_2,
			CAST(ROUND((CASE 
				WHEN A.UsedTemplatesCount_1 = 0 THEN 0 
				ELSE ((CAST(A.UsedTemplatesCount_2 AS float) / CAST(A.UsedTemplatesCount_1 AS float)) - 1) * 100
			END), 0) AS varchar(10)) + '%' AS UsedTemplatesChange,
			A.LoginCount,
			A.LoginCount_1,
			A.LoginCount_2,
			CAST(ROUND((CASE 
				WHEN A.LoginCount_1 = 0 THEN 0 
				ELSE ((CAST(A.LoginCount_2 AS float) / CAST(A.LoginCount_1 AS float)) - 1) * 100
			END), 0) AS varchar(10)) + '%' AS LoginCountChange,
			A.SearchCount,
			A.SearchCount_1,
			A.SearchCount_2,
			CAST(ROUND((CASE 
				WHEN A.SearchCount_1 = 0 THEN 0 
				ELSE ((CAST(A.SearchCount_2 AS float) / CAST(A.SearchCount_1 AS float)) - 1) * 100
			END), 0) AS varchar(10)) + '%' AS SearchCountChange,
			A.Attachments,
			A.Attachments_1,
			A.Attachments_2,
			CAST(ROUND((CASE 
				WHEN A.Attachments_1 = 0 THEN 0 
				ELSE ((CAST(A.Attachments_2 AS float) / CAST(A.Attachments_1 AS float)) - 1) * 100
			END), 0) AS varchar(10)) + '%' AS AttachmentsChange,
			A.AttachmentSizeMB,
			A.AttachmentSizeMB_1,
			A.AttachmentSizeMB_2,
			CAST(ROUND((CASE 
				WHEN A.AttachmentSizeMB_1 = 0 THEN 0 
				ELSE ((CAST(A.AttachmentSizeMB_2 AS float) / CAST(A.AttachmentSizeMB_1 AS float)) - 1) * 100
			END), 0) AS varchar(10)) + '%' AS AttachmentSizeMBChange
	FROM Aggregated AS A
END

GO

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[FG_FormsListReport]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[FG_FormsListReport]
GO

CREATE PROCEDURE [dbo].[FG_FormsListReport]
	@ApplicationID			uniqueidentifier,
	@CurrentUserID			uniqueidentifier,
    @FormID					uniqueidentifier,
    @LowerCreationDateLimit	datetime,
    @UpperCreationDateLimit	datetime,
    @FormFiltersTemp		FormFilterTableType readonly,
    @delimiter				char
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @FormFilters FormFilterTableType
	INSERT INTO @FormFilters SELECT * FROM @FormFiltersTemp
	
	DECLARE @Results Table (
		InstanceID_Hide uniqueidentifier primary key clustered,
		CreationDate datetime,
		CreatorUserID_Hide uniqueidentifier,
		CreatorName nvarchar(1000),
		CreatorUserName nvarchar(1000)
	)
	
	INSERT INTO @Results (
		InstanceID_Hide, 
		CreationDate, 
		CreatorUserID_Hide, 
		CreatorName, 
		CreatorUserName
	)
	SELECT	FI.InstanceID, 
			FI.CreationDate,
			FI.CreatorUserID,
			LTRIM(RTRIM(ISNULL(UN.FirstName, N'') + N' ' + ISNULL(UN.LastName, N''))),
			UN.UserName
	FROM [dbo].[FG_FormInstances] AS FI
		LEFT JOIN [dbo].[Users_Normal] AS UN
		ON UN.ApplicationID = @ApplicationID AND UN.UserID = FI.CreatorUserID
	WHERE FI.ApplicationID = @ApplicationID AND FI.FormID = @FormID AND
		(@LowerCreationDateLimit IS NULL OR FI.CreationDate >= @LowerCreationDateLimit) AND
		(@UpperCreationDateLimit IS NULL OR FI.CreationDate <= @UpperCreationDateLimit) AND
		FI.Deleted = 0
	
	DECLARE @InstanceIDs GuidTableType
		
	INSERT INTO @InstanceIDs
	SELECT Ref.InstanceID_Hide
	FROM @Results AS Ref
	
	IF (SELECT COUNT(Ref.ElementID) FROM @FormFilters AS Ref) > 0 BEGIN
		DELETE I
		FROM @InstanceIDs AS I
			LEFT JOIN [dbo].[FG_FN_FilterInstances](
				@ApplicationID, NULL, @InstanceIDs, @FormFilters, @delimiter, 1
			) AS Ref
			ON Ref.InstanceID = I.Value
		WHERE Ref.InstanceID IS NULL
	END
	
	SELECT R.*
	FROM @InstanceIDs AS I
		INNER JOIN @Results AS R
		ON R.InstanceID_Hide = I.Value
	ORDER BY R.CreationDate DESC
	
	SELECT ('{' +
			'"CreatorName": {"Action": "Link", "Type": "User",' +
				'"Requires": {"UID": "CreatorUserID_Hide"}' +
			'}' +
		   '}') AS Actions

	
	-- Second Part: Describes the Third Part
	SELECT CAST(EFE.ElementID AS varchar(50)) AS ColumnName, EFE.Title AS Translation,
		CASE
			WHEN EFE.[Type] = N'Binary' THEN N'bool'
			WHEN EFE.[Type] = N'Number' THEN N'double'
			WHEN EFE.[Type] = N'Date' THEN N'datetime'
			WHEN EFE.[Type] = N'User' THEN N'user'
			WHEN EFE.[Type] = N'Node' THEN N'node'
			ELSE N'string'
		END AS [Type]
	FROM [dbo].[FG_ExtendedFormElements] AS EFE
	WHERE EFE.ApplicationID = @ApplicationID AND 
		EFE.FormID = @FormID AND EFE.Deleted = 0
	ORDER BY EFE.SequenceNumber ASC
	
	SELECT ('{"IsDescription": "true"}') AS Info
	-- end of Second Part
	
	-- Third Part: The Form Info
	DECLARE @ElementIDs GuidTableType
	DECLARE @FakeOwnerIDs GuidTableType, @FakeFilters FormFilterTableType
	
	EXEC [dbo].[FG_P_GetFormRecords] @ApplicationID, @FormID, @ElementIDs, 
		@InstanceIDs, @FakeOwnerIDs, @FakeFilters, NULL, 1000000, NULL, NULL
	
	SELECT ('{' +
		'"ColumnsMap": "InstanceID_Hide:InstanceID",' +
		'"ColumnsToTransfer": "' + STUFF((
			SELECT ',' + CAST(EFE.ElementID AS varchar(50))
			FROM [dbo].[FG_ExtendedFormElements] AS EFE
			WHERE EFE.ApplicationID = @ApplicationID AND 
				EFE.FormID = @FormID AND EFE.Deleted = 0
			ORDER BY EFE.SequenceNumber ASC
			FOR xml path('a'), type
		).value('.','nvarchar(max)'), 1, 1, '') + '"' +
	   '}') AS Info
	-- End of Third Part
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[FG_PollDetailReport]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[FG_PollDetailReport]
GO

CREATE PROCEDURE [dbo].[FG_PollDetailReport]
	@ApplicationID	uniqueidentifier,
	@CurrentUserID	uniqueidentifier,
    @PollID			uniqueidentifier,
    @NodeTypeID		uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT	A.Title, 
			A.UserID AS UserID_Hide,
			LTRIM(RTRIM(ISNULL(A.FirstName, N'') + N' ' + ISNULL(A.LastName, N''))) AS FullName, 
			A.UserName, 
			A.MembershipNodeID AS NodeID_Hide,
			ND.Name AS NodeName,
			A.Value,
			A.NumberValue
	FROM (
			SELECT	MAX(X.Seq) AS Seq,
					X.UserID,
					MAX(UN.FirstName) AS FirstName, 
					MAX(UN.LastName) AS LastName, 
					MAX(UN.UserName) AS UserName,
					MAX(X.Title) AS Title,
					MAX(X.Value) AS Value,
					MAX(X.FloatValue) AS NumberValue,
					CAST(MAX(CAST(NM.NodeID AS varchar(50))) AS uniqueidentifier) AS MembershipNodeID
			FROM (
					SELECT	I.CreatorUserID AS UserID, 
							FE.ElementID AS ElementID,
							FE.Title,
							FE.SequenceNumber AS Seq,
							[dbo].[FG_FN_ToString](@ApplicationID, E.ElementID, E.[Type], 
								E.TextValue, E.FloatValue, E.BitValue, E.DateValue) AS Value,
							E.FloatValue
					FROM [dbo].[FG_FormInstances] AS I
						INNER JOIN [dbo].[FG_InstanceElements] AS E
						ON E.ApplicationID = @ApplicationID AND E.InstanceID = I.InstanceID AND E.Deleted = 0
						INNER JOIN [dbo].[FG_ExtendedFormElements] AS FE
						ON FE.ApplicationID = @ApplicationID AND FE.ElementID = E.RefElementID AND FE.Deleted = 0
					WHERE I.ApplicationID = @ApplicationID AND I.OwnerID = @PollID AND I.Deleted = 0
				) AS X
				INNER JOIN [dbo].[Users_Normal] AS UN
				ON UN.ApplicationID = @ApplicationID AND UN.UserID = X.UserID
				LEFT JOIN [dbo].[CN_View_NodeMembers] AS NM
				ON @NodeTypeID IS NOT NULL AND NM.ApplicationID = @ApplicationID AND
					NM.NodeTypeID = @NodeTypeID AND NM.UserID = UN.UserID AND NM.IsPending = 0
			WHERE ISNULL(X.Value, N'') <> N''
			GROUP BY X.ElementID, X.UserID
		) AS A
		LEFT JOIN [dbo].[CN_Nodes] AS ND
		ON @NodeTypeID IS NOT NULL AND ND.ApplicationID = @ApplicationID AND ND.NodeID = A.MembershipNodeID
	ORDER BY A.FirstName ASC, A.LastName ASC, A.Seq ASC
	
	SELECT ('{' +
			'"FullName": {"Action": "Link", "Type": "User",' +
				'"Requires": {"UID": "UserID_Hide"}' +
			'},' +
			'"NodeName": {"Action": "Link", "Type": "Node",' +
				'"Requires": {"ID": "NodeID_Hide"}' +
			'}' +
		   '}') AS Actions
END

GO

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_NodesListReport]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_NodesListReport]
GO

CREATE PROCEDURE [dbo].[CN_NodesListReport]
	@ApplicationID			uniqueidentifier,
	@CurrentUserID			uniqueidentifier,
    @NodeTypeID				uniqueidentifier,
    @SearchText				nvarchar(1000),
    @Status					varchar(100),
    @MinContributorsCount	int,
    @LowerCreationDateLimit	datetime,
    @UpperCreationDateLimit	datetime,
    @FormFiltersTemp		FormFilterTableType readonly,
    @delimiter				char
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @FormFilters FormFilterTableType
	INSERT INTO @FormFilters SELECT * FROM @FormFiltersTemp
	
	SET @SearchText = [dbo].[GFN_GetSearchText](@SearchText)
	
	DECLARE @Results Table (
		NodeID_Hide uniqueidentifier primary key clustered,
		Name nvarchar(1000),
		AdditionalID varchar(1000),
		NodeType nvarchar(1000),
		Classification nvarchar(250),
		Description_HTML nvarchar(max),
		CreationDate datetime,
		PublicationDate datetime,
		CreatorUserID_Hide uniqueidentifier,
		CreatorName nvarchar(1000),
		CreatorUserName nvarchar(1000),
		OwnerID_Hide uniqueidentifier,
		OwnerName nvarchar(1000),
		OwnerType nvarchar(1000),
		Score float,
		Status_Dic nvarchar(100),
		WFState nvarchar(1000),
		UsersCount int,
		Collaboration float,
		MaxCollaboration float,
		UploadSize float
	)
	
	IF @SearchText IS NULL BEGIN
		INSERT INTO @Results
		SELECT	ND.NodeID AS NodeID_Hide,
				ND.NodeName AS Name,
				ND.NodeAdditionalID AS AdditionalID,
				ND.TypeName AS NodeType,
				Conf.[Level] AS Classification,
				ND.[Description] AS Description_HTML,
				ND.CreationDate,
				ND.PublicationDate,
				ND.CreatorUserID AS CreatorUserID_Hide,
				(ISNULL(UN.FirstName, N'') + N' ' + ISNULL(UN.LastName, N'')) AS CreatorName,
				UN.UserName AS CreatorUserName,
				ND.OwnerID AS OwnerID_Hide,
				OW.NodeName AS OwnerName,
				OW.TypeName AS OwnerType,
				ND.Score,
				ND.[Status],
				ND.WFState,
				Ref.UsersCount,
				Ref.Collaboration,
				Ref.MaxCollaboration,
				Ref.UploadSize
		FROM (
				SELECT	ND.NodeID, 
						ISNULL(COUNT(NC.UserID), 0) AS UsersCount, 
						CASE
							WHEN ISNULL(COUNT(NC.UserID), 1) = 0 THEN 0
							ELSE ISNULL(SUM(NC.CollaborationShare), 0) / ISNULL(COUNT(NC.UserID), 1)
						END AS Collaboration,
						ISNULL(MAX(NC.CollaborationShare), 0) AS MaxCollaboration,
						SUM(ISNULL(F.Size, 0)) / (1024.0 * 1024.0) AS UploadSize
				FROM [dbo].[CN_Nodes] AS ND
					LEFT JOIN [dbo].[CN_NodeCreators] AS NC
					ON NC.ApplicationID = @ApplicationID AND 
						NC.NodeID = ND.NodeID AND NC.Deleted = 0
					LEFT JOIN [dbo].[DCT_Files] AS F
					ON F.ApplicationID = @ApplicationID AND F.OwnerID = ND.NodeID AND 
						(F.OwnerType = N'Node') AND F.Deleted = 0
				WHERE ND.ApplicationID = @ApplicationID AND 
					(@NodeTypeID IS NULL OR ND.NodeTypeID = @NodeTypeID) AND 
					(@Status IS NULL OR ND.[Status] = @Status) AND ND.Deleted = 0 AND
					(@LowerCreationDateLimit IS NULL OR ND.CreationDate >= @LowerCreationDateLimit) AND
					(@UpperCreationDateLimit IS NULL OR ND.CreationDate <= @UpperCreationDateLimit)
				GROUP BY ND.NodeID
			) AS Ref
			INNER JOIN [dbo].[CN_View_Nodes_Normal] AS ND
			ON ND.ApplicationID = @ApplicationID AND ND.NodeID = Ref.NodeID
			LEFT JOIN [dbo].[Users_Normal] AS UN
			ON UN.ApplicationID = @ApplicationID AND UN.UserID = ND.CreatorUserID
			LEFT JOIN [dbo].[CN_View_Nodes_Normal] AS OW
			ON OW.ApplicationID = @ApplicationID AND OW.NodeID = ND.OwnerID
			LEFT JOIN [dbo].[PRVC_View_Confidentialities] AS Conf
			ON Conf.ApplicationID = @ApplicationID AND Conf.ObjectID = ND.NodeID
		WHERE (@MinContributorsCount IS NULL OR Ref.UsersCount >= @MinContributorsCount)
	END
	ELSE BEGIN
		INSERT INTO @Results
		SELECT	ND.NodeID AS NodeID_Hide,
				ND.NodeName AS Name,
				ND.NodeAdditionalID AS AdditionalID,
				ND.TypeName AS NodeType,
				Conf.[Level] AS Classification,
				ND.[Description] AS Description_HTML,
				ND.CreationDate,
				ND.PublicationDate,
				ND.CreatorUserID AS CreatorUserID_Hide,
				(ISNULL(UN.FirstName, N'') + N' ' + ISNULL(UN.LastName, N'')) AS CreatorName,
				UN.UserName AS CreatorUserName,
				ND.OwnerID AS OwnerID_Hide,
				OW.NodeName AS OwnerName,
				OW.TypeName AS OwnerType,
				ND.Score,
				ND.[Status],
				ND.WFState,
				Ref.UsersCount,
				Ref.Collaboration,
				Ref.MaxCollaboration,
				Ref.UploadSize
		FROM (
				SELECT	ND.NodeID, 
						ISNULL(COUNT(NC.UserID), 0) AS UsersCount, 
						CASE
							WHEN ISNULL(COUNT(NC.UserID), 1) = 0 THEN 0
							ELSE ISNULL(SUM(NC.CollaborationShare), 0) / ISNULL(COUNT(NC.UserID), 1)
						END AS Collaboration,
						ISNULL(MAX(NC.CollaborationShare), 0) AS MaxCollaboration,
						SUM(ISNULL(F.Size, 0)) / (1024.0 * 1024.0) AS UploadSize
				FROM CONTAINSTABLE([dbo].[CN_Nodes], ([Name]), @SearchText) AS SRCH
					INNER JOIN [dbo].[CN_Nodes] AS ND
					ON ND.ApplicationID = @ApplicationID AND ND.NodeID = SRCH.[Key]
					LEFT JOIN [dbo].[CN_NodeCreators] AS NC
					ON NC.ApplicationID = @ApplicationID AND 
						NC.NodeID = ND.NodeID AND NC.Deleted = 0
					LEFT JOIN [dbo].[DCT_Files] AS F
					ON F.ApplicationID = @ApplicationID AND F.OwnerID = ND.NodeID AND 
						(F.OwnerType = N'Node') AND F.Deleted = 0
				WHERE (@NodeTypeID IS NULL OR ND.NodeTypeID = @NodeTypeID) AND 
					(@Status IS NULL OR ND.[Status] = @Status) AND ND.Deleted = 0 AND
					(@LowerCreationDateLimit IS NULL OR ND.CreationDate >= @LowerCreationDateLimit) AND
					(@UpperCreationDateLimit IS NULL OR ND.CreationDate <= @UpperCreationDateLimit)
				GROUP BY ND.NodeID
			) AS Ref
			INNER JOIN [dbo].[CN_View_Nodes_Normal] AS ND
			ON ND.ApplicationID = @ApplicationID AND ND.NodeID = Ref.NodeID
			LEFT JOIN [dbo].[Users_Normal] AS UN
			ON UN.ApplicationID = @ApplicationID AND UN.UserID = ND.CreatorUserID
			LEFT JOIN [dbo].[CN_View_Nodes_Normal] AS OW
			ON OW.ApplicationID = @ApplicationID AND OW.NodeID = ND.OwnerID
			LEFT JOIN [dbo].[PRVC_View_Confidentialities] AS Conf
			ON Conf.ApplicationID = @ApplicationID AND Conf.ObjectID = ND.NodeID
		WHERE (@MinContributorsCount IS NULL OR Ref.UsersCount >= @MinContributorsCount)
	END
	
	DECLARE @NodeIDs GuidTableType
	
	INSERT INTO @NodeIDs
	SELECT Ref.NodeID_Hide
	FROM @Results AS Ref
	
	DECLARE @InstanceIDs GuidTableType
	
	DECLARE @FormID uniqueidentifier = NULL
	
	IF @NodeTypeID IS NOT NULL BEGIN
		SET @FormID = (
			SELECT TOP(1) FormID
			FROM [dbo].[FG_FormOwners]
			WHERE ApplicationID = @ApplicationID AND OwnerID = @NodeTypeID AND Deleted = 0
		)
	END
	
	IF @FormID IS NOT NULL AND (SELECT COUNT(Ref.ElementID) FROM @FormFilters AS Ref) > 0 BEGIN
		DECLARE @FormInstanceOwners Table (InstanceID uniqueidentifier, OwnerID uniqueidentifier)
	
		INSERT INTO @FormInstanceOwners (InstanceID, OwnerID)
		SELECT FI.InstanceID, FI.OwnerID
		FROM @NodeIDs AS Ref 
			INNER JOIN [dbo].[FG_FormInstances] AS FI
			ON FI.ApplicationID = @ApplicationID AND FI.OwnerID = Ref.Value AND FI.Deleted = 0
		
		INSERT INTO @InstanceIDs (Value)
		SELECT DISTINCT Ref.InstanceID
		FROM @FormInstanceOwners AS Ref
		
		DELETE N
		FROM @NodeIDs AS N
			LEFT JOIN @FormInstanceOwners AS O
			ON O.OwnerID = N.Value
			LEFT JOIN [dbo].[FG_FN_FilterInstances](
				@ApplicationID, NULL, @InstanceIDs, @FormFilters, @delimiter, 1
			) AS Ref
			ON Ref.InstanceID = O.InstanceID
		WHERE Ref.InstanceID IS NULL
		
		DELETE I
		FROM @InstanceIDs AS I
			LEFT JOIN @FormInstanceOwners AS O
			LEFT JOIN @NodeIDs AS N
			ON N.Value = O.OwnerID
			ON O.InstanceID = I.Value
		WHERE O.InstanceID IS NULL OR N.Value IS NULL
	END
	
	SELECT R.*
	FROM @NodeIDs AS N
		INNER JOIN @Results AS R
		ON R.NodeID_Hide = N.Value
	
	SELECT ('{' +
			'"Name": {"Action": "Link", "Type": "Node",' +
				'"Requires": {"ID": "NodeID_Hide"}' +
			'},' +
			'"CreatorName": {"Action": "Link", "Type": "User",' +
				'"Requires": {"UID": "CreatorUserID_Hide"}' +
			'},' +
			'"OwnerName": {"Action": "Link", "Type": "Node",' +
				'"Requires": {"ID": "OwnerID_Hide"}' +
			'},' +
			'"Contributor": {"Action": "Link", "Type": "User",' +
				'"Requires": {"UID": "ContributorID_Hide"}' +
			'},' +
			'"UsersCount": {"Action": "Report", ' +
		   		'"ModuleIdentifier": "CN", "ReportName": "CreatorUsersReport",' +
		   		'"Requires": {"NodeID": {"Value": "NodeID_Hide", "Title": "Name"}}, ' + 
		   		'"Params": {}' + 
		   	'}' +
		   '}') AS Actions

	IF @FormID IS NOT NULL AND EXISTS(
		SELECT TOP(1) *
		FROM [dbo].[CN_Extensions] AS Ex
		WHERE Ex.ApplicationID = @ApplicationID AND 
			Ex.OwnerID = @NodeTypeID AND Ex.Extension = N'Form' AND Ex.Deleted = 0
	) BEGIN
		-- Second Part: Describes the Third Part
		SELECT CAST(EFE.ElementID AS varchar(50)) AS ColumnName, EFE.Title AS Translation,
			CASE
				WHEN EFE.[Type] = N'Binary' THEN N'bool'
				WHEN EFE.[Type] = N'Number' THEN N'double'
				WHEN EFE.[Type] = N'Date' THEN N'datetime'
				WHEN EFE.[Type] = N'User' THEN N'user'
				WHEN EFE.[Type] = N'Node' THEN N'node'
				ELSE N'string'
			END AS [Type]
		FROM [dbo].[FG_ExtendedFormElements] AS EFE
		WHERE EFE.ApplicationID = @ApplicationID AND 
			EFE.FormID = @FormID AND EFE.Deleted = 0
		ORDER BY EFE.SequenceNumber ASC
		
		SELECT ('{"IsDescription": "true"}') AS Info
		-- end of Second Part
		
		-- Third Part: The Form Info
		DECLARE @ElementIDs GuidTableType
		DECLARE @FakeOwnerIDs GuidTableType, @FakeFilters FormFilterTableType
		
		EXEC [dbo].[FG_P_GetFormRecords] @ApplicationID, @FormID, @ElementIDs, 
			@InstanceIDs, @FakeOwnerIDs, @FakeFilters, NULL, 1000000, NULL, NULL
		
		SELECT ('{' +
			'"ColumnsMap": "NodeID_Hide:OwnerID",' +
			'"ColumnsToTransfer": "' + STUFF((
				SELECT ',' + CAST(EFE.ElementID AS varchar(50))
				FROM [dbo].[FG_ExtendedFormElements] AS EFE
				WHERE EFE.ApplicationID = @ApplicationID AND 
					EFE.FormID = @FormID AND EFE.Deleted = 0
				ORDER BY EFE.SequenceNumber ASC
				FOR xml path('a'), type
			).value('.','nvarchar(max)'), 1, 1, '') + '"' +
		   '}') AS Info
		-- End of Third Part
	END
	
	
	-- Add Contributor Columns
	
	DECLARE @Proc nvarchar(max) = N''
	
	SELECT X.*
	INTO #Result
	FROM (
			SELECT	C.NodeID, 
					CAST(C.UserID AS varchar(50)) AS unq,
					C.UserID, 
					C.CollaborationShare AS Share,
					ROW_NUMBER() OVER (PARTITION BY C.NodeID ORDER BY C.CollaborationShare DESC, C.UserID DESC) AS RowNumber
			FROM @NodeIDs AS IDs
				INNER JOIN [dbo].[CN_NodeCreators] AS C
				ON C.ApplicationID = @ApplicationID AND C.NodeID = IDs.Value AND C.Deleted = 0
		) AS X
		
	DECLARE @Count int = (SELECT MAX(RowNumber) FROM #Result)
	DECLARE @ItemsList varchar(max) = N'', @SelectList varchar(max) = N'', @ColsToTransfer varchar(max) = N''
	
	SET @Proc = N''

	DECLARE @Ind int = @Count - 1
	WHILE @Ind >= 0 BEGIN
		DECLARE @Tmp varchar(10) = CAST((@Count - @Ind) AS varchar(10))
		
		SET @SelectList = @SelectList + '[' + @Tmp + '] AS [ContributorID_Hide_' + @Tmp + '], ' + 
			'CAST(NULL AS nvarchar(500)) AS [Contributor_' + @Tmp + '], ' +
			'CAST(NULL AS float) AS [ContributorShare_' + @Tmp + ']'
			
		SET @ItemsList = @ItemsList + '[' + @Tmp + ']'
		
		SET @Proc = @Proc + 
			'SELECT ''ContributorID_Hide_' + @Tmp + ''' AS ColumnName, null AS Translation, ''string'' AS Type ' +
			'UNION ALL ' +
			'SELECT ''Contributor_' + @Tmp + ''' AS ColumnName, null AS Translation, ''string'' AS Type ' +
			'UNION ALL ' +
			'SELECT ''ContributorShare_' + @Tmp + ''' AS ColumnName, null AS Translation, ''double'' AS Type '
			
		SET @ColsToTransfer = @ColsToTransfer + 
			'ContributorID_Hide_' + @Tmp + ',Contributor_' + @Tmp + ',ContributorShare_' + @Tmp
		
		IF @Ind > 0 BEGIN 
			SET @SelectList = @SelectList + ', '
			SET @ItemsList = @ItemsList + ', '
			SET @Proc = @Proc + N'UNION ALL '
			SET @ColsToTransfer = @ColsToTransfer + ','
		END
		
		SET @Ind = @Ind - 1
	END
	
	-- Second Part: Describes the Third Part
	EXEC (@Proc)
	
	SELECT ('{"IsDescription": "true"}') AS Info
	-- end of Second Part

	-- Third Part: The Data
	SET @Proc = 
		'SELECT NodeID AS NodeID_Hide, ' + @SelectList + 
		'INTO #Final ' +
		'FROM ( ' +
				'SELECT NodeID, unq, RowNumber ' +
				'FROM #Result ' +
			') AS P ' +
			'PIVOT (MAX(unq) FOR RowNumber IN (' + @ItemsList + ')) AS PVT '

	SET @Ind = @Count - 1
	WHILE @Ind >= 0 BEGIN
		DECLARE @No varchar(10) = CAST((@Count - @Ind) AS varchar(10))
		
		SET @Proc = @Proc + 
			'UPDATE F ' + 
				'SET Contributor_' + @No + ' = LTRIM(RTRIM(ISNULL(UN.FirstName, N'''') + N'' '' + ISNULL(UN.LastName, N''''))) ' + 
			'FROM #Final AS F ' + 
				'INNER JOIN [dbo].[Users_Normal] AS UN ' + 
				'ON UN.ApplicationID = ''' + CAST(@ApplicationID AS varchar(50)) + ''' AND UN.UserID = F.ContributorID_Hide_' + @No + ' '
				
		SET @Proc = @Proc + 
			'UPDATE F ' + 
				'SET ContributorShare_' + @No + ' = R.Share ' + 
			'FROM #Final AS F ' + 
				'INNER JOIN #Result AS R ' + 
				'ON R.NodeID = F.NodeID_Hide AND R.UserID = F.ContributorID_Hide_' + @No + ' '
		
		SET @Ind = @Ind - 1
	END

	SET @Proc = @Proc + 'SELECT * FROM #Final'

	EXEC (@Proc)
	
	SELECT ('{' +
			'"ColumnsMap": "NodeID_Hide:NodeID_Hide",' +
			'"ColumnsToTransfer": "' + @ColsToTransfer + '"' +
		   '}') AS Info
	-- end of Third Part
	
	-- end of Add Contributor Columns
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_MostFavoriteNodesReport]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_MostFavoriteNodesReport]
GO

CREATE PROCEDURE [dbo].[CN_MostFavoriteNodesReport]
	@ApplicationID	uniqueidentifier,
	@CurrentUserID	uniqueidentifier,
	@Count			int,
	@NodeTypeID		uniqueidentifier,
	@BeginDate		datetime,
	@FinishDate		datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	IF @Count IS NULL SET @Count = 20
	
	SELECT TOP(@Count) 
		nd.NodeID AS NodeID_Hide, 
		nd.NodeName, 
		nd.TypeName, 
		Conf.[Level] AS Classification,
		ref.cnt AS [Count]
	FROM (
			SELECT nl.NodeID, COUNT(nl.UserID) AS cnt
			FROM [dbo].[CN_NodeLikes] AS nl
			WHERE nl.ApplicationID = @ApplicationID AND 
				(@BeginDate IS NULL OR nl.LikeDate >= @BeginDate) AND
				(@FinishDate IS NULL OR nl.LikeDate <= @FinishDate) AND
				nl.Deleted = 0
			GROUP BY nl.NodeID
		) AS ref
		INNER JOIN [dbo].[CN_View_Nodes_Normal] AS nd
		ON nd.ApplicationID = @ApplicationID AND nd.NodeID = ref.NodeID
		LEFT JOIN [dbo].[PRVC_View_Confidentialities] AS Conf
		ON Conf.ApplicationID = @ApplicationID AND Conf.ObjectID = ND.NodeID
	WHERE (@NodeTypeID IS NULL OR nd.NodeTypeID = @NodeTypeID) AND nd.Deleted = 0
	ORDER BY ref.cnt DESC
	
	SELECT ('{' +
			'"NodeName": {"Action": "Link", "Type": "Node",' +
				'"Requires": {"ID": "NodeID_Hide"}' +
			'}' +
		   '}') AS Actions
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_CreatorUsersReport]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_CreatorUsersReport]
GO

CREATE PROCEDURE [dbo].[CN_CreatorUsersReport]
	@ApplicationID			uniqueidentifier,
	@CurrentUserID			uniqueidentifier,
	@NodeID					uniqueidentifier,
	@MembershipNodeTypeID	uniqueidentifier,
	@MembershipNodeID		uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON

	SELECT NC.UserID AS UserID_Hide,
		(UN.FirstName + N' ' + UN.LastName) AS Name, UN.UserName AS UserName,
		NC.CollaborationShare AS Collaboration
	FROM [dbo].[CN_NodeCreators] AS NC
		INNER JOIN [dbo].[Users_Normal] AS UN
		ON UN.ApplicationID = @ApplicationID AND UN.UserID = NC.UserID
	WHERE NC.ApplicationID = @ApplicationID AND NC.NodeID = @NodeID AND NC.Deleted = 0 AND
		((@MembershipNodeID IS NULL AND @MembershipNodeTypeID IS NULL) OR EXISTS(
			SELECT TOP(1) *
			FROM [dbo].[CN_View_NodeMembers] AS NM
				INNER JOIN [dbo].[CN_Nodes] AS ND
				ON ND.ApplicationID = @ApplicationID AND ND.NodeID = NM.NodeID
			WHERE NM.ApplicationID = @ApplicationID AND 
				(
					(@MembershipNodeID IS NULL AND ND.NodeTypeID = @MembershipNodeTypeID) OR
					(@MembershipNodeID IS NOT NULL AND ND.NodeID = @MembershipNodeID)
				) AND NM.UserID = UN.UserID AND NM.IsPending = 0 AND ND.Deleted = 0
		))

	
	SELECT ('{' +
			'"Name": {"Action": "Link", "Type": "User",' +
				'"Requires": {"ID": "UserID_Hide"}' +
			'}' +
		   '}') AS Actions
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_NodeCreatorsReport]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_NodeCreatorsReport]
GO

CREATE PROCEDURE [dbo].[CN_NodeCreatorsReport]
	@ApplicationID			uniqueidentifier,
	@CurrentUserID			uniqueidentifier,
	@NodeTypeID				uniqueidentifier,
	@strUserIDs				varchar(max),
	@strNodeIDs				varchar(max),
	@delimiter				char,
	@ShowPersonalItems		bit,
	@LowerCreationDateLimit datetime,
	@UpperCreationDateLimit datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @UserIDs GuidTableType
	
	INSERT INTO @UserIDs
	SELECT Ref.Value FROM [dbo].[GFN_StrToGuidTable](@strUserIDs, @delimiter) AS Ref
	
	DECLARE @NodeIDs GuidTableType, @NodeUserIDs GuidTableType
	
	INSERT INTO @NodeIDs
	SELECT Ref.Value FROM [dbo].[GFN_StrToGuidTable](@strNodeIDs, @delimiter) AS Ref
	
	INSERT INTO @NodeUserIDs
	EXEC [dbo].[CN_P_GetMemberUserIDs] @ApplicationID, @NodeIDs, N'Accepted', NULL
	
	INSERT INTO @UserIDs
	SELECT Ref.Value
	FROM @NodeUserIDs AS Ref
	WHERE Ref.Value NOT IN (SELECT U.Value FROM @UserIDs AS U)
	
	IF((SELECT COUNT(*) FROM @UserIDs) = 0) BEGIN
		INSERT INTO @UserIDs
		SELECT UserID
		FROM [dbo].[Users_Normal]
		WHERE ApplicationID = @ApplicationID AND IsApproved = 1
	END

	DECLARE @DepTypeIDs GuidTableType
	INSERT INTO @DepTypeIDs (Value)
	SELECT Ref.NodeTypeID
	FROM [dbo].[CN_FN_GetDepartmentNodeTypeIDs](@ApplicationID) AS Ref

	SELECT UN.UserID AS UserID_Hide, 
		CAST(MAX(CAST(ND.NodeID AS varchar(36))) AS uniqueidentifier) AS DepartmentID_Hide,
		(MAX(UN.FirstName) + N' ' + MAX(UN.LastName)) AS Name, 
		MAX(UN.UserName) AS UserName,  
		MAX(ND.Name) AS Department, 
		MAX(Ref.[Count]) AS [Count], 
		MAX(Ref.Personal) AS PersonalCount, 
		MAX(Ref.[Group]) AS GroupCount, 
		MAX(Ref.Collaboration) AS Collaboration,
		MAX(Ref.UploadSize) AS UploadSize
	FROM
		(
			SELECT NC.UserID, 
				COUNT(NC.NodeID) AS [Count],
				SUM(
					CASE
						WHEN NC.CollaborationShare = 100 THEN 1
						ELSE 0
					END
				) AS Personal,
				SUM(
					CASE
						WHEN NC.CollaborationShare = 100 THEN 0
						ELSE 1
					END
				) AS [Group],
				CASE
					WHEN ISNULL(COUNT(NC.UserID), 1) = 0 THEN 0
					ELSE ISNULL(SUM(NC.CollaborationShare), 0) / ISNULL(COUNT(NC.UserID), 1)
				END AS Collaboration,
				SUM(ISNULL(F.Size, 0)) / (1024.0 * 1024.0) AS UploadSize
			FROM @UserIDs AS UDS
				INNER JOIN [dbo].[CN_NodeCreators] AS NC
				ON NC.ApplicationID = @ApplicationID AND NC.UserID = UDS.Value
				INNER JOIN [dbo].[CN_Nodes] AS ND
				ON ND.ApplicationID = @ApplicationID AND ND.NodeID = NC.NodeID
				LEFT JOIN [dbo].[DCT_Files] AS F
				ON F.ApplicationID = @ApplicationID AND F.OwnerID = ND.NodeID AND 
					(F.OwnerType = N'Node') AND F.Deleted = 0
			WHERE NC.Deleted = 0 AND ND.Deleted = 0 AND
				(@NodeTypeID IS NULL OR ND.NodeTypeID = @NodeTypeID) AND
				(@ShowPersonalItems IS NULL OR
					(@ShowPersonalItems = 1 AND NC.CollaborationShare = 100) OR
					(@ShowPersonalItems = 0 AND NC.CollaborationShare < 100)
				) AND
				(@LowerCreationDateLimit IS NULL OR ND.CreationDate >= @LowerCreationDateLimit) AND
				(@UpperCreationDateLimit IS NULL OR ND.CreationDate <= @UpperCreationDateLimit)
			GROUP BY NC.UserID
		) AS Ref
		INNER JOIN [dbo].[Users_Normal] AS UN
		ON UN.ApplicationID = @ApplicationID AND Ref.UserID = UN.UserID
		LEFT JOIN [dbo].[CN_NodeMembers] AS NM
		LEFT JOIN [dbo].[CN_Nodes] AS ND
		ON ND.ApplicationID = @ApplicationID AND 
			ND.NodeTypeID IN (SELECT Value FROM @DepTypeIDs) AND ND.Deleted = 0
		ON NM.ApplicationID = @ApplicationID AND 
			NM.NodeID = ND.NodeID AND  NM.UserID = UN.UserID AND NM.Deleted = 0
	GROUP BY UN.UserID
	ORDER BY MAX(Ref.[Count]) DESC
	
	SELECT ('{' +
			'"Name": {"Action": "Link", "Type": "User",' +
				'"Requires": {"UID": "UserID_Hide"}' +
			'},' +
			'"Department": {"Action": "Link", "Type": "Node",' +
				'"Requires": {"ID": "DepartmentID_Hide"}' +
			'},' +
		    '"Count": {"Action": "Report", 
		   		"ModuleIdentifier": "CN", "ReportName": "UserCreatedNodesReport",' +
		   		'"Requires": {"UserID": {"Value": "UserID_Hide", ' + 
		   			'"Title": "~[[Name]] (~[[UserName]])"}}, ' + 
		   		'"Params": {"ShowPersonalItems": null}' + 
		   	'},' +
		    '"PersonalCount": {"Action": "Report", 
		   		"ModuleIdentifier": "CN", "ReportName": "UserCreatedNodesReport",' +
		   		'"Requires": {"UserID": {"Value": "UserID_Hide", ' + 
		   			'"Title": "~[[Name]] (~[[UserName]])"}}, ' + 
		   		'"Params": {"ShowPersonalItems": true}' + 
		   	'},' +
		   	'"GroupCount": {"Action": "Report", 
		   		"ModuleIdentifier": "CN", "ReportName": "UserCreatedNodesReport",' +
		   		'"Requires": {"UserID": {"Value": "UserID_Hide", ' + 
		   			'"Title": "~[[Name]] (~[[UserName]])"}}, ' + 
		   		'"Params": {"ShowPersonalItems": false}' + 
		   	'}' +
		   '}') AS Actions
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_UserCreatedNodesReport]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_UserCreatedNodesReport]
GO

CREATE PROCEDURE [dbo].[CN_UserCreatedNodesReport]
	@ApplicationID			uniqueidentifier,
	@CurrentUserID			uniqueidentifier,
	@NodeTypeID				uniqueidentifier,
	@UserID					uniqueidentifier,
	@ShowPersonalItems		bit,
	@LowerCreationDateLimit datetime,
	@UpperCreationDateLimit datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @UserIDs GuidTableType

	SELECT	NC.NodeID AS NodeID_Hide, 
			ND.Name AS NodeName, 
			ND.AdditionalID AS AdditionalID,
			Conf.[Level] AS Classification,
			NC.CollaborationShare, ND.CreationDate AS CreationDate,
			ISNULL((
				SELECT SUM(ISNULL(F.Size, 0))
				FROM [dbo].[DCT_Files] AS F
				WHERE F.ApplicationID = @ApplicationID AND F.OwnerID = NC.NodeID AND 
					(F.OwnerType = N'Node') AND F.Deleted = 0
			), 0) / (1024.0 * 1024.0) AS UploadSize
	FROM [dbo].[CN_NodeCreators] AS NC
		INNER JOIN [dbo].[CN_Nodes] AS ND
		ON ND.ApplicationID = @ApplicationID AND ND.NodeID = NC.NodeID
		LEFT JOIN [dbo].[PRVC_View_Confidentialities] AS Conf
		ON Conf.ApplicationID = @ApplicationID AND Conf.ObjectID = ND.NodeID
	WHERE NC.ApplicationID = @ApplicationID AND 
		NC.UserID = @UserID AND NC.Deleted = 0 AND 
		(@NodeTypeID IS NULL OR ND.NodeTypeID = @NodeTypeID) AND 
		ND.Deleted = 0 AND
		(@ShowPersonalItems IS NULL OR
			(@ShowPersonalItems = 1 AND NC.CollaborationShare = 100) OR
			(@ShowPersonalItems = 0 AND NC.CollaborationShare < 100)
		) AND
		(@LowerCreationDateLimit IS NULL OR ND.CreationDate >= @LowerCreationDateLimit) AND
		(@UpperCreationDateLimit IS NULL OR ND.CreationDate <= @UpperCreationDateLimit)
	
	SELECT ('{' +
			'"NodeName": {"Action": "Link", "Type": "Node",' +
				'"Requires": {"ID": "NodeID_Hide"}' +
			'}' +
		   '}') AS Actions
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_NodesCreatedNodesReport]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_NodesCreatedNodesReport]
GO

CREATE PROCEDURE [dbo].[CN_NodesCreatedNodesReport]
	@ApplicationID			uniqueidentifier,
	@CurrentUserID			uniqueidentifier,
	@NodeTypeID				uniqueidentifier,
	@CreatorNodeTypeID		uniqueidentifier,
	@strNodeIDs				varchar(max),
	@delimiter				char,
	@ShowPersonalItems		bit,
	@LowerCreationDateLimit datetime, 
	@UpperCreationDateLimit datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @NodeIDs GuidTableType
	INSERT INTO @NodeIDs
	SELECT Ref.Value FROM [dbo].[GFN_StrToGuidTable](@strNodeIDs, @delimiter) AS Ref
	
	IF @CreatorNodeTypeID IS NOT NULL AND (SELECT COUNT(*) FROM @NodeIDs) = 0 BEGIN
		INSERT INTO @NodeIDs
		SELECT NodeID
		FROM [dbo].[CN_Nodes]
		WHERE ApplicationID = @ApplicationID AND 
			NodeTypeID = @CreatorNodeTypeID AND Deleted = 0
	END
	

	SELECT	ND.NodeID AS NodeID_Hide, 
			MAX(ND.NodeName) AS [Node], 
			MAX(ND.TypeName) AS [NodeType], 
			COUNT(Ref.CreatedNodeID) AS [Count], 
			SUM(Ref.Personal) AS PersonalCount, 
			(COUNT(Ref.CreatedNodeID) - SUM(Ref.Personal)) AS GroupCount, 
			AVG(Ref.Collaboration) AS Collaboration,
			SUM(Ref.Published) AS Published,
			SUM(Ref.SentToAdmin) AS SentToAdmin,
			SUM(Ref.SentToEvaluators) AS SentToEvaluators,
			SUM(Ref.Accepted) AS Accepted,
			SUM(Ref.Rejected) AS Rejected,
			SUM(Ref.UploadSize) AS UploadSize
	FROM
		(
			SELECT NM.NodeID, NC.NodeID AS CreatedNodeID, 
				CAST(MAX(CASE WHEN NC.CollaborationShare = 100 THEN 1 ELSE 0 END) AS int) AS Personal,
				CASE
					WHEN ISNULL(COUNT(NC.UserID), 1) = 0 THEN 0
					ELSE ISNULL(SUM(NC.CollaborationShare), 0) / ISNULL(COUNT(NC.UserID), 1)
				END AS Collaboration,
				CASE WHEN MAX(CAST(ND.Searchable AS int)) = 1 THEN 1 ELSE 0 END AS Published,
				CASE WHEN MAX(ND.[Status]) = N'SentToAdmin' THEN 1 ELSE 0 END AS SentToAdmin,
				CASE WHEN MAX(ND.[Status]) = N'SentToEvaluators' THEN 1 ELSE 0 END AS SentToEvaluators,
				CASE WHEN MAX(ND.[Status]) = N'Accepted' THEN 1 ELSE 0 END AS Accepted,
				CASE WHEN MAX(ND.[Status]) = N'Rejected' THEN 1 ELSE 0 END AS Rejected,
				((SUM(ISNULL(F.Size, 0)) / (1024.0 * 1024.0)) / COUNT(DISTINCT NC.UserID)) AS UploadSize
			FROM @NodeIDs AS NDS
				INNER JOIN [dbo].[CN_NodeMembers] AS NM
				ON NM.ApplicationID = @ApplicationID AND NM.NodeID = NDS.Value AND NM.Deleted = 0
				INNER JOIN [dbo].[CN_NodeCreators] AS NC
				ON NC.ApplicationID = @ApplicationID AND NC.UserID = NM.UserID AND NC.Deleted = 0
				INNER JOIN [dbo].[CN_Nodes] AS ND
				ON ND.ApplicationID = @ApplicationID AND ND.NodeID = NC.NodeID AND ND.Deleted = 0
				LEFT JOIN [dbo].[DCT_Files] AS F
				ON F.ApplicationID = @ApplicationID AND F.OwnerID = ND.NodeID AND 
					(F.OwnerType = N'Node') AND F.Deleted = 0
			WHERE (@NodeTypeID IS NULL OR ND.NodeTypeID = @NodeTypeID) AND 
				(@ShowPersonalItems IS NULL OR
					(@ShowPersonalItems = 1 AND NC.CollaborationShare = 100) OR
					(@ShowPersonalItems = 0 AND NC.CollaborationShare < 100)
				) AND
				(@LowerCreationDateLimit IS NULL OR 
					ND.CreationDate >= @LowerCreationDateLimit) AND
				(@UpperCreationDateLimit IS NULL OR 
					ND.CreationDate <= @UpperCreationDateLimit)
			GROUP BY NM.NodeID, NC.NodeID
		) AS Ref
		INNER JOIN [dbo].[CN_View_Nodes_Normal] AS ND
		ON ND.ApplicationID = @ApplicationID AND ND.NodeID = Ref.NodeID
	GROUP BY ND.NodeID
	ORDER BY COUNT(Ref.CreatedNodeID) DESC

	
	SELECT ('{' +
			'"Node": {"Action": "Link", "Type": "Node",' +
				'"Requires": {"ID": "NodeID_Hide"}' +
			'},' +
		   	'"Count": {"Action": "Report", ' +
		   		'"ModuleIdentifier": "CN", "ReportName": "NodeCreatedNodesReport",' +
		   		'"Requires": {"CreatorNodeID": {"Value": "NodeID_Hide", ' + 
		   		'"Title": "~[[Node]] (~[[NodeType]])"}}, ' + 
		   		'"Params": {"ShowPersonalItems": null}' + 
		   	'},' +
		   	'"PersonalCount": {"Action": "Report", ' +
		   		'"ModuleIdentifier": "CN", "ReportName": "NodeCreatedNodesReport",' +
		   		'"Requires": {"CreatorNodeID": {"Value": "NodeID_Hide", ' + 
		   		'"Title": "~[[Node]] (~[[NodeType]])"}}, ' + 
		   		'"Params": {"ShowPersonalItems": true}' + 
		   	'},' +
		   	'"GroupCount": {"Action": "Report", ' +
		   		'"ModuleIdentifier": "CN", "ReportName": "NodeCreatedNodesReport",' +
		   		'"Requires": {"CreatorNodeID": {"Value": "NodeID_Hide", ' + 
		   		'"Title": "~[[Node]] (~[[NodeType]])"}}, ' + 
		   		'"Params": {"ShowPersonalItems": false}' + 
		   	'},' +
		   	'"Published": {"Action": "Report", ' +
		   		'"ModuleIdentifier": "CN", "ReportName": "NodeCreatedNodesReport",' +
		   		'"Requires": {"CreatorNodeID": {"Value": "NodeID_Hide", ' + 
		   		'"Title": "~[[Node]] (~[[NodeType]])"}}, ' + 
		   		'"Params": {"Published": true}' + 
		   	'},' +
		   	'"SentToAdmin": {"Action": "Report", ' +
		   		'"ModuleIdentifier": "CN", "ReportName": "NodeCreatedNodesReport",' +
		   		'"Requires": {"CreatorNodeID": {"Value": "NodeID_Hide", ' + 
		   		'"Title": "~[[Node]] (~[[NodeType]])"}}, ' + 
		   		'"Params": {"Status": "SentToAdmin"}' + 
		   	'},' +
		   	'"SentToEvaluators": {"Action": "Report", ' +
		   		'"ModuleIdentifier": "CN", "ReportName": "NodeCreatedNodesReport",' +
		   		'"Requires": {"CreatorNodeID": {"Value": "NodeID_Hide", ' + 
		   		'"Title": "~[[Node]] (~[[NodeType]])"}}, ' + 
		   		'"Params": {"Status": "SentToEvaluators"}' + 
		   	'},' +
		   	'"Accepted": {"Action": "Report", ' +
		   		'"ModuleIdentifier": "CN", "ReportName": "NodeCreatedNodesReport",' +
		   		'"Requires": {"CreatorNodeID": {"Value": "NodeID_Hide", ' + 
		   		'"Title": "~[[Node]] (~[[NodeType]])"}}, ' + 
		   		'"Params": {"Status": "Accepted"}' + 
		   	'},' +
		   	'"Rejected": {"Action": "Report", ' +
		   		'"ModuleIdentifier": "CN", "ReportName": "NodeCreatedNodesReport",' +
		   		'"Requires": {"CreatorNodeID": {"Value": "NodeID_Hide", ' + 
		   		'"Title": "~[[Node]] (~[[NodeType]])"}}, ' + 
		   		'"Params": {"Status": "Rejected"}' + 
		   	'}' +
		   '}') AS Actions
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_NodeCreatedNodesReport]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_NodeCreatedNodesReport]
GO

CREATE PROCEDURE [dbo].[CN_NodeCreatedNodesReport]
	@ApplicationID			uniqueidentifier,
	@CurrentUserID			uniqueidentifier,
	@NodeTypeID				uniqueidentifier,
	@CreatorNodeID			uniqueidentifier,
	@Status					varchar(50),
	@ShowPersonalItems		bit,
	@Published				bit,
	@LowerCreationDateLimit datetime, 
	@UpperCreationDateLimit datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON

	SELECT	NC.NodeID AS NodeID_Hide, 
			MAX(ND.NodeName) AS Node,
			MAX(ND.NodeAdditionalID) AS AdditionalID,
			MAX(ND.TypeName) AS NodeType,
			MAX(Conf.[Level]) AS Classification,
			CAST(MAX(CAST(ND.CreatorUserID AS varchar(40))) AS uniqueidentifier) AS CreatorUserID_Hide,
			MAX(ISNULL(UN.FirstName, N'') + N' ' + ISNULL(UN.LastName, N'')) AS CreatorName,
			MAX(UN.UserName) AS CreatorUserName,
			MAX(ND.CreationDate) AS CreationDate,
			ISNULL(COUNT(DISTINCT NC.UserID), 0) AS UsersCount, 
			CASE
				WHEN ISNULL(COUNT(NC.UserID), 1) = 0 THEN 0
				ELSE ISNULL(SUM(NC.CollaborationShare), 0) / ISNULL(COUNT(NC.UserID), 1)
			END AS Collaboration,
			CAST(MAX(CAST(ND.Searchable AS int)) AS bit) AS Published_Dic,
			MAX(ND.[Status]) AS Status_Dic,
			MAX(ND.WFState) AS WorkFlowState,
			((SUM(ISNULL(F.Size, 0)) / (1024.0 * 1024.0)) / ISNULL(COUNT(DISTINCT NC.UserID), 0)) AS UploadSize
	FROM [dbo].[CN_NodeMembers] AS NM
		INNER JOIN [dbo].[CN_NodeCreators] AS NC
		ON NC.ApplicationID = @ApplicationID AND NC.UserID = NM.UserID
		INNER JOIN [dbo].[CN_View_Nodes_Normal] AS ND
		ON ND.ApplicationID = @ApplicationID AND ND.NodeID = NC.NodeID
		LEFT JOIN [dbo].[Users_Normal] AS UN
		ON UN.ApplicationID = @ApplicationID AND UN.UserID = ND.CreatorUserID
		LEFT JOIN [dbo].[DCT_Files] AS F
		ON F.ApplicationID = @ApplicationID AND F.OwnerID = ND.NodeID AND 
			(F.OwnerType = N'Node') AND F.Deleted = 0
		LEFT JOIN [dbo].[PRVC_View_Confidentialities] AS Conf
		ON Conf.ApplicationID = @ApplicationID AND Conf.ObjectID = ND.NodeID
	WHERE NM.ApplicationID = @ApplicationID AND NM.NodeID = @CreatorNodeID AND 
		(@NodeTypeID IS NULL OR ND.NodeTypeID = @NodeTypeID) AND
		NC.Deleted = 0 AND ND.Deleted = 0 AND NM.Deleted = 0 AND
		(ISNULL(@Status, N'') = N'' OR ND.[Status] = @Status) AND
		(@ShowPersonalItems IS NULL OR
			(@ShowPersonalItems = 1 AND NC.CollaborationShare = 100) OR
			(@ShowPersonalItems = 0 AND NC.CollaborationShare < 100)
		) AND
		(@Published IS NULL OR ISNULL(ND.Searchable, 1) = @Published) AND
		(@LowerCreationDateLimit IS NULL OR 
			ND.CreationDate >= @LowerCreationDateLimit) AND
		(@UpperCreationDateLimit IS NULL OR 
			ND.CreationDate <= @UpperCreationDateLimit)
	GROUP BY NC.NodeID

	
	SELECT ('{' +
			'"Node": {"Action": "Link", "Type": "Node",' +
				'"Requires": {"ID": "NodeID_Hide"}' +
			'},' +
			'"CreatorName": {"Action": "Link", "Type": "User",' +
				'"Requires": {"UID": "CreatorUserID_Hide"}' +
			'},' +
			'"UsersCount": {"Action": "Report", ' +
		   		'"ModuleIdentifier": "CN", "ReportName": "CreatorUsersReport",' +
		   		'"Rename": {"CreatorNodeID": "MembershipNodeID"}, ' + 
		   		'"Requires": {"NodeID": {"Value": "NodeID_Hide", "Title": "Node"}}, ' + 
		   		'"Params": {}' + 
		   	'}' +
		   '}') AS Actions
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_NodesOwnNodesReport]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_NodesOwnNodesReport]
GO

CREATE PROCEDURE [dbo].[CN_NodesOwnNodesReport]
	@ApplicationID			uniqueidentifier,
	@CurrentUserID			uniqueidentifier,
	@NodeTypeID				uniqueidentifier,
	@CreatorNodeTypeID		uniqueidentifier,
	@strNodeIDs				varchar(max),
	@delimiter				char,
	@LowerCreationDateLimit datetime, 
	@UpperCreationDateLimit datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @NodeIDs GuidTableType
	INSERT INTO @NodeIDs
	SELECT Ref.Value FROM [dbo].[GFN_StrToGuidTable](@strNodeIDs, @delimiter) AS Ref
	
	IF @CreatorNodeTypeID IS NOT NULL AND (SELECT COUNT(*) FROM @NodeIDs) = 0 BEGIN
		INSERT INTO @NodeIDs
		SELECT NodeID
		FROM [dbo].[CN_Nodes]
		WHERE ApplicationID = @ApplicationID AND 
			NodeTypeID = @CreatorNodeTypeID AND Deleted = 0
	END
	

	SELECT ND.NodeID AS NodeID_Hide, MAX(ND.NodeName) AS [Node], 
		MAX(ND.TypeName) AS [NodeType], MAX(Ref.[Count]) AS [Count]
	FROM
		(
			SELECT ND.OwnerID, COUNT(DISTINCT ND.NodeID) AS [Count]
			FROM @NodeIDs AS NDS
				INNER JOIN [dbo].[CN_Nodes] AS ND
				ON ND.ApplicationID = @ApplicationID AND ND.OwnerID = NDS.Value
			WHERE (@NodeTypeID IS NULL OR ND.NodeTypeID = @NodeTypeID) AND 
				ND.Deleted = 0 AND
				(@LowerCreationDateLimit IS NULL OR 
					ND.CreationDate >= @LowerCreationDateLimit) AND
				(@UpperCreationDateLimit IS NULL OR 
					ND.CreationDate <= @UpperCreationDateLimit)
			GROUP BY ND.OwnerID
		) AS Ref
		INNER JOIN [dbo].[CN_View_Nodes_Normal] AS ND
		ON ND.ApplicationID = @ApplicationID AND ND.NodeID = Ref.OwnerID
	GROUP BY ND.NodeID
	ORDER BY MAX(Ref.[Count]) DESC

	
	SELECT ('{' +
			'"Node": {"Action": "Link", "Type": "Node",' +
				'"Requires": {"ID": "NodeID_Hide"}' +
			'},' +
		   	'"Count": {"Action": "Report", 
		   		"ModuleIdentifier": "CN", "ReportName": "NodeOwnNodesReport",' +
		   		'"Requires": {"CreatorNodeID": {"Value": "NodeID_Hide", ' + 
		   		'"Title": "~[[Node]] (~[[NodeType]])"}} ' +
		   	'}' +
		   '}') AS Actions
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_NodeOwnNodesReport]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_NodeOwnNodesReport]
GO

CREATE PROCEDURE [dbo].[CN_NodeOwnNodesReport]
	@ApplicationID			uniqueidentifier,
	@CurrentUserID			uniqueidentifier,
	@NodeTypeID				uniqueidentifier,
	@CreatorNodeID			uniqueidentifier,
	@LowerCreationDateLimit datetime, 
	@UpperCreationDateLimit datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON

	SELECT	NC.NodeID AS NodeID_Hide, 
			MAX(ND.Name) AS Node,
			MAX(ND.AdditionalID) AS AdditionalID,
			MAX(Conf.[Level]) AS Classification,
			MAX(ND.CreationDate) AS CreationDate,
			COUNT(NC.UserID) AS UsersCount, 
			CASE
				WHEN ISNULL(COUNT(NC.UserID), 1) = 0 THEN 0
				ELSE ISNULL(SUM(NC.CollaborationShare), 0) / ISNULL(COUNT(NC.UserID), 1)
			END AS Collaboration,
			MAX(ND.WFState) AS WorkFlowState
	FROM [dbo].[CN_Nodes] AS ND
		INNER JOIN [dbo].[CN_NodeCreators] AS NC
		ON NC.ApplicationID = @ApplicationID AND NC.NodeID = ND.NodeID
		LEFT JOIN [dbo].[PRVC_View_Confidentialities] AS Conf
		ON Conf.ApplicationID = @ApplicationID AND Conf.ObjectID = ND.NodeID
	WHERE ND.ApplicationID = @ApplicationID AND ND.OwnerID = @CreatorNodeID AND 
		(@NodeTypeID IS NULL OR ND.NodeTypeID = @NodeTypeID) AND 
		NC.Deleted = 0 AND ND.Deleted = 0 AND
		(@LowerCreationDateLimit IS NULL OR 
			ND.CreationDate >= @LowerCreationDateLimit) AND
		(@UpperCreationDateLimit IS NULL OR 
			ND.CreationDate <= @UpperCreationDateLimit)
	GROUP BY NC.NodeID

	
	SELECT ('{' +
			'"Node": {"Action": "Link", "Type": "Node",' +
				'"Requires": {"ID": "NodeID_Hide"}' +
			'},' +
			'"UsersCount": {"Action": "Report", ' +
		   		'"ModuleIdentifier": "CN", "ReportName": "CreatorUsersReport",' +
		   		'"Rename": {"CreatorNodeID": "MembershipNodeID"}, ' + 
		   		'"Requires": {"NodeID": {"Value": "NodeID_Hide", "Title": "Node"}}, ' + 
		   		'"Params": {}' + 
		   	'}' +
		   '}') AS Actions
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_RelatedNodesCountReport]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_RelatedNodesCountReport]
GO

CREATE PROCEDURE [dbo].[CN_RelatedNodesCountReport]
	@ApplicationID		uniqueidentifier,
	@CurrentUserID		uniqueidentifier,
	@NodeTypeID			uniqueidentifier,
	@RelatedNodeTypeID	uniqueidentifier,
	@CreationDateFrom	datetime,
	@CreationDateTo		datetime,
	@In					bit,
	@Out				bit,
	@InTags				bit,
	@OutTags			bit
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON

	DECLARE @NodeIDs GuidTableType
	DECLARE @NodeTypeIDs GuidTableType
	DECLARE @RelatedNodeTypeIDs GuidTableType

	IF @NodeTypeID IS NULL RETURN

	INSERT INTO @NodeTypeIDs (Value)
	VALUES (@NodeTypeID)

	IF @RelatedNodeTypeID IS NOT NULL BEGIN
		INSERT INTO @RelatedNodeTypeIDs (Value)
		VALUES (@RelatedNodeTypeID)
	END

	SELECT	ND.NodeID AS NodeID_Hide,
			ND.NodeName AS Name,
			ND.NodeAdditionalID AS AdditionalID,
			X.CNT AS [Count]
	FROM (
			SELECT Ref.NodeID, COUNT(Ref.RelatedNodeID) AS CNT
			FROM [dbo].[CN_FN_GetRelatedNodeIDs](@ApplicationID, 
					@NodeIDs, @NodeTypeIDs, @RelatedNodeTypeIDs, @In, @Out, @InTags, @OutTags) AS Ref
			GROUP BY Ref.NodeID
		) AS X
		INNER JOIN [dbo].[CN_View_Nodes_Normal] AS ND
		ON ND.ApplicationID = @ApplicationID AND ND.NodeID = X.NodeID
	WHERE (@CreationDateFrom IS NULL OR ND.CreationDate >= @CreationDateFrom) AND
		(@CreationDateTo IS NULL OR ND.CreationDate < @CreationDateTo)
	ORDER BY X.CNT DESC, ND.CreationDate DESC
	
	SELECT ('{' +
			'"Name": {"Action": "Link", "Type": "Node",' +
				'"Requires": {"ID": "NodeID_Hide"}' +
			'},' +
			'"Count": {"Action": "Report", ' +
		   		'"ModuleIdentifier": "CN", "ReportName": "RelatedNodesReport",' +
		   		'"Requires": {"NodeID": {"Value": "NodeID_Hide", "Title": "Name"}}, ' + 
		   		'"Params": {}' + 
		   	'}' +
		   '}') AS Actions
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_RelatedNodesReport]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_RelatedNodesReport]
GO

CREATE PROCEDURE [dbo].[CN_RelatedNodesReport]
	@ApplicationID		uniqueidentifier,
	@CurrentUserID		uniqueidentifier,
	@NodeID				uniqueidentifier,
	@RelatedNodeTypeID	uniqueidentifier,
	@CreationDateFrom	datetime,
	@CreationDateTo		datetime,
	@In					bit,
	@Out				bit,
	@InTags				bit,
	@OutTags			bit
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON

	DECLARE @NodeIDs GuidTableType
	DECLARE @NodeTypeIDs GuidTableType
	DECLARE @RelatedNodeTypeIDs GuidTableType

	IF @NodeID IS NULL RETURN

	INSERT INTO @NodeIDs (Value)
	VALUES (@NodeID)

	IF @RelatedNodeTypeID IS NOT NULL BEGIN
		INSERT INTO @RelatedNodeTypeIDs (Value)
		VALUES (@RelatedNodeTypeID)
	END

	SELECT	R.NodeID AS NodeID_Hide,
			R.NodeName AS Name,
			R.NodeAdditionalID AS AdditionalID,
			R.TypeName AS NodeType
	FROM [dbo].[CN_FN_GetRelatedNodeIDs](@ApplicationID, 
			@NodeIDs, @NodeTypeIDs, @RelatedNodeTypeIDs, @In, @Out, @InTags, @OutTags) AS Ref
		INNER JOIN [dbo].[CN_View_Nodes_Normal] AS ND
		ON ND.ApplicationID = @ApplicationID AND ND.NodeID = Ref.NodeID
		INNER JOIN [dbo].[CN_View_Nodes_Normal] AS R
		ON R.ApplicationID = @ApplicationID AND R.NodeID = Ref.RelatedNodeID
	WHERE (@CreationDateFrom IS NULL OR ND.CreationDate >= @CreationDateFrom) AND
		(@CreationDateTo IS NULL OR ND.CreationDate < @CreationDateTo)
	ORDER BY ND.CreationDate DESC
	
	SELECT ('{' +
			'"Name": {"Action": "Link", "Type": "Node",' +
				'"Requires": {"ID": "NodeID_Hide"}' +
			'}' +
		   '}') AS Actions
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[CN_DownloadedFilesReport]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[CN_DownloadedFilesReport]
GO

CREATE PROCEDURE [dbo].[CN_DownloadedFilesReport]
	@ApplicationID	uniqueidentifier,
	@CurrentUserID	uniqueidentifier,
	@strNodeTypeIDs	varchar(max),
	@strUserIDs		varchar(max),
	@Delimiter		char,
	@BeginDate		datetime, 
	@FinishDate		datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON

	DECLARE @NodeTypeIDs GuidTableType
	DECLARE @UserIDs GuidTableType
	
	INSERT INTO @NodeTypeIDs (Value)
	SELECT DISTINCT Ref.Value 
	FROM [dbo].[GFN_StrToGuidTable](@strNodeTypeIDs, @delimiter) AS Ref
	
	INSERT INTO @UserIDs (Value)
	SELECT DISTINCT Ref.Value 
	FROM [dbo].[GFN_StrToGuidTable](@strUserIDs, @delimiter) AS Ref

	DECLARE @HasUserID bit = CAST(ISNULL((SELECT TOP(1) 1 FROM @UserIDs), 0) AS bit)
	DECLARE @HasNodeTypeID bit = CAST(ISNULL((SELECT TOP(1) 1 FROM @NodeTypeIDs), 0) AS bit)
	
	DECLARE @Empty uniqueidentifier = N'00000000-0000-0000-0000-000000000000'
	
	DECLARE @Logs TABLE (LogID bigint, SubjectID uniqueidentifier, UserID uniqueidentifier, [Date] datetime)
	
	INSERT INTO @Logs (LogID, SubjectID, UserID, [Date])
	SELECT LG.LogID, LG.SubjectID, LG.UserID, LG.[Date]
	FROM [dbo].[LG_Logs] AS LG
	WHERE LG.ApplicationID = @ApplicationID AND LG.[Action] = N'Download' AND
		LG.SubjectID IS NOT NULL AND LG.SubjectID <> @Empty AND
		(@HasUserID = 0 OR LG.UserID IN (SELECT U.Value FROM @UserIDs AS U)) AND
		(@BeginDate IS NULL OR LG.[Date] >= @BeginDate) AND
		(@FinishDate IS NULL OR LG.[Date] <= @FinishDate)
		
	DECLARE @FileIDs GuidTableType
	
	INSERT INTO @FileIDs
	SELECT DISTINCT LG.SubjectID
	FROM @Logs AS LG
	WHERE LG.SubjectID IS NOT NULL
	
	DECLARE @Extensions StringTableType
	
	INSERT INTO @Extensions (Value)
	VALUES (N'jpg'), (N'png'), (N'gif'), (N'jpeg'), (N'bmp')
	
	SELECT TOP(2000)	
			((ROW_NUMBER() OVER (ORDER BY Ref.LogID_Hide DESC)) +
			(ROW_NUMBER() OVER (ORDER BY Ref.LogID_Hide ASC)) - 1) AS TotalCount_Hide,
			Ref.*
	FROM (
			SELECT	MAX(LG.LogID) AS LogID_Hide,
					CAST(MAX(CAST(X.NodeID AS varchar(50))) AS uniqueidentifier) AS NodeID_Hide,
					CAST(MAX(CAST(UN.UserID AS varchar(50))) AS uniqueidentifier) AS UserID_Hide,
					MAX(LTRIM(RTRIM(ISNULL(UN.FirstName, N'') + N' ' + ISNULL(UN.LastName, N'')))) AS FullName,
					MAX(UN.UserName) AS UserName,
					MAX(X.NodeName) AS NodeName,
					MAX(X.NodeType) AS NodeType,
					MAX(X.[FileName]) AS [FileName],
					MAX(X.Extension) AS Extension,
					MAX(LG.[Date]) AS LastDownloadDate,
					COUNT(DISTINCT LG.LogID) AS DownloadsCount
			FROM @Logs AS LG
				INNER JOIN [dbo].[DCT_FN_GetFileOwnerNodes](@ApplicationID, @FileIDs) AS X
				INNER JOIN [dbo].[DCT_Files] AS F
				ON F.ApplicationID = @ApplicationID AND F.FileNameGuid = X.FileID
				ON F.FileNameGuid = LG.SubjectID AND
					(@HasNodeTypeID = 0 OR X.NodeTypeID IN (SELECT A.Value FROM @NodeTypeIDs AS A))
				INNER JOIN [dbo].[Users_Normal] AS UN
				ON UN.ApplicationID = @ApplicationID AND UN.UserID = LG.UserID
			WHERE LOWER(ISNULL(X.Extension, N'')) NOT IN (SELECT A.Value FROM @Extensions AS A)
			GROUP BY LG.SubjectID, LG.UserID
		) AS Ref
	ORDER BY Ref.LogID_Hide DESC

	SELECT ('{' +
			'"NodeName": {"Action": "Link", "Type": "Node",' +
				'"Requires": {"ID": "NodeID_Hide"}' +
			'},' +
			'"FullName": {"Action": "Link", "Type": "User",' +
				'"Requires": {"UID": "UserID_Hide"}' +
			'}' +
		   '}') AS Actions
END

GO

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_UsersListReport]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_UsersListReport]
GO

CREATE PROCEDURE [dbo].[USR_UsersListReport]
	@ApplicationID			uniqueidentifier,
	@CurrentUserID			uniqueidentifier,
    @EmploymentType			varchar(20),
    @SearchText				nvarchar(1000),
    @IsApproved				bit,
    @LowerBirthDateLimit	datetime,
    @UpperBirthDateLimit	datetime,
    @LowerCreationDateLimit	datetime,
    @UpperCreationDateLimit	datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SET @SearchText = [dbo].[GFN_GetSearchText](@SearchText)
	
	DECLARE @Results Table(UserID_Hide uniqueidentifier primary key clustered,
		Name nvarchar(1000), UserName nvarchar(1000), Birthday datetime,
		JobTitle nvarchar(1000), EmploymentType_Dic varchar(50), CreationDate datetime,
		DepartmentID_Hide uniqueidentifier, Department nvarchar(1000))
	
	IF @SearchText IS NULL BEGIN
		INSERT INTO @Results(
			UserID_Hide, Name, UserName, Birthday, JobTitle, EmploymentType_Dic, CreationDate
		)
		SELECT	UN.UserID AS UserID_Hide,
				LTRIM(RTRIM((ISNULL(UN.FirstName, N'') + N' ' + ISNULL(UN.LastName, N'')))) AS Name,
				UN.UserName AS UserName,
				UN.BirthDay,
				UN.JobTitle,
				UN.EmploymentType,
				UN.CreationDate
		FROM [dbo].[Users_Normal] AS UN
		WHERE UN.ApplicationID = @ApplicationID AND
			(@EmploymentType IS NULL OR UN.EmploymentType = @EmploymentType) AND
			(@LowerBirthDateLimit IS NULL OR UN.BirthDay >= @LowerBirthDateLimit) AND
			(@UpperBirthDateLimit IS NULL OR UN.BirthDay <= @UpperBirthDateLimit) AND
			(@LowerCreationDateLimit IS NULL OR UN.CreationDate >= @LowerCreationDateLimit) AND
			(@UpperCreationDateLimit IS NULL OR UN.CreationDate <= @UpperCreationDateLimit) AND 
			UN.IsApproved = ISNULL(@IsApproved, 1)
	END
	ELSE BEGIN
		INSERT INTO @Results(
			UserID_Hide, Name, UserName, Birthday, JobTitle, EmploymentType_Dic, CreationDate
		)
		SELECT	UN.UserID AS UserID_Hide,
				LTRIM(RTRIM((ISNULL(UN.FirstName, N'') + N' ' + ISNULL(UN.LastName, N'')))) AS Name,
				UN.UserName AS UserName,
				UN.BirthDay,
				UN.JobTitle,
				UN.EmploymentType,
				UN.CreationDate
		FROM CONTAINSTABLE([dbo].[USR_View_Users], 
			([UserName], [FirstName], [LastName]), @SearchText) AS SRCH
			INNER JOIN [dbo].[Users_Normal] AS UN
			ON UN.ApplicationID = @ApplicationID AND UN.UserID = SRCH.[Key]
		WHERE (@EmploymentType IS NULL OR UN.EmploymentType = @EmploymentType) AND
			(@LowerBirthDateLimit IS NULL OR UN.BirthDay >= @LowerBirthDateLimit) AND
			(@UpperBirthDateLimit IS NULL OR UN.BirthDay <= @UpperBirthDateLimit) AND
			(@LowerCreationDateLimit IS NULL OR UN.CreationDate >= @LowerCreationDateLimit) AND
			(@UpperCreationDateLimit IS NULL OR UN.CreationDate <= @UpperCreationDateLimit) AND
			UN.IsApproved = ISNULL(@IsApproved, 1)
	END
	
	DECLARE @DepTypeIDs GuidTableType
	INSERT INTO @DepTypeIDs (Value)
	SELECT Ref.NodeTypeID
	FROM [dbo].[CN_FN_GetDepartmentNodeTypeIDs](@ApplicationID) AS Ref
	
	UPDATE R
		SET DepartmentID_Hide = Ref.DepartmentID,
			Department = Ref.Department
	FROM @Results AS R
		INNER JOIN (
			SELECT T.UserID_Hide,
				CAST(MAX(CAST(ND.NodeID AS varchar(36))) AS uniqueidentifier) 
					AS DepartmentID,
				MAX(ND.Name) AS Department
			FROM @Results AS T
				LEFT JOIN [dbo].[CN_NodeMembers] AS NM
				LEFT JOIN [dbo].[CN_Nodes] AS ND
				ON ND.ApplicationID = @ApplicationID AND 
					ND.NodeTypeID IN (SELECT Value FROM @DepTypeIDs) AND ND.Deleted = 0
				ON NM.ApplicationID = @ApplicationID AND 
					NM.NodeID = ND.NodeID AND NM.UserID = T.UserID_Hide AND NM.Deleted = 0
			GROUP BY T.UserID_Hide
		) AS Ref
		ON R.UserID_Hide = Ref.UserID_Hide
		
	
	SELECT * FROM @Results
	
	SELECT ('{' +
			'"Name": {"Action": "Link", "Type": "User",' +
				'"Requires": {"UID": "UserID_Hide"}' +
			'},' +
			'"Department": {"Action": "Link", "Type": "Node",' +
				'"Requires": {"ID": "DepartmentID_Hide"}' +
			'}' +
		   '}') AS Actions
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_InvitationsReport]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_InvitationsReport]
GO

CREATE PROCEDURE [dbo].[USR_InvitationsReport]
	@ApplicationID	uniqueidentifier,
	@CurrentUserID	UNIQUEIDENTIFIER,
    @BeginDate		DATETIME,
    @FinishDate		DATETIME
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	;WITH X AS(
		SELECT
			i.SenderUserID,
			COUNT(i.ID) AS SentInvitationsCount,
			COUNT(tu.UserID) AS RegisteredUsersCount,
			COUNT(un.UserID) AS ActivatedUsersCount
		FROM [USR_Invitations] AS i
			LEFT JOIN [USR_TemporaryUsers] AS tu
			ON tu.EMail = i.Email
			LEFT JOIN [Users_Normal] AS un
			ON un.ApplicationID = @ApplicationID AND un.UserID = tu.UserID
		WHERE i.ApplicationID = @ApplicationID AND 
			(@BeginDate IS NULL OR i.SendDate >= @BeginDate) AND
			(@FinishDate IS NULL OR i.SendDate <= @FinishDate)
		GROUP BY i.SenderUserID
	)
	SELECT 
		X.SenderUserID AS SenderUserID_Hide,
		un.FirstName + ' ' + un.LastName AS Name,
		X.SentInvitationsCount,
		X.RegisteredUsersCount,
		X.ActivatedUsersCount
	FROM X
		INNER JOIN [Users_Normal] AS un
		ON un.ApplicationID = @ApplicationID AND un.UserID = X.SenderUserID
	ORDER BY X.SentInvitationsCount DESC
	
	SELECT (
		'{' +
			'"Name": {"Action": "Link", "Type": "User",' +
				'"Requires": {"UID": "SenderUserID_Hide"}' +
			'}'+
		'}') AS Actions
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_UsersMembershipFlowReport]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_UsersMembershipFlowReport]
GO

CREATE PROCEDURE [dbo].[USR_UsersMembershipFlowReport]
	@ApplicationID					uniqueidentifier,
	@CurrentUserID					UNIQUEIDENTIFIER,
	@SenderUserID					UNIQUEIDENTIFIER,
    @LowerInvitationSentDateLimit	DATETIME,
    @UpperInvitationSentDateLimit	DATETIME
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON

	SELECT 
		un.UserID AS UserID_Hide,
		CASE
			WHEN (un.UserID IS NOT NULL) THEN un.FirstName + ' ' + un.LastName
			WHEN (tu.UserID IS NOT NULL) THEN tu.FirstName + ' ' + tu.LastName 
			ELSE N' '
		END AS Name,
		i.Email,
		i.SendDate AS ReceivedDate,
		tu.CreationDate AS RegisterationDate,
		un.CreationDate AS ActivationDate
	FROM [USR_Invitations] AS i
		LEFT JOIN [USR_TemporaryUsers] AS tu
		ON tu.EMail = i.Email
		LEFT JOIN [Users_Normal] AS un
		ON un.ApplicationID = @ApplicationID AND un.UserID = tu.UserID
	WHERE i.ApplicationID = @ApplicationID AND 
		(@SenderUserID IS NULL OR i.SenderUserID = @SenderUserID) AND
		(@LowerInvitationSentDateLimit IS NULL OR i.SendDate >= @LowerInvitationSentDateLimit) AND
		(@UpperInvitationSentDateLimit IS NULL OR i.SendDate <= @UpperInvitationSentDateLimit)
	ORDER BY i.SendDate DESC
	
	SELECT (
		'{' +
			'"Name": {"Action": "Link", "Type": "User",' +
				'"Requires": {"UID": "UserID_Hide"}' +
			'}'+
		'}') AS Actions
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_MostVisitedItemsReport]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_MostVisitedItemsReport]
GO

CREATE PROCEDURE [dbo].[USR_MostVisitedItemsReport]
	@ApplicationID		uniqueidentifier,
	@CurrentUserID		uniqueidentifier,
    @ItemType			varchar(20),
    @NodeTypeID			uniqueidentifier,
    @Count				int,
    @BeginDate			datetime,
    @FinishDate			datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	IF @Count IS NULL OR @Count <= 0 SET @Count = 50
	
	DECLARE @Results Table (ItemID uniqueidentifier primary key clustered, 
		VisitsCount int, LastVisitDate datetime)
	
	IF @NodeTypeID IS NOT NULL BEGIN
		INSERT INTO @Results (ItemID, VisitsCount, LastVisitDate)
		SELECT TOP(@Count) Ref.ItemID, Ref.[Count], Ref.VisitDate
		FROM (
				SELECT IV.ItemID, COUNT(IV.ItemID) AS [Count], MAX(IV.VisitDate) AS VisitDate
				FROM [dbo].[USR_ItemVisits] AS IV
					INNER JOIN [dbo].[CN_Nodes] AS ND
					ON ND.ApplicationID = @ApplicationID AND ND.NodeID = IV.ItemID
				WHERE IV.ApplicationID = @ApplicationID AND ND.NodeTypeID = @NodeTypeID AND
					(@BeginDate IS NULL OR IV.VisitDate >= @BeginDate) AND
					(@FinishDate IS NULL OR IV.VisitDate <= @FinishDate)
				GROUP BY IV.ItemID
			) AS Ref
		ORDER BY Ref.[Count] DESC, Ref.VisitDate DESC
	END
	ELSE BEGIN
		INSERT INTO @Results (ItemID, VisitsCount, LastVisitDate)
		SELECT TOP(@Count) Ref.ItemID, Ref.[Count], Ref.VisitDate
		FROM (
				SELECT ItemID, COUNT(ItemID) AS [Count], MAX(VisitDate) AS VisitDate
				FROM [dbo].[USR_ItemVisits]
				WHERE ApplicationID = @ApplicationID AND ItemType = @ItemType AND
					(@BeginDate IS NULL OR VisitDate >= @BeginDate) AND
					(@FinishDate IS NULL OR VisitDate <= @FinishDate)
				GROUP BY ItemID
			) AS Ref
		ORDER BY Ref.[Count] DESC, Ref.VisitDate DESC
	END
	
	IF @ItemType = N'User' BEGIN
		SELECT R.ItemID AS ItemID_Hide, 
			(UN.FirstName + N' ' + UN.LastName) AS ItemName, 
			UN.UserName,
			R.VisitsCount
		FROM @Results AS R
			INNER JOIN [dbo].[Users_Normal] AS UN
			ON UN.ApplicationID = @ApplicationID AND UN.UserID = R.ItemID
		ORDER BY R.VisitsCount DESC, R.LastVisitDate DESC
	END
	ELSE BEGIN
		SELECT R.ItemID AS ItemID_Hide, ND.NodeName AS ItemName, R.VisitsCount
		FROM @Results AS R
			INNER JOIN [dbo].[CN_View_Nodes_Normal] AS ND
			ON ND.ApplicationID = @ApplicationID AND ND.NodeID = R.ItemID
		ORDER BY R.VisitsCount DESC, R.LastVisitDate DESC
	END
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_P_UsersPerformanceReport]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_P_UsersPerformanceReport]
GO

CREATE PROCEDURE [dbo].[USR_P_UsersPerformanceReport]
	@ApplicationID			uniqueidentifier,
    @UserGroupIDsTemp		GuidPairTableType readonly,
    @KnowledgeTypeIDsTemp	GuidTableType readonly,
    @CompensatePerScore		bit,
    @CompensationVolume		float,
    @ScoreItemsTemp			FloatStringTableType readonly,
    @BeginDate				datetime,
    @FinishDate				datetime
WITH ENCRYPTION, RECOMPILE
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @Users TABLE (UserID uniqueidentifier primary key clustered, GroupID uniqueidentifier, GroupName nvarchar(500)) 
	INSERT INTO @Users (UserID, GroupID, GroupName)
	SELECT T.FirstValue, ND.NodeID, ND.Name
	FROM @UserGroupIDsTemp AS T
		LEFT JOIN [dbo].[CN_Nodes] AS ND
		ON ND.ApplicationID = @ApplicationID AND ND.NodeID = T.SecondValue
	
    DECLARE @KnowledgeTypeIDs GuidTableType
    INSERT INTO @KnowledgeTypeIDs SELECT * FROM @KnowledgeTypeIDsTemp
    
    DECLARE @ScoreItems FloatStringTableType
    INSERT INTO @ScoreItems SELECT * FROM @ScoreItemsTemp

	SELECT Data.*
	INTO #Results
	FROM (
			-- (1)        
			---- ItemName: SharesOnWall ----
			SELECT USERS.UserID, POSTS.Score, N'AA_SharesOnWall' AS ItemName 
			FROM @Users AS USERS
				LEFT JOIN (
					SELECT PS.SenderUserID, ISNULL(COUNT(PS.ShareID), 0) AS Score 
					FROM [dbo].[SH_PostShares] AS PS
					WHERE PS.ApplicationID = @ApplicationID AND 
						PS.OwnerType = N'User' AND PS.Deleted = 0 AND
						(@BeginDate IS NULL OR PS.SendDate >= @BeginDate) AND
						(@FinishDate IS NULL OR PS.SendDate <= @FinishDate)
					GROUP BY PS.SenderUserID
				) AS POSTS
				ON USERS.UserID = POSTS.SenderUserID
			-- end of (1)

			UNION ALL

			-- (8)        
			---- ItemName: ReceivedSharesOnKnowledges ----
			SELECT USR.UserID, (
				(SELECT ISNULL(COUNT(PS.ShareID), 0)
				 FROM [dbo].[SH_PostShares] AS PS
					INNER JOIN [dbo].[KW_View_Knowledges] AS VK
					INNER JOIN [dbo].[CN_NodeCreators] AS NC
					ON NC.ApplicationID = @ApplicationID AND NC.NodeID = VK.KnowledgeID
					ON VK.ApplicationID = @ApplicationID AND VK.KnowledgeID = PS.OwnerID
				 WHERE NC.ApplicationID = @ApplicationID AND 
					NC.UserID = USR.UserID AND NC.Deleted = 0 AND 
					PS.SenderUserID <> USR.UserID AND PS.OwnerType = N'Knowledge' AND
					VK.Deleted = 0 AND PS.Deleted = 0 AND
					(@BeginDate IS NULL OR PS.SendDate >= @BeginDate) AND
					(@FinishDate IS NULL OR PS.SendDate <= @FinishDate))
			), N'AB_ReceivedSharesOnKnowledges'
			FROM @Users AS USR
			-- end of (8)

			UNION ALL

			-- (9)         
			---- ItemName: SentSharesOnKnowledges ----
			SELECT USR.UserID, (
				SELECT ISNULL(COUNT(PS.ShareID), 0)
				FROM [dbo].[SH_PostShares] AS PS
					INNER JOIN [dbo].[KW_View_Knowledges] VK
					ON VK.ApplicationID = @ApplicationID AND VK.KnowledgeID = PS.OwnerID
				WHERE PS.ApplicationID = @ApplicationID AND PS.SenderUserID = USR.UserID AND
					PS.OwnerType = N'Knowledge' AND PS.Deleted = 0 AND
					(@BeginDate IS NULL OR PS.SendDate >= @BeginDate) AND
					(@FinishDate IS NULL OR PS.SendDate <= @FinishDate) AND
					NOT EXISTS(SELECT TOP(1) * FROM [dbo].[CN_NodeCreators] AS NC
						WHERE NC.NodeID = VK.KnowledgeID AND NC.UserID = USR.UserID AND NC.Deleted = 0)
			), N'AC_SentSharesOnKnowledges'
			FROM @Users AS USR
			-- end of (9)

			UNION ALL

			-- (10)         
			---- ItemName: ReceivedTemporalFeedBacks ----
			SELECT USR.UserID, (
				(SELECT ISNULL(SUM(FB.Value), 0)
				 FROM [dbo].[KW_FeedBacks] AS FB
					INNER JOIN [dbo].[KW_View_Knowledges] AS VK
					INNER JOIN [dbo].[CN_NodeCreators] AS NC
					ON NC.ApplicationID = @ApplicationID AND NC.NodeID = VK.KnowledgeID
					ON VK.ApplicationID = @ApplicationID AND VK.KnowledgeID = FB.KnowledgeID
				 WHERE FB.ApplicationID = @ApplicationID AND 
					NC.UserID = USR.UserID AND NC.Deleted = 0 AND 
					FB.FeedBackTypeID = 2 AND FB.UserID <> USR.UserID AND
					VK.Deleted = 0 AND FB.Deleted = 0 AND
					(@BeginDate IS NULL OR FB.SendDate >= @BeginDate) AND
					(@FinishDate IS NULL OR FB.SendDate <= @FinishDate))
			), N'AD_ReceivedTemporalFeedBacks'
			FROM @Users AS USR
			-- end of (10)

			UNION ALL

			-- (11)         
			---- ItemName: ReceivedFinancialFeedBacks ----
			SELECT USR.UserID, (
				(SELECT ISNULL(SUM(FB.Value), 0)
				 FROM [dbo].[KW_FeedBacks] AS FB
					INNER JOIN [dbo].[KW_View_Knowledges] AS VK
					INNER JOIN [dbo].[CN_NodeCreators] AS NC
					ON NC.ApplicationID = @ApplicationID AND NC.NodeID = VK.KnowledgeID
					ON VK.ApplicationID = @ApplicationID AND VK.KnowledgeID = FB.KnowledgeID
				 WHERE FB.ApplicationID = @ApplicationID AND 
					NC.UserID = USR.UserID AND NC.Deleted = 0 AND 
					FB.FeedBackTypeID = 1 AND FB.UserID <> USR.UserID AND
					VK.Deleted = 0 AND FB.Deleted = 0 AND
					(@BeginDate IS NULL OR FB.SendDate >= @BeginDate) AND
					(@FinishDate IS NULL OR FB.SendDate <= @FinishDate))
			), N'AE_ReceivedFinancialFeedBacks'
			FROM @Users AS USR
			-- end of (11)

			UNION ALL

			-- (12)           
			---- ItemName: SentFeedBacksCount ----
			SELECT USR.UserID, (
				SELECT COUNT(FB.Value) 
				FROM [dbo].[KW_FeedBacks] AS FB
					INNER JOIN [dbo].[KW_View_Knowledges] AS VK
					ON VK.ApplicationID = @ApplicationID AND VK.KnowledgeID = FB.KnowledgeID
				WHERE FB.ApplicationID = @ApplicationID AND 
					FB.UserID = USR.UserID AND FB.Deleted = 0 AND
					(@BeginDate IS NULL OR FB.SendDate >= @BeginDate) AND
					(@FinishDate IS NULL OR FB.SendDate <= @FinishDate) AND
					NOT EXISTS(SELECT TOP(1) * FROM [dbo].[CN_NodeCreators] AS NC
						WHERE NC.NodeID = VK.KnowledgeID AND NC.UserID = USR.UserID AND NC.Deleted = 0)
			), N'AF_SentFeedBacksCount'
			FROM @Users AS USR
			-- end of (12)

			UNION ALL

			-- (13)    
			---- ItemName: SentQuestions ----
			SELECT USERS.UserID, ISNULL(QTN.Score, 0), N'AG_SentQuestions' 
			FROM @Users AS USERS
				LEFT JOIN (
					SELECT QU.SenderUserID, COUNT(QU.QuestionID) AS Score
					FROM [dbo].[QA_Questions] AS QU
					WHERE QU.ApplicationID = @ApplicationID AND QU.Deleted = 0 AND 
						(@BeginDate IS NULL OR QU.SendDate >= @BeginDate) AND
						(@FinishDate IS NULL OR QU.SendDate <= @FinishDate)
					GROUP BY QU.SenderUserID
				) AS QTN
				ON USERS.UserID = QTN.SenderUserID
			-- end of (13)

			UNION ALL

			-- (14)          
			---- ItemName: SentAnswers ----
			SELECT USR.UserID, (
				SELECT ISNULL(COUNT(ANS.AnswerID), 0)
				FROM [dbo].[QA_Answers] AS ANS
					INNER JOIN [dbo].[QA_Questions] AS QU
					ON QU.ApplicationID = @ApplicationID AND QU.QuestionID = ANS.QuestionID
				WHERE ANS.ApplicationID = @ApplicationID AND ANS.SenderUserID = USR.UserID AND 
					QU.SenderUserID <> USR.UserID AND ANS.Deleted = 0 AND
					(@BeginDate IS NULL OR ANS.SendDate >= @BeginDate) AND
					(@FinishDate IS NULL OR ANS.SendDate <= @FinishDate)
			), N'AH_SentAnswers'
			FROM @Users AS USR 
			-- end of (14)

			UNION ALL

			-- (15)      
			---- ItemName: KnowledgeOverview ----
			SELECT	USR.UserID,
					SUM(
						CASE 
							WHEN H.[KnowledgeID] IS NOT NULL THEN 1
							ELSE 0
						END
					),
					N'AI_KnowledgeOverview'
			FROM @Users AS USR
				LEFT JOIN (
					SELECT ROW_NUMBER() OVER (PARTITION BY H.KnowledgeID, H.ActorUserID ORDER BY H.ID ASC) AS RowNumber,
						H.KnowledgeID,
						H.ActorUserID,
						H.ActionDate
					FROM [dbo].[KW_History] AS H
					WHERE H.ApplicationID = @ApplicationID AND H.[Action] IN (
							N'Accept', N'Reject', N'SendBackForRevision', 
							N'SendToEvaluators', N'TerminateEvaluation'
						)
				) AS H
				INNER JOIN [dbo].[CN_Nodes] AS ND
				ON ND.ApplicationID = @ApplicationID AND 
					ND.NodeID = H.KnowledgeID AND ND.Deleted = 0
				ON H.RowNumber = 1 AND H.ActorUserID = USR.UserID AND
					(@BeginDate IS NULL OR H.ActionDate >= @BeginDate) AND
					(@FinishDate IS NULL OR H.ActionDate <= @FinishDate) AND
					NOT EXISTS(
						SELECT TOP(1) * 
						FROM [dbo].[CN_NodeCreators] AS NC
						WHERE NC.ApplicationID = @ApplicationID AND 
							NC.NodeID = H.KnowledgeID AND NC.UserID = USR.UserID AND NC.Deleted = 0
					)
			GROUP BY USR.UserID
			-- end of (15)

			UNION ALL

			-- (16)      
			---- ItemName: KnowledgeEvaluation ----
			SELECT	USR.UserID,
					SUM(
						CASE 
							WHEN H.[KnowledgeID] IS NOT NULL THEN 1
							ELSE 0
						END
					),
					N'AJ_KnowledgeEvaluation'
			FROM @Users AS USR
				LEFT JOIN (
					SELECT ROW_NUMBER() OVER (PARTITION BY H.KnowledgeID, H.ActorUserID ORDER BY H.ID ASC) AS RowNumber,
						H.KnowledgeID,
						H.ActorUserID,
						H.ActionDate
					FROM [dbo].[KW_History] AS H
					WHERE H.ApplicationID = @ApplicationID AND H.[Action] IN (N'Evaluation')
				) AS H
				INNER JOIN [dbo].[CN_Nodes] AS ND
				ON ND.ApplicationID = @ApplicationID AND 
					ND.NodeID = H.KnowledgeID AND ND.Deleted = 0
				ON H.RowNumber = 1 AND H.ActorUserID = USR.UserID AND
					(@BeginDate IS NULL OR H.ActionDate >= @BeginDate) AND
					(@FinishDate IS NULL OR H.ActionDate <= @FinishDate) AND
					NOT EXISTS(
						SELECT TOP(1) * 
						FROM [dbo].[CN_NodeCreators] AS NC
						WHERE NC.ApplicationID = @ApplicationID AND 
							NC.NodeID = H.KnowledgeID AND NC.UserID = USR.UserID AND NC.Deleted = 0
					)
			GROUP BY USR.UserID
			-- end of (16)

			UNION ALL

			-- (17)  
			---- ItemName: CommunityScore ----
			SELECT USR.UserID, (
				(
					SELECT ISNULL(COUNT(ANS.AnswerID), 0)
					FROM [dbo].[QA_Answers] AS ANS
						INNER JOIN [dbo].[QA_Questions] AS QU
						ON QU.ApplicationID = @ApplicationID AND QU.QuestionID = ANS.QuestionID
					WHERE ANS.ApplicationID = @ApplicationID AND 
						ANS.SenderUserID = USR.UserID AND QU.SenderUserID <> USR.UserID AND 
						ANS.Deleted = 0 AND
						(@BeginDate IS NULL OR ANS.SendDate >= @BeginDate) AND
						(@FinishDate IS NULL OR ANS.SendDate <= @FinishDate)
				) + (
					SELECT CAST(ISNULL(COUNT(PS.ShareID), 0) AS float)
					FROM [dbo].[SH_PostShares] AS PS
					WHERE PS.ApplicationID = @ApplicationID AND PS.SenderUserID = USR.UserID AND
						PS.OwnerType = N'Node' AND PS.Deleted = 0 AND
						(@BeginDate IS NULL OR PS.SendDate >= @BeginDate) AND
						(@FinishDate IS NULL OR PS.SendDate <= @FinishDate)
				)
			), N'AK_CommunityScore'
			FROM @Users AS USR
			-- end of (17)

			UNION ALL

			-- (18)     
			---- ItemName: AcceptedWikiChanges ----
			SELECT USERS.UserID, ISNULL(CNG.Score, 0), N'AL_AcceptedWikiChanges' 
			FROM @Users AS USERS
				LEFT JOIN (
					SELECT CH.UserID, COUNT(CH.ChangeID) AS Score
					FROM [dbo].[WK_Changes] AS CH
					WHERE CH.ApplicationID = @ApplicationID AND CH.[Status] = N'Accepted' AND
						(@BeginDate IS NULL OR CH.AcceptionDate >= @BeginDate) AND
						(@FinishDate IS NULL OR CH.AcceptionDate <= @FinishDate)
					GROUP BY CH.UserID
				) AS CNG
				ON USERS.UserID = CNG.UserID
			-- end of (18)

			UNION ALL

			-- (19)        
			---- ItemName: WikiEvaluation ----
			SELECT USERS.UserID, ISNULL(CNG.Score, 0), N'AM_WikiEvaluation' 
			FROM @Users AS USERS
				LEFT JOIN (
					SELECT CH.EvaluatorUserID, COUNT(CH.ChangeID) AS Score
					FROM [dbo].[WK_Changes] AS CH
					WHERE CH.ApplicationID = @ApplicationID AND 
						(@BeginDate IS NULL OR CH.EvaluationDate >= @BeginDate) AND
						(@FinishDate IS NULL OR CH.EvaluationDate <= @FinishDate)
					GROUP BY CH.EvaluatorUserID
				) AS CNG
				ON USERS.UserID = CNG.EvaluatorUserID
			-- end of (19)

			UNION ALL

			-- (20)      
			---- ItemName: PersonalPageVisit ----
			SELECT USR.UserID, 
				(
					SELECT COUNT(IV.UserID) 
					FROM [dbo].[USR_ItemVisits] AS IV
					WHERE IV.ApplicationID = @ApplicationID AND IV.ItemID = USR.UserID AND
						(@BeginDate IS NULL OR IV.VisitDate >= @BeginDate) AND
						(@FinishDate IS NULL OR IV.VisitDate <= @FinishDate)
				), N'AN_PersonalPageVisit'
			FROM @Users AS USR
			-- end of (20)
			
			UNION ALL
			
			-- (N)  
			SELECT	USERS.UserID AS UserID, ISNULL(KN.Score, 0), KN.RegisteredType
			FROM @Users AS USERS
				LEFT JOIN (
					SELECT	NC.UserID,
							N'AO_Registered_' + REPLACE(CAST(ND.NodeTypeID AS varchar(100)), '-', '') AS RegisteredType, 
							SUM(
								CASE
									WHEN (@BeginDate IS NULL OR ND.CreationDate >= @BeginDate) AND
										(@FinishDate IS NULL OR ND.CreationDate <= @FinishDate) THEN 1
									ELSE 0
								END * (NC.CollaborationShare / 100)
							) AS Score
					FROM @KnowledgeTypeIDs AS K
						INNER JOIN [dbo].[CN_Nodes] AS ND
						ON ND.ApplicationID = @ApplicationID AND ND.NodeTypeID = K.Value
						INNER JOIN [dbo].[CN_NodeCreators] AS NC
						ON NC.ApplicationID = @ApplicationID AND NC.NodeID = ND.NodeID
					WHERE ND.Deleted = 0 AND NC.Deleted = 0
					GROUP BY NC.UserID, ND.NodeTypeID
				) AS KN
				ON USERS.UserID = KN.UserID
				
			UNION ALL

			SELECT	USERS.UserID AS UserID, ISNULL(KN.Score, 0), KN.AcceptedTypeCount
			FROM @Users AS USERS
				LEFT JOIN (
					SELECT	NC.UserID,
							N'AP_AcceptedCount_' + REPLACE(CAST(ND.NodeTypeID AS varchar(100)), '-', '') AS AcceptedTypeCount,
							SUM(
								CASE
									WHEN ND.[Status] = N'Accepted' AND 
										(@BeginDate IS NULL OR ISNULL(ND.PublicationDate, ND.CreationDate) >= @BeginDate) AND
										(@FinishDate IS NULL OR ISNULL(ND.PublicationDate, ND.CreationDate) <= @FinishDate)
										THEN 1
									ELSE 0
								END * (NC.CollaborationShare / 100)
							) AS Score
					FROM @KnowledgeTypeIDs AS K
						INNER JOIN [dbo].[CN_Nodes] AS ND
						ON ND.ApplicationID = @ApplicationID AND ND.NodeTypeID = K.Value
						INNER JOIN [dbo].[CN_NodeCreators] AS NC
						ON NC.ApplicationID = @ApplicationID AND NC.NodeID = ND.NodeID
					WHERE ND.Deleted = 0 AND NC.Deleted = 0
					GROUP BY NC.UserID, ND.NodeTypeID
				) AS KN
				ON USERS.UserID = KN.UserID
				
			UNION ALL

			SELECT	USERS.UserID AS UserID, ISNULL(KN.Score, 0), KN.AcceptedTypeScore
			FROM @Users AS USERS
				LEFT JOIN (
					SELECT	NC.UserID,
							N'AQ_AcceptedScore_' + REPLACE(CAST(ND.NodeTypeID AS varchar(100)), '-', '') AS AcceptedTypeScore,
							SUM(
								CASE
									WHEN ND.[Status] = N'Accepted' AND 
										(@BeginDate IS NULL OR ISNULL(ND.PublicationDate, ND.CreationDate) >= @BeginDate) AND
										(@FinishDate IS NULL OR ISNULL(ND.PublicationDate, ND.CreationDate) <= @FinishDate)
										THEN ISNULL(ND.Score, 0)
									ELSE 0
								END * (NC.CollaborationShare / 100)
							) AS Score
					FROM @KnowledgeTypeIDs AS K
						INNER JOIN [dbo].[CN_Nodes] AS ND
						ON ND.ApplicationID = @ApplicationID AND ND.NodeTypeID = K.Value
						INNER JOIN [dbo].[CN_NodeCreators] AS NC
						ON NC.ApplicationID = @ApplicationID AND NC.NodeID = ND.NodeID
					WHERE ND.Deleted = 0 AND NC.Deleted = 0
					GROUP BY NC.UserID, ND.NodeTypeID
				) AS KN
				ON USERS.UserID = KN.UserID
			-- end of (N)
		) AS Data
		INNER JOIN @ScoreItems AS SI
		ON SI.SecondValue = Data.ItemName AND SI.FirstValue > 0
	
	
	DECLARE @ItemsList VARCHAR(MAX)   

	SELECT @ItemsList = ISNULL(@ItemsList + ', ', '') + '[' + ItemName + ']'
	FROM (SELECT DISTINCT ItemName FROM #Results) AS q
	ORDER BY q.ItemName
	
	CREATE TABLE #TMPR (UserID_Hide uniqueidentifier, GroupID_Hide uniqueidentifier, 
		Name nvarchar(1000), UserName nvarchar(256), GroupName nvarchar(500),
		Score float, Compensation float
	)
	
	INSERT INTO #TMPR (UserID_Hide)
	SELECT DISTINCT UserID
	FROM #Results AS R
	
	-- Compute Users' Scores
	UPDATE T
		SET Score = Ref.Score
	FROM #TMPR AS T
		INNER JOIN (
			SELECT R.UserID, SUM(ISNULL(S.FirstValue, 0) * ISNULL(R.Score, 0)) AS Score
			FROM #Results AS R
				INNER JOIN @ScoreItems AS S
				ON LOWER(R.ItemName) = LOWER(S.SecondValue)
			GROUP BY R.UserID
		) AS Ref
		ON T.UserID_Hide = Ref.UserID
	-- end of Compute Users' Scores
	
	-- Compute Users' Compensations
	DECLARE @ScoreReward float = @CompensationVolume
	
	IF(@CompensatePerScore IS NULL OR @CompensatePerScore = 0)
		SET @ScoreReward = @CompensationVolume / (SELECT SUM(Score) FROM #TMPR)
	
	UPDATE #TMPR
	SET Compensation = Score * ISNULL(@ScoreReward, 0)
	-- end of Compute Users' Compensations
	
	-- Determine Full Names & Groups
	UPDATE R
		SET GroupID_Hide = U.GroupID,
			Name = LTRIM(RTRIM(ISNULL(UN.FirstName, N'') + N' ' + ISNULL(UN.LastName, N''))),
			UserName = UN.UserName,
			GroupName = U.GroupName
	FROM #TMPR AS R
		INNER JOIN @Users AS U
		ON U.UserID = R.UserID_Hide
		INNER JOIN [dbo].[Users_Normal] AS UN
		ON UN.ApplicationID = @ApplicationID AND UN.UserID = U.UserID
	-- end of Determine Names & Departments
	
	
	EXEC (
		'SELECT ROW_NUMBER() OVER(ORDER BY T.Score DESC, T.UserID_Hide ASC) AS [Rank], T.UserID_Hide, T.GroupID_Hide, T.Name, T.UserName, ' +
			'T.GroupName, T.Score, T.Compensation, ' + @ItemsList + ' ' +
		'FROM #TMPR AS T ' +
			'INNER JOIN ( ' +
				'SELECT UserID, ' + @ItemsList + ' ' +
				'FROM ( ' +
						'SELECT UserID, Score, ItemName ' +
						'FROM #Results ' +
					') AS P ' +
					'PIVOT ' +
					'(SUM(Score) FOR ItemName IN (' + @ItemsList + ')) AS PVT ' +
			') AS X ' +
			'ON X.UserID = T.UserID_Hide ' +
		'ORDER BY T.Score DESC, T.UserID_Hide ASC'
	)
	
	SELECT ('{' +
			'"Name": {"Action": "Link", "Type": "User",' +
				'"Requires": {"UID": "UserID_Hide"}' +
			'},' +
			'"GroupName": {"Action": "Link", "Type": "Node",' +
				'"Requires": {"ID": "GroupID_Hide"}' +
			'}' +
		   '}') AS Actions
	
	SELECT *
	FROM (
		SELECT	'AO_Registered_' + REPLACE(CAST(NT.NodeTypeID AS varchar(100)), '-', '') AS ColumnName,
				N' ''' + NT.Name + N'''  ' AS Translation,
				'double' AS [Type]
		FROM @KnowledgeTypeIDs AS K
			INNER JOIN [dbo].[CN_NodeTypes] AS NT
			ON NT.NodeTypeID = K.Value
			
		UNION ALL
		
		SELECT	'AP_AcceptedCount_' + REPLACE(CAST(NT.NodeTypeID AS varchar(100)), '-', '') AS ColumnName,
				N' ''' + NT.Name + N'''  ' AS Translation,
				'double' AS [Type]
		FROM @KnowledgeTypeIDs AS K
			INNER JOIN [dbo].[CN_NodeTypes] AS NT
			ON NT.NodeTypeID = K.Value
		
		UNION ALL
		
		SELECT	'AQ_AcceptedScore_' + REPLACE(CAST(NT.NodeTypeID AS varchar(100)), '-', '') AS ColumnName,
				N'  ''' + NT.Name + N'''  ' AS Translation,
				'double' AS [Type]
		FROM @KnowledgeTypeIDs AS K
			INNER JOIN [dbo].[CN_NodeTypes] AS NT
			ON NT.NodeTypeID = K.Value
	) AS X
			
	SELECT ('{"IsDescription": "true", "IsColumnsDictionary": "true"}') AS Info
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_UsersPerformanceReport]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_UsersPerformanceReport]
GO

CREATE PROCEDURE [dbo].[USR_UsersPerformanceReport]
	@ApplicationID			uniqueidentifier,
	@CurrentUserID			uniqueidentifier,
    @strUserIDs				varchar(max),
    @strNodeIDs				varchar(max),
    @strListIDs				varchar(max),
    @strKnowledgeTypeIDs	varchar(max),
    @delimiter				char,
    @BeginDate				datetime,
    @FinishDate				datetime,
    @CompensatePerScore		bit,
    @CompensationVolume		float,
    @strScoreItems			varchar(max),
    @innerDelimiter			char
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @NodeIDs GuidTableType
	
	INSERT INTO @NodeIDs (Value)
	SELECT DISTINCT Ref.Value
	FROM [dbo].[GFN_StrToGuidTable](@strNodeIDs, @delimiter) AS Ref
	
	DECLARE @ListIDs GuidTableType
	
	INSERT INTO @ListIDs (Value)
	SELECT DISTINCT Ref.Value
	FROM [dbo].[GFN_StrToGuidTable](@strListIDs, @delimiter) AS Ref
	
	DECLARE @GroupsCount int = (SELECT COUNT(*) FROM @NodeIDs) + (SELECT COUNT(*) FROM @ListIDs)
	
	DECLARE @ScoreItems FloatStringTableType
	INSERT INTO @ScoreItems (FirstValue, SecondValue)
	SELECT Ref.FirstValue, Ref.SecondValue
	FROM [dbo].[GFN_StrToFloatStringTable](@strScoreItems, @innerDelimiter, @delimiter) AS Ref
	
	DECLARE @UserIDs TABLE (UserID uniqueidentifier, GroupID uniqueidentifier)
	
	INSERT INTO @UserIDs(UserID, GroupID)
	SELECT [UID].UserID, CAST(MAX(CAST([UID].GroupID AS varchar(50))) AS uniqueidentifier) AS GroupID
	FROM (
			SELECT Ref.Value AS UserID, NULL AS GroupID
			FROM GFN_StrToGuidTable(@strUserIDs, @delimiter) AS Ref	
			
			UNION ALL
			
			SELECT NM.UserID AS UserID, NM.NodeID AS GroupID
			FROM (
					SELECT Ref.Value AS Value
					FROM @NodeIDs AS Ref
					
					UNION ALL
					 
					SELECT ND.NodeID
					FROM @ListIDs AS LIDs
						INNER JOIN [dbo].[CN_ListNodes] AS LN
						ON LN.ApplicationID = @ApplicationID AND LN.ListID = LIDs.Value
						INNER JOIN [dbo].[CN_Nodes] AS ND
						ON ND.ApplicationID = @ApplicationID AND ND.NodeID = LN.NodeID
					WHERE LN.Deleted = 0 AND ND.Deleted = 0
				) AS NID
				INNER JOIN [dbo].[CN_NodeMembers] AS NM
				ON NM.ApplicationID = @ApplicationID AND NM.NodeID = NID.Value
				INNER JOIN [dbo].[Users_Normal] AS UN
				ON UN.ApplicationID = @ApplicationID AND UN.UserID = NM.UserID
			WHERE NM.[Status] = N'Accepted' AND NM.Deleted = 0 AND UN.IsApproved = 1
		) AS [UID]
	GROUP BY [UID].UserID
	
	IF @GroupsCount = 0 BEGIN
		IF (SELECT COUNT(*) FROM @UserIDs) = 0 BEGIN
			INSERT INTO @UserIDs (UserID)
			SELECT UserID
			FROM [dbo].[Users_Normal]
			WHERE ApplicationID = @ApplicationID AND IsApproved = 1
		END
		
		DECLARE @DepTypeIDs GuidTableType
		INSERT INTO @DepTypeIDs (Value)
		SELECT Ref.NodeTypeID
		FROM [dbo].[CN_FN_GetDepartmentNodeTypeIDs](@ApplicationID) AS Ref
	
		UPDATE R
			SET GroupID = Ref.GroupID
		FROM @UserIDs AS R
			INNER JOIN (
				SELECT T.UserID,
					CAST(MAX(CAST(ND.NodeID AS varchar(36))) AS uniqueidentifier) AS GroupID
				FROM @UserIDs AS T
					INNER JOIN [dbo].[CN_NodeMembers] AS NM
					INNER JOIN [dbo].[CN_Nodes] AS ND
					ON ND.ApplicationID = @ApplicationID AND 
						ND.NodeTypeID IN (SELECT Value FROM @DepTypeIDs) AND ND.Deleted = 0
					ON NM.ApplicationID = @ApplicationID AND
						NM.NodeID = ND.NodeID AND NM.UserID = T.UserID AND NM.Deleted = 0
				GROUP BY T.UserID
			) AS Ref
			ON R.UserID = Ref.UserID
	END
	
	DECLARE @KnowledgeTypeIDs GuidTableType
	
	INSERT INTO @KnowledgeTypeIDs (Value)
	SELECT Ref.Value
	FROM [dbo].[GFN_StrToGuidTable](@strKnowledgeTypeIDs, @delimiter) AS Ref
	
	DECLARE @UserGroupIDs GuidPairTableType
	
	INSERT INTO @UserGroupIDs (FirstValue, SecondValue)
	SELECT DISTINCT U.UserID, ISNULL(U.GroupID, NEWID())
	FROM @UserIDs AS U
	
	EXEC [dbo].[USR_P_UsersPerformanceReport] @ApplicationID, @UserGroupIDs, @KnowledgeTypeIDs,
		@CompensatePerScore, @CompensationVolume, @ScoreItems, @BeginDate, @FinishDate
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_ProfileFilledPercentageReport]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_ProfileFilledPercentageReport]
GO

CREATE PROCEDURE [dbo].[USR_ProfileFilledPercentageReport]
	@ApplicationID		uniqueidentifier,
	@CurrentUserID		uniqueidentifier
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT	X.FilledPercentage,
			COUNT(X.UserID) AS UsersCount,
			SUM(X.HasJobTitle) AS JobTitlesCount,
			SUM(X.JobsCount) AS JobsCount,
			SUM(X.SchoolsCount) AS SchoolsCount,
			SUM(X.CoursesCount) AS CoursesCount,
			SUM(X.HonorsCount) AS HonorsCount,
			SUM(X.LanguagesCount) AS LanguagesCount
	FROM (
			SELECT	R.UserID,
					(
						CASE WHEN R.HasJobTitle > 0 THEN 1 ELSE 0 END +
						CASE WHEN R.JobsCount > 0 THEN 1 ELSE 0 END +
						CASE WHEN R.SchoolsCount > 0 THEN 1 ELSE 0 END +
						CASE WHEN R.CoursesCount > 0 THEN 1 ELSE 0 END +
						CASE WHEN R.HonorsCount > 0 THEN 1 ELSE 0 END +
						CASE WHEN R.LanguagesCount > 0 THEN 1 ELSE 0 END
					) * 100 / 6 AS FilledPercentage,
					R.HasJobTitle,
					R.JobsCount,
					R.SchoolsCount,
					R.CoursesCount,
					R.HonorsCount,
					R.LanguagesCount
			FROM (
					SELECT	UN.UserID,
							CASE WHEN ISNULL(MAX(UN.JobTitle), N'') = N'' THEN 0 ELSE 1 END AS HasJobTitle,
							COUNT(DISTINCT JE.JobID) AS JobsCount,
							COUNT(DISTINCT
								CASE 
									WHEN EE.EducationID IS NOT NULL AND EE.IsSchool = 1 THEN EE.EducationID 
									ELSE NULL 
								END
							) AS SchoolsCount,
							COUNT(DISTINCT
								CASE 
									WHEN EE.EducationID IS NOT NULL AND EE.IsSchool = 0 THEN EE.EducationID 
									ELSE NULL 
								END
							) AS CoursesCount,
							COUNT(DISTINCT HA.ID) AS HonorsCount,
							COUNT(DISTINCT UL.ID) AS LanguagesCount
					FROM [dbo].[Users_Normal] AS UN
						LEFT JOIN [dbo].[USR_JobExperiences] AS JE
						ON JE.ApplicationID = @ApplicationID AND 
							JE.UserID = UN.UserID AND JE.Deleted = 0
						LEFT JOIN [dbo].[USR_EducationalExperiences] AS EE
						ON EE.ApplicationID = @ApplicationID AND
							EE.UserID = UN.UserID AND EE.Deleted = 0
						LEFT JOIN [dbo].[USR_HonorsAndAwards] AS HA
						ON HA.ApplicationID = @ApplicationID AND
							HA.UserID = UN.UserID AND HA.Deleted = 0
						LEFT JOIN [dbo].[USR_UserLanguages] AS UL
						ON UL.ApplicationID = @ApplicationID AND
							UL.UserID = UN.UserID AND UL.Deleted = 0
					WHERE UN.ApplicationID = @ApplicationID AND UN.IsApproved = 1
					GROUP BY UN.UserID
				) AS R
		) AS X
	GROUP BY X.FilledPercentage
	
	SELECT ('{' +
			'"FilledPercentage": {"Action": "Report", ' +
		   		'"ModuleIdentifier": "USR", "ReportName": "UsersWithSpecificPercentageOfFilledProfileReport",' +
		   		'"Requires": {"FilledPercentage": {"Value": "FilledPercentage"}}, ' + 
		   		'"Params": {}' + 
		   	'}' +
		   '}') AS Actions
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_UsersWithSpecificPercentageOfFilledProfileReport]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_UsersWithSpecificPercentageOfFilledProfileReport]
GO

CREATE PROCEDURE [dbo].[USR_UsersWithSpecificPercentageOfFilledProfileReport]
	@ApplicationID		uniqueidentifier,
	@CurrentUserID		uniqueidentifier,
	@Percentage			int
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT	X.UserID AS UserID_Hide,
			LTRIM(RTRIM(ISNULL(UN.FirstName, N'') + N' ' + ISNULL(UN.LastName, N''))) AS FullName,
			X.FilledPercentage,
			CASE WHEN X.HasJobTitle = 1 THEN N'Yes' ELSE N'No' END AS HasJobTitle_Dic,
			X.JobsCount,
			X.SchoolsCount,
			X.CoursesCount,
			X.HonorsCount,
			X.LanguagesCount
	FROM (
			SELECT	R.UserID,
					(
						CASE WHEN R.HasJobTitle > 0 THEN 1 ELSE 0 END +
						CASE WHEN R.JobsCount > 0 THEN 1 ELSE 0 END +
						CASE WHEN R.SchoolsCount > 0 THEN 1 ELSE 0 END +
						CASE WHEN R.CoursesCount > 0 THEN 1 ELSE 0 END +
						CASE WHEN R.HonorsCount > 0 THEN 1 ELSE 0 END +
						CASE WHEN R.LanguagesCount > 0 THEN 1 ELSE 0 END
					) * 100 / 6 AS FilledPercentage,
					R.HasJobTitle,
					R.JobsCount,
					R.SchoolsCount,
					R.CoursesCount,
					R.HonorsCount,
					R.LanguagesCount
			FROM (
					SELECT	UN.UserID,
							CASE WHEN ISNULL(MAX(UN.JobTitle), N'') = N'' THEN 0 ELSE 1 END AS HasJobTitle,
							COUNT(DISTINCT JE.JobID) AS JobsCount,
							COUNT(DISTINCT
								CASE 
									WHEN EE.EducationID IS NOT NULL AND EE.IsSchool = 1 THEN EE.EducationID 
									ELSE NULL 
								END
							) AS SchoolsCount,
							COUNT(DISTINCT
								CASE 
									WHEN EE.EducationID IS NOT NULL AND EE.IsSchool = 0 THEN EE.EducationID 
									ELSE NULL 
								END
							) AS CoursesCount,
							COUNT(DISTINCT HA.ID) AS HonorsCount,
							COUNT(DISTINCT UL.ID) AS LanguagesCount
					FROM [dbo].[Users_Normal] AS UN
						LEFT JOIN [dbo].[USR_JobExperiences] AS JE
						ON JE.ApplicationID = @ApplicationID AND 
							JE.UserID = UN.UserID AND JE.Deleted = 0
						LEFT JOIN [dbo].[USR_EducationalExperiences] AS EE
						ON EE.ApplicationID = @ApplicationID AND
							EE.UserID = UN.UserID AND EE.Deleted = 0
						LEFT JOIN [dbo].[USR_HonorsAndAwards] AS HA
						ON HA.ApplicationID = @ApplicationID AND
							HA.UserID = UN.UserID AND HA.Deleted = 0
						LEFT JOIN [dbo].[USR_UserLanguages] AS UL
						ON UL.ApplicationID = @ApplicationID AND
							UL.UserID = UN.UserID AND UL.Deleted = 0
					WHERE UN.ApplicationID = @ApplicationID AND UN.IsApproved = 1
					GROUP BY UN.UserID
				) AS R
		) AS X
		INNER JOIN [dbo].[Users_Normal] AS UN
		ON UN.ApplicationID = @ApplicationID AND UN.UserID = X.UserID
	WHERE (@Percentage IS NULL OR X.FilledPercentage = @Percentage)
	ORDER BY X.FilledPercentage DESC
	
	SELECT ('{' +
			'"FullName": {"Action": "Link", "Type": "User",' +
				'"Requires": {"UID": "UserID_Hide"}' +
			'}' +
		   '}') AS Actions
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_ResumeJobExperienceReport]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_ResumeJobExperienceReport]
GO

CREATE PROCEDURE [dbo].[USR_ResumeJobExperienceReport]
	@ApplicationID	uniqueidentifier,
	@CurrentUserID	uniqueidentifier,
	@strUserIDs		varchar(max),
	@strGroupIDs	varchar(max),
	@delimiter		char,
	@Hierarchy		bit,
	@DateFrom		datetime,
	@DateTo			datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @UserIDs GuidTableType

	INSERT INTO @UserIDs (Value)
	SELECT Ref.Value
	FROM [dbo].[GFN_StrToGuidTable](@strUserIDs, @delimiter) AS Ref

	DECLARE @GroupIDs GuidTableType

	INSERT INTO @GroupIDs (Value)
	SELECT Ref.Value
	FROM [dbo].[GFN_StrToGuidTable](@strGroupIDs, @delimiter) AS Ref

	IF ((SELECT COUNT(*) FROM @GroupIDs) > 0) AND ((SELECT COUNT(*) FROM @UserIDs) = 0) BEGIN
		IF ISNULL(@Hierarchy, 0) = 1 BEGIN
			INSERT INTO @UserIDs (Value)
			SELECT DISTINCT NM.UserID
			FROM [dbo].[CN_FN_GetChildNodesDeepHierarchy](@ApplicationID, @GroupIDs) AS H
				INNER JOIN [dbo].[CN_View_NodeMembers] AS NM
				ON NM.ApplicationID = @ApplicationID and NM.NodeID = H.NodeID
		END
		ELSE BEGIN
			INSERT INTO @UserIDs (Value)
			SELECT DISTINCT NM.UserID
			FROM @GroupIDs AS G
				INNER JOIN [dbo].[CN_View_NodeMembers] AS NM
				ON NM.ApplicationID = @ApplicationID and NM.NodeID = G.Value
		END
	END

	DECLARE @UsersCount int = (SELECT COUNT(*) FROM @UserIDs)
	DECLARE @GroupsCount int = (SELECT COUNT(*) FROM @GroupIDs)

	SELECT	E.UserID AS UserID_Hide, 
			LTRIM(RTRIM(ISNULL(UN.FirstName, N'') + N' ' + ISNULL(UN.LastName, N''))) AS FullName,
			UN.UserName,
			E.Title, 
			E.Employer, 
			E.StartDate,
			E.EndDate
	FROM [dbo].[USR_JobExperiences] AS E
		INNER JOIN [dbo].[Users_Normal] AS UN
		ON UN.ApplicationID = @ApplicationID AND UN.UserID = E.UserID
	WHERE E.ApplicationID = @ApplicationID AND E.Deleted = 0 AND
		((@UsersCount = 0 AND @GroupsCount = 0) OR UN.UserID IN (SELECT U.Value FROM @UserIDs AS U)) AND
		(@UsersCount > 0 OR UN.IsApproved = 1) AND
		(@DateFrom IS NULL OR ISNULL(E.StartDate, E.EndDate) >= @DateFrom) AND
		(@DateTo IS NULL OR ISNULL(E.StartDate, E.EndDate) >= @DateTo)
	ORDER BY E.UserID ASC, ISNULL(E.StartDate, E.EndDate) ASC, E.EndDate ASC
	
	SELECT ('{' +
			'"FullName": {"Action": "Link", "Type": "User",' +
				'"Requires": {"UID": "UserID_Hide"}' +
			'}' +
		   '}') AS Actions
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_ResumeEducationReport]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_ResumeEducationReport]
GO

CREATE PROCEDURE [dbo].[USR_ResumeEducationReport]
	@ApplicationID	uniqueidentifier,
	@CurrentUserID	uniqueidentifier,
	@strUserIDs		varchar(max),
	@strGroupIDs	varchar(max),
	@delimiter		char,
	@Hierarchy		bit,
	@DateFrom		datetime,
	@DateTo			datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @UserIDs GuidTableType

	INSERT INTO @UserIDs (Value)
	SELECT Ref.Value
	FROM [dbo].[GFN_StrToGuidTable](@strUserIDs, @delimiter) AS Ref

	DECLARE @GroupIDs GuidTableType

	INSERT INTO @GroupIDs (Value)
	SELECT Ref.Value
	FROM [dbo].[GFN_StrToGuidTable](@strGroupIDs, @delimiter) AS Ref

	IF ((SELECT COUNT(*) FROM @GroupIDs) > 0) AND ((SELECT COUNT(*) FROM @UserIDs) = 0) BEGIN
		IF ISNULL(@Hierarchy, 0) = 1 BEGIN
			INSERT INTO @UserIDs (Value)
			SELECT DISTINCT NM.UserID
			FROM [dbo].[CN_FN_GetChildNodesDeepHierarchy](@ApplicationID, @GroupIDs) AS H
				INNER JOIN [dbo].[CN_View_NodeMembers] AS NM
				ON NM.ApplicationID = @ApplicationID and NM.NodeID = H.NodeID
		END
		ELSE BEGIN
			INSERT INTO @UserIDs (Value)
			SELECT DISTINCT NM.UserID
			FROM @GroupIDs AS G
				INNER JOIN [dbo].[CN_View_NodeMembers] AS NM
				ON NM.ApplicationID = @ApplicationID and NM.NodeID = G.Value
		END
	END

	DECLARE @UsersCount int = (SELECT COUNT(*) FROM @UserIDs)
	DECLARE @GroupsCount int = (SELECT COUNT(*) FROM @GroupIDs)

	SELECT	E.UserID AS UserID_Hide, 
			LTRIM(RTRIM(ISNULL(UN.FirstName, N'') + N' ' + ISNULL(UN.LastName, N''))) AS FullName,
			UN.UserName,
			E.School, 
			E.StudyField, 
			(CASE WHEN E.[Level] = N'None' THEN N'' ELSE E.[Level] END) AS Level_Dic,
			E.StartDate,
			E.EndDate
	FROM [dbo].[USR_EducationalExperiences] AS E
		INNER JOIN [dbo].[Users_Normal] AS UN
		ON UN.ApplicationID = @ApplicationID AND UN.UserID = E.UserID
	WHERE E.ApplicationID = @ApplicationID AND E.Deleted = 0 AND E.IsSchool = 1 AND
		((@UsersCount = 0 AND @GroupsCount = 0) OR UN.UserID IN (SELECT U.Value FROM @UserIDs AS U)) AND
		(@UsersCount > 0 OR UN.IsApproved = 1) AND
		(@DateFrom IS NULL OR ISNULL(E.StartDate, E.EndDate) >= @DateFrom) AND
		(@DateTo IS NULL OR ISNULL(E.StartDate, E.EndDate) >= @DateTo)
	ORDER BY E.UserID ASC, ISNULL(E.StartDate, E.EndDate) ASC, E.EndDate ASC
	
	SELECT ('{' +
			'"FullName": {"Action": "Link", "Type": "User",' +
				'"Requires": {"UID": "UserID_Hide"}' +
			'}' +
		   '}') AS Actions
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_ResumeCoursesReport]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_ResumeCoursesReport]
GO

CREATE PROCEDURE [dbo].[USR_ResumeCoursesReport]
	@ApplicationID	uniqueidentifier,
	@CurrentUserID	uniqueidentifier,
	@strUserIDs		varchar(max),
	@strGroupIDs	varchar(max),
	@delimiter		char,
	@Hierarchy		bit,
	@DateFrom		datetime,
	@DateTo			datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @UserIDs GuidTableType

	INSERT INTO @UserIDs (Value)
	SELECT Ref.Value
	FROM [dbo].[GFN_StrToGuidTable](@strUserIDs, @delimiter) AS Ref

	DECLARE @GroupIDs GuidTableType

	INSERT INTO @GroupIDs (Value)
	SELECT Ref.Value
	FROM [dbo].[GFN_StrToGuidTable](@strGroupIDs, @delimiter) AS Ref

	IF ((SELECT COUNT(*) FROM @GroupIDs) > 0) AND ((SELECT COUNT(*) FROM @UserIDs) = 0) BEGIN
		IF ISNULL(@Hierarchy, 0) = 1 BEGIN
			INSERT INTO @UserIDs (Value)
			SELECT DISTINCT NM.UserID
			FROM [dbo].[CN_FN_GetChildNodesDeepHierarchy](@ApplicationID, @GroupIDs) AS H
				INNER JOIN [dbo].[CN_View_NodeMembers] AS NM
				ON NM.ApplicationID = @ApplicationID and NM.NodeID = H.NodeID
		END
		ELSE BEGIN
			INSERT INTO @UserIDs (Value)
			SELECT DISTINCT NM.UserID
			FROM @GroupIDs AS G
				INNER JOIN [dbo].[CN_View_NodeMembers] AS NM
				ON NM.ApplicationID = @ApplicationID and NM.NodeID = G.Value
		END
	END

	DECLARE @UsersCount int = (SELECT COUNT(*) FROM @UserIDs)
	DECLARE @GroupsCount int = (SELECT COUNT(*) FROM @GroupIDs)

	SELECT	E.UserID AS UserID_Hide, 
			LTRIM(RTRIM(ISNULL(UN.FirstName, N'') + N' ' + ISNULL(UN.LastName, N''))) AS FullName,
			UN.UserName,
			E.School, 
			E.StudyField, 
			E.StartDate,
			E.EndDate
	FROM [dbo].[USR_EducationalExperiences] AS E
		INNER JOIN [dbo].[Users_Normal] AS UN
		ON UN.ApplicationID = @ApplicationID AND UN.UserID = E.UserID
	WHERE E.ApplicationID = @ApplicationID AND E.Deleted = 0 AND ISNULL(E.IsSchool, 0) = 0 AND
		((@UsersCount = 0 AND @GroupsCount = 0) OR UN.UserID IN (SELECT U.Value FROM @UserIDs AS U)) AND
		(@UsersCount > 0 OR UN.IsApproved = 1) AND
		(@DateFrom IS NULL OR ISNULL(E.StartDate, E.EndDate) >= @DateFrom) AND
		(@DateTo IS NULL OR ISNULL(E.StartDate, E.EndDate) >= @DateTo)
	ORDER BY E.UserID ASC, ISNULL(E.StartDate, E.EndDate) ASC, E.EndDate ASC
	
	SELECT ('{' +
			'"FullName": {"Action": "Link", "Type": "User",' +
				'"Requires": {"UID": "UserID_Hide"}' +
			'}' +
		   '}') AS Actions
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_ResumeHonorsReport]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_ResumeHonorsReport]
GO

CREATE PROCEDURE [dbo].[USR_ResumeHonorsReport]
	@ApplicationID	uniqueidentifier,
	@CurrentUserID	uniqueidentifier,
	@strUserIDs		varchar(max),
	@strGroupIDs	varchar(max),
	@delimiter		char,
	@Hierarchy		bit,
	@DateFrom		datetime,
	@DateTo			datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @UserIDs GuidTableType

	INSERT INTO @UserIDs (Value)
	SELECT Ref.Value
	FROM [dbo].[GFN_StrToGuidTable](@strUserIDs, @delimiter) AS Ref

	DECLARE @GroupIDs GuidTableType

	INSERT INTO @GroupIDs (Value)
	SELECT Ref.Value
	FROM [dbo].[GFN_StrToGuidTable](@strGroupIDs, @delimiter) AS Ref

	IF ((SELECT COUNT(*) FROM @GroupIDs) > 0) AND ((SELECT COUNT(*) FROM @UserIDs) = 0) BEGIN
		IF ISNULL(@Hierarchy, 0) = 1 BEGIN
			INSERT INTO @UserIDs (Value)
			SELECT DISTINCT NM.UserID
			FROM [dbo].[CN_FN_GetChildNodesDeepHierarchy](@ApplicationID, @GroupIDs) AS H
				INNER JOIN [dbo].[CN_View_NodeMembers] AS NM
				ON NM.ApplicationID = @ApplicationID and NM.NodeID = H.NodeID
		END
		ELSE BEGIN
			INSERT INTO @UserIDs (Value)
			SELECT DISTINCT NM.UserID
			FROM @GroupIDs AS G
				INNER JOIN [dbo].[CN_View_NodeMembers] AS NM
				ON NM.ApplicationID = @ApplicationID and NM.NodeID = G.Value
		END
	END

	DECLARE @UsersCount int = (SELECT COUNT(*) FROM @UserIDs)
	DECLARE @GroupsCount int = (SELECT COUNT(*) FROM @GroupIDs)

	SELECT	E.UserID AS UserID_Hide, 
			LTRIM(RTRIM(ISNULL(UN.FirstName, N'') + N' ' + ISNULL(UN.LastName, N''))) AS FullName,
			UN.UserName,
			E.Title, 
			E.Occupation, 
			E.Issuer, 
			E.[Description],
			E.IssueDate
	FROM [dbo].[USR_HonorsAndAwards] AS E
		INNER JOIN [dbo].[Users_Normal] AS UN
		ON UN.ApplicationID = @ApplicationID AND UN.UserID = E.UserID
	WHERE E.ApplicationID = @ApplicationID AND E.Deleted = 0 AND
		((@UsersCount = 0 AND @GroupsCount = 0) OR UN.UserID IN (SELECT U.Value FROM @UserIDs AS U)) AND
		(@UsersCount > 0 OR UN.IsApproved = 1) AND
		(@DateFrom IS NULL OR E.IssueDate >= @DateFrom) AND
		(@DateTo IS NULL OR E.IssueDate >= @DateTo)
	ORDER BY E.UserID ASC, E.IssueDate ASC
	
	SELECT ('{' +
			'"FullName": {"Action": "Link", "Type": "User",' +
				'"Requires": {"UID": "UserID_Hide"}' +
			'}' +
		   '}') AS Actions
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_ResumeLanguagesReport]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_ResumeLanguagesReport]
GO

CREATE PROCEDURE [dbo].[USR_ResumeLanguagesReport]
	@ApplicationID	uniqueidentifier,
	@CurrentUserID	uniqueidentifier,
	@strUserIDs		varchar(max),
	@strGroupIDs	varchar(max),
	@delimiter		char,
	@Hierarchy		bit
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @UserIDs GuidTableType

	INSERT INTO @UserIDs (Value)
	SELECT Ref.Value
	FROM [dbo].[GFN_StrToGuidTable](@strUserIDs, @delimiter) AS Ref

	DECLARE @GroupIDs GuidTableType

	INSERT INTO @GroupIDs (Value)
	SELECT Ref.Value
	FROM [dbo].[GFN_StrToGuidTable](@strGroupIDs, @delimiter) AS Ref

	IF ((SELECT COUNT(*) FROM @GroupIDs) > 0) AND ((SELECT COUNT(*) FROM @UserIDs) = 0) BEGIN
		IF ISNULL(@Hierarchy, 0) = 1 BEGIN
			INSERT INTO @UserIDs (Value)
			SELECT DISTINCT NM.UserID
			FROM [dbo].[CN_FN_GetChildNodesDeepHierarchy](@ApplicationID, @GroupIDs) AS H
				INNER JOIN [dbo].[CN_View_NodeMembers] AS NM
				ON NM.ApplicationID = @ApplicationID and NM.NodeID = H.NodeID
		END
		ELSE BEGIN
			INSERT INTO @UserIDs (Value)
			SELECT DISTINCT NM.UserID
			FROM @GroupIDs AS G
				INNER JOIN [dbo].[CN_View_NodeMembers] AS NM
				ON NM.ApplicationID = @ApplicationID and NM.NodeID = G.Value
		END
	END

	DECLARE @UsersCount int = (SELECT COUNT(*) FROM @UserIDs)
	DECLARE @GroupsCount int = (SELECT COUNT(*) FROM @GroupIDs)

	SELECT	E.UserID AS UserID_Hide, 
			LTRIM(RTRIM(ISNULL(UN.FirstName, N'') + N' ' + ISNULL(UN.LastName, N''))) AS FullName,
			UN.UserName,
			L.LanguageName, 
			E.[Level] AS Level_Dic
	FROM [dbo].[USR_UserLanguages] AS E
		INNER JOIN [dbo].[USR_LanguageNames] AS L
		ON L.ApplicationID = @ApplicationID AND L.LanguageID = L.LanguageID
		INNER JOIN [dbo].[Users_Normal] AS UN
		ON UN.ApplicationID = @ApplicationID AND UN.UserID = E.UserID
	WHERE E.ApplicationID = @ApplicationID AND E.Deleted = 0 AND
		((@UsersCount = 0 AND @GroupsCount = 0) OR UN.UserID IN (SELECT U.Value FROM @UserIDs AS U)) AND
		(@UsersCount > 0 OR UN.IsApproved = 1)
	ORDER BY E.UserID ASC, L.LanguageName ASC
	
	SELECT ('{' +
			'"FullName": {"Action": "Link", "Type": "User",' +
				'"Requires": {"UID": "UserID_Hide"}' +
			'}' +
		   '}') AS Actions
END

GO

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WF_StateNodesCountReport]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WF_StateNodesCountReport]
GO

CREATE PROCEDURE [dbo].[WF_StateNodesCountReport]
	@ApplicationID			uniqueidentifier,
	@CurrentUserID			uniqueidentifier,
	@NodeTypeID				uniqueidentifier,
	@WorkFlowID				uniqueidentifier,
	@LowerCreationDateLimit	datetime,
	@UpperCreationDateLimit	datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT WFS.StateID AS StateID_Hide, ST.Title AS StateTitle, 
		WFS.WorkFlowID AS WorkFlowID_Hide, WF.Name AS WorkFlowTitle, 
		NT.NodeTypeID AS NodeTypeID_Hide, NT.Name AS NodeType,
		ISNULL(Ref.[Count], 0) AS [Count], CAST(ST.Deleted AS int) AS RemovedState
	FROM (
			SELECT A.StateID, 
				CAST(MAX(CAST(ND.NodeTypeID AS varchar(36))) AS uniqueidentifier) AS NodeTypeID,
				CAST(MAX(CAST(A.WorkFlowID AS varchar(36))) AS uniqueidentifier) AS WorkFlowID,
				COUNT(ND.NodeID) AS [Count]
			FROM [dbo].[WF_History] AS A
				INNER JOIN (
					SELECT OwnerID, MAX(SendDate) AS SendDate
					FROM [dbo].[WF_History]
					WHERE ApplicationID = @ApplicationID AND Deleted = 0
					GROUP BY OwnerID
				) AS B
				ON B.OwnerID = A.OwnerID AND B.SendDate = A.SendDate
				INNER JOIN [dbo].[CN_Nodes] AS ND
				ON ND.ApplicationID = @ApplicationID AND ND.NodeID = A.OwnerID
			WHERE A.ApplicationID = @ApplicationID AND 
				(@WorkFlowID IS NULL OR A.WorkFlowID = @WorkFlowID) AND
				(@NodeTypeID IS NULL OR ND.NodeTypeID = @NodeTypeID) AND
				(@LowerCreationDateLimit IS NULL OR ND.CreationDate >= @LowerCreationDateLimit) AND
				(@UpperCreationDateLimit IS NULL OR ND.CreationDate <= @UpperCreationDateLimit) AND
				 ND.Deleted = 0
			GROUP BY A.StateID
		) AS Ref
		RIGHT JOIN [dbo].[WF_WorkFlowStates] AS WFS
		ON WFS.ApplicationID = @ApplicationID AND 
			Ref.WorkFlowID = WFS.WorkFlowID AND WFS.StateID = Ref.StateID
		INNER JOIN [dbo].[WF_States] AS ST
		ON ST.ApplicationID = @ApplicationID AND ST.StateID = WFS.StateID
		INNER JOIN [dbo].[WF_WorkFlows] AS WF
		ON WF.ApplicationID = @ApplicationID AND WF.WorkFlowID = Ref.WorkFlowID
		INNER JOIN [dbo].[CN_NodeTypes] AS NT
		ON NT.ApplicationID = @ApplicationID AND NT.NodeTypeID = Ref.NodeTypeID
	WHERE WFS.ApplicationID = @ApplicationID AND (Ref.StateID IS NOT NULL OR WFS.Deleted = 0)
	
	
	SELECT ('{' +
			'"Count": {"Action": "Report",' + 
		   		'"ModuleIdentifier": "WF", "ReportName": "NodesWorkFlowStatesReport",' +
		   		'"Requires": {"StateID": {"Value": "StateID_Hide", "Title": "StateTitle"}}, ' + 
		   		'"Params": {"CurrentState": true }' + 
		   	'}' +
		   '}') AS Actions
END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[WF_NodesWorkFlowStatesReport]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[WF_NodesWorkFlowStatesReport]
GO

CREATE PROCEDURE [dbo].[WF_NodesWorkFlowStatesReport]
	@ApplicationID			uniqueidentifier,
	@CurrentUserID			uniqueidentifier,
	@NodeTypeID				uniqueidentifier,
	@WorkFlowID				uniqueidentifier,
	@StateID				uniqueidentifier,
	@TagID					uniqueidentifier,
	@CurrentState			bit,
	@LowerCreationDateLimit datetime,
	@UpperCreationDateLimit datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @Results Table (
		NodeID_Hide uniqueidentifier primary key clustered, 
		Name nvarchar(1000), 
		AdditionalID varchar(1000), 
		Classification nvarchar(250),
		UserID_Hide uniqueidentifier, 
		[User] nvarchar(1000), 
		UserName nvarchar(1000), 
		RefStateID_Hide uniqueidentifier, 
		RefStateTitle nvarchar(1000), 
		TagID_Hide uniqueidentifier, 
		Tag nvarchar(1000), 
		RefDirectorNodeID_Hide uniqueidentifier, 
		RefDirectorNode nvarchar(1000), 
		RefDirectorUserID_Hide uniqueidentifier, 
		RefDirectorName nvarchar(1000), 
		RefDirectorUserName nvarchar(1000), 
		EntranceDate datetime, 
		RefSenderUserID_Hide uniqueidentifier, 
		RefSenderName nvarchar(1000),
		RefSenderUserName nvarchar(1000),
		StateID_Hide uniqueidentifier, 
		StateTitle nvarchar(1000), 
		DirectorNodeID_Hide uniqueidentifier, 
		DirectorNodeName nvarchar(1000),
		DirectorUserID_Hide uniqueidentifier, 
		DirectorName nvarchar(1000),
		DirectorUserName nvarchar(1000),
		SendDate datetime, 
		SenderUserID_Hide uniqueidentifier, 
		SenderName nvarchar(1000),
		SenderUserName nvarchar(1000)
	)
	
	INSERT INTO @Results
	SELECT	RPT.NodeID AS NodeID_Hide, 
			ND.Name, 
			ND.AdditionalID, 
			Conf.[Level] AS Classification,
			UN.UserID AS UserID_Hide, 
			(UN.FirstName + N' ' + UN.LastName) AS [User], 
			UN.UserName, 
			RPT.RefStateID AS RefStateID_Hide, 
			RS.Title AS RefStateTitle, 
			RPT.TagID AS TagID_Hide, 
			TG.Tag, 
			RPT.RefDirectorNodeID AS RefDirectorNodeID_Hide, 
			RDN.Name AS RefDirectorNode, 
			RPT.RefDirectorUserID AS RefDirectorUserID_Hide, 
			(RDU.FirstName + N' ' + RDU.LastName) AS RefDirectorName, 
			RDU.UserName AS RefDirectorUserName, 
			RPT.EntranceDate, 
			RPT.RefSenderUserID AS RefSenderUserID_Hide, 
			(RSU.FirstName + N' ' + RSU.LastName) AS RefSenderName,
			RSU.UserName AS RefSenderUserName,
			RPT.StateID AS StateID_Hide, 
			ST.Title AS StateTitle, 
			RPT.DirectorNodeID AS DirectorNodeID_Hide, 
			DN.Name AS DirectorNodeName,
			RPT.DirectorUserID AS DirectorUserID_Hide, 
			(DU.FirstName + N' ' + DU.LastName) AS DirectorName,
			DU.UserName AS DirectorUserName,
			RPT.SendDate, 
			RPT.SenderUserID AS SenderUserID_Hide, 
			(SU.FirstName + N' ' + SU.LastName) AS SenderName,
			SU.UserName AS SenderUserName
	FROM (
			SELECT Ref.NodeID AS NodeID, 
				CAST(MAX(CAST(Ref.StateID AS varchar(36))) AS uniqueidentifier) AS RefStateID,
				CAST(MAX(CAST(Ref.TagID AS varchar(36))) AS uniqueidentifier) AS TagID,
				CAST(MAX(CAST(Ref.DirectorNodeID AS varchar(36))) AS uniqueidentifier) AS RefDirectorNodeID,
				CAST(MAX(CAST(Ref.DirectorUserID AS varchar(36))) AS uniqueidentifier) AS RefDirectorUserID,
				MAX(Ref.SendDate) AS EntranceDate, 
				CAST(MAX(CAST(Ref.SenderUserID AS varchar(36))) AS uniqueidentifier) AS RefSenderUserID,
				CAST(MAX(CAST(H.StateID AS varchar(36))) AS uniqueidentifier) AS StateID,
				CAST(MAX(CAST(H.DirectorNodeID AS varchar(36))) AS uniqueidentifier) AS DirectorNodeID,
				CAST(MAX(CAST(H.DirectorUserID AS varchar(36))) AS uniqueidentifier) AS DirectorUserID,
				MAX(H.SendDate) AS SendDate,
				CAST(MAX(CAST(H.SenderUserID AS varchar(36))) AS uniqueidentifier) AS SenderUserID
			FROM (
					SELECT A.OwnerID AS NodeID, A.WorkFlowID, A.StateID AS StateID, B.TagID AS TagID, 
						A.DirectorNodeID, A.DirectorUserID, B.SendDate, A.SenderUserID
					FROM [dbo].[WF_History] AS A
						INNER JOIN (
							SELECT H.OwnerID, MAX(H.SendDate) AS SendDate, 
								CAST(MAX(CAST(WFS.TagID AS varchar(36))) AS uniqueidentifier) AS TagID
							FROM [dbo].[WF_History] AS H
								INNER JOIN [dbo].[WF_WorkFlowStates] AS WFS
								ON WFS.ApplicationID = @ApplicationID AND 
									H.WorkFlowID = WFS.WorkFlowID AND WFS.StateID = H.StateID
							WHERE H.ApplicationID = @ApplicationID AND 
								(@WorkFlowID IS NULL OR H.WorkFlowID = @WorkFlowID) AND
								(@StateID IS NULL OR H.StateID = @StateID) AND
								(@TagID IS NULL OR WFS.TagID = @TagID) AND H.Deleted = 0
							GROUP BY H.OwnerID
						) AS B
						ON B.OwnerID = A.OwnerID AND A.SendDate = B.SendDate
					WHERE A.ApplicationID = @ApplicationID
				) AS Ref
				LEFT JOIN [dbo].[WF_History] AS H
				ON H.ApplicationID = @ApplicationID AND H.OwnerID = Ref.NodeID AND 
					H.WorkFlowID = Ref.WorkFlowID AND H.SendDate > Ref.SendDate
			WHERE (@CurrentState IS NULL OR (@CurrentState = 1 AND H.SendDate IS NULL) OR 
				@CurrentState = 0 AND H.SendDate IS NOT NULL)
			GROUP BY Ref.NodeID
		) AS RPT
		INNER JOIN [dbo].[CN_Nodes] AS ND
		ON ND.ApplicationID = @ApplicationID AND ND.NodeID = RPT.NodeID
		LEFT JOIN [dbo].[Users_Normal] AS UN
		ON UN.ApplicationID = @ApplicationID AND UN.UserID = ND.CreatorUserID
		LEFT JOIN [dbo].[WF_States] AS RS
		ON RS.ApplicationID = @ApplicationID AND RS.StateID = RPT.RefStateID
		LEFT JOIN [dbo].[CN_Tags] AS TG
		ON TG.ApplicationID = @ApplicationID AND TG.TagID = RPT.TagID
		LEFT JOIN [dbo].[CN_Nodes] AS RDN
		ON RDN.ApplicationID = @ApplicationID AND RDN.NodeID = RPT.RefDirectorNodeID
		LEFT JOIN [dbo].[Users_Normal] AS RDU
		ON RDU.ApplicationID = @ApplicationID AND RDU.UserID = RPT.RefDirectorUserID
		LEFT JOIN [dbo].[Users_Normal] AS RSU
		ON RSU.ApplicationID = @ApplicationID AND RSU.UserID = RPT.RefSenderUserID
		LEFT JOIN [dbo].[WF_States] AS ST
		ON ST.ApplicationID = @ApplicationID AND ST.StateID = RPT.StateID
		LEFT JOIN [dbo].[CN_Nodes] AS DN
		ON DN.ApplicationID = @ApplicationID AND DN.NodeID = RPT.DirectorNodeID
		LEFT JOIN [dbo].[Users_Normal] AS DU
		ON DU.ApplicationID = @ApplicationID AND DU.UserID = RPT.DirectorUserID
		LEFT JOIN [dbo].[Users_Normal] AS SU
		ON SU.ApplicationID = @ApplicationID AND SU.UserID = RPT.SenderUserID
		LEFT JOIN [dbo].[PRVC_View_Confidentialities] AS Conf
		ON Conf.ApplicationID = @ApplicationID AND Conf.ObjectID = ND.NodeID
	WHERE (@NodeTypeID IS NULL OR ND.NodeTypeID = @NodeTypeID) AND
		(@LowerCreationDateLimit IS NULL OR ND.CreationDate >= @LowerCreationDateLimit) AND
		(@UpperCreationDateLimit IS NULL OR ND.CreationDate <= @UpperCreationDateLimit) AND
		ND.Deleted = 0
		
	SELECT *
	FROM @Results
		
	SELECT ('{' +
			'"Name": {"Action": "Link", "Type": "Node",' +
				'"Requires": {"ID": "NodeID_Hide"}' +
			'},' +
			'"User": {"Action": "Link", "Type": "User",' +
				'"Requires": {"UID": "UserID_Hide"}' +
			'},' +
			'"RefDirectorNode": {"Action": "Link", "Type": "Node",' +
				'"Requires": {"ID": "RefDirectorNodeID_Hide"}' +
			'},' +
			'"RefDirectorName": {"Action": "Link", "Type": "User",' +
				'"Requires": {"UID": "RefDirectorUserID_Hide"}' +
			'},' +
			'"RefSenderName": {"Action": "Link", "Type": "User",' +
				'"Requires": {"UID": "RefSenderUserID_Hide"}' +
			'},' +
			'"DirectorNodeName": {"Action": "Link", "Type": "Node",' +
				'"Requires": {"ID": "DirectorNodeID_Hide"}' +
			'},' +
			'"DirectorName": {"Action": "Link", "Type": "User",' +
				'"Requires": {"UID": "DirectorUserID_Hide"}' +
			'},' +
			'"SenderName": {"Action": "Link", "Type": "User",' +
				'"Requires": {"UID": "SenderUserID_Hide"}' +
			'}' +
		   '}') AS Actions
		   
	IF @NodeTypeID IS NOT NULL BEGIN
		DECLARE @FormID uniqueidentifier = (
			SELECT TOP(1) FormID
			FROM [dbo].[FG_FormOwners]
			WHERE ApplicationID = @ApplicationID AND OwnerID = @NodeTypeID AND Deleted = 0
		)
		
		IF @FormID IS NOT NULL AND EXISTS(
			SELECT TOP(1) *
			FROM [dbo].[CN_Extensions] AS Ex
			WHERE Ex.ApplicationID = @ApplicationID AND 
				Ex.OwnerID = @NodeTypeID AND Ex.Extension = N'Form' AND Ex.Deleted = 0
		) BEGIN
			-- Second Part: Describes the Third Part
			SELECT CAST(EFE.ElementID AS varchar(50)) AS ColumnName, EFE.Title AS Translation,
				CASE
					WHEN EFE.[Type] = N'Binary' THEN N'bool'
					WHEN EFE.[Type] = N'Number' THEN N'double'
					WHEN EFE.[Type] = N'Date' THEN N'datetime'
					WHEN EFE.[Type] = N'User' THEN N'user'
					WHEN EFE.[Type] = N'Node' THEN N'node'
					ELSE N'string'
				END AS [Type]
			FROM [dbo].[FG_ExtendedFormElements] AS EFE
			WHERE EFE.ApplicationID = @ApplicationID AND 
				EFE.FormID = @FormID AND EFE.Deleted = 0
			ORDER BY EFE.SequenceNumber ASC
			
			SELECT ('{"IsDescription": "true"}') AS Info
			-- end of Second Part
			
			-- Third Part: The Form Info
			DECLARE @NodeIDs GuidTableType
			
			INSERT INTO @NodeIDs (Value)
			SELECT R.NodeID_Hide
			FROM @Results AS R
			
			DECLARE @ElementIDs GuidTableType
			
			DECLARE @FakeInstances GuidTableType
			DECLARE @FakeFilters FormFilterTableType
			
			EXEC [dbo].[FG_P_GetFormRecords] @ApplicationID, @FormID, 
				@ElementIDs, @FakeInstances, @NodeIDs, 
				@FakeFilters, NULL, 1000000, NULL, NULL
			
			SELECT ('{' +
				'"ColumnsMap": "NodeID_Hide:OwnerID",' +
				'"ColumnsToTransfer": "' + STUFF((
					SELECT ',' + CAST(EFE.ElementID AS varchar(50))
					FROM [dbo].[FG_ExtendedFormElements] AS EFE
					WHERE EFE.ApplicationID = @ApplicationID AND 
						EFE.FormID = @FormID AND EFE.Deleted = 0
					ORDER BY EFE.SequenceNumber ASC
					FOR xml path('a'), type
				).value('.','nvarchar(max)'), 1, 1, '') + '"' +
			   '}') AS Info
			-- End of Third Part
		END
	END
END

GO


SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[KW_KnowledgeAdminsReport]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[KW_KnowledgeAdminsReport]
GO

CREATE PROCEDURE [dbo].[KW_KnowledgeAdminsReport]
	@ApplicationID			uniqueidentifier,
	@CurrentUserID			uniqueidentifier,
	@Now					datetime,
    @KnowledgeTypeID		uniqueidentifier,
	@strUserIDs				varchar(max),
	@delimiter				char,
	@MemberInNodeTypeID		uniqueidentifier,
	@SendDateFrom			datetime,
	@SendDateTo				datetime,
	@ActionDateFrom			datetime,
	@ActionDateTo			datetime,
	@DelayFrom				int,
	@DelayTo				int,
	@Seen					bit,
	@Done					bit
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @UserIDs GuidTableType
	
	INSERT INTO @UserIDs
	SELECT Ref.Value
	FROM [dbo].[GFN_StrToGuidTable](@strUserIDs, @delimiter) AS Ref
	
	IF @DelayFrom IS NOT NULL AND @DelayFrom < 0 SET @DelayFrom = NULL
	ELSE SET @DelayFrom = @DelayFrom * 24 * 60 * 60

	IF @DelayTo IS NOT NULL AND @DelayTo < 0 SET @DelayTo = NULL
	ELSE SET @DelayTo = @DelayTo * 24 * 60 * 60

	DECLARE @HasTargetUsers bit = 0
	IF (SELECT COUNT(*) FROM @UserIDs) > 0 OR @MemberInNodeTypeID IS NOT NULL 
		SET @HasTargetUsers = 1

	DECLARE @TargetUserIDs GuidTableType

	INSERT INTO @TargetUserIDs (Value)
	SELECT DISTINCT X.UserID
	FROM (
			SELECT Value AS UserID
			FROM @UserIDs
			
			UNION ALL
			
			SELECT NM.UserID
			FROM [dbo].[CN_View_NodeMembers] AS NM
			WHERE @MemberInNodeTypeID IS NOT NULL AND NM.ApplicationID = @ApplicationID AND
				NM.NodeTypeID = @MemberInNodeTypeID AND NM.IsPending = 0
		) AS X
		

	SELECT	D.UserID AS UserID_Hide,
			MAX(UN.FirstName + N' ' + UN.LastName) AS FullName,
			COUNT(D.ID) AS ItemsCount,
			SUM(CASE WHEN D.Deleted = 0 AND D.ActionDate IS NULL THEN 1 ELSE 0 END) AS PendingCount,
			SUM(CASE WHEN D.ActionDate IS NULL THEN 0 ELSE 1 END) AS DoneCount,
			SUM(CASE WHEN D.Seen = 0 THEN 1 ELSE 0 END) AS NotSeenCount, 
			AVG(
				CASE
					WHEN D.ActionDate IS NULL THEN NULL
					ELSE ISNULL(CAST(DATEDIFF(second, D.SendDate, D.ActionDate) as float) / (24 * 3600), 0)
				END
			) AS DoneDelayAverage, 
			MIN(
				CASE
					WHEN D.ActionDate IS NULL THEN 0
					ELSE ISNULL(CAST(DATEDIFF(second, D.SendDate, D.ActionDate) as float) / (24 * 3600), 0)
				END
			) AS DoneDelayMin, 
			MAX(
				CASE
					WHEN D.ActionDate IS NULL THEN 0
					ELSE ISNULL(CAST(DATEDIFF(second, D.SendDate, D.ActionDate) as float) / (24 * 3600), 0)
				END
			) AS DoneDelayMax,
			AVG(
				CASE
					WHEN D.ActionDate IS NOT NULL OR D.Deleted = 1 THEN NULL
					ELSE ISNULL(CAST(DATEDIFF(second, D.SendDate, @Now) as float) / (24 * 3600), 0)
				END
			) AS NotDoneDelayAverage, 
			MIN(
				CASE
					WHEN D.ActionDate IS NOT NULL OR D.Deleted = 1 THEN 0
					ELSE ISNULL(CAST(DATEDIFF(second, D.SendDate, @Now) as float) / (24 * 3600), 0)
				END
			) AS NotDoneDelayMin, 
			MAX(
				CASE
					WHEN D.ActionDate IS NOT NULL OR D.Deleted = 1 THEN 0
					ELSE ISNULL(CAST(DATEDIFF(second, D.SendDate, @Now) as float) / (24 * 3600), 0)
				END
			) AS NotDoneDelayMax
	FROM @TargetUserIDs AS T
		RIGHT JOIN [dbo].[NTFN_Dashboards] AS D
		ON D.ApplicationID = @ApplicationID AND D.UserID = T.Value
		INNER JOIN [dbo].[CN_Nodes] AS ND
		ON ND.ApplicationID = @ApplicationID AND ND.NodeID = D.NodeID AND
			(@KnowledgeTypeID IS NULL OR ND.NodeTypeID = @KnowledgeTypeID)
		INNER JOIN [dbo].[Users_Normal] AS UN
		ON UN.ApplicationID = @ApplicationID AND UN.UserID = D.UserID
	WHERE D.ApplicationID = @ApplicationID AND (@HasTargetUsers = 0 OR T.Value IS NOT NULL) AND
		D.[Type] = N'Knowledge' AND D.SubType = N'Admin' AND
		(@SendDateFrom IS NULL OR D.SendDate >= @SendDateFrom) AND
		(@SendDateTo IS NULL OR D.SendDate <= @SendDateTo) AND
		(@ActionDateFrom IS NULL OR D.ActionDate >= @ActionDateFrom) AND
		(@ActionDateTo IS NULL OR D.ActionDate <= @ActionDateTo) AND
		(@DelayFrom IS NULL OR 
			DATEDIFF(second, D.SendDate, ISNULL(D.ActionDate, @Now)) >= @DelayFrom) AND
		(@DelayTo IS NULL OR 
			DATEDIFF(second, D.SendDate, ISNULL(D.ActionDate, @Now)) <= @DelayTo) AND
		(@Done IS NULL OR ((@Done = 1 OR D.Deleted = 0) AND D.Done = @Done)) AND
		(@Seen IS NULL OR D.Seen = @Seen)
	GROUP BY D.UserID

	
	SELECT ('{' +
			'"FullName": {"Action": "Link", "Type": "User",' +
				'"Requires": {"ID": "UserID_Hide"}' +
			'},' +
			'"PendingCount": {"Action": "Report", ' +
		   		'"ModuleIdentifier": "KW", "ReportName": "KnowledgeAdminsDetailReport",' +
		   		'"Requires":{"UserID":{"Value": "UserID_Hide", "Title": "FullName"}},' +
		   		'"Params": {"Done": "false"}' + 
		   	'},' +
		   	'"DoneCount": {"Action": "Report", ' +
		   		'"ModuleIdentifier": "KW", "ReportName": "KnowledgeAdminsDetailReport",' +
		   		'"Requires":{"UserID":{"Value": "UserID_Hide", "Title": "FullName"}},' +
		   		'"Params": {"Done": "true"}' + 
		   	'},' +
		   	'"NotSeenCount": {"Action": "Report", ' +
		   		'"ModuleIdentifier": "KW", "ReportName": "KnowledgeAdminsDetailReport",' +
		   		'"Requires":{"UserID":{"Value": "UserID_Hide", "Title": "FullName"}},' +
		   		'"Params": {"Seen": "false"}' + 
		   	'}' +
		   '}') AS Actions

END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[KW_KnowledgeAdminsDetailReport]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[KW_KnowledgeAdminsDetailReport]
GO

CREATE PROCEDURE [dbo].[KW_KnowledgeAdminsDetailReport]
	@ApplicationID			uniqueidentifier,
	@CurrentUserID			uniqueidentifier,
	@Now					datetime,
	@KnowledgeID			uniqueidentifier,
    @KnowledgeTypeID		uniqueidentifier,
	@strUserIDs				varchar(max),
	@delimiter				char,
	@MemberInNodeTypeID		uniqueidentifier,
	@SendDateFrom			datetime,
	@SendDateTo				datetime,
	@ActionDateFrom			datetime,
	@ActionDateTo			datetime,
	@DelayFrom				int,
	@DelayTo				int,
	@Seen					bit,
	@Done					bit
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @UserIDs GuidTableType

	INSERT INTO @UserIDs
	SELECT Ref.Value
	FROM [dbo].[GFN_StrToGuidTable](@strUserIDs, @delimiter) AS Ref

	IF @DelayFrom IS NOT NULL AND @DelayFrom < 0 SET @DelayFrom = NULL
	ELSE SET @DelayFrom = @DelayFrom * 24 * 60 * 60

	IF @DelayTo IS NOT NULL AND @DelayTo < 0 SET @DelayTo = NULL
	ELSE SET @DelayTo = @DelayTo * 24 * 60 * 60

	DECLARE @HasTargetUsers bit = 0
	IF (SELECT COUNT(*) FROM @UserIDs) > 0 OR @MemberInNodeTypeID IS NOT NULL 
		SET @HasTargetUsers = 1

	DECLARE @TargetUserIDs GuidTableType

	INSERT INTO @TargetUserIDs (Value)
	SELECT DISTINCT X.UserID
	FROM (
			SELECT Value AS UserID
			FROM @UserIDs
			
			UNION ALL
			
			SELECT NM.UserID
			FROM [dbo].[CN_View_NodeMembers] AS NM
			WHERE @MemberInNodeTypeID IS NOT NULL AND NM.ApplicationID = @ApplicationID AND
				NM.NodeTypeID = @MemberInNodeTypeID AND NM.IsPending = 0
		) AS X
		

	SELECT	ND.NodeID AS NodeID_Hide,
			ND.NodeName,
			ND.TypeName AS NodeType,
			D.UserID AS UserID_Hide,
			UN.FirstName + N' ' + UN.LastName AS FullName,
			D.SendDate,
			D.ActionDate,
			CASE
				WHEN D.Deleted = 0 AND D.ActionDate IS NULL THEN N'Pending'
				WHEN D.ActionDate IS NOT NULL THEN N'Done'
				ELSE N''
			END AS DoneStatus_Dic,
			CASE WHEN D.Seen = 0 THEN N'Seen' ELSE N'NotSeen' END AS SeenStatus_Dic, 
			CASE
				WHEN D.Deleted IS NULL THEN 0
				ELSE ISNULL(CAST(DATEDIFF(second, D.SendDate, ISNULL(D.ActionDate, @Now)) as int) / (24 * 3600), 0)
			END AS ActionDelay
	FROM @TargetUserIDs AS T
		RIGHT JOIN [dbo].[NTFN_Dashboards] AS D
		ON D.ApplicationID = @ApplicationID AND D.UserID = T.Value
		INNER JOIN [dbo].[CN_View_Nodes_Normal] AS ND
		ON ND.ApplicationID = @ApplicationID AND ND.NodeID = D.NodeID AND
			(@KnowledgeTypeID IS NULL OR ND.NodeTypeID = @KnowledgeTypeID)
		INNER JOIN [dbo].[Users_Normal] AS UN
		ON UN.ApplicationID = @ApplicationID AND UN.UserID = D.UserID
	WHERE D.ApplicationID = @ApplicationID AND (@HasTargetUsers = 0 OR T.Value IS NOT NULL) AND
		D.[Type] = N'Knowledge' AND D.SubType = N'Admin' AND
		(@SendDateFrom IS NULL OR D.SendDate >= @SendDateFrom) AND
		(@SendDateTo IS NULL OR D.SendDate <= @SendDateTo) AND
		(@ActionDateFrom IS NULL OR D.ActionDate >= @ActionDateFrom) AND
		(@ActionDateTo IS NULL OR D.ActionDate <= @ActionDateTo) AND
		(@DelayFrom IS NULL OR (D.Deleted = 0 AND
			DATEDIFF(second, D.SendDate, ISNULL(D.ActionDate, @Now)) >= @DelayFrom)) AND
		(@DelayTo IS NULL OR  (D.Deleted = 0 AND
			DATEDIFF(second, D.SendDate, ISNULL(D.ActionDate, @Now)) <= @DelayTo)) AND
		(@Done IS NULL OR ((@Done = 1 OR D.Deleted = 0) AND D.Done = @Done)) AND
		(@Seen IS NULL OR D.Seen = @Seen) AND
		(@KnowledgeID IS NULL OR ND.NodeID = @KnowledgeID)

	
	SELECT ('{' +
			'"FullName": {"Action": "Link", "Type": "User",' +
				'"Requires": {"ID": "UserID_Hide"}' +
			'},' +
			'"NodeName": {"Action": "Link", "Type": "Node",' +
				'"Requires": {"ID": "NodeID_Hide"}' +
			'}' +
		   '}') AS Actions

END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[KW_KnowledgeEvaluationsReport]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[KW_KnowledgeEvaluationsReport]
GO

CREATE PROCEDURE [dbo].[KW_KnowledgeEvaluationsReport]
	@ApplicationID			uniqueidentifier,
	@CurrentUserID			uniqueidentifier,
	@Now					datetime,
    @KnowledgeTypeID		uniqueidentifier,
	@strUserIDs				varchar(max),
	@delimiter				char,
	@MemberInNodeTypeID		uniqueidentifier,
	@SendDateFrom			datetime,
	@SendDateTo				datetime,
	@ActionDateFrom			datetime,
	@ActionDateTo			datetime,
	@DelayFrom				int,
	@DelayTo				int,
	@Seen					bit,
	@Done					bit,
	@Canceled				bit
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @UserIDs GuidTableType
	
	INSERT INTO @UserIDs
	SELECT Ref.Value
	FROM [dbo].[GFN_StrToGuidTable](@strUserIDs, @delimiter) AS Ref
	
	IF @DelayFrom IS NOT NULL AND @DelayFrom < 0 SET @DelayFrom = NULL
	ELSE SET @DelayFrom = @DelayFrom * 24 * 60 * 60

	IF @DelayTo IS NOT NULL AND @DelayTo < 0 SET @DelayTo = NULL
	ELSE SET @DelayTo = @DelayTo * 24 * 60 * 60

	DECLARE @HasTargetUsers bit = 0
	IF (SELECT COUNT(*) FROM @UserIDs) > 0 OR @MemberInNodeTypeID IS NOT NULL 
		SET @HasTargetUsers = 1

	DECLARE @TargetUserIDs GuidTableType

	INSERT INTO @TargetUserIDs (Value)
	SELECT DISTINCT X.UserID
	FROM (
			SELECT Value AS UserID
			FROM @UserIDs
			
			UNION ALL
			
			SELECT NM.UserID
			FROM [dbo].[CN_View_NodeMembers] AS NM
			WHERE @MemberInNodeTypeID IS NOT NULL AND NM.ApplicationID = @ApplicationID AND
				NM.NodeTypeID = @MemberInNodeTypeID AND NM.IsPending = 0
		) AS X
		

	SELECT	D.UserID AS UserID_Hide,
			MAX(UN.FirstName + N' ' + UN.LastName) AS FullName,
			COUNT(D.ID) AS ItemsCount,
			SUM(CASE WHEN D.Deleted = 0 AND D.ActionDate IS NULL THEN 1 ELSE 0 END) AS PendingCount,
			SUM(CASE WHEN D.ActionDate IS NULL THEN 0 ELSE 1 END) AS EvaluationsCount,
			SUM(CASE WHEN D.Deleted = 1 THEN 1 ELSE 0 END) AS CanceledCount,
			SUM(CASE WHEN D.Seen = 0 THEN 1 ELSE 0 END) AS NotSeenCount, 
			AVG(
				CASE
					WHEN D.ActionDate IS NULL THEN NULL
					ELSE ISNULL(CAST(DATEDIFF(second, D.SendDate, D.ActionDate) as float) / (24 * 3600), 0)
				END
			) AS DoneDelayAverage, 
			MIN(
				CASE
					WHEN D.ActionDate IS NULL THEN 0
					ELSE ISNULL(CAST(DATEDIFF(second, D.SendDate, D.ActionDate) as float) / (24 * 3600), 0)
				END
			) AS DoneDelayMin, 
			MAX(
				CASE
					WHEN D.ActionDate IS NULL THEN 0
					ELSE ISNULL(CAST(DATEDIFF(second, D.SendDate, D.ActionDate) as float) / (24 * 3600), 0)
				END
			) AS DoneDelayMax,
			AVG(
				CASE
					WHEN D.ActionDate IS NOT NULL OR D.Deleted = 1 THEN NULL
					ELSE ISNULL(CAST(DATEDIFF(second, D.SendDate, @Now) as float) / (24 * 3600), 0)
				END
			) AS NotDoneDelayAverage, 
			MIN(
				CASE
					WHEN D.ActionDate IS NOT NULL OR D.Deleted = 1 THEN 0
					ELSE ISNULL(CAST(DATEDIFF(second, D.SendDate, @Now) as float) / (24 * 3600), 0)
				END
			) AS NotDoneDelayMin, 
			MAX(
				CASE
					WHEN D.ActionDate IS NOT NULL OR D.Deleted = 1 THEN 0
					ELSE ISNULL(CAST(DATEDIFF(second, D.SendDate, @Now) as float) / (24 * 3600), 0)
				END
			) AS NotDoneDelayMax
	FROM @TargetUserIDs AS T
		RIGHT JOIN [dbo].[NTFN_Dashboards] AS D
		ON D.ApplicationID = @ApplicationID AND D.UserID = T.Value
		INNER JOIN [dbo].[CN_Nodes] AS ND
		ON ND.ApplicationID = @ApplicationID AND ND.NodeID = D.NodeID AND
			(@KnowledgeTypeID IS NULL OR ND.NodeTypeID = @KnowledgeTypeID)
		INNER JOIN [dbo].[Users_Normal] AS UN
		ON UN.ApplicationID = @ApplicationID AND UN.UserID = D.UserID
	WHERE D.ApplicationID = @ApplicationID AND (@HasTargetUsers = 0 OR T.Value IS NOT NULL) AND
		D.[Type] = N'Knowledge' AND D.SubType = N'Evaluator' AND
		(@SendDateFrom IS NULL OR D.SendDate >= @SendDateFrom) AND
		(@SendDateTo IS NULL OR D.SendDate <= @SendDateTo) AND
		(@ActionDateFrom IS NULL OR D.ActionDate >= @ActionDateFrom) AND
		(@ActionDateTo IS NULL OR D.ActionDate <= @ActionDateTo) AND
		(@DelayFrom IS NULL OR 
			DATEDIFF(second, D.SendDate, ISNULL(D.ActionDate, @Now)) >= @DelayFrom) AND
		(@DelayTo IS NULL OR 
			DATEDIFF(second, D.SendDate, ISNULL(D.ActionDate, @Now)) <= @DelayTo) AND
		(@Done IS NULL OR ((@Done = 1 OR D.Deleted = 0) AND D.Done = @Done)) AND
		(@Seen IS NULL OR D.Seen = @Seen) AND
		(@Canceled IS NULL OR D.Deleted = @Canceled)
	GROUP BY D.UserID

	
	SELECT ('{' +
			'"FullName": {"Action": "Link", "Type": "User",' +
				'"Requires": {"ID": "UserID_Hide"}' +
			'},' +
			'"PendingCount": {"Action": "Report", ' +
		   		'"ModuleIdentifier": "KW", "ReportName": "KnowledgeEvaluationsDetailReport",' +
		   		'"Requires":{"UserID":{"Value": "UserID_Hide", "Title": "FullName"}},' +
		   		'"Params": {"Done": "false"}' + 
		   	'},' +
		   	'"EvaluationsCount": {"Action": "Report", ' +
		   		'"ModuleIdentifier": "KW", "ReportName": "KnowledgeEvaluationsDetailReport",' +
		   		'"Requires":{"UserID":{"Value": "UserID_Hide", "Title": "FullName"}},' +
		   		'"Params": {"Done": "true"}' + 
		   	'},' +
		   	'"CanceledCount": {"Action": "Report", ' +
		   		'"ModuleIdentifier": "KW", "ReportName": "KnowledgeEvaluationsDetailReport",' +
		   		'"Requires":{"UserID":{"Value": "UserID_Hide", "Title": "FullName"}},' +
		   		'"Params": {"Canceled": "true"}' + 
		   	'},' +
		   	'"NotSeenCount": {"Action": "Report", ' +
		   		'"ModuleIdentifier": "KW", "ReportName": "KnowledgeEvaluationsDetailReport",' +
		   		'"Requires":{"UserID":{"Value": "UserID_Hide", "Title": "FullName"}},' +
		   		'"Params": {"Seen": "false"}' + 
		   	'}' +
		   '}') AS Actions

END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[KW_KnowledgeEvaluationsDetailReport]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[KW_KnowledgeEvaluationsDetailReport]
GO

CREATE PROCEDURE [dbo].[KW_KnowledgeEvaluationsDetailReport]
	@ApplicationID			uniqueidentifier,
	@CurrentUserID			uniqueidentifier,
	@Now					datetime,
	@KnowledgeID			uniqueidentifier,
    @KnowledgeTypeID		uniqueidentifier,
	@strUserIDs				varchar(max),
	@delimiter				char,
	@MemberInNodeTypeID		uniqueidentifier,
	@SendDateFrom			datetime,
	@SendDateTo				datetime,
	@ActionDateFrom			datetime,
	@ActionDateTo			datetime,
	@DelayFrom				int,
	@DelayTo				int,
	@Seen					bit,
	@Done					bit,
	@Canceled				bit
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @UserIDs GuidTableType

	INSERT INTO @UserIDs
	SELECT Ref.Value
	FROM [dbo].[GFN_StrToGuidTable](@strUserIDs, @delimiter) AS Ref

	IF @DelayFrom IS NOT NULL AND @DelayFrom < 0 SET @DelayFrom = NULL
	ELSE SET @DelayFrom = @DelayFrom * 24 * 60 * 60

	IF @DelayTo IS NOT NULL AND @DelayTo < 0 SET @DelayTo = NULL
	ELSE SET @DelayTo = @DelayTo * 24 * 60 * 60

	DECLARE @HasTargetUsers bit = 0
	IF (SELECT COUNT(*) FROM @UserIDs) > 0 OR @MemberInNodeTypeID IS NOT NULL 
		SET @HasTargetUsers = 1

	DECLARE @TargetUserIDs GuidTableType

	INSERT INTO @TargetUserIDs (Value)
	SELECT DISTINCT X.UserID
	FROM (
			SELECT Value AS UserID
			FROM @UserIDs
			
			UNION ALL
			
			SELECT NM.UserID
			FROM [dbo].[CN_View_NodeMembers] AS NM
			WHERE @MemberInNodeTypeID IS NOT NULL AND NM.ApplicationID = @ApplicationID AND
				NM.NodeTypeID = @MemberInNodeTypeID AND NM.IsPending = 0
		) AS X
		

	SELECT	ND.NodeID AS NodeID_Hide,
			ND.NodeName,
			ND.TypeName AS NodeType,
			D.UserID AS UserID_Hide,
			UN.FirstName + N' ' + UN.LastName AS FullName,
			D.SendDate,
			D.ActionDate,
			CASE
				WHEN D.Deleted = 0 AND D.ActionDate IS NULL THEN N'Pending'
				WHEN D.Deleted = 1 THEN N'Canceled'
				WHEN D.ActionDate IS NOT NULL THEN N'Done'
				ELSE N''
			END AS EvaluationStatus_Dic,
			CASE WHEN D.Seen = 0 THEN N'Seen' ELSE N'NotSeen' END AS SeenStatus_Dic, 
			CASE
				WHEN D.Deleted IS NULL THEN 0
				ELSE ISNULL(CAST(DATEDIFF(second, D.SendDate, ISNULL(D.ActionDate, @Now)) as int) / (24 * 3600), 0)
			END AS EvaluationDelay
	FROM @TargetUserIDs AS T
		RIGHT JOIN [dbo].[NTFN_Dashboards] AS D
		ON D.ApplicationID = @ApplicationID AND D.UserID = T.Value
		INNER JOIN [dbo].[CN_View_Nodes_Normal] AS ND
		ON ND.ApplicationID = @ApplicationID AND ND.NodeID = D.NodeID AND
			(@KnowledgeTypeID IS NULL OR ND.NodeTypeID = @KnowledgeTypeID)
		INNER JOIN [dbo].[Users_Normal] AS UN
		ON UN.ApplicationID = @ApplicationID AND UN.UserID = D.UserID
	WHERE D.ApplicationID = @ApplicationID AND (@HasTargetUsers = 0 OR T.Value IS NOT NULL) AND
		D.[Type] = N'Knowledge' AND D.SubType = N'Evaluator' AND
		(@SendDateFrom IS NULL OR D.SendDate >= @SendDateFrom) AND
		(@SendDateTo IS NULL OR D.SendDate <= @SendDateTo) AND
		(@ActionDateFrom IS NULL OR D.ActionDate >= @ActionDateFrom) AND
		(@ActionDateTo IS NULL OR D.ActionDate <= @ActionDateTo) AND
		(@DelayFrom IS NULL OR (D.Deleted = 0 AND
			DATEDIFF(second, D.SendDate, ISNULL(D.ActionDate, @Now)) >= @DelayFrom)) AND
		(@DelayTo IS NULL OR  (D.Deleted = 0 AND
			DATEDIFF(second, D.SendDate, ISNULL(D.ActionDate, @Now)) <= @DelayTo)) AND
		(@Done IS NULL OR ((@Done = 1 OR D.Deleted = 0) AND D.Done = @Done)) AND
		(@Seen IS NULL OR D.Seen = @Seen) AND
		(@Canceled IS NULL OR D.Deleted = @Canceled) AND
		(@KnowledgeID IS NULL OR ND.NodeID = @KnowledgeID)

	
	SELECT ('{' +
			'"FullName": {"Action": "Link", "Type": "User",' +
				'"Requires": {"ID": "UserID_Hide"}' +
			'},' +
			'"NodeName": {"Action": "Link", "Type": "Node",' +
				'"Requires": {"ID": "NodeID_Hide"}' +
			'}' +
		   '}') AS Actions

END

GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[KW_KnowledgeEvaluationsHistoryReport]') AND
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[KW_KnowledgeEvaluationsHistoryReport]
GO

CREATE PROCEDURE [dbo].[KW_KnowledgeEvaluationsHistoryReport]
	@ApplicationID		uniqueidentifier,
	@CurrentUserID		uniqueidentifier,
	@KnowledgeTypeID	uniqueidentifier,
	@KnowledgeID		uniqueidentifier,
	@strUserIDs			varchar(max),
	@delimiter			char,
	@DateFrom			datetime,
	@DateTo				datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @UserIDs GuidTableType
	
	INSERT INTO @UserIDs (Value)
	SELECT DISTINCT Ref.Value
	FROM [dbo].[GFN_StrToGuidTable](@strUserIDs, @delimiter) AS Ref
	
	DECLARE @UsersIDsCount int = (SELECT COUNT(*) FROM @UserIDs)
	
	DECLARE @LastVersions TABLE (KnowledgeID uniqueidentifier primary key clustered, LastVersionID int)

	INSERT INTO @LastVersions (KnowledgeID, LastVersionID)
	SELECT H.KnowledgeID, MAX(H.WFVersionID) AS LastVersionID
	FROM [dbo].[KW_History] AS H
	GROUP BY H.KnowledgeID


	DECLARE @Ret TABLE (
		NodeID_Hide uniqueidentifier, 
		NodeName nvarchar(1000), 
		NodeAdditionalID nvarchar(100),
		NodeType nvarchar(200),
		CreatorUserID_Hide uniqueidentifier,
		CreatorFullName nvarchar(200),
		CreatorUserName nvarchar(100),
		Status_Dic nvarchar(100),
		EvaluatorUserID_Hide uniqueidentifier,
		EvaluatorFullName nvarchar(200),
		EvaluatorUserName nvarchar(100),
		Score float,
		EvaluationDate datetime,
		WFVersionID int,
		[Description] nvarchar(max),
		Reasons nvarchar(1000)
	)


	INSERT INTO @Ret (NodeID_Hide, NodeName, NodeAdditionalID, NodeType, CreatorUserID_Hide, CreatorUserName, CreatorFullName, 
		Status_Dic, EvaluatorUserID_Hide, EvaluatorUserName, EvaluatorFullName, Score, EvaluationDate, WFVersionID, 
		[Description], Reasons)
	SELECT	ND.NodeID, ND.NodeName, ND.NodeAdditionalID, ND.TypeName, UN.UserID, UN.UserName, 
		LTRIM(RTRIM(ISNULL(UN.FirstName, N'') + N' ' + ISNULL(UN.LastName, N''))),
		ND.[Status], X.EvaluatorUserID, X.EvaluatorUserName,
		LTRIM(RTRIM(ISNULL(X.EvaluatorFirstName, N'') + N' ' + ISNULL(X.EvaluatorLastName, N''))),
		X.Score, X.EvaluationDate, X.WFVersionID, H.[Description], H.TextOptions
	FROM (
			SELECT	Ref.KnowledgeID,
					Ref.UserID AS EvaluatorUserID,
					UN.UserName AS EvaluatorUserName,
					UN.FirstName AS EvaluatorFirstName,
					UN.LastName AS EvaluatorLastName,
					Ref.Score,
					Ref.EvaluationDate,
					LV.LastVersionID AS WFVersionID
			FROM (
					SELECT	A.KnowledgeID, 
							A.UserID, 
							(SUM(ISNULL(ISNULL(A.AdminScore, A.Score), 0)) / ISNULL(COUNT(A.UserID), 1)) AS Score,
							MAX(A.EvaluationDate) AS EvaluationDate
					FROM [dbo].[KW_QuestionAnswers] AS A
					WHERE A.ApplicationID = @ApplicationID AND A.Deleted = 0 AND
						(@DateFrom IS NULL OR A.EvaluationDate > @DateFrom) AND
						(@DateTo IS NULL OR A.EvaluationDate <= @DateTo)
					GROUP BY A.KnowledgeID, A.UserID
				) AS Ref
				INNER JOIN @LastVersions AS LV
				ON LV.KnowledgeID = Ref.KnowledgeID
				INNER JOIN [dbo].[Users_Normal] AS UN
				ON UN.ApplicationID = @ApplicationID AND UN.UserID = Ref.UserID AND
					(@UsersIDsCount = 0 OR UN.UserID IN (SELECT Value FROM @UserIDs))

			UNION ALL

			SELECT	Ref.KnowledgeID,
					Ref.UserID,
					UN.UserName,
					UN.FirstName,
					UN.LastName,
					Ref.Score,
					Ref.EvaluationDate,
					Ref.WFVersionID
			FROM (
					SELECT A.KnowledgeID, A.UserID, (SUM(ISNULL(ISNULL(A.AdminScore, A.Score), 0)) / ISNULL(COUNT(A.UserID), 1)) AS Score,
						MAX(A.EvaluationDate) AS EvaluationDate, A.WFVersionID
					FROM [dbo].[KW_QuestionAnswersHistory] AS A
					WHERE A.ApplicationID = @ApplicationID AND A.Deleted = 0 AND
						(@DateFrom IS NULL OR A.EvaluationDate > @DateFrom) AND
						(@DateTo IS NULL OR A.EvaluationDate <= @DateTo)
					GROUP BY A.KnowledgeID, A.UserID, A.WFVersionID
				) AS Ref
				INNER JOIN [dbo].[Users_Normal] AS UN
				ON UN.ApplicationID = @ApplicationID AND UN.UserID = Ref.UserID AND
					(@UsersIDsCount = 0 OR UN.UserID IN (SELECT Value FROM @UserIDs))
		) AS X
		INNER JOIN [dbo].[CN_View_Nodes_Normal] AS ND
		ON ND.ApplicationID = @ApplicationID AND ND.NodeID = X.KnowledgeID AND
			(@KnowledgeTypeID IS NULL OR ND.NodeTypeID = @KnowledgeTypeID) AND
			(@KnowledgeID IS NULL OR ND.NodeID = @KnowledgeID)
		INNER JOIN [dbo].[Users_Normal] AS UN
		ON UN.ApplicationID = @ApplicationID AND UN.UserID = ND.CreatorUserID
		LEFT JOIN [dbo].[KW_History] AS H
		ON H.ApplicationID = @ApplicationID AND H.KnowledgeID = X.KnowledgeID AND 
			H.ActorUserID = X.EvaluatorUserID AND H.ActionDate = X.EvaluationDate
	ORDER BY X.EvaluationDate DESC, X.KnowledgeID DESC, X.WFVersionID DESC

	SELECT *
	FROM @Ret


	SELECT ('{' +
			'"NodeName": {"Action": "Link", "Type": "Node",' +
				'"Requires": {"ID": "NodeID_Hide"}' +
			'},' +
			'"CreatorFullName": {"Action": "Link", "Type": "User",' +
				'"Requires": {"UID": "CreatorUserID_Hide"}' +
			'},' +
			'"EvaluatorFullName": {"Action": "Link", "Type": "User",' +
				'"Requires": {"UID": "EvaluatorUserID_Hide"}' +
			'},' +
			'"Contributor": {"Action": "Link", "Type": "User",' +
				'"Requires": {"UID": "ContributorID_Hide"}' +
			'}' +
		   '}') AS Actions
		   
	   
	-- Add Contributor Columns

	DECLARE @Proc nvarchar(max) = N''

	SELECT X.*
	INTO #Result
	FROM (
			SELECT	C.NodeID, 
					CAST(C.UserID AS varchar(50)) AS unq,
					C.UserID, 
					C.CollaborationShare AS Share,
					ROW_NUMBER() OVER (PARTITION BY C.NodeID ORDER BY C.CollaborationShare DESC, C.UserID DESC) AS RowNumber
			FROM @Ret AS IDs
				INNER JOIN [dbo].[CN_NodeCreators] AS C
				ON C.ApplicationID = @ApplicationID AND C.NodeID = IDs.NodeID_Hide AND C.Deleted = 0
		) AS X
		
	DECLARE @Count int = (SELECT MAX(RowNumber) FROM #Result)
	DECLARE @ItemsList varchar(max) = N'', @SelectList varchar(max) = N'', @ColsToTransfer varchar(max) = N''

	SET @Proc = N''

	DECLARE @Ind int = @Count - 1
	WHILE @Ind >= 0 BEGIN
		DECLARE @Tmp varchar(10) = CAST((@Count - @Ind) AS varchar(10))
		
		SET @SelectList = @SelectList + '[' + @Tmp + '] AS [ContributorID_Hide_' + @Tmp + '], ' + 
			'CAST(NULL AS nvarchar(500)) AS [Contributor_' + @Tmp + '], ' +
			'CAST(NULL AS float) AS [ContributorShare_' + @Tmp + ']'
			
		SET @ItemsList = @ItemsList + '[' + @Tmp + ']'
		
		SET @Proc = @Proc + 
			'SELECT ''ContributorID_Hide_' + @Tmp + ''' AS ColumnName, null AS Translation, ''string'' AS Type ' +
			'UNION ALL ' +
			'SELECT ''Contributor_' + @Tmp + ''' AS ColumnName, null AS Translation, ''string'' AS Type ' +
			'UNION ALL ' +
			'SELECT ''ContributorShare_' + @Tmp + ''' AS ColumnName, null AS Translation, ''double'' AS Type '
			
		SET @ColsToTransfer = @ColsToTransfer + 
			'ContributorID_Hide_' + @Tmp + ',Contributor_' + @Tmp + ',ContributorShare_' + @Tmp
		
		IF @Ind > 0 BEGIN 
			SET @SelectList = @SelectList + ', '
			SET @ItemsList = @ItemsList + ', '
			SET @Proc = @Proc + N'UNION ALL '
			SET @ColsToTransfer = @ColsToTransfer + ','
		END
		
		SET @Ind = @Ind - 1
	END

	-- Second Part: Describes the Third Part
	EXEC (@Proc)

	SELECT ('{"IsDescription": "true"}') AS Info
	-- end of Second Part

	-- Third Part: The Data
	SET @Proc = 
		'SELECT NodeID AS NodeID_Hide, ' + @SelectList + 
		'INTO #Final ' +
		'FROM ( ' +
				'SELECT NodeID, unq, RowNumber ' +
				'FROM #Result ' +
			') AS P ' +
			'PIVOT (MAX(unq) FOR RowNumber IN (' + @ItemsList + ')) AS PVT '

	SET @Ind = @Count - 1
	WHILE @Ind >= 0 BEGIN
		DECLARE @No varchar(10) = CAST((@Count - @Ind) AS varchar(10))
		
		SET @Proc = @Proc + 
			'UPDATE F ' + 
				'SET Contributor_' + @No + ' = LTRIM(RTRIM(ISNULL(UN.FirstName, N'''') + N'' '' + ISNULL(UN.LastName, N''''))) ' + 
			'FROM #Final AS F ' + 
				'INNER JOIN [dbo].[Users_Normal] AS UN ' + 
				'ON UN.ApplicationID = ''' + CAST(@ApplicationID AS varchar(50)) + ''' AND UN.UserID = F.ContributorID_Hide_' + @No + ' '
				
		SET @Proc = @Proc + 
			'UPDATE F ' + 
				'SET ContributorShare_' + @No + ' = R.Share ' + 
			'FROM #Final AS F ' + 
				'INNER JOIN #Result AS R ' + 
				'ON R.NodeID = F.NodeID_Hide AND R.UserID = F.ContributorID_Hide_' + @No + ' '
		
		SET @Ind = @Ind - 1
	END

	SET @Proc = @Proc + 'SELECT * FROM #Final'

	EXEC (@Proc)

	SELECT ('{' +
			'"ColumnsMap": "NodeID_Hide:NodeID_Hide",' +
			'"ColumnsToTransfer": "' + @ColsToTransfer + '"' +
		   '}') AS Info
	-- end of Third Part

	-- end of Add Contributor Columns
END

GO

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[RV_FN_KnowledgeDemandIndicatorsReport]') 
    AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
DROP FUNCTION [dbo].[RV_FN_KnowledgeDemandIndicatorsReport]
GO

CREATE FUNCTION [dbo].[RV_FN_KnowledgeDemandIndicatorsReport](
	@ApplicationID			uniqueidentifier,
	@CurrentUserID			uniqueidentifier,
	@ContentTypeIDsTemp		GuidTableType readonly,
	@UserIDsTemp			GuidTableType readonly,
	@AllUsers				bit,
	@LowerCreationDateLimit datetime,
	@UpperCreationDateLimit datetime
)
RETURNS @outputTable TABLE (
	UserID		uniqueidentifier,
	VisitedID	uniqueidentifier,
	SearchID	bigint,
	QuestionID	uniqueidentifier,
	PostID		uniqueidentifier,
	CommentID	uniqueidentifier,
	[Date]		datetime
)
WITH ENCRYPTION
AS
BEGIN
	DECLARE @ContentTypeIDs GuidTableType
	INSERT INTO @ContentTypeIDs (Value) SELECT Ref.Value FROM @ContentTypeIDsTemp AS Ref

	DECLARE @ContentTypesCount int = (SELECT COUNT(*) FROM @ContentTypeIDs)

	DECLARE @UserIDs GuidTableType

	INSERT INTO @UserIDs ([Value])
	SELECT Ref.[Value]
	FROM @UserIDsTemp AS Ref

	INSERT INTO @outputTable (UserID, VisitedID, SearchID, QuestionID, PostID, CommentID, [Date])
	(
		SELECT	IV.UserID,
				IV.ItemID AS VisitedID,
				NULL AS SearchID,
				NULL AS QuestionID,
				NULL AS PostID,
				NULL AS CommentID,
				IV.VisitDate AS [Date]
		FROM [dbo].[USR_ItemVisits] AS IV
			INNER JOIN [dbo].[CN_Nodes] AS ND
			ON ND.ApplicationID = @ApplicationID AND ND.NodeID = IV.ItemID AND ND.Deleted = 0 AND
				(@ContentTypesCount = 0 OR ND.NodeTypeID IN (SELECT Ref.[Value] FROM @ContentTypeIDs AS Ref))
			INNER JOIN [dbo].[Users_Normal] AS UN
			ON UN.ApplicationID = @ApplicationID AND UN.UserID = IV.UserID AND UN.IsApproved = 1
		WHERE IV.ApplicationID = @ApplicationID AND
			(@AllUsers = 1 OR IV.UserID IN (SELECT U.[Value] FROM @UserIDs AS U)) AND 
			(@LowerCreationDateLimit IS NULL OR IV.VisitDate >= @LowerCreationDateLimit) AND
			(@UpperCreationDateLimit IS NULL OR IV.VisitDate < @UpperCreationDateLimit)

		UNION ALL

		SELECT	L.UserID AS UserID,
				NULL AS VisitedID,
				L.LogID AS SearchID,
				NULL AS QuestionID,
				NULL AS PostID,
				NULL AS CommentID,
				L.[Date]
		FROM [dbo].[LG_Logs] AS L
			INNER JOIN [dbo].[Users_Normal] AS UN
			ON UN.ApplicationID = @ApplicationID AND UN.UserID = L.UserID AND UN.IsApproved = 1
		WHERE L.ApplicationID = @ApplicationID AND L.[Action] = N'Search' AND 
			(@AllUsers = 1 OR L.UserID IN (SELECT U.[Value] FROM @UserIDs AS U)) AND 
			(@LowerCreationDateLimit IS NULL OR L.[Date] >= @LowerCreationDateLimit) AND
			(@UpperCreationDateLimit IS NULL OR L.[Date] < @UpperCreationDateLimit)

		UNION ALL

		SELECT	Q.SenderUserID AS UserID,
				NULL AS VisitedID,
				NULL AS SearchID,
				Q.QuestionID AS QuestionID,
				NULL AS PostID,
				NULL AS CommentID,
				Q.SendDate AS [Date]
		FROM [dbo].[QA_Questions] AS Q
			INNER JOIN [dbo].[Users_Normal] AS UN
			ON UN.ApplicationID = @ApplicationID AND UN.UserID = Q.SenderUserID AND UN.IsApproved = 1
		WHERE Q.ApplicationID = @ApplicationID AND 
			(@AllUsers = 1 OR Q.SenderUserID IN (SELECT U.[Value] FROM @UserIDs AS U)) AND Q.Deleted = 0 AND
			(@LowerCreationDateLimit IS NULL OR Q.SendDate >= @LowerCreationDateLimit) AND
			(@UpperCreationDateLimit IS NULL OR Q.SendDate < @UpperCreationDateLimit)

		UNION ALL

		SELECT	PS.SenderUserID AS UserID,
				NULL AS VisitedID,
				NULL AS SearchID,
				NULL AS QuestionID,
				PS.ShareID AS PostID,
				NULL AS CommentID,
				PS.SendDate AS [Date]
		FROM [dbo].[SH_PostShares] AS PS
			INNER JOIN [dbo].[CN_Nodes] AS ND
			ON ND.ApplicationID = @ApplicationID AND ND.NodeID = PS.OwnerID AND ND.Deleted = 0 AND
				(@ContentTypesCount = 0 OR ND.NodeTypeID IN (SELECT Ref.[Value] FROM @ContentTypeIDs AS Ref))
			INNER JOIN [dbo].[Users_Normal] AS UN
			ON UN.ApplicationID = @ApplicationID AND UN.UserID = PS.SenderUserID AND UN.IsApproved = 1
		WHERE PS.ApplicationID = @ApplicationID AND 
			(@AllUsers = 1 OR PS.SenderUserID IN (SELECT U.[Value] FROM @UserIDs AS U)) AND PS.Deleted = 0 AND 
			(@LowerCreationDateLimit IS NULL OR PS.SendDate >= @LowerCreationDateLimit) AND
			(@UpperCreationDateLimit IS NULL OR PS.SendDate < @UpperCreationDateLimit)

		UNION ALL

		SELECT	C.SenderUserID AS UserID,
				NULL AS VisitedID,
				NULL AS SearchID,
				NULL AS QuestionID,
				NULL AS PostID,
				C.CommentID,
				C.SendDate AS [Date]
		FROM [dbo].[SH_Comments] AS C
			INNER JOIN [dbo].[SH_PostShares] AS PS
			ON PS.ApplicationID = @ApplicationID AND PS.ShareID = C.ShareID
			INNER JOIN [dbo].[CN_Nodes] AS ND
			ON ND.ApplicationID = @ApplicationID AND ND.NodeID = PS.OwnerID AND ND.Deleted = 0 AND
				(@ContentTypesCount = 0 OR ND.NodeTypeID IN (SELECT Ref.[Value] FROM @ContentTypeIDs AS Ref))
			INNER JOIN [dbo].[Users_Normal] AS UN
			ON UN.ApplicationID = @ApplicationID AND UN.UserID = C.SenderUserID AND UN.IsApproved = 1
		WHERE C.ApplicationID = @ApplicationID AND 
			(@AllUsers = 1 OR C.SenderUserID IN (SELECT U.[Value] FROM @UserIDs AS U)) AND PS.Deleted = 0 AND 
			(@LowerCreationDateLimit IS NULL OR C.SendDate >= @LowerCreationDateLimit) AND
			(@UpperCreationDateLimit IS NULL OR C.SendDate < @UpperCreationDateLimit)
	)

	RETURN
END

GO

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[RV_KnowledgeDemandIndicatorsReport]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[RV_KnowledgeDemandIndicatorsReport]
GO

CREATE PROCEDURE [dbo].[RV_KnowledgeDemandIndicatorsReport]
	@ApplicationID			uniqueidentifier,
	@CurrentUserID			uniqueidentifier,
	@ContentTypeIDsTemp		GuidTableType readonly,
	@CreatorNodeTypeID		uniqueidentifier,
	@NodeIDsTemp			GuidTableType readonly,
	@LowerCreationDateLimit datetime,
	@UpperCreationDateLimit datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON

	DECLARE @ContentTypeIDs GuidTableType
	INSERT INTO @ContentTypeIDs (Value) SELECT Ref.Value FROM @ContentTypeIDsTemp AS Ref
	
	DECLARE @CreatorNodeIDs GuidTableType

	INSERT INTO @CreatorNodeIDs ([Value])
	SELECT Ref.[Value]
	FROM @NodeIDsTemp AS Ref

	DECLARE @CreatorCount int = (SELECT COUNT(*) FROM @CreatorNodeIDs)

	DECLARE @UserIDs GuidTableType

	DECLARE @AllUsers bit = 0

	IF @CreatorNodeTypeID IS NULL AND NOT EXISTS (SELECT TOP(1) * FROM @CreatorNodeIDs) SET @AllUsers = 1

	DECLARE @GroupMembers TABLE (
		GroupID				uniqueidentifier, 
		GroupName			nvarchar(500), 
		UserID				uniqueidentifier,
		LastActivityDate	datetime
	)

	IF @AllUsers = 0 BEGIN
		INSERT INTO @GroupMembers (GroupID, GroupName, UserID, LastActivityDate)
		SELECT Groups.NodeID, Groups.[Name], NM.UserID, UN.LastActivityDate
		FROM [dbo].[CN_Nodes] AS Groups
			INNER JOIN [dbo].[CN_View_NodeMembers] AS NM
			ON NM.ApplicationID = @ApplicationID AND NM.NodeID = Groups.NodeID AND NM.IsPending = 0
			INNER JOIN [dbo].[Users_Normal] AS UN
			ON UN.ApplicationID = @ApplicationID AND UN.UserID = NM.UserID
		WHERE Groups.ApplicationID = @ApplicationID AND (
				(@CreatorCount > 0 AND Groups.NodeID IN (SELECT * FROM @CreatorNodeIDs)) OR
				(@CreatorCount = 0 AND
					(@CreatorNodeTypeID IS NULL OR Groups.NodeTypeID = @CreatorNodeTypeID)
				)
			) AND Groups.Deleted = 0 AND UN.IsApproved = 1

		INSERT INTO @UserIDs ([Value])
		SELECT DISTINCT G.UserID
		FROM @GroupMembers AS G
	END

	IF @AllUsers = 0 BEGIN
		;WITH Content AS (
			SELECT X.UserID, X.VisitedID, X.SearchID, X.QuestionID, X.PostID, X.CommentID, X.[Date]
			FROM [dbo].[RV_FN_KnowledgeDemandIndicatorsReport](@ApplicationID, @CurrentUserID, @ContentTypeIDs, 
				@UserIDs, @AllUsers, @LowerCreationDateLimit, @UpperCreationDateLimit) AS X
		)
		SELECT	G.GroupID AS GroupID_Hide, 
				MAX(G.GroupName) AS GroupName,
				COUNT(DISTINCT G.UserID) AS MembersCount,
				COUNT(C.SearchID) AS SearchesCount,
				COUNT(C.QuestionID) AS QuestionsCount,
				COUNT(C.VisitedID) AS ContentVisitsCount,
				COUNT(DISTINCT C.VisitedID) AS DistinctContentVisitsCount,
				COUNT(DISTINCT C.PostID) AS PostsCount,
				COUNT(DISTINCT C.CommentID) AS CommentsCount
		FROM @GroupMembers AS G
			INNER JOIN Content AS C
			ON C.UserID = G.UserID
		GROUP BY G.GroupID
	END
	ELSE BEGIN
		;WITH Content AS (
			SELECT X.UserID, X.VisitedID, X.SearchID, X.QuestionID, X.PostID, X.CommentID, X.[Date]
			FROM [dbo].[RV_FN_KnowledgeDemandIndicatorsReport](@ApplicationID, @CurrentUserID, @ContentTypeIDs, 
				@UserIDs, @AllUsers, @LowerCreationDateLimit, @UpperCreationDateLimit) AS X
		)
		SELECT	X.UserID AS UserID_Hide,
				LTRIM(RTRIM(ISNULL(UN.FirstName, N' ') + N' ' + ISNULL(UN.LastName, N' '))) AS FullName,
				X.SearchesCount,
				X.QuestionsCount,
				X.ContentVisitsCount,
				X.DistinctContentVisitsCount,
				X.PostsCount,
				X.CommentsCount
		FROM (
				SELECT	C.UserID, 
						COUNT(C.SearchID) AS SearchesCount,
						COUNT(C.QuestionID) AS QuestionsCount,
						COUNT(C.VisitedID) AS ContentVisitsCount,
						COUNT(DISTINCT C.VisitedID) AS DistinctContentVisitsCount,
						COUNT(DISTINCT C.PostID) AS PostsCount,
						COUNT(DISTINCT C.CommentID) AS CommentsCount
				FROM Content AS C
				GROUP BY C.UserID
			) AS X
			INNER JOIN [dbo].[Users_Normal] AS UN
			ON UN.ApplicationID = @ApplicationID AND UN.UserID = X.UserID
	END
	
	SELECT ('{' +
		'"GroupName": {"Action": "Link", "Type": "Node",' +
			'"Requires": {"ID": "GroupID_Hide"}' +
		'},' +
		'"FullName": {"Action": "Link", "Type": "User",' +
			'"Requires": {"ID": "UserID_Hide"}' +
		'}' +
	   '}') AS Actions
END

GO

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[RV_KnowledgeDemandIndicatorsReport_Chart]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[RV_KnowledgeDemandIndicatorsReport_Chart]
GO

CREATE PROCEDURE [dbo].[RV_KnowledgeDemandIndicatorsReport_Chart]
	@ApplicationID			uniqueidentifier,
	@CurrentUserID			uniqueidentifier,
	@Period					varchar(50),
	@CalendarType			varchar(50),
	@PeriodList				BigIntTableType readonly,
	@ContentTypeIDsTemp		GuidTableType readonly,
	@CreatorNodeTypeID		uniqueidentifier,
	@NodeIDsTemp			GuidTableType readonly,
	@LowerCreationDateLimit datetime,
	@UpperCreationDateLimit datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON

	DECLARE @ContentTypeIDs GuidTableType
	INSERT INTO @ContentTypeIDs (Value) SELECT Ref.Value FROM @ContentTypeIDsTemp AS Ref
	
	DECLARE @CreatorNodeIDs GuidTableType

	INSERT INTO @CreatorNodeIDs ([Value])
	SELECT Ref.[Value]
	FROM @NodeIDsTemp AS Ref

	DECLARE @CreatorCount int = (SELECT COUNT(*) FROM @CreatorNodeIDs)

	DECLARE @UserIDs GuidTableType

	DECLARE @AllUsers bit = 0

	IF @CreatorNodeTypeID IS NULL AND NOT EXISTS (SELECT TOP(1) * FROM @CreatorNodeIDs) SET @AllUsers = 1

	IF @AllUsers = 0 BEGIN
		INSERT INTO @UserIDs ([Value])
		SELECT DISTINCT NM.UserID
		FROM [dbo].[CN_Nodes] AS Groups
			INNER JOIN [dbo].[CN_View_NodeMembers] AS NM
			ON NM.ApplicationID = @ApplicationID AND NM.NodeID = Groups.NodeID AND NM.IsPending = 0
		WHERE Groups.ApplicationID = @ApplicationID AND (
				(@CreatorCount > 0 AND Groups.NodeID IN (SELECT * FROM @CreatorNodeIDs)) OR
				(@CreatorCount = 0 AND
					(@CreatorNodeTypeID IS NULL OR Groups.NodeTypeID = @CreatorNodeTypeID)
				)
			) AND Groups.Deleted = 0
	END

	;WITH Content AS (
		SELECT X.UserID, X.VisitedID, X.SearchID, X.QuestionID, X.PostID, X.CommentID,
			[dbo].[GFN_GetTimePeriod](X.[Date], @Period, @CalendarType) AS [Period]
		FROM [dbo].[RV_FN_KnowledgeDemandIndicatorsReport](@ApplicationID, @CurrentUserID, @ContentTypeIDs, 
			@UserIDs, @AllUsers, @LowerCreationDateLimit, @UpperCreationDateLimit) AS X
	)
	SELECT	P.[Value] AS [Period],
			COUNT(C.VisitedID) AS VisitsCount,
			COUNT(C.SearchID) AS SearchesCount
	FROM @PeriodList AS P
		LEFT JOIN Content AS C
		ON C.[Period] = P.[Value]
	GROUP BY P.[Value]
	ORDER BY P.[Value]
END

GO



SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[RV_FN_KnowledgeSupplyIndicatorsReport]') 
    AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
DROP FUNCTION [dbo].[RV_FN_KnowledgeSupplyIndicatorsReport]
GO

CREATE FUNCTION [dbo].[RV_FN_KnowledgeSupplyIndicatorsReport](
	@ApplicationID			uniqueidentifier,
	@CurrentUserID			uniqueidentifier,
	@ContentTypeIDsTemp		GuidTableType readonly,
	@UserIDsTemp			GuidTableType readonly,
	@AllUsers				bit,
	@LowerCreationDateLimit datetime,
	@UpperCreationDateLimit datetime
)
RETURNS @outputTable TABLE (
	UserID						uniqueidentifier,
	ContentID					uniqueidentifier,
	ContentCollaborationShare	float,
	ContentStatus				varchar(100),
	ContentScore				float,
	ContentPublished			bit,
	AnswerID					uniqueidentifier,
	WikiParagraphID				uniqueidentifier,
	[Date]						datetime
)
WITH ENCRYPTION
AS
BEGIN
	DECLARE @ContentTypeIDs GuidTableType
	INSERT INTO @ContentTypeIDs (Value) SELECT Ref.Value FROM @ContentTypeIDsTemp AS Ref

	DECLARE @ContentTypesCount int = (SELECT COUNT(*) FROM @ContentTypeIDs)

	DECLARE @UserIDs GuidTableType

	INSERT INTO @UserIDs ([Value])
	SELECT Ref.[Value]
	FROM @UserIDsTemp AS Ref

	INSERT INTO @outputTable (UserID, ContentID, ContentCollaborationShare,
		ContentStatus, ContentScore, ContentPublished, AnswerID, WikiParagraphID, [Date])
	(
		SELECT	NC.UserID,
				NC.NodeID AS ContentID,
				NC.CollaborationShare AS ContentCollaborationShare,
				Contents.[Status] AS ContentStatus,
				Contents.Score AS ContentScore,
				Contents.Searchable AS ContentPublished,
				NULL AS AnswerID,
				NULL AS WikiParagraphID,
				Contents.CreationDate AS [Date]
		FROM [dbo].[CN_NodeCreators] AS NC
			INNER JOIN [dbo].[CN_Nodes] AS Contents
			ON Contents.ApplicationID = @ApplicationID AND Contents.NodeID = NC.NodeID
			INNER JOIN [dbo].[Users_Normal] AS UN
			ON UN.ApplicationID = @ApplicationID AND UN.UserID = NC.UserID AND UN.IsApproved = 1
		WHERE NC.ApplicationID = @ApplicationID AND 
			(@AllUsers = 1 OR NC.UserID IN (SELECT U.[Value] FROM @UserIDs AS U)) AND NC.Deleted = 0 AND 
			(@ContentTypesCount = 0 OR Contents.NodeTypeID IN (SELECT X.Value FROM @ContentTypeIDs AS X)) AND 
			(@LowerCreationDateLimit IS NULL OR Contents.CreationDate >= @LowerCreationDateLimit) AND
			(@UpperCreationDateLimit IS NULL OR Contents.CreationDate < @UpperCreationDateLimit) AND
			Contents.Deleted = 0

		UNION ALL

		SELECT	A.SenderUserID AS UserID,
				NULL AS ContentID,
				NULL AS ContentCollaborationShare,
				NULL AS ContentStatus,
				NULL AS ContentScore,
				NULL AS ContentPublished,
				A.AnswerID,
				NULL AS WikiParagraphID,
				A.SendDate AS [Date]
		FROM [dbo].[QA_Answers] AS A
			INNER JOIN [dbo].[QA_Questions] AS Q
			ON Q.ApplicationID = @ApplicationID AND Q.QuestionID = A.QuestionID AND Q.Deleted = 0
			INNER JOIN [dbo].[Users_Normal] AS UN
			ON UN.ApplicationID = @ApplicationID AND UN.UserID = A.SenderUserID AND UN.IsApproved = 1
		WHERE A.ApplicationID = @ApplicationID AND 
			(@AllUsers = 1 OR A.SenderUserID IN (SELECT U.[Value] FROM @UserIDs AS U)) AND A.Deleted = 0 AND
			(@LowerCreationDateLimit IS NULL OR A.SendDate >= @LowerCreationDateLimit) AND
			(@UpperCreationDateLimit IS NULL OR A.SendDate < @UpperCreationDateLimit)

		UNION ALL

		SELECT	C.UserID,
				NULL AS ContentID,
				NULL AS ContentCollaborationShare,
				NULL AS ContentStatus,
				NULL AS ContentScore,
				NULL AS ContentPublished,
				NULL AS AnswerID,
				C.ParagraphID AS WikiParagraphID,
				C.SendDate AS [Date]
		FROM [dbo].[WK_Changes] AS C
			INNER JOIN [dbo].[WK_Paragraphs] AS P
			ON P.ApplicationID = @ApplicationID AND P.ParagraphID = C.ParagraphID AND 
				P.Deleted = 0 AND (P.[Status] = N'Accepted' OR P.[Status] = N'CitationNeeded')
			INNER JOIN [dbo].[WK_Titles] AS T
			ON T.ApplicationID = @ApplicationID AND T.TitleID = P.TitleID AND T.Deleted = 0
			INNER JOIN [dbo].[CN_Nodes] AS ND
			ON ND.ApplicationID = @ApplicationID AND ND.NodeID = T.OwnerID AND 
				ND.Deleted = 0 AND (ND.Searchable = 1 OR ND.[Status] = N'Accepted') AND
				(@ContentTypesCount = 0 OR ND.NodeTypeID IN (SELECT X.Value FROM @ContentTypeIDs AS X))
			INNER JOIN [dbo].[Users_Normal] AS UN
			ON UN.ApplicationID = @ApplicationID AND UN.UserID = C.UserID AND UN.IsApproved = 1
		WHERE C.ApplicationID = @ApplicationID AND 
			(@AllUsers = 1 OR C.UserID IN (SELECT U.[Value] FROM @UserIDs AS U)) AND 
			(@LowerCreationDateLimit IS NULL OR C.SendDate >= @LowerCreationDateLimit) AND
			(@UpperCreationDateLimit IS NULL OR C.SendDate < @UpperCreationDateLimit) AND
			(C.[Status] = N'Accepted' OR C.Applied = 1) AND C.Deleted = 0
	)

	RETURN
END

GO

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[RV_KnowledgeSupplyIndicatorsReport]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[RV_KnowledgeSupplyIndicatorsReport]
GO

CREATE PROCEDURE [dbo].[RV_KnowledgeSupplyIndicatorsReport]
	@ApplicationID			uniqueidentifier,
	@CurrentUserID			uniqueidentifier,
	@ContentTypeIDsTemp		GuidTableType readonly,
	@CreatorNodeTypeID		uniqueidentifier,
	@NodeIDsTemp			GuidTableType readonly,
	@LowerCreationDateLimit datetime,
	@UpperCreationDateLimit datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON

	DECLARE @ContentTypeIDs GuidTableType
	INSERT INTO @ContentTypeIDs (Value) SELECT Ref.Value FROM @ContentTypeIDsTemp AS Ref
	
	DECLARE @CreatorNodeIDs GuidTableType

	INSERT INTO @CreatorNodeIDs ([Value])
	SELECT Ref.[Value]
	FROM @NodeIDsTemp AS Ref

	DECLARE @CreatorCount int = (SELECT COUNT(*) FROM @CreatorNodeIDs)

	DECLARE @UserIDs GuidTableType

	DECLARE @AllUsers bit = 0

	IF @CreatorNodeTypeID IS NULL AND NOT EXISTS (SELECT TOP(1) * FROM @CreatorNodeIDs) SET @AllUsers = 1

	DECLARE @GroupMembers TABLE (
		GroupID				uniqueidentifier, 
		GroupName			nvarchar(500), 
		UserID				uniqueidentifier,
		LastActivityDate	datetime
	)

	IF @AllUsers = 0 BEGIN
		INSERT INTO @GroupMembers (GroupID, GroupName, UserID, LastActivityDate)
		SELECT Groups.NodeID, Groups.[Name], NM.UserID, UN.LastActivityDate
		FROM [dbo].[CN_Nodes] AS Groups
			INNER JOIN [dbo].[CN_View_NodeMembers] AS NM
			ON NM.ApplicationID = @ApplicationID AND NM.NodeID = Groups.NodeID AND NM.IsPending = 0
			INNER JOIN [dbo].[Users_Normal] AS UN
			ON UN.ApplicationID = @ApplicationID AND UN.UserID = NM.UserID
		WHERE Groups.ApplicationID = @ApplicationID AND (
				(@CreatorCount > 0 AND Groups.NodeID IN (SELECT * FROM @CreatorNodeIDs)) OR
				(@CreatorCount = 0 AND
					(@CreatorNodeTypeID IS NULL OR Groups.NodeTypeID = @CreatorNodeTypeID)
				)
			) AND Groups.Deleted = 0 AND UN.IsApproved = 1

		INSERT INTO @UserIDs ([Value])
		SELECT DISTINCT G.UserID
		FROM @GroupMembers AS G
	END

	IF @AllUsers = 0 BEGIN
		;WITH Content AS (
			SELECT X.UserID, X.ContentID, X.ContentCollaborationShare, X.ContentStatus,
				X.ContentScore, X.ContentPublished, X.AnswerID, X.WikiParagraphID, X.[Date]
			FROM [dbo].[RV_FN_KnowledgeSupplyIndicatorsReport](@ApplicationID, @CurrentUserID, @ContentTypeIDs, 
				@UserIDs, @AllUsers, @LowerCreationDateLimit, @UpperCreationDateLimit) AS X
		),
		SummaryCol AS (
			SELECT G.GroupID, C.ContentID, SUM(ISNULL(C.ContentCollaborationShare, 0)) AS CollaborationShare
			FROM @GroupMembers AS G
				INNER JOIN Content AS C
				ON C.UserID = G.UserID
			GROUP BY G.GroupID, C.ContentID
		),
		SummaryScore AS (
			SELECT G.GroupID, C.ContentID,
				MAX(CASE WHEN C.[ContentStatus] = N'Accepted' THEN ISNULL(C.ContentScore, 0) ELSE 0 END) AS [Score]
			FROM @GroupMembers AS G
				INNER JOIN Content AS C
				ON C.UserID = G.UserID
			GROUP BY G.GroupID, C.ContentID
		)
		SELECT	G.GroupID AS GroupID_Hide, 
				MAX(G.GroupName) AS GroupName,
				COUNT(DISTINCT G.UserID) AS MembersCount,
				COUNT(DISTINCT C.ContentID) AS ContentsCount,
				CASE WHEN COUNT(DISTINCT C.ContentID) = 0 THEN 0 ELSE MAX(S.CollaborationShare) / COUNT(DISTINCT C.ContentID) END AS AverageCollaborationShare,
				COUNT(DISTINCT (CASE WHEN C.ContentStatus = N'Accepted' THEN C.ContentID ELSE NULL END)) AS AcceptedCount,
				CASE WHEN COUNT(DISTINCT C.ContentID) = 0 THEN 0 ELSE MAX(SC.Score) / COUNT(DISTINCT C.ContentID) END AS AverageAcceptedScore,
				COUNT(DISTINCT (CASE WHEN C.ContentPublished = 1 THEN C.ContentID ELSE NULL END)) AS PublishedCount,
				COUNT(DISTINCT C.AnswerID) AS AnswersCount,
				COUNT(DISTINCT C.WikiParagraphID) AS WikiChangesCount
		FROM @GroupMembers AS G
			INNER JOIN Content AS C
			ON C.UserID = G.UserID
			INNER JOIN SummaryCol AS S
			ON S.GroupID = G.GroupID AND S.ContentID = C.ContentID
			INNER JOIN SummaryScore AS SC
			ON SC.GroupID = G.GroupID AND SC.ContentID = C.ContentID
		GROUP BY G.GroupID
	END
	ELSE BEGIN
		;WITH Content AS (
			SELECT X.UserID, X.ContentID, X.ContentCollaborationShare, X.ContentStatus,
				X.ContentScore, X.ContentPublished, X.AnswerID, X.WikiParagraphID, X.[Date]
			FROM [dbo].[RV_FN_KnowledgeSupplyIndicatorsReport](@ApplicationID, @CurrentUserID, @ContentTypeIDs, 
				@UserIDs, @AllUsers, @LowerCreationDateLimit, @UpperCreationDateLimit) AS X
		)
		SELECT	X.UserID AS UserID_Hide,
				LTRIM(RTRIM(ISNULL(UN.FirstName, N' ') + N' ' + ISNULL(UN.LastName, N' '))) AS FullName,
				X.ContentsCount,
				X.AverageCollaborationShare,
				X.AcceptedCount,
				X.AverageAcceptedScore,
				X.PublishedCount,
				X.AnswersCount,
				X.WikiChangesCount
		FROM (
				SELECT	C.UserID, 
						COUNT(DISTINCT C.ContentID) AS ContentsCount,
						CASE 
							WHEN COUNT(DISTINCT C.ContentID) = 0 THEN 0 
							ELSE SUM(ISNULL(C.ContentCollaborationShare, 0)) / COUNT(DISTINCT C.ContentID) 
						END AS AverageCollaborationShare,
						COUNT(DISTINCT (CASE WHEN C.ContentStatus = N'Accepted' THEN C.ContentID ELSE NULL END)) AS AcceptedCount,
						CASE 
							WHEN COUNT(DISTINCT C.ContentID) = 0 THEN 0 
							ELSE SUM(ISNULL(C.ContentScore, 0)) / COUNT(DISTINCT C.ContentID) 
						END AS AverageAcceptedScore,
						COUNT(DISTINCT (CASE WHEN C.ContentPublished = 1 THEN C.ContentID ELSE NULL END)) AS PublishedCount,
						COUNT(DISTINCT C.AnswerID) AS AnswersCount,
						COUNT(DISTINCT C.WikiParagraphID) AS WikiChangesCount
				FROM Content AS C
				GROUP BY C.UserID
			) AS X
			INNER JOIN [dbo].[Users_Normal] AS UN
			ON UN.ApplicationID = @ApplicationID AND UN.UserID = X.UserID
	END
	
	SELECT ('{' +
		'"GroupName": {"Action": "Link", "Type": "Node",' +
			'"Requires": {"ID": "GroupID_Hide"}' +
		'},' +
		'"FullName": {"Action": "Link", "Type": "User",' +
			'"Requires": {"ID": "UserID_Hide"}' +
		'}' +
	   '}') AS Actions
END

GO

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[RV_KnowledgeSupplyIndicatorsReport_Chart]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[RV_KnowledgeSupplyIndicatorsReport_Chart]
GO

CREATE PROCEDURE [dbo].[RV_KnowledgeSupplyIndicatorsReport_Chart]
	@ApplicationID			uniqueidentifier,
	@CurrentUserID			uniqueidentifier,
	@Period					varchar(50),
	@CalendarType			varchar(50),
	@PeriodList				BigIntTableType readonly,
	@ContentTypeIDsTemp		GuidTableType readonly,
	@CreatorNodeTypeID		uniqueidentifier,
	@NodeIDsTemp			GuidTableType readonly,
	@LowerCreationDateLimit datetime,
	@UpperCreationDateLimit datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON

	DECLARE @ContentTypeIDs GuidTableType
	INSERT INTO @ContentTypeIDs (Value) SELECT Ref.Value FROM @ContentTypeIDsTemp AS Ref
	
	DECLARE @CreatorNodeIDs GuidTableType

	INSERT INTO @CreatorNodeIDs ([Value])
	SELECT Ref.[Value]
	FROM @NodeIDsTemp AS Ref

	DECLARE @CreatorCount int = (SELECT COUNT(*) FROM @CreatorNodeIDs)

	DECLARE @UserIDs GuidTableType

	DECLARE @AllUsers bit = 0

	IF @CreatorNodeTypeID IS NULL AND NOT EXISTS (SELECT TOP(1) * FROM @CreatorNodeIDs) SET @AllUsers = 1

	IF @AllUsers = 0 BEGIN
		INSERT INTO @UserIDs ([Value])
		SELECT DISTINCT NM.UserID
		FROM [dbo].[CN_Nodes] AS Groups
			INNER JOIN [dbo].[CN_View_NodeMembers] AS NM
			ON NM.ApplicationID = @ApplicationID AND NM.NodeID = Groups.NodeID AND NM.IsPending = 0
		WHERE Groups.ApplicationID = @ApplicationID AND (
				(@CreatorCount > 0 AND Groups.NodeID IN (SELECT * FROM @CreatorNodeIDs)) OR
				(@CreatorCount = 0 AND
					(@CreatorNodeTypeID IS NULL OR Groups.NodeTypeID = @CreatorNodeTypeID)
				)
			) AND Groups.Deleted = 0
	END

	;WITH Content AS (
		SELECT X.UserID, X.ContentID, X.ContentCollaborationShare, X.ContentStatus,
			X.ContentScore, X.ContentPublished, X.AnswerID, X.WikiParagraphID, 
			[dbo].[GFN_GetTimePeriod](X.[Date], @Period, @CalendarType) AS [Period]
		FROM [dbo].[RV_FN_KnowledgeSupplyIndicatorsReport](@ApplicationID, @CurrentUserID, @ContentTypeIDs, 
			@UserIDs, @AllUsers, @LowerCreationDateLimit, @UpperCreationDateLimit) AS X
	)
	SELECT	P.[Value] AS [Period],
			COUNT(DISTINCT C.ContentID) AS RegisteredCount,
			COUNT(DISTINCT (CASE WHEN C.ContentPublished = 1 THEN C.ContentID ELSE NULL END)) AS PublishedCount
	FROM @PeriodList AS P
		LEFT JOIN Content AS C
		ON C.[Period] = P.[Value]
	GROUP BY P.[Value]
	ORDER BY P.[Value]
END

GO



SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[RV_FN_SocialContributionIndicatorsReport]') 
    AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
DROP FUNCTION [dbo].[RV_FN_SocialContributionIndicatorsReport]
GO

CREATE FUNCTION [dbo].[RV_FN_SocialContributionIndicatorsReport](
	@ApplicationID			uniqueidentifier,
	@CurrentUserID			uniqueidentifier,
	@UserIDsTemp			GuidTableType readonly,
	@AllUsers				bit,
	@LowerCreationDateLimit datetime,
	@UpperCreationDateLimit datetime
)
RETURNS @outputTable TABLE (
	UserID			uniqueidentifier,
	PostID			uniqueidentifier,
	CommentID		uniqueidentifier,
	PostSendDate	datetime,
	CommentSendDate	datetime
)
WITH ENCRYPTION
AS
BEGIN
	DECLARE @UserIDs GuidTableType

	INSERT INTO @UserIDs ([Value])
	SELECT Ref.[Value]
	FROM @UserIDsTemp AS Ref

	INSERT INTO @outputTable (UserID, PostID, CommentID, PostSendDate, CommentSendDate)
	(
		SELECT	PS.SenderUserID AS UserID,
				PS.ShareID AS PostID,
				NULL AS CommentID,
				PS.SendDate AS PostSendDate,
				NULL AS CommentSendDate
		FROM [dbo].[SH_PostShares] AS PS
			INNER JOIN [dbo].[Users_Normal] AS UN
			ON UN.ApplicationID = @ApplicationID AND UN.UserID = PS.SenderUserID AND UN.IsApproved = 1
		WHERE PS.ApplicationID = @ApplicationID AND 
			(@AllUsers = 1 OR PS.SenderUserID IN (SELECT U.[Value] FROM @UserIDs AS U)) AND PS.Deleted = 0 AND 
			(@LowerCreationDateLimit IS NULL OR PS.SendDate >= @LowerCreationDateLimit) AND
			(@UpperCreationDateLimit IS NULL OR PS.SendDate <= @UpperCreationDateLimit)

		UNION ALL

		SELECT	C.SenderUserID,
				NULL AS PostID,
				C.CommentID,
				NULL AS PostSendDate,
				C.SendDate AS CommentSendDate
		FROM [dbo].[SH_Comments] AS C
			INNER JOIN [dbo].[SH_PostShares] AS PS
			ON PS.ApplicationID = @ApplicationID AND PS.ShareID = C.ShareID
			INNER JOIN [dbo].[Users_Normal] AS UN
			ON UN.ApplicationID = @ApplicationID AND UN.UserID = C.SenderUserID AND UN.IsApproved = 1
		WHERE C.ApplicationID = @ApplicationID AND 
			(@AllUsers = 1 OR C.SenderUserID IN (SELECT U.[Value] FROM @UserIDs AS U)) AND 
			C.Deleted = 0 AND PS.Deleted = 0 AND 
			(@LowerCreationDateLimit IS NULL OR C.SendDate >= @LowerCreationDateLimit) AND
			(@UpperCreationDateLimit IS NULL OR C.SendDate <= @UpperCreationDateLimit)
	)

	RETURN
END

GO

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[RV_SocialContributionIndicatorsReport]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[RV_SocialContributionIndicatorsReport]
GO

CREATE PROCEDURE [dbo].[RV_SocialContributionIndicatorsReport]
	@ApplicationID			uniqueidentifier,
	@CurrentUserID			uniqueidentifier,
	@CreatorNodeTypeID		uniqueidentifier,
	@NodeIDsTemp			GuidTableType readonly,
	@LowerCreationDateLimit datetime,
	@UpperCreationDateLimit datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @CreatorNodeIDs GuidTableType

	INSERT INTO @CreatorNodeIDs ([Value])
	SELECT Ref.[Value]
	FROM @NodeIDsTemp AS Ref

	DECLARE @CreatorCount int = (SELECT COUNT(*) FROM @CreatorNodeIDs)

	DECLARE @UserIDs GuidTableType

	DECLARE @AllUsers bit = 0

	IF @CreatorNodeTypeID IS NULL AND NOT EXISTS (SELECT TOP(1) * FROM @CreatorNodeIDs) SET @AllUsers = 1

	DECLARE @GroupMembers TABLE (
		GroupID				uniqueidentifier, 
		GroupName			nvarchar(500), 
		UserID				uniqueidentifier,
		LastActivityDate	datetime
	)

	IF @AllUsers = 0 BEGIN
		INSERT INTO @GroupMembers (GroupID, GroupName, UserID, LastActivityDate)
		SELECT Groups.NodeID, Groups.[Name], NM.UserID, UN.LastActivityDate
		FROM [dbo].[CN_Nodes] AS Groups
			INNER JOIN [dbo].[CN_View_NodeMembers] AS NM
			ON NM.ApplicationID = @ApplicationID AND NM.NodeID = Groups.NodeID AND NM.IsPending = 0
			INNER JOIN [dbo].[Users_Normal] AS UN
			ON UN.ApplicationID = @ApplicationID AND UN.UserID = NM.UserID
		WHERE Groups.ApplicationID = @ApplicationID AND (
				(@CreatorCount > 0 AND Groups.NodeID IN (SELECT * FROM @CreatorNodeIDs)) OR
				(@CreatorCount = 0 AND
					(@CreatorNodeTypeID IS NULL OR Groups.NodeTypeID = @CreatorNodeTypeID)
				)
			) AND Groups.Deleted = 0 AND UN.IsApproved = 1

		INSERT INTO @UserIDs ([Value])
		SELECT DISTINCT G.UserID
		FROM @GroupMembers AS G
	END

	IF @AllUsers = 0 BEGIN
		;WITH Social AS (
			SELECT X.UserID, X.PostID, X.CommentID, X.PostSendDate, X.CommentSendDate
			FROM [dbo].[RV_FN_SocialContributionIndicatorsReport](@ApplicationID, @CurrentUserID, @UserIDs, 
				@AllUsers, @LowerCreationDateLimit, @UpperCreationDateLimit) AS X
		)
		SELECT	G.GroupID AS GroupID_Hide,
				MAX(G.GroupName) AS GroupName,
				COUNT(DISTINCT G.UserID) MembersCount,
				MAX(R.ActiveUsersCount) AS ActiveUsersCount,
				MAX(R.PostsCount) AS PostsCount,
				MAX(R.CommentsCount) AS CommentsCount
		FROM (
				SELECT	G.GroupID,
						COUNT(G.UserID) AS ActiveUsersCount,
						0 AS PostsCount,
						0 AS CommentsCount
				FROM @GroupMembers AS G
				WHERE (@LowerCreationDateLimit IS NULL OR G.LastActivityDate >= @LowerCreationDateLimit) AND
					(@UpperCreationDateLimit IS NULL OR G.LastActivityDate <= @UpperCreationDateLimit)
				GROUP BY G.GroupID

				UNION ALL

				SELECT	G.GroupID,
						0 AS ActiveUsersCount,
						COUNT(S.PostID) AS PostsCount,
						0 AS CommentsCount
				FROM @GroupMembers AS G
					INNER JOIN Social AS S
					ON S.UserID = G.UserID
				GROUP BY G.GroupID

				UNION ALL

				SELECT	G.GroupID,
						0 AS ActiveUsersCount,
						0 AS PostsCount,
						COUNT(S.CommentID) AS CommentsCount
				FROM @GroupMembers AS G
					INNER JOIN Social AS S
					ON S.UserID = G.UserID
				GROUP BY G.GroupID
			) AS R
			INNER JOIN @GroupMembers AS G
			ON G.GroupID = R.GroupID
		GROUP BY G.GroupID
	END
	ELSE BEGIN
		;WITH Social AS (
			SELECT X.UserID, X.PostID, X.CommentID, X.PostSendDate, X.CommentSendDate
			FROM [dbo].[RV_FN_SocialContributionIndicatorsReport](@ApplicationID, @CurrentUserID, @UserIDs, 
				@AllUsers, @LowerCreationDateLimit, @UpperCreationDateLimit) AS X
		)
		SELECT	R.UserID AS UserID_Hide,
				LTRIM(RTRIM(ISNULL(MAX(UN.FirstName), N' ') + N' ' + ISNULL(MAX(UN.LastName), N' '))) AS FullName,
				MAX(R.PostsCount) AS PostsCount,
				MAX(R.CommentsCount) AS CommentsCount
		FROM (
				SELECT	S.UserID,
						COUNT(S.PostID) AS PostsCount,
						0 AS CommentsCount
				FROM Social AS S
				GROUP BY S.UserID

				UNION ALL

				SELECT	S.UserID,
						0 AS PostsCount,
						COUNT(S.CommentID) AS CommentsCount
				FROM Social AS S
				GROUP BY S.UserID
			) AS R
			INNER JOIN [dbo].[Users_Normal] AS UN
			ON UN.ApplicationID = @ApplicationID AND UN.UserID = R.UserID
		GROUP BY R.UserID
	END
	
	SELECT ('{' +
		'"GroupName": {"Action": "Link", "Type": "Node",' +
			'"Requires": {"ID": "GroupID_Hide"}' +
		'},' +
		'"FullName": {"Action": "Link", "Type": "User",' +
			'"Requires": {"ID": "UserID_Hide"}' +
		'}' +
	   '}') AS Actions
END

GO

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[RV_SocialContributionIndicatorsReport_Chart]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[RV_SocialContributionIndicatorsReport_Chart]
GO

CREATE PROCEDURE [dbo].[RV_SocialContributionIndicatorsReport_Chart]
	@ApplicationID			uniqueidentifier,
	@CurrentUserID			uniqueidentifier,
	@Period					varchar(50),
	@CalendarType			varchar(50),
	@PeriodList				BigIntTableType readonly,
	@CreatorNodeTypeID		uniqueidentifier,
	@NodeIDsTemp			GuidTableType readonly,
	@LowerCreationDateLimit datetime,
	@UpperCreationDateLimit datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON

	DECLARE @CreatorNodeIDs GuidTableType

	INSERT INTO @CreatorNodeIDs ([Value])
	SELECT Ref.[Value]
	FROM @NodeIDsTemp AS Ref

	DECLARE @CreatorCount int = (SELECT COUNT(*) FROM @CreatorNodeIDs)

	DECLARE @UserIDs GuidTableType

	DECLARE @AllUsers bit = 0

	IF @CreatorNodeTypeID IS NULL AND NOT EXISTS (SELECT TOP(1) * FROM @CreatorNodeIDs) SET @AllUsers = 1

	IF @AllUsers = 0 BEGIN
		INSERT INTO @UserIDs ([Value])
		SELECT DISTINCT NM.UserID
		FROM [dbo].[CN_Nodes] AS Groups
			INNER JOIN [dbo].[CN_View_NodeMembers] AS NM
			ON NM.ApplicationID = @ApplicationID AND NM.NodeID = Groups.NodeID AND NM.IsPending = 0
		WHERE Groups.ApplicationID = @ApplicationID AND (
				(@CreatorCount > 0 AND Groups.NodeID IN (SELECT * FROM @CreatorNodeIDs)) OR
				(@CreatorCount = 0 AND
					(@CreatorNodeTypeID IS NULL OR Groups.NodeTypeID = @CreatorNodeTypeID)
				)
			) AND Groups.Deleted = 0
	END

	;WITH Social AS (
		SELECT	X.UserID, 
				X.PostID, 
				X.CommentID, 
				[dbo].[GFN_GetTimePeriod](X.PostSendDate, @Period, @CalendarType) AS PostPeriod,
				[dbo].[GFN_GetTimePeriod](X.CommentSendDate, @Period, @CalendarType) AS CommentPeriod
		FROM [dbo].[RV_FN_SocialContributionIndicatorsReport](@ApplicationID, @CurrentUserID, @UserIDs, 
			@AllUsers, @LowerCreationDateLimit, @UpperCreationDateLimit) AS X
	)
	SELECT	R.[Period],
			MAX(R.PostsCount) AS PostsCount,
			MAX(R.CommentsCount) AS CommentsCount
	FROM (
			SELECT P.[Value] AS [Period], ISNULL(COUNT(DISTINCT S.PostID), 0) AS PostsCount, 0 AS CommentsCount
			FROM @PeriodList AS P
				LEFT JOIN Social AS S
				ON S.PostPeriod = P.[Value]
			GROUP BY P.[Value]

			UNION ALL

			SELECT P.[Value] AS [Period], 0 AS PostsCount, ISNULL(COUNT(DISTINCT S.CommentID), 0) AS CommentsCount
			FROM @PeriodList AS P
				LEFT JOIN Social AS S
				ON S.CommentPeriod = P.[Value]
			GROUP BY P.[Value]
		) AS R
	GROUP BY R.[Period]
	ORDER BY R.[Period]
END

GO



SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[USR_FN_ActiveUsersReport]') 
    AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
DROP FUNCTION [dbo].[USR_FN_ActiveUsersReport]
GO

CREATE FUNCTION [dbo].[USR_FN_ActiveUsersReport](
	@ApplicationID	uniqueidentifier,
	@BeginDate		datetime,
	@FinishDate		datetime
)
RETURNS @outputTable TABLE (
	UserID	uniqueidentifier,
	[Date]	datetime
)
WITH ENCRYPTION
AS
BEGIN
	INSERT INTO @outputTable (UserID, [Date])
	SELECT LG.UserID, LG.[Date]
	FROM [dbo].[LG_Logs] AS LG
	WHERE LG.ApplicationID = @ApplicationID AND LG.[Action] = 'Login' AND
		(@BeginDate IS NULL OR LG.[Date] >= @BeginDate) AND
		(@FinishDate IS NULL OR LG.[Date] < @FinishDate)

	RETURN
END

GO


SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_ActiveUsersReport]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_ActiveUsersReport]
GO

CREATE PROCEDURE [dbo].[USR_ActiveUsersReport]
	@ApplicationID	uniqueidentifier,
	@CurrentUserID	uniqueidentifier,
	@BeginDate		datetime,
	@FinishDate		datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON

	
	SELECT	UN.UserID AS UserID_Hide,
			UN.UserName,
			LTRIM(RTRIM(ISNULL(UN.FirstName, N'') + N' ' + ISNULL(UN.LastName, N''))) AS FullName
	FROM ( 
			SELECT DISTINCT Ref.UserID
			FROM [dbo].[USR_FN_ActiveUsersReport](@ApplicationID, @BeginDate, @FinishDate) AS Ref
		) AS X
		INNER JOIN [dbo].[Users_Normal] AS UN
		ON UN.ApplicationID = @ApplicationID AND UN.UserID = X.UserID

	SELECT ('{' +
			'"FullName": {"Action": "Link", "Type": "User",' +
				'"Requires": {"UID": "UserID_Hide"}' +
			'}' +
		   '}') AS Actions
END

GO



SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[USR_ActiveUsersReport_Chart]') and 
	OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[USR_ActiveUsersReport_Chart]
GO

CREATE PROCEDURE [dbo].[USR_ActiveUsersReport_Chart]
	@ApplicationID	uniqueidentifier,
	@CurrentUserID	uniqueidentifier,
	@Period			varchar(50),
	@CalendarType	varchar(50),
	@PeriodList		BigIntTableType readonly,
	@BeginDate		datetime,
	@FinishDate		datetime
WITH ENCRYPTION
AS
BEGIN
	SET NOCOUNT ON

	SELECT P.[Value] AS [Period], ISNULL(COUNT(DISTINCT X.UserID), 0) AS TotalCount
	FROM @PeriodList AS P
		LEFT JOIN (
			SELECT Ref.UserID, [dbo].[GFN_GetTimePeriod](Ref.[Date], @Period, @CalendarType) AS [Period]
			FROM [dbo].[USR_FN_ActiveUsersReport](@ApplicationID, @BeginDate, @FinishDate) AS Ref
		) AS X
		ON X.[Period] = P.[Value]
	GROUP BY P.[Value]
	ORDER BY P.[Value]
END

GO

